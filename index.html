<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸ¹ç™’è©¦é©—å®¤ | èƒ½é‡èˆ‡äººé¡åœ–å°å¼•</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@800&family=Ma+Shan+Zheng&family=Noto+Serif+TC:wght@600;900&family=ZCOOL+XiaoWei&family=Shippori+Mincho&display=swap" rel="stylesheet">
    
    <style>
        :root { --forest: #1a2f23; --cream: #fdfaf1; --accent: #c6a87c; --text: #2c3e50; --shopee: #ff5722; --error: #e74c3c; }
        * { box-sizing: border-box; }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: var(--cream); margin: 0; color: var(--text); line-height: 1.6; }
        
        /* === å°èˆªåˆ— (V40 ä¿®æ”¹ï¼šå–®ä¸€æ©«å‘ Logo) === */
        nav { background: var(--forest); padding: 0 20px; display: flex; justify-content: space-between; align-items: center; height: 70px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); overflow: hidden; }
        
        .logo-area { display: flex; align-items: center; cursor: pointer; height: 100%; }
        
        /* ğŸŒŸ [ä¿®æ”¹] Logo è¨­å®šï¼šè®“é•·æ¢åœ–å¯ä»¥è‡ªç„¶ä¼¸å±• */
        .logo-img { 
            max-height: 55px; /* é«˜åº¦çµ¦ç¨å¾®å¤§ä¸€é»ï¼Œè®“å­—æ¸…æ¥š */
            width: auto;      /* å¯¬åº¦è‡ªå‹•ï¼Œä¸æœƒè®Šå½¢ */
            object-fit: contain; 
            margin-top: 4px;  /* å¾®èª¿å‚ç›´ä½ç½® */
        } 
        
        .nav-links button { background: none; border: none; padding: 10px 15px; cursor: pointer; font-size: 15px; color: #ccc; transition: 0.3s; font-weight: 500; }
        .nav-links button.active { color: var(--accent); font-weight: bold; border-bottom: 2px solid var(--accent); }
        .nav-links button:hover { color: white; }

        /* === é€šç”¨å€å¡Š === */
        .section { display: none; padding: 0 20px 40px 20px; max-width: 1200px; margin: 0 auto; min-height: calc(100vh - 70px); animation: fadeIn 0.5s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* === é¦–é  Hero å€å¡Š === */
        .hero-section { display: flex; align-items: center; justify-content: center; gap: 30px; padding: 20px 0 0 0; border-bottom: 2px dashed #e0e0e0; margin-top: 0; margin-bottom: 0; }
        
        .hero-text { flex: 0 1 auto; max-width: 500px; text-align: left; }
        .hero-text h1 { font-family: 'Noto Serif TC', serif; font-size: 3rem; color: var(--forest); margin-bottom: 5px; line-height: 1.2; margin-top: 0; }
        .hero-text h2 { font-size: 1.3rem; color: #555; margin-bottom: 20px; font-weight: normal; margin-top: 0; }
        
        .hero-img { flex: 0 1 auto; max-width: 400px; text-align: center; }
        .hero-img img { width: 100%; max-width: 280px; drop-shadow: 0 10px 20px rgba(0,0,0,0.1); border-radius: 20px; vertical-align: bottom; margin-bottom: -10px; }

        /* === Story å€å¡Š === */
        .story-section { padding: 30px 0; text-align: center; max-width: 900px; margin: 0 auto; }
        .story-section h3 { font-family: 'Noto Serif TC', serif; font-size: 2rem; color: var(--forest); margin-bottom: 20px; position: relative; display: inline-block; margin-top: 0; }
        .story-section h3::after { content: ''; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); width: 60px; height: 3px; background: var(--accent); }
        .story-content { text-align: left; font-size: 1.1rem; color: #444; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); line-height: 1.8; }

        /* === å…¶ä»–æ¨£å¼ç¶­æŒä¸è®Š === */
        .features-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; padding: 30px 0; }
        .feature-card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); text-align: center; transition: 0.3s; cursor: pointer; border: 1px solid #eee; display: flex; flex-direction: column; justify-content: space-between; }
        .feature-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); border-color: var(--accent); }
        .feature-icon { font-size: 3rem; margin-bottom: 15px; }
        .feature-title { font-size: 1.5rem; font-weight: bold; color: var(--forest); margin-bottom: 10px; font-family: 'Noto Serif TC', serif; }
        .feature-desc { color: #666; font-size: 1rem; line-height: 1.5; }

        .disclaimer-box { background: #1a2f23; color: var(--cream); padding: 30px; border-radius: 15px; margin-top: 40px; margin-bottom: 40px; text-align: center; position: relative; overflow: hidden; }
        .disclaimer-box::before { content: 'âš ï¸'; position: absolute; top: -10px; left: 20px; font-size: 5rem; opacity: 0.1; }
        .disclaimer-text { font-size: 1.1rem; font-weight: bold; line-height: 1.8; }

        .btn-primary { padding: 15px 40px; background: var(--forest); color: var(--cream); border: none; border-radius: 30px; font-size: 1.2rem; cursor: pointer; font-weight: bold; transition: 0.3s; display: inline-block; box-shadow: 0 4px 10px rgba(26, 47, 35, 0.3); }
        .btn-primary:hover { background: #2c4739; transform: scale(1.05); }
        .btn-primary:disabled { background: #bdc3c7; cursor: not-allowed; opacity: 0.7; }
        
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); border-top: 5px solid var(--forest); margin-bottom: 25px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 8px; color: var(--forest); }
        input:not([type="checkbox"]):not([type="radio"]), select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; outline: none; transition: border 0.3s; }
        input:focus, select:focus, textarea:focus { border-color: var(--accent); }
        
        .service-card { background: #fafafa; border: 1px solid #eee; padding: 18px; border-radius: 12px; margin-bottom: 15px; position: relative; transition: 0.2s; }
        .service-card:hover { border-color: var(--accent); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .service-card.disabled-card { opacity: 0.4; pointer-events: none; filter: grayscale(0.8); }
        .service-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 10px; width: 100%; }
        .service-info { display: flex; align-items: center; gap: 12px; font-weight: bold; font-size: 17px; cursor: pointer; flex: 1; }
        .service-info input { width: 20px; height: 20px; cursor: pointer; flex-shrink: 0; margin: 0; }
        .price-badge { background: var(--forest); color: white; padding: 3px 10px; border-radius: 6px; font-size: 13px; flex-shrink: 0; }
        .service-desc { font-size: 14px; color: #777; margin-left: 32px; padding-top: 8px; border-top: 1px solid #f0f0f0; margin-top: 8px; }
        .sub-check-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 12px; margin-left: 32px; padding: 15px; background: #f4f7f5; border-radius: 10px; border: 1px solid #e0e0e0; }
        .sub-opt-label { font-size: 13px; display: flex; align-items: center; gap: 8px; cursor: pointer; color: var(--forest); margin-bottom: 0; }
        .sub-opt-label input { margin: 0; width: 16px; height: 16px; }
        .agree-wrapper { display: flex; align-items: center; gap: 10px; margin-top: 15px; cursor: pointer; font-size: 14px; color: var(--text); }
        .agree-wrapper input { width: 18px; height: 18px; margin: 0; cursor: pointer; flex-shrink: 0; }
        #terms-box { font-size: 13px; height: 120px; overflow-y: auto; background: white; padding: 15px; border: 1px solid #eee; color: #666; border-radius: 8px; }
        .total-box { text-align: right; font-size: 26px; font-weight: bold; color: #d35400; border-top: 2px dashed #eee; padding-top: 25px; margin-top: 30px; }
        .cat-card { border: 2px solid #eee; padding: 25px; border-radius: 15px; margin-bottom: 15px; cursor: pointer; background: white; transition: 0.3s; }
        .cat-card:hover { border-color: var(--accent); background: #fdf9f0; transform: translateY(-2px); }
        .required::after { content: " *"; color: var(--error); }

        #draw-area { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; padding: 20px 0; perspective: 1000px; }
        .card-back { width: 60px; height: 100px; background: radial-gradient(circle at center, #1a2f23 0%, #0d1812 100%); border: 2px solid #c6a87c; outline: 1px solid #1a2f23; outline-offset: -4px; border-radius: 8px; cursor: pointer; position: relative; transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.4s ease, border-color 0.4s ease; box-shadow: 0 4px 8px rgba(0,0,0,0.4), inset 0 0 10px rgba(198, 168, 124, 0.1); overflow: hidden; display: flex; justify-content: center; align-items: center; }
        .card-back::after { content: 'åŸ¹ç™’\Aè©¦é©—å®¤'; white-space: pre; font-family: 'Noto Serif TC', 'Shippori Mincho', serif; color: #c6a87c; font-size: 12px; font-weight: 900; text-align: center; line-height: 1.4; letter-spacing: 2px; text-shadow: 0 0 5px rgba(198, 168, 124, 0.6); opacity: 0.9; padding: 12px 8px; border: 1px solid rgba(198, 168, 124, 0.5); border-radius: 50% / 30%; background: radial-gradient(circle, rgba(198, 168, 124, 0.1) 0%, transparent 70%); box-shadow: inset 0 0 5px rgba(198, 168, 124, 0.2); }
        .card-back:hover { transform: translateY(-12px) scale(1.05); box-shadow: 0 15px 30px rgba(0,0,0,0.5), 0 0 20px rgba(198, 168, 124, 0.4); border-color: #e0c8a0; z-index: 100; }
        .result-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(5px); opacity: 0; transition: opacity 0.5s; }
        .result-overlay.active { display: flex; opacity: 1; }
        .card-reveal { position: relative; width: 320px; height: 550px; background: #fff; border-radius: 20px; overflow: hidden; box-shadow: 0 0 50px rgba(198, 168, 124, 0.6); transform: scale(0.8); opacity: 0; transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.6s; }
        .result-overlay.active .card-reveal { transform: scale(1); opacity: 1; }
        .layer-bg { width: 100%; height: 100%; object-fit: cover; position: absolute; top:0; left:0; z-index: 0; }
        .layer-text { position: absolute; z-index: 10; white-space: pre-wrap; text-align: center; transform: translate(-50%, -50%); pointer-events: none; width: max-content; }
        .retry-btn { position: absolute; bottom: -70px; left: 50%; transform: translateX(-50%); padding: 12px 30px; background: #c6a87c; color: #000; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 16px; box-shadow: 0 0 15px rgba(198, 168, 124, 0.4); transition: 0.2s; }
        .retry-btn:hover { background: #d4b585; transform: translateX(-50%) scale(1.05); }

        @media (max-width: 768px) {
            .hero-section { flex-direction: column-reverse; text-align: center; margin-top: 20px; gap: 20px; }
            .hero-text h1 { font-size: 2.2rem; }
            .hero-img { margin-bottom: 20px; }
            .card-back { width: 45px; height: 75px; outline-offset: -3px; }
            .card-back::after { font-size: 10px; padding: 8px 4px; letter-spacing: 1px; }
            .card-reveal { width: 300px; height: 515px; } 
        }
    </style>
</head>
<body>

<nav>
    <div class="logo-area" onclick="showSection('home')">
        <img src="logo.png" alt="åŸ¹ç™’è©¦é©—å®¤" class="logo-img" id="site-logo">
    </div>
    <div class="nav-links">
        <button onclick="showSection('home')" id="nav-home" class="active">é¦–é </button>
        <button onclick="showSection('booking-step-1')" id="nav-booking">æœå‹™é ç´„</button>
        <button onclick="showSection('knowledge')" id="nav-knowledge">çŸ¥è­˜åº«</button>
        <button onclick="showSection('draw')" id="nav-draw">èƒ½é‡æŠ½å¡</button>
        <button onclick="showSection('member')" id="nav-member">å€‹æ¡ˆå°ˆå€</button>
    </div>
</nav>

<div id="home" class="section active">
    
    <div class="hero-section">
        <div class="hero-text">
            <h1>ğŸ‘‹æ­¡è¿ä¾†åˆ°<br>ã€ŒåŸ¹ç™’è©¦é©—å®¤ã€</h1>
            <h2>æˆ‘æ˜¯æ­¤ç©ºé–“å‰µè¾¦äººåŸ¹åŸ¹</h2>
            <button class="btn-primary" onclick="showSection('booking-step-1')">ç«‹å³é ç´„èª¿é »</button>
        </div>
        <div class="hero-img">
            <img src="logohuman.png" alt="åŸ¹åŸ¹" id="site-hero">
        </div>
    </div>

    <div class="story-section">
        <h3>ç‚ºä»€éº¼é¸æ“‡äººé¡åœ–åšéˆæ“ºé …ç›®èª¿æ•´ï¼Ÿ</h3>
        <div class="story-content">
            <p>åœ¨2024å¹´æˆ‘è¢«è¿«é›¢é–‹å·¥ä½œï¼Œé€™æ®µæœŸé–“ä¸åœæ€ç´¢æˆ‘èƒ½åšä»€éº¼ï¼Ÿæƒ³åšä»€éº¼ï¼Ÿ</p>
            <p>äººé¡åœ–åœ¨æˆ‘æ¥µåº¦è‡ªæˆ‘å…§è€—æ™‚ä¾†åˆ°æˆ‘é¢å‰ï¼Œæˆ‘çš„ç©ºç™½èƒ½é‡ä¸­å¿ƒæ˜¯å¸æ”¶è·Ÿæ”¾å¤§å™¨ï¼Œä½†æˆ‘å”¯ä¸€å…©å€‹è¢«é»äº®çš„èƒ½é‡ä¸­å¿ƒï¼Œå¥½åƒä¹Ÿæ²’æœ‰æ­£å¸¸é‹ä½œï¼Œæˆ‘åŸºæœ¬ä¸Šæ‰€æœ‰èƒ½é‡ä¸­å¿ƒéƒ½å¡åœ¨äº†ã€éè‡ªå·±ã€è·Ÿã€è¢«åˆ¶ç´„ã€ã€‚</p>
            <p>æˆ‘é€éè‡ªå·±å­¸ç¿’ç†è§£äººé¡åœ–ä¹‹å¾Œï¼Œé †åˆ©è§£æ±ºäº†æˆ‘çš„è‡ªæˆ‘å…§è€—ä¹‹è·¯ã€‚</p>
            <br>
            <p><strong>æ‰€ä»¥æˆ‘æƒ³ç”¨éˆæ“ºå”åŠ©ä¾†åˆ°é€™å€‹ç©ºé–“çš„ä½ ï¼Œåšä¸€æ¬¡äººé¡åœ–èƒ½é‡ä¸­å¿ƒçš„èª¿æ•´ï¼Œè®“ä½ å›åˆ°ä½ è‡ªå·±çš„äººç”ŸåŸå» è¨­å®šã€‚</strong></p>
        </div>
    </div>

    <div class="features-grid">
        <div class="feature-card" onclick="showSection('booking-step-1')">
            <div class="feature-icon">ğŸ’</div>
            <div class="feature-title">èƒ½é‡ä¸­å¿ƒèª¿æ•´</div>
            <div class="feature-desc">éˆæ“ºæš¨äººé¡åœ–èƒ½é‡ä¸­å¿ƒèª¿æ•´ã€‚<br>æ‰¾å›ä½ çš„åŸå» è¨­å®šã€‚</div>
            <div style="margin-top:15px; color:var(--accent); font-weight:bold;">å»é ç´„ &rarr;</div>
        </div>
        <div class="feature-card" onclick="showSection('knowledge')">
            <div class="feature-icon">ğŸ“š</div>
            <div class="feature-title">å¯¦é©—ç´€éŒ„ç­†è¨˜</div>
            <div class="feature-desc">éå°ˆæ¥­çŸ¥è­˜åº«ï¼Œé™ªæˆ‘èµ°éå…§è€—ä¹‹è·¯çš„å·¥å…·æˆ–ç³»çµ±ç°¡ä»‹ã€‚(çš†ç‚ºè‡ªæˆ‘å­¸ç¿’)</div>
            <div style="margin-top:15px; color:var(--accent); font-weight:bold;">çœ‹ç­†è¨˜ &rarr;</div>
        </div>
        <div class="feature-card" onclick="showSection('draw')">
            <div class="feature-icon">ğŸƒ</div>
            <div class="feature-title">64 é–˜é–€èƒ½é‡æŒ‡å¼•</div>
            <div class="feature-desc">æˆ‘å°‡ 64 å€‹é–˜é–€è½‰æ›æˆåœ–ç‰‡é…ä¸Šæ–‡å­—ã€‚<br>å»ºè­°æ¯å¤©æŠ½ä¸€å¼µå³å¯ã€‚</div>
            <div style="margin-top:15px; color:var(--accent); font-weight:bold;">å»æŠ½å¡ &rarr;</div>
        </div>
    </div>

    <div class="disclaimer-box">
        <div class="disclaimer-text">
            å¦‚æœå…§å®¹æœ‰èª¤ï¼Œæ­¡è¿å”åŠ©æˆ‘ä¿®æ­£ï¼Œæˆ–æ˜¯æä¾›æˆ‘å…è²»èª²ç¨‹ğŸ¤­ã€‚<br>
            å¦‚æœåªæ˜¯çœ‹äº†ä¸é–‹å¿ƒï¼Œè«‹æŒ‰ä¸‹é—œé–‰ï¼Œè¬è¬æ°æ°ğŸ‘‹
        </div>
    </div>

</div>

<div id="booking-step-1" class="section"><div class="card"><h2>ğŸ“‚ é¸æ“‡æœå‹™é¡å‹</h2><p style="color:#666;">è«‹æ ¹æ“šæ‚¨çš„éœ€æ±‚é¸æ“‡ä¸»è¦æœå‹™é ˜åŸŸï¼š</p><div id="category-list">è¼‰å…¥è³‡æ–™ä¸­...</div></div></div>
<div id="booking-step-2" class="section"><div class="card"><button onclick="showSection('booking-step-1')" style="background:none; border:none; color:#999; cursor:pointer; margin-bottom:15px; padding:0;">â† è¿”å›</button><h2 id="active-cat-name" style="color:var(--forest);">æœå‹™è©³æƒ…</h2><div style="background:#e0f7fa; padding:20px; border-radius:12px; margin-bottom:25px; border:1px solid #4dd0e1;"><div class="form-group"><label>ğŸ”¶ ä»˜æ¬¾ç‹€æ…‹é¸æ“‡</label><select id="pay-status" onchange="toggleShopee()"><option value="unpaid">ğŸ”— æˆ‘é‚„æ²’ä»˜æ¬¾ (é ç´„å¾Œè«‹å‚³é€£çµçµ¦æˆ‘)</option><option value="shopee">ğŸ¦ æˆ‘å·²åœ¨è¦çš®ä»˜æ¬¾ (è«‹æä¾›è¨‚å–®ç·¨è™Ÿ)</option></select></div><div id="shopee-area" style="display:none;"><label style="color:var(--shopee);">è¦çš®è¨‚å–®ç·¨è™Ÿ (å¿…å¡«)</label><input type="text" id="shopee-id" placeholder="è«‹è²¼ä¸Šè¨‚å–®ç·¨è™Ÿä¾›æ ¸å°"></div></div><div class="form-group"><label class="required">æ‚¨çš„å§“å</label><input type="text" id="c-name" placeholder="çœŸå¯¦å§“å"></div><div class="form-group"><label class="required">æ‰‹æ©Ÿè™Ÿç¢¼ (å°‡ä½œç‚ºç™»å…¥å¸³è™Ÿ)</label><input type="tel" id="c-phone" placeholder="09xxxxxxxx"></div><div class="form-group"><label class="required">E-mail (æ¥æ”¶å ±å‘Šé€šçŸ¥)</label><input type="email" id="c-email" placeholder="example@mail.com"></div><div class="form-group"><label>ğŸ”¶ æ‚¨æ˜¯å¾å“ªè£¡èªè­˜åŸ¹ç™’è©¦é©—å®¤çš„ï¼Ÿ</label><select id="client-source"><option value="Threads">Threads</option><option value="IG">Instagram</option><option value="Shopee">è¦çš®</option><option value="Friend">æœ‹å‹ä»‹ç´¹</option><option value="Other">å…¶ä»–</option></select></div><hr style="border:0; border-top:1px dashed #ddd; margin: 30px 0;"><label style="font-size:18px; margin-bottom:15px;">1. é¸æ“‡æ–¹æ¡ˆå…§å®¹èˆ‡åŠ è³¼</label><div id="items-area" style="margin-bottom:30px;"></div><div id="conditional-question" style="background:#f9f9f9; padding:20px; border-radius:12px; margin-bottom:20px; border-left:5px solid var(--accent);"></div><div class="form-group"><label>ğŸ”¶ å‡ºç”Ÿå¹´æœˆæ—¥è³‡æ–™æä¾›</label><select id="data-flow" onchange="toggleFlow()"><option value="data">æä¾›å‡ºç”Ÿæ—¥æœŸæ™‚é–“</option><option value="upload">ç›´æ¥ä¸Šå‚³äººé¡åœ–æˆªåœ–</option></select></div><div id="flow-data" style="background:#f9f9f9; padding:20px; border-radius:12px; margin-bottom:20px;"><div class="form-group"><label>å‡ºç”Ÿæ—¥æœŸ</label><input type="date" id="b-date"></div><div class="form-group"><label>å‡ºç”Ÿç²¾ç¢ºæ™‚é–“</label><input type="time" id="b-time" value="12:00" onchange="timeHint()"><small id="t-hint" style="color:#d32f2f; display:block; margin-top:5px;">âœ… ç›®å‰é¸æ“‡ï¼šä¸­åˆ 12 é»</small></div><div class="form-group"><label>å‡ºç”Ÿåœ‹å®¶èˆ‡åŸå¸‚</label><input type="text" id="b-place" placeholder="ä¾‹å¦‚ï¼šå°ç£å°ä¸­å¸‚"></div></div><div id="flow-upload" style="display:none; background:#f9f9f9; padding:20px; border-radius:12px; margin-bottom:20px;"><label>ä¸Šå‚³äººé¡åœ–æˆªåœ–</label><input type="file" id="c-file" accept="image/*"></div><div class="card" style="background:#fdf9f0; border-top:none; padding:20px; margin-bottom:0;"><label>ğŸ“œ æœå‹™è¦ç¯„</label><div id="terms-box"></div><label class="agree-wrapper"><input type="checkbox" id="agree-check" onchange="toggleSubmitBtn(this.checked)"><span>æˆ‘å·²è©³ç´°é–±è®€ä¸¦åŒæ„</span></label></div><div class="total-box">æ‡‰ä»˜ç¸½é¡ï¼š$<span id="total-price">0</span></div><button id="sub-btn" class="btn-primary" onclick="doSubmit()" disabled>è«‹å…ˆå‹¾é¸åŒæ„è¦ç¯„</button></div></div>

<div id="soliloquy" class="section"><h2>ğŸ•¯ï¸ è‡ªè¨€è‡ªèª</h2><div id="sol-list"></div></div>
<div id="knowledge" class="section"><h2>ğŸ“š èƒ½é‡çŸ¥è­˜åº«</h2><div id="kno-list"></div></div>

<div id="draw" class="section">
    <div style="text-align:center; margin-bottom:20px;">
        <h2>ğŸƒ 64 é–˜é–€èƒ½é‡æŒ‡å¼•</h2>
        <p style="color:#666;">æ·±å‘¼å¸ï¼Œåœ¨å¿ƒä¸­é»˜æƒ³ä½ çš„å•é¡Œï¼Œæ†‘ç›´è¦ºé¸ä¸€å¼µç‰Œã€‚</p>
    </div>
    <div id="draw-area" class="card-table">
        <div style="color:#666;">æ­£åœ¨æ´—ç‰Œä¸­...</div>
    </div>
</div>

<div id="overlay" class="result-overlay">
    <div style="position:relative;">
        <div id="final-card" class="card-reveal">
            <img id="p-bg" class="layer-bg" src="">
            <div id="p-gate" class="layer-text"></div>
            <div id="p-info" class="layer-text"></div>
            <div id="p-zodiac" class="layer-text"></div>
            <div id="p-quote" class="layer-text"></div>
        </div>
        <button class="retry-btn" onclick="closeResult()">å†æ¬¡æŠ½å¡</button>
    </div>
</div>

<div id="member" class="section"><h2>ğŸ‘¤ å€‹æ¡ˆå°ˆå€</h2><div class="card" id="login-box"><input type="tel" id="l-phone" placeholder="æ‰‹æ©Ÿ"><input type="password" id="l-pass" placeholder="å¯†ç¢¼" style="margin-top:10px;"><button class="btn-primary" onclick="doLogin()" style="margin-top:20px;">ç™»å…¥ç³»çµ±</button></div><div id="dash" style="display:none;"></div></div>

<script>
    const SB_URL = "https://geyrpowhaqfhnxghpokr.supabase.co";
    const SB_KEY = "sb_publishable_aXucdq8UtvMbCKbriqpJCw_gtpYBw-r";
    const myDB = supabase.createClient(SB_URL, SB_KEY);

    let cats = [], items = [], activeCat = null;
    let allCards = [];

    const defaultStyle = {
        gate: { x: 50, y: 65, size: 34, font: "'Cinzel', serif", color: "#1a1a1a", stroke: "#ffffff" },
        info: { x: 50, y: 72, size: 18, font: "'Noto Serif TC', serif", color: "#1a1a1a", stroke: "transparent", w: 300 },
        zodiac: { x: 85, y: 65, size: 12, font: "sans-serif", color: "#6a1b9a", stroke: "transparent" },
        quote: { x: 50, y: 88, size: 15, font: "'Shippori Mincho', serif", color: "#ffffff", stroke: "#000000", w: 280, lh: 1.6, ls: 0 }
    };

    window.onload = async () => {
        try {
            await Promise.all([initBookingData(), initDrawData(), loadSiteAssets()]);
        } catch (e) { console.error("Init Error:", e); }
    };

    // ğŸŒŸ [V40 æ–°å¢] å‹•æ…‹è¼‰å…¥ç¶²ç«™ç´ æ (åªæ‰¾ ID=logo å’Œ logohuman)
    async function loadSiteAssets() {
        const { data, error } = await myDB.from('site_content').select('*').eq('category', 'site_asset');
        if (data) {
            data.forEach(item => {
                if (item.title === 'logo') {
                    const el = document.getElementById('site-logo');
                    if (el) el.src = item.image_url;
                }
                // ğŸŒŸ logoA å·²ç¶“ä¸éœ€è¦äº†
                if (item.title === 'logohuman') {
                    const el = document.getElementById('site-hero');
                    if (el) el.src = item.image_url;
                }
            });
        }
    }

    async function initBookingData() {
        const { data: c } = await myDB.from('service_categories').select('*').order('created_at'); cats = c || [];
        const { data: i } = await myDB.from('services').select('*').order('sort_order', {ascending: true}); items = i || [];
        const { data: posts } = await myDB.from('site_content').select('*').order('created_at', {ascending:false});
        renderCats();
        if(posts) {
            document.getElementById('sol-list').innerHTML = posts.filter(p=>p.category==='soliloquy').map(p=>`<div class="card"><h3>${p.title}</h3><p>${p.body}</p></div>`).join('');
            document.getElementById('kno-list').innerHTML = posts.filter(p=>p.category==='knowledge').map(p=>`<div class="card"><h3>${p.title}</h3><p>${p.body}</p></div>`).join('');
        }
    }

    async function initDrawData() {
        const { data, error } = await myDB.from('card_pool').select('*');
        if(!error && data) { allCards = data; renderDrawTable(); }
    }

    function showSection(id) { 
        document.querySelectorAll('.section').forEach(s=>s.classList.remove('active')); 
        document.getElementById(id).classList.add('active'); 
        document.querySelectorAll('.nav-links button').forEach(b=>b.classList.remove('active'));
        
        const baseId = id.split('-')[0]; 
        const activeBtn = document.getElementById('nav-'+baseId);
        if(activeBtn) activeBtn.classList.add('active');
        
        window.scrollTo(0,0); 
    }

    function renderDrawTable() {
        const table = document.getElementById('draw-area'); table.innerHTML = '';
        const deck = allCards.length > 0 ? allCards : Array.from({length:64}, (_, i) => ({ gate_id: i+1 }));
        const shuffled = deck.sort(() => Math.random() - 0.5);
        shuffled.forEach((card, index) => {
            const el = document.createElement('div'); el.className = 'card-back';
            el.style.animation = `fadeIn 0.5s ease ${index * 0.02}s backwards`;
            el.onclick = () => openCard(card);
            table.appendChild(el);
        });
    }

    function openCard(card) {
        if (!card.gate_id) return alert("è³‡æ–™åº«è®€å–ä¸­...");
        const bgUrl = card.image_url ? card.image_url : 'https://via.placeholder.com/320x550?text=No+Image';
        document.getElementById('p-bg').src = bgUrl + `?t=${new Date().getTime()}`;
        document.getElementById('p-gate').innerText = `GATE ${card.gate_id}`;
        document.getElementById('p-info').innerText = `${card.gate_name || ''} / ${card.gate_keyword || ''}`;
        document.getElementById('p-zodiac').innerText = card.zodiac || '';
        document.getElementById('p-quote').innerText = card.quote || '';
        const style = card.style_config || defaultStyle;
        applyStyle('gate', style.gate || defaultStyle.gate);
        applyStyle('info', style.info || defaultStyle.info);
        applyStyle('zodiac', style.zodiac || defaultStyle.zodiac);
        applyStyle('quote', style.quote || defaultStyle.quote);
        document.getElementById('overlay').classList.add('active');
    }

    function applyStyle(id, s) {
        const el = document.getElementById(`p-${id}`); const def = defaultStyle[id];
        const val = (prop) => (s && s[prop] !== undefined) ? s[prop] : def[prop];
        el.style.left = val('x') + '%'; el.style.top = val('y') + '%';
        el.style.fontSize = val('size') + 'px'; el.style.fontFamily = val('font'); el.style.color = val('color');
        const str = val('stroke');
        el.style.textShadow = (str && str !== 'transparent') ? `1px 1px 0 ${str}, -1px -1px 0 ${str}, 1px -1px 0 ${str}, -1px 1px 0 ${str}` : 'none';
        if(id === 'quote' || id === 'info') el.style.width = val('w') + 'px';
        if(id === 'quote') { el.style.lineHeight = val('lh'); el.style.letterSpacing = val('ls') + 'px'; }
        if(id === 'zodiac') el.style.display = document.getElementById('p-zodiac').innerText ? 'block' : 'none';
    }

    function closeResult() { document.getElementById('overlay').classList.remove('active'); setTimeout(() => { renderDrawTable(); }, 500); }

    function toggleFlow() { 
        const isD = document.getElementById('data-flow').value === 'data'; 
        document.getElementById('flow-data').style.display = isD ? 'block' : 'none'; 
        document.getElementById('flow-upload').style.display = isD ? 'none' : 'block'; 
    }
    function toggleShopee() { document.getElementById('shopee-area').style.display = (document.getElementById('pay-status').value === 'shopee') ? 'block' : 'none'; }
    function toggleSubmitBtn(checked) { const btn = document.getElementById('sub-btn'); btn.disabled = !checked; btn.innerText = checked ? "ç¢ºèªé€å‡ºé ç´„è³‡æ–™" : "è«‹å…ˆå‹¾é¸åŒæ„è¦ç¯„"; }
    function timeHint() { const t = document.getElementById('b-time').value; if(!t) return; const h = parseInt(t.split(':')[0]); document.getElementById('t-hint').innerText = "âœ… å·²é¸ï¼š" + (h===0?"å‡Œæ™¨ 0 é»":h===12?"ä¸­åˆ 12 é»":h<12?"ä¸Šåˆ "+h+" é»":"ä¸‹åˆ "+(h-12)+" é»"); }
    
    function renderCats() {
        document.getElementById('category-list').innerHTML = cats.map(c => `
            <div class="cat-card" onclick="selectCat('${c.id}')">
                <h3>${c.name}</h3>
                <small>${c.description || 'é»æ“ŠæŸ¥çœ‹è©³æƒ…'}</small>
            </div>`).join('');
    }

    function selectCat(id) {
        activeCat = cats.find(x => x.id === id);
        if(!activeCat) return;
        document.getElementById('active-cat-name').innerText = activeCat.name;
        document.getElementById('terms-box').innerText = activeCat.terms || "è«‹è©³é–±ä¸¦éµå®ˆç›¸é—œæœå‹™è¦ç¯„ã€‚";
        document.getElementById('agree-check').checked = false; toggleSubmitBtn(false);
        const sub = items.filter(x => x.category_id === id);
        const isSleepMode = activeCat.question_type === 'sleep'; 
        const listArea = document.getElementById('items-area');
        
        listArea.innerHTML = sub.map(i => {
            let subHtml = "";
            if (i.sub_options) {
                const opts = i.sub_options.split(/[,ï¼Œ]/);
                subHtml = `<div class="sub-check-grid">` + opts.map(opt => `<label class="sub-opt-label"><input type="checkbox" class="sub-opt-item" data-parent-id="${i.id}" value="${opt.trim()}"> ${opt.trim()}</label>`).join('') + `</div>`;
            }
            const isMain = i.is_main ? 'true' : 'false';
            return `<div class="service-card" id="card-${i.id}">
                <div class="service-header">
                    <label class="service-info">
                        <input type="checkbox" name="svc" value="${i.id}" 
                               data-price="${i.price}" 
                               data-title="${i.title}" 
                               data-is-main="${isMain}"
                               ${i.is_auto_check?'checked disabled':''} 
                               onchange="handleServiceCheck(this)">
                        <span>${i.title}</span>
                    </label>
                    <span class="price-badge">$${i.price}</span>
                </div>
                ${i.description ? `<div class="service-desc">${i.description}</div>` : ''}
                ${subHtml}
                ${i.has_text_input ? `<input type="text" class="addon-note" data-id="${i.id}" placeholder="è«‹ç°¡è¿°æ‚¨çš„éœ€æ±‚..." style="margin-top:10px;">` : ''}
            </div>`;
        }).join('');
        
        const qArea = document.getElementById('conditional-question');
        if (isSleepMode) {
            qArea.innerHTML = `<label>ğŸŒ™ è«‹å¡«å¯«æ‚¨çš„ã€Œé è¨ˆç¡çœ /ä¼‘æ¯æ™‚æ®µã€ (å¿…å¡«)</label><div style="font-size:12px; color:#666; margin-bottom:5px;">è€å¸«å°‡æ–¼æ‚¨ä¼‘æ¯æ™‚é€²è¡Œé ç«¯èƒ½é‡èª¿æ•´ï¼Œè«‹æä¾›æ‚¨é€šå¸¸çš„ä½œæ¯æ™‚é–“ã€‚</div><input type="text" id="q-val" placeholder="ä¾‹å¦‚ï¼šæ¯å¤© 23:30 ~ 07:00">`;
        } else {
            qArea.innerHTML = `<label>ğŸ“… è«‹å¡«å¯«æ‚¨ã€Œå¸Œæœ›é ç´„çš„è«®è©¢æ™‚æ®µã€ (å¿…å¡«)</label><div style="font-size:12px; color:#666; margin-bottom:5px;">è«‹æä¾› 2-3 å€‹æ–¹ä¾¿çš„æ™‚é–“ï¼Œå¾ŒçºŒå°‡ç”±å°ˆäººç¢ºèªæœ€çµ‚æ’ç¨‹ã€‚</div><input type="text" id="q-val" placeholder="ä¾‹å¦‚ï¼šå¹³æ—¥æ™šä¸Š 8 é»å¾Œã€12/25 ä¸‹åˆ">`;
        }
        calcTotal(); showSection('booking-step-2');
    }

    function handleServiceCheck(el) {
        const isMain = el.dataset.isMain === 'true';
        if (isMain) {
            const allMainInputs = document.querySelectorAll('input[name="svc"][data-is-main="true"]');
            allMainInputs.forEach(input => {
                if (input !== el) {
                    input.disabled = el.checked; 
                    const card = document.getElementById(`card-${input.value}`);
                    if(card) {
                        card.classList.toggle('disabled-card', el.checked);
                    }
                }
            });
        }
        calcTotal();
    }

    function calcTotal() {
        let t = 0; document.querySelectorAll('input[name="svc"]:checked').forEach(el => t += parseInt(el.dataset.price || 0)); document.getElementById('total-price').innerText = t;
    }

    async function doSubmit() {
        const name = document.getElementById('c-name').value.trim();
        const phone = document.getElementById('c-phone').value.trim();
        const email = document.getElementById('c-email').value.trim();
        const checkedSvcs = document.querySelectorAll('input[name="svc"]:checked');
        
        if (!name || !phone || !email) { alert("âš ï¸ è«‹å®Œæ•´å¡«å¯«å§“åã€é›»è©±èˆ‡ Email"); return; }
        if (checkedSvcs.length === 0) { alert("âš ï¸ è«‹è‡³å°‘é¸æ“‡ä¸€é …æœå‹™æ–¹æ¡ˆ"); return; }
        
        const payType = document.getElementById('pay-status').value;
        if (payType === 'shopee' && !document.getElementById('shopee-id').value.trim()) { alert("âš ï¸ é¸æ“‡ã€Œè¦çš®ä»˜æ¬¾ã€æ™‚ï¼Œè«‹å‹™å¿…å¡«å¯«è¨‚å–®ç·¨è™Ÿ"); return; }
        
        const flow = document.getElementById('data-flow').value;
        if (flow === 'data') {
            const bDate = document.getElementById('b-date').value;
            const bTime = document.getElementById('b-time').value;
            const bPlace = document.getElementById('b-place').value.trim();
            if (!bDate || !bTime || !bPlace) { alert("âš ï¸ è«‹å®Œæ•´å¡«å¯«å‡ºç”Ÿæ—¥æœŸã€æ™‚é–“èˆ‡åœ°é»"); return; }
        } else {
            const file = document.getElementById('c-file').files[0];
            if (!file) { alert("âš ï¸ è«‹ä¸Šå‚³äººé¡åœ–æˆªåœ–"); return; }
        }

        const qVal = document.getElementById('q-val') ? document.getElementById('q-val').value.trim() : '';
        if (activeCat && activeCat.question_type === 'sleep') {
            if (!qVal) { alert("âš ï¸ è«‹å¡«å¯«ã€Œé è¨ˆç¡çœ /ä¼‘æ¯æ™‚æ®µã€ä»¥åˆ©è€å¸«é€²è¡Œé ç«¯ä½œæ¥­"); return; }
        }

        const btn = document.getElementById('sub-btn'); btn.disabled = true; btn.innerText = "è³‡æ–™è™•ç†ä¸­...";
        
        let finalDataInfo = "";
        if(flow === 'upload') {
            const file = document.getElementById('c-file').files[0];
            let chartUrl = "";
            if(file) {
                const fName = `HD_${phone}_${Date.now()}.png`;
                const { error: uploadErr } = await myDB.storage.from('case-charts').upload(fName, file);
                if(uploadErr) { alert("âŒ åœ–ç‰‡ä¸Šå‚³å¤±æ•—: " + uploadErr.message); btn.disabled = false; btn.innerText = "ç¢ºèªé€å‡ºé ç´„è³‡æ–™"; return; }
                const { data } = myDB.storage.from('case-charts').getPublicUrl(fName); chartUrl = data.publicUrl;
            }
            finalDataInfo = `æˆªåœ–å·²ä¸Šå‚³ ( <a href="${chartUrl}" target="_blank">é»æ“ŠæŸ¥çœ‹åœ–ç‰‡</a> )`;
        } else {
            const bDate = document.getElementById('b-date').value; 
            const bTime = document.getElementById('b-time').value; 
            const bPlace = document.getElementById('b-place').value;
            finalDataInfo = `å‡ºç”Ÿæ—¥æœŸ: ${bDate} | æ™‚é–“: ${bTime} | åœ°é»: ${bPlace}`;
        }

        let details = [];
        checkedSvcs.forEach(el => {
            let txt = `${el.dataset.title} ($${el.dataset.price})`; 
            let subs = Array.from(document.querySelectorAll(`.sub-opt-item[data-parent-id="${el.value}"]:checked`)).map(s=>s.value);
            if(subs.length > 0) txt += ` [${subs.join('ã€')}]`;
            let noteInput = document.querySelector(`.addon-note[data-id="${el.value}"]`);
            if(noteInput && noteInput.value) txt += ` (å‚™è¨»: ${noteInput.value})`;
            details.push(txt);
        });

        const { error } = await myDB.from('bookings').insert([{
            booking_id: "OD" + Date.now(), temp_phone: phone, status: 'pending', price: parseInt(document.getElementById('total-price').innerText),
            service_item: activeCat.name, service_detail: details.join(' | '), client_source: document.getElementById('client-source').value, 
            shopee_order_id: document.getElementById('shopee-id').value, payment_method: payType, sleep_time: qVal,
            wish_detail: `å§“å:${name} | Email:${email} | æ•¸æ“š:${finalDataInfo}` 
        }]);

        if(!error) { 
            alert("ğŸ‰ é ç´„æˆåŠŸï¼"); location.reload(); 
        } else { 
            alert("âŒ é ç´„å¤±æ•—ï¼š" + error.message); 
            btn.disabled = false; btn.innerText = "ç¢ºèªé€å‡ºé ç´„è³‡æ–™"; 
        }
    }

    async function doLogin() {
        const phone = document.getElementById('l-phone').value; const pass = document.getElementById('l-pass').value;
        if(!phone || !pass) return alert("è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼");
        const { data } = await myDB.from('profiles').select('*, reports(*)').eq('phone', phone).eq('password', pass).single();
        if(data) {
            document.getElementById('login-box').style.display = 'none'; document.getElementById('dash').style.display = 'block';
            document.getElementById('dash').innerHTML = `<h3>æ‚¨å¥½ï¼Œ${data.full_name}</h3><p>æ‚¨çš„æ­·å²å ±å‘Šï¼š</p>${data.reports.length > 0 ? data.reports.map(r=>`<div class="card" style="display:flex; justify-content:space-between; align-items:center;"><span>ğŸ“… ${r.service_date}</span><button onclick="window.open('viewer.html?id=${r.id}')" style="padding:5px 15px; cursor:pointer;">æŸ¥çœ‹å ±è¡¨</button></div>`).join('') : "<div class='card'>ç›®å‰å°šç„¡å·²å®Œæˆçš„å ±å‘Š</div>"}`;
        } else { alert("å¸³å¯†éŒ¯èª¤"); }
    }
</script>
</body>
</html>
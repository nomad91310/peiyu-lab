<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸ¹ç™’è©¦é©—å®¤</title>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Ma+Shan+Zheng&family=Noto+Serif+TC:wght@500;700;900&family=Shippori+Mincho:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link rel="preload" as="image" href="logo.png">
    <link rel="preload" as="image" href="logohuman.png">

<style>
    /* ======================================================
       1. å…¨ç«™åŸºç¤è¨­å®š (Variables & Reset)
       ====================================================== */
    :root { 
        --forest: #1a2f23; --forest-light: #2a4032;
        --cream: #f9f7f2; --white: #ffffff;
        --accent: #c6a87c; --accent-hover: #b09060;
        --text-main: #2c3e50; --text-light: #666;
        --shopee: #ff5722; --error: #d32f2f; --success: #2e7d32;
        --shadow-soft: 0 10px 30px rgba(26, 47, 35, 0.08);
        --shadow-hover: 0 15px 40px rgba(26, 47, 35, 0.15);
    }
    
    * { box-sizing: border-box; }
    
    body { 
        font-family: -apple-system, "Microsoft JhengHei", "Helvetica Neue", sans-serif; 
        background-color: var(--cream); margin: 0; 
        color: var(--text-main); line-height: 1.7; letter-spacing: 0.02em;
    }
    #home { padding-bottom: 220px; }
    h1, h2, h3, h4, .serif-font { font-family: 'Noto Serif TC', serif; }

    /* ======================================================
       2. å°èˆªèˆ‡ä½ˆå±€ (Nav & Layout)
       ====================================================== */
    nav { 
        background: var(--forest); padding: 0 40px; 
        display: flex; justify-content: space-between; align-items: center; 
        height: 80px; position: sticky; top: 0; z-index: 1000; 
        box-shadow: 0 4px 20px rgba(0,0,0,0.25); border-bottom: 3px solid var(--accent);
    }
    .logo-area { display: flex; align-items: center; cursor: pointer; height: 100%; }
    .logo-img { max-height: 60px; width: auto; transition: transform 0.3s; } 
    .logo-img:hover { transform: scale(1.05); }

    .nav-links { display: flex; gap: 20px; }
    .nav-links button { 
        background: none; border: none; padding: 8px 0; cursor: pointer; 
        font-size: 16px; color: rgba(255,255,255,0.7); transition: 0.3s; 
        font-family: 'Noto Serif TC', serif; letter-spacing: 1px; position: relative;
    }
    .nav-links button::after {
        content: ''; position: absolute; width: 0; height: 2px; bottom: 0; left: 0;
        background-color: var(--accent); transition: width 0.3s;
    }
    .nav-links button:hover { color: var(--accent); }
    .nav-links button:hover::after { width: 100%; }
    .nav-links button.active { color: var(--white); font-weight: bold; }
    .nav-links button.active::after { width: 100%; background-color: var(--white); }
    .hamburger-btn { display: none; background: none; border: none; color: var(--white); font-size: 28px; cursor: pointer; padding: 5px; }

    /* å‹•ç•«å®¹å™¨ */
    .section { 
        display: none; padding: 40px 20px 100px 20px; 
        max-width: 1100px; margin: 0 auto; min-height: calc(100vh - 80px); 
        animation: fadeSlideUp 0.6s ease-out; 
    }
    .section.active { display: block; }
    @keyframes fadeSlideUp { 
        from { opacity: 0; transform: translateY(20px); } 
        to { opacity: 1; transform: translateY(0); } 
    }

    /* Footer */
    .footer-banner { position: fixed; bottom: 0; left: 0; width: 100%; z-index: 1000; background-color: var(--forest); border-top: 3px solid var(--accent); padding: 10px 0; box-shadow: 0 -4px 10px rgba(0,0,0,0.1); }
    .footer-content { max-width: 1200px; margin: 0 auto; padding: 0 15px; display: flex; align-items: center; justify-content: center; gap: 20px; flex-wrap: wrap; }
    .social-group { display: flex; gap: 8px; align-items: center; }
    .social-btn { display: inline-flex; align-items: center; gap: 5px; padding: 6px 12px; border-radius: 4px; text-decoration: none; font-size: 0.85rem; color: rgba(255,255,255,0.8); border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.05); transition: all 0.2s; }
    .social-btn:hover { background: var(--accent); color: var(--forest); border-color: var(--accent); }
    .copyright { font-size: 0.75rem; color: rgba(255,255,255,0.4); white-space: nowrap; }

    /* ======================================================
       3. é€šç”¨å…ƒä»¶ (Components)
       ====================================================== */
    /* æŒ‰éˆ• (ä¸€èˆ¬) */
    .btn-primary { 
        padding: 16px 45px; background: linear-gradient(135deg, var(--forest) 0%, #2a4032 100%); 
        color: var(--white); border: none; border-radius: 50px; font-size: 1.1rem; cursor: pointer; font-weight: bold; 
        box-shadow: 0 5px 15px rgba(26, 47, 35, 0.3); transition: all 0.3s ease; display: inline-block; letter-spacing: 1px;
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(26, 47, 35, 0.4); }
    .btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
    .btn-secondary { padding: 10px 25px; background: transparent; color: var(--forest); border: 2px solid var(--forest); border-radius: 50px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: 0.3s; margin-right: 10px; }
    .btn-secondary:hover { background: var(--forest); color: var(--white); }

    /* è¿”å›è† å›ŠæŒ‰éˆ• */
    .btn-back-capsule, .kb-internal-back {
        display: inline-flex; align-items: center; gap: 8px;
        color: var(--forest); background: #ffffff; border: 1px solid rgba(0,0,0,0.08);
        padding: 8px 24px; border-radius: 50px;
        font-size: 0.95rem; font-weight: bold; font-family: 'Noto Serif TC', serif;
        cursor: pointer; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); 
        text-decoration: none; transition: all 0.3s ease;
    }
    .kb-internal-back { margin-bottom: 5px; } 
    
    .btn-back-capsule:hover, .kb-internal-back:hover { 
        color: #ffffff; background: var(--forest); border-color: var(--forest); 
        transform: translateY(-2px); box-shadow: 0 6px 15px rgba(26, 47, 35, 0.15); 
    }
    .btn-back-capsule:hover i, .kb-internal-back:hover i { transform: translateX(-3px); }
    .btn-back-capsule i, .kb-internal-back i { transition: transform 0.3s ease; }

    /* æ‡¸æµ®æŒ‰éˆ• (FAB) */
    .kb-fab-back {
        position: fixed; bottom: 40px; right: 25px;
        width: 60px; height: 60px; border-radius: 50%;
        background: var(--forest); color: var(--accent); border: 2px solid var(--accent);
        display: flex; justify-content: center; align-items: center;
        box-shadow: 0 5px 20px rgba(0,0,0,0.4); z-index: 9999; cursor: pointer; font-size: 1.4rem;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); opacity: 0;
        animation: fabPopIn 0.5s forwards 0.3s;
    }
    .kb-fab-back:active { transform: scale(0.9); background: var(--accent); color: var(--forest); }
    @keyframes fabPopIn { from { opacity: 0; transform: scale(0) rotate(-90deg); } to { opacity: 1; transform: scale(1) rotate(0); } }
    @media (min-width: 769px) { .kb-fab-back { display: none; } }

    /* å¡ç‰‡èˆ‡è¡¨å–® */
    .card { background: var(--white); padding: 40px; border-radius: 20px; box-shadow: var(--shadow-soft); border: 1px solid #eee; margin-bottom: 30px; position: relative; }
    .form-group { margin-bottom: 25px; }
    label { display: block; font-weight: bold; margin-bottom: 10px; color: var(--forest); font-size: 1.05rem; }
    label.required::after { content: " *"; color: var(--error); }
    input:not([type="checkbox"]):not([type="radio"]), select, textarea { width: 100%; padding: 14px 18px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; outline: none; transition: 0.3s; background: #fafafa; }
    input:focus, select:focus, textarea:focus { border-color: var(--accent); background: var(--white); box-shadow: 0 0 0 3px rgba(198, 168, 124, 0.2); }
    input:disabled { background: #eee; cursor: not-allowed; color: #999; }

    /* å½ˆçª— */
    .result-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(26, 47, 35, 0.9); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(8px); opacity: 0; transition: opacity 0.4s; }
    .result-overlay.active { display: flex; opacity: 1; }
    .text-modal-card { position: relative; width: 90%; max-width: 650px; max-height: 85vh; background: #fff; border-radius: 4px; overflow-y: auto; padding: 50px 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); transform: scale(0.95); opacity: 0; transition: all 0.4s ease; }
    .result-overlay.active .text-modal-card { transform: scale(1); opacity: 1; }
    .text-modal-card h3 { text-align: center; color: var(--forest); margin-top: 10px; margin-bottom: 25px; font-size: 2rem; border: none; padding: 10px 0; background: linear-gradient(to right, transparent, rgba(198, 168, 124, 0.2), transparent); }
    .close-modal-btn { display: block; width: 100%; max-width: 250px; margin: 40px auto 0 auto; padding: 14px 0; background: var(--text-main); color: white; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.2s; }
    .close-modal-btn:hover { background: var(--error); }

    /* ======================================================
       4. é€šç”¨æ¨™é¡Œæ¨£å¼ (Brand Headers - V900 åº•éƒ¨å°é½Šç‰ˆ)
       ====================================================== */
    .brand-section-header, .draw-section-header {
        text-align: center;
        margin-bottom: 45px;
        padding-top: 15px;
    }

    /* ä¸­æ–‡å¤§æ¨™ */
    .brand-h3-zh, .draw-title-zh {
        display: inline-block !important;
        font-family: 'Noto Serif TC', serif !important;
        font-size: 2.2rem !important; 
        color: var(--forest);
        margin: 0 !important;
        font-weight: 900;
        letter-spacing: 5px;
        text-shadow: 2px 2px 0px rgba(198, 168, 124, 0.15);
        /* ğŸ”¥ é—œéµï¼šåº•éƒ¨å°é½Š */
        vertical-align: baseline !important;
    }
    
    /* è‹±æ–‡é™ªè¥¯ */
    .brand-h2-en, .draw-title-h2 {
        display: inline-block !important;
        font-family: 'Cinzel', serif !important;
        font-size: 1.1rem !important; /* ğŸ‘ˆ ç¨å¾®ç¸®ä¸€é»ï¼Œè®“é«˜ä½è½å·®æ›´æœ‰å±¤æ¬¡ */
        color: var(--forest);
        margin-left: 15px !important; 
        font-weight: 700;
        letter-spacing: 1.5px;
        opacity: 0.4; 
        /* ğŸ”¥ é—œéµï¼šåº•éƒ¨å°é½Š */
        vertical-align: baseline !important;
        text-shadow: none !important;
    }

    /* é‡‘é‚Šè† å›Š */
    .brand-capsule, .draw-desc-p {
        display: table !important;
        margin: 10px auto 0 auto !important; 
        font-family: 'Noto Serif TC', serif !important;
        font-size: 0.85rem !important;
        color: #777;
        background: #fffdf9;
        padding: 4px 22px !important;
        border-radius: 50px;
        border: 1px solid rgba(198, 168, 124, 0.4) !important;
        box-shadow: 0 4px 10px rgba(198, 168, 124, 0.1);
    }

    
    
    .brand-capsule::before, .brand-capsule::after, 
    .draw-desc-p::before, .draw-desc-p::after {
        content: 'âœ¦'; color: var(--accent); margin: 0 10px; font-size: 0.8rem;
    }

    /* ======================================================
       5. é¦–é èˆ‡ Hero å€å¡Š
       ====================================================== */
    .hero-section {
        flex-direction: column;
        text-align: center;
        padding: 40px 20px 60px 20px;
        gap: 20px;
        background: linear-gradient(180deg, #fffcf5 0%, #f4f7f6 100%);
        border-radius: 0 0 40px 40px;
        margin-bottom: 50px;
        border-bottom: none;
    }

    /* åŸ¹åŸ¹é ­åƒ */
    .hero-img { 
        margin: 0 auto; 
        width: 220px; height: 220px; 
        border-radius: 50%; 
        overflow: hidden; 
        border: 6px solid white; 
        box-shadow: 0 15px 35px rgba(198, 168, 124, 0.25);
        animation: floatImg 6s ease-in-out infinite;
        display: flex; justify-content: center; align-items: center;
        background-color: white; 
        position: relative;
    }
    .hero-img img { 
        width: 110% !important; height: 110% !important; 
        object-fit: contain; border-radius: 60%; 
        transition: transform 0.3s ease; 
    }
    .hero-img:hover img { transform: scale(1.1); }
    @keyframes floatImg { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

    /* æ­¡è¿æ¨™é¡Œ */
    .hero-text { flex: 1; max-width: 600px; z-index: 2; display: flex; flex-direction: column; align-items: center; margin: 0 auto; }
    .hero-text h1 { 
        font-size: 2.2rem; margin-bottom: 5px; color: var(--forest); letter-spacing: 2px;
        text-shadow: none; width: 100%;
    }
    .hero-text h2 { 
        font-size: 1.1rem; color: #888; font-weight: normal; margin-bottom: 25px; 
        position: relative; display: inline-block; width: 100%;
    }
    .hero-text h2::after {
        content: ''; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%);
        width: 40px; height: 3px; background: var(--accent); border-radius: 2px;
    }
    
    /* å…¬å‘Šå¡ç‰‡å€ */
   /* =========================================
       ğŸ”¥ V310 å¿…è®€å…¬å‘Šå€é˜²æ’è£œä¸ (çµ‚æ¥µåŠ å¯¬ç‰ˆ)
       ========================================= */
    
    /* 1. å¤–æ¡†ï¼šä¸Šæ–¹å…§è·é–‹åˆ° 70pxï¼Œçµ•å°å¤ å¯¬ */
    /* 1. å¤–æ¡†ï¼šé€™è£¡æ§åˆ¶æ¨™é¡Œèˆ‡æŒ‰éˆ•çš„è·é›¢ */
    #announcement-wrapper, #must-read-wrapper, #temp-wrapper {
        background: white;
        border: 1px solid rgba(198, 168, 124, 0.3);
        border-radius: 20px;
        
        /* ğŸ”¥ æ”¹é€™è£¡ï¼šæŠŠ 70px æ”¹æˆ 50px (æˆ–æ˜¯æ‚¨è¦ºå¾—èˆ’æœçš„æ•¸å­—) */
        padding: 40px 20px 30px 20px !important; 
        
        box-shadow: 0 15px 40px rgba(26, 47, 35, 0.06);
        width: 100%;
        max-width: 500px;
        margin: 35px auto 0 auto !important;
        position: relative;
        text-align: center;
    }
    
    /* 2. æ¨™é¡Œï¼šç¨å¾®å¾€ä¸Šæä¸€é»ï¼Œä¸è¦å£“é‚£éº¼ä½ */
    .announce-badge {
        position: absolute; 
        top: -20px; /* ğŸ”¥ æ”¹é€™è£¡ï¼šåŸæœ¬ -15px æ”¹æˆ -20pxï¼Œè®“å®ƒæµ®é«˜ä¸€é» */
        left: 50%; 
        transform: translateX(-50%);
        padding: 8px 25px;
        border-radius: 50px;
        font-size: 0.95rem; 
        font-weight: 900; 
        letter-spacing: 1.5px;
        box-shadow: 0 5px 15px rgba(26, 47, 35, 0.2);
        background: var(--forest);
        color: var(--accent);
        border: 2px solid white;
        z-index: 20; 
        white-space: nowrap;
        display: block !important;
    }

    /* 3. æŒ‰éˆ•å®¹å™¨ï¼šå†åŠ å€‹ä¸Šé‚Šè·ä¿éšª */
    #hero-btn-container, #must-read-container, #temp-container { 
        display: flex; 
        gap: 15px; 
        justify-content: center; 
        flex-wrap: wrap; 
        margin-top: 5px; /* é€™è£¡ç¨å¾®ç¸®å°ï¼Œå› ç‚º padding å·²ç¶“å¤ å¤§äº† */
    }
    .btn-primary {
        background: white; color: var(--forest); border: 2px solid var(--forest);
        box-shadow: none; padding: 10px 25px; font-size: 1rem; transition: all 0.2s;
    }
    .btn-primary:hover {
        background: var(--forest); color: white; transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(26, 47, 35, 0.2);
    }

    /* ä¸‰å¤§åŠŸèƒ½é¸å–® */
    .hero-menu-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        width: 100%;
        max-width: 800px;
        margin: 30px auto 0 auto;
    }
    .hero-menu-item {
        background: white;
        border: 2px solid rgba(255, 255, 255, 0.8);
        border-radius: 20px;
        padding: 20px 10px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 5px 20px rgba(26, 47, 35, 0.05);
        display: flex; flex-direction: column; align-items: center; gap: 8px;
    }
    .hero-menu-item:hover { transform: translateY(-8px); box-shadow: 0 15px 35px rgba(26, 47, 35, 0.15); border-color: var(--accent); }
    
    .hero-menu-icon {
        font-size: 2.2rem; color: var(--forest); background: #f4f7f6;
        width: 70px; height: 70px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        margin-bottom: 5px; transition: 0.3s;
    }
    .hero-menu-item:hover .hero-menu-icon { background: var(--forest); color: var(--accent); transform: scale(1.1) rotate(10deg); }
    
    .hero-menu-text { font-size: 1.1rem; font-weight: 900; color: var(--forest); letter-spacing: 1px; }
    .hero-menu-desc { font-size: 0.9rem; color: #777; line-height: 1.5; margin-top: 5px; font-weight: normal; }

    /* ======================================================
       6. é ç´„æµç¨‹èˆ‡è¡¨å–®æ¨£å¼ (V1000 å“ç‰Œè³ªæ„Ÿæœ€çµ‚æ ¡æº–ç‰ˆ)
       ====================================================== */
    
    /* é¡åˆ¥é¸æ“‡å¡ç‰‡ï¼šå¢åŠ ç§»å‹•å¹…åº¦èˆ‡é‡‘è‰²é™°å½± */
    .cat-card { 
        border: 1px solid rgba(0,0,0,0.05); 
        padding: 22px 30px; 
        border-radius: 16px; 
        margin-bottom: 15px; 
        cursor: pointer; 
        background: var(--white); 
        transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
        display: flex; 
        align-items: center; 
        justify-content: space-between;
        box-shadow: 0 4px 15px rgba(26, 47, 35, 0.03); /* æ¥µæ·¡çš„ç¶ è‰²ç³»é™°å½± */
    }
    .cat-card:hover { 
        border-color: var(--accent); 
        background: #fffdf9; 
        transform: translateX(8px); /* ğŸ‘ˆ è®“é€²å…¥æ„Ÿæ›´æ˜é¡¯ */
        box-shadow: 0 10px 25px rgba(198, 168, 124, 0.15); /* é‡‘è‰²èª¿é™°å½± */
    }
    .cat-card h3 { margin: 0; border: none; padding: 0; font-size: 1.25rem; color: var(--forest); font-weight: bold; }
    
    /* æœå‹™ç´°é …å¡ç‰‡ï¼šæ”¹ç‚ºæ›´æŸ”å’Œçš„èƒŒæ™¯ */
    .service-card { 
        background: #ffffff; 
        border: 1px solid #f0f0f0; 
        padding: 20px; 
        border-radius: 15px; 
        margin-bottom: 15px; 
        transition: all 0.2s ease; 
    }
    .service-card:hover { 
        border-color: var(--accent); 
        box-shadow: 0 8px 20px rgba(26, 47, 35, 0.05); 
    }
    .service-card.disabled-card { opacity: 0.4; filter: grayscale(1); }
    
    .service-header { display: flex; justify-content: space-between; align-items: center; width: 100%; }
    .service-info { 
        display: flex; 
        align-items: center; 
        gap: 15px; 
        font-weight: bold; 
        font-size: 1.1rem; 
        cursor: pointer; 
        flex: 1; 
        color: var(--forest);
    }
    .service-info input { width: 22px; height: 22px; cursor: pointer; accent-color: var(--forest); }
    
    /* åƒ¹æ ¼æ¨™ç±¤ï¼šæ”¹æˆé‡‘æ£•è‰²å­—ï¼Œæ›´æœ‰åƒ¹å€¼æ„Ÿ */
    .price-badge { 
        background: var(--forest); 
        color: var(--accent); /* ğŸ‘ˆ é—œéµï¼šæ·±ç¶ é…é‡‘å­— */
        padding: 4px 14px; 
        border-radius: 8px; 
        font-size: 14px; 
        font-weight: 900;
        font-family: 'Cinzel', serif;
        letter-spacing: 1px;
    }
    
    .service-desc { font-size: 0.95rem; color: #888; margin-left: 38px; padding-top: 5px; line-height: 1.5; }
    
    /* åŠ è³¼å€ç¶²æ ¼ï¼šèƒŒæ™¯æ”¹ç‚ºè¶…æ·¡æ£®æ—ç¶  */
    .sub-check-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
        gap: 12px; 
        margin-top: 15px; 
        padding: 18px; 
        background: rgba(26, 47, 35, 0.04); /* ğŸ‘ˆ 5% æ¿ƒåº¦çš„æ£®æ—ç¶  */
        border-radius: 12px; 
        border: 1px solid rgba(26, 47, 35, 0.05);
    }
    .sub-opt-label { font-size: 14px; display: flex; align-items: center; gap: 10px; cursor: pointer; color: var(--forest-light); font-weight: 500; }
    .sub-opt-label input { width: 18px; height: 18px; accent-color: var(--accent); }
    
    /* çµç®—å€ï¼šå›æ­¸ä¸»è‰²èª¿ï¼Œç§»é™¤æ©˜è‰² */
    .total-box { 
        text-align: right; 
        font-size: 2rem; 
        font-weight: 900; 
        color: var(--forest); /* ğŸ‘ˆ å›æ­¸æ·±ç¶ è‰²ï¼Œé¡¯å¾—å°ˆæ¥­ç¨³é‡ */
        border-top: 2px dashed #eee; 
        padding-top: 25px; 
        margin-top: 35px; 
        font-family: 'Cinzel', serif; 
        letter-spacing: 1px;
    }
    
    /* å„ªæƒ åˆ¸å€ï¼šæ”¹ç‚ºå¯¦ç·šæ·¡é‡‘é‚Š */
    .coupon-box { 
        background: #fffdf9; 
        padding: 15px 20px; 
        border-radius: 12px; 
        border: 1px solid rgba(198, 168, 124, 0.4); /* ğŸ‘ˆ å¯¦ç·šæ¯”è™›ç·šæ›´é«˜ç´š */
        margin-top: 25px; 
        display: flex; 
        gap: 15px; 
        align-items: center; 
    }
    .coupon-msg { font-size: 13px; font-weight: bold; margin-top: 8px; letter-spacing: 0.5px; }
    /* æ•…äº‹èˆ‡è¦å‰‡æ–‡å­— */
    .story-text p { font-size: 1.1rem; line-height: 1.8; color: #444; margin-bottom: 20px; }
    .highlight-text { color: #a0522d; font-weight: bold; background: rgba(198, 168, 124, 0.15); padding: 10px 15px; border-radius: 8px; border-left: 4px solid var(--accent); margin: 20px 0; }
    .rule-item { margin-bottom: 30px; }
    .rule-head { color: var(--accent); font-size: 1.3rem; margin-bottom: 12px; display: flex; align-items: center; font-weight: bold; }
    .rule-num { background: var(--forest); color: var(--accent); width: 35px; height: 35px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 18px; font-weight: bold; flex-shrink: 0; }
    .rule-body { font-size: 1.05rem; color: #555; line-height: 1.8; margin-left: 50px; }
    .hd-chart-container { text-align: center; margin: 30px 0; }
    .hd-chart-container img { max-width: 100%; height: auto; border-radius: 12px; border: 1px solid #ddd; box-shadow: var(--shadow-soft); }
    .hd-caption { font-size: 13px; color: #888; margin-top: 8px; font-style: italic; }
    .disclaimer-box { background-color: #fffcf5; border: 2px dashed var(--accent); border-radius: 8px; padding: 15px 20px; margin: 20px auto 30px auto; text-align: center; max-width: 90%; width: 600px; position: relative; overflow: hidden; box-shadow: 0 4px 10px rgba(198, 168, 124, 0.15); }
    .disclaimer-box::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 5px; background-color: var(--accent); }
    .disclaimer-box p { margin: 5px 0; color: var(--forest); font-weight: bold; font-size: 1rem; line-height: 1.6; }

    /* ======================================================
       7. åŸ¹ç™’å¯¶å…¸ (Knowledge Base)
       ====================================================== */
    .kb-cat-view, .kb-article-view {
        background: #fdfaf5; min-height: 80vh; padding: 40px 20px;
        position: relative; overflow: visible !important; 
    }
    .kb-article-view {
        background: #ffffff; padding: 40px 50px; 
        border-radius: 16px; box-shadow: 0 10px 40px rgba(26, 47, 35, 0.08); 
        border: 1px solid rgba(0,0,0,0.02); margin-bottom: 60px; max-width: 900px; margin-left: auto; margin-right: auto; 
    }
    .kb-cat-header { text-align: center; margin-bottom: 40px; }
    .kb-cat-title-h1 { font-family: 'Noto Serif TC', serif; font-size: 2.5rem; color: var(--forest); font-weight: 900; margin: 0; letter-spacing: 2px; text-shadow: 2px 2px 0px rgba(198, 168, 124, 0.2); }
    .kb-article-title-h1 { font-family: 'Noto Serif TC', serif; font-size: 2rem; font-weight: 900; color: var(--forest); margin-bottom: 20px; line-height: 1.4; text-align: center; }
    
    .kb-reading-mode .kb-header { display: none !important; }
    .kb-reading-mode #kb-container { padding-top: 30px; }

    /* ğŸ”¥ ä¿®å¾©ï¼šä¾¿åˆ©è²¼ (Sticky Note) */
    .kb-tiny-note {
        position: absolute; 
        top: 25px; 
        right: 30px; 
        z-index: 99; /* ğŸ‘ˆ æ‹‰é«˜å±¤ç´šï¼Œç¢ºä¿ä¸è¢«è“‹ä½ */
        background: #ffffff; 
        border: 2px dashed var(--accent); 
        padding: 15px 20px; 
        border-radius: 12px;
        box-shadow: 0 5px 20px rgba(198, 168, 124, 0.15);
        font-size: 12px; color: #888; text-align: left; line-height: 1.7; font-family: sans-serif;
        max-width: 300px; transform: rotate(1deg); transition: transform 0.3s ease;
    }
    .kb-tiny-note:hover { transform: rotate(0deg) scale(1.02); box-shadow: 0 8px 25px rgba(198, 168, 124, 0.25); }

    /* KB åˆ†é¡åˆ—è¡¨ */
    .kb-list-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; padding: 5px 0; }
    .kb-article-card { background: #ffffff; padding: 25px; border-radius: 12px; border: 1px solid #f0f0f0; border-left: 6px solid var(--accent); box-shadow: 0 4px 15px rgba(0,0,0,0.03); cursor: pointer; transition: all 0.3s ease; display: flex; justify-content: space-between; align-items: center; position: relative; overflow: hidden; }
    .kb-article-card:hover { transform: translateY(-5px); box-shadow: 0 12px 30px rgba(26, 47, 35, 0.15); border-left-color: var(--forest); }
/* KB å¡ç‰‡å…§å®¹å€ - æ”¹ç‚ºæ©«å‘æ’åˆ— */
    .kb-card-content { 
        display: flex; 
        flex-direction: row !important; /* ğŸ‘ˆ å¼·åˆ¶æ©«å‘ */
        align-items: center !important; /* ğŸ‘ˆ å‚ç›´ç½®ä¸­ */
        gap: 12px; /* ğŸ‘ˆ æ•¸å­—èˆ‡æ–‡å­—çš„é–“è· */
        text-align: left;
    }
    .kb-card-num { font-family: 'Cinzel', serif; font-size: 1.8rem; color: var(--accent); font-weight: 900; line-height: 1; }
    .kb-card-text { font-size: 1.1rem; font-weight: bold; color: var(--forest); letter-spacing: 0.05em; }
    .kb-arrow { color: #ddd; font-size: 1.5rem; transition: 0.3s; }
    .kb-article-card:hover .kb-arrow { color: var(--forest); transform: translateX(5px); }
    
    details.kb-section-group { margin-bottom: 40px; transition: 0.3s; }
    summary.kb-mid-separator { display: flex; align-items: center; justify-content: center; cursor: pointer; list-style: none; margin-bottom: 25px; outline: none; position: relative; }
    summary.kb-mid-separator::-webkit-details-marker { display: none; }
    summary.kb-mid-separator::before, summary.kb-mid-separator::after { content: ''; height: 2px; background: #e0e0e0; flex: 1; margin: 0 20px; }
    .kb-mid-badge { background: var(--forest); color: var(--accent); padding: 10px 35px; border-radius: 50px; font-size: 1.2rem; font-weight: bold; font-family: 'Noto Serif TC', serif; box-shadow: 0 4px 15px rgba(26, 47, 35, 0.2); display: flex; align-items: center; gap: 10px; transition: 0.3s; border: 2px solid transparent; }
    summary.kb-mid-separator:hover .kb-mid-badge { background: #fff; color: var(--forest); border-color: var(--forest); transform: translateY(-3px); }
    .kb-mid-badge::after { content: 'â–¼'; font-size: 0.8em; transition: transform 0.3s; }
    details[open] summary .kb-mid-badge::after { transform: rotate(180deg); }

    .kb-meta-row { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
    .kb-tag { font-size: 0.9rem; padding: 4px 12px; border-radius: 20px; font-weight: bold; letter-spacing: 1px; }
    .kb-tag-big { background: var(--forest); color: #fff; }
    .kb-tag-mid { background: #fffcf5; color: var(--accent); border: 1px solid var(--accent); }
    .kb-divider { color: #ccc; font-size: 0.8rem; }

    /* ======================================================
       8. æŠ½å¡ç³»çµ± & ç·¨è¼¯å™¨
       ====================================================== */
    #draw-area { display: grid; grid-template-columns: repeat(16, 1fr); gap: 25px 0; padding: 40px 0; perspective: 1000px; width: 100%; max-width: 800px; margin: 0 auto; justify-content: center; }
    .card-back { width: 130%; justify-self: center; aspect-ratio: 3/5; height: auto; background-image: url('https://geyrpowhaqfhnxghpokr.supabase.co/storage/v1/object/public/site-assets/cardback.png'); background-repeat: no-repeat; background-position: center; background-size: cover; border-radius: 4px; cursor: pointer; position: relative; box-shadow: -2px 0 6px rgba(0,0,0,0.3); z-index: 1; will-change: transform; transition: transform 0.2s ease-out; }
    .card-back.is-selected { transform: translateY(-30px) !important; z-index: 200 !important; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5); filter: brightness(1.1); }
    @keyframes cardShuffleIn { from { opacity: 0; transform: translateX(-30px) rotateY(-10deg); } to { opacity: 1; transform: translateX(0) rotateY(0); } }
    @keyframes cardDrawUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-160px); opacity: 1; box-shadow: 0 0 30px var(--accent); } }
    .card-back.is-drawing { animation: cardDrawUp 0.6s ease-out forwards; z-index: 999 !important; pointer-events: none; }
    @media (min-width: 1025px) { .card-back:not(.is-drawing):not(.is-selected):hover { transform: translateY(-40px) !important; z-index: 100; box-shadow: 0 -5px 15px rgba(0,0,0,0.3); } }

    .card-reveal { position: relative; width: 340px; height: 580px; background: #fff; border-radius: 24px; overflow: hidden; box-shadow: 0 0 60px rgba(198, 168, 124, 0.5); transform: scale(0.8) rotateY(90deg); opacity: 0; transition: 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .result-overlay.active .card-reveal { transform: scale(1) rotateY(0); opacity: 1; }
    .close-card-btn { position: fixed; top: 30px; right: 30px; width: 50px; height: 50px; border-radius: 50%; background: rgba(0, 0, 0, 0.6); border: 2px solid rgba(255, 255, 255, 0.5); color: white; font-size: 30px; display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 2002; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
    .close-card-btn:hover { background: var(--accent); color: var(--forest); transform: rotate(90deg); border-color: var(--forest); }
    
    /* ğŸ”¥ ä¿®å¾©ï¼šå¡ç‰‡èƒŒæ™¯åœ– (åŸæœ¬é è¨­é€æ˜åº¦0å°è‡´çœ‹ä¸è¦‹) */
    .layer-bg { 
        width: 100%; height: 100%; object-fit: cover; 
        position: absolute; top:0; left:0; z-index: 0; 
        opacity: 1; /* ğŸ‘ˆ æ”¹ç‚º 1ï¼Œç¢ºä¿æ²’è¼‰å…¥å®Œæˆä¹Ÿèƒ½çœ‹è¦‹ */
        background-color: var(--cream); 
    }
    .layer-text { position: absolute; z-index: 10; white-space: pre-wrap; text-align: center; transform: translate(-50%, -50%); pointer-events: none; width: max-content; }
    .img-loader { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 5; color: var(--accent); font-size: 40px; display: none; }
    .fa-spinner { animation: spin 2s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    /* ç·¨è¼¯å™¨ */
    .ql-editor { padding: 0; color: #333; font-size: 16px; line-height: 1.8; font-family: -apple-system, "Microsoft JhengHei", sans-serif; overflow-wrap: break-word; }
    .ql-editor img { max-width: 100%; height: auto; display: block; margin: 20px 0; border-radius: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .ql-editor ul, .ql-editor ol { padding-left: 5px !important; margin-bottom: 5px !important; margin-top: 0 !important; }
    .ql-editor li { padding-left: 1.2em !important; margin-bottom: 0px !important; line-height: 1.3 !important; padding-bottom: 0px !important; }
    .ql-editor li > p { margin: 0 !important; padding: 0 !important; display: inline-block !important; line-height: 1.3 !important; }
    .ql-editor li::before { margin-right: 0.3em !important; width: 1.2em !important; text-align: center !important; display: inline-block !important; }
    .ql-editor .ql-indent-1 { padding-left: 2em; }
    .ql-editor .ql-indent-2 { padding-left: 4em; }
    .ql-editor .ql-indent-3 { padding-left: 6em; }
    .ql-editor .ql-size-small { font-size: 0.85rem; color: #666; line-height: 1.6; }
    .ql-editor .ql-size-large { font-size: 1.5rem; font-weight: 900; margin-top: 30px; margin-bottom: 10px; line-height: 1.4; display: block; color: var(--forest); }
    .ql-editor .ql-size-huge { font-size: 2.2rem; font-weight: 900; margin-top: 40px; margin-bottom: 25px; line-height: 1.2; display: block; color: var(--forest); text-align: center; }
    .ql-editor blockquote { border-left: 5px solid var(--shopee, #d35400); background-color: #fffaf0; padding: 15px 20px; margin: 20px 0; color: #8a5a00; font-style: italic; font-weight: bold; }
    .ql-editor h2.title-boxed-h2 { border-left: 8px solid var(--accent); background: var(--forest); color: #fff; padding: 10px 20px; margin: 30px 0 15px 0; border-radius: 4px; font-family: 'Noto Serif TC', serif; font-size: 1.4rem; line-height: 1.4; display: table; box-shadow: 4px 4px 0px rgba(198, 168, 124, 0.4); }
    .ql-editor h3.title-boxed-h3 { border: 2px solid var(--accent); background: #fffcf5; color: var(--forest); display: inline-flex !important; align-items: center !important; justify-content: center; padding: 8px 35px !important; margin: 25px 0 15px 0; border-radius: 50px; font-family: 'Noto Serif TC', serif; width: auto; max-width: 100%; min-height: 50px; }
    .ql-editor h3.title-boxed-h3 .ql-size-large { margin: 0 !important; padding: 0 !important; line-height: 1.2 !important; display: inline !important; border: none !important; }
    .ql-font-monospace { font-family: inherit !important; letter-spacing: 0.05em; color: #444; }
    strong[style*="background-color"] { padding: 0 4px; border-radius: 2px; }

   /* ======================================================
       9. æ‰‹æ©Ÿç‰ˆ RWD (V420 æ¼¢å ¡æ¢å¾© + æŠ½å¡ä¿®æ­£ + æ¯”ä¾‹ç˜¦èº«)
       ====================================================== */
    @media (max-width: 768px) {
        /* 1. å…¨å±€ç˜¦èº«ï¼šæ¸›å°‘å€å¡Šèˆ‡å¡ç‰‡é–“è· */
        .section { padding: 15px 12px 100px 12px !important; }
        .card { padding: 20px 15px !important; border-radius: 12px !important; }
        
        /* 2. å°èˆªèˆ‡æ¼¢å ¡æŒ‰éˆ•ä¿®æ­£ */
        nav { padding: 0 15px; height: 70px; display: flex; justify-content: space-between; align-items: center; }
        .logo-img { max-height: 48px; }
        .hamburger-btn { 
            display: block !important; /* ğŸ”¥ æ¼¢å ¡æŒ‰éˆ•å¼·åˆ¶é¡¯ç¾ */
            font-size: 24px;
            color: var(--white);
            z-index: 1001;
        }
        .nav-links { 
            display: none; /* å¹³å¸¸éš±è— */
            position: absolute; top: 70px; left: 0; width: 100%; 
            background: var(--forest); flex-direction: column; padding: 10px 0; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.2); z-index: 1000;
        }
        .nav-links.active { display: flex !important; } /* é»æ“Šå¾Œå±•é–‹ */
        .nav-links button { padding: 12px 0; font-size: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        
        /* 3. é¦–é  Hero æ¯”ä¾‹ä¿®æ­£ */
        .hero-section { border-radius: 0 0 25px 25px; padding: 30px 15px 40px 15px; }
        .hero-img { width: 150px; height: 150px; border-width: 4px; }
        .hero-text h1 { font-size: 1.6rem; letter-spacing: 1px; }
        .hero-text h2 { font-size: 0.9rem; margin-bottom: 20px; }
        
        /* 4. å…¬å‘Šå€å„ªåŒ– */
        #must-read-wrapper, #temp-wrapper {
            padding: 45px 12px 20px 12px !important;
            margin: 25px auto 0 auto !important;
            width: 100%;
        }
        .announce-badge { top: -12px !important; padding: 5px 18px !important; font-size: 0.8rem !important; }

        /* 5. å“ç‰Œæ¨™é¡Œä¿®æ­£ (ä¸­æ–‡å¤§å­—åœ¨ä¸Šï¼Œè‹±æ–‡å°å­—åœ¨ä¸‹) */
        .brand-h3-zh, .draw-title-zh { 
            display: block !important; 
            font-size: 1.4rem !important; 
            letter-spacing: 2px;
            text-align: center;
            margin-bottom: 0 !important;
        }
        .brand-h2-en, .draw-title-h2 { 
            display: block !important; 
            margin-left: 0 !important; 
            margin-top: 2px !important; 
            font-size: 0.8rem !important;
            text-align: center;
            opacity: 0.5;
        }
        .brand-capsule, .draw-desc-p { 
            font-size: 0.75rem !important; 
            padding: 6px 18px !important; 
            margin-top: 10px !important;
        }

        /* 6. åŸ¹ç™’å¯¶å…¸ï¼šæ•¸å­—èˆ‡æ–‡å­—ä½µè¡Œ */
        .kb-card-content { flex-direction: row !important; align-items: center !important; gap: 10px; text-align: left; }
        .kb-card-num { font-size: 1.1rem !important; min-width: 32px; margin-bottom: 0 !important; }
        .kb-card-text { font-size: 0.9rem !important; line-height: 1.4; }
        .kb-article-card { padding: 12px 15px !important; margin-bottom: 8px; }
        .kb-tiny-note { top: -15px !important; right: -5px !important; font-size: 9px !important; max-width: 55%; transform: rotate(2deg) !important; }

        /* 7. æœå‹™é ç´„ç˜¦èº« */
        .cat-card { padding: 15px !important; border-radius: 12px !important; }
        .cat-card h3 { font-size: 1.05rem !important; }
        .service-card { padding: 15px !important; }
        .service-info { font-size: 0.95rem !important; }
        .price-badge { font-size: 11px !important; padding: 2px 8px !important; }
        .sub-check-grid { grid-template-columns: 1fr; padding: 12px !important; }
        .total-box { font-size: 1.4rem !important; margin-top: 25px; }

        /* 8. æŠ½å¡ç³»çµ±ä¿®æ­£ï¼š4æ¬„æ’åˆ—ä¸ç ´ç‰ˆ */
        #draw-area { grid-template-columns: repeat(8, 1fr); gap: 6px 0; width: 92%; margin: 0 auto; padding: 15px 0; }
        .card-back { width: 115%; }
        .close-card-btn { top: 20px; right: 20px; width: 40px; height: 40px; font-size: 24px; }

        /* 9. Footer åƒ…åœ¨é¦–é  */
        .footer-banner { 
            position: relative !important; 
            margin-top: 40px; 
            padding-bottom: 40px; 
            border-radius: 20px 20px 0 0;
        }
    }

    /* æ©«å‘æ¨¡å¼è£œä¸ */
    @media (max-width: 768px) and (orientation: landscape) {
        .kb-tiny-note { top: 10px !important; right: 15px !important; max-width: 40%; }
        .kb-cat-header, .kb-article-title-h1 { margin-top: 20px; }
        #draw-area { grid-template-columns: repeat(8, 1fr) !important; } /* æ©«å‘æœ‰ç©ºé–“å¯æ”¾8æ¬„ */
    }
</style>

</head>
<body>

<nav>
    <div class="logo-area" onclick="showSection('home')">
        <img src="logo.png" alt="åŸ¹ç™’è©¦é©—å®¤" class="logo-img" id="site-logo">
    </div>
    
    <button class="hamburger-btn" onclick="toggleMenu()">â˜°</button>

    <div class="nav-links" id="nav-menu">
        <button onclick="showSection('home')" id="nav-home" class="active">é¦–é </button>
        <button onclick="showSection('booking-step-1')" id="nav-booking">æœå‹™é ç´„</button>
        <button onclick="showSection('knowledge')" id="nav-knowledge">åŸ¹ç™’å¯¶å…¸</button>
        <button onclick="showSection('draw')" id="nav-draw">èƒ½é‡æŠ½å¡</button>
        <button onclick="showSection('member')" id="nav-member">æœƒå“¡å°ˆå€</button>
    </div>
</nav>

<div id="home" class="section active">
    <div class="hero-section">
        <div class="hero-img">
            <img src="logohuman.png" alt="åŸ¹åŸ¹" id="site-hero">
        </div>

        <div class="hero-text">
            <h1>åŸ¹ç™’è©¦é©—å®¤</h1>
            <h2>æˆ‘æ˜¯ç©ºé–“å‰µè¾¦äººåŸ¹åŸ¹</h2>
            
            <div id="must-read-wrapper" style="width: 100%; max-width: 500px; margin: 15px auto 10px auto; border: 2px solid var(--forest); border-radius: 12px; padding: 15px; background: #fff; text-align: center; display: none;">
                <div class="announce-badge" style="background: var(--forest); color: var(--accent);">âœ¦ å¿…è®€å°ˆå€ âœ¦</div>
                <div id="must-read-container" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-top:10px;"></div>
            </div>

            <div id="temp-wrapper" style="width: 100%; max-width: 500px; margin: 0 auto 20px auto; border: 2px dashed #e67e22; border-radius: 12px; padding: 15px; background: #fffcf0; text-align: center; display: none;">
                <div class="announce-badge" style="background: #e67e22; color: #fff;">ğŸ”¥ æœ€æ–°å¿«è¨Š ğŸ”¥</div>
                <div id="temp-container" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-top:10px;"></div>
            </div>

            <div class="hero-menu-grid">
                <div class="hero-menu-item" onclick="showSection('booking-step-1')">
                    <div class="hero-menu-icon"><i class="fa-regular fa-calendar-check"></i></div>
                    <div class="hero-menu-text">æœå‹™é ç´„</div>
                    <div class="hero-menu-desc">éˆæ“ºèƒ½é‡èª¿æ•´<br>æ‰¾å›åŸå» è¨­å®š</div>
                </div>

                <div class="hero-menu-item" onclick="showSection('knowledge')">
                    <div class="hero-menu-icon"><i class="fa-solid fa-book-open"></i></div>
                    <div class="hero-menu-text">åŸ¹ç™’å¯¶å…¸</div>
                    <div class="hero-menu-desc">éå°ˆæ¥­çŸ¥è­˜åº«<br>å…§è€—è‡ªæ•‘ç­†è¨˜</div>
                </div>

                <div class="hero-menu-item" onclick="showSection('draw')">
                    <div class="hero-menu-icon"><i class="fa-solid fa-wand-magic-sparkles"></i></div>
                    <div class="hero-menu-text">èƒ½é‡æŠ½å¡</div>
                    <div class="hero-menu-desc">64 é–˜é–€æŒ‡å¼•<br>ç›´è¦ºæŠ½å–è¨Šæ¯</div>
                </div>
            </div>

        </div>
    </div>
     <div class="footer-banner">
        <div class="footer-content">
            
            <div class="social-group">
                <a href="https://line.me/R/ti/p/@927ctmwa" target="_blank" class="social-btn">
                    <i class="fa-brands fa-line" style="font-size: 1.2rem;"></i> LINE
                </a>
                
                <a href="https://instagram.com/nomad91310" target="_blank" class="social-btn">
                    <i class="fa-brands fa-instagram" style="font-size: 1.2rem;"></i> IG
                </a>

                <a href="https://facebook.com/å¦³çš„ç²‰å°ˆ" target="_blank" class="social-btn">
                    <i class="fa-brands fa-facebook-f" style="font-size: 1.1rem;"></i> FB
                </a>

                <a href="https://www.threads.net/@nomad91310" target="_blank" class="social-btn">
                    <i class="fa-brands fa-threads" style="font-size: 1.1rem;"></i> Threads
                </a>
            </div>

            <div class="copyright">
                &copy; 2026 åŸ¹ç™’è©¦é©—å®¤
            </div>
            
        </div>
    </div>
    
</div>

    
     

<div id="booking-step-1" class="section">
    
    <div class="brand-section-header">
        <div class="brand-h3-zh">æœå‹™é ç´„</div>
         <div class="brand-h2-en">SERVICE BOOKING</div>       
        <div class="brand-capsule">
            è«‹é¸æ“‡æ‚¨éœ€è¦çš„æœå‹™é ˜åŸŸ
        </div>
    </div>

    <div class="card">
        <div id="category-list">è¼‰å…¥è³‡æ–™ä¸­...</div>
    </div>
</div>

<div id="booking-step-2" class="section">
    <div class="card">
        <button class="btn-back-capsule" onclick="showSection('booking-step-1')">
            <i class="fa-solid fa-arrow-left"></i> è¿”å›é¡åˆ¥
        </button>

        <h2 id="active-cat-name" style="margin-top:0;">æœå‹™è©³æƒ…</h2>
        
        <div class="payment-notice-box">
            <div class="form-group" style="margin-bottom:15px;">
                <label>ğŸ”¶ ä»˜æ¬¾ç‹€æ…‹é¸æ“‡</label>
                <select id="pay-status" onchange="toggleOTA()"> 
                    <option value="unpaid">ğŸ”— æˆ‘é‚„æ²’ä»˜æ¬¾ (é ç´„å¾Œè«‹å‚³é€£çµçµ¦æˆ‘)</option>
                    <option value="ota">ğŸ›’ æˆ‘å·²æ–¼å…¶ä»–ç¶²è·¯å¹³å°ä»˜æ¬¾</option> 
                </select>
            </div>
            
            <div id="ota-area" style="display:none; border-top:1px dashed #26c6da; padding-top:15px; margin-top:10px;">
                <div class="form-group">
                    <label style="color:#006064;">é¸æ“‡ä»˜æ¬¾å¹³å°</label>
                    <select id="ota-source-select" style="background:white; border:1px solid #26c6da;"></select>
                </div>
                <div class="form-group" style="margin-bottom:0;">
                    <label style="color:#006064;">è¨‚å–®ç·¨è™Ÿ (å¿…å¡«)</label>
                    <input type="text" id="ota-order-id" placeholder="è«‹è²¼ä¸Šè©²å¹³å°çš„è¨‚å–®ç·¨è™Ÿ" style="background:white; border:1px solid #26c6da;">
                </div>
            </div>
        </div>

        <div class="form-group"><label class="required">æ‚¨çš„å§“å</label><input type="text" id="c-name" placeholder="çœŸå¯¦å§“å"></div>
        <div class="form-group">
            <label class="required">æ‰‹æ©Ÿè™Ÿç¢¼ (å°‡ä½œç‚ºç™»å…¥å¸³è™Ÿ)</label>
            <input type="tel" id="c-phone" onblur="checkPhoneMembership()" placeholder="09xxxxxxxx (éœ€10ç¢¼æ•¸å­—)">
            <small id="phone-status" style="display:block; margin-top:8px; font-weight:bold;"></small>
        </div>
        <div class="form-group"><label class="required">E-mail (æ¥æ”¶å ±å‘Šé€šçŸ¥)</label><input type="email" id="c-email" placeholder="example@mail.com"></div>
                
        <hr style="border:0; border-top:1px dashed #ddd; margin: 40px 0;">
        
        <label style="font-size:1.4rem; color:var(--forest); margin-bottom:20px;">1. é¸æ“‡æ–¹æ¡ˆå…§å®¹èˆ‡åŠ è³¼</label>
        <div id="items-area" style="margin-bottom:40px;"></div>
        
        <div class="coupon-box" style="margin-top: 25px;">
            <input type="text" id="coupon-code" placeholder="è¼¸å…¥å„ªæƒ ä»£ç¢¼ (è‹¥ç„¡å¯è·³é)" style="flex:1; border:1px solid #ccc; background:#fff;">
            <button class="btn-secondary" onclick="verifyCoupon()" style="margin:0; padding:12px 25px;">å¥—ç”¨</button>
        </div>
        <div id="coupon-msg" class="coupon-msg"></div>
        <div id="coupon-msg" class="coupon-msg"></div>

        <div id="conditional-question" style="background:#fcf8f2; padding:30px; border-radius:15px; margin:30px 0; border:1px solid #eee;"></div>
        
        <div class="form-group" id="data-flow-wrapper" style="display:none;">
            <label>ğŸ”¶ è«‹é¸æ“‡è³‡æ–™æä¾›æ–¹å¼</label>
            <select id="data-flow" onchange="toggleFlow()">
                </select>
        </div>
        <div id="flow-data" style="background:#f9f9f9; padding:25px; border-radius:15px; margin-bottom:20px; border:1px solid #eee;">
            <div class="form-group"><label>å‡ºç”Ÿæ—¥æœŸ</label><input type="date" id="b-date"></div>
            <div class="form-group">
                <label>å‡ºç”Ÿç²¾ç¢ºæ™‚é–“</label>
                <input type="time" id="b-time" value="12:00">
                <small style="color:#d32f2f; display:block; margin-top:5px;">âœ… è«‹ç¢ºèªæ˜¯ä¸Šåˆæˆ–ä¸‹åˆ</small>
            </div>

            <div style="display: grid; grid-template-columns: 1.2fr 1fr; gap: 10px; margin-bottom: 20px;">
                <div class="form-group">
                    <label>å‡ºç”Ÿåœ°å€/åŸå¸‚</label>
                    <input type="text" id="b-place" placeholder="ä¾‹ï¼šå°åŒ—ã€ä¸Šæµ·ã€æ´›æ‰ç£¯">
                </div>
                <div class="form-group">
                    <label>ç•¶åœ°æ™‚å€ (GMT)</label>
                    <select id="b-timezone">
                        <option value="+8">GMT+8 (å°ç£/ä¸­æ¸¯æ¾³/æ–°é¦¬)</option>
                        <option value="+9">GMT+9 (æ—¥æœ¬/éŸ“åœ‹)</option>
                        <option value="+7">GMT+7 (æ³°åœ‹/å°å°¼)</option>
                        <option value="+10">GMT+10 (æ¾³æ´²-å¸ƒé‡Œæ–¯æœ¬)</option>
                        <option value="+0">GMT+0 (è‹±åœ‹/å€«æ•¦)</option>
                        <option value="+1">GMT+1 (å¾·/æ³•/ç¾©/ç‘/è¥¿)</option>
                        <option value="-5">GMT-5 (ç¾æ±-ç´ç´„/æ³¢å£«é “)</option>
                        <option value="-6">GMT-6 (ç¾ä¸­-èŠåŠ å“¥)</option>
                        <option value="-7">GMT-7 (ç¾å±±-ä¸¹ä½›)</option>
                        <option value="-8">GMT-8 (ç¾è¥¿-æ´›æ‰ç£¯/æº«å“¥è¯)</option>
                        <option value="other">å…¶ä»– (è«‹æ–¼å‚™è¨»èªªæ˜)</option>
                    </select>
                </div>
            </div>
            <small style="color:#666; display:block; margin-top:-10px;">âš ï¸ è‹¥ä¸ç¢ºå®šå¤ä»¤æ™‚é–“ï¼Œè«‹ä¾å‡ºç”Ÿç•¶ä¸‹é†«é™¢ç´€éŒ„ç‚ºä¸»ã€‚</small>
        </div>
        
        <div id="flow-upload" style="display:none; background:#f9f9f9; padding:25px; border-radius:15px; margin-bottom:20px; border:1px solid #eee;">
            
            <div style="margin-bottom: 15px; border-left: 4px solid var(--accent); padding-left: 15px;">
                <p style="margin:0; font-weight:bold; color:var(--forest);">ç¬¬ä¸€æ­¥ï¼šå–å¾—åœ–æª”</p>
                <p style="margin:5px 0 0 0; font-size:0.95rem;">è«‹å‰å¾€ <a href="https://humandesignasia.org/get-your-chart/" target="_blank" style="color:var(--shopee); text-decoration:underline; font-weight:bold;">äºæ´²äººé¡åœ–å­¸é™¢ (é»æ“Šå‰å¾€)</a></p>
            </div>

            <div style="margin-bottom: 20px; background: #fff; border: 1px dashed #ccc; border-radius: 8px; padding: 15px; text-align: center;">
                <p style="margin:0 0 10px 0; font-weight:bold; color:#555; font-size:14px;">ğŸ‘€ ä¸Šå‚³ç¯„æœ¬åƒè€ƒ (ç¶²ç«™å¯ç›´æ¥ä¸‹è¼‰åœ–æª”)</p>
                <img src="https://geyrpowhaqfhnxghpokr.supabase.co/storage/v1/object/public/site-assets/my_hd_chart.png" 
                     alt="æˆªåœ–ç¯„æœ¬" 
                     style="max-width: 100%; max-height: 300px; border-radius: 8px; object-fit: contain; border: 1px solid #eee;">
            </div>

            <label style="font-weight:bold; color:var(--forest); display:block; margin-bottom:10px;">ğŸ“¸ ç¬¬äºŒæ­¥ï¼šä¸Šå‚³å‰›æ‰ä¸‹è¼‰çš„åœ–æª”</label>
            <input type="file" id="c-file" accept="image/*" style="background:#fff; border:1px solid #ccc; width:100%; padding:10px; border-radius:8px;">
        </div>
        
        <div class="card" style="background:#fffcf5; border-top:none; padding:30px; margin-bottom:0; border:1px solid #fae1c3;">
            <label>ğŸ“œ æœå‹™è¦ç¯„</label>
            <div id="terms-box" style="height:150px; overflow-y:auto; border:1px solid #e0e0e0; padding:15px; font-size:14px; background:#fff; border-radius:8px; line-height:1.8;"></div>
            <label class="agree-wrapper" style="margin-top:20px; font-size:1.1rem;">
                <input type="checkbox" id="agree-check" onchange="toggleSubmitBtn(this.checked)">
                <span>æˆ‘å·²è©³ç´°é–±è®€ä¸¦åŒæ„</span>
            </label>
        </div>
        
        <div class="total-box">
            <div id="original-price-row" style="font-size:1rem; color:#999; text-decoration:line-through; display:none; margin-bottom:5px;">åŸåƒ¹: $<span id="original-price">0</span></div>
            æ‡‰ä»˜ç¸½é¡ï¼š$<span id="total-price">0</span>
        </div>
        <div style="text-align:right; margin-top:20px;">
            <button id="sub-btn" class="btn-primary" onclick="doSubmit()" disabled>è«‹å…ˆå‹¾é¸åŒæ„è¦ç¯„</button>
        </div>
    </div>
</div>

<div id="knowledge" class="section">
    <div class="kb-header">
        <button id="kb-back-btn" class="kb-back-btn" onclick="kbGoBack()">â† è¿”å›</button>
        <h2 class="kb-title">ğŸ“˜ åŸ¹ç™’å¯¶å…¸</h2>
        <div style="width:70px;"></div> 
    </div>

    <div id="kb-container">è¼‰å…¥ä¸­...</div>
</div> 
<div id="draw" class="section">
    <div class="brand-section-header" style="margin-bottom: 60px;"> 
                <div class="brand-h3-zh">64 é–˜é–€èƒ½é‡æŒ‡å¼•</div>

        <div class="brand-h2-en">ORACLE GUIDANCE</div>
        
        <div class="brand-capsule">
            æ†‘ç›´è¦ºé¸ä¸€å¼µç‰Œï¼Œé ˜å–ç•¶ä¸‹çš„æŒ‡å¼•
        </div>
    </div>

    <div id="draw-area"><div style="color:#666;"></div></div>
</div>

<div id="member" class="section">
    <div class="card" id="login-box" style="max-width:500px; margin:50px auto;">
        <h3 style="margin-top:0; text-align:center;">ğŸ‘¤ æœƒå“¡ç™»å…¥</h3>
        <div style="margin-top:30px;">
            <input type="tel" id="l-phone" placeholder="æ‰‹æ©Ÿ (å¸³è™Ÿ)" style="margin-bottom:15px;">
            <input type="password" id="l-pass" placeholder="å¯†ç¢¼" style="margin-bottom:25px;">
            <button class="btn-primary" onclick="doLogin()" style="width:100%;">ç™»å…¥ç³»çµ±</button>
        </div>
    </div>
    <div id="dash" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <h3 id="dash-welcome" style="margin:0;"></h3>
            <div>
                <button class="btn-secondary" style="font-size:14px;" onclick="openEditProfile()">ä¿®æ”¹è³‡æ–™</button>
                <button class="btn-secondary" style="font-size:14px; border-color:#999; color:#999;" onclick="doLogout()">ç™»å‡º</button>
            </div>
        </div>
        <div class="card" style="background:#f1f8e9; border:1px solid #c8e6c9;">
            <h4 style="margin-top:0; color:#2e7d32;">ğŸ“‹ æ‚¨çš„æœå‹™å ±å‘Š</h4>
            <div id="dash-history" style="max-height:500px; overflow-y:auto; margin-top:15px;"></div>
        </div>
    </div>
</div>

<div id="overlay" class="result-overlay">
    <div style="position:relative;">
        <button class="close-card-btn" onclick="closeResult()">Ã—</button>
        
        <div id="final-card" class="card-reveal">
            <img id="p-bg" class="layer-bg" src="">
            <div id="p-gate" class="layer-text"></div>
            <div id="p-info" class="layer-text"></div>
            <div id="p-zodiac" class="layer-text"></div>
            <div id="p-quote" class="layer-text"></div>
        </div>
        
        </div>
</div>
<div id="success-overlay" class="result-overlay">
    <div class="text-modal-card" style="text-align:center; padding: 40px 30px; max-width: 450px;">
        <h3 style="color:var(--forest); margin:0 0 10px 0;">ğŸ‰ é ç´„æˆåŠŸï¼</h3>
        <p style="color:#666; margin-bottom: 30px;">æ‚¨çš„é ç´„å·²é€å‡ºï¼Œè¨‚å–®ç·¨è™Ÿå¦‚ä¸‹ï¼š</p>
        
        <div id="success-order-id" style="background:#f1f8e9; color:var(--forest); padding:15px; border-radius:8px; font-weight:bold; font-size:1.2rem; margin-bottom:30px; border:1px dashed var(--forest);">
            OD123456789
        </div>

        <p style="font-size:0.9rem; color:#d32f2f; font-weight:bold; margin-bottom:15px;">
            âš ï¸ è«‹å‹™å¿…é»æ“Šä¸‹æ–¹æŒ‰éˆ•<br>å‚³é€ç·¨è™Ÿçµ¦æˆ‘ç¢ºèªï¼Œæ‰ç®—å®Œæˆå–”ï¼
        </p>

        <a id="line-super-btn" href="#" target="_blank" class="btn-primary" 
           style="background:#06c755; box-shadow:0 5px 15px rgba(6,199,85,0.4); 
                  display: inline-flex; justify-content: center; align-items: center; 
                  text-decoration: none; line-height: 50px; border-radius: 30px; 
                  padding: 0 35px; width: auto; min-width: 240px; max-width: 100%; box-sizing: border-box;">
            <i class="fa-brands fa-line" style="margin-right:10px; font-size:1.5rem;"></i> 
            <span style="font-size:1.1rem; font-weight: bold;">å‚³é€è¨‚å–®ç·¨è™Ÿ (LINE)</span>
        </a>

        <div style="margin-top:25px; background:#f5f5f5; color:#777; font-size:12px; padding:12px; border-radius:8px; line-height:1.6; border:1px solid #eee;">
            ğŸ–¥ï¸ é›»è…¦ç‰ˆç”¨æˆ¶è‹¥æ²’å®‰è£ LINE<br>
            è«‹ç›´æ¥æœå°‹ ID <b style="color:#333; user-select:all;">@927ctmwa</b> ä¸¦å›å‚³è¨‚å–®ç·¨è™Ÿå”·ï¼
        </div>

        <button onclick="closeSuccessModal()" style="margin-top:25px; background:none; border:none; color:#999; cursor:pointer; text-decoration:underline; font-size:0.9rem; padding: 10px;">
            ç¨å¾Œå†å‚³ï¼Œå…ˆå›é¦–é 
        </button>
    </div>
</div>
<div id="dynamic-overlay" class="result-overlay">
    <div class="text-modal-card">
        <h3 id="dyn-modal-title">è¼‰å…¥ä¸­...</h3>
        
        <div id="dyn-modal-content" class="story-text"></div>
        
        <button class="close-modal-btn" onclick="closeModal('dynamic-overlay')">é—œé–‰</button>
    </div>
</div>

<div id="edit-profile-overlay" class="result-overlay">
    <div class="text-modal-card" style="max-width:450px; padding:30px;">
        <h3 style="margin-top:0;">âœï¸ ä¿®æ”¹æœƒå“¡è³‡æ–™</h3>
        <label>æ‰‹æ©Ÿ (å¸³è™Ÿä¸å¯ä¿®æ”¹)</label><input type="text" id="ep-phone" disabled style="background:#eee; color:#666;">
        <label style="margin-top:15px;">å§“å</label><input type="text" id="ep-name">
        <label style="margin-top:15px;">Email</label><input type="email" id="ep-email">
        <label style="margin-top:15px;">æ–°å¯†ç¢¼ (ä¸æ”¹è«‹ç•™ç©º)</label><input type="password" id="ep-pass" placeholder="è¼¸å…¥æ–°å¯†ç¢¼">
        <div style="margin-top:30px; display:flex; gap:15px;">
            <button class="btn-secondary" onclick="closeModal('edit-profile-overlay')" style="flex:1; justify-content:center;">å–æ¶ˆ</button>
            <button class="btn-primary" onclick="saveProfile()" style="flex:1; padding:10px 0; font-size:1rem;">å„²å­˜</button>
        </div>
    </div>
</div>

<script>
    const SB_URL = "https://geyrpowhaqfhnxghpokr.supabase.co";
    const SB_KEY = "sb_publishable_aXucdq8UtvMbCKbriqpJCw_gtpYBw-r";
    const myDB = supabase.createClient(SB_URL, SB_KEY);

    let cats = [], items = [], activeCat = null, allCards = [], kbTree = {}, kbState = { level: 0 }, otas = [];
    let kbCatOrder = { big: [], mid: {}, hide_note: [] }; 
    let currentCoupon = null; 
    let currentUser = null; 
    let isMemberBlocked = false; 
    const defaultStyle = { gate: { x: 50, y: 65, size: 34, font: "'Cinzel', serif", color: "#1a1a1a", stroke: "#ffffff" }, info: { x: 50, y: 72, size: 18, font: "'Noto Serif TC', serif", color: "#1a1a1a", stroke: "transparent", w: 300 }, zodiac: { x: 85, y: 65, size: 12, font: "sans-serif", color: "#6a1b9a", stroke: "transparent" }, quote: { x: 50, y: 88, size: 15, font: "'Shippori Mincho', serif", color: "#ffffff", stroke: "#000000", w: 280, lh: 1.6, ls: 0 } };

    function showSection(id) { 
        // 1. åˆ‡æ›å€å¡Šé¡¯ç¤º
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active')); 
        document.getElementById(id).classList.add('active'); 
        
        // 2. åˆ‡æ›å°èˆªæŒ‰éˆ•ç‹€æ…‹
        document.querySelectorAll('.nav-links button').forEach(b => b.classList.remove('active'));
        const baseId = id.split('-')[0]; 
        const navBtn = document.getElementById('nav-' + baseId);
        if(navBtn) navBtn.classList.add('active');
        
        // 3. è‡ªå‹•é—œé–‰æ‰‹æ©Ÿé¸å–®
        document.getElementById('nav-menu').classList.remove('active');
        
        // ğŸ”¥ğŸ”¥ğŸ”¥ é—œéµä¿®å¾©ï¼šå¦‚æœæ˜¯é»æ“Šã€ŒåŸ¹ç™’å¯¶å…¸ã€ï¼Œå¼·åˆ¶å›åˆ°ç›®éŒ„é¦–é  ğŸ”¥ğŸ”¥ğŸ”¥
        if (id === 'knowledge') {
            renderKbHome(); // é€™ä¸€è¡Œæ•‘äº†æ•´å€‹å°èˆªï¼
        }
        
        // 4. æ²å‹•åˆ°æœ€ä¸Šæ–¹
        window.scrollTo(0,0); 
    }

    window.onload = async () => {
        // 1. åˆå§‹åŒ–è³‡æ–™ (åŸæœ¬çš„é‚è¼¯)
        await initBookingData(); 
        initDrawData(); 
        initKbData(); 
        loadSiteAssets();
        checkSession(); 

        // ğŸ”¥ğŸ”¥ğŸ”¥ æ–°å¢ï¼šç¶²å€å‚³é€é–€åµæ¸¬é›·é” ğŸ”¥ğŸ”¥ğŸ”¥
        // å–å¾—ç¶²å€åƒæ•¸ (ä¾‹å¦‚: ?view=draw)
        const params = new URLSearchParams(window.location.search);
        const targetView = params.get('view');

        // å¦‚æœç¶²å€æœ‰æŒ‡å®šå»å“ªä¸€é  (ä¸”è©²é é¢ ID å­˜åœ¨)
        if (targetView && document.getElementById(targetView)) {
            showSection(targetView); // ç›´æ¥åˆ‡æ›éå»
        } else {
            // æ²’æŒ‡å®šï¼Œæˆ–è€…äº‚æ‰“ï¼Œå°±é è¨­å›é¦–é 
            showSection('home');
        }
    };
    
    // æ‰‹æ©Ÿç‰ˆé¸å–®é–‹é—œ
    function toggleMenu() {
        const menu = document.getElementById('nav-menu');
        menu.classList.toggle('active');
    }
    function checkSession() {
        const saved = localStorage.getItem('peiyu_user');
        if (saved) {
            try {
                const { phone, pass } = JSON.parse(saved);
                document.getElementById('l-phone').value = phone;
                document.getElementById('l-pass').value = pass;
                doLogin(); 
            } catch (e) {
                console.log("è‡ªå‹•ç™»å…¥å¤±æ•ˆ");
                localStorage.removeItem('peiyu_user');
            }
        }
    }

    async function checkPhoneMembership() {
        const phone = document.getElementById('c-phone').value.trim();
        const statusEl = document.getElementById('phone-status');
        const submitBtn = document.getElementById('sub-btn');

        if (!phone || currentUser) return;
        if (!/^09\d{8}$/.test(phone)) {
            statusEl.innerHTML = "âŒ æ ¼å¼éŒ¯èª¤ (éœ€10ç¢¼)"; statusEl.style.color = "red"; submitBtn.disabled = true; return;
        }

        statusEl.innerHTML = "ğŸ” æª¢æŸ¥ä¸­...";
        const { data } = await myDB.from('profiles').select('id').eq('phone', phone).single();

        if (data) {
            isMemberBlocked = true;
            statusEl.innerHTML = `âš ï¸ æ­¤è™Ÿç¢¼å·²è¨»å†Šï¼è«‹å…ˆ <a href="#" onclick="showSection('member'); return false;" style="color:red;font-weight:bold;text-decoration:underline;">ç™»å…¥æœƒå“¡</a>`;
            statusEl.style.color = "red"; submitBtn.disabled = true; submitBtn.innerText = "è«‹å…ˆç™»å…¥æœƒå“¡";
        } else {
            isMemberBlocked = false;
            statusEl.innerHTML = "âœ… æ–°æœ‹å‹æ­¡è¿ä½ ";
            statusEl.style.color = "green";
            toggleSubmitBtn(document.getElementById('agree-check').checked);
        }
    }

    async function verifyCoupon() {
        const code = document.getElementById('coupon-code').value.trim().toUpperCase();
        const msgEl = document.getElementById('coupon-msg');
        const phone = document.getElementById('c-phone').value.trim();

        if (!phone && !currentUser) { alert("âš ï¸ è«‹å…ˆè¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼æˆ–ç™»å…¥æœƒå“¡ï¼Œæ‰èƒ½é©—è­‰å„ªæƒ åˆ¸è³‡æ ¼ï¼"); return; }
        if (!code) { msgEl.innerText = ""; currentCoupon = null; calcTotal(); return; }

        msgEl.className = "coupon-msg"; msgEl.innerText = "æŸ¥è©¢ä¸­...";

        const { data: coupon, error } = await myDB.from('coupons').select('*').eq('code', code).single();

        if (error || !coupon) {
            msgEl.className = "coupon-msg error"; msgEl.innerText = "âŒ ç„¡æ•ˆçš„å„ªæƒ ä»£ç¢¼";
            currentCoupon = null;
        } else {
            if (coupon.expires_at && new Date(coupon.expires_at) < new Date()) {
                msgEl.className = "coupon-msg error"; msgEl.innerText = "âš ï¸ æ­¤ä»£ç¢¼å·²éæœŸ";
                currentCoupon = null;
            } else {
                let isMember = false;
                let searchUserId = null;

                if (currentUser) {
                    isMember = true;
                    searchUserId = currentUser.id;
                } else {
                    const { data: profile } = await myDB.from('profiles').select('id').eq('phone', phone).single();
                    if (profile) { isMember = true; searchUserId = profile.id; }
                }

                if (isMember && !coupon.allow_member) {
                    msgEl.className = "coupon-msg error"; msgEl.innerText = "âŒ æ­¤å„ªæƒ åˆ¸åƒ…é™ã€æ–°æœ‹å‹/è¨ªå®¢ã€‘ä½¿ç”¨";
                    currentCoupon = null; calcTotal(); return;
                } else if (!isMember && !coupon.allow_guest) {
                    msgEl.className = "coupon-msg error"; msgEl.innerText = "âŒ æ­¤å„ªæƒ åˆ¸åƒ…é™ã€æœƒå“¡ã€‘ä½¿ç”¨ (è«‹è¨»å†Š/ç™»å…¥)";
                    currentCoupon = null; calcTotal(); return;
                }

                if (searchUserId) {
                    const { data: history } = await myDB.from('bookings').select('id').eq('user_id', searchUserId).ilike('coupon_info', `%Code:${code}%`).limit(1);
                    if (history && history.length > 0) {
                        msgEl.className = "coupon-msg error"; msgEl.innerText = "âŒ æ‚¨å·²ä½¿ç”¨éæ­¤å„ªæƒ åˆ¸ (é™ç”¨ä¸€æ¬¡)";
                        currentCoupon = null; calcTotal(); return;
                    }
                }

                currentCoupon = coupon;
                let desc = coupon.discount_type === 'percentage' ? `æ‰“ ${coupon.discount_value < 10 ? coupon.discount_value*10 : coupon.discount_value} æŠ˜` : `æŠ˜æŠµ $${coupon.discount_value}`;
                msgEl.className = "coupon-msg success"; msgEl.innerText = `âœ… å¥—ç”¨æˆåŠŸï¼š${coupon.name} (${desc})`;
            }
        }
        calcTotal(); 
    }

    async function initBookingData() {
        // 1. è®€å–å¤§é¡
        const { data: c } = await myDB.from('service_categories').select('*').order('created_at'); 
        
        // ğŸ”¥ é—œéµä¿®æ­£ï¼šåªä¿ç•™ã€Œå•Ÿç”¨ä¸­ (is_active !== false)ã€çš„å¤§é¡
        // é€™æ¨£å¾Œå°æŒ‰æš«åœçš„ï¼Œé€™è£¡å°±æœƒè‡ªå‹•æ¶ˆå¤±
        cats = (c || []).filter(x => x.is_active !== false);

        // 2. è®€å–ç´°é …
        const { data: i } = await myDB.from('services').select('*').order('sort_order'); 
        items = i || [];
        
        // 3. è®€å– OTA è¨­å®š
        const { data: o } = await myDB.from('ota_settings').select('*'); 
        otas = o || [];
        
        // 4. æ¸²æŸ“ OTA é¸å–®
        const otaSelect = document.getElementById('ota-source-select');
        if(otaSelect) otaSelect.innerHTML = otas.map(p => `<option value="${p.code}">${p.name}</option>`).join('');

        // 5. æ¸²æŸ“å¤§é¡åˆ—è¡¨ (Category List)
        document.getElementById('category-list').innerHTML = cats.map(c => `
            <div class="cat-card" onclick="selectCat('${c.id}')">
                <h3>${c.name}</h3>
                <span style="font-size:1.5rem; color:var(--accent);">â”</span>
            </div>`).join('');
    }

    function selectCat(id) {
        activeCat = cats.find(x => x.id === id);
        document.getElementById('active-cat-name').innerText = activeCat.name;
        document.getElementById('terms-box').innerText = activeCat.terms || "è«‹éµå®ˆè¦ç¯„ã€‚";
        document.getElementById('agree-check').checked = false; toggleSubmitBtn(false);
        document.getElementById('coupon-code').value = ""; document.getElementById('coupon-msg').innerText = ""; currentCoupon = null;

        // 1. æ¸²æŸ“ç´°é …èˆ‡äº’æ–¥å‹¾é¸é‚è¼¯ (ç¶­æŒ V162)
        const sub = items.filter(x => x.category_id === id);
        let hasCheckedMain = false;

        document.getElementById('items-area').innerHTML = sub.map(i => {
            let checkAttr = "";
            if (i.is_main && !hasCheckedMain) {
                checkAttr = "checked";
                hasCheckedMain = true;
            }
            let subHtml = i.sub_options ? `<div class="sub-check-grid">${i.sub_options.split(/[,ï¼Œ]/).map(o=>`<label class="sub-opt-label"><input type="checkbox" class="sub-opt-item" data-parent-id="${i.id}" value="${o.trim()}"> ${o.trim()}</label>`).join('')}</div>` : '';
            return `<div class="service-card" id="card-${i.id}"><div class="service-header"><label class="service-info"><input type="checkbox" name="svc" value="${i.id}" data-price="${i.price}" data-title="${i.title}" data-is-main="${i.is_main}" ${checkAttr} onchange="handleServiceCheck(this)"> <span>${i.title}</span></label><span class="price-badge">$${i.price}</span></div>${subHtml}</div>`;
        }).join('');
        
        document.getElementById('conditional-question').innerHTML = activeCat.question_type === 'sleep' ? `<label>ğŸŒ™ ç¡çœ æ™‚é–“</label><input type="text" id="q-val" placeholder="ä¾‹å¦‚ï¼š23:30 ~ 07:00">` : `<label>ğŸ“… å¸Œæœ›è«®è©¢æ™‚é–“</label><input type="text" id="q-val" placeholder="ä¾‹å¦‚ï¼šå¹³æ—¥æ™šä¸Š">`;

        // 2. ğŸ”¥ V171 æ ¸å¿ƒï¼šå‹•æ…‹æ±ºå®šè³‡æ–™æä¾›æ–¹å¼ ğŸ”¥
        const reqStr = activeCat.data_requirement || 'birth'; // é è¨­ birth
        const flowSelect = document.getElementById('data-flow');
        const flowWrapper = document.getElementById('data-flow-wrapper');
        
        // æ¸…ç©ºä¸¦é‡å»ºé¸é …
        flowSelect.innerHTML = '';
        
        if (reqStr.includes('birth')) {
            const opt = document.createElement('option');
            opt.value = 'data';
            opt.text = 'ğŸ“… æä¾›å‡ºç”Ÿæ—¥æœŸæ™‚é–“';
            flowSelect.add(opt);
        }
        if (reqStr.includes('image')) {
            const opt = document.createElement('option');
            opt.value = 'upload';
            opt.text = 'ğŸ“¸ ç›´æ¥ä¸Šå‚³äººé¡åœ–æˆªåœ–';
            flowSelect.add(opt);
        }

        // åˆ¤æ–·æ˜¯å¦é¡¯ç¤ºä¸‹æ‹‰é¸å–®
        // å¦‚æœåŒæ™‚æœ‰ birth å’Œ image (é•·åº¦>1)ï¼Œå°±é¡¯ç¤ºé¸å–®è®“å®¢äººé¸
        // å¦‚æœåªæœ‰ä¸€ç¨®ï¼Œå°±éš±è—é¸å–® (ä½†å€¼é‚„åœ¨ï¼Œæ‰€ä»¥é‚è¼¯æœƒé€š)
        if (reqStr.includes('birth') && reqStr.includes('image')) {
            flowWrapper.style.display = 'block';
        } else {
            flowWrapper.style.display = 'none';
        }

        // å¼·åˆ¶è§¸ç™¼ä¸€æ¬¡åˆ‡æ›ï¼Œè®“ä¸‹æ–¹çš„è¡¨å–® (å‡ºç”Ÿæ¡† vs ä¸Šå‚³æ¡†) é¡¯ç¤ºæ­£ç¢º
        toggleFlow();

        calcTotal(); 
        showSection('booking-step-2');
    }

    function handleServiceCheck(el) {
        // ğŸ”¥ V162 ä¿®æ­£ï¼šä¸»é …ç›®å–®é¸äº’æ–¥é‚è¼¯
        // å¦‚æœç¾åœ¨å‹¾é¸çš„æ˜¯ã€Œä¸»é …ç›®ã€ï¼Œå°±å»æŠŠå…¶ä»–ä¹Ÿæ˜¯ã€Œä¸»é …ç›®ã€çš„å‹¾å‹¾å–æ¶ˆæ‰
        if (el.dataset.isMain === 'true' && el.checked) {
            document.querySelectorAll('input[name="svc"][data-is-main="true"]').forEach(i => {
                if (i !== el) { 
                    i.checked = false; // è‡ªå‹•å–æ¶ˆåˆ¥äººï¼Œä¸ç”¨å†æ‰‹å‹•å–æ¶ˆäº†
                    // ç§»é™¤ä¹‹å‰çš„ disabled æ¨£å¼ (é˜²å‘†ï¼Œç¢ºä¿ä¹¾æ·¨)
                    if(document.getElementById(`card-${i.value}`)) {
                        document.getElementById(`card-${i.value}`).classList.remove('disabled-card');
                    }
                    i.disabled = false; 
                }
            });
        }
        calcTotal();
    }

    function calcTotal() {
        let t = 0;
        document.querySelectorAll('input[name="svc"]:checked').forEach(el => t += parseInt(el.dataset.price || 0));
        const originalPrice = t;
        let finalPrice = t;
        if (currentCoupon) {
            if (currentCoupon.discount_type === 'percentage') finalPrice = Math.round(originalPrice * (currentCoupon.discount_value / 100));
            else finalPrice = originalPrice - currentCoupon.discount_value;
            if (finalPrice < 0) finalPrice = 0;
            document.getElementById('original-price').innerText = originalPrice;
            document.getElementById('original-price-row').style.display = 'block';
            document.getElementById('total-price').style.color = '#27ae60';
        } else {
            document.getElementById('original-price-row').style.display = 'none';
            document.getElementById('total-price').style.color = '#d35400';
        }
        document.getElementById('total-price').innerText = finalPrice;
        return finalPrice;
    }

    function compressImage(file) {
        return new Promise((resolve, reject) => {
            const maxWidth = 1600; const quality = 0.7; const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image(); img.src = event.target.result;
                img.onload = () => {
                    let width = img.width; let height = img.height;
                    if (width > maxWidth) { height = Math.round(height * (maxWidth / width)); width = maxWidth; }
                    const canvas = document.createElement('canvas'); canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
                    canvas.toBlob((blob) => { if (!blob) return reject(new Error("å£“ç¸®å¤±æ•—")); resolve(blob); }, 'image/jpeg', quality);
                }; img.onerror = (err) => reject(err);
            }; reader.onerror = (err) => reject(err);
        });
    }

async function doSubmit() {
        if (isMemberBlocked) return alert("âš ï¸ ç³»çµ±åµæ¸¬æ‚¨å·²æ˜¯æœƒå“¡ï¼Œè«‹å…ˆå‰å¾€ã€Œå€‹æ¡ˆå°ˆå€ã€ç™»å…¥ï¼");
        
        const name = document.getElementById('c-name').value.trim();
        const phone = document.getElementById('c-phone').value.trim();
        const email = document.getElementById('c-email').value.trim();
        
        if (!name || !phone || !email) return alert("è«‹å¡«å¯«å®Œæ•´åŸºæœ¬è³‡æ–™");
        if (!/^09\d{8}$/.test(phone)) return alert("æ‰‹æ©Ÿæ ¼å¼éŒ¯èª¤ (éœ€10ç¢¼)");
        
        const finalPrice = calcTotal();
        if (finalPrice === 0 && document.querySelectorAll('input[name="svc"]:checked').length === 0) return alert("è«‹è‡³å°‘é¸æ“‡ä¸€é …æœå‹™");

        const payStatus = document.getElementById('pay-status').value;
        const otaSource = document.getElementById('ota-source-select').value;
        const otaOrderId = document.getElementById('ota-order-id').value.trim();
        if (payStatus === 'ota' && !otaOrderId) return alert("âŒ è«‹å¡«å¯«è¨‚å–®ç·¨è™Ÿ");

        const qVal = document.getElementById('q-val').value.trim();
        if (!qVal) return alert("âŒ è«‹å›ç­”æ™‚é–“ç›¸é—œå•é¡Œ");

        const flow = document.getElementById('data-flow').value;
        let finalDataInfo = "";
        
        const btn = document.getElementById('sub-btn'); 
        btn.disabled = true; 
        btn.innerText = "è³‡æ–™è™•ç†ä¸­...";

        try {
            // 1. åœ–ç‰‡/è³‡æ–™è™•ç† (ç¶­æŒåŸæ¨£)
            if (flow === 'upload') {
                const fileInput = document.getElementById('c-file');
                if (!fileInput.files || fileInput.files.length === 0) throw new Error("âŒ è«‹ä¸Šå‚³äººé¡åœ–æˆªåœ–ï¼");
                let fileToUpload = fileInput.files[0];
                if (fileToUpload.size > 1024 * 1024) fileToUpload = await compressImage(fileToUpload);
                const fName = `HD_${phone}_${Date.now()}.jpg`;
                const { error: uploadErr } = await myDB.storage.from('case-charts').upload(fName, fileToUpload, { contentType: 'image/jpeg' });
                if (uploadErr) throw uploadErr;
                const { data } = myDB.storage.from('case-charts').getPublicUrl(fName);
                finalDataInfo = `æˆªåœ–: ${data.publicUrl}`;
            } else {
                const bDate = document.getElementById('b-date').value;
                const bTime = document.getElementById('b-time').value;
                const bPlace = document.getElementById('b-place').value.trim();
                if (!bDate || !bTime || !bPlace) throw new Error("âŒ è«‹å®Œæ•´å¡«å¯«å‡ºç”Ÿè³‡æ–™");
                finalDataInfo = `å‡ºç”Ÿ: ${bDate} ${bTime} ${bPlace}`;
            }

            // 2. ğŸ”¥ æ ¸å¿ƒä¿®æ­£ï¼šä¸»é …ç›®èˆ‡åŠ è³¼é …ç›®å¾¹åº•åˆ†æµ ğŸ”¥
            const checkedInputs = document.querySelectorAll('input[name="svc"]:checked');
            let details = []; // é€™å€‹é™£åˆ—ç¾åœ¨ã€Œåªå­˜åŠ è³¼ã€
            let specificMainService = ""; // é€™å€‹è®Šæ•¸å­˜ã€Œä¸»é …ç›®ã€

            checkedInputs.forEach(el => {
                let txt = `${el.dataset.title} ($${el.dataset.price})`;
                let subs = Array.from(document.querySelectorAll(`.sub-opt-item[data-parent-id="${el.value}"]:checked`)).map(s=>s.value);
                if(subs.length) txt += ` [${subs.join('ã€')}]`;

                if (el.dataset.isMain === 'true') {
                    // âœ… å¦‚æœæ˜¯ä¸»é …ç›®ï¼šå­˜å…¥ main_serviceï¼Œä¸è¦æ”¾é€² details
                    specificMainService = txt; 
                } else {
                    // âœ… å¦‚æœæ˜¯åŠ è³¼ï¼šå­˜å…¥ details
                    details.push(txt);
                }
            });

            // 3. å„ªæƒ åˆ¸ (ç¶­æŒåŸæ¨£)
            let couponInfoText = null;
            if (currentCoupon) {
                let desc = currentCoupon.discount_type === 'percentage' ? `${currentCoupon.discount_value}æŠ˜` : `æŠ˜$${currentCoupon.discount_value}`;
                couponInfoText = `${currentCoupon.name} (${desc}) [Code:${currentCoupon.code}]`;
                await myDB.from('coupons').update({ usage_count: currentCoupon.usage_count + 1 }).eq('id', currentCoupon.id);
            }

            // 4. å¯«å…¥è³‡æ–™åº«
            const myBookingId = "OD" + Date.now(); 

            const { error } = await myDB.from('bookings').insert([{
                booking_id: myBookingId,
                temp_phone: phone, 
                status: 'pending', 
                price: finalPrice,
                // A. å¤§é¡åç¨± (å¦‚: å€‹äººèƒ½é‡èª¿é »)
                service_item: activeCat.name, 
                // B. ä¸»é …ç›® (å¦‚: éˆæ“ºèª¿æ•´ $800) -> ç¨ç«‹æ¬„ä½
                main_service: specificMainService, 
                // C. åŠ è³¼ç´°é … (å¦‚: è±ç››ä¹‹æµ $400) -> ç¨ç«‹æ¬„ä½ï¼Œåªå­˜åŠ è³¼
                service_detail: details.join(' | '), 
                ota_source: payStatus === 'ota' ? otaSource : null,
                ota_order_id: payStatus === 'ota' ? otaOrderId : null,
                payment_method: payStatus, 
                sleep_time: qVal,
                wish_detail: `å§“å:${name} | Email:${email} | æ•¸æ“š:${finalDataInfo}`,
                coupon_info: couponInfoText, 
                user_id: currentUser ? currentUser.id : null
            }]);

            if(!error) { 
                // 1. LINE Notify ç™¼é€çµ¦è€å¸« (ç¶­æŒåŸæ¨£)
                //try { await myDB.functions.invoke('line-notify', { body: { name: name,  phone: phone, service: activeCat.name, note: `é‡‘é¡:$${finalPrice} ${couponInfoText ? '(å«å„ªæƒ )' : ''}`  } });console.log("âœ… LINE é€šçŸ¥å·²æˆåŠŸç™¼é€");} catch (notifyErr) {console.error("âŒ é€šçŸ¥ç™¼é€å¤±æ•—:", notifyErr); }

                // 2. æº–å‚™å½ˆçª—è³‡è¨Š
                const shortId = myBookingId.slice(-6);
                const myLineId = "@927ctmwa"; 
                const message = encodeURIComponent(`æˆ‘å·²å®Œæˆæœå‹™é ç´„ï¼Œè¨‚å–®ç·¨è™Ÿæ˜¯ï¼š${shortId}`);
                const lineUrl = `https://line.me/R/oaMessage/${myLineId}/?${message}`;
                
                document.getElementById('success-order-id').innerText = myBookingId;
                
                const lineBtn = document.getElementById('line-super-btn');
                // 1. é€™è£¡ç¶­æŒä½ åŸæœ¬çš„ lineUrlï¼Œä¸è¦æ”¹ javascript:void(0)
                lineBtn.href = lineUrl; 

                // 2. æ”¹å¯« onclickï¼ŒåŠ å…¥æ””æˆªé‚è¼¯
                lineBtn.onclick = function(e) {
                    e.preventDefault(); 
                    
                    const textToCopy = `é ç´„ç·¨è™Ÿï¼š${myBookingId} (Line ID: ${myLineId})`;
                    
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        const originalHtml = lineBtn.innerHTML;
                        lineBtn.innerHTML = `<i class="fa-solid fa-check"></i> <b>ç·¨è™Ÿå·²è¤‡è£½ï¼æ­£åœ¨é–‹å•Ÿ...</b>`;
                        lineBtn.style.background = "#05b34c";
                        
                        setTimeout(() => {
                            // ğŸ”¥ V181 ä¿®æ­£ï¼šåˆ¤æ–·è¢å¹•å¯¬åº¦æ±ºå®šæ˜¯å¦é–‹æ–°è¦–çª—
                            if (window.innerWidth > 768) {
                                // é›»è…¦ç‰ˆï¼šé–‹æ–°åˆ†é ï¼Œä¿ç•™åŸæœ¬ç¶²é 
                                window.open(lineUrl, '_blank');
                            } else {
                                // æ‰‹æ©Ÿç‰ˆï¼šåŸè¦–çª—è·³è½‰ï¼Œå–šèµ· App æ¯”è¼ƒé †
                                window.location.href = lineUrl;
                            }
                        }, 600);
                        
                        setTimeout(() => {
                            lineBtn.innerHTML = originalHtml;
                            lineBtn.style.background = "#06c755";
                        }, 5000);
                    }).catch(() => {
                        // å¤±æ•—ä¿éšª
                        if (window.innerWidth > 768) window.open(lineUrl, '_blank');
                        else window.location.href = lineUrl;
                    });
                };

                document.getElementById('sub-btn').disabled = false;
                document.getElementById('sub-btn').innerText = "é€å‡ºé ç´„";
                openModal('success-overlay');
            } else { 
                throw error; 
            }

        } catch (err) { 
            console.error(err);
            alert(err.message || "ç™¼ç”ŸéŒ¯èª¤"); 
            btn.disabled = false; 
            btn.innerText = "é€å‡ºé ç´„"; 
        }
    }
    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function toggleOTA() { const isOTA = document.getElementById('pay-status').value === 'ota'; document.getElementById('ota-area').style.display = isOTA ? 'block' : 'none'; }
    function toggleFlow() { const isD=document.getElementById('data-flow').value==='data'; document.getElementById('flow-data').style.display=isD?'block':'none'; document.getElementById('flow-upload').style.display=isD?'none':'block'; }
    function toggleSubmitBtn(c) { if(isMemberBlocked) return; document.getElementById('sub-btn').disabled = !c; document.getElementById('sub-btn').innerText = c ? "é€å‡ºé ç´„" : "è«‹åŒæ„è¦ç¯„"; }

    // ğŸ”¥ ä¿®æ”¹ï¼šè®€å–æ–‡ç«  + è®€å–å¾Œå°è¨­å®š (æ’åº & éš±è—æ¸…å–®)
    async function initKbData() {
        // 1. æŠ“æ–‡ç« 
        const { data } = await myDB.from('kb_articles').select('id,title,big_category,mid_category').eq('is_published', true).order('sort_order', { ascending: true });
        
        // 2. æŠ“è¨­å®š (é€™è£¡æ˜¯æ–°å¢çš„é‡é»ï¼)
        const { data: cfg } = await myDB.from('site_content').select('content').eq('title', 'kb_category_order').single();
        if (cfg && cfg.content) {
            kbCatOrder = cfg.content; // æŠŠå¾Œå°è¨­å®š (å« hide_note) å­˜å…¥å‰å°è®Šæ•¸
        }

        if (data) {
            kbTree = {};
            data.forEach(i => {
                if (!kbTree[i.big_category]) kbTree[i.big_category] = {};
                if (!kbTree[i.big_category][i.mid_category]) kbTree[i.big_category][i.mid_category] = [];
                kbTree[i.big_category][i.mid_category].push(i);
            });
            renderKbHome();
        }
    }


    // ğŸ”¥ V106 åŸ¹ç™’å¯¶å…¸é¦–é ï¼šåŠ å…¥ç²¾ç·»å“ç‰Œæ¨™é¡Œå€
    function renderKbHome() {
        kbState.level = 0;
        kbState.big = null;
        kbState.activeMid = null;

        const bigCats = Object.keys(kbTree);
        const listHtml = bigCats.map(cat => {
            return `
            <div class="kb-article-card" onclick="enterKb('${cat}')" style="padding: 35px 30px;">
                <div class="kb-card-content">
                    <div class="kb-card-text" style="font-size: 1.4rem;">${cat}</div>
                </div>
                <div class="kb-arrow">â”</div>
            </div>`;
        }).join('');

        // ğŸ”¥ V107ï¼šç›´æ¥ä½¿ç”¨ kb-cat-viewï¼Œä¸å†å¥—ç”¨å…§å±¤ .card
        document.getElementById('kb-container').innerHTML = `
            <div class="kb-cat-view">
                <div class="brand-section-header">
                     <div class="brand-h3-zh">åŸ¹ç™’å¯¶å…¸</div>                   
                    <div class="brand-h2-en">PY JOURNEY</div>
                    <div class="brand-capsule">
                        æ¢ç´¢è‡ªæˆ‘çš„å°å¼•æ‰‹å†Š
                    </div>
                </div>
                
                <div class="kb-list-container">
                    ${listHtml}
                </div>
            </div>
        `;
        
        document.getElementById('knowledge').classList.add('kb-reading-mode');
        window.scrollTo(0,0);
    }

    // ğŸ”¥ ä¿®æ”¹ï¼šæ ¹æ“šå¾Œå°è¨­å®šæ±ºå®šæ˜¯å¦é¡¯ç¤ºä¾¿åˆ©è²¼
    function enterKb(big) {
        kbState.level = 1;
        kbState.big = big;
        
        document.getElementById('knowledge').classList.add('kb-reading-mode');
        
        // 1. åˆ¤æ–·æ˜¯å¦éš±è—ä¾¿åˆ©è²¼
        // æª¢æŸ¥ hide_note é™£åˆ—æ˜¯å¦å­˜åœ¨ï¼Œä¸”æ˜¯å¦åŒ…å«ç›®å‰çš„å¤§åˆ†é¡åç¨±
        const isHidden = kbCatOrder.hide_note && kbCatOrder.hide_note.includes(big);
        
        // å¦‚æœéš±è—å°±çµ¦ç©ºå­—ä¸²ï¼Œå¦å‰‡é¡¯ç¤ºä¾¿åˆ©è²¼ HTML
        const noteHtml = isHidden ? '' : `
            <div class="kb-tiny-note">
                å¦‚æœå…§å®¹æœ‰èª¤ æ­¡è¿å”åŠ©ä¿®æ­£<br>
                æˆ–æ˜¯æä¾›æˆ‘å…è²»èª²ç¨‹ ğŸ¤­<br>
                å¦‚æœçœ‹äº†è¦ºå¾—ä¸å°ˆæ¥­æˆ–ä¸é–‹å¿ƒ<br>
                è«‹ç›´æ¥é—œé–‰ è¬è¬æ°æ° ğŸ‘‹
            </div>`;

        // 2. æ’åºé‚è¼¯ (æ²¿ç”¨æ‚¨çš„è¨­å®š)
        let sortedMids = [];
        if (kbCatOrder && kbCatOrder.mid && kbCatOrder.mid[big]) {
            sortedMids = kbCatOrder.mid[big].filter(m => kbTree[big] && kbTree[big][m]);
            if(kbTree[big]) {
                Object.keys(kbTree[big]).forEach(k => { if (!sortedMids.includes(k)) sortedMids.push(k); });
            }
        } else if (kbTree[big]) {
            sortedMids = Object.keys(kbTree[big]);
        }

        const contentHtml = sortedMids.map(mid => {
            const arts = kbTree[big][mid]; 
            const articlesHtml = arts.map(a => {
                let displayHtml = `<div class="kb-card-text">${a.title}</div>`;
                const match = a.title.match(/^([0-9\-\.]+)\s+(.*)/);
                if (match) displayHtml = `<div class="kb-card-num">${match[1]}</div><div class="kb-card-text">${match[2]}</div>`;
                
                return `
                <div class="kb-article-card" onclick="event.stopPropagation(); readArt('${a.id}')">
                    <div class="kb-card-content">${displayHtml}</div>
                    <div class="kb-arrow">â”</div>
                </div>`;
            }).join('');

            return `
            <details class="kb-section-group" open>
                <summary class="kb-mid-separator"><span class="kb-mid-badge">${mid}</span></summary>
                <div class="kb-list-container">${articlesHtml}</div>
            </details>`;
        }).join('');
        
        // 3. çµ„åˆç•«é¢ (æŠŠ noteHtml æ”¾é€²å»)
        document.getElementById('kb-container').innerHTML = `
            <div class="kb-cat-view">
                <div class="kb-fab-back" onclick="kbGoBack()"><i class="fa-solid fa-reply"></i></div>

                <div onclick="kbGoBack()" class="kb-internal-back">
                    <i class="fa-solid fa-arrow-left"></i> è¿”å›é¦–é 
                </div>

                ${noteHtml}

                <div class="kb-cat-header">
                    <h1 class="kb-cat-title-h1">${big}</h1>
                </div>
                ${contentHtml}
            </div>
        `;
        window.scrollTo(0, 0);
    }
    // ğŸ”¥ V92 æ–‡ç« å…§é ï¼šèª¿æ•´æ’ç‰ˆé †åº (æŒ‰éˆ• -> ä¾¿åˆ©è²¼)
    async function readArt(id) {
        const { data, error } = await myDB.from('kb_articles').select('*').eq('id', id).single();
        if (error || !data) { console.error(error); alert("è®€å–å¤±æ•—"); return; }

        kbState.activeMid = data.mid_category;
        document.getElementById('knowledge').classList.add('kb-reading-mode');
        
        // 1. åˆ¤æ–·æ˜¯å¦éš±è— (æª¢æŸ¥é€™ç¯‡æ–‡ç« çš„å¤§åˆ†é¡)
        const isHidden = kbCatOrder.hide_note && kbCatOrder.hide_note.includes(data.big_category);
        
        const noteHtml = isHidden ? '' : `
            <div class="kb-tiny-note">
                å¦‚æœå…§å®¹æœ‰èª¤ æ­¡è¿å”åŠ©ä¿®æ­£<br>
                æˆ–æ˜¯æä¾›æˆ‘å…è²»èª²ç¨‹ ğŸ¤­<br>
                å¦‚æœçœ‹äº†è¦ºå¾—ä¸å°ˆæ¥­æˆ–ä¸é–‹å¿ƒ<br>
                è«‹ç›´æ¥é—œé–‰ è¬è¬æ°æ° ğŸ‘‹
            </div>`;
        
        document.getElementById('kb-container').innerHTML = `
            <div class="kb-article-view">
                <div class="kb-fab-back" onclick="kbGoBack()"><i class="fa-solid fa-reply"></i></div>

                <div onclick="kbGoBack()" class="kb-internal-back">
                    <i class="fa-solid fa-arrow-left"></i> è¿”å›ç›®éŒ„
                </div>

                ${noteHtml}

                <h1 class="kb-article-title-h1">${data.title}</h1>
                
                <div class="kb-meta-row">
                    <span class="kb-tag kb-tag-big">${data.big_category}</span>
                    <span class="kb-divider">â—</span>
                    <span class="kb-tag kb-tag-mid">${data.mid_category}</span>
                </div>
                
                <div class="ql-editor">
                    ${data.body}
                </div>
            </div>`;
            
        kbState.level = 2;
        window.scrollTo(0, 0);
    }
    
    // ğŸ”¥ è¿”å›åŠŸèƒ½ (V78ï¼šé€€å‡ºé–±è®€æ¨¡å¼)
    function kbGoBack() {
        // 1. é€€å‡ºã€Œé–±è®€æ¨¡å¼ã€ï¼šæŠŠå¤–éƒ¨ Header å«å›ä¾†
        document.getElementById('knowledge').classList.remove('kb-reading-mode');

        if (kbState.level === 2) {
            // å¦‚æœåŸæœ¬æ˜¯åœ¨çœ‹æ–‡ç« ï¼Œè¿”å›åˆ°ã€Œè©²å¤§åˆ†é¡çš„åˆ—è¡¨ã€
            enterKb(kbState.big);
        } else {
            // å¦å‰‡å›é¦–é 
            renderKbHome();
        }
    }
    async function initDrawData() { const { data } = await myDB.from('card_pool').select('*'); allCards = data || []; renderDrawTable(); }
    
   // æŠ½å¡æ ¸å¿ƒé‚è¼¯ (å« 0.8ç§’ å®‰å…¨é–)
    function renderDrawTable() { 
        const table = document.getElementById('draw-area'); 
        if (!table) return; 
        table.innerHTML = ''; 
        
        const deck = allCards.length > 0 ? [...allCards] : Array.from({length: 64}, (_, i) => ({ gate_id: i + 1 })); 
        const shuffled = deck.sort(() => Math.random() - 0.5); 
        
        // åˆ¤å®šï¼šåªæœ‰æ”¯æ´ hover çš„æ‰ç®—é›»è…¦ (é€™æ¨£æœ€æº–)
        const isDesktop = window.matchMedia('(hover: hover)').matches;

        // å®‰å…¨é–
        let isInputLocked = true;
        setTimeout(() => { isInputLocked = false; }, 800);

        shuffled.forEach((card, index) => { 
            const el = document.createElement('div'); 
            el.className = 'card-back'; 
            el.style.animation = `cardShuffleIn 0.5s ease-out ${index * 0.015}s forwards`; 
            
            el.onclick = function() { 
                if (isInputLocked) return;

                // === æƒ…æ³ A: é›»è…¦ç‰ˆ (ç›´æ¥æŠ½) OR æ‰‹æ©Ÿç‰ˆç¢ºèªæŠ½å– ===
                if (isDesktop || el.classList.contains('is-selected')) {
                    el.classList.remove('is-selected');
                    el.classList.add('is-drawing'); 
                    isInputLocked = true; 
                    setTimeout(() => { drawCard(card); }, 600); 
                } 
                // === æƒ…æ³ B: æ‰‹æ©Ÿç‰ˆé¸å– ===
                else {
                    // ğŸ©¸ æ­¢è¡€é‰—ï¼šå…ˆæŠŠæ‰€æœ‰å…¶ä»–çš„ is-selected å…¨éƒ¨ç§»é™¤ï¼
                    // é€™è¡Œæœƒå¼·åˆ¶æŠŠä¸Šä¸€å¼µã€Œå¹½éˆæ‡¸åœã€çš„ç‰Œå£“ä¸‹å»
                    const allActive = document.querySelectorAll('.card-back.is-selected');
                    allActive.forEach(c => c.classList.remove('is-selected'));

                    // åªè®“ç¾åœ¨é€™å¼µæµ®èµ·ä¾†
                    el.classList.add('is-selected');
                }
            }; 
            
            table.appendChild(el); 
        }); 
    }
    // ğŸ”¥ V175 ä¿®æ­£ï¼šæˆåŠŸå½ˆçª—é—œé–‰ä¸¦è·³å›é¦–é 
    function closeSuccessModal() {
        // 1. é—œé–‰å½ˆçª—
        closeModal('success-overlay');
        // 2. å¼·åˆ¶åˆ‡æ›å›é¦–é å€å¡Š
        showSection('home');
        // 3. ç•«é¢æ²å›æœ€ä¸Šæ–¹ (é¿å…åœ¨é¦–é åº•éƒ¨)
        window.scrollTo(0, 0);
    }

    // é †ä¾¿æª¢æŸ¥åŸæœ¬çš„ closeSuccessModal æ˜¯å¦æœ‰é»éŒ¯ï¼Œ
    // ç¢ºä¿ HTML è£¡çš„æŒ‰éˆ• onclick="closeSuccessModal()" èƒ½å°æ‡‰åˆ°ä¸Šé¢é€™å€‹ã€‚
    async function drawCard(card) { document.getElementById('p-gate').innerText = `GATE ${card.gate_id}`; document.getElementById('p-info').innerText = `${card.gate_name || ''} / ${card.gate_keyword || ''}`; document.getElementById('p-zodiac').innerText = card.zodiac || ''; document.getElementById('p-quote').innerText = card.quote || ''; if (card.image_url) { document.getElementById('p-bg').src = card.image_url + `?t=${new Date().getTime()}`; } const style = card.style_config || defaultStyle; applyStyle('gate', style.gate || defaultStyle.gate); applyStyle('info', style.info || defaultStyle.info); applyStyle('zodiac', style.zodiac || defaultStyle.zodiac); applyStyle('quote', style.quote || defaultStyle.quote); document.getElementById('overlay').classList.add('active'); }
    function applyStyle(id, s) { const el = document.getElementById(`p-${id}`); const def = defaultStyle[id]; const val = (prop) => (s && s[prop] !== undefined) ? s[prop] : def[prop]; el.style.left = val('x') + '%'; el.style.top = val('y') + '%'; el.style.fontSize = val('size') + 'px'; el.style.fontFamily = val('font'); el.style.color = val('color'); const str = val('stroke'); el.style.textShadow = (str && str !== 'transparent') ? `1px 1px 0 ${str}, -1px -1px 0 ${str}, 1px -1px 0 ${str}, -1px 1px 0 ${str}` : 'none'; if(id === 'quote' || id === 'info') el.style.width = val('w') + 'px'; if(id === 'quote') { el.style.lineHeight = val('lh'); el.style.letterSpacing = val('ls') + 'px'; } if(id === 'zodiac') el.style.display = document.getElementById('p-zodiac').innerText ? 'block' : 'none'; }
    function closeResult() { document.getElementById('overlay').classList.remove('active'); setTimeout(() => { renderDrawTable(); document.getElementById('p-bg').src = ""; }, 500); }
    // ğŸ”¥ V113 åœ–ç‰‡æ¥µé€Ÿè¼‰å…¥é‚è¼¯ (è«‹ç¢ºä¿è³‡æ–™å¤¾å…§æœ‰ logo.png å’Œ logohuman.png)
    async function loadSiteAssets() { 
        // 1. é€™è£¡ä¸åšä»»ä½•äº‹ï¼Œå› ç‚º HTML å·²ç¶“å¯«æ­» src="logo.png" äº†
        // ç€è¦½å™¨ä¸€æ‰“é–‹å°±æœƒç›´æ¥é¡¯ç¤ºæœ¬åœ°åœ–ç‰‡ï¼Œä¸ç”¨ç­‰ JSï¼Œé€™æ‰æ˜¯çœŸæ­£çš„ 0 ç§’è¼‰å…¥

        // 2. èƒŒæ™¯é»˜é»˜é€£ç·šè³‡æ–™åº«ï¼Œæª¢æŸ¥æœ‰æ²’æœ‰ã€Œæ–°ç‰ˆæœ¬ã€çš„åœ–è¦æ›
        const { data } = await myDB.from('site_content').select('*').eq('category', 'site_asset'); 
        
        if (data) { 
            data.forEach(item => { 
                // é€™è£¡æˆ‘å€‘ã€Œå·å·ã€ä¸‹è¼‰æ–°åœ–ç‰‡ï¼Œä½¿ç”¨è€…é€™æ™‚å€™é‚„åœ¨çœ‹èˆŠåœ–ï¼Œå®Œå…¨ç„¡æ„Ÿ
                const img = new Image();
                img.src = item.image_url;
                
                // ç­‰æ–°åœ–ç‰‡ä¸‹è¼‰å¥½ä¹‹å¾Œï¼Œæ‰ç„¡ç¸«æ›¿æ›æ‰èˆŠçš„
                img.onload = () => {
                    if (item.title === 'logo') {
                        // åªæœ‰ç•¶åœ–ç‰‡çœŸçš„ä¸ä¸€æ¨£æ™‚æ‰æ›¿æ›ï¼Œé¿å…é–ƒçˆ
                        const el = document.getElementById('site-logo');
                        if(el.src !== item.image_url) el.src = item.image_url;
                    }
                    if (item.title === 'logohuman') {
                        const el = document.getElementById('site-hero');
                        if(el.src !== item.image_url) el.src = item.image_url;
                    }
                    if (item.title === 'my_hd_chart') {
                        const chartEl = document.getElementById('hd-chart-img');
                        if(chartEl) chartEl.src = item.image_url;
                    }
                };
            }); 
        } 
    }
    async function doLogin() { 
        const phone = document.getElementById('l-phone').value.trim(); 
        const pass = document.getElementById('l-pass').value.trim(); 
        if(!phone || !pass) return alert("è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼"); 
        
        try { 
            const { data: user, error: userErr } = await myDB.from('profiles').select('*').eq('phone', phone).eq('password', pass).single(); 
            if (userErr || !user) throw new Error("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤"); 
            
            const { data: bookings } = await myDB.from('bookings').select('*').eq('user_id', user.id); 
            const { data: reports } = await myDB.from('reports').select('*').eq('user_id', user.id); 
            
            user.bookings = bookings || []; 
            user.reports = reports || []; 
            
            currentUser = user; 
            isMemberBlocked = false; 

            // ç™»å…¥æˆåŠŸæ™‚ï¼Œå­˜å…¥ LocalStorage
            localStorage.setItem('peiyu_user', JSON.stringify({ phone: phone, pass: pass }));
            
            document.getElementById('login-box').style.display = 'none'; 
            document.getElementById('dash').style.display = 'block'; 
            
            renderDashboard(currentUser); 
        } catch (err) { 
            console.error(err); 
            alert("ç™»å…¥ç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message); 
        } 
    }

   function renderDashboard(user) {
        document.getElementById('dash-welcome').innerText = `æ‚¨å¥½ï¼Œ${user.full_name}`;
        
        // æ’åºè¨‚å–®ï¼šç”±æ–°åˆ°èˆŠ
        const allBookings = user.bookings.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        let historyHtml = "<div style='color:#666;padding:10px;'>ç›®å‰å°šç„¡é ç´„ç´€éŒ„</div>";

        if (allBookings.length > 0) {
            historyHtml = allBookings.map(b => {
                const dateStr = new Date(b.created_at).toLocaleDateString();
                const title = b.service_item || 'æœå‹™é ç´„';
                
                const stMap = { 
                    'pending': '<span style="color:red">æœªä»˜æ¬¾</span>', 
                    'paid': '<span style="color:green">å·²ä»˜æ¬¾</span>', 
                    'completed': '<span style="color:#333">å·²çµæ¡ˆ</span>' 
                };
                const statusBadge = stMap[b.status] || b.status;
                
                const rawDetail = b.service_detail || "";
                const details = rawDetail.split('|').map(s => s.trim().split('(')[0].trim()).join(' + ');

                let originalPrice = 0;
                const priceMatches = rawDetail.match(/\$(\d+)/g);
                if (priceMatches) priceMatches.forEach(m => originalPrice += parseInt(m.replace('$', '')));
                if (originalPrice < b.price || originalPrice === 0) originalPrice = b.price;

                let priceInfoHtml = b.coupon_info ?
                    `<div style="font-size:12px;color:#999;margin-top:5px;">åŸåƒ¹ <span style="text-decoration:line-through;">$${originalPrice}</span></div><div style="font-size:12px;color:#27ae60;">ğŸŸï¸ ${b.coupon_info}</div><div style="font-weight:bold;color:#d35400;">å¯¦ä»˜ $${b.price}</div>` :
                    `<div style="font-weight:bold;color:#333;margin-top:5px;">$${b.price}</div>`;

                const reportMatch = (b.wish_detail || "").match(/\[å ±å‘Šå·²ç”Ÿæˆ ID:(.*?)\]/);
                const currentReportId = reportMatch ? reportMatch[1] : null;

                let scheduleHtml = "";
                let btnHtml = `<div style="font-size:12px; margin-top:5px;">${statusBadge}</div>`;

                if (currentReportId) {
                    scheduleHtml = `<div style="color:var(--success); font-weight:bold; font-size:13px; margin-top:4px; background:#e8f5e9; padding:3px 6px; border-radius:4px; display:inline-block;">âœ¨ æœå‹™å·²å®Œæˆ</div>`;
                    const matchedCat = cats.find(c => b.service_item === c.name);
                    const specificSvc = items.find(s => s.category_id === matchedCat?.id && b.service_detail.includes(s.title) && s.is_main);
                    const templateFile = (specificSvc && specificSvc.report_template) ? specificSvc.report_template : "srt_report.html";
                    let targetUrl = `${templateFile}?id=${currentReportId}&mode=view`;
                    btnHtml = `<button class="btn-primary" style="font-size:13px;padding:6px 15px;height:fit-content;" onclick="window.open('${targetUrl}')">æŸ¥çœ‹å ±å‘Š</button>`;
                } else if (b.scheduled_at) {
                    const t = new Date(b.scheduled_at);
                    const timeStr = `${t.getFullYear()}/${t.getMonth() + 1}/${t.getDate()} ${t.getHours().toString().padStart(2, '0')}:${t.getMinutes().toString().padStart(2, '0')}`;
                    scheduleHtml = `<div style="color:#6a1b9a; font-weight:bold; font-size:13px; margin-top:4px; background:#f3e5f5; padding:3px 6px; border-radius:4px; display:inline-block;">ğŸ•’ é è¨ˆæœå‹™ï¼š${timeStr}</div>`;
                }

                return `
                <div style="border-bottom:1px solid #eee;padding:15px 10px;display:flex;justify-content:space-between;align-items:flex-start;">
                    <div style="flex:1;padding-right:10px;">
                        <span style="font-weight:bold;font-size:15px;display:block;color:var(--forest);">${title}</span>
                        <small style="color:#666;display:block;margin-top:2px;">${details}</small>
                        ${scheduleHtml}
                        <small style="color:#999; display:block; margin-top:5px;">ä¸‹å–®æ—¥ï¼š${dateStr}</small>
                        ${priceInfoHtml}
                    </div>
                    <div style="text-align:right">${btnHtml}</div>
                </div>`;
            }).join('');
        }

        document.getElementById('dash-history').innerHTML = historyHtml;
        document.getElementById('c-name').value = user.full_name;
        document.getElementById('c-phone').value = user.phone;
        document.getElementById('c-email').value = user.email || "";
        document.getElementById('c-phone').disabled = true;
        document.getElementById('c-name').style.backgroundColor = "#e8f5e9";

        const statusEl = document.getElementById('phone-status');
        if (statusEl) statusEl.innerHTML = "";
        const phoneInput = document.getElementById('c-phone');
        if (phoneInput) {
            phoneInput.style.borderColor = "#ddd";
            phoneInput.style.backgroundColor = "#eee";
        }
    }

    function doLogout() { 
        currentUser = null; 
        localStorage.removeItem('peiyu_user'); 
        document.getElementById('login-box').style.display = 'block'; 
        document.getElementById('dash').style.display = 'none'; 
        document.getElementById('c-name').value = ""; 
        document.getElementById('c-phone').value = ""; 
        document.getElementById('c-email').value = ""; 
        document.getElementById('c-phone').disabled = false; 
        document.getElementById('c-name').style.backgroundColor = ""; 
        alert("å·²ç™»å‡º"); 
    }

    function openEditProfile() { 
        if(!currentUser) return; 
        document.getElementById('ep-phone').value = currentUser.phone; 
        document.getElementById('ep-name').value = currentUser.full_name; 
        document.getElementById('ep-email').value = currentUser.email || ""; 
        document.getElementById('ep-pass').value = ""; 
        openModal('edit-profile-overlay'); 
    }

    async function saveProfile() { 
        if(!currentUser) return; 
        const newName = document.getElementById('ep-name').value; 
        const newEmail = document.getElementById('ep-email').value; 
        const newPass = document.getElementById('ep-pass').value; 
        
        const updateData = { full_name: newName, email: newEmail }; 
        if(newPass) updateData.password = newPass; 
        
        const { error } = await myDB.from('profiles').update(updateData).eq('id', currentUser.id); 
        
        if(error) { 
            alert("æ›´æ–°å¤±æ•—: " + error.message); 
        } else { 
            alert("âœ… è³‡æ–™å·²æ›´æ–°ï¼"); 
            currentUser.full_name = newName; 
            currentUser.email = newEmail; 
            document.getElementById('dash-welcome').innerText = `æ‚¨å¥½ï¼Œ${newName}`; 
            document.getElementById('c-name').value = newName; 
            document.getElementById('c-email').value = newEmail; 
            closeModal('edit-profile-overlay'); 
        } 
    }
    // ğŸ”¥ V210 æ–°å¢ï¼šé¦–é å‹•æ…‹å…¬å‘Šå€ (æ”¹è®€å– announcements è¡¨)
    // ğŸ”¥ V215 æ–°å¢ï¼šè®€å–å…¬å‘Šä¸¦æ§åˆ¶é¡¯ç¤º
    // ğŸ”¥ V290 å‡ç´šï¼šå…¬å‘Šåˆ†æµ (å¿…è®€ vs è‡¨æ™‚)
   // ğŸ”¥ V290 å‡ç´šç‰ˆï¼šå…¬å‘Šåˆ†æµ
    async function loadHeroAnnouncements() {
        const mustContainer = document.getElementById('must-read-container');
        const mustWrapper = document.getElementById('must-read-wrapper');
        const tempContainer = document.getElementById('temp-container');
        const tempWrapper = document.getElementById('temp-wrapper');
        
        try {
            const { data, error } = await myDB.from('announcements')
                .select('title, content, type')
                .eq('is_active', true)
                .order('sort_order', { ascending: true });

            if (error) throw error;

            if (data && data.length > 0) {
                mustContainer.innerHTML = '';
                tempContainer.innerHTML = '';
                let hasMust = false;
                let hasTemp = false;

                data.forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = 'btn-primary';
                    btn.innerHTML = item.title;
                    btn.style.padding = "8px 20px";
                    btn.style.fontSize = "0.95rem";
                    btn.style.minWidth = "auto";
                    btn.style.boxShadow = "0 4px 10px rgba(0,0,0,0.1)";
                    btn.onclick = () => openDynamicAnnouncement(item.title, item.content);

                    // ğŸ”¥ğŸ”¥ğŸ”¥ é—œéµåˆ†æµé‚è¼¯åœ¨é€™è£¡ï¼ ğŸ”¥ğŸ”¥ğŸ”¥
                    if (item.type === 'temp') {
                        // é€™æ˜¯è‡¨æ™‚å…¬å‘Š (æ©˜è‰²)
                        btn.style.border = "1px solid #e67e22";
                        btn.style.color = "#d35400";
                        tempContainer.appendChild(btn);
                        hasTemp = true; // æ¨™è¨˜æœ‰è³‡æ–™
                    } else {
                        // é€™æ˜¯å¿…è®€å…¬å‘Š (ç¶ è‰²)
                        mustContainer.appendChild(btn);
                        hasMust = true; // æ¨™è¨˜æœ‰è³‡æ–™
                    }
                });

                // ğŸ”¥ æœ‰è³‡æ–™æ‰é¡¯ç¤ºæ¡†æ¡†ï¼Œæ²’è³‡æ–™å°±éš±è—
                mustWrapper.style.display = hasMust ? 'block' : 'none';
                tempWrapper.style.display = hasTemp ? 'block' : 'none';

            } else {
                mustWrapper.style.display = 'none';
                tempWrapper.style.display = 'none';
            }
        } catch (e) {
            console.error("å…¬å‘Šè¼‰å…¥å¤±æ•—:", e);
        }
    }
    // ğŸ”¥ è™•ç†é»æ“Šå¾Œçš„å½ˆçª—å…§å®¹å¡«å……
    function openDynamicAnnouncement(title, contentHtml) {
        document.getElementById('dyn-modal-title').innerText = title; 
        document.getElementById('dyn-modal-content').innerHTML = contentHtml || "ç„¡å…§å®¹";
        openModal('dynamic-overlay');
    }

    // ğŸ”¥ è¨˜å¾—ä¿®æ”¹ window.onload
    window.onload = async () => {
        await initBookingData(); 
        initDrawData(); 
        initKbData(); 
        loadSiteAssets();
        checkSession(); 
        
        // ğŸ‘‡ æ›æˆå‘¼å«æ–°å‡½å¼
        loadHeroAnnouncements();

        const params = new URLSearchParams(window.location.search);
        const targetView = params.get('view');
        if (targetView && document.getElementById(targetView)) {
            showSection(targetView);
        } else {
            showSection('home');
        }
    };
</script>
</body>
</html>
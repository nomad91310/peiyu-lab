<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸ¹ç™’è©¦é©—å®¤</title>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Ma+Shan+Zheng&family=Noto+Serif+TC:wght@500;700;900&family=Shippori+Mincho:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    
    <link rel="preload" as="image" href="logo.png">
    <link rel="preload" as="image" href="logohuman.png">
    <link rel="preload" as="image" href="logoloading.png">


<style>
    /* ======================================================
       1. å…¨ç«™åŸºç¤è¨­å®š (Variables & Reset)
       ====================================================== */
    :root { 
        --forest: #1a2f23; --forest-light: #2a4032;
        --cream: #f9f7f2; --white: #ffffff;
        --accent: #c6a87c; --accent-hover: #b09060;
        --text-main: #2c3e50; --text-light: #666;
        --shopee: #ff5722; --error: #d32f2f; --success: #2e7d32;
        --shadow-soft: 0 10px 30px rgba(26, 47, 35, 0.08);
        --shadow-hover: 0 15px 40px rgba(26, 47, 35, 0.15);
    }
    
    * { box-sizing: border-box; }
    
    body { 
        font-family: -apple-system, "Microsoft JhengHei", "Helvetica Neue", sans-serif; 
        background-color: var(--cream); margin: 0; 
        color: var(--text-main); line-height: 1.7; letter-spacing: 0.02em;
    }
    
    h1, h2, h3, h4, .serif-font { font-family: 'Noto Serif TC', serif; }
    #home { padding-bottom: 220px; }

    /* å‹•ç•«å®¹å™¨ & Section */
    .section { 
        display: none; padding: 40px 20px 100px 20px; 
        max-width: 1100px; margin: 0 auto; min-height: calc(100vh - 80px); 
        animation: fadeSlideUp 0.6s ease-out; 
    }
    .section.active { display: block; }
    @keyframes fadeSlideUp { 
        from { opacity: 0; transform: translateY(20px); } 
        to { opacity: 1; transform: translateY(0); } 
    }

    /* ======================================================
       2. å°èˆª (Nav) & Footer
       ====================================================== */
    nav { 
        background: var(--forest); padding: 0 40px; 
        display: flex; justify-content: space-between; align-items: center; 
        height: 80px; position: sticky; top: 0; z-index: 1000; 
        box-shadow: 0 4px 20px rgba(0,0,0,0.25); border-bottom: 3px solid var(--accent);
    }
    .logo-area { display: flex; align-items: center; cursor: pointer; height: 100%; }
    .logo-img { max-height: 60px; width: auto; transition: transform 0.3s; } 
    .logo-img:hover { transform: scale(1.05); }

    .nav-links { display: flex; gap: 20px; }
    .nav-links button { 
        background: none; border: none; padding: 8px 0; cursor: pointer; 
        font-size: 16px; color: rgba(255,255,255,0.7); transition: 0.3s; 
        font-family: 'Noto Serif TC', serif; letter-spacing: 1px; position: relative;
    }
    .nav-links button::after {
        content: ''; position: absolute; width: 0; height: 2px; bottom: 0; left: 0;
        background-color: var(--accent); transition: width 0.3s;
    }
    .nav-links button:hover { color: var(--accent); }
    .nav-links button:hover::after { width: 100%; }
    .nav-links button.active { color: var(--white); font-weight: bold; }
    .nav-links button.active::after { width: 100%; background-color: var(--white); }
    .hamburger-btn { display: none; background: none; border: none; color: var(--white); font-size: 28px; cursor: pointer; padding: 5px; }

    /* Footer */
    .footer-banner { position: fixed; bottom: 0; left: 0; width: 100%; z-index: 1000; background-color: var(--forest); border-top: 3px solid var(--accent); padding: 10px 0; box-shadow: 0 -4px 10px rgba(0,0,0,0.1); }
    .footer-content { max-width: 1200px; margin: 0 auto; padding: 0 15px; display: flex; align-items: center; justify-content: center; gap: 20px; flex-wrap: wrap; }
    .social-group { display: flex; gap: 8px; align-items: center; }
    .social-btn { display: inline-flex; align-items: center; gap: 5px; padding: 6px 12px; border-radius: 4px; text-decoration: none; font-size: 0.85rem; color: rgba(255,255,255,0.8); border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.05); transition: all 0.2s; }
    .social-btn:hover { background: var(--accent); color: var(--forest); border-color: var(--accent); }
    .copyright { font-size: 0.75rem; color: rgba(255,255,255,0.4); white-space: nowrap; }

    /* ======================================================
       3. é€šç”¨å…ƒä»¶ (UI Components)
       ====================================================== */
    /* Buttons */
    .btn-primary { 
        padding: 16px 45px; background: linear-gradient(135deg, var(--forest) 0%, #2a4032 100%); 
        color: var(--white); border: none; border-radius: 50px; font-size: 1.1rem; cursor: pointer; font-weight: bold; 
        box-shadow: 0 5px 15px rgba(26, 47, 35, 0.3); transition: all 0.3s ease; display: inline-block; letter-spacing: 1px;
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(26, 47, 35, 0.4); }
    .btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
    
    .btn-secondary { padding: 10px 25px; background: transparent; color: var(--forest); border: 2px solid var(--forest); border-radius: 50px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: 0.3s; margin-right: 10px; }
    .btn-secondary:hover { background: var(--forest); color: var(--white); }

    .btn-back-capsule, .kb-internal-back {
        display: inline-flex; align-items: center; gap: 8px;
        color: var(--forest); background: #ffffff; border: 1px solid rgba(0,0,0,0.08);
        padding: 0 15px; height: 36px; border-radius: 50px;
        font-size: 13px; font-weight: bold; font-family: 'Noto Serif TC', serif;
        cursor: pointer; margin: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        text-decoration: none; transition: all 0.3s ease;
        justify-content: center; width: auto;
    }

    .btn-back-capsule:hover, .kb-internal-back:hover { 
        color: #ffffff; background: var(--forest); border-color: var(--forest); 
        transform: translateY(-2px); box-shadow: 0 6px 15px rgba(26, 47, 35, 0.15); 
    }
    .kb-internal-back i, .btn-back-capsule i { margin-right: 6px; font-size: 13px; transform: none; }

    .kb-fab-back {
        display: none !important;
        position: fixed; bottom: 40px; right: 25px;
        width: 60px; height: 60px; border-radius: 50%;
        background: var(--forest); color: var(--accent); border: 2px solid var(--accent);
        display: flex; justify-content: center; align-items: center;
        box-shadow: 0 5px 20px rgba(0,0,0,0.4); z-index: 9999; cursor: pointer; font-size: 1.4rem;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); opacity: 0;
        animation: fabPopIn 0.5s forwards 0.3s;
    }
    .kb-fab-back:active { transform: scale(0.9); background: var(--accent); color: var(--forest); }
    @keyframes fabPopIn { from { opacity: 0; transform: scale(0) rotate(-90deg); } to { opacity: 1; transform: scale(1) rotate(0); } }

    /* Cards & Forms */
    .card { background: var(--white); padding: 40px; border-radius: 20px; box-shadow: var(--shadow-soft); border: 1px solid #eee; margin-bottom: 30px; position: relative; }
    .form-group { margin-bottom: 25px; }
    label { display: block; font-weight: bold; margin-bottom: 10px; color: var(--forest); font-size: 1.05rem; }
    label.required::after { content: " *"; color: var(--error); }
    input:not([type="checkbox"]):not([type="radio"]), select, textarea { width: 100%; padding: 14px 18px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; outline: none; transition: 0.3s; background: #fafafa; }
    input:focus, select:focus, textarea:focus { border-color: var(--accent); background: var(--white); box-shadow: 0 0 0 3px rgba(198, 168, 124, 0.2); }
    input:disabled { background: #eee; cursor: not-allowed; color: #999; }

    /* Overlays & Modals */
    .result-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(26, 47, 35, 0.9); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(8px); opacity: 0; transition: opacity 0.4s; }
    .result-overlay.active { display: flex; opacity: 1; }
    .text-modal-card { position: relative; width: 90%; max-width: 650px; max-height: 85vh; background: #fff; border-radius: 4px; overflow-y: auto; padding: 50px 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); transform: scale(0.95); opacity: 0; transition: all 0.4s ease; }
    .result-overlay.active .text-modal-card { transform: scale(1); opacity: 1; }
    .text-modal-card h3 { text-align: center; color: var(--forest); margin-top: 10px; margin-bottom: 25px; font-size: 2rem; border: none; padding: 10px 0; background: linear-gradient(to right, transparent, rgba(198, 168, 124, 0.2), transparent); }
    .close-modal-btn { display: block; width: 100%; max-width: 250px; margin: 40px auto 0 auto; padding: 14px 0; background: var(--text-main); color: white; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.2s; }
    .close-modal-btn:hover { background: var(--error); }

    /* Brand Headers */
    .brand-section-header, .draw-section-header { text-align: center; margin-bottom: 45px; padding-top: 15px; }
    .brand-h3-zh, .draw-title-zh {
        display: inline-block !important; font-family: 'Noto Serif TC', serif !important;
        font-size: 2.2rem !important; color: var(--forest); margin: 0 !important;
        font-weight: 900; letter-spacing: 5px; text-shadow: 2px 2px 0px rgba(198, 168, 124, 0.15);
        vertical-align: baseline !important;
    }
    .brand-h2-en, .draw-title-h2 {
        display: inline-block !important; font-family: 'Cinzel', serif !important;
        font-size: 1.1rem !important; color: var(--forest); margin-left: 15px !important;
        font-weight: 700; letter-spacing: 1.5px; opacity: 0.4;
        vertical-align: baseline !important; text-shadow: none !important;
    }
    .brand-capsule, .draw-desc-p {
        display: table !important; margin: 10px auto 0 auto !important;
        font-family: 'Noto Serif TC', serif !important; font-size: 0.85rem !important;
        color: #777; background: #fffdf9; padding: 4px 22px !important;
        border-radius: 50px; border: 1px solid rgba(198, 168, 124, 0.4) !important;
        box-shadow: 0 4px 10px rgba(198, 168, 124, 0.1);
    }
    .brand-capsule::before, .brand-capsule::after, .draw-desc-p::before, .draw-desc-p::after {
        content: 'âœ¦'; color: var(--accent); margin: 0 10px; font-size: 0.8rem;
    }

    /* ======================================================
       4. é¦–é å€å¡Š (Hero & Home)
       ====================================================== */
    .hero-section {
        flex-direction: column; text-align: center; padding: 40px 20px 60px 20px;
        gap: 20px; background: linear-gradient(180deg, #fffcf5 0%, #f4f7f6 100%);
        border-radius: 0 0 40px 40px; margin-bottom: 50px; border-bottom: none;
    }
    .hero-img { 
        margin: 0 auto; width: 220px; height: 220px; border-radius: 50%; overflow: hidden; 
        border: 6px solid white; box-shadow: 0 15px 35px rgba(198, 168, 124, 0.25);
        animation: floatImg 6s ease-in-out infinite; display: flex; justify-content: center; align-items: center;
        background-color: white; position: relative;
    }
    .hero-img img { width: 110% !important; height: 110% !important; object-fit: contain; border-radius: 60%; transition: transform 0.3s ease; }
    .hero-img:hover img { transform: scale(1.1); }
    @keyframes floatImg { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

    .hero-text { flex: 1; max-width: 600px; z-index: 2; display: flex; flex-direction: column; align-items: center; margin: 0 auto; }
    .hero-text h1 { font-size: 2.2rem; margin-bottom: 5px; color: var(--forest); letter-spacing: 2px; text-shadow: none; width: 100%; }
    .hero-text h2 { font-size: 1.1rem; color: #888; font-weight: normal; margin-bottom: 25px; position: relative; display: inline-block; width: 100%; }
    .hero-text h2::after { content: ''; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); width: 40px; height: 3px; background: var(--accent); border-radius: 2px; }
    
    /* å…¬å‘Šèˆ‡æŒ‰éˆ•å®¹å™¨ */
    #announcement-wrapper, #must-read-wrapper, #temp-wrapper {
        background: white; border: 1px solid rgba(198, 168, 124, 0.3); border-radius: 20px;
        padding: 40px 20px 30px 20px !important; box-shadow: 0 15px 40px rgba(26, 47, 35, 0.06);
        width: 100%; max-width: 500px; margin: 35px auto 0 auto !important; position: relative; text-align: center;
    }
    .announce-badge {
        position: absolute; top: -20px; left: 50%; transform: translateX(-50%);
        padding: 8px 25px; border-radius: 50px; font-size: 0.95rem; font-weight: 900; 
        letter-spacing: 1.5px; box-shadow: 0 5px 15px rgba(26, 47, 35, 0.2);
        background: var(--forest); color: var(--accent); border: 2px solid white;
        z-index: 20; white-space: nowrap; display: block !important;
    }
    #hero-btn-container, #must-read-container, #temp-container { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 5px; }
    #hero-btn-container .btn-primary, #must-read-container .btn-primary, #temp-container .btn-primary {
        background: white; color: var(--forest); border: 2px solid var(--forest);
        box-shadow: none; padding: 10px 25px; font-size: 1rem; transition: all 0.2s;
    }
    #hero-btn-container .btn-primary:hover, #must-read-container .btn-primary:hover, #temp-container .btn-primary:hover {
        background: var(--forest); color: white; transform: translateY(-3px); box-shadow: 0 8px 20px rgba(26, 47, 35, 0.2);
    }

    /* ä¸‰å¤§åŠŸèƒ½é¸å–® */
    .hero-menu-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; width: 100%; max-width: 800px; margin: 30px auto 0 auto; }
    .hero-menu-item {
        background: white; border: 2px solid rgba(255, 255, 255, 0.8); border-radius: 20px;
        padding: 20px 10px; text-align: center; cursor: pointer; transition: all 0.3s;
        box-shadow: 0 5px 20px rgba(26, 47, 35, 0.05); display: flex; flex-direction: column; align-items: center; gap: 8px;
    }
    .hero-menu-item:hover { transform: translateY(-8px); box-shadow: 0 15px 35px rgba(26, 47, 35, 0.15); border-color: var(--accent); }
    .hero-menu-icon {
        font-size: 2.2rem; color: var(--forest); background: #f4f7f6;
        width: 70px; height: 70px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
        margin-bottom: 5px; transition: 0.3s;
    }
    .hero-menu-item:hover .hero-menu-icon { background: var(--forest); color: var(--accent); transform: scale(1.1) rotate(10deg); }
    .hero-menu-text { font-size: 1.1rem; font-weight: 900; color: var(--forest); letter-spacing: 1px; }
    .hero-menu-desc { font-size: 0.9rem; color: #777; line-height: 1.5; margin-top: 5px; font-weight: normal; }

    /* ======================================================
       5. é ç´„æµç¨‹èˆ‡è¡¨å–® (Booking)
       ====================================================== */
    .cat-card { 
        border: 1px solid rgba(0,0,0,0.05); padding: 22px 30px; border-radius: 16px; 
        margin-bottom: 15px; cursor: pointer; background: var(--white); 
        transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
        display: flex; align-items: center; justify-content: space-between;
        box-shadow: 0 4px 15px rgba(26, 47, 35, 0.03);
    }
    .cat-card:hover { border-color: var(--accent); background: #fffdf9; transform: translateX(8px); box-shadow: 0 10px 25px rgba(198, 168, 124, 0.15); }
    .cat-card h3 { margin: 0; border: none; padding: 0; font-size: 1.25rem; color: var(--forest); font-weight: bold; }
    
    .service-card { background: #ffffff; border: 1px solid #f0f0f0; padding: 20px; border-radius: 15px; margin-bottom: 15px; transition: all 0.2s ease; }
    .service-card:hover { border-color: var(--accent); box-shadow: 0 8px 20px rgba(26, 47, 35, 0.05); }
    .service-card.disabled-card { opacity: 0.4; filter: grayscale(1); }
    
    .service-header { display: flex; justify-content: space-between; align-items: center; width: 100%; }
    .service-info { display: flex; align-items: center; gap: 15px; font-weight: bold; font-size: 1.1rem; cursor: pointer; flex: 1; color: var(--forest); }
    .service-info input { width: 22px; height: 22px; cursor: pointer; accent-color: var(--forest); }
    
    .price-badge { background: var(--forest); color: var(--accent); padding: 4px 14px; border-radius: 8px; font-size: 14px; font-weight: 900; font-family: 'Cinzel', serif; letter-spacing: 1px; }
    .service-desc { font-size: 0.95rem; color: #888; margin-left: 38px; padding-top: 5px; line-height: 1.5; }
    
    /* åŠ è³¼å€èˆ‡ç‰¹æ®Šä½ˆå±€ */
    .sub-check-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; margin-top: 15px; padding: 18px; background: rgba(26, 47, 35, 0.04); border-radius: 12px; border: 1px solid rgba(26, 47, 35, 0.05); }
    .sub-opt-label { font-size: 14px; display: flex; align-items: center; gap: 10px; cursor: pointer; color: var(--forest-light); font-weight: 500; }
    .sub-opt-label input { width: 18px; height: 18px; accent-color: var(--accent); }

    .service-setting-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: end; background: #fffcf5; padding: 20px; border-radius: 12px; border: 1px solid #fae1c3; margin: 25px 0; }
    .info-grid { display: grid; grid-template-columns: 1fr 1.2fr 1.5fr; gap: 20px; margin-bottom: 20px; align-items: start; }

    /* çµç®—å€ */
    .checkout-footer { display: flex; justify-content: space-between; align-items: center; border-top: 2px dashed #eee; margin-top: 30px; padding-top: 20px; }
    .checkout-footer .coupon-box { 
        margin: 0 !important; 
        flex: 0 0 320px; 
        background: #fffdf9; 
        padding: 15px 20px; 
        border-radius: 12px; 
        border: 1px solid rgba(198, 168, 124, 0.4); 
        display: flex; flex-direction: column; gap: 10px; align-items: stretch; 
    }
    /* è«‹æ‰¾åˆ°é€™ä¸€æ®µä¸¦ä¿®æ”¹ */
    .checkout-footer .total-box { 
        margin: 0 !important; 
        padding: 0 !important; 
        border: none !important; 
        text-align: right; 
        font-size: 2rem; 
        font-weight: 900; 
        color: var(--forest); 
        font-family: 'Cinzel', serif; 
        letter-spacing: 1px;
        
        /* ğŸ”¥ åŠ é€™ä¸€è¡Œï¼ä¿è­‰å®ƒæ°¸é é å³é‚Šï¼ */
        margin-left: auto !important;
    }
    .ota-grid-row {
        display: grid;
        grid-template-columns: 1fr 1.5fr; /* é›»è…¦ï¼šå·¦1 å³1.5 */
        gap: 15px;
    }
    .coupon-msg { font-size: 13px; font-weight: bold; margin-top: 8px; letter-spacing: 0.5px; }

    /* è¦å‰‡èˆ‡æ¢æ¬¾ */
    .story-text p { font-size: 1.1rem; line-height: 1.8; color: #444; margin-bottom: 20px; }
    .highlight-text { color: #a0522d; font-weight: bold; background: rgba(198, 168, 124, 0.15); padding: 10px 15px; border-radius: 8px; border-left: 4px solid var(--accent); margin: 20px 0; }
    .disclaimer-box { background-color: #fffcf5; border: 2px dashed var(--accent); border-radius: 8px; padding: 15px 20px; margin: 20px auto 30px auto; text-align: center; max-width: 90%; width: 600px; position: relative; overflow: hidden; box-shadow: 0 4px 10px rgba(198, 168, 124, 0.15); }
    .disclaimer-box::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 5px; background-color: var(--accent); }
    .disclaimer-box p { margin: 5px 0; color: var(--forest); font-weight: bold; font-size: 1rem; line-height: 1.6; }

    /* ğŸ”¥ æ–°å¢ï¼šæ¨™é¡Œèˆ‡è¿”å›æŒ‰éˆ•çš„æ’ç‰ˆå„ªåŒ– */
    .step-header-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center; /* æ¨™é¡Œç½®ä¸­ */
        margin-bottom: 30px;
        min-height: 50px;
    }
    
    /* è¿”å›æŒ‰éˆ•ï¼šé›»è…¦ç‰ˆçµ•å°å®šä½åœ¨å·¦é‚Š */
    .step-header-wrapper .btn-back-capsule {
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        z-index: 10;
    }

    /* æ¨™é¡Œæœ¬é«”ï¼šå„ªé›…çš„è¥¯ç·šå­—é«” */
    .step-title-fancy {
        font-family: 'Noto Serif TC', serif;
        font-size: 1.6rem;
        font-weight: 900;
        color: var(--forest);
        letter-spacing: 2px;
        border-bottom: 3px solid var(--accent); /* åº•éƒ¨è£é£¾ç·š */
        padding-bottom: 5px;
        margin: 0;
        text-align: center;
    }

    /* ======================================================
       6. åŸ¹ç™’å¯¶å…¸ (Knowledge Base)
       ====================================================== */

    /* 2. ç®±å­å…§çš„æŒ‰éˆ•åˆ—ï¼šå¼·åˆ¶é å³ */
    .kb-inner-header-row {
        display: flex !important;
        justify-content: space-between !important; /* ğŸ‘ˆ å·¦å³æ’é–‹ï¼šå·¦è¿”å›ã€å³åŠŸèƒ½ */
        align-items: center !important;
        width: 100% !important;
        margin-bottom: 25px !important;
        gap: 10px;
    }
    /* çµ±ä¸€æŒ‰éˆ•èˆ‡åˆ†äº«éµçš„é–“è· */
    .kb-action-group {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    /* æ–‡ç« å…§å®¹é  (.kb-article-view) å»ºè­°ä¿ç•™ç™½è‰²åº•ï¼Œé€™æ¨£è®€é•·æ–‡æ‰èˆ’æœ */
    .kb-article-view { 
        background: #ffffff; 
        padding: 40px 50px; 
        border-radius: 16px; 
        box-shadow: 0 10px 40px rgba(26, 47, 35, 0.08); 
        max-width: 900px; 
        margin: 0 auto 60px auto; 
    }.kb-cat-header { text-align: center; margin-bottom: 40px; }
    .kb-cat-title-h1 { font-family: 'Noto Serif TC', serif; font-size: 2.5rem; color: var(--forest); font-weight: 900; margin: 0; letter-spacing: 2px; text-shadow: 2px 2px 0px rgba(198, 168, 124, 0.2); }
    .kb-article-title-h1 { font-family: 'Noto Serif TC', serif; font-size: 2rem; font-weight: 900; color: var(--forest); margin-bottom: 20px; line-height: 1.4; text-align: center; }


    /* --- åŸ¹ç™’å¯¶å…¸ï¼šä¾¿åˆ©è²¼ä¿®æ­£ç‰ˆ (åŠ ç²— + é˜²æ¨¡ç³Š + æœƒè½‰å‹•) --- */
    .kb-tiny-note {
        position: absolute; top: 25px; right: 30px; z-index: 99;
        background: #ffffff; border: 2px dashed var(--accent); padding: 15px 25px;
        border-radius: 12px; box-shadow: 0 5px 20px rgba(198, 168, 124, 0.15);
        
        /* ğŸ”¥ ä½ çš„ç¥å»ºè­°ï¼šåŠ ç²—å­—é«”ï¼Œè§£æ±ºç´°ç·šå¤±çœŸå•é¡Œ */
        font-weight: bold !important; 
        font-size: 13px; color: #555; text-align: left; line-height: 1.7; font-family: sans-serif;
        max-width: 300px;
        
        /* ğŸ”¥ è§£æ±ºéœæ­¢æ¨¡ç³Šï¼šä½¿ç”¨ scale(1) æ­é…å¹³æ»‘æ¸²æŸ“æ¿¾é¡ */
        transform: rotate(1.2deg);
        -webkit-font-smoothing: antialiased; 
        backface-visibility: hidden;
        filter: drop-shadow(0 0 0 transparent); /* å¼·åˆ¶é‡ç¹ª */
        
        transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    /* ğŸ”¥ ç¢ºä¿æ»‘é¼ ç§»å…¥æœƒã€Œè½‰ä¸€ä¸‹ã€è€Œä¸”è®Šè¶…æ¸…æ¥š */
    .kb-tiny-note:hover { 
        transform: rotate(0deg) scale(1.05) !important; 
        box-shadow: 0 10px 30px rgba(198, 168, 124, 0.3);
        color: var(--forest);
        z-index: 100;
    }
    /* ğŸ”¥ KB åˆ—è¡¨èˆ‡å¡ç‰‡ (çµ±ä¸€ç˜¦èº«ç‰ˆ) */
    .kb-list-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; padding: 5px 0; }
    
    

    .kb-article-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(26, 47, 35, 0.1); border-left-color: var(--forest); }
    
    .kb-card-content {
        display: flex !important;
        align-items: center !important;
        width: 100% !important;
        min-width: 0 !important; /* è§¸ç™¼ ellipsis é—œéµ */
    }

    .kb-card-text {
        font-size: 1.05rem !important;
        font-weight: bold !important;
        color: var(--forest) !important;
        white-space: nowrap !important;   /* ğŸ”¥ å¼·åˆ¶ä¸€è¡Œ */
        overflow: hidden !important;      /* ğŸ”¥ è¶…å‡ºéš±è— */
        text-overflow: ellipsis !important; /* ğŸ”¥ è¶…å‡ºè®Š ... */
        flex: 1 !important;
    }
    /* â” ç®­é ­ä¹Ÿå„ªåŒ–ä¸€ä¸‹ */
    .kb-arrow {
        font-size: 1.5rem !important;
        color: var(--accent) !important; /* ç®­é ­æ”¹ç”¨é‡‘è‰² */
        opacity: 0.6;
    }
    .kb-article-card:hover .kb-arrow { color: var(--forest); transform: translateX(5px); }

    /* ä¸­åˆ†é¡åˆ†éš” (åŸæœ¬ç›®éŒ„é çš„æ¨£å¼) */
    details.kb-section-group { margin-bottom: 40px; transition: 0.3s; }
    summary.kb-mid-separator { display: flex; align-items: center; justify-content: center; cursor: pointer; list-style: none; margin-bottom: 25px; outline: none; position: relative; }
    summary.kb-mid-separator::-webkit-details-marker { display: none; }
    summary.kb-mid-separator::before, summary.kb-mid-separator::after { content: ''; height: 2px; background: #e0e0e0; flex: 1; margin: 0 20px; }
    .kb-mid-badge { 
        background: var(--forest); color: var(--accent); padding: 10px 35px; border-radius: 50px; 
        font-size: 1.2rem; font-weight: bold; font-family: 'Noto Serif TC', serif; 
        box-shadow: 0 4px 15px rgba(26, 47, 35, 0.2); display: flex; align-items: center; gap: 10px; 
        transition: 0.3s; border: 2px solid transparent; 
    }
    summary.kb-mid-separator:hover .kb-mid-badge { background: #fff; color: var(--forest); border-color: var(--forest); transform: translateY(-3px); }
    .kb-mid-badge::after { content: 'â–¼'; font-size: 0.8em; transition: transform 0.3s; }
    details[open] summary .kb-mid-badge::after { transform: rotate(180deg); }

    /* ğŸ”¥ æœå°‹çµæœçš„åˆ†çµ„æ¨™é¡Œ (ä»¿ç…§åŸæœ¬ä¸­åˆ†é¡çš„ç·šæ¢æ¨£å¼) */
    .kb-search-group-separator {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 40px 0 25px 0;
    }
    .kb-search-group-separator::before,
    .kb-search-group-separator::after {
        content: '';
        height: 2px;
        background: #e0e0e0;
        flex: 1;
        margin: 0 20px;
    }
    .kb-search-group-badge {
        background: var(--forest);
        color: var(--accent);
        padding: 10px 35px;
        border-radius: 50px;
        font-size: 1.2rem;
        font-weight: bold;
        font-family: 'Noto Serif TC', serif;
        box-shadow: 0 4px 15px rgba(26, 47, 35, 0.2);
    }

    .kb-meta-row { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
    .kb-tag { font-size: 0.9rem; padding: 4px 12px; border-radius: 20px; font-weight: bold; letter-spacing: 1px; }
    .kb-tag-big { background: var(--forest); color: #fff; }
    .kb-tag-mid { background: #fffcf5; color: var(--accent); border: 1px solid var(--accent); }
    .kb-divider { color: #ccc; font-size: 0.8rem; }

    /* KB é ‚éƒ¨æŒ‰éˆ•å€ */
    .kb-header-actions { display: flex !important; align-items: center !important; gap: 15px !important; margin-bottom: 25px !important; width: 100% !important; }
    
    
    /* ======================================================
       ğŸ” æœå°‹ç›¸é—œæ¨£å¼ (æ•´åˆç‰ˆ)
       ====================================================== */
    /* æœå°‹æ¡†èˆ‡å½ˆçª— */
    .btn-open-search {
        display: flex; align-items: center; gap: 10px; margin: 0 auto 30px auto; padding: 12px 30px;
        background: #fff; border: 2px solid var(--forest); border-radius: 50px;
        color: var(--forest); font-weight: bold; font-size: 1rem; cursor: pointer; transition: all 0.3s;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .btn-open-search:hover { background: var(--forest); color: var(--accent); transform: translateY(-3px); box-shadow: 0 8px 20px rgba(26, 47, 35, 0.2); }

    .kb-search-container { max-width: 650px; margin: 0 auto 30px auto; }
    
    .kb-search-group { display: flex; gap: 10px; margin-bottom: 12px; align-items: center; background: #f9f9f9; padding: 12px; border-radius: 10px; border: 1px solid #eee; }
    .kb-search-title-input { flex: 1; min-width: 80px; padding: 10px; border: 1px solid var(--forest); border-radius: 8px; font-size: 0.9rem; font-weight: bold; color: var(--forest); }
    .kb-search-key-input { flex: 2; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 0.9rem; }
    
    .kb-group-remove-btn { background: #ffebee; color: #d32f2f; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }

    .kb-search-actions { display: flex; gap: 15px; justify-content: center; margin-top: 10px; }
    .btn-add-group { background: #fff; color: var(--forest); border: 1px solid var(--forest); }
    .btn-add-group:hover { background: #f1f8e9; }
    .btn-do-search { background: var(--forest); color: var(--accent); }
    .btn-do-search:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(26,47,35,0.3); }

    .kb-result-section-title { text-align: center; margin: 40px 0 20px 0; position: relative; }
    .kb-result-section-badge { background: var(--forest); color: #fff; padding: 8px 25px; border-radius: 50px; font-size: 1.1rem; font-weight: 900; letter-spacing: 1px; box-shadow: 0 4px 10px rgba(26,47,35,0.2); display: inline-block; }
    /* ======================================================
       ğŸ” æœå°‹çµæœåˆ†çµ„æ¨™é¡Œï¼šé ‚ç´šè† å›Šæ¨£å¼
       ====================================================== */
    
    /* 1. å¤–å±¤å®¹å™¨ï¼šè² è²¬ç½®ä¸­ + å·¦å³ç•«ç·š */
    .kb-search-mid-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 40px 0 20px 0; /* èˆ‡ä¸Šä¸‹å…§å®¹ä¿æŒè·é›¢ */
    }

    /* å·¦å³å…©æ¢ç°ç·š */
    .kb-search-mid-wrapper::before,
    .kb-search-mid-wrapper::after {
        content: '';
        height: 1px;
        background: #ccc; /* ç·šæ¢é¡è‰² */
        flex: 1;          /* è‡ªå‹•æ’æ»¿å…©é‚Š */
        margin: 0 15px;   /* ç·šæ¢èˆ‡è† å›Šçš„è·é›¢ */
    }

    /* 2. è† å›Šæœ¬é«”ï¼šæ·±ç¶ åº•é‡‘å­— (å“ç‰Œè‰²) */
    .kb-search-mid-pill {
        background: var(--forest);
        color: var(--accent);
        padding: 8px 30px;        /* è† å›Šå¤§å° */
        border-radius: 50px;      /* åœ“å¼§é€ å‹ */
        font-size: 1.1rem;
        font-weight: 900;
        font-family: 'Noto Serif TC', serif;
        letter-spacing: 1.5px;
        box-shadow: 0 4px 15px rgba(26, 47, 35, 0.25); /* è®“å®ƒæµ®èµ·ä¾†çš„é™°å½± */
        border: 2px solid transparent; /* é ç•™é‚Šæ¡†ç©ºé–“ */
        transition: all 0.3s;
        white-space: nowrap;
    }

    /* æ»‘é¼ ç§»éå»çš„å°ç‰¹æ•ˆ (é¸å¡«) */
    .kb-search-mid-pill:hover {
        background: #fff;
        color: var(--forest);
        border-color: var(--forest);
        transform: translateY(-2px);
    }
    /* ======================================================
       ğŸ” æœå°‹çµæœæ¨£å¼ä¿®æ­£
       ====================================================== */
    
    /* 1. æœå°‹åˆ†çµ„å¤§æ¨™é¡Œ (å¤©è³¦ã€æŒ‘æˆ°...)ï¼šç½®ä¸­ + å·¦å³ç·šæ¢ */
    .kb-result-section-title {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 40px 0 20px 0;
        color: #555;
        font-weight: bold;
        font-size: 1.1rem;
    }
    .kb-result-section-title::before,
    .kb-result-section-title::after {
        content: '';
        height: 2px;
        background: #e0e0e0;
        flex: 1;
        margin: 0 20px;
    }
    /* æ¨™é¡Œæ–‡å­—è† å›Š */
    .kb-result-section-badge {
        background: #fff; /* ç™½åº•ï¼Œä¸åšæ·±è‰²äº†ï¼Œä¹¾æ·¨ç‚ºä¸» */
        color: var(--forest);
        padding: 5px 20px;
        border: 2px solid var(--forest);
        border-radius: 50px;
    }

    /* 2. ä¸­åˆ†é¡æ¨™é¡Œ (é–˜é–€ã€é€šé“...)ï¼šé å·¦ + æ·±ç¶ è‰²è† å›Š + ç„¡ç·šæ¢ */
    .kb-search-mid-group {
        margin-bottom: 30px;
    }
    
    .kb-mid-simple-badge {
        display: inline-block;
        background: var(--forest);
        color: var(--accent);
        padding: 6px 25px;
        border-radius: 50px;
        font-size: 1rem;
        font-weight: 900;
        font-family: 'Noto Serif TC', serif;
        margin-bottom: 15px; /* è·Ÿä¸‹é¢æ–‡ç« çš„è·é›¢ */
        box-shadow: 0 4px 10px rgba(26, 47, 35, 0.15);
    }
    /* ğŸ”¥ æœå°‹çµæœé ï¼šä¸Šæ–¹ç·¨è¼¯å€ */
    .kb-search-edit-box {
        background: #f0f4f1; /* æ·ºç¶ ç°åº• */
        border: 1px solid #dcebdc;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
    }
    
    .kb-result-row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        align-items: center;
    }
    
    .kb-result-input {
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 0.9rem;
    }
    /* æŒ‰éˆ•ç¾¤çµ„ */
    .kb-edit-actions {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px dashed #ccc;
    }
    /* ğŸ”¥ è† å›Šèˆ‡æŒ‰éˆ•çš„ä¸¦æ’å®¹å™¨ */
    .kb-action-row {
        display: flex;
        justify-content: center; /* ç½®ä¸­ */
        align-items: center;     /* å‚ç›´å°é½Š */
        gap: 15px;               /* å…©å€‹æ±è¥¿ä¸­é–“çš„è·é›¢ */
        margin-top: 15px;
        flex-wrap: wrap;         /* æ‰‹æ©Ÿç‰ˆå¦‚æœä¸å¤ å¯¬æœƒè‡ªå‹•æ›è¡Œ */
    }

    /* ğŸ”¥ æ·±ç¶ è‰²è—¥ä¸¸æŒ‰éˆ• (çµ±ä¸€é¢¨æ ¼) */
    .btn-pill-dark {
        background: var(--forest);
        color: var(--accent);
        border: 1px solid var(--forest);
        padding: 6px 20px;
        border-radius: 50px;
        font-size: 0.85rem;
        font-weight: bold;
        font-family: 'Noto Serif TC', serif;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
        box-shadow: 0 4px 10px rgba(26, 47, 35, 0.2);
        text-decoration: none;
        line-height: 1.5; /* ç¢ºä¿é«˜åº¦è·Ÿéš”å£è† å›Šå·®ä¸å¤š */
    }
    
    .btn-pill-dark:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(26, 47, 35, 0.3);
        background: #2a4032; /*ç¨å¾®è®Šäº®ä¸€é»é»*/
    }

    /* å¾®èª¿åŸæœ¬çš„ brand-capsule è®“å®ƒä¹–ä¹–æ’éšŠ */
    .brand-capsule.in-row {
        margin: 0 !important; /* æ‹¿æ‰åŸæœ¬çš„ç½®ä¸­ margin */
        display: inline-flex !important;
    }
    /* ğŸ”¥ 1. å¼·åˆ¶ä¸¦æ’å®¹å™¨ */
    .kb-action-row {
        display: flex;
        justify-content: center; /* æ•´çµ„ç½®ä¸­ */
        align-items: center;     /* å‚ç›´å°é½Š */
        gap: 15px;               /* æŒ‰éˆ•è·Ÿæ–‡å­—çš„è·é›¢ */
        margin-top: 15px;
        flex-wrap: wrap;         /* æ‰‹æ©Ÿç‰ˆç©ºé–“ä¸å¤ è‡ªå‹•æ›è¡Œ */
    }

    /* ğŸ”¥ 2. è† å›Šæ¨£å¼ä¿®æ­£ (å¼·åˆ¶è§£é™¤åŸæœ¬çš„ç½®ä¸­èˆ‡è¡¨æ ¼å±¬æ€§) */
    .brand-capsule.in-row {
        display: inline-flex !important; /* è®Šæˆè¡Œå…§å…ƒç´  */
        margin: 0 !important;            /* æ‹¿æ‰åŸæœ¬çš„ auto margin */
        width: auto !important;          /* å¯¬åº¦è‡ªå‹• */
        line-height: 1.5;                /* è·ŸæŒ‰éˆ•é«˜åº¦å°é½Š */
        vertical-align: middle;
    }

    

    /* 1. ä¿®æ­£æ¨™é¡Œç¶²æ ¼ï¼šå¼·åˆ¶ä¸­é–“ç½®ä¸­ã€å³é‚Šæ¨åˆ°åº• */
.kb-header-grid {
    display: grid !important;
    grid-template-columns: 1fr auto 1fr !important; /* å·¦å³ç­‰å¯¬åˆ†æ‰ç©ºé–“ï¼Œä¸­é–“æ‰æœƒåœ¨æ­£ä¸­é–“ */
    width: 100% !important;
    align-items: center !important;
    margin: 25px 0 !important;
}

.kb-header-right {
    display: flex !important;
    justify-content: flex-end !important; /* ğŸ”¥ é—œéµï¼šæŠŠæŒ‰éˆ•æ¨åˆ°æœ€å³é‚Šé‚Šç·£ */
}

    /* æ¢å¾©é‡‘è‰²è† å›ŠåŸæœ¬çš„æ¨£å­ */
    .brand-capsule.center-fix {
        margin: 0 !important; /* å› ç‚º Grid æœƒå¹«å®ƒç½®ä¸­ï¼Œæ‰€ä»¥ margin æ­¸é›¶ */
        white-space: nowrap;  /* ä¸å‡†æ›è¡Œ */
    }

    /* 3. ğŸ”¥ å®Œå…¨é‚„åŸæ‚¨åŸæœ¬çš„ã€Œæ·±ç¶ åº•é‡‘å­—ã€æŒ‰éˆ•æ¨£å¼ */
.btn-pill-search {
    background: var(--forest) !important;
    color: var(--accent) !important;
    border: 1px solid var(--forest) !important;
    padding: 6px 20px !important;
    border-radius: 50px !important;
    font-size: 0.85rem !important;
    font-weight: bold !important;
    font-family: 'Noto Serif TC', serif !important;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 10px rgba(26, 47, 35, 0.2);
    transition: all 0.2s;
    text-decoration: none;
    line-height: 1.5;
}
.btn-pill-search:hover {
    transform: translateY(-2px);
    background: #2a4032 !important;
    box-shadow: 0 6px 15px rgba(26, 47, 35, 0.3);
}
    /* =========================================
       KB å…§å®¹ç·¨è¼¯å™¨æ¨£å¼ (å‰å°æœ€çµ‚ç‰ˆ)
       ========================================= */
    .ql-editor { padding: 0; color: #2c3e50; font-size: 16px; line-height: 1.8; font-family: -apple-system, "Microsoft JhengHei", "Helvetica Neue", sans-serif; overflow-wrap: break-word; }
    .ql-font-serif { font-family: 'Noto Serif TC', serif !important; }
    .ql-font-monospace { font-family: 'Courier New', monospace !important; }
    .ql-editor img { max-width: 100%; height: auto; display: block; margin: 20px 0; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .ql-editor .ql-indent-1 { padding-left: 3em !important; }
    .ql-editor .ql-indent-2 { padding-left: 6em !important; }
    .ql-editor .ql-indent-3 { padding-left: 9em !important; }
    .ql-editor ul, .ql-editor ol { padding-left: 5px !important; margin-bottom: 5px !important; margin-top: 0 !important; }
    .ql-editor li { padding-left: 1.2em !important; margin-bottom: 0px !important; margin-top: 8px !important; line-height: 1.3 !important; list-style-position: outside !important; }
    .ql-editor li > p { margin: 0 !important; padding: 0 !important; display: inline-block !important; line-height: 1.3 !important; }
    .ql-editor li::before { margin-right: 0em !important; width: 1em !important; text-align: center !important; display: inline-block !important; }
    .ql-editor .ql-size-small { font-size: 0.85rem; color: #666; line-height: 1.6; }
    .ql-editor .ql-size-large { font-size: 1.5rem; font-weight: 900; margin-top: 0px !important; margin-bottom: 15px; line-height: 1.4; display: block; color: var(--forest); }
    .ql-editor .ql-size-huge { font-size: 2.2rem; font-weight: 900; margin-top: 40px; margin-bottom: 25px; line-height: 1.2; display: block; color: var(--forest); text-align: center; }
    .ql-editor blockquote { border-left: 5px solid var(--shopee, #d35400); background-color: #fffaf0; padding: 15px 20px; margin: 20px 0; color: #8a5a00; font-style: italic; font-weight: bold; }
    .ql-editor h2.title-boxed-h2 { border-left: 8px solid var(--accent); background: var(--forest); color: #fff; padding: 10px 20px; margin: 30px 0 15px 0; border-radius: 4px; font-family: 'Noto Serif TC', serif; font-size: 1.4rem; line-height: 1.4; display: table; box-shadow: 4px 4px 0px rgba(198, 168, 124, 0.4); }
    .ql-editor h3.title-boxed-h3 { border: 2px solid var(--accent); background: #fffcf5; color: var(--forest); display: inline-flex !important; align-items: center !important; justify-content: center; padding: 8px 35px !important; margin: 25px 0 5px 0 !important; border-radius: 50px; font-family: 'Noto Serif TC', serif; width: auto; max-width: 100%; min-height: 50px; }
    .ql-editor h3.title-boxed-h3 .ql-size-large { margin: 0 !important; padding: 0 !important; line-height: 1.2 !important; display: inline !important; border: none !important; color: inherit !important; }
    .ql-font-monospace { font-family: inherit !important; letter-spacing: 0.05em; color: #444; }
    strong[style*="background-color"] { padding: 0 4px; border-radius: 2px; }

    /* ======================================================
       7. æŠ½å¡ç³»çµ± & 8. æ‰‹æ©Ÿç‰ˆ RWD (æ•´åˆ)
       ====================================================== */
    #draw-area { display: grid; grid-template-columns: repeat(16, 1fr); gap: 25px 0; padding: 40px 0; perspective: 1000px; width: 100%; max-width: 900px; margin: 0 auto; justify-content: center; }
    .card-back { width: 130%; justify-self: center; aspect-ratio: 3/5; height: auto; background-image: url('https://geyrpowhaqfhnxghpokr.supabase.co/storage/v1/object/public/site-assets/cardback.png'); background-repeat: no-repeat; background-position: center; background-size: cover; border-radius: 4px; cursor: pointer; position: relative; box-shadow: -2px 0 6px rgba(0,0,0,0.3); z-index: 1; will-change: transform; transition: transform 0.2s ease-out; }
    .card-back.is-selected { transform: translateY(-30px) !important; z-index: 200 !important; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5); filter: brightness(1.1); }
    @keyframes cardShuffleIn { from { opacity: 0; transform: translateX(-30px) rotateY(-10deg); } to { opacity: 1; transform: translateX(0) rotateY(0); } }
    @keyframes cardDrawUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-160px); opacity: 1; box-shadow: 0 0 30px var(--accent); } }
    .card-back.is-drawing { animation: cardDrawUp 0.6s ease-out forwards; z-index: 999 !important; pointer-events: none; }
    @media (min-width: 1025px) { .card-back:not(.is-drawing):not(.is-selected):hover { transform: translateY(-40px) !important; z-index: 100; box-shadow: 0 -5px 15px rgba(0,0,0,0.3); } }

    .card-reveal { position: relative; width: 340px; height: 580px; background: #fff; border-radius: 24px; overflow: hidden; box-shadow: 0 0 60px rgba(198, 168, 124, 0.5); transform: scale(0.8) rotateY(90deg); opacity: 0; transition: 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .result-overlay.active .card-reveal { transform: scale(1) rotateY(0); opacity: 1; }
    .close-card-btn { position: fixed; top: 30px; right: 30px; width: 50px; height: 50px; border-radius: 50%; background: rgba(0, 0, 0, 0.6); border: 2px solid rgba(255, 255, 255, 0.5); color: white; font-size: 30px; display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 2002; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
    .close-card-btn:hover { background: var(--accent); color: var(--forest); transform: rotate(90deg); border-color: var(--forest); }
    
    .layer-bg { width: 100%; height: 100%; object-fit: cover; position: absolute; top:0; left:0; z-index: 0; opacity: 1; background-color: var(--cream); }
    .layer-text { position: absolute; z-index: 10; white-space: pre-wrap; text-align: center; transform: translate(-50%, -50%); pointer-events: none; width: max-content; }

    /* å›åˆ°é ‚éƒ¨æŒ‰éˆ• */
    #back-to-top {
        position: fixed; bottom: 90px; right: 20px; width: 40px; height: 40px;
        background: rgba(26, 47, 35, 0.8); color: #fff; border: none; border-radius: 50%;
        cursor: pointer; z-index: 998; opacity: 0; visibility: hidden;
        transform: translateY(20px); transition: all 0.4s ease;
        display: flex; align-items: center; justify-content: center; font-size: 18px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    #back-to-top.show { opacity: 1; visibility: visible; transform: translateY(0); }
    #back-to-top:hover { background: var(--accent); transform: translateY(-3px); }

    /* 9. æœƒå“¡ä¸­å¿ƒ - æ­·å²è¨‚å–®å¡ç‰‡ */
    .history-card { background: #fff; border-radius: 12px; padding: 20px; margin-bottom: 20px; position: relative; box-shadow: 0 5px 20px rgba(26, 47, 35, 0.05); border: 1px solid rgba(0,0,0,0.02); transition: all 0.3s ease; overflow: hidden; }
    .history-card:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(26, 47, 35, 0.12); }
    .history-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px; }
    .history-card.status-pending::before { background-color: #f39c12; }
    .history-card.status-paid::before { background-color: #9b59b6; }
    .history-card.status-awaiting_service::before { background-color: #3498db; }
    .history-card.status-completed::before { background-color: #27ae60; }
    .history-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; border-bottom: 1px dashed #eee; padding-bottom: 12px; }
    .history-date { font-size: 0.85rem; color: #999; letter-spacing: 1px; }
    .history-id { font-family: monospace; color: #ccc; font-size: 0.8rem; }
    .history-title { font-family: 'Noto Serif TC', serif; font-size: 1.2rem; color: var(--forest); font-weight: 900; margin-bottom: 5px; }
    .history-sub { font-size: 0.9rem; color: #666; margin-bottom: 15px; line-height: 1.5; }
    .history-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding-top: 15px; border-top: 1px solid #f5f5f5; }
    .history-price { font-family: 'Cinzel', serif; font-weight: bold; color: var(--forest); font-size: 1.1rem; }
    .status-badge { font-size: 0.75rem; padding: 4px 10px; border-radius: 20px; font-weight: bold; display: inline-block; vertical-align: middle; }
    .sb-pending { background: #fff3e0; color: #e67e22; }
    .sb-paid { background: #f3e5f5; color: #8e44ad; }
    .sb-completed { background: #e8f5e9; color: #2e7d32; }
    .btn-view-report { background: linear-gradient(135deg, var(--forest) 0%, #2a4032 100%); color: white; border: none; padding: 8px 20px; border-radius: 30px; font-size: 0.9rem; cursor: pointer; text-decoration: none; box-shadow: 0 4px 10px rgba(26, 47, 35, 0.2); transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; }
    .btn-view-report:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(26, 47, 35, 0.3); }
    /* ======================================================
   ğŸ”¥ æŒ‰éˆ•æ¨£å¼æœ€çµ‚æ•´ç†ï¼ˆåƒ…é‡å°æŒ‰éˆ•ã€ä¸å½±éŸ¿ä¾¿åˆ©è²¼èˆ‡æ–‡ç« ï¼‰
   ====================================================== */

/* 1. çµ±ä¸€æ‰€æœ‰åŠŸèƒ½æŒ‰éˆ•ï¼šç¶ åº•ã€ç™½å­—ã€ç´°é‡‘æ¡† */
.btn-primary, 
.btn-secondary,
.btn-back-capsule, 
.kb-internal-back,
.btn-pill-search,
.btn-open-search,
.kb-action-btn,
.btn-add-group,
.btn-do-search,
.close-modal-btn,
.btn-view-report,
#kb-share-btn,
#back-to-top,
.kb-fab-back,
.close-card-btn, 
#success-close-x,
#line-super-btn,
#term-btn,
#sub-btn {
    background-color: var(--forest) !important;
    color: #ffffff !important;
    border: 1px solid var(--accent) !important; /* æ¥µç´°é‡‘æ¡† */
    border-radius: 50px !important;            /* å¼·åˆ¶åœ“è§’ï¼Œè§£æ±ºæ­£æ–¹å½¢å•é¡Œ */
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    text-decoration: none;
    box-shadow: 0 4px 10px rgba(26, 47, 35, 0.2);
}

/* 2. çµ±ä¸€ Hover æ•ˆæœï¼šè®Šé‡‘åº•ã€ç™½å­— */
.btn-primary:hover, 
.btn-secondary:hover,
.btn-back-capsule:hover, 
.kb-internal-back:hover,
.btn-pill-search:hover,
.btn-open-search:hover,
.kb-action-btn:hover,
.btn-add-group:hover,
.btn-do-search:hover,
.close-modal-btn:hover,
.btn-view-report:hover,
#kb-share-btn:hover,
#back-to-top:hover,
.kb-fab-back:hover,
.close-card-btn:hover, 
#success-close-x:hover,
#line-super-btn:hover,
#term-btn:not(:disabled):hover,
#sub-btn:not(:disabled):hover {
    background-color: var(--accent) !important;
    border-color: var(--accent) !important;
    color: #ffffff !important;
    transform: translateY(-2px);
}

/* 3. ä¿®æ­£å…¬å‘Šå°ˆå€æ¨£å¼ï¼ˆé‚„åŸç™½åº•è‰²æ¡†ï¼Œä¸è¦è®Šç¶ è‰²ï¼‰ */
#hero-btn-container .btn-primary, 
#must-read-container .btn-primary, 
#temp-container .btn-primary {
    background-color: #ffffff !important;
    color: var(--forest) !important;
    border: 2px solid var(--forest) !important;
    box-shadow: none !important;
    padding: 8px 20px !important;
}
/* æ©˜è‰²å¿«è¨Šå…¬å‘Š */
#temp-container .btn-primary {
    color: #d35400 !important;
    border-color: #d35400 !important;
}
#hero-btn-container .btn-primary:hover, 
#must-read-container .btn-primary:hover {
    background-color: var(--forest) !important;
    color: #fff !important;
}
#temp-container .btn-primary:hover {
    background-color: #d35400 !important;
    color: #fff !important;
}

/* 4. ä¿®æ­£å½ˆçª—åº•éƒ¨é—œé–‰æŒ‰éˆ•ï¼šå¼·åˆ¶ç½®ä¸­ */
.close-modal-btn {
    display: block !important; /* å¿…é ˆæ˜¯ block æ‰èƒ½ç”¨ margin auto */
    margin: 40px auto 0 auto !important; 
    width: fit-content !important;
    min-width: 200px;
}

/* 5. é‡å°ç¦ç”¨æŒ‰éˆ•çš„é¡¯ç¤ºï¼ˆä¾‹å¦‚æœªå‹¾é¸åŒæ„æ™‚ï¼‰ */
#term-btn:disabled, #sub-btn:disabled {
    background-color: #ccc !important;
    border-color: #ccc !important;
    cursor: not-allowed !important;
}

    /* 2. ä¿®æ­£èƒ½é‡æŠ½å¡ï¼šå°é½Šæœå‹™é ç´„çš„è¦–è¦ºé«˜åº¦ */
    #draw-area {
        padding-top: 10 !important;     /* æ‹¿æ‰æŠ½å¡å€ä¸Šæ–¹çš„ 40px ç•™ç™½ */
    }

    /* 3. ç§»é™¤ HTML æ¨™ç±¤å…§å¤šé¤˜çš„ç¡¬æ’é–“è· */
    #draw .brand-section-header {
        margin-bottom: 40px !important; /* å¼·åˆ¶å°‡æŠ½å¡æ¨™é¡Œçš„åº•è·ç¸®å°è‡³æ»¿æ„å¯¬åº¦ */
    }
    /* ======================================================
       åŸ¹ç™’å¯¶å…¸ï¼šå¡ç‰‡æ¨£å¼åˆ†æµ
       ====================================================== */

    /* --- 1. å¤§é¡åˆ¥å°ˆå±¬ (Big Category) --- */
    .kb-big-cat-card {
        min-height: 140px !important;
        padding: 20px 35px !important;
        border-radius: 20px !important;
        border-left: 8px solid var(--accent) !important;
    }
    .kb-big-cat-card .kb-avatar {
        width: 100px !important;
        height: 100px !important;
        margin-right: 25px !important;
        flex-shrink: 0;
        object-fit: contain;
        filter: drop-shadow(4px 4px 10px rgba(26, 47, 35, 0.12));
    }
    .kb-big-cat-card .kb-card-text {
        font-family: 'Noto Serif TC', serif !important;
        font-size: 1.6rem !important;
        font-weight: 900 !important;
        letter-spacing: 3px !important;
        color: var(--forest) !important;
    }

    /* --- 2. æ–‡ç« åˆ—è¡¨å°ˆå±¬ (Article List) --- */
    .kb-article-card {
        background: #ffffff;
        padding: 12px 25px;
        border-radius: 12px;
        border: 1px solid #f0f0f0;
        border-left: 6px solid var(--accent);
        min-height: 60px; /* æ¢å¾©è¼•è–„é«˜åº¦ */
        margin-bottom: 0px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: 0.3s;
    }
    /* ======================================================
       åŸ¹ç™’å¯¶å…¸ï¼šçµ‚æ¥µå°é½Šã€é˜²æ¨¡ç³Šã€ç´”ç™½å…§å®¹ç‰ˆ
       ====================================================== */

    /* 1. åˆ—è¡¨ç®±å­ï¼šç±³è‰²åº• (Knowledge Base List) */
    .kb-cat-view { 
        background: #fdfaf5 !important; 
        padding: 40px 25px 25px 25px !important; 
        border-radius: 24px; 
        margin-top: 0 !important; 
        position: relative !important; 
        box-shadow: inset 0 0 20px rgba(26, 47, 35, 0.02);
    }

    /* 2. ğŸ”¥ æ–‡ç« å…§å®¹ç®±å­ï¼šçµ•å°ç´”ç™½ï¼Œå…§å®¹ç½®ä¸­å„ªåŒ– (Article Content) */
    .kb-article-view { 
        background: #ffffff !important; 
        padding: 50px 40px !important; 
        border-radius: 24px; 
        margin: 0 auto !important; 
        max-width: 100% !important; 
        position: relative !important; 
        box-shadow: 0 10px 40px rgba(26, 47, 35, 0.08) !important;
        border: 1px solid #eee;
    }

    /* 3. ğŸ”¥ è§£æ±ºã€Œ1ã€å°ä¸é½Šï¼šé å³å°é½Šæ‰æ˜¯å”¯ä¸€è§£ */
    .kb-card-num {
        font-family: 'Cinzel', serif !important;
        font-size: 1.45rem !important;
        color: var(--accent) !important;
        font-weight: 900 !important;
        flex: 0 0 85px !important;       /* åœè»Šæ ¼ 85px */
        display: inline-flex !important;
        justify-content: flex-end !important; /* ğŸ‘ˆ é å³æ’éšŠï¼Œæ•¸å­—å°¾å·´å°é½Šï¼Œæ–‡å­—èµ·è·‘ç·šæ‰æœƒçµ±ä¸€ */
        align-items: center;
        margin-right: 20px !important; 
        font-variant-numeric: tabular-nums !important;
        line-height: 1;
    }

    /* 4. ğŸ”¥ è§£æ±ºä¾¿åˆ©è²¼æ¨¡ç³Šï¼šåŠ ç²—å­—é«” + ç§»é™¤ translate3d */
    .kb-tiny-note {
        position: absolute; top: 25px; right: 30px; z-index: 99;
        background: #ffffff; border: 2px dashed var(--accent); padding: 15px 25px;
        border-radius: 12px; box-shadow: 0 5px 20px rgba(198, 168, 124, 0.15);
        font-family: sans-serif; font-size: 13px; color: #444; text-align: left; line-height: 1.7;
        max-width: 300px;
        transform: rotate(1.2deg);         /* éœæ­¢è§’åº¦ */
        backface-visibility: hidden;
        filter: blur(0);                   /* å¼·åˆ¶ç€è¦½å™¨ç²¾ç´°æ¸²æŸ“ */
        outline: 1px solid transparent;    /* è¼”åŠ©æ–‡å­—éŠ³åˆ©åŒ– */
        transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    /* æ»‘é¼ ç§»å…¥ï¼šé †æš¢è½‰æ­£ */
    .kb-tiny-note:hover { 
        transform: rotate(0deg) scale(1.05) !important; 
        box-shadow: 0 10px 30px rgba(198, 168, 124, 0.3);
        z-index: 100;
    }
    #kb-share-btn {
        width: 36px !important; 
        height: 36px !important; 
        padding: 0 !important; 
        border-radius: 50% !important; 
        min-width: 40px !important;
        flex-shrink: 0;
    }
    /* 5. å…¶ä»– KB å…ƒä»¶æ¨£å¼ */
    .kb-list-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
    .kb-article-card { 
        background: #ffffff !important; padding: 12px 20px !important; border-radius: 12px !important; 
        border: 1px solid #f0f0f0; border-left: 6px solid var(--accent) !important; min-height: 65px; 
        display: flex; align-items: center; transition: 0.3s; cursor: pointer;
    }
    .kb-article-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(26,47,35,0.1); }
    
    .kb-card-content { display: flex; align-items: center; width: 100%; min-width: 0; }
    .kb-card-text { 
        font-size: 1.05rem; font-weight: bold; color: var(--forest); flex: 1;
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
    }
    .kb-arrow { font-size: 1.2rem; color: var(--accent); opacity: 0.5; flex-shrink: 0; }
    /* å°‡å…©å€‹åå­—å¯«åœ¨ä¸€èµ·ï¼Œç”¨é€—è™Ÿéš”é–‹ */
.kb-action-btn, .btn-pill-search {
    height: 36px !important;           /* é–æ­»é«˜åº¦ */
    padding: 0 20px !important;        /* çµ±ä¸€å…§è· */
    font-size: 13px !important;        /* çµ±ä¸€å­—é«”å¤§å° */
    font-weight: 900 !important;       /* çµ±ä¸€ç²—ç´° */
    font-family: 'Noto Serif TC', serif !important;
    
    background-color: var(--forest) !important;
    color: #ffffff !important;
    border: 1px solid var(--accent) !important;
    border-radius: 50px !important;
    
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    white-space: nowrap;
}
    
    /* RWD: Mobile (Max 768px) */
    @media (max-width: 768px) {
        nav { padding: 0 20px; height: 80px; display: flex; justify-content: space-between; align-items: center; }
        .hamburger-btn { display: block !important; font-size: 32px !important; padding: 10px !important; color: var(--white); z-index: 1001; cursor: pointer; }
        .nav-links { display: none; position: absolute; top: 80px; left: 0; width: 100%; background: var(--forest); flex-direction: column; padding: 20px 0; box-shadow: 0 10px 20px rgba(0,0,0,0.2); border-top: 1px solid rgba(255,255,255,0.1); }
        .nav-links.active { display: flex; }
        .nav-links button { text-align: center; padding: 15px 0; width: 100%; border-bottom: 1px solid rgba(255,255,255,0.05); }
        
        .section { padding: 20px 15px 60px 15px !important; }
        .card { padding: 20px 15px !important; border-radius: 12px !important; }
        .btn-primary { padding: 12px 30px !important; font-size: 1rem !important; }

        .kb-fab-back { display: flex !important; position: fixed; bottom: 125px !important; right: 15px !important; width: 40px !important; height: 40px !important; border-radius: 50%; background: var(--forest); color: var(--accent); border: 2px solid var(--accent); box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 1002; font-size: 1.2rem; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transform: translateY(20px); transition: all 0.4s ease; }
        #back-to-top.show, .kb-fab-back.show { opacity: 1; visibility: visible; transform: translateY(0); }

        .hero-section { flex-direction: column-reverse; gap: 30px; }
        .hero-img { margin: 0 auto !important; width: 180px; height: 180px; }
        .hero-text h1 { font-size: 1.8rem; line-height: 1.4; margin-bottom: 15px; }
        .hero-menu-grid { grid-template-columns: 1fr !important; gap: 15px !important; width: 100% !important; max-width: 340px !important; margin: 30px auto 0 auto !important; }
        .hero-menu-item { width: 100% !important; padding: 25px 20px !important; display: flex !important; flex-direction: column !important; align-items: center !important; border-radius: 20px !important; box-shadow: 0 5px 15px rgba(26, 47, 35, 0.05) !important; }
        .hero-menu-icon { width: 60px !important; height: 60px !important; font-size: 2rem !important; margin-bottom: 10px !important; }

        #announcement-wrapper, #must-read-wrapper, #temp-wrapper { padding: 45px 15px 20px 15px !important; margin-top: 25px !important; }
        .announce-badge { top: -12px !important; font-size: 0.8rem !important; padding: 5px 18px !important; }
        #must-read-container, #temp-container { flex-direction: column !important; gap: 12px !important; align-items: center !important; }
        #must-read-container button, #temp-container button { width: 100% !important; max-width: 280px; padding: 12px 20px !important; display: block !important; }

        .info-grid, .service-setting-grid, .checkout-footer, #birth-geo-group, #birth-time-group { display: block !important; }
        .service-setting-grid { padding: 15px; }
        .info-grid .form-group { margin-bottom: 15px; }
        #flow-data div[style*="grid-template-columns"], #flow-data div[style*="display: grid"], #flow-data div[style*="display: flex"] { display: block !important; grid-template-columns: 1fr !important; gap: 15px !important; }
        #flow-data { padding: 15px 10px !important; }
        #flow-data .form-group { width: 100% !important; margin-bottom: 15px !important; }
        #flow-data input[type="date"], #flow-data input[type="time"], #flow-data input[type="text"], #flow-data select { width: 100% !important; max-width: 100% !important; box-sizing: border-box !important; font-size: 16px !important; appearance: none; -webkit-appearance: none; }
        #flow-data label { font-size: 0.9rem !important; margin-bottom: 5px !important; }
        
        .cat-card { padding: 15px !important; }
        .service-card { padding: 10px !important; }
        .service-info { font-size: 0.95rem !important; }
        .service-desc { font-size: 0.85rem !important; margin-left: 30px; line-height: 1.4; }

       .kb-article-view {
        background: #ffffff !important;
        box-shadow: 0 0px 0px rgba(26, 47, 35, 0.08) !important;
    }
        .kb-cat-view, .kb-article-view { padding: 30px 12px 20px 12px !important; border-radius: 16px !important; }
        .kb-card-content { flex-direction: row !important; align-items: center !important; gap: 12px; }
        .kb-list-container { gap: 10px !important; }
        /* èª¿æ•´å¡ç‰‡æ•´é«”é«˜åº¦èˆ‡åœ“è§’ï¼Œæ’èµ· 100px çš„åœ– */
        .kb-article-card { 
            padding: 10px 15px !important; /* ğŸ‘ˆ ç¸®å°ä¸Šä¸‹å…§è·ï¼ˆåŸç‚º 15pxï¼‰ */
            min-height: 60px !important;   /* ğŸ‘ˆ å°‡ 80px æ”¹æˆ 60px æˆ–æ›´å° */
        }
        .kb-big-cat-card { min-height: 110px !important; }
        .kb-card-text { font-size: 0.95rem !important; }
        .kb-section-group { margin-bottom: 25px !important; }
        .kb-mid-badge { padding: 4px 15px !important; font-size: 0.9rem !important; }
        /* æ‰‹æ©Ÿç‰ˆä¾¿åˆ©è²¼ä¿®æ­£ */
        .kb-card-num { flex: 0 0 70px !important; font-size: 1.1rem !important; margin-right: 12px !important; }
        /* æ‰‹æ©Ÿç‰ˆä¾¿åˆ©è²¼ï¼šå›ºå®šä½ç½®ã€ä¸è½‰å‹•é¿å…æ¨¡ç³Š */
       .kb-tiny-note {
            position: absolute; top: -12px; right: -5px; width: fit-content; max-width: 55%; 
            padding: 8px 10px; text-align: left; font-size: 10px; line-height: 1.4;
            transform: rotate(2deg); z-index: 999; margin: 0; transition: none;
        }
        .kb-tiny-note:hover { transform: rotate(2deg); }
        .kb-header-actions { gap: 10px !important; margin-bottom: 20px !important; }
        .kb-internal-back, .btn-back-capsule { height: 36px !important; border-radius: 50px !important; border: 1px solid rgba(0,0,0,0.1) !important; box-shadow: 0 2px 5px rgba(0,0,0,0.05) !important; margin-top: 0 !important; margin-bottom: 0 !important; }
        .kb-internal-back, .btn-back-capsule {
            background-color: var(--forest) !important; /* ğŸ‘ˆ ç¶ åº• */
            color: #ffffff !important;                   /* ğŸ‘ˆ ç™½å­— */
            border: 1px solid var(--accent) !important;  /* ğŸ‘ˆ é‡‘æ¡† */
            display: inline-flex !important;
            padding: 0 15px !important;
            height: 36px !important;
            border-radius: 50px !important;
            font-size: 13px !important;
        }
        /* æ‰‹æ©Ÿç‰ˆæŒ‰éˆ•ç¾¤çµ„å¾®èª¿ */
        .kb-inner-header-row { 
            display: flex !important; 
            flex-direction: row !important; /* ğŸ‘ˆ é–æ­»åŒåˆ— */
            justify-content: space-between !important; 
            align-items: center !important; 
            width: 100% !important; 
            gap: 8px !important;
        }
        .kb-action-group { display: flex !important; gap: 8px !important; align-items: center !important; }        .kb-internal-back, .btn-back-capsule, .btn-pill-search { font-size: 12px !important; padding: 0 12px !important; height: 34px !important; }
        .kb-internal-back i, .btn-back-capsule i { margin-right: 6px !important; font-size: 13px !important; transform: none !important; }
        .kb-header-actions { display: flex !important; align-items: center !important; gap: 8px !important; margin-bottom: 20px !important; width: 100% !important; }
        #booking-step-2 h2 { margin-top: 20px !important; }
        .ota-grid-row {
            grid-template-columns: 1fr; /* æ‰‹æ©Ÿï¼šè®Šå›ä¸€æ¬„ (ä¸Šä¸‹æ’) */
            gap: 15px;
        }
        .ql-editor h2.title-boxed-h2, .ql-editor h3.title-boxed-h3 { display: block; width: 100%; box-sizing: border-box; }
        .ql-editor h2.title-boxed-h2 { font-size: 1.2rem; padding: 10px 15px; }
        .ql-editor h3.title-boxed-h3 { font-size: 1rem; }
        #birth-time-group, #birth-geo-group { display: flex !important; flex-direction: column !important; gap: 10px !important; width: 100% !important; }
        
        #draw-area { grid-template-columns: repeat(8, 1fr) !important; gap: 6px 0 !important; width: 92% !important; margin: 0 auto !important; padding: 15px 0 !important; }
        .card-back { width: 115% !important; }
        .close-card-btn { top: 20px; right: 20px; width: 40px; height: 40px; font-size: 24px; }

        .footer-banner { padding: 5px 0 8px 0 !important; background: #1a2f23 !important; position: fixed !important; bottom: 0 !important; left: 0 !important; width: 100% !important; z-index: 1001 !important; box-shadow: 0 -2px 10px rgba(0,0,0,0.15) !important; border-top: 2px solid #c6a87c !important; border-radius: 0 !important; }
        .footer-content { padding: 0 10px !important; gap: 4px !important; display: flex !important; flex-direction: column !important; justify-content: center !important; }
        .social-btn { padding: 4px 10px !important; font-size: 12px !important; border-radius: 20px !important; border: 1px solid rgba(255,255,255,0.2) !important; }
        .social-btn i { font-size: 12px !important; }
        .copyright { margin-top: 4px !important; font-size: 10px !important; opacity: 0.5 !important; line-height: 1 !important; }
        
        /* å°‹æ‰¾é€™ä¸€è¡Œï¼ŒæŠŠ 0.9rem æ”¹æˆ 0.7rem */
        .brand-h2-en, .draw-title-h2 { font-size: 0.7rem !important; } 

        /* å°‹æ‰¾é€™ä¸€è¡Œï¼ŒæŠŠ 1.3rem æ”¹æˆ 1.6rem */
        .brand-h3-zh, .draw-title-zh { font-size: 1.6rem !important; }.brand-capsule, .draw-desc-p { font-size: 0.85rem !important; padding: 6px 12px !important; width: auto !important; max-width: 92% !important; display: inline-flex; align-items: center; justify-content: center; line-height: 1.3; }
        
        #back-to-top { position: fixed !important; bottom: 70px !important; right: 15px !important; width: 40px !important; height: 40px !important; border-radius: 50% !important; background: var(--forest) !important; color: var(--accent) !important; border: 2px solid var(--accent) !important; box-shadow: 0 4px 10px rgba(0,0,0,0.3) !important; z-index: 1002 !important; display: flex !important; justify-content: center; align-items: center; font-size: 1.2rem !important; opacity: 0; visibility: hidden; transform: translateY(20px); transition: all 0.4s ease; }
    
        .kb-search-group { flex-direction: column; align-items: stretch; position: relative; }
        .kb-group-remove-btn { position: absolute; top: 5px; right: 5px; }
        .kb-search-cat-text { font-size: 0.85rem; margin-right: 5px; }
        .kb-search-cat-text::after { margin-left: 5px; }
        .step-header-wrapper {
            flex-direction: column; /* å‚ç›´æ’åˆ— */
            align-items: flex-start; /* é å·¦å°é½Š */
            gap: 15px;
            margin-bottom: 20px;
        }
        .step-header-wrapper .btn-back-capsule {
            position: relative; /* å–æ¶ˆçµ•å°å®šä½ */
            transform: none;
            left: auto;
            top: auto;
        }
        .step-title-fancy {
            width: 100%;
            text-align: center;
            font-size: 1.4rem;
            border-bottom: none; /* æ‰‹æ©Ÿç‰ˆæ‹¿æ‰ç·šæ¢æ¯”è¼ƒä¹¾æ·¨ */
            background: linear-gradient(transparent 70%, #fff3e0 70%); /* æ”¹ç”¨è¢å…‰ç­†æ•ˆæœ */
        }
        .kb-result-row {
            flex-direction: column;
            background: #fff;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #eee;
            position: relative;
        }
        .kb-result-input { width: 100%; }
        .kb-remove-row-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ffebee;
            color: #d32f2f;
            border: none;
            width: 25px; height: 25px;
            border-radius: 50%;
        }
        /* æ‰‹æ©Ÿç‰ˆæ¨™é¡Œç¶²æ ¼ï¼šç”±æ©«å‘æ”¹ç‚ºå‚ç›´æ’åˆ— */
    .kb-header-grid {
        display: flex !important;
        flex-direction: column !important; /* ğŸ”¥ å¼·åˆ¶æ›è¡Œ */
        align-items: center !important;
        gap: 15px !important;
        width: 100% !important;
        margin: 15px 0 !important;
    }
    /* ğŸ”¥ åˆ†äº«æŒ‰éˆ•ï¼šçµ•å°åœ“å½¢çµ±ä¸€ç‰ˆ (èˆ‡å›åˆ°æœ€ä¸Šé æŒ‰éˆ•ä¸€è‡´) */
    #kb-share-btn {
        width: 36px !important;
        height: 36px !important;
        min-width: 36px !important;
        padding: 0 !important;
        border-radius: 50% !important; /* ğŸ‘ˆ é–æ­»ç‚ºæ­£åœ“å½¢ */
        display: inline-flex !important;
        align-items: center;
        justify-content: center;
        background-color: var(--forest) !important;
        color: #ffffff !important;      /* ğŸ‘ˆ çµ±ä¸€ç‚ºç™½å­— */
        border: 1px solid var(--accent) !important;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(26, 47, 35, 0.2);
        transition: all 0.3s ease;
        margin: 0 !important;
    }
    #kb-share-btn:hover { background-color: var(--accent) !important; transform: translateY(-2px); }
    #kb-share-btn i { font-size: 16px !important; color: #ffffff !important; }
    /* æ‰‹æ©Ÿç‰ˆæŒ‰éˆ•å®¹å™¨ï¼šå–æ¶ˆé å³ï¼Œæ”¹ç‚ºç½®ä¸­ä¸¦ä½”æ»¿é©åº¦å¯¬åº¦ */
    .kb-header-right {
        display: flex !important;
        justify-content: center !important; /* æ›è¡Œå¾Œç½®ä¸­ */
        width: 100% !important;
    }
    .kb-header-right  {
        width: auto !important;
        min-width: 220px;
        padding: 10px 30px !important;
    }
    .kb-avatar {
            width: 80px !important;
            height: 80px !important;
            margin-right: 15px !important;
        }
        .kb-article-card .kb-card-text {
            font-size: 1.3rem !important;
            letter-spacing: 1px !important;
        }
    /* 4. ç¸®å°æŒ‰éˆ•é«”ç©ä»¥ç¬¦åˆæ‰‹æ©Ÿç©ºé–“ */
        .btn-pill-search { 
            font-size: 12px !important; 
            padding: 6px 12px !important; 
            height: 36px !important; 
            white-space: nowrap !important;
            color: #ffffff !important; /* ğŸ‘ˆ é–æ­»ç™½å­— */
        }

        .kb-card-num { flex: 0 0 65px !important; font-size: 1.1rem !important; margin-right: 12px !important; text-align: right !important; }
        .kb-tiny-note { position: absolute !important; top: -12px !important; right: -5px !important; max-width: 55% !important; transform: rotate(2deg) !important; transition: none !important; }
    
}
    
    @media (max-width: 768px) and (orientation: landscape) {
        .kb-tiny-note { top: 10px !important; right: 15px !important; transform: rotate(0deg) !important; }
    }
    .total-display-row {
        display: flex;
        align-items: baseline; /* åº•éƒ¨å°é½Š */
        justify-content: flex-end; /* é å³ */
        gap: 10px;
        flex-wrap: wrap;
    }
</style>

</head>
<body>

<nav>
    <div class="logo-area" onclick="showSection('home')">
        <img src="logo.png" alt="åŸ¹ç™’è©¦é©—å®¤" class="logo-img" id="site-logo">
    </div>
    
    <button class="hamburger-btn" onclick="toggleMenu()">â˜°</button>

    <div class="nav-links" id="nav-menu">
        <button onclick="showSection('home')" id="nav-home" class="active">é¦–é </button>
        <button onclick="showSection('booking-step-1')" id="nav-booking">æœå‹™é ç´„</button>
        <button onclick="showSection('knowledge')" id="nav-knowledge">åŸ¹ç™’å¯¶å…¸</button>
        <button onclick="showSection('draw')" id="nav-draw">èƒ½é‡æŠ½å¡</button>
        <button onclick="showSection('member')" id="nav-member">æœƒå“¡å°ˆå€</button>
    </div>
</nav>

<div id="home" class="section active">
    <div class="hero-section">
        <div class="hero-img">
            <img src="logohuman.png" alt="åŸ¹åŸ¹" id="site-hero">
        </div>

        <div class="hero-text">
            <h1>åŸ¹ç™’è©¦é©—å®¤</h1>
            <h2>æˆ‘æ˜¯ç©ºé–“å‰µè¾¦äººåŸ¹åŸ¹</h2>
            
            <div id="must-read-wrapper" style="width: 100%; max-width: 500px; margin: 15px auto 10px auto; border: 2px solid var(--forest); border-radius: 12px; padding: 15px; background: #fff; text-align: center; display: none;">
                <div class="announce-badge" style="background: var(--forest); color: var(--accent);">âœ¦ å¿…è®€å°ˆå€ âœ¦</div>
                <div id="must-read-container" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-top:10px;"></div>
            </div>

            <div id="temp-wrapper" style="width: 100%; max-width: 500px; margin: 0 auto 20px auto; border: 2px dashed #e67e22; border-radius: 12px; padding: 15px; background: #fffcf0; text-align: center; display: none;">
                <div class="announce-badge" style="background: #e67e22; color: #fff;">ğŸ”¥ æœ€æ–°å¿«è¨Š ğŸ”¥</div>
                <div id="temp-container" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-top:10px;"></div>
            </div>

            <div class="hero-menu-grid">
                <div class="hero-menu-item" onclick="showSection('booking-step-1')">
                    <div class="hero-menu-icon"><i class="fa-regular fa-calendar-check"></i></div>
                    <div class="hero-menu-text">æœå‹™é ç´„</div>
                    <div class="hero-menu-desc">éˆæ“ºèƒ½é‡èª¿æ•´<br>æ‰¾å›åŸå» è¨­å®š</div>
                </div>

                <div class="hero-menu-item" onclick="showSection('knowledge')">
                    <div class="hero-menu-icon"><i class="fa-solid fa-book-open"></i></div>
                    <div class="hero-menu-text">åŸ¹ç™’å¯¶å…¸</div>
                    <div class="hero-menu-desc">éå°ˆæ¥­çŸ¥è­˜åº«<br>å…§è€—è‡ªæ•‘ç­†è¨˜</div>
                </div>

                <div class="hero-menu-item" onclick="showSection('draw')">
                    <div class="hero-menu-icon"><i class="fa-solid fa-wand-magic-sparkles"></i></div>
                    <div class="hero-menu-text">èƒ½é‡æŠ½å¡</div>
                    <div class="hero-menu-desc">64 é–˜é–€æŒ‡å¼•<br>ç›´è¦ºæŠ½å–è¨Šæ¯</div>
                </div>
            </div>

        </div>
    </div>
     <div class="footer-banner">
        <div class="footer-content">
            
            <div class="social-group">
                <a href="https://line.me/R/ti/p/@927ctmwa" target="_blank" class="social-btn">
                    <i class="fa-brands fa-line" style="font-size: 1.2rem;"></i> LINE
                </a>
                
                <a href="https://instagram.com/nomad91310" target="_blank" class="social-btn">
                    <i class="fa-brands fa-instagram" style="font-size: 1.2rem;"></i> IG
                </a>


                <a href="https://www.threads.net/@nomad91310" target="_blank" class="social-btn">
                    <i class="fa-brands fa-threads" style="font-size: 1.1rem;"></i> Threads
                </a>
            </div>

            <div class="copyright">
                &copy; 2026 åŸ¹ç™’è©¦é©—å®¤
            </div>
            
        </div>
    </div>
    
</div>

<div id="booking-step-1" class="section">
    
    <div class="brand-section-header">
        <div class="brand-h3-zh">æœå‹™é ç´„</div>
         <div class="brand-h2-en">SERVICE BOOKING</div>       
        <div class="brand-capsule">
            è«‹é¸æ“‡æ‚¨éœ€è¦çš„æœå‹™é ˜åŸŸ
        </div>
    </div>

    <div class="card">
        <div id="category-list">è¼‰å…¥è³‡æ–™ä¸­...</div>
    </div>
</div>

<div id="booking-step-2" class="section">
    <div class="card">
        <div class="step-header-wrapper">
            <button class="btn-back-capsule" onclick="showSection('booking-step-1')">
                <i class="fa-solid fa-arrow-left"></i> è¿”å›é‡é¸
            </button>
            <h2 id="active-cat-name" class="step-title-fancy">æœå‹™è©³æƒ…</h2>
        </div>
        <div id="entry-gate" style="max-width:600px; margin:20px auto; padding:10px; text-align:center;">
            <p style="color:#666; margin-bottom:25px;">è«‹å•æ‚¨çš„é ç´„é¡å‹ï¼Ÿ</p>
            <div style="display:flex; gap:20px; justify-content:center; flex-wrap:wrap;">
                <div onclick="openTermModal()" style="
                    flex:1; min-width:240px; cursor:pointer;
                    background:#fff; padding:30px 20px; border-radius:16px;
                    box-shadow:0 5px 15px rgba(0,0,0,0.08); border:2px solid transparent;
                    transition:all 0.3s; position:relative;"
                    onmouseover="this.style.borderColor='var(--forest)'; this.style.transform='translateY(-5px)'"
                    onmouseout="this.style.borderColor='transparent'; this.style.transform='translateY(0)'">
                    <div style="background:#e8f5e9; width:60px; height:60px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 15px auto;">
                        <i class="fa-regular fa-calendar-check" style="font-size:1.8rem; color:var(--forest);"></i>
                    </div>
                    <h3 style="margin:0 0 8px 0; color:#333; font-size:1.1rem;">ä¸€èˆ¬é ç´„</h3>
                    <p style="color:#888; font-size:0.9rem; margin:0; line-height:1.4;">å°šæœªä»˜æ¬¾<br>å…ˆå¡«å¯«é ç´„å–®</p>
                </div>
                <div onclick="selectBookingType('ota')" style="
                    flex:1; min-width:240px; cursor:pointer;
                    background:#fff; padding:30px 20px; border-radius:16px;
                    box-shadow:0 5px 15px rgba(0,0,0,0.08); border:2px solid transparent;
                    transition:all 0.3s;"
                    onmouseover="this.style.borderColor='#e67e22'; this.style.transform='translateY(-5px)'"
                    onmouseout="this.style.borderColor='transparent'; this.style.transform='translateY(0)'">
                    <div style="background:#fff3e0; width:60px; height:60px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 15px auto;">
                        <i class="fa-solid fa-ticket" style="font-size:1.8rem; color:#e67e22;"></i>
                    </div>
                    <h3 style="margin:0 0 8px 0; color:#333; font-size:1.1rem;">æŒæœ‰å¹³å°æ†‘è­‰</h3>
                    <p style="color:#888; font-size:0.9rem; margin:0; line-height:1.4;">Pinkoiã€è¦çš®<br>æˆ–å…¶ä»–å¹³å°é€šè·¯</p>
                </div>
            </div>
        </div>

        <div id="term-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:9999; justify-content:center; align-items:center; padding:20px; backdrop-filter: blur(5px);">
            <div style="background:#fff; width:100%; max-width:420px; border-radius:16px; overflow:hidden; animation:fadeSlideUp 0.3s ease; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                <div style="background:var(--forest); padding:20px; text-align:center;">
                    <h3 style="margin:0; color:#fff; font-size:1.2rem; display:flex; align-items:center; justify-content:center;">
                        <i class="fa-solid fa-shield-halved" style="margin-right:10px; color:var(--accent);"></i> é ç´„å‰è«‹ç¢ºèª
                    </h3>
                </div>
                <div style="padding:25px;">
                    <ul style="padding-left:20px; color:#555; line-height:1.8; margin-bottom:25px; font-size:0.95rem;">
                        <li style="margin-bottom:8px;">ç›®å‰åƒ…æä¾› <b>ã€è¡—å£æ”¯ä»˜ã€‘</b> è½‰å¸³ã€‚</li>
                        <li style="margin-bottom:8px;">é€™åªæ˜¯<b>ã€Œé ç´„ç”³è«‹ã€</b>ï¼Œé€å‡ºå¾Œè«‹ç¨å€™ã€‚</li>
                        <li style="margin-bottom:8px;">æˆ‘å€‘æœƒç¢ºèªæ™‚æ®µèˆ‡å…§å®¹ï¼Œ<b>ç¢ºèªç„¡èª¤å¾Œæ‰æœƒå‚³é€ä»˜æ¬¾ç¢¼çµ¦æ‚¨</b>ã€‚</li>
                        <li style="color:#c0392b; font-weight:bold; background:#fff5f5; padding:5px 10px; border-radius:6px; margin-top:10px; list-style:none; margin-left:-20px;">
                            âš ï¸ é˜²è©é¨™æé†’ï¼šæˆ‘å€‘çµ•ä¸æœƒè¦æ±‚æ‚¨è§£é™¤åˆ†æœŸä»˜æ¬¾æˆ–æ“ä½œ ATMã€‚
                        </li>
                    </ul>
                    <label style="display:flex; align-items:center; cursor:pointer; background:#f9f9f9; padding:12px; border-radius:10px; border:1px solid #eee; transition:0.2s;" onmouseover="this.style.borderColor='var(--forest)'" onmouseout="this.style.borderColor='#eee'">
                        <input type="checkbox" id="term-agree-check" style="transform:scale(1.3); margin-right:12px; accent-color:var(--forest);">
                        <span style="font-size:0.95rem; font-weight:bold; color:#333;">æˆ‘å·²é–±è®€ä¸¦åŒæ„ä¸Šè¿°äº‹é …</span>
                    </label>
                    <div style="display:flex; gap:10px; margin-top:20px;">
                         <button onclick="closeTermModal()" style="flex:1; padding:12px; border:1px solid #ddd; background:#fff; color:#666; border-radius:50px; cursor:pointer;">å†æƒ³æƒ³</button>
                         <button onclick="confirmTerm()" id="term-btn" disabled style="flex:2; padding:12px; border:none; border-radius:50px; background:#ccc; color:#fff; font-weight:bold; cursor:not-allowed; transition:0.3s;">é–‹å§‹å¡«å¯«</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="main-container" style="display:none; animation: fadeSlideUp 0.5s ease;">
            <input type="hidden" id="pay-status" value="">

            <div id="ota-area" style="display:none; background:#fffcf5; padding:20px; border-radius:12px; margin-bottom:25px; border:1px solid #fae1c3; border-left:5px solid #e67e22;">
                <div style="font-weight:bold; color:#d35400; margin-bottom:15px; font-size:0.95rem;">
                    <i class="fa-solid fa-ticket"></i> è«‹å¡«å¯«å¹³å°è¨‚å–®è³‡è¨Š
                </div>
                <div class="ota-grid-row">
                    <div class="form-group" style="margin:0;">
                        <label style="font-size:13px; color:#888;">ä»˜æ¬¾å¹³å°</label>
                        <select id="ota-source-select" style="background:#fff; border:1px solid #ddd;"></select>
                    </div>
                    <div class="form-group" style="margin:0;">
                        <label style="font-size:13px; color:#888;">è¨‚å–®ç·¨è™Ÿ</label>
                        <input type="text" id="ota-order-id" placeholder="è«‹è²¼ä¸Šç·¨è™Ÿ" style="background:#fff; border:1px solid #ddd;">
                    </div>
                </div>
            </div>

            <div class="info-grid">
                <div class="form-group"><label class="required">æ‚¨çš„å§“å</label><input type="text" id="c-name" placeholder="è«‹å¡«å¯«çœŸå¯¦å§“å"></div>
                <div class="form-group">
                    <label class="required">æ‰‹æ©Ÿè™Ÿç¢¼</label>
                    <input type="tel" id="c-phone" onblur="checkPhoneMembership()" placeholder="09xxxxxxxx">
                    <small id="phone-status" style="display:block; margin-top:5px; font-weight:bold;"></small>
                </div>
                <div class="form-group"><label class="required">E-mail</label><input type="email" id="c-email" placeholder="example@mail.com"></div>
            </div>
                    
            
            <label style="font-size:1.2rem; color:var(--forest); font-weight:900; margin-bottom:15px; display:block;">é¸æ“‡æœå‹™é …ç›®</label>
            <div id="items-area" style="margin-bottom:10px;"></div>
            
            <div class="service-setting-grid">
                <div id="conditional-question" style="background:#fcf8f2; padding:15px; border-radius:10px; border:1px solid #eee; margin:0;"></div>
                <div class="form-group" id="data-flow-wrapper" style="margin:0; background:#f4f7f6; padding:15px; border-radius:10px; border:1px solid #eee;">
                    <label style="font-weight:bold;">ğŸ”¶ è«‹é¸æ“‡è³‡æ–™æä¾›æ–¹å¼</label>
                    <select id="data-flow" onchange="toggleFlow()" style="background:white;"></select>
                </div>
            </div>

            <div id="flow-data" style="background:#fdfdfd; padding:20px; border-radius:12px; margin-bottom:20px; border:1px solid #eee;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;" id="birth-time-group">
                    <div class="form-group">
                        <label>å‡ºç”Ÿæ—¥æœŸ</label>
                        <input type="date" id="b-date">
                    </div>
                    <div class="form-group">
                        <label>å‡ºç”Ÿç²¾ç¢ºæ™‚é–“</label>
                        <input type="time" id="b-time" value="12:00">
                        <small style="color:#d32f2f; display:block; margin-top:5px; font-size:12px;">âœ… è«‹ç¢ºèªæ˜¯ä¸Šåˆæˆ–ä¸‹åˆ</small>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;" id="birth-geo-group">
                    <div class="form-group">
                        <label>å‡ºç”Ÿåœ°å€/åŸå¸‚</label>
                        <input type="text" id="b-place" placeholder="ä¾‹ï¼šå°åŒ—">
                    </div>
                    <div class="form-group">
                        <label>ç•¶åœ°æ™‚å€</label>
                        <select id="b-timezone">
                            <option value="+8">GMT+8 (å°/æ¸¯/æ–°é¦¬)</option>
                            <option value="+9">GMT+9 (æ—¥æœ¬/éŸ“åœ‹)</option>
                            <option value="+7">GMT+7 (æ³°åœ‹/å°å°¼)</option>
                            <option value="+10">GMT+10 (æ¾³æ´²-å¸ƒé‡Œæ–¯æœ¬)</option>
                            <option value="+0">GMT+0 (è‹±åœ‹/å€«æ•¦)</option>
                            <option value="+1">GMT+1 (å¾·/æ³•/ç¾©/ç‘/è¥¿)</option>
                            <option value="-5">GMT-5 (ç¾æ±-ç´ç´„/æ³¢å£«é “)</option>
                            <option value="-6">GMT-6 (ç¾ä¸­-èŠåŠ å“¥)</option>
                            <option value="-7">GMT-7 (ç¾å±±-ä¸¹ä½›)</option>
                            <option value="-8">GMT-8 (ç¾è¥¿-æ´›æ‰ç£¯/æº«å“¥è¯)</option>
                            <option value="other">å…¶ä»– (è«‹æ–¼æ•…äº‹èªªæ˜)</option>
                        </select>
                    </div>
                </div>
                <small style="color:#999; display:block; margin-top:10px; font-size:12px;">âš ï¸ è‹¥ä¸ç¢ºå®šå¤ä»¤æ™‚é–“ï¼Œè«‹ä¾å‡ºç”Ÿç•¶ä¸‹é†«é™¢ç´€éŒ„ç‚ºä¸»ã€‚</small>
            </div>
            
            <div id="flow-upload" style="display:none; background:#f9f9f9; padding:20px; border-radius:12px; margin-bottom:20px; border:1px solid #eee;">
                <div style="margin-bottom: 15px; border-left: 4px solid var(--accent); padding-left: 15px;">
                    <p style="margin:0; font-weight:bold; color:var(--forest);">ç¬¬ä¸€æ­¥ï¼šå–å¾—åœ–æª”</p>
                    <p style="margin:5px 0 0 0; font-size:0.9rem;">å‰å¾€ <a href="https://humandesignasia.org/get-your-chart/" target="_blank" style="color:var(--shopee); text-decoration:underline;">äºæ´²äººé¡åœ–å­¸é™¢</a></p>
                </div>
                <div style="margin-bottom: 20px; background: #fff; border: 1px dashed #ccc; border-radius: 8px; padding: 15px; text-align: center;">
                    <p style="margin:0 0 10px 0; font-weight:bold; color:#555; font-size:14px;">ğŸ‘€ ä¸Šå‚³ç¯„æœ¬åƒè€ƒ</p>
                    <img src="https://geyrpowhaqfhnxghpokr.supabase.co/storage/v1/object/public/site-assets/my_hd_chart.png" style="max-width: 100%; max-height: 250px; object-fit: contain;">
                </div>
                <label style="font-weight:bold; color:var(--forest); display:block; margin-bottom:10px;">ğŸ“¸ ç¬¬äºŒæ­¥ï¼šä¸Šå‚³åœ–æª”</label>
                <input type="file" id="c-file" accept="image/*" style="background:#fff; border:1px solid #ccc; width:100%; padding:10px; border-radius:8px;">
            </div>

            <div class="form-group" style="margin-top: 25px;">
                <label>ğŸ“– å¯«ä¸‹æ‚¨çš„æ•…äº‹ / ç¾æ³ (é¸å¡«)</label>
                <textarea id="c-story" placeholder="å¯ä»¥ç°¡å–®åˆ†äº«æƒ³èª¿æ•´çš„åŸå› ã€æœ€è¿‘é‡åˆ°çš„å›°é›£..." style="height: 100px; line-height: 1.6;"></textarea>
            </div>

            <div class="card" style="background:#fffcf5; border-top:none; padding:20px; margin-bottom:0; border:1px solid #fae1c3;">
                <label>ğŸ“œ æœå‹™è¦ç¯„</label>
                <div id="terms-box" style="height:120px; overflow-y:auto; border:1px solid #e0e0e0; padding:10px; font-size:13px; background:#fff; border-radius:8px; margin:10px 0;"></div>
                <label class="agree-wrapper" style="margin-top:15px; display:flex; align-items:center; gap:10px; cursor:pointer; font-weight:bold;">
                    <input type="checkbox" id="agree-check" onchange="toggleSubmitBtn(this.checked)" style="width:18px; height:18px;">
                    <span>æˆ‘å·²è©³ç´°é–±è®€ä¸¦åŒæ„</span>
                </label>
            </div>
            
            <div class="checkout-footer">
                <div class="coupon-box" style="width:100%; max-width:320px;">
                    <div style="display:flex; gap:8px;">
                        <input type="text" id="coupon-code" placeholder="å„ªæƒ ä»£ç¢¼" style="flex:1; margin:0; border:1px solid #ccc;">
                        <button class="btn-secondary" onclick="verifyCoupon()" style="margin:0; padding:10px 15px; white-space:nowrap;">å¥—ç”¨</button>
                    </div>
                    <div id="coupon-msg" class="coupon-msg"></div>
                </div>

               <div class="total-box">
                    <div style="display:flex; flex-direction:column; align-items:flex-end;">
                        
                        <div class="price-row">
                            <span id="original-price-row" style="font-size:0.9rem; color:#999; text-decoration:line-through; display:none;">
                                åŸåƒ¹ $<span id="original-price">0</span>
                            </span>
                            
                            <span id="label-text" style="font-size:1rem; font-weight:bold; color:#444;">æ‡‰ä»˜ç¸½é¡ï¼š</span>
                            <span style="color:#d35400; font-size:1.8rem; font-weight:900;">$<span id="total-price">0</span></span>
                        </div>

                        <div id="ota-reminder" style="display:none; color:#c0392b; font-size:0.85rem; font-weight:bold; margin-top:5px; line-height:1.4;">
                            è«‹é¸æ“‡èˆ‡å¹³å°è¨‚å–®ç›¸åŒçš„ç¸½é¡<br>è‹¥ç¶“æ ¸å°é‡‘é¡æœ‰èª¤ï¼Œå¾ŒçºŒæœƒå‘æ‚¨è£œæ”¶å·®é¡å”·ï¼
                        </div>

                    </div>
                </div>
            </div>

            <div style="text-align:center; margin-top:25px;">
                <button id="sub-btn" class="btn-primary" onclick="doSubmit()" disabled style="width:100%; max-width:450px; font-size:1.2rem; padding:15px 0;">â” é€å‡ºé ç´„</button>
            </div>
        </div>
    </div>
</div>

<div id="knowledge" class="section">
    <div id="kb-container">è¼‰å…¥ä¸­...</div>
</div>

<div id="draw" class="section">
    <div class="brand-section-header"> 
                <div class="brand-h3-zh">64 é–˜é–€èƒ½é‡æŒ‡å¼•</div>

        <div class="brand-h2-en">ORACLE GUIDANCE</div>
        
        <div class="brand-capsule">
            æ†‘ç›´è¦ºé¸ä¸€å¼µç‰Œï¼Œé ˜å–ç•¶ä¸‹çš„æŒ‡å¼•
        </div>
    </div>

    <div id="draw-area"><div style="color:#666;"></div></div>
</div>

<div id="member" class="section">
    <div id="login-box" class="card" style="max-width:500px; margin:50px auto;">
    <h3 style="margin-top:0; text-align:center;">ğŸ‘¤ æœƒå“¡ç™»å…¥</h3>
    <div style="margin-top:30px;">
        <input type="tel" id="l-phone" placeholder="æ‰‹æ©Ÿ (å¸³è™Ÿ)" style="margin-bottom:15px;">
        <input type="password" id="l-pass" placeholder="å¯†ç¢¼" style="margin-bottom:25px;">
        <button class="btn-primary" onclick="doLogin()" style="width:100%;">ç™»å…¥ç³»çµ±</button>
        
        <div style="text-align:center; margin-top:20px;">
            <a href="https://line.me/R/ti/p/@927ctmwa" target="_blank" 
               style="color:#999; font-size:14px; text-decoration:underline; letter-spacing:1px;">
               å¿˜è¨˜å¯†ç¢¼ï¼Ÿè«‹è‡³å®˜æ–¹ Line è©¢å•
            </a>
        </div>
    </div>
</div>
    <div id="dash" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <h3 id="dash-welcome" style="margin:0;"></h3>
            <div>
                <button class="btn-secondary" style="font-size:14px;" onclick="openEditProfile()">ä¿®æ”¹è³‡æ–™</button>
                <button class="btn-secondary" style="font-size:14px; border-color:#999; color:#999;" onclick="doLogout()">ç™»å‡º</button>
            </div>
        </div>
        <div class="card" style="background:#f1f8e9; border:1px solid #c8e6c9;">
            <h4 style="margin-top:0; color:#2e7d32;">ğŸ“‹ æ‚¨çš„æœå‹™å ±å‘Š</h4>
            <div id="dash-history" style="max-height:500px; overflow-y:auto; margin-top:15px;"></div>
        </div>
    </div>
</div>

<div id="overlay" class="result-overlay">
    <div style="position:relative;">
        <button class="close-card-btn" onclick="closeResult()">Ã—</button>
        
        <div id="final-card" class="card-reveal">
            <img id="p-bg" class="layer-bg" src="">
            <div id="p-gate" class="layer-text"></div>
            <div id="p-info" class="layer-text"></div>
            <div id="p-zodiac" class="layer-text"></div>
            <div id="p-quote" class="layer-text"></div>
        </div>
        
        </div>
</div>

<div id="success-overlay" class="result-overlay">
    <div class="text-modal-card" style="text-align:center; padding: 40px 30px; max-width: 450px; position: relative;">
        
        <button id="success-close-x" onclick="closeSuccessModal()" style="
            display: none; /* é è¨­çœ‹ä¸åˆ° */
            position: absolute; 
            top: 15px; 
            right: 15px; 
            background: none; 
            border: none; 
            font-size: 1.5rem; 
            color: #ccc; 
            cursor: pointer; 
            transition: 0.3s;
            padding: 5px 10px;"
            onmouseover="this.style.color='#666'" 
            onmouseout="this.style.color='#ccc'"
            title="é—œé–‰">
            <i class="fa-solid fa-xmark"></i>
        </button>

        <h3 style="color:var(--forest); margin:0 0 10px 0;">ğŸ‰ é ç´„æˆåŠŸï¼</h3>
        <p style="color:#666; margin-bottom: 30px;">æ‚¨çš„é ç´„å·²é€å‡ºï¼Œè¨‚å–®ç·¨è™Ÿå¦‚ä¸‹ï¼š</p>
        
        <div id="success-order-id" style="background:#f1f8e9; color:var(--forest); padding:15px; border-radius:8px; font-weight:bold; font-size:1.2rem; margin-bottom:30px; border:1px dashed var(--forest);">
            OD123456789
        </div>

        <p style="font-size:0.9rem; color:#d32f2f; font-weight:bold; margin-bottom:15px;">
            âš ï¸ è«‹å‹™å¿…é»æ“Šä¸‹æ–¹æŒ‰éˆ•<br>å‚³é€ç·¨è™Ÿçµ¦æˆ‘ç¢ºèªï¼Œæ‰ç®—å®Œæˆå–”ï¼
        </p>

        <a id="line-super-btn" href="#" target="_blank" class="btn-primary" 
           style="background:#06c755; box-shadow:0 5px 15px rgba(6,199,85,0.4); 
                  display: inline-flex; justify-content: center; align-items: center; 
                  text-decoration: none; line-height: 50px; border-radius: 30px; 
                  padding: 0 35px; width: auto; min-width: 240px; max-width: 100%; box-sizing: border-box;">
            <i class="fa-brands fa-line" style="margin-right:10px; font-size:1.5rem;"></i> 
            <span style="font-size:1.1rem; font-weight: bold;">å‚³é€è¨‚å–®ç·¨è™Ÿ (LINE)</span>
        </a>

        <div style="margin-top:25px; background:#f5f5f5; color:#777; font-size:12px; padding:12px; border-radius:8px; line-height:1.6; border:1px solid #eee;">
            ğŸ–¥ï¸ é›»è…¦ç‰ˆç”¨æˆ¶è‹¥æ²’å®‰è£ LINE<br>
            è«‹ç›´æ¥æœå°‹ ID <b style="color:#333; user-select:all;">@927ctmwa</b> ä¸¦å›å‚³è¨‚å–®ç·¨è™Ÿå”·ï¼
        </div>

        <button id="success-close-text" onclick="closeSuccessModal()" style="
            display: none; /* é è¨­çœ‹ä¸åˆ° */
            width: 100%;
            margin-top:25px; 
            background:none; 
            border:none; 
            color:#999; 
            cursor:pointer; 
            text-decoration:underline; 
            font-size:0.9rem; 
            padding: 10px;">
            ç¨å¾Œå†å‚³ï¼Œå…ˆå›é¦–é 
        </button>
    </div>
</div>


<div id="dynamic-overlay" class="result-overlay">
    <div class="text-modal-card">
        <h3 id="dyn-modal-title">è¼‰å…¥ä¸­...</h3>
        
        <div id="dyn-modal-content" class="story-text"></div>
        
        <button class="close-modal-btn" onclick="closeModal('dynamic-overlay')">é—œé–‰</button>
    </div>
</div>

<div id="edit-profile-overlay" class="result-overlay">
    <div class="text-modal-card" style="max-width:450px; padding:30px;">
        <h3 style="margin-top:0;">âœï¸ ä¿®æ”¹æœƒå“¡è³‡æ–™</h3>
        <label>æ‰‹æ©Ÿ (å¸³è™Ÿä¸å¯ä¿®æ”¹)</label><input type="text" id="ep-phone" disabled style="background:#eee; color:#666;">
        <label style="margin-top:15px;">å§“å</label><input type="text" id="ep-name">
        <label style="margin-top:15px;">Email</label><input type="email" id="ep-email">
        <label style="margin-top:15px;">æ–°å¯†ç¢¼ (ä¸æ”¹è«‹ç•™ç©º)</label><input type="password" id="ep-pass" placeholder="è¼¸å…¥æ–°å¯†ç¢¼">
        <div style="margin-top:30px; display:flex; gap:15px;">
            <button class="btn-secondary" onclick="closeModal('edit-profile-overlay')" style="flex:1; justify-content:center;">å–æ¶ˆ</button>
            <button class="btn-primary" onclick="saveProfile()" style="flex:1; padding:10px 0; font-size:1rem;">å„²å­˜</button>
        </div>
    </div>
</div>

<div id="search-overlay" class="result-overlay">
    <div class="text-modal-card" style="max-width: 650px; padding: 30px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0; font-size:1.5rem; border:none; text-align:left;">ğŸ” æ–‡ç« æœå°‹</h3>
            <button onclick="closeModal('search-overlay')" style="background:none; border:none; font-size:1.5rem; color:#999; cursor:pointer;">âœ•</button>
        </div>
        
        <div style="background: #f9f9f9; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #eee;">
            <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 10px;">
                <div>
                    <label style="font-size: 0.85rem; color: #888;">è‡ªè¨‚å ±å‘Šæ¨™é¡Œ (é¸å¡«)</label>
                    <input type="text" id="kb-search-report-title" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„å¤©è³¦å ±å‘Š" style="padding: 10px; margin-top: 5px;">
                </div>
                <div>
                    <label style="font-size: 0.85rem; color: #888;">ç¯©é¸å¤§åˆ†é¡</label>
                    <select id="kb-search-big-cat" style="padding: 10px; margin-top: 5px;">
                        <option value="">å…¨åŸŸæœå°‹</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="modal-search-groups-area"></div>

        <div class="kb-search-actions" style="margin-top:25px;">
            <button class="kb-action-btn btn-add-group" onclick="addSearchGroup()" style="background:#fff; color:var(--forest); border:1px solid var(--forest); padding:10px 25px; border-radius:50px; cursor:pointer;">
                <i class="fa-solid fa-plus"></i> æ–°å¢æ¬„ä½
            </button>
            <button class="btn-pill-search" onclick="doKbSearch()" style="padding:10px 35px;">
                <i class="fa-solid fa-magnifying-glass"></i> åŸ·è¡Œæœå°‹
            </button>
        </div>
    </div>
</div>

<script>
    const SB_URL = "https://geyrpowhaqfhnxghpokr.supabase.co";
    const SB_KEY = "sb_publishable_aXucdq8UtvMbCKbriqpJCw_gtpYBw-r";
    const myDB = supabase.createClient(SB_URL, SB_KEY);

    let cats = [], items = [], activeCat = null, allCards = [], kbTree = {}, kbState = { level: 0 }, otas = [], servicesData = {};    let kbCatOrder = { big: [], mid: {}, hide_note: [] }; 
    let currentCoupon = null; 
    let currentUser = null; 
    let isMemberBlocked = false; 
    const defaultStyle = { gate: { x: 50, y: 65, size: 34, font: "'Cinzel', serif", color: "#1a1a1a", stroke: "#ffffff" }, info: { x: 50, y: 72, size: 18, font: "'Noto Serif TC', serif", color: "#1a1a1a", stroke: "transparent", w: 300 }, zodiac: { x: 85, y: 65, size: 12, font: "sans-serif", color: "#6a1b9a", stroke: "transparent" }, quote: { x: 50, y: 88, size: 15, font: "'Shippori Mincho', serif", color: "#ffffff", stroke: "#000000", w: 280, lh: 1.6, ls: 0 } };

    // ğŸ”¥ showSection ä¿®æ­£ç‰ˆï¼šæ”¯æ´ã€Œä¸æ¸²æŸ“ç›®éŒ„ã€çš„ç´”åˆ‡æ›æ¨¡å¼
    function showSection(id, isDirectArticle = false) { 
        // 1. æ”¹å›åŸæ¨™é¡Œ
        document.title = "åŸ¹ç™’è©¦é©—å®¤";

        // 2. ç¶²å€æ¸…ç† (åªæœ‰åœ¨ã€Œéç›´æ¥çœ‹æ–‡ç« ã€çš„æƒ…æ³ä¸‹æ‰æ¸…ç©ºï¼Œé¿å…æŠŠæ–‡ç« é€£çµæ´—æ‰)
        if (!isDirectArticle) {
             const cleanUrl = window.location.pathname;
             window.history.pushState({ path: cleanUrl }, '', cleanUrl);
        }

        // 3. åˆ‡æ›é¡¯ç¤ºå€å¡Š
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active')); 
        document.getElementById(id).classList.add('active'); 
        
        // 4. è™•ç†å°èˆªæŒ‰éˆ•ç‹€æ…‹
        document.querySelectorAll('.nav-links button').forEach(b => b.classList.remove('active'));
        const baseId = id.split('-')[0]; 
        const navBtn = document.getElementById('nav-' + baseId);
        if(navBtn) navBtn.classList.add('active');
        
        document.getElementById('nav-menu').classList.remove('active');
        
        // ğŸ”¥ é—œéµä¿®æ”¹ï¼š
        // åªæœ‰åœ¨ã€Œä¸æ˜¯ã€ç›´æ¥çœ‹æ–‡ç« çš„æƒ…æ³ä¸‹ï¼Œæ‰ç•«å‡ºç›®éŒ„
        // é€™æ¨£å°±ä¸æœƒç™¼ç”Ÿã€Œå…ˆçœ‹åˆ°ç›®éŒ„ -> æ‰è®Šæˆæ–‡ç« ã€çš„æ€ªç•°è·³è½‰
        if (id === 'knowledge' && !isDirectArticle) {
            renderKbHome(); 
        }
        window.scrollTo(0,0); 
    }

   document.addEventListener("DOMContentLoaded", async () => {
        
        const params = new URLSearchParams(window.location.search);
        const targetArticle = params.get('article');
        const targetView = params.get('view'); 
        
        // ğŸ”¥ æ”¹ç”¨ 'q' åƒæ•¸ä¾†æ¥æ”¶ JSON è³‡æ–™
        const targetQ = params.get('q'); 

        const loadingHtml = `
            <div style="height: 80vh; display: flex; justify-content: center; align-items: center; flex-direction: column;">
                <img src="logoloading.png" 
                     style="width: 100px; height: 100px; object-fit: contain; 
                            animation: spin 2s infinite linear; 
                            filter: drop-shadow(0 0 15px rgba(198, 168, 124, 0.5));">
                <div style="margin-top: 20px; color: var(--forest); font-weight: 900; letter-spacing: 2px; font-family: 'Noto Serif TC', serif;">
                    è³‡æ–™èª¿é–±ä¸­...
                </div>
            </div>
            <style>@keyframes spin { 100% { transform: rotate(360deg); } }</style>
        `;

        if (targetArticle) {
            showSection('knowledge', true); 
            document.getElementById('knowledge').classList.add('kb-reading-mode');
            document.getElementById('kb-container').innerHTML = loadingHtml;
        } 
        else if (targetView === 'knowledge') {
            showSection('knowledge', true); 
            document.getElementById('knowledge').classList.add('kb-reading-mode'); 
            document.getElementById('kb-container').innerHTML = loadingHtml;
        }
        else if (targetView === 'booking-step-1') {
            showSection('booking-step-1');
            document.getElementById('category-list').innerHTML = loadingHtml;
        }
        else if (targetView && document.getElementById(targetView)) {
            showSection(targetView);
        }
        else {
            showSection('home');
        }

        const p1 = initBookingData(); 
        initDrawData(); 
        const p3 = initKbData(); 
        loadSiteAssets();
        checkSession(); 
        loadHeroAnnouncements();

        await Promise.all([p1, p3]); 

        // ... å‰é¢ä¸è®Š ...
        if (targetArticle) {
            readArt(targetArticle);
        } 
        else if (targetView === 'knowledge') {
            // ğŸ”¥ è§£æ JSON æœå°‹è³‡æ–™ (ä¿®æ­£ç‰ˆ)
            if (targetQ) {
                try {
                    // 1. å˜—è©¦ç”¨è¬ç”¨è§£ç¢¼å™¨ (æ–°ç‰ˆ)
                    const decodedJson = safeB64Decode(targetQ);
                    const searchData = JSON.parse(decodedJson);
                    doKbSearch(searchData);
                } catch(e) {
                    console.log("æ–°ç‰ˆè§£æå¤±æ•—ï¼Œå˜—è©¦èˆŠç‰ˆ...");
                    try {
                        // 2. å˜—è©¦èˆŠç‰ˆ JSON è§£æ (ç›¸å®¹èˆŠç¶²å€)
                        const searchData = JSON.parse(decodeURIComponent(targetQ));
                        doKbSearch(searchData);
                    } catch (e2) {
                        console.error("ç¶²å€è§£æå®Œå…¨å¤±æ•—", e2);
                        // è§£æå¤±æ•—å°±é¡¯ç¤ºé¦–é ï¼Œä¸è¦è®“ç•«é¢å…¨ç™½
                        renderKbHome();
                    }
                }
            } else {
                renderKbHome(); 
            }
        }
    });
    function toggleMenu() {
        const menu = document.getElementById('nav-menu');
        menu.classList.toggle('active');
    }
    async function checkSession() {
        const saved = sessionStorage.getItem('peiyu_session'); 
        if (saved) {
            try {
                const { phone, pass } = JSON.parse(saved);
                document.getElementById('l-phone').value = phone;
                document.getElementById('l-pass').value = pass;
                await doLogin(); 
                console.log("Session æ¢å¾©æˆåŠŸ");
            } catch (e) {
                sessionStorage.removeItem('peiyu_session');
            }
        }
    }

    async function checkPhoneMembership() {
        const phone = document.getElementById('c-phone').value.trim();
        const statusEl = document.getElementById('phone-status');
        const submitBtn = document.getElementById('sub-btn');

        if (!phone || currentUser) return;
        if (!/^09\d{8}$/.test(phone)) {
            statusEl.innerHTML = "âŒ æ ¼å¼éŒ¯èª¤ (éœ€10ç¢¼)"; statusEl.style.color = "red"; submitBtn.disabled = true; return;
        }

        statusEl.innerHTML = "ğŸ” æª¢æŸ¥ä¸­...";
        const { data } = await myDB.from('profiles').select('id').eq('phone', phone).single();

        if (data) {
            isMemberBlocked = true;
            statusEl.innerHTML = `âš ï¸ æ­¤è™Ÿç¢¼å·²è¨»å†Šï¼è«‹å…ˆ <a href="#" onclick="showSection('member'); return false;" style="color:red;font-weight:bold;text-decoration:underline;">ç™»å…¥æœƒå“¡</a>`;
            statusEl.style.color = "red"; submitBtn.disabled = true; submitBtn.innerText = "è«‹å…ˆç™»å…¥æœƒå“¡";
        } else {
            isMemberBlocked = false;
            statusEl.innerHTML = "âœ… æ–°æœ‹å‹æ­¡è¿ä½ ";
            statusEl.style.color = "green";
            toggleSubmitBtn(document.getElementById('agree-check').checked);
        }
    }

    async function verifyCoupon() {
        const code = document.getElementById('coupon-code').value.trim().toUpperCase();
        const msgEl = document.getElementById('coupon-msg');
        const phone = document.getElementById('c-phone').value.trim();

        if (!phone && !currentUser) { alert("âš ï¸ è«‹å…ˆè¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼æˆ–ç™»å…¥æœƒå“¡ï¼Œæ‰èƒ½é©—è­‰å„ªæƒ åˆ¸è³‡æ ¼ï¼"); return; }
        if (!code) { msgEl.innerText = ""; currentCoupon = null; calcTotal(); return; }

        msgEl.className = "coupon-msg"; msgEl.innerText = "æŸ¥è©¢ä¸­...";

        const { data: coupon, error } = await myDB.from('coupons').select('*').eq('code', code).single();

        if (error || !coupon) {
            msgEl.className = "coupon-msg error"; msgEl.innerText = "âŒ ç„¡æ•ˆçš„å„ªæƒ ä»£ç¢¼";
            currentCoupon = null;
        } else {
            if (coupon.expires_at && new Date(coupon.expires_at) < new Date()) {
                msgEl.className = "coupon-msg error"; msgEl.innerText = "âš ï¸ æ­¤ä»£ç¢¼å·²éæœŸ";
                currentCoupon = null;
            } else {
                let isMember = false;
                let searchUserId = null;

                if (currentUser) {
                    isMember = true;
                    searchUserId = currentUser.id;
                } else {
                    const { data: profile } = await myDB.from('profiles').select('id').eq('phone', phone).single();
                    if (profile) { isMember = true; searchUserId = profile.id; }
                }

                if (isMember && !coupon.allow_member) {
                    msgEl.className = "coupon-msg error"; msgEl.innerText = "âŒ æ­¤å„ªæƒ åˆ¸åƒ…é™ã€æ–°æœ‹å‹/è¨ªå®¢ã€‘ä½¿ç”¨";
                    currentCoupon = null; calcTotal(); return;
                } else if (!isMember && !coupon.allow_guest) {
                    msgEl.className = "coupon-msg error"; msgEl.innerText = "âŒ æ­¤å„ªæƒ åˆ¸åƒ…é™ã€æœƒå“¡ã€‘ä½¿ç”¨ (è«‹è¨»å†Š/ç™»å…¥)";
                    currentCoupon = null; calcTotal(); return;
                }

                if (searchUserId) {
                    const { data: history } = await myDB.from('bookings').select('id').eq('user_id', searchUserId).ilike('coupon_info', `%Code:${code}%`).limit(1);
                    if (history && history.length > 0) {
                        msgEl.className = "coupon-msg error"; msgEl.innerText = "âŒ æ‚¨å·²ä½¿ç”¨éæ­¤å„ªæƒ åˆ¸ (é™ç”¨ä¸€æ¬¡)";
                        currentCoupon = null; calcTotal(); return;
                    }
                }

                currentCoupon = coupon;
                let desc = coupon.discount_type === 'percentage' ? `æ‰“ ${coupon.discount_value < 10 ? coupon.discount_value*10 : coupon.discount_value} æŠ˜` : `æŠ˜æŠµ $${coupon.discount_value}`;
                msgEl.className = "coupon-msg success"; msgEl.innerText = `âœ… å¥—ç”¨æˆåŠŸï¼š${coupon.name} (${desc})`;
            }
        }
        calcTotal(); 
    }

    async function initBookingData() {
        const { data: c } = await myDB.from('service_categories').select('*').order('created_at'); 
        cats = (c || []).filter(x => x.is_active !== false);
        
        // å»ºç«‹å°ç…§è¡¨ï¼Œè®“ selectCat æ‰¾å¾—åˆ°è³‡æ–™
        servicesData = {};
        cats.forEach(cat => { servicesData[cat.id] = cat; });

        const { data: i } = await myDB.from('services').select('*').order('sort_order'); 
        items = i || [];
        
        const { data: o } = await myDB.from('ota_settings').select('*'); 
        otas = o || [];
        
        const otaSelect = document.getElementById('ota-source-select');
        if(otaSelect) otaSelect.innerHTML = otas.map(p => `<option value="${p.code}">${p.name}</option>`).join('');

        document.getElementById('category-list').innerHTML = cats.map(c => `
            <div class="cat-card" onclick="selectCat('${c.id}')">
                <h3>${c.name}</h3>
                <span style="font-size:1.5rem; color:var(--accent);">â”</span>
            </div>`).join('');
    }

    // --- æ–°å¢çš„å…¥å£èˆ‡å½ˆçª—æ§åˆ¶ ---
    function openTermModal() { document.getElementById('term-modal').style.display = 'flex'; }
    function closeTermModal() { document.getElementById('term-modal').style.display = 'none'; }
    // ç¶å®šå‹¾é¸äº‹ä»¶
    setTimeout(() => {
        const chk = document.getElementById('term-agree-check');
        if(chk) {
            chk.addEventListener('change', function() {
                const btn = document.getElementById('term-btn');
                if(this.checked) { btn.disabled=false; btn.style.background='var(--forest)'; btn.style.cursor='pointer'; }
                else { btn.disabled=true; btn.style.background='#ccc'; btn.style.cursor='not-allowed'; }
            });
        }
    }, 1000);

    function confirmTerm() { closeTermModal(); selectBookingType('unpaid'); }

    function selectBookingType(type) {
        // 1. åˆ‡æ›é¡¯ç¤º
        document.getElementById('entry-gate').style.display = 'none';
        document.getElementById('main-container').style.display = 'block';
        
        // 2. è¨­å®šç‹€æ…‹
        document.getElementById('pay-status').value = type;
        
        // 3. æ›´æ–°ä»‹é¢
        toggleOTA();
        
        // ğŸ”¥ğŸ”¥ğŸ”¥ ä¿®æ”¹é€™è£¡ï¼šå¼·åˆ¶è¦–çª—æ»¾å‹•åˆ°æœ€ä¸Šé¢çš„ (0, 0) åº§æ¨™
        window.scrollTo({
            top: 0, 
            behavior: 'smooth' // å¹³æ»‘æ»¾å‹•ä¸Šå»
        });
    }

    function selectCat(id) {
        // 1. è¨­å®šç›®å‰é¸æ“‡çš„åˆ†é¡
        activeCat = servicesData[id]; 
        document.getElementById('active-cat-name').innerText = activeCat.name;
        
        // 2. ä»‹é¢é‡ç½® (å›åˆ°å…¥å£ã€æ¸…ç©ºè¡¨å–®)
        if(document.getElementById('entry-gate')) {
             document.getElementById('entry-gate').style.display = 'block';   
             document.getElementById('main-container').style.display = 'none'; 
             document.getElementById('term-modal').style.display = 'none';     
             const check = document.getElementById('term-agree-check'); if(check) check.checked = false;
             const btn = document.getElementById('term-btn'); if(btn) { btn.disabled=true; btn.style.background='#ccc'; }
        }
        document.getElementById('terms-box').innerText = activeCat.terms || "è«‹éµå®ˆè¦ç¯„ã€‚";
        document.getElementById('agree-check').checked = false; toggleSubmitBtn(false);
        document.getElementById('coupon-code').value = ""; document.getElementById('coupon-msg').innerText = ""; currentCoupon = null;

        // ğŸ”¥ğŸ”¥ğŸ”¥ é€™è£¡å°±æ˜¯åˆ†çµ„é‚è¼¯ ğŸ”¥ğŸ”¥ğŸ”¥
        const sub = items.filter(x => x.category_id === id);
        const mainItems = sub.filter(x => x.is_main); // æŒ‘å‡ºä¸»é …ç›®
        const addItems = sub.filter(x => !x.is_main); // æŒ‘å‡ºåŠ è³¼é …ç›®
        
        let hasCheckedMain = false; // ç”¨ä¾†è¨˜éŒ„ã€Œæ˜¯å¦å·²ç¶“å‹¾é¸äº†ç¬¬ä¸€å€‹ä¸»é …ç›®ã€
        let html = "";

        // ğŸ”¥ é€™è£¡å°±æ˜¯æ‚¨æ‰¾çš„ã€Œæ‰“å‹¾é‚è¼¯ã€ï¼æˆ‘æŠŠå®ƒåŒ…åœ¨é€™å€‹å°å·¥å…·è£¡é¢äº†
        const renderCard = (i) => {
            let checkAttr = "";
            
            // ğŸ‘‡ğŸ‘‡ğŸ‘‡ å°±åœ¨é€™è£¡ï¼ğŸ‘‡ğŸ‘‡ğŸ‘‡
            // å¦‚æœå®ƒæ˜¯ä¸»é …ç›® (is_main)ï¼Œè€Œä¸”é‚„æ²’å‹¾éä»»ä½•ä¸»é …ç›® (!hasCheckedMain)
            // å°±æŠŠå®ƒæ‰“å‹¾ (checkAttr = "checked")ï¼Œä¸¦æ¨™è¨˜å·²å‹¾é¸ (hasCheckedMain = true)
            if (i.is_main && !hasCheckedMain) { 
                checkAttr = "checked"; 
                hasCheckedMain = true; 
            }
            
            let subHtml = i.sub_options ? `<div class="sub-check-grid">${i.sub_options.split(/[,ï¼Œ]/).map(o=>`<label class="sub-opt-label"><input type="checkbox" class="sub-opt-item" data-parent-id="${i.id}" value="${o.trim()}" onchange="handleSubCheck(this)"> ${o.trim()}</label>`).join('')}</div>` : '';
            
            // æ³¨æ„é€™è£¡æœ‰ onchange="handleServiceCheck(this)"
            // é€™å°±æ˜¯ç¢ºä¿ã€Œä¸»é …ç›®åªèƒ½å–®é¸ã€çš„é—œéµï¼å®ƒæœƒå»å‘¼å«æ‚¨åŸæœ¬çš„ handleServiceCheck
            return `<div class="service-card" id="card-${i.id}">
                        <div class="service-header">
                            <label class="service-info">
                                <input type="checkbox" name="svc" value="${i.id}" 
                                    data-price="${i.price}" data-title="${i.title}" 
                                    data-is-main="${i.is_main}" ${checkAttr} 
                                    onchange="handleServiceCheck(this)"> 
                                <span>${i.title}</span>
                            </label>
                            <span class="price-badge">$${i.price}</span>
                        </div>
                        <div class="service-desc">${i.description || ''}</div>
                        ${subHtml}
                    </div>`;
        };

        // (A) é¡¯ç¤ºä¸»é …ç›®å€ (æœ‰æ¨™é¡Œ)
        if (mainItems.length > 0) {
            html += `<div style="margin-bottom:20px;">
                        <label style="font-size:1.1rem; color:var(--forest); font-weight:bold; margin-bottom:10px; display:block; border-left:4px solid var(--forest); padding-left:10px;">
                            è«‹é¸æ“‡ä¸»è¦æœå‹™é …ç›®
                        </label>
                        ${mainItems.map(i => renderCard(i)).join('')}
                     </div>`;
        }

        // (B) é¡¯ç¤ºåŠ è³¼é …ç›®å€ (æœ‰æ¨™é¡Œ)
        if (addItems.length > 0) {
            html += `<div style="margin-top:30px;">
                        <label style="font-size:1.1rem; color:var(--forest); font-weight:bold; margin-bottom:10px; display:block; border-left:4px solid var(--accent); padding-left:10px;">
                            åŠ è³¼é …ç›®
                        </label>
                        ${addItems.map(i => renderCard(i)).join('')}
                     </div>`;
        }

        document.getElementById('items-area').innerHTML = html;
        
        // 3. å…¶ä»–æ¬„ä½è™•ç†
        document.getElementById('conditional-question').innerHTML = activeCat.question_type === 'sleep' ? `<label>ğŸŒ™ ç¡çœ æ™‚é–“</label><input type="text" id="q-val" placeholder="ä¾‹å¦‚ï¼š23:30 ~ 07:00">` : `<label>ğŸ“… å¸Œæœ›è«®è©¢æ™‚é–“</label><input type="text" id="q-val" placeholder="ä¾‹å¦‚ï¼šå¹³æ—¥æ™šä¸Š">`;

        const reqStr = activeCat.data_requirement || 'birth'; 
        const flowSelect = document.getElementById('data-flow');
        const flowWrapper = document.getElementById('data-flow-wrapper');
        flowSelect.innerHTML = '';
        if (reqStr.includes('birth')) { const opt = document.createElement('option'); opt.value = 'data'; opt.text = 'ğŸ“… æä¾›å‡ºç”Ÿæ—¥æœŸæ™‚é–“'; flowSelect.add(opt); }
        if (reqStr.includes('image')) { const opt = document.createElement('option'); opt.value = 'upload'; opt.text = 'ğŸ“¸ ç›´æ¥ä¸Šå‚³äººé¡åœ–æˆªåœ–'; flowSelect.add(opt); }
        flowWrapper.style.display = (reqStr.includes('birth') && reqStr.includes('image')) ? 'block' : 'none';
        
        toggleFlow();
        calcTotal(); 
        showSection('booking-step-2');
    }

    function handleServiceCheck(el) {
        const isMain = (el.dataset.isMain === 'true');

        // ğŸ”¥ğŸ”¥ğŸ”¥ æ–°å¢é˜²å‘†ï¼šå¦‚æœé€™æ˜¯ä¸»é …ç›®ï¼Œä¸”å®¢äººè©¦åœ–å–æ¶ˆå‹¾é¸...
        if (isMain && !el.checked) {
            // æª¢æŸ¥æ˜¯å¦é‚„æœ‰å…¶ä»–ä¸»é …ç›®æ˜¯å‹¾è‘—çš„ï¼Ÿ
            const otherChecked = document.querySelectorAll('input[name="svc"][data-is-main="true"]:checked');
            
            // å¦‚æœæ²’æœ‰å…¶ä»–å‹¾é¸çš„äº† (ä»£è¡¨é€™æ˜¯æœ€å¾Œä¸€å€‹)ï¼Œå°±ç¦æ­¢å–æ¶ˆï¼
            if (otherChecked.length === 0) {
                el.checked = true; // å¼·åˆ¶å¹«ä»–å‹¾å›ä¾†
                alert("âš ï¸ å¿…é ˆè‡³å°‘é¸æ“‡ä¸€é …ã€ä¸»è¦æœå‹™ã€‘æ‰èƒ½é ç´„å”·ï¼\nï¼ˆæˆ‘å€‘ç„¡æ³•å–®ç¨æä¾›åŠ è³¼é …ç›®ï¼‰");
                return; // çµæŸå‡½å¼ï¼Œä¸é‡æ–°è¨ˆç®—é‡‘é¡
            }
        }
        // ğŸ”¥ğŸ”¥ğŸ”¥ é˜²å‘†çµæŸ

        // åŸæœ¬çš„å–®é¸é‚è¼¯ (Radio è¡Œç‚º)
        if (isMain && el.checked) {
            document.querySelectorAll('input[name="svc"][data-is-main="true"]').forEach(i => {
                if (i !== el) { 
                    i.checked = false; 
                    if(document.getElementById(`card-${i.value}`)) { 
                        document.getElementById(`card-${i.value}`).classList.remove('disabled-card'); 
                    } 
                    i.disabled = false; 
                }
            });
        }
        
        calcTotal();
    }
    
    function handleSubCheck(el) {
        const parentId = el.dataset.parentId;
        const parentCheckbox = document.querySelector(`input[name="svc"][value="${parentId}"]`);
        if (el.checked && parentCheckbox) parentCheckbox.checked = true;
        calcTotal(); 
    }

    function calcTotal() {
        let t = 0;
        // è¨ˆç®—æ‰€æœ‰å‹¾é¸é …ç›®çš„åƒ¹æ ¼
        document.querySelectorAll('input[name="svc"]:checked').forEach(el => t += parseInt(el.dataset.price || 0));
        
        const originalPrice = t;
        let finalPrice = t;

        // è¨ˆç®—å„ªæƒ åˆ¸
        if (currentCoupon) {
            if (currentCoupon.discount_type === 'percentage') {
                finalPrice = Math.round(originalPrice * (currentCoupon.discount_value / 100));
            } else {
                finalPrice = originalPrice - currentCoupon.discount_value;
            }
            if (finalPrice < 0) finalPrice = 0;

            // é¡¯ç¤ºåŸåƒ¹ (é¡¯ç¤ºåœ¨æ—é‚Šï¼Œä¸æœƒæŠŠé«˜åº¦æ’é–‹)
            document.getElementById('original-price').innerText = originalPrice;
            document.getElementById('original-price-row').style.display = 'inline'; // æ”¹ç”¨ inline è®“å®ƒæ’åœ¨æ—é‚Š
        } else {
            // æ²’æœ‰å„ªæƒ åˆ¸æ™‚ï¼Œéš±è—åŸåƒ¹
            document.getElementById('original-price-row').style.display = 'none';
        }

        // ğŸ”¥ è¨­å®šæœ€çµ‚åƒ¹æ ¼ (é¡è‰²æ°¸é ä¿æŒ #d35400 æ·±æ©˜è‰²ï¼Œä¸å†è®Šç¶ ï¼)
        const totalEl = document.getElementById('total-price');
        totalEl.innerText = finalPrice;
        totalEl.parentElement.style.color = '#d35400'; // å¼·åˆ¶é–å®šé¡è‰²

        return finalPrice;
    }

    function compressImage(file) {
        return new Promise((resolve, reject) => {
            const maxWidth = 1600; const quality = 0.7; const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image(); img.src = event.target.result;
                img.onload = () => {
                    let width = img.width; let height = img.height;
                    if (width > maxWidth) { height = Math.round(height * (maxWidth / width)); width = maxWidth; }
                    const canvas = document.createElement('canvas'); canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
                    canvas.toBlob((blob) => { if (!blob) return reject(new Error("å£“ç¸®å¤±æ•—")); resolve(blob); }, 'image/jpeg', quality);
                }; img.onerror = (err) => reject(err);
            }; reader.onerror = (err) => reject(err);
        });
    }

async function doSubmit() {
    if (isMemberBlocked) return alert("âš ï¸ ç³»çµ±åµæ¸¬æ‚¨å·²æ˜¯æœƒå“¡ï¼Œè«‹å…ˆå‰å¾€ã€Œå€‹æ¡ˆå°ˆå€ã€ç™»å…¥ï¼");
    
    const selectedSvcs = document.querySelectorAll('input[name="svc"]:checked');
    for (let svc of selectedSvcs) {
        const subBoxes = document.querySelectorAll(`.sub-opt-item[data-parent-id="${svc.value}"]`);
        if (subBoxes.length > 0) {
            const checkedSubs = document.querySelectorAll(`.sub-opt-item[data-parent-id="${svc.value}"]:checked`);
            if (checkedSubs.length === 0) {
                alert(`âŒ æ‚¨å‹¾é¸äº†ã€Œ${svc.dataset.title}ã€ï¼Œè«‹è¨˜å¾—é¸æ“‡å…·é«”çš„åŠ è³¼å…§å®¹å”·ï¼`);
                svc.scrollIntoView({ behavior: 'smooth' }); 
                return; 
            }
        }
    }

    const name = document.getElementById('c-name').value.trim();
    const phone = document.getElementById('c-phone').value.trim();
    const email = document.getElementById('c-email').value.trim();
    const qVal = document.getElementById('q-val').value.trim(); 
    const story = document.getElementById('c-story').value.trim();

    if (!name || !phone || !email) return alert("è«‹å¡«å¯«å®Œæ•´åŸºæœ¬è³‡æ–™");
    if (!/^09\d{8}$/.test(phone)) return alert("æ‰‹æ©Ÿæ ¼å¼éŒ¯èª¤ (éœ€10ç¢¼)");
    
    const finalPrice = calcTotal();
    if (finalPrice === 0 && document.querySelectorAll('input[name="svc"]:checked').length === 0) return alert("è«‹è‡³å°‘é¸æ“‡ä¸€é …æœå‹™");

    const payStatus = document.getElementById('pay-status').value;
    const otaSource = document.getElementById('ota-source-select').value;
    const otaOrderId = document.getElementById('ota-order-id').value.trim();
    if (payStatus === 'ota' && !otaOrderId) return alert("âŒ è«‹å¡«å¯«è¨‚å–®ç·¨è™Ÿ");

    if (!qVal) return alert("âŒ è«‹å›ç­”æ™‚é–“ç›¸é—œå•é¡Œ");

    const flow = document.getElementById('data-flow').value;
    let finalDataInfo = "";
    
    const btn = document.getElementById('sub-btn'); 
    btn.disabled = true; 
    btn.innerText = "è³‡æ–™è™•ç†ä¸­...";

    try {
        if (flow === 'upload') {
            const fileInput = document.getElementById('c-file');
            if (!fileInput.files || fileInput.files.length === 0) throw new Error("âŒ è«‹ä¸Šå‚³äººé¡åœ–æˆªåœ–ï¼");
            let fileToUpload = fileInput.files[0];
            if (fileToUpload.size > 1024 * 1024) fileToUpload = await compressImage(fileToUpload);
            const fName = `HD_${phone}_${Date.now()}.jpg`;
            const { error: uploadErr } = await myDB.storage.from('case-charts').upload(fName, fileToUpload, { contentType: 'image/jpeg' });
            if (uploadErr) throw uploadErr;
            const { data } = myDB.storage.from('case-charts').getPublicUrl(fName);
            finalDataInfo = `æˆªåœ–: ${data.publicUrl}`;
        } else {
            const bDate = document.getElementById('b-date').value;
            const bTime = document.getElementById('b-time').value;
            const bPlace = document.getElementById('b-place').value.trim();
            if (!bDate || !bTime || !bPlace) throw new Error("âŒ è«‹å®Œæ•´å¡«å¯«å‡ºç”Ÿè³‡æ–™");
            finalDataInfo = `å‡ºç”Ÿ: ${bDate} ${bTime} ${bPlace}`;
        }

        const checkedInputs = document.querySelectorAll('input[name="svc"]:checked');
        let details = [];
        let specificMainService = "";

        checkedInputs.forEach(el => {
            let txt = `${el.dataset.title} ($${el.dataset.price})`;
            let subs = Array.from(document.querySelectorAll(`.sub-opt-item[data-parent-id="${el.value}"]:checked`)).map(s=>s.value);
            if(subs.length) txt += ` [${subs.join('ã€')}]`;

            if (el.dataset.isMain === 'true') {
                specificMainService = txt; 
            } else {
                details.push(txt);
            }
        });

        let couponInfoText = null;
        if (currentCoupon) {
            let desc = currentCoupon.discount_type === 'percentage' ? `${currentCoupon.discount_value}æŠ˜` : `æŠ˜$${currentCoupon.discount_value}`;
            couponInfoText = `${currentCoupon.name} (${desc}) [Code:${currentCoupon.code}]`;
            await myDB.from('coupons').update({ usage_count: currentCoupon.usage_count + 1 }).eq('id', currentCoupon.id);
        }

        const myBookingId = "OD" + Date.now(); 

        const { error } = await myDB.from('bookings').insert([{
            booking_id: myBookingId,
            temp_phone: phone, 
            status: 'pending', 
            price: finalPrice,
            service_item: activeCat.name, 
            main_service: specificMainService, 
            service_detail: details.join(' | '), 
            ota_source: payStatus === 'ota' ? otaSource : null,
            ota_order_id: payStatus === 'ota' ? otaOrderId : null,
            payment_method: payStatus, 
            sleep_time: qVal,
            case_story: story,
            wish_detail: `å§“å:${name} | Email:${email} | æ•¸æ“š:${finalDataInfo}`,
            coupon_info: couponInfoText,
            user_id: currentUser ? currentUser.id : null
        }]);

        if(!error) { 
            try { await myDB.functions.invoke('line-notify', { body: { name: name,  phone: phone, service: activeCat.name, note: `é‡‘é¡:$${finalPrice} ${couponInfoText ? '(å«å„ªæƒ )' : ''}`  } });} catch (e) {}

            // ğŸ”¥ğŸ”¥ğŸ”¥ é‡é»ä¿®æ”¹åœ¨é€™è£¡ï¼šåŠ ä¸Š '#' å­—è™Ÿï¼
            const shortId = '#' + myBookingId.slice(-6);
            
            const idBox = document.getElementById('success-order-id');
            idBox.innerText = shortId;
            idBox.style.cursor = "pointer";
            idBox.title = "é»æ“Šè¤‡è£½ç·¨è™Ÿ";
            idBox.onclick = function() {
                fallbackCopyText(shortId, () => alert("è¨‚å–®ç·¨è™Ÿå·²è¤‡è£½ï¼"));
            };

            // 2. æº–å‚™æ–‡å­— (é€™è£¡çš„ shortId ç¾åœ¨å·²ç¶“å¸¶æœ‰ # äº†)
            let lineMsgText = "";
            if (payStatus === 'ota') {
                const otaSelect = document.getElementById('ota-source-select');
                const otaName = otaSelect.options[otaSelect.selectedIndex].text;
                const otaCode = document.getElementById('ota-order-id').value.trim();
                lineMsgText = `ä½ å¥½ï¼Œæˆ‘å·²é ç´„ã€”å·²æ–¼ ${otaName} ä»˜æ¬¾ï¼Œå–®è™Ÿï¼š${otaCode}ã€•ã€‚\nåŸ¹ç™’è©¦é©—å®¤è¨‚å–®ç·¨è™Ÿï¼š${shortId}`;
            } else {
                lineMsgText = `ä½ å¥½ï¼Œæˆ‘å·²é ç´„ï¼ˆå°šæœªä»˜æ¬¾ï¼‰ã€‚\nåŸ¹ç™’è©¦é©—å®¤è¨‚å–®ç·¨è™Ÿï¼š${shortId}`;
            }

            // 3. è¨­å®š LINE æŒ‰éˆ•è¡Œç‚º (éš±è—å‡ºå£é‚è¼¯)
            const lineUrl = `https://line.me/R/oaMessage/@927ctmwa/?${encodeURIComponent(lineMsgText)}`;
            const lineBtn = document.getElementById('line-super-btn');
            lineBtn.href = lineUrl; 
            
            // å…ˆéš±è—å‡ºå£
            document.getElementById('success-close-x').style.display = 'none';
            document.getElementById('success-close-text').style.display = 'none';

            lineBtn.onclick = function(e) {
                e.preventDefault(); 
                
                fallbackCopyText(lineMsgText, () => {
                    lineBtn.innerHTML = `<i class="fa-solid fa-check"></i> <b>å·²è¤‡è£½ï¼æ­£åœ¨é–‹å•Ÿ...</b>`;
                    
                    // è§£é–å‡ºå£
                    document.getElementById('success-close-x').style.display = 'block';
                    document.getElementById('success-close-text').style.display = 'block';
                    
                    setTimeout(() => { window.open(lineUrl, '_blank'); }, 500); 
                });
            };

            document.getElementById('sub-btn').disabled = false;
            document.getElementById('sub-btn').innerText = "é€å‡ºé ç´„";
            openModal('success-overlay');

        } else { throw error; }

    } catch (err) { 
        console.error(err);
        alert(err.message || "ç™¼ç”ŸéŒ¯èª¤"); 
        btn.disabled = false; 
        btn.innerText = "é€å‡ºé ç´„"; 
    }
}
// ğŸ”¥ æ–°å¢ï¼šè¬ç”¨è¤‡è£½å‡½å¼ (å°±ç®—ç€è¦½å™¨æ“‹ä¹Ÿèƒ½è¤‡è£½)
function fallbackCopyText(text, callback) {
    // å˜—è©¦ A è¨ˆç•«ï¼šç¾ä»£ API
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text)
            .then(callback)
            .catch(() => tryOldSchoolCopy(text, callback)); // å¤±æ•—å°±ç”¨ B è¨ˆç•«
    } else {
        tryOldSchoolCopy(text, callback); // ç›´æ¥ç”¨ B è¨ˆç•«
    }
}

// B è¨ˆç•«ï¼šå‚³çµ± Textarea è¤‡è£½æ³• (ä¿è­‰é›»è…¦ç‰ˆå¯ç”¨)
function tryOldSchoolCopy(text, callback) {
    try {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        // è—åœ¨çœ‹ä¸åˆ°çš„åœ°æ–¹ï¼Œé¿å…ç•«é¢è·³å‹•
        textArea.style.position = "fixed";
        textArea.style.left = "-9999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        document.execCommand('copy'); // åŸ·è¡Œè¤‡è£½æŒ‡ä»¤
        document.body.removeChild(textArea);
        if(callback) callback();
    } catch (err) {
        console.error("è¤‡è£½å¤±æ•—", err);
        // å°±ç®—çœŸçš„è¤‡è£½å¤±æ•—ï¼Œé‚„æ˜¯è¦åŸ·è¡Œ callback è®“è¦–çª—è·³è½‰ï¼
        if(callback) callback();
    }
}

    function openModal(id) {
        const modal = document.getElementById(id);
        modal.classList.add('active');
        const card = modal.querySelector('.text-modal-card');
        if (card) {
            card.scrollTop = 0;
        }
    }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function toggleOTA() { 
        const statusInput = document.getElementById('pay-status');
        if(!statusInput) return;
        const isOTA = (statusInput.value === 'ota');
        
        // 1. æ§åˆ¶ OTA è¼¸å…¥å€
        document.getElementById('ota-area').style.display = isOTA ? 'block' : 'none'; 
        
        // 2. æ§åˆ¶å„ªæƒ åˆ¸
        const couponBox = document.querySelector('.checkout-footer .coupon-box');
        if (couponBox) couponBox.style.display = isOTA ? 'none' : 'flex';

        // 3. æ§åˆ¶é‡‘é¡æ¨™é¡Œèˆ‡æé†’ (ğŸ”¥ ä¿®æ­£ç‰ˆï¼šåˆ†é–‹è™•ç†)
        const labelText = document.getElementById('label-text');
        const reminderBox = document.getElementById('ota-reminder');

        if (isOTA) {
            // å¦‚æœæ˜¯å¹³å°ï¼šæ¨™é¡Œæ”¹ç‚ºã€Œå¹³å°ç¸½é¡ã€ï¼Œä¸¦é¡¯ç¤ºä¸‹æ–¹ç´…å­—æé†’
            if(labelText) labelText.innerText = "å¹³å°ç¸½é¡ï¼š"; 
            if(reminderBox) reminderBox.style.display = "block";
        } else {
            // å¦‚æœæ˜¯ä¸€èˆ¬ï¼šæ¨™é¡Œæ”¹å›ã€Œæ‡‰ä»˜ç¸½é¡ã€ï¼Œéš±è—ç´…å­—
            if(labelText) labelText.innerText = "æ‡‰ä»˜ç¸½é¡ï¼š";
            if(reminderBox) reminderBox.style.display = "none";
        }
    }

    function toggleFlow() { const isD=document.getElementById('data-flow').value==='data'; document.getElementById('flow-data').style.display=isD?'block':'none'; document.getElementById('flow-upload').style.display=isD?'none':'block'; }
    function toggleSubmitBtn(c) { if(isMemberBlocked) return; document.getElementById('sub-btn').disabled = !c; document.getElementById('sub-btn').innerText = c ? "é€å‡ºé ç´„" : "è«‹åŒæ„è¦ç¯„"; }

    // ğŸ”¥ å…¨åŸŸè®Šæ•¸æ–°å¢ï¼šæ‰å¹³åŒ–æ–‡ç« æ¸…å–®
    let kbArticlesFlat = []; 

    // ğŸ”¥ initKbData ä¿®æ­£ç‰ˆï¼šå»ºç«‹æ‰å¹³æ¸…å–®ä¾›æœå°‹ä½¿ç”¨
    async function initKbData() {
        const { data } = await myDB.from('kb_articles').select('id,title,big_category,mid_category').eq('is_published', true).order('sort_order', { ascending: true });
        
        const { data: cfg } = await myDB.from('site_content').select('content').eq('title', 'kb_category_order').single();
        if (cfg && cfg.content) {
            kbCatOrder = cfg.content; 
        }

        if (data) {
            kbTree = {};
            kbArticlesFlat = data; // ğŸ‘ˆ å­˜èµ·ä¾†ï¼æœå°‹è¦ç”¨ï¼

            data.forEach(i => {
                if (!kbTree[i.big_category]) kbTree[i.big_category] = {};
                if (!kbTree[i.big_category][i.mid_category]) kbTree[i.big_category][i.mid_category] = [];
                kbTree[i.big_category][i.mid_category].push(i);
            });
        }
    }

    function renderKbHome() {
        kbState.level = 0; kbState.big = null; kbState.activeMid = null; kbState.searchQuery = null; 
        const bigCats = Object.keys(kbTree);
        const zodiacPool = Array.from({length: 12}, (_, i) => `https://geyrpowhaqfhnxghpokr.supabase.co/storage/v1/object/public/site-assets/zodiac_${i+1}.png`).sort(() => Math.random() - 0.5);

        const listHtml = bigCats.map((cat, idx) => {
            const myImg = zodiacPool[idx % zodiacPool.length];
            return `<div class="kb-article-card kb-big-cat-card" onclick="enterKb('${cat}')">
                        <div class="kb-card-content">
                            <img src="${myImg}" class="kb-avatar" alt="zodiac">
                            <div class="kb-card-text" style="font-family:'Noto Serif TC',serif; font-weight:900;">${cat}</div>
                        </div>
                        <div class="kb-arrow">â”</div>
                    </div>`;
        }).join('');

        document.getElementById('kb-container').innerHTML = `
            <div class="brand-section-header">
                 <div class="brand-h3-zh">åŸ¹ç™’å¯¶å…¸</div>                    
                 <div class="brand-h2-en">PY JOURNEY</div>
                 <div class="brand-capsule center-fix" style="margin: 15px auto !important;">æ¢ç´¢è‡ªæˆ‘çš„å°å¼•æ‰‹å†Š</div>
            </div>
            <div class="kb-cat-view">
                <div class="kb-inner-header-row">
                    <div></div> <button class="btn-pill-search" onclick="openSearchPanel()">
                        <i class="fa-solid fa-magnifying-glass"></i> æ–‡ç« æœå°‹ç”Ÿæˆå™¨
                    </button>
                </div>
                <div class="kb-list-container">${listHtml}</div>
            </div>`;
        document.getElementById('knowledge').classList.add('kb-reading-mode');
        window.scrollTo(0,0);
    }

    // ğŸ”¥ ä¿®æ”¹ï¼šæ‰“é–‹æœå°‹å½ˆçª— (æ”¯æ´å¸¶å…¥èˆŠè³‡æ–™)
    function openSearchPanel(existingData = null) {
        const area = document.getElementById('modal-search-groups-area');
        const bigCatSelect = document.getElementById('kb-search-big-cat');
        if (!area || !bigCatSelect) return;
        
        bigCatSelect.innerHTML = '<option value="">å…¨åŸŸæœå°‹</option>' + Object.keys(kbTree).map(c => `<option value="${c}">${c}</option>`).join('');

        area.innerHTML = ''; 
        if (existingData && existingData.groups) {
            document.getElementById('kb-search-report-title').value = existingData.reportTitle || '';
            bigCatSelect.value = existingData.filterCat || '';
            existingData.groups.forEach(item => addSearchGroup(item.title, item.keys));
        } else {
            addSearchGroup(); 
        }
        openModal('search-overlay');
    }

    // ğŸ”¥ æ–°åŠŸèƒ½ï¼šå‹•æ…‹æ–°å¢æ¬„ä½ (ç›®æ¨™æ”¹ç‚ºå½ˆçª—å…§çš„å€åŸŸ)
    // âš ï¸ ä¿®æ­£é‡é»ï¼šåªç•™é€™ä¸€å€‹ç‰ˆæœ¬ï¼Œå°æ‡‰ id="modal-search-groups-area"
    function addSearchGroup(title = '', keywords = '') {
        const area = document.getElementById('modal-search-groups-area');
        if (!area) return;

        const div = document.createElement('div');
        div.className = 'kb-search-group';
        div.innerHTML = `
            <input type="text" class="kb-search-title-input" placeholder="æ¨™é¡Œ (å¦‚:å¤©è³¦)" value="${title}">
            <input type="text" class="kb-search-key-input" placeholder="é—œéµå­— (å¦‚:12,38)" value="${keywords}">
            <button class="kb-group-remove-btn" onclick="this.parentElement.remove()" title="åˆªé™¤æ­¤çµ„">âœ•</button>
        `;
        area.appendChild(div);
    }

    // 3. ä¿®æ­£æœå°‹åŸ·è¡Œï¼šæŠ“å–æ¨™é¡Œèˆ‡åˆ†é¡
    function doKbSearch(forceData = null) {
        if (!kbArticlesFlat || kbArticlesFlat.length === 0) return;
        let searchData = { reportTitle: '', filterCat: '', groups: [] };
        if (forceData) { searchData = forceData; } else {
            searchData.reportTitle = document.getElementById('kb-search-report-title').value.trim();
            searchData.filterCat = document.getElementById('kb-search-big-cat').value;
            document.querySelectorAll('#modal-search-groups-area .kb-search-group').forEach(g => {
                const t = g.querySelector('.kb-search-title-input').value.trim();
                const k = g.querySelector('.kb-search-key-input').value.trim();
                if (k) searchData.groups.push({ title: t, keys: k });
            });
        }
        if (searchData.groups.length === 0) return;
        closeModal('search-overlay');
        kbState.level = 3; kbState.searchQuery = searchData;
        const base64Str = safeB64Encode(JSON.stringify(searchData));
        window.history.pushState({ path: window.location.pathname + `?view=knowledge&q=${base64Str}` }, '', window.location.pathname + `?view=knowledge&q=${base64Str}`);
        renderSearchResults(searchData);
    }

    function renderSearchResults(searchData) {
        document.getElementById('knowledge').classList.add('kb-reading-mode');
        let finalHtml = ""; let totalCount = 0;
        const displayTitle = searchData.reportTitle || "æ–‡ç« æœå°‹çµæœ";

        // åœ¨ renderSearchResults å‡½å¼å…§
    searchData.groups.forEach((group) => {
        const keywords = group.keys.split(/[,.ï¼Œ\s]+/).filter(k => k.trim() !== "");
        let pool = kbArticlesFlat;
        
        // å¦‚æœæœ‰é¸å¤§åˆ†é¡ï¼Œå…ˆéæ¿¾å¤§åˆ†é¡
        if (searchData.filterCat) {
            pool = pool.filter(a => a.big_category === searchData.filterCat);
        }

        // ğŸ”¥ ä¿®æ­£å¾Œçš„é‚è¼¯ï¼šç§»é™¤åš´æ ¼æ•¸å­—åŒ¹é…ï¼Œæ”¹å›é€šç”¨åŒ…å«åˆ¤æ–·
        const results = pool.filter(art => keywords.some(k => {
            return art.title.toLowerCase().includes(k.toLowerCase());
        }));
        
        totalCount += results.length;
            const sectionTitle = group.title || `æœå°‹ï¼š${keywords.join('ã€')}`;
            let contentHtml = results.length === 0 ? `<div style="text-align:center; color:#ccc; padding:20px;">(ç„¡ç›¸é—œæ–‡ç« )</div>` : "";
            if (results.length > 0) {
                const grouped = {};
                results.forEach(art => { const mid = art.mid_category || 'å…¶ä»–'; if (!grouped[mid]) grouped[mid] = []; grouped[mid].push(art); });
                Object.keys(grouped).forEach(midCat => {
                    const cards = grouped[midCat].map(a => {
                        const m = a.title.match(/^([0-9\-\.]+)\s+(.*)/);
                        let disp = m ? `<div class="kb-card-num">${m[1]}</div><div class="kb-card-text">${m[2]}</div>` : `<div class="kb-card-num" style="font-size:1rem; opacity:0.3;">âœ¦</div><div class="kb-card-text">${a.title}</div>`;
                        return `<div class="kb-article-card" onclick="readArt('${a.id}')"><div class="kb-card-content">${disp}</div><div class="kb-arrow">â”</div></div>`;
                    }).join('');
                    contentHtml += `<div class="kb-search-mid-group"><div style="text-align:left;"><span class="kb-mid-simple-badge">${midCat}</span></div><div class="kb-list-container">${cards}</div></div>`;
                });
            }
            finalHtml += `<div class="kb-result-section"><div class="kb-result-section-title"><span class="kb-result-section-badge">${sectionTitle}</span></div>${contentHtml}</div>`;
        });

        // å°‹æ‰¾ renderSearchResults å‡½å¼æœ€å¾Œçš„ innerHTML ä½ç½®
    document.getElementById('kb-container').innerHTML = `
        <div class="kb-search-results-wrapper">
            <div class="kb-fab-back" onclick="kbGoBack()"><i class="fa-solid fa-reply"></i></div>
            <div class="brand-section-header">
                <div class="brand-h3-zh">${displayTitle}</div>                    
                <div class="brand-h2-en">SEARCH RESULTS</div>
                <div class="brand-capsule center-fix" style="margin: 15px auto !important;">å…±æœå°‹åˆ° ${totalCount} ç¯‡æ–‡ç« </div>
            </div>
            <div class="kb-cat-view">
                <div class="kb-inner-header-row">
    <div class="kb-action-group">
        <button onclick="kbGoBack()" class="btn-pill-search"><i class="fa-solid fa-arrow-left"></i> è¿”å›</button>
        <button id="kb-share-btn" onclick="copyArtLink()" title="åˆ†äº«æ­¤å ±å‘Š">
            <i class="fa-solid fa-share-nodes"></i>
        </button>
    </div>
    <button class="btn-pill-search" onclick="openSearchPanel(kbState.searchQuery)"><i class="fa-solid fa-magnifying-glass"></i> æœå°‹æ–‡ç« </button>
</div>
                ${finalHtml}
            </div>
        </div>`;
        window.scrollTo(0, 0);
    }
function renderSearchResults(searchData) {
    document.getElementById('knowledge').classList.add('kb-reading-mode');
    let finalHtml = "";
    let totalCount = 0;
    const displayTitle = searchData.reportTitle || "æ–‡ç« æœå°‹çµæœ";

    // searchData ç¾åœ¨æ˜¯ä¸€å€‹ç‰©ä»¶ { reportTitle, filterCat, groups }
    searchData.groups.forEach((group) => {
        const keywords = group.keys.split(/[,.ï¼Œ\s]+/).filter(k => k.trim() !== "");
        
        // 1. å…ˆç¯©é¸å‡ºæ‰€æœ‰ç¬¦åˆçš„æ–‡ç« 
        let pool = kbArticlesFlat;
        
        // ğŸ”¥ å¤§åˆ†é¡ç¯©é¸é‚è¼¯
        if (searchData.filterCat) {
            pool = pool.filter(a => a.big_category === searchData.filterCat);
        }

        const results = pool.filter(art => {
            return keywords.some(k => {
                if (/^\d+$/.test(k)) {
                    // ğŸ”¥ ç²¾ç¢ºæ•¸å­—æ­£å‰‡ï¼šç¢ºä¿ã€Œ1ã€åªæœƒå°åˆ°ã€Œ1ã€æˆ–ã€Œ01ã€ï¼Œä¸æœƒå°åˆ°ã€Œ10ã€æˆ–ã€Œ21ã€
                    const cleanNum = parseInt(k, 10).toString();
                    const regex = new RegExp(`(^|[^0-9])0?${cleanNum}([^0-9]|$)`);
                    return regex.test(art.title);
                } else {
                    return art.title.includes(k);
                }
            });
        });
        
        totalCount += results.length;
        const sectionTitle = group.title || `æœå°‹ï¼š${keywords.join('ã€')}`;
        let contentHtml = "";

        if (results.length === 0) {
            contentHtml = `<div style="text-align:center; color:#ccc; padding:20px;">(æ­¤å€ç„¡ç›¸é—œæ–‡ç« )</div>`;
        } else {
            // 2. ä¾ç…§ã€Œä¸­åˆ†é¡ (mid_category)ã€é€²è¡Œåˆ†çµ„
            const grouped = {};
            results.forEach(art => {
                const mid = art.mid_category || 'å…¶ä»–';
                if (!grouped[mid]) grouped[mid] = [];
                grouped[mid].push(art);
            });

            Object.keys(grouped).forEach(midCat => {
                const articles = grouped[midCat];
                const cards = articles.map(a => {
                    let displayHtml = `<div class="kb-card-text">${a.title}</div>`;
                    const match = a.title.match(/^([0-9\-\.]+)\s+(.*)/);
                    if (match) {
                        displayHtml = `<div class="kb-card-num" style="margin-right:15px;">${match[1]}</div><div class="kb-card-text">${match[2]}</div>`;
                    }
                    return `<div class="kb-article-card" onclick="readArt('${a.id}')"><div class="kb-card-content">${displayHtml}</div><div class="kb-arrow">â”</div></div>`;
                }).join('');

                contentHtml += `<div class="kb-search-mid-group"><div class="kb-search-mid-header">${midCat}</div><div class="kb-list-container">${cards}</div></div>`;
            });
        }

        finalHtml += `<div class="kb-result-section"><div class="kb-result-section-title"><span class="kb-result-section-badge">${sectionTitle}</span></div>${contentHtml}</div>`;
    });

    // 3. æ¸²æŸ“æœ€çµ‚ç•«é¢ (å·¦äºŒå³ä¸€ä½ˆå±€)
    document.getElementById('kb-container').innerHTML = `
        <div class="kb-search-results-wrapper">
            <div class="brand-section-header">
                <div class="brand-h3-zh">${displayTitle}</div>                    
                <div class="brand-h2-en">SEARCH RESULTS</div>
                <div class="brand-capsule center-fix" style="margin: 15px auto !important;">å…±æœå°‹åˆ° ${totalCount} ç¯‡æ–‡ç« </div>
            </div>
            <div class="kb-cat-view">
                <div class="kb-inner-header-row">
                    <div class="kb-action-group">
                        <button onclick="kbGoBack()" class="btn-pill-search"><i class="fa-solid fa-arrow-left"></i> è¿”å›</button>
                        <button id="kb-share-btn" onclick="copyArtLink()" title="åˆ†äº«æ­¤å ±å‘Š"><i class="fa-solid fa-share-nodes"></i></button>
                    </div>
                    <button class="btn-pill-search" onclick="openSearchPanel(kbState.searchQuery)"><i class="fa-solid fa-magnifying-glass"></i> æœå°‹æ–‡ç« </button>
                </div>
                ${finalHtml}
            </div>
        </div>`;
    window.scrollTo(0, 0);
}

    // ğŸ”¥ enterKb ä¿®æ­£ç‰ˆï¼šç§»é™¤è‡ªå‹•å®šä½ï¼Œæ”¹ç‚ºå¼·åˆ¶å›åˆ°æœ€é ‚ç«¯
    function enterKb(big) {
        kbState.level = 1;
        kbState.big = big;
        
        document.getElementById('knowledge').classList.add('kb-reading-mode');
        
        const isHidden = kbCatOrder.hide_note && kbCatOrder.hide_note.includes(big);
        const noteHtml = isHidden ? '' : `
            <div class="kb-tiny-note">
                å¦‚æœå…§å®¹æœ‰èª¤ æ­¡è¿å”åŠ©ä¿®æ­£<br>
                æˆ–æ˜¯æä¾›æˆ‘å…è²»èª²ç¨‹ ğŸ¤­<br>
                å¦‚æœçœ‹äº†è¦ºå¾—ä¸å°ˆæ¥­æˆ–ä¸é–‹å¿ƒ<br>
                è«‹ç›´æ¥é—œé–‰ è¬è¬æ°æ° ğŸ‘‹
            </div>`;

        let sortedMids = [];
        if (kbCatOrder && kbCatOrder.mid && kbCatOrder.mid[big]) {
            sortedMids = kbCatOrder.mid[big].filter(m => kbTree[big] && kbTree[big][m]);
            if(kbTree[big]) { Object.keys(kbTree[big]).forEach(k => { if (!sortedMids.includes(k)) sortedMids.push(k); }); }
        } else if (kbTree[big]) {
            sortedMids = Object.keys(kbTree[big]);
        }

        const contentHtml = sortedMids.map(mid => {
            const arts = kbTree[big][mid]; 
            const articlesHtml = arts.map(a => {
                let displayHtml = "";
                const match = a.title.match(/^([0-9\-\.]+)\s+(.*)/);
                
                if (match) {
                    // æœ‰æ•¸å­—ï¼šé å³é¡¯ç¤ºåœ¨åœè»Šæ ¼è£¡
                    displayHtml = `<div class="kb-card-num">${match[1]}</div><div class="kb-card-text">${match[2]}</div>`;
                } else {
                    // æ²’æœ‰æ•¸å­—ï¼šè£œä¸€å€‹åŒæ¨£ 75px å¯¬çš„ âœ¦ ä½”ä½ï¼Œèµ·è·‘ç·šæ‰æœƒçµ•å°å°é½Š
                    displayHtml = `<div class="kb-card-num" style="font-size:1rem; opacity:0.3;">âœ¦</div><div class="kb-card-text">${a.title}</div>`;
                }
                
                return `
                <div class="kb-article-card" onclick="event.stopPropagation(); readArt('${a.id}')">
                    <div class="kb-card-content">${displayHtml}</div>
                    <div class="kb-arrow">â”</div>
                </div>`;
            }).join('');

            const safeMidId = `mid-group-${mid.replace(/\s+/g, '-')}`;

            return `
            <details id="${safeMidId}" class="kb-section-group" open>
                <summary class="kb-mid-separator"><span class="kb-mid-badge">${mid}</span></summary>
                <div class="kb-list-container">${articlesHtml}</div>
            </details>`;
        }).join('');
        
        document.getElementById('kb-container').innerHTML = `
            <div class="kb-cat-view">
                <div class="kb-fab-back" onclick="kbGoBack()"><i class="fa-solid fa-reply"></i></div>

                <div class="kb-header-actions">
                    <div onclick="kbGoBack()" class="kb-internal-back" style="cursor:pointer;">
                        <i class="fa-solid fa-arrow-left"></i> è¿”å›é¦–é 
                    </div>
                </div>

                <div class="kb-cat-header">
                    <h1 class="kb-cat-title-h1">${big}</h1>
                    ${noteHtml}
                </div>
                ${contentHtml}
            </div>
        `;
        
        // ğŸ”¥ é€™è£¡æ”¹æ‰äº†ï¼
        // ä¸ç®¡æœ‰æ²’æœ‰ activeMidï¼Œå…¨éƒ¨å¼·åˆ¶æ»¾åˆ°æœ€ä¸Šé¢ (0, 0)
        window.scrollTo(0, 0);
    }


    // ğŸ”¥ readArt æœ€çµ‚ç‰ˆï¼šå‹•æ…‹ä¿®æ”¹ç¶²é æ¨™é¡Œ + æ‰‹æ©Ÿç‰ˆå„ªåŒ–
    async function readArt(idOrSlug) {
        const isUUID = idOrSlug.length > 20; 
        let query = myDB.from('kb_articles').select('*');
        if (isUUID) { query = query.eq('id', idOrSlug); } else { query = query.eq('slug', idOrSlug); }

        const { data, error } = await query.single();
        if (error || !data) { console.error(error); alert("æ‰¾ä¸åˆ°æ–‡ç« ï¼"); return; }

        // âœ… é€™è£¡ä¿®æ”¹æ¨™é¡Œï¼
        document.title = `åŸ¹ç™’è©¦é©—å®¤ ${data.title}`;

        // ç‹€æ…‹èˆ‡ç¶²å€è™•ç†
        kbState.activeBig = data.big_category; 
        kbState.activeMid = data.mid_category;
        kbState.level = 2;

        const displayId = data.slug ? data.slug : data.id;
        const newUrl = `${window.location.pathname}?view=knowledge&article=${displayId}`;
        window.history.pushState({ path: newUrl }, '', newUrl);

        document.getElementById('knowledge').classList.add('kb-reading-mode');
        
        const isHidden = kbCatOrder.hide_note && kbCatOrder.hide_note.includes(data.big_category);
        const noteHtml = isHidden ? '' : `
            <div class="kb-tiny-note">
                å¦‚æœå…§å®¹æœ‰èª¤ æ­¡è¿å”åŠ©ä¿®æ­£<br>
                æˆ–æ˜¯æä¾›æˆ‘å…è²»èª²ç¨‹ ğŸ¤­<br>
                å¦‚æœçœ‹äº†è¦ºå¾—ä¸å°ˆæ¥­æˆ–ä¸é–‹å¿ƒ<br>
                è«‹ç›´æ¥é—œé–‰ è¬è¬æ°æ° ğŸ‘‹
            </div>`;
        
        document.getElementById('kb-container').innerHTML = `
            <div class="kb-article-view" style="position: relative;">
                <div class="kb-fab-back" onclick="kbGoBack()"><i class="fa-solid fa-reply"></i></div>

            <div class="kb-header-actions">
    <div onclick="kbGoBack()" class="kb-internal-back" style="cursor:pointer;">
        <i class="fa-solid fa-arrow-left"></i> è¿”å›
    </div>
    <button id="kb-share-btn" onclick="copyArtLink()" title="è¤‡è£½æ–‡ç« é€£çµ">
        <i class="fa-solid fa-share-nodes"></i>
    </button>
</div>
                ${noteHtml}

                <h1 class="kb-article-title-h1" style="margin-top: 10px;">${data.title}</h1>
                
                <div class="kb-meta-row">
                    <span class="kb-tag kb-tag-big">${data.big_category}</span>
                    <span class="kb-divider">â—</span>
                    <span class="kb-tag kb-tag-mid">${data.mid_category}</span>
                </div>
                
                <div class="ql-editor">${data.body}</div>
            </div>`;
            
        window.scrollTo(0, 0);
    }

    // ğŸ”¥ æœ€çµ‚ä¿®å¾©ï¼šæ‰‹æ©Ÿç‰ˆæ“ä½œçµæŸå¾Œç›´æ¥é›¢é–‹ï¼Œçµ•ä¸åŸ·è¡Œé›»è…¦ç‰ˆé‚è¼¯
   async function copyArtLink() {
        // 1. æŠ“å–æ¨™é¡Œï¼šå…ˆæŠ“æ–‡ç« æ¨™é¡Œï¼ŒæŠ“ä¸åˆ°å°±æŠ“æœå°‹å ±å‘Šæ¨™é¡Œ
        const articleTitle = document.querySelector('.kb-article-title-h1');
        const searchTitle = document.querySelector('.brand-h3-zh');
        const currentTitle = articleTitle ? articleTitle.innerText : (searchTitle ? searchTitle.innerText : 'åŸ¹ç™’å¯¶å…¸');

        const shareData = {
            title: `åŸ¹ç™’è©¦é©—å®¤ - ${currentTitle}`,
            text: `åŸ¹ç™’è©¦é©—å®¤ - ${currentTitle}`,
            url: window.location.href 
        };

        // 2. å„ªå…ˆåŸ·è¡Œæ‰‹æ©ŸåŸç”Ÿåˆ†äº«
        if (navigator.share) {
            try { await navigator.share(shareData); return; } catch (err) { return; }
        }

        // 3. é›»è…¦ç‰ˆï¼šè¤‡è£½ç¶²å€ä¸¦é¡¯ç¤ºå›é¥‹
        try {
            await navigator.clipboard.writeText(shareData.url);
            const btn = document.getElementById('kb-share-btn');
            const icon = btn.querySelector('i');
            const originalIcon = icon.className;
            
            icon.className = 'fa-solid fa-check';
            btn.style.background = '#27ae60';
            
            setTimeout(() => {
                icon.className = originalIcon;
                btn.style.background = '';
            }, 1500);
        } catch (err) { alert("ç¶²å€å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼"); }
    }


    // ğŸ”¥ kbGoBack æœ€çµ‚ä¿®æ­£ç‰ˆï¼šæ”¯æ´å¾æ–‡ç« è¿”å›ã€Œå¤šçµ„æœå°‹çµæœã€
    function kbGoBack() {
        // 1. æ”¹å›åŸæ¨™é¡Œ
        document.title = "åŸ¹ç™’è©¦é©—å®¤";
        
        // 2. é€€å‡ºé–±è®€æ¨¡å¼æ¨£å¼ (è®“æ¨™é¡Œè·‘å‡ºä¾†ï¼Œå¦‚æœæ˜¯å›é¦–é çš„è©±)
        document.getElementById('knowledge').classList.remove('kb-reading-mode');
        
        // 3. åˆ¤æ–·ç•¶å‰ç‹€æ…‹
        if (kbState.level === 2) { 
            // === ç›®å‰åœ¨çœ‹æ–‡ç«  (Level 2) ===
            
            // A. å¦‚æœä¹‹å‰æ˜¯é€éã€Œæœå°‹ã€é€²ä¾†çš„ (ä¸ç®¡æ˜¯å–®çµ„é‚„æ˜¯å¤šçµ„)
            if (kbState.searchQuery) {
                // ç›´æ¥æŠŠå­˜èµ·ä¾†çš„æœå°‹è¨­å®š (searchQuery) ä¸Ÿå›å»é‡æ–°åŸ·è¡Œ
                // é€™æ¨£ç•«é¢å°±æœƒè®Šå›å‰›å‰›é‚£å¼µæ¼‚äº®çš„ã€Œå®¢è£½åŒ–å ±å‘Šè¡¨ã€
                doKbSearch(kbState.searchQuery);
            }
            // B. æ­£å¸¸åˆ†é¡ç€è¦½ -> å›åˆ°è©²å¤§åˆ†é¡ç›®éŒ„
            else if (kbState.activeBig) {
                const cleanUrl = window.location.pathname + "?view=knowledge";
                window.history.pushState({ path: cleanUrl }, '', cleanUrl);
                enterKb(kbState.activeBig);
            } 
            // C. ä¾‹å¤–ç‹€æ³ -> å›é¦–é 
            else {
                renderKbHome();
            }
        } 
        else {
            // === å…¶ä»–æƒ…æ³ (Level 3 æœå°‹çµæœé  æˆ– Level 1 ç›®éŒ„é ) ===
            // æŒ‰è¿”å› -> å…¨éƒ¨å›å¯¶å…¸é¦–é 
            const cleanUrl = window.location.pathname + "?view=knowledge";
            window.history.pushState({ path: cleanUrl }, '', cleanUrl);
            renderKbHome();
        }
    }

    async function initDrawData() { const { data } = await myDB.from('card_pool').select('*'); allCards = data || []; renderDrawTable(); }
    
    function renderDrawTable() { 
        const table = document.getElementById('draw-area'); 
        if (!table) return; 
        table.innerHTML = ''; 
        
        const deck = allCards.length > 0 ? [...allCards] : Array.from({length: 64}, (_, i) => ({ gate_id: i + 1 })); 
        const shuffled = deck.sort(() => Math.random() - 0.5); 
        const isDesktop = window.matchMedia('(hover: hover)').matches;

        let isInputLocked = true;
        setTimeout(() => { isInputLocked = false; }, 800);

        shuffled.forEach((card, index) => { 
            const el = document.createElement('div'); 
            el.className = 'card-back'; 
            el.style.animation = `cardShuffleIn 0.5s ease-out ${index * 0.015}s forwards`; 
            
            el.onclick = function() { 
                if (isInputLocked) return;

                if (isDesktop || el.classList.contains('is-selected')) {
                    el.classList.remove('is-selected');
                    el.classList.add('is-drawing'); 
                    isInputLocked = true; 
                    setTimeout(() => { drawCard(card); }, 600); 
                } else {
                    const allActive = document.querySelectorAll('.card-back.is-selected');
                    allActive.forEach(c => c.classList.remove('is-selected'));
                    el.classList.add('is-selected');
                }
            }; 
            
            table.appendChild(el); 
        }); 
    }

    function closeSuccessModal() {
        closeModal('success-overlay');
        showSection('home');
        window.scrollTo(0, 0);
    }

    async function drawCard(card) { document.getElementById('p-gate').innerText = `GATE ${card.gate_id}`; document.getElementById('p-info').innerText = `${card.gate_name || ''} / ${card.gate_keyword || ''}`; document.getElementById('p-zodiac').innerText = card.zodiac || ''; document.getElementById('p-quote').innerText = card.quote || ''; if (card.image_url) { document.getElementById('p-bg').src = card.image_url + `?t=${new Date().getTime()}`; } const style = card.style_config || defaultStyle; applyStyle('gate', style.gate || defaultStyle.gate); applyStyle('info', style.info || defaultStyle.info); applyStyle('zodiac', style.zodiac || defaultStyle.zodiac); applyStyle('quote', style.quote || defaultStyle.quote); document.getElementById('overlay').classList.add('active'); }
    function applyStyle(id, s) { const el = document.getElementById(`p-${id}`); const def = defaultStyle[id]; const val = (prop) => (s && s[prop] !== undefined) ? s[prop] : def[prop]; el.style.left = val('x') + '%'; el.style.top = val('y') + '%'; el.style.fontSize = val('size') + 'px'; el.style.fontFamily = val('font'); el.style.color = val('color'); const str = val('stroke'); el.style.textShadow = (str && str !== 'transparent') ? `1px 1px 0 ${str}, -1px -1px 0 ${str}, 1px -1px 0 ${str}, -1px 1px 0 ${str}` : 'none'; if(id === 'quote' || id === 'info') el.style.width = val('w') + 'px'; if(id === 'quote') { el.style.lineHeight = val('lh'); el.style.letterSpacing = val('ls') + 'px'; } if(id === 'zodiac') el.style.display = document.getElementById('p-zodiac').innerText ? 'block' : 'none'; }
    function closeResult() { document.getElementById('overlay').classList.remove('active'); setTimeout(() => { renderDrawTable(); document.getElementById('p-bg').src = ""; }, 500); }
    
    async function loadSiteAssets() { 
        const { data } = await myDB.from('site_content').select('*').eq('category', 'site_asset'); 
        
        if (data) { 
            data.forEach(item => { 
                const img = new Image();
                img.src = item.image_url;
                
                img.onload = () => {
                    if (item.title === 'logo') {
                        const el = document.getElementById('site-logo');
                        if(el.src !== item.image_url) el.src = item.image_url;
                    }
                    if (item.title === 'logohuman') {
                        const el = document.getElementById('site-hero');
                        if(el.src !== item.image_url) el.src = item.image_url;
                    }
                    if (item.title === 'my_hd_chart') {
                        const chartEl = document.getElementById('hd-chart-img');
                        if(chartEl) chartEl.src = item.image_url;
                    }
                };
            }); 
        } 
    }
    async function doLogin() { 
        const phone = document.getElementById('l-phone').value.trim(); 
        const pass = document.getElementById('l-pass').value.trim(); 
        if(!phone || !pass) return alert("è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼"); 
        
        try { 
            const { data: user, error: userErr } = await myDB.from('profiles').select('*').eq('phone', phone).eq('password', pass).single(); 
            if (userErr || !user) throw new Error("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤"); 
            
            const { data: bookings } = await myDB.from('bookings').select('*').eq('user_id', user.id); 
            const { data: reports } = await myDB.from('reports').select('*').eq('user_id', user.id); 
            
            user.bookings = bookings || []; 
            user.reports = reports || []; 
            currentUser = user; 
            isMemberBlocked = false; 

            sessionStorage.setItem('peiyu_session', JSON.stringify({ phone: phone, pass: pass }));
            
            document.getElementById('login-box').style.display = 'none'; 
            document.getElementById('dash').style.display = 'block'; 
            
            renderDashboard(currentUser); 
        } catch (err) { 
            console.error(err); 
            alert("ç™»å…¥å¤±æ•—ï¼š" + err.message); 
        } 
    }

   function renderDashboard(user) {
        document.getElementById('dash-welcome').innerText = `ğŸŒ¿ æ­¡è¿å›ä¾†ï¼Œ${user.full_name}`;
        
        // æŒ‰æ™‚é–“å€’åºæ’åˆ—
        const allBookings = user.bookings.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        let historyHtml = "<div style='color:#999; text-align:center; padding:40px;'>ğŸƒ ç›®å‰å°šç„¡é ç´„ç´€éŒ„ï¼ŒæœŸå¾…æ‚¨çš„å…‰è‡¨</div>";

        if (allBookings.length > 0) {
            historyHtml = allBookings.map(b => {
                const dateStr = new Date(b.created_at).toLocaleDateString();
                const title = b.service_item || 'æœå‹™é ç´„';
                
                // ç‹€æ…‹å°æ‡‰æ¨£å¼èˆ‡æ–‡å­—
                let statusClass = `status-${b.status}`;
                let statusText = "è™•ç†ä¸­";
                let statusBadgeClass = "sb-pending";

                if (b.status === 'pending') { statusText = "ç­‰å¾…ä»˜æ¬¾"; statusBadgeClass = "sb-pending"; }
                else if (b.status === 'paid' || b.status === 'awaiting_service') { statusText = "å·²é ç´„ / æœå‹™ä¸­"; statusBadgeClass = "sb-paid"; }
                else if (b.status === 'completed') { statusText = "âœ¨ æ—…ç¨‹å®Œæˆ"; statusBadgeClass = "sb-completed"; }

                // è™•ç†æœå‹™ç´°ç¯€é¡¯ç¤º
                const rawDetail = b.service_detail || "";
                // éæ¿¾æ‰åƒ¹æ ¼å­—ä¸²ï¼Œåªç•™é …ç›®åç¨±
                const details = rawDetail.split('|')
                    .map(s => s.replace(/\(\$\d+\)/g, '').trim())
                    .join(' âœ¦ ');

                // æª¢æŸ¥æ˜¯å¦æœ‰å ±å‘Š
                const reportMatch = (b.wish_detail || "").match(/\[å ±å‘Šå·²ç”Ÿæˆ ID:(.*?)\]/);
                const currentReportId = reportMatch ? reportMatch[1] : null;

                // åº•éƒ¨æŒ‰éˆ•å€é‚è¼¯
                let actionBtn = "";
                if (currentReportId) {
                    // è‡ªå‹•åˆ¤æ–·å°æ‡‰çš„å ±å‘Šç¯„æœ¬ (é è¨­ç‚º srt_report.html)
                    const matchedCat = cats.find(c => b.service_item === c.name);
                    const specificSvc = items.find(s => s.category_id === matchedCat?.id && b.service_detail.includes(s.title) && s.is_main);
                    const templateFile = (specificSvc && specificSvc.report_template) ? specificSvc.report_template : "srt_report.html";
                    
                    // é€™è£¡åŠ ä¸Š mode=view è®“å®¢äººç›´æ¥çœ‹åœ–
                    let targetUrl = `${templateFile}?id=${currentReportId}&mode=view`;
                    
                    actionBtn = `
                        <button class="btn-view-report" onclick="window.open('${targetUrl}')">
                            <i class="fa-solid fa-scroll"></i> æŸ¥çœ‹èƒ½é‡å ±å‘Š
                        </button>`;
                } else if (b.status === 'pending') {
                    actionBtn = `<span style="font-size:0.85rem; color:#e67e22; font-weight:bold;">è«‹è¯ç¹«å®˜æ–¹ LINE ç¢ºèªä»˜æ¬¾</span>`;
                } else if (b.scheduled_at) {
                    const t = new Date(b.scheduled_at);
                    const timeStr = `${t.getMonth() + 1}/${t.getDate()} ${t.getHours().toString().padStart(2, '0')}:${t.getMinutes().toString().padStart(2, '0')}`;
                    actionBtn = `<span style="font-size:0.85rem; color:#8e44ad; font-weight:bold;"><i class="fa-regular fa-clock"></i> é ç´„æ™‚é–“ï¼š${timeStr}</span>`;
                }

                // åƒ¹æ ¼é¡¯ç¤º (è‹¥æœ‰å„ªæƒ åˆ¸å‰‡æ¨™ç¤º)
                let priceDisplay = `$${b.price}`;
                if (b.coupon_info) {
                    priceDisplay += ` <small style="color:#e91e63; font-size:0.7rem;">(å«å„ªæƒ )</small>`;
                }

                return `
                <div class="history-card ${statusClass}">
                    <div class="history-header">
                        <span class="history-date">${dateStr}</span>
                        <span class="history-id">#${b.booking_id.slice(-6)}</span>
                    </div>
                    
                    <div class="history-title">${title}</div>
                    <div class="history-sub">${details}</div>
                    
                    <div style="margin-bottom:10px;">
                        <span class="status-badge ${statusBadgeClass}">${statusText}</span>
                    </div>

                    <div class="history-footer">
                        <div class="history-price">${priceDisplay}</div>
                        <div>${actionBtn}</div>
                    </div>
                </div>`;
            }).join('');
        }

        document.getElementById('dash-history').innerHTML = historyHtml;
        
        // å¡«å…¥å€‹è³‡æ¬„ä½
        document.getElementById('c-name').value = user.full_name;
        document.getElementById('c-phone').value = user.phone;
        document.getElementById('c-email').value = user.email || "";
        document.getElementById('c-phone').disabled = true;
        
        // UI ç‹€æ…‹å¾®èª¿
        document.getElementById('c-name').style.backgroundColor = "#e8f5e9";
        const statusEl = document.getElementById('phone-status');
        if (statusEl) statusEl.innerHTML = "";
    }

    function doLogout() { 
        currentUser = null; 
        sessionStorage.removeItem('peiyu_session'); 
        document.getElementById('login-box').style.display = 'block'; 
        document.getElementById('dash').style.display = 'none'; 
        document.getElementById('c-name').value = ""; 
        document.getElementById('c-phone').value = ""; 
        document.getElementById('c-email').value = ""; 
        document.getElementById('c-phone').disabled = false; 
        document.getElementById('c-name').style.backgroundColor = ""; 
        alert("å·²æˆåŠŸç™»å‡º"); 
    }

    function openEditProfile() { 
        if(!currentUser) return; 
        document.getElementById('ep-phone').value = currentUser.phone; 
        document.getElementById('ep-name').value = currentUser.full_name; 
        document.getElementById('ep-email').value = currentUser.email || ""; 
        document.getElementById('ep-pass').value = ""; 
        openModal('edit-profile-overlay'); 
    }

    async function saveProfile() { 
        if(!currentUser) return; 
        const newName = document.getElementById('ep-name').value; 
        const newEmail = document.getElementById('ep-email').value; 
        const newPass = document.getElementById('ep-pass').value; 
        
        const updateData = { full_name: newName, email: newEmail }; 
        if(newPass) updateData.password = newPass; 
        
        const { error } = await myDB.from('profiles').update(updateData).eq('id', currentUser.id); 
        
        if(error) { 
            alert("æ›´æ–°å¤±æ•—: " + error.message); 
        } else { 
            alert("âœ… è³‡æ–™å·²æ›´æ–°ï¼"); 
            currentUser.full_name = newName; 
            currentUser.email = newEmail; 
            document.getElementById('dash-welcome').innerText = `æ‚¨å¥½ï¼Œ${newName}`; 
            document.getElementById('c-name').value = newName; 
            document.getElementById('c-email').value = newEmail; 
            closeModal('edit-profile-overlay'); 
        } 
    }

    async function loadHeroAnnouncements() {
        const mustContainer = document.getElementById('must-read-container');
        const mustWrapper = document.getElementById('must-read-wrapper');
        const tempContainer = document.getElementById('temp-container');
        const tempWrapper = document.getElementById('temp-wrapper');
        
        try {
            const { data, error } = await myDB.from('announcements')
                .select('title, content, type')
                .eq('is_active', true)
                .order('sort_order', { ascending: true });

            if (error) throw error;

            if (data && data.length > 0) {
                mustContainer.innerHTML = '';
                tempContainer.innerHTML = '';
                let hasMust = false;
                let hasTemp = false;

                data.forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = 'btn-primary';
                    btn.innerHTML = item.title;
                    btn.style.padding = "8px 20px";
                    btn.style.fontSize = "0.95rem";
                    btn.style.minWidth = "auto";
                    btn.style.boxShadow = "0 4px 10px rgba(0,0,0,0.1)";
                    btn.onclick = () => openDynamicAnnouncement(item.title, item.content);

                    if (item.type === 'temp') {
                        btn.style.border = "1px solid #e67e22";
                        btn.style.color = "#d35400";
                        tempContainer.appendChild(btn);
                        hasTemp = true; 
                    } else {
                        mustContainer.appendChild(btn);
                        hasMust = true; 
                    }
                });

                mustWrapper.style.display = hasMust ? 'block' : 'none';
                tempWrapper.style.display = hasTemp ? 'block' : 'none';

            } else {
                mustWrapper.style.display = 'none';
                tempWrapper.style.display = 'none';
            }
        } catch (e) {
            console.error("å…¬å‘Šè¼‰å…¥å¤±æ•—:", e);
        }
    }

    function openDynamicAnnouncement(title, contentHtml) {
        document.getElementById('dyn-modal-title').innerText = title; 
        document.getElementById('dyn-modal-content').innerHTML = contentHtml || "ç„¡å…§å®¹";
        openModal('dynamic-overlay');
    }
    // === å›åˆ°é ‚éƒ¨æŒ‰éˆ•é‚è¼¯ ===
    
    // ç›£è½æ²å‹•äº‹ä»¶
    // === é›™æŒ‰éˆ•æ»‘å‹•ç›£è½é‚è¼¯ ===
    window.onscroll = function() {
        const scrollTop = document.body.scrollTop || document.documentElement.scrollTop;
        const isScrolled = scrollTop > 300; // æ»‘å‹•è¶…é 300px

        // 1. æ§åˆ¶ã€Œå›åˆ°æœ€ä¸Šã€æŒ‰éˆ• (å…¨ç«™é€šç”¨)
        const topBtn = document.getElementById('back-to-top');
        if (topBtn) {
            if (isScrolled) topBtn.classList.add('show');
            else topBtn.classList.remove('show');
        }

        // 2. æ§åˆ¶ã€Œå›ä¸Šä¸€é ã€æŒ‰éˆ• (åªåœ¨åŸ¹ç™’å¯¶å…¸å‡ºç¾)
        // å› ç‚ºé€™æŒ‰éˆ•æ˜¯å‹•æ…‹ç”Ÿæˆçš„ï¼Œæ‰€ä»¥ç”¨ querySelector æŠ“
        const backBtn = document.querySelector('.kb-fab-back');
        const knowledgeSection = document.getElementById('knowledge');
        
        // æª¢æŸ¥ï¼š(1)æŒ‰éˆ•å­˜åœ¨ (2)ç›®å‰åœ¨åŸ¹ç™’å¯¶å…¸åˆ†é  (3)æœ‰æ»‘å‹•
        if (backBtn && knowledgeSection.classList.contains('active')) {
            if (isScrolled) {
                backBtn.classList.add('show');
            } else {
                backBtn.classList.remove('show');
            }
        }
    };
    

    // é»æ“Šå›åˆ°é ‚éƒ¨
    function scrollToTop() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth' // å¹³æ»‘æ²å‹•
        });
    }
    // ğŸ”¥ è¬ç”¨ Base64 ç·¨ç¢¼å™¨ (è§£æ±ºä¸­æ–‡/ç¬¦è™Ÿäº‚ç¢¼å•é¡Œ)
    function safeB64Encode(str) {
        return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
            function toSolidBytes(match, p1) {
                return String.fromCharCode('0x' + p1);
        }));
    }

    // ğŸ”¥ è¬ç”¨ Base64 è§£ç¢¼å™¨
    function safeB64Decode(str) {
        // 1. å…ˆæŠŠ URL å¯èƒ½ç”¢ç”Ÿçš„ç©ºç™½æ›å› + è™Ÿ (é¿å…è¤‡è£½ç¶²å€æ™‚æ ¼å¼è·‘æ‰)
        str = str.replace(/ /g, '+');
        return decodeURIComponent(atob(str).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
    }
</script>
<button id="back-to-top" onclick="scrollToTop()">
    <i class="fa-solid fa-arrow-up"></i>
</button>
</body>
</html>
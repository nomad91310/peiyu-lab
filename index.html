<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸ¹ç™’è©¦é©—å®¤ | èƒ½é‡èˆ‡äººé¡åœ–å°å¼•</title>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Ma+Shan+Zheng&family=Noto+Serif+TC:wght@500;700;900&family=Shippori+Mincho:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* ================= V34 ç¾æ„Ÿæ ¸å¿ƒ ================= */
        :root { 
            --forest: #1a2f23; --forest-light: #2a4032;
            --cream: #f9f7f2; --white: #ffffff;
            --accent: #c6a87c; --accent-hover: #b09060;
            --text-main: #2c3e50; --text-light: #666;
            --shopee: #ff5722; --error: #d32f2f; --success: #2e7d32;
            --shadow-soft: 0 10px 30px rgba(26, 47, 35, 0.08);
            --shadow-hover: 0 15px 40px rgba(26, 47, 35, 0.15);
        }
        
        * { box-sizing: border-box; }
        
        body { 
            font-family: -apple-system, "Microsoft JhengHei", "Helvetica Neue", sans-serif; 
            background-color: var(--cream); margin: 0; 
            color: var(--text-main); line-height: 1.7; letter-spacing: 0.02em;
        }

        h1, h2, h3, h4, .serif-font { font-family: 'Noto Serif TC', serif; }
        
        /* === å°èˆªåˆ— === */
        nav { 
            background: var(--forest); padding: 0 40px; 
            display: flex; justify-content: space-between; align-items: center; 
            height: 80px; position: sticky; top: 0; z-index: 1000; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.25); border-bottom: 3px solid var(--accent);
        }
        .logo-area { display: flex; align-items: center; cursor: pointer; height: 100%; }
        .logo-img { max-height: 60px; width: auto; transition: transform 0.3s; } 
        .logo-img:hover { transform: scale(1.05); }

        .nav-links { display: flex; gap: 20px; }
        .nav-links button { 
            background: none; border: none; padding: 8px 0; cursor: pointer; 
            font-size: 16px; color: rgba(255,255,255,0.7); transition: 0.3s; 
            font-family: 'Noto Serif TC', serif; letter-spacing: 1px; position: relative;
        }
        .nav-links button::after {
            content: ''; position: absolute; width: 0; height: 2px; bottom: 0; left: 0;
            background-color: var(--accent); transition: width 0.3s;
        }
        .nav-links button:hover { color: var(--accent); }
        .nav-links button:hover::after { width: 100%; }
        .nav-links button.active { color: var(--white); font-weight: bold; }
        .nav-links button.active::after { width: 100%; background-color: var(--white); }

        /* === å…§å®¹å®¹å™¨èˆ‡å‹•ç•« === */
        .section { 
            display: none; padding: 40px 20px 100px 20px; 
            max-width: 1100px; margin: 0 auto; min-height: calc(100vh - 80px); 
            animation: fadeSlideUp 0.6s ease-out; 
        }
        .section.active { display: block; }
        @keyframes fadeSlideUp { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* === Hero å€å¡Š === */
        .hero-section { 
            display: flex; align-items: center; justify-content: center; 
            gap: 60px; padding: 40px 0 60px 0; 
            border-bottom: 1px solid rgba(26, 47, 35, 0.1); margin-bottom: 40px; 
        }
        .hero-text { flex: 1; max-width: 550px; text-align: left; }
        .hero-text h1 { 
            font-size: 3.5rem; color: var(--forest); margin: 0 0 10px 0; 
            line-height: 1.1; text-shadow: 2px 2px 0px rgba(198, 168, 124, 0.2);
        }
        .hero-text h2 { 
            font-size: 1.4rem; color: var(--text-light); margin: 0 0 30px 0; 
            font-weight: normal; letter-spacing: 0.1em; 
        }
        .hero-img { flex: 0 0 400px; text-align: center; position: relative; }
        .hero-img img { 
            width: 100%; max-width: 350px; border-radius: 20px; 
            box-shadow: 20px 20px 0px var(--accent); transition: transform 0.5s ease;
        }
        .hero-img img:hover { transform: translateY(-10px); }

        /* === ç‰¹è‰²å¡ç‰‡ === */
        .features-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; padding: 20px 0; }
        .feature-card { 
            background: var(--white); padding: 40px 30px; border-radius: 16px; 
            box-shadow: var(--shadow-soft); text-align: center; cursor: pointer; 
            border: 1px solid transparent; transition: all 0.3s ease; 
            position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: space-between;
        }
        .feature-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px; 
            background: var(--forest); transform: scaleX(0); transform-origin: left; transition: transform 0.3s;
        }
        .feature-card:hover { transform: translateY(-8px); box-shadow: var(--shadow-hover); border-color: var(--accent); }
        .feature-card:hover::before { transform: scaleX(1); }
        .feature-icon { font-size: 3.5rem; margin-bottom: 20px; }
        .feature-title { font-size: 1.6rem; color: var(--forest); margin-bottom: 15px; }
        .feature-desc { color: var(--text-light); font-size: 1.05rem; }

        /* === é€šç”¨å¡ç‰‡å®¹å™¨ === */
        .card { 
            background: var(--white); padding: 40px; border-radius: 20px; 
            box-shadow: var(--shadow-soft); border: 1px solid #eee; 
            margin-bottom: 30px; position: relative;
        }
        .card h2, .card h3 { 
            color: var(--forest); margin-top: 0; 
            border-left: 5px solid var(--accent); padding-left: 15px;
        }

        /* === è¡¨å–®å…ƒä»¶ === */
        .form-group { margin-bottom: 25px; }
        label { display: block; font-weight: bold; margin-bottom: 10px; color: var(--forest); font-size: 1.05rem; }
        label.required::after { content: " *"; color: var(--error); }
        
        input:not([type="checkbox"]):not([type="radio"]), select, textarea { 
            width: 100%; padding: 14px 18px; border: 1px solid #ddd; border-radius: 10px; 
            font-size: 16px; outline: none; transition: 0.3s; background: #fafafa;
        }
        input:focus, select:focus, textarea:focus { 
            border-color: var(--accent); background: var(--white); 
            box-shadow: 0 0 0 3px rgba(198, 168, 124, 0.2); 
        }
        input:disabled { background: #eee; cursor: not-allowed; color: #999; }

        /* === æŒ‰éˆ• === */
        .btn-primary { 
            padding: 16px 45px; background: linear-gradient(135deg, var(--forest) 0%, #2a4032 100%); 
            color: var(--white); border: none; border-radius: 50px; 
            font-size: 1.1rem; cursor: pointer; font-weight: bold; 
            box-shadow: 0 5px 15px rgba(26, 47, 35, 0.3); transition: all 0.3s ease; 
            display: inline-block; letter-spacing: 1px;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(26, 47, 35, 0.4); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }

        .btn-secondary { 
            padding: 10px 25px; background: transparent; color: var(--forest); 
            border: 2px solid var(--forest); border-radius: 50px; 
            font-size: 1rem; font-weight: bold; cursor: pointer; 
            transition: 0.3s; margin-right: 10px;
        }
        .btn-secondary:hover { background: var(--forest); color: var(--white); }

        /* === æœå‹™åˆ—è¡¨ & åŠ è³¼ === */
        .cat-card {
            border: 1px solid #eee; padding: 25px; border-radius: 12px; margin-bottom: 15px; cursor: pointer; background: var(--white); transition: 0.3s;
            display: flex; align-items: center; justify-content: space-between;
        }
        .cat-card:hover { border-color: var(--accent); background: #fdfcf9; transform: translateX(5px); }
        .cat-card h3 { margin: 0; border: none; padding: 0; font-size: 1.3rem; }

        .service-card { 
            background: #fafbfc; border: 1px solid #eee; padding: 20px; 
            border-radius: 12px; margin-bottom: 15px; transition: 0.2s; 
        }
        .service-card:hover { border-color: var(--accent); background: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.03); }
        .service-card.disabled-card { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        
        .service-header { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .service-info { display: flex; align-items: center; gap: 15px; font-weight: bold; font-size: 1.1rem; cursor: pointer; flex: 1; }
        .service-info input { width: 22px; height: 22px; cursor: pointer; accent-color: var(--forest); }
        .price-badge { background: var(--forest); color: var(--white); padding: 5px 12px; border-radius: 6px; font-size: 14px; font-weight: normal; }
        .service-desc { font-size: 1rem; color: #777; margin-left: 38px; padding-top: 8px; line-height: 1.5; }
        
        .sub-check-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; 
            margin-top: 15px; padding: 15px; background: #f0f4f1; border-radius: 10px; 
        }
        .sub-opt-label { font-size: 14px; display: flex; align-items: center; gap: 8px; cursor: pointer; color: var(--forest); }
        .sub-opt-label input { width: 18px; height: 18px; margin: 0; }

        .total-box { 
            text-align: right; font-size: 1.8rem; font-weight: bold; color: #d35400; 
            border-top: 2px dashed #eee; padding-top: 25px; margin-top: 30px; font-family: 'Cinzel', serif; 
        }

        /* === å„ªæƒ åˆ¸ === */
        .coupon-box { 
            background: #fdfbf5; padding: 20px; border-radius: 10px; border: 1px dashed var(--accent); 
            margin-top: 25px; display: flex; gap: 15px; align-items: center; 
        }
        .coupon-msg { font-size: 14px; font-weight: bold; margin-top: 8px; }
        .coupon-msg.success { color: var(--success); }
        .coupon-msg.error { color: var(--error); }

        /* === å½ˆçª— (Modals) === */
        .result-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(26, 47, 35, 0.9); 
            display: none; justify-content: center; align-items: center; 
            z-index: 2000; backdrop-filter: blur(8px); 
            opacity: 0; transition: opacity 0.4s; 
        }
        .result-overlay.active { display: flex; opacity: 1; }

        .text-modal-card { 
            position: relative; width: 90%; max-width: 650px; max-height: 85vh; 
            background: #fff; border-radius: 4px; overflow-y: auto; padding: 50px 40px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.5); 
            transform: scale(0.95); opacity: 0; transition: all 0.4s ease;
        }
        .result-overlay.active .text-modal-card { transform: scale(1); opacity: 1; }
        
        .text-modal-card h3 { 
            text-align: center; color: var(--forest); margin-top: 10px; margin-bottom: 25px; 
            font-size: 2rem; border: none; padding: 0;
            background: linear-gradient(to right, transparent, rgba(198, 168, 124, 0.2), transparent);
            padding: 10px 0;
        }

        .close-modal-btn { 
            display: block; width: 100%; max-width: 250px; margin: 40px auto 0 auto; 
            padding: 14px 0; background: var(--text-main); color: white; 
            border: none; border-radius: 50px; font-weight: bold; 
            cursor: pointer; font-size: 1rem; transition: 0.2s; 
        }
        .close-modal-btn:hover { background: var(--error); }

        /* === åŸ¹ç™’å¯¶å…¸ (çŸ¥è­˜åº«) === */
        .kb-card { 
            border-left: 6px solid var(--accent); padding: 30px; 
            transition: 0.3s; background: var(--white); border-radius: 12px; box-shadow: var(--shadow-soft); cursor: pointer;
        }
        .kb-card:hover { transform: translateY(-5px) scale(1.02); background: #fffcf5; box-shadow: var(--shadow-hover); }
        .kb-card h3 { font-size: 1.5rem; margin-bottom: 10px; color: var(--forest); border: none; padding: 0; }
        
        details.kb-mid-cat { margin-bottom: 15px; border: 1px solid #eee; border-radius: 8px; overflow: hidden; background: #fff; }
        summary.kb-mid-header { background: #fafafa; padding: 18px; font-size: 1.1rem; color: var(--forest); transition: 0.2s; }
        summary.kb-mid-header:hover { background: #f0f0f0; }
        .kb-article-link { padding: 15px 25px; border-bottom: 1px solid #f0f0f0; cursor: pointer; color: #555; position: relative; transition: 0.2s; }
        .kb-article-link:hover { background: #eef5e9; color: var(--forest); padding-left: 35px; }
        .kb-article-link::before { content: 'ğŸ“„'; position: absolute; left: 10px; opacity: 0; transition: 0.2s; }
        .kb-article-link:hover::before { opacity: 1; }

        /* === æŠ½å¡èƒŒé¢ === */
        #draw-area { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; padding: 40px 0; perspective: 1000px; }
        .card-back { 
            width: 60px; height: 100px; 
            background-image: url('https://geyrpowhaqfhnxghpokr.supabase.co/storage/v1/object/public/site-assets/cardback.png');
            background-repeat: no-repeat; background-position: center; background-size: cover; 
            border-radius: 8px; cursor: pointer; position: relative; 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        .card-back:hover { 
            transform: translateY(-15px) scale(1.03); z-index: 100; 
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6), 0 0 20px rgba(198, 168, 124, 0.4); 
        }
        
        .card-reveal { 
            position: relative; width: 340px; height: 580px; 
            background: #fff; border-radius: 24px; overflow: hidden; 
            box-shadow: 0 0 60px rgba(198, 168, 124, 0.5); 
            transform: scale(0.8) rotateY(90deg); opacity: 0; transition: 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        .result-overlay.active .card-reveal { transform: scale(1) rotateY(0); opacity: 1; }
        
        .retry-btn { 
            position: absolute; bottom: -80px; left: 50%; transform: translateX(-50%); 
            padding: 12px 35px; background: var(--accent); color: #000; border: none; 
            border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 16px; 
            box-shadow: 0 0 20px rgba(198, 168, 124, 0.6); transition: 0.3s; 
        }
        .retry-btn:hover { background: #e0c8a0; transform: translateX(-50%) scale(1.1); }
        
        .layer-bg { width: 100%; height: 100%; object-fit: cover; position: absolute; top:0; left:0; z-index: 0; }
        .layer-text { position: absolute; z-index: 10; white-space: pre-wrap; text-align: center; transform: translate(-50%, -50%); pointer-events: none; width: max-content; }

        @media (max-width: 768px) {
            nav { padding: 0 20px; justify-content: flex-start; gap: 15px; }
            .nav-links { overflow-x: auto; width: 100%; padding-right: 20px; }
            .nav-links button { white-space: nowrap; flex-shrink: 0; font-size: 15px; }
            .hero-section { flex-direction: column-reverse; text-align: center; gap: 30px; }
            .hero-text h1 { font-size: 2.5rem; }
            .card { padding: 25px; }
            .text-modal-card { width: 92%; padding: 40px 25px; }
        }

        @keyframes cardShuffleIn {
            from { opacity: 0; transform: translateX(-30px) rotateY(-10deg); }
            to { opacity: 1; transform: translateX(0) rotateY(0); }
        }
        .card-back { animation: cardShuffleIn 0.5s ease-out forwards; opacity: 0; }
    </style>
</head>
<body>

<nav>
    <div class="logo-area" onclick="showSection('home')">
        <img src="logo.png" alt="åŸ¹ç™’è©¦é©—å®¤" class="logo-img" id="site-logo">
    </div>
    <div class="nav-links">
        <button onclick="showSection('home')" id="nav-home" class="active">é¦–é </button>
        <button onclick="showSection('booking-step-1')" id="nav-booking">æœå‹™é ç´„</button>
        <button onclick="showSection('knowledge')" id="nav-knowledge">åŸ¹ç™’å¯¶å…¸</button>
        <button onclick="showSection('draw')" id="nav-draw">èƒ½é‡æŠ½å¡</button>
        <button onclick="showSection('member')" id="nav-member">å€‹æ¡ˆå°ˆå€</button>
    </div>
</nav>

<div id="home" class="section active">
    <div class="hero-section">
        <div class="hero-text">
            <h1>ğŸ‘‹æ­¡è¿ä¾†åˆ°<br>ã€ŒåŸ¹ç™’è©¦é©—å®¤ã€</h1>
            <h2>æˆ‘æ˜¯æ­¤ç©ºé–“å‰µè¾¦äººåŸ¹åŸ¹</h2>
            <div style="margin-top: 30px; display: flex; gap: 20px; flex-wrap: wrap; justify-content: flex-start;">
                <button class="btn-primary" onclick="openModal('story-overlay')">ğŸ“– æˆ‘çš„æ•…äº‹</button>
                <button class="btn-primary" onclick="openModal('rules-overlay')">ğŸ‘‘ ç©ºé–“å®ˆå‰‡</button>
            </div>
            <p style="color:#999; font-size:0.9rem; margin-top:15px; font-style:italic;">é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–±è®€æ•…äº‹èˆ‡å®ˆå‰‡ â†‘</p>
        </div>
        <div class="hero-img">
            <img src="logohuman.png" alt="åŸ¹åŸ¹" id="site-hero">
        </div>
    </div>

    <div class="features-grid">
        <div class="feature-card" onclick="showSection('booking-step-1')">
            <div class="feature-icon">ğŸ’</div>
            <div class="feature-title">æœå‹™é ç´„</div>
            <div class="feature-desc">éˆæ“ºæš¨äººé¡åœ–èƒ½é‡ä¸­å¿ƒèª¿æ•´ã€‚<br>æ‰¾å›ä½ çš„åŸå» è¨­å®šã€‚</div>
            <div style="margin-top:20px; color:var(--accent); font-weight:bold; letter-spacing:1px;">å‰å¾€é ç´„ &rarr;</div>
        </div>
        <div class="feature-card" onclick="showSection('knowledge')">
            <div class="feature-icon">ğŸ“˜</div>
            <div class="feature-title">åŸ¹ç™’å¯¶å…¸</div>
            <div class="feature-desc">éå°ˆæ¥­çŸ¥è­˜åº«ï¼Œé™ªæˆ‘èµ°éå…§è€—ä¹‹è·¯çš„å·¥å…·æˆ–ç³»çµ±ç°¡ä»‹ã€‚</div>
            <div style="margin-top:20px; color:var(--accent); font-weight:bold; letter-spacing:1px;">é–±è®€ç­†è¨˜ &rarr;</div>
        </div>
        <div class="feature-card" onclick="showSection('draw')">
            <div class="feature-icon">ğŸƒ</div>
            <div class="feature-title">64 é–˜é–€èƒ½é‡æŒ‡å¼•</div>
            <div class="feature-desc">å°‡ 64 å€‹é–˜é–€è½‰æ›æˆåœ–ç‰‡é…ä¸Šæ–‡å­—ã€‚<br>å»ºè­°æ¯å¤©æŠ½ä¸€å¼µå³å¯ã€‚</div>
            <div style="margin-top:20px; color:var(--accent); font-weight:bold; letter-spacing:1px;">é–‹å§‹æŠ½å¡ &rarr;</div>
        </div>
    </div>
    
    <div class="disclaimer-box" style="background:var(--forest); color:var(--cream); padding:40px; border-radius:20px; margin:60px 0; text-align:center; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
        <div class="disclaimer-text" style="font-size:1.1rem; line-height:1.8;">
            å¦‚æœå…§å®¹æœ‰èª¤ï¼Œæ­¡è¿å”åŠ©æˆ‘ä¿®æ­£ï¼Œæˆ–æ˜¯æä¾›æˆ‘å…è²»èª²ç¨‹ğŸ¤­ã€‚<br>
            å¦‚æœåªæ˜¯çœ‹äº†ä¸é–‹å¿ƒï¼Œè«‹æŒ‰ä¸‹é—œé–‰ï¼Œè¬è¬æ°æ°ğŸ‘‹
        </div>
    </div>
</div>

<div id="booking-step-1" class="section">
    <div class="card">
        <h2>ğŸ“‚ é¸æ“‡æœå‹™é¡å‹</h2>
        <p style="color:#666; margin-bottom:20px;">è«‹æ ¹æ“šæ‚¨çš„éœ€æ±‚é¸æ“‡ä¸»è¦æœå‹™é ˜åŸŸï¼š</p>
        <div id="category-list">è¼‰å…¥è³‡æ–™ä¸­...</div>
    </div>
</div>

<div id="booking-step-2" class="section">
    <div class="card">
        <button onclick="showSection('booking-step-1')" style="background:none; border:none; color:#999; cursor:pointer; margin-bottom:15px; padding:0; font-size:0.9rem; display:flex; align-items:center; gap:5px;">â† è¿”å›é¡åˆ¥</button>
        <h2 id="active-cat-name" style="margin-top:0;">æœå‹™è©³æƒ…</h2>
        
        <div style="background:#e0f7fa; padding:25px; border-radius:12px; margin-bottom:30px; border-left:5px solid #26c6da;">
            <div class="form-group" style="margin-bottom:15px;">
                <label>ğŸ”¶ ä»˜æ¬¾ç‹€æ…‹é¸æ“‡</label>
                <select id="pay-status" onchange="toggleOTA()"> 
                    <option value="unpaid">ğŸ”— æˆ‘é‚„æ²’ä»˜æ¬¾ (é ç´„å¾Œè«‹å‚³é€£çµçµ¦æˆ‘)</option>
                    <option value="ota">ğŸ›’ æˆ‘å·²æ–¼å…¶ä»–ç¶²è·¯å¹³å°ä»˜æ¬¾</option> 
                </select>
            </div>
            
            <div id="ota-area" style="display:none; border-top:1px dashed #26c6da; padding-top:15px; margin-top:10px;">
                <div class="form-group">
                    <label style="color:#006064;">é¸æ“‡ä»˜æ¬¾å¹³å°</label>
                    <select id="ota-source-select" style="background:white; border:1px solid #26c6da;"></select>
                </div>
                <div class="form-group" style="margin-bottom:0;">
                    <label style="color:#006064;">è¨‚å–®ç·¨è™Ÿ (å¿…å¡«)</label>
                    <input type="text" id="ota-order-id" placeholder="è«‹è²¼ä¸Šè©²å¹³å°çš„è¨‚å–®ç·¨è™Ÿ" style="background:white; border:1px solid #26c6da;">
                </div>
            </div>
        </div>

        <div class="form-group"><label class="required">æ‚¨çš„å§“å</label><input type="text" id="c-name" placeholder="çœŸå¯¦å§“å"></div>
        <div class="form-group">
            <label class="required">æ‰‹æ©Ÿè™Ÿç¢¼ (å°‡ä½œç‚ºç™»å…¥å¸³è™Ÿ)</label>
            <input type="tel" id="c-phone" onblur="checkPhoneMembership()" placeholder="09xxxxxxxx (éœ€10ç¢¼æ•¸å­—)">
            <small id="phone-status" style="display:block; margin-top:8px; font-weight:bold;"></small>
        </div>
        <div class="form-group"><label class="required">E-mail (æ¥æ”¶å ±å‘Šé€šçŸ¥)</label><input type="email" id="c-email" placeholder="example@mail.com"></div>
                
        <hr style="border:0; border-top:1px dashed #ddd; margin: 40px 0;">
        
        <label style="font-size:1.4rem; color:var(--forest); margin-bottom:20px;">1. é¸æ“‡æ–¹æ¡ˆå…§å®¹èˆ‡åŠ è³¼</label>
        <div id="items-area" style="margin-bottom:40px;"></div>
        
        <div class="coupon-box">
            <input type="text" id="coupon-code" placeholder="è¼¸å…¥å„ªæƒ ä»£ç¢¼" style="flex:1; border:1px solid #ccc; background:#fff;">
            <button class="btn-secondary" onclick="verifyCoupon()" style="margin:0; padding:12px 25px;">å¥—ç”¨</button>
        </div>
        <div id="coupon-msg" class="coupon-msg"></div>

        <div id="conditional-question" style="background:#fcf8f2; padding:30px; border-radius:15px; margin:30px 0; border:1px solid #eee;"></div>
        
        <div class="form-group"><label>ğŸ”¶ å‡ºç”Ÿå¹´æœˆæ—¥è³‡æ–™æä¾›</label><select id="data-flow" onchange="toggleFlow()"><option value="data">æä¾›å‡ºç”Ÿæ—¥æœŸæ™‚é–“</option><option value="upload">ç›´æ¥ä¸Šå‚³äººé¡åœ–æˆªåœ–</option></select></div>
        
        <div id="flow-data" style="background:#f9f9f9; padding:25px; border-radius:15px; margin-bottom:20px; border:1px solid #eee;">
            <div class="form-group"><label>å‡ºç”Ÿæ—¥æœŸ</label><input type="date" id="b-date"></div>
            <div class="form-group"><label>å‡ºç”Ÿç²¾ç¢ºæ™‚é–“</label><input type="time" id="b-time" value="12:00"><small style="color:#d32f2f; display:block; margin-top:5px;">âœ… è«‹ç¢ºèªæ˜¯ä¸Šåˆæˆ–ä¸‹åˆ</small></div>
            <div class="form-group"><label>å‡ºç”Ÿåœ‹å®¶èˆ‡åŸå¸‚</label><input type="text" id="b-place" placeholder="ä¾‹å¦‚ï¼šå°ç£å°ä¸­å¸‚"></div>
        </div>
        
        <div id="flow-upload" style="display:none; background:#f9f9f9; padding:25px; border-radius:15px; margin-bottom:20px; border:1px solid #eee;">
            <div style="margin-bottom: 20px; border-left: 4px solid var(--accent); padding-left: 15px;">
                <p style="margin:0; font-weight:bold; color:var(--forest);">ç¬¬ä¸€æ­¥ï¼šå–å¾—åœ–æª”</p>
                <p style="margin:5px 0 0 0; font-size:0.95rem;">è«‹å‰å¾€ <a href="https://humandesignasia.org/get-your-chart/" target="_blank" style="color:var(--shopee); text-decoration:underline; font-weight:bold;">äºæ´²äººé¡åœ–å­¸é™¢ (é»æ“Šå‰å¾€)</a></p>
            </div>
            <label style="font-weight:bold; color:var(--forest); display:block; margin-bottom:10px;">ğŸ“¸ ç¬¬äºŒæ­¥ï¼šä¸Šå‚³å‰›æ‰ä¸‹è¼‰çš„åœ–æª”</label>
            <input type="file" id="c-file" accept="image/*" style="background:#fff; border:1px solid #ccc; width:100%; padding:10px; border-radius:8px;">
        </div>
        
        <div class="card" style="background:#fffcf5; border-top:none; padding:30px; margin-bottom:0; border:1px solid #fae1c3;">
            <label>ğŸ“œ æœå‹™è¦ç¯„</label>
            <div id="terms-box" style="height:150px; overflow-y:auto; border:1px solid #e0e0e0; padding:15px; font-size:14px; background:#fff; border-radius:8px; line-height:1.8;"></div>
            <label class="agree-wrapper" style="margin-top:20px; font-size:1.1rem;">
                <input type="checkbox" id="agree-check" onchange="toggleSubmitBtn(this.checked)">
                <span>æˆ‘å·²è©³ç´°é–±è®€ä¸¦åŒæ„</span>
            </label>
        </div>
        
        <div class="total-box">
            <div id="original-price-row" style="font-size:1rem; color:#999; text-decoration:line-through; display:none; margin-bottom:5px;">åŸåƒ¹: $<span id="original-price">0</span></div>
            æ‡‰ä»˜ç¸½é¡ï¼š$<span id="total-price">0</span>
        </div>
        <div style="text-align:right; margin-top:20px;">
            <button id="sub-btn" class="btn-primary" onclick="doSubmit()" disabled>è«‹å…ˆå‹¾é¸åŒæ„è¦ç¯„</button>
        </div>
    </div>
</div>

<div id="knowledge" class="section">
    <div class="kb-header">
        <button id="kb-back-btn" class="kb-back-btn" onclick="kbGoBack()">â† è¿”å›</button>
        <h2 class="kb-title">ğŸ“˜ åŸ¹ç™’å¯¶å…¸</h2>
        <div style="width:70px;"></div> 
    </div>
    <div id="kb-container">è¼‰å…¥ä¸­...</div>
</div>

<div id="draw" class="section">
    <div style="text-align:center; margin-bottom:40px;">
        <h2 style="font-size:2.5rem; margin-bottom:10px;">ğŸƒ 64 é–˜é–€èƒ½é‡æŒ‡å¼•</h2>
        <p style="color:#666; font-size:1.1rem;">æ·±å‘¼å¸ï¼Œåœ¨å¿ƒä¸­é»˜æƒ³ä½ çš„å•é¡Œï¼Œæ†‘ç›´è¦ºé¸ä¸€å¼µç‰Œã€‚</p>
    </div>
    <div id="draw-area"><div style="color:#666;">æ­£åœ¨æ´—ç‰Œä¸­...</div></div>
</div>

<div id="member" class="section">
    <div class="card" id="login-box" style="max-width:500px; margin:50px auto;">
        <h3 style="margin-top:0; text-align:center;">ğŸ‘¤ æœƒå“¡ç™»å…¥</h3>
        <div style="margin-top:30px;">
            <input type="tel" id="l-phone" placeholder="æ‰‹æ©Ÿ (å¸³è™Ÿ)" style="margin-bottom:15px;">
            <input type="password" id="l-pass" placeholder="å¯†ç¢¼" style="margin-bottom:25px;">
            <button class="btn-primary" onclick="doLogin()" style="width:100%;">ç™»å…¥ç³»çµ±</button>
        </div>
    </div>
    <div id="dash" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <h3 id="dash-welcome" style="margin:0;"></h3>
            <div>
                <button class="btn-secondary" style="font-size:14px;" onclick="openEditProfile()">ä¿®æ”¹è³‡æ–™</button>
                <button class="btn-secondary" style="font-size:14px; border-color:#999; color:#999;" onclick="doLogout()">ç™»å‡º</button>
            </div>
        </div>
        <div class="card" style="background:#f1f8e9; border:1px solid #c8e6c9;">
            <h4 style="margin-top:0; color:#2e7d32;">ğŸ“‹ æ‚¨çš„æœå‹™å ±å‘Š (å·²çµæ¡ˆ)</h4>
            <div id="dash-history" style="max-height:500px; overflow-y:auto; margin-top:15px;"></div>
        </div>
    </div>
</div>

<div id="overlay" class="result-overlay">
    <div style="position:relative;">
        <div id="final-card" class="card-reveal">
            <img id="p-bg" class="layer-bg" src="">
            <div id="p-gate" class="layer-text"></div>
            <div id="p-info" class="layer-text"></div>
            <div id="p-zodiac" class="layer-text"></div>
            <div id="p-quote" class="layer-text"></div>
        </div>
        <button class="retry-btn" onclick="closeResult()">å†æ¬¡æŠ½å¡</button>
    </div>
</div>

<div id="story-overlay" class="result-overlay">
    <div class="text-modal-card">
        <h3>å¾å…§è€—åˆ°åŸå» è¨­å®š</h3>
        <div class="story-text">
            <p>åœ¨ 2024 å¹´åº•æˆ‘è¢«è¿«é›¢é–‹ç•¶æ™‚çš„å·¥ä½œï¼Œé€™æ®µæœŸé–“ä¸åœæ€ç´¢æˆ‘èƒ½åšä»€éº¼ï¼Ÿæƒ³åšä»€éº¼ï¼Ÿ</p>
            <p>æ‰¾å·¥ä½œè™•è™•ç¢°å£ä¸”é–‹å§‹è‡ªæˆ‘å…§è€—ï¼ŒåŸºæœ¬ä¸Šæˆ‘è™•åœ¨å‹•å½ˆä¸å¾—çš„ç‹€æ…‹ã€‚æˆ‘é–‹å§‹å°‹æ±‚å¿ƒç†ç›¸é—œåŠèº«å¿ƒéˆé ˜åŸŸæ–¹é¢ï¼Œé›–ç„¶æœ‰ç·©è§£ä½†æˆ‘åˆç–‘æƒ‘è‡ªå·±æ˜¯ä¸æ˜¯é£„åœ¨åŠç©ºã€‚</p>
            <p>å°±åœ¨æˆ‘ä¸€ç›´çŒ¶è±«ä¸å®šæ™‚ï¼Œäººé¡åœ–åœ¨é¢å‰å‡ºç¾äº†ã€‚</p>
            <p class="highlight-text">æˆ‘å¿…é ˆå…ˆè²æ˜ï¼Œæˆ‘ä¸€é–‹å§‹çœ‹åˆ°æˆ‘çš„äººé¡åœ–ï¼Œæˆ‘æ¥µåº¦å­æƒ¡ï¼Œä½†æˆ‘ç¾åœ¨æ˜¯å°æ–¼æˆ‘çš„åŸå» è¨­è¨ˆéå¸¸æ»¿æ„ã€‚</p>
        </div>
        <div class="hd-chart-container">
            <img src="https://geyrpowhaqfhnxghpokr.supabase.co/storage/v1/object/public/site-assets/my_hd_chart.png" id="hd-chart-img" alt="åŸ¹åŸ¹çš„äººé¡åœ–">
            <div class="hd-caption">â–² å¦‚åœ–æ‰€ç¤ºï¼Œæˆ‘çš„ç©ºç™½èƒ½é‡ä¸­å¿ƒæ›¾æ˜¯æˆ‘æœ€å¤§çš„å›°æ“¾</div>
        </div>
        <div class="story-text">
            <p>åœ–ä¸Šç©ºç™½çš„èƒ½é‡ä¸­å¿ƒæ˜¯å¸æ”¶ä»–äººèƒ½é‡èˆ‡èƒ½é‡æ”¾å¤§å™¨ï¼Œä½†æˆ‘å”¯ä¸€å…©å€‹æœ‰é¡è‰²çš„èƒ½é‡ä¸­å¿ƒä¹Ÿæ²’æœ‰æ­£å¸¸é‹ä½œï¼Œæˆ‘åŸºæœ¬ä¸Šæ‰€æœ‰èƒ½é‡ä¸­å¿ƒéƒ½å¡åœ¨äº†ã€éè‡ªå·±ã€è·Ÿã€è¢«åˆ¶ç´„ã€çš„ç‹€æ…‹ã€‚</p>
            <p>æˆ‘é€éè‡ªå·±å­¸ç¿’ä¸¦ç†è§£äººé¡åœ–ä¹‹å¾Œï¼Œé †åˆ©è§£æ±ºäº†æˆ‘çš„è‡ªæˆ‘å…§è€—ä¹‹è·¯ã€‚</p>
            <p class="highlight-text">æˆ‘æƒ³ç”¨éˆæ“ºå”åŠ©ä¾†åˆ°é€™å€‹ç©ºé–“çš„ä½ ï¼Œåšä¸€æ¬¡äººé¡åœ–èƒ½é‡ä¸­å¿ƒçš„èª¿æ•´ï¼Œè®“ä½ å›åˆ°ä½ è‡ªå·±çš„äººç”ŸåŸå» è¨­å®šã€‚</p>
            <p style="font-size:0.9rem; color:#888; margin-top:20px;">(è‡³æ–¼éˆæ“ºæ˜¯ä»€éº¼ï¼Œè«‹åˆ°åŸ¹ç™’å¯¶å…¸æ¢ç´¢)</p>
        </div>
        <button class="close-modal-btn" onclick="closeModal('story-overlay')">é—œé–‰æ•…äº‹</button>
    </div>
</div>

<div id="rules-overlay" class="result-overlay">
    <div class="text-modal-card">
        <h3>ğŸ‘‘ ç©ºé–“å®ˆå‰‡</h3>
        <div class="rule-item">
            <h4 class="rule-head"><span class="rule-num">1</span> åˆå¿ƒè€…æŒ‡å—</h4>
            <p class="rule-body">å¦‚æœä½ å‰›ä¾†åˆ°é€™å€‹ç©ºé–“ï¼Œå°é€™ä¸€åˆ‡æ„Ÿåˆ°å¥½å¥‡ï¼Œæ­¡è¿å…ˆé ˜å–æˆ‘ç‚ºä½ æº–å‚™çš„ ã€Œå…¥é–€ç¦®ç‰©ğŸã€ã€‚<br>è«‹å‰å¾€ã€åŸ¹ç™’å¯¶å…¸ã€‘æ¢ç´¢ï¼Œæˆ–é€éã€èƒ½é‡æŠ½å¡ã€‘æ„Ÿå—ä½ æœ€è¿‘çš„ç‹€æ…‹æŒ‡å¼•ã€‚</p>
        </div>
        <div class="rule-item">
            <h4 class="rule-head"><span class="rule-num">2</span> é ç´„å‰çš„æ ¡æº–å»ºè­°</h4>
            <div class="rule-body">
                <p>å°æ–¼å·²æœ‰ç¶“é©—çš„æœ‹å‹ï¼Œåœ¨é»é¸é ç´„å‰ï¼Œæˆ‘å¸Œæœ›ä½ å…ˆæ€è€ƒç›®å‰çš„ç‹€æ…‹ã€‚è‹¥ä½ æ­£è™•æ–¼ä»¥ä¸‹éšæ®µï¼š</p>
                <ul class="rule-list" style="margin:10px 0 15px 20px; padding:0; color:#555; list-style-type: square;">
                    <li>æ‰¾å°‹èƒ½å¿«é€Ÿç²åˆ©çš„ã€Œéˆæ€§å·¥å…·ã€</li>
                    <li>æ‰¾å°‹èƒ½å¹«ä½ åšæœªä¾†æ±ºå®šçš„ã€Œä»£è¡Œäººã€</li>
                    <li>è™•æ–¼å¤šæ–¹å˜—è©¦ã€å°šæœªæ‰“ç®—è½åœ°çš„éšæ®µ</li>
                </ul>
                <p>ç‚ºäº†ç¢ºä¿è«®è©¢èƒ½å¸¶çµ¦ä½ çœŸæ­£çš„åƒ¹å€¼ï¼Œæˆ‘ä¸å»ºè­°ä½ ç›´æ¥é»é¸é ç´„ã€‚ä½ å¯ä»¥å…ˆèˆ‡åŸ¹ç™’å¸«èŠèŠçœ‹ï¼Œç¢ºèªç›®å‰çš„é »ç‡æ˜¯å¦é©åˆé€²è¡Œæ·±åº¦è©¦é©—ã€‚</p>
            </div>
        </div>
        <div class="rule-item">
            <h4 class="rule-head"><span class="rule-num">3</span> å•Ÿå‹•ä½ çš„åŸå» è¨­å®š</h4>
            <p class="rule-body">è‹¥ä½ çœŸå¿ƒæƒ³äº†è§£è‡ªå·±çš„åŸå» è¨­è¨ˆï¼Œæˆ–æ„Ÿå—åˆ°èƒ½é‡å µå¡ä¸”æ±ºå®šä¸å†é€ƒé¿ã€‚<br><strong style="color:var(--forest);">è¡¨ç¤ºä½ å·²ç¶“æº–å‚™å¥½ç‚ºè‡ªå·±çš„äººç”Ÿè² è²¬ï¼Œé€™ä»½æ±ºå¿ƒå°±æ˜¯é€²å…¥æœ¬è©¦é©—å®¤æœ€çè²´çš„é€šè¡Œè­‰ã€‚</strong></p>
            <div style="text-align:center; margin-top:30px;">
                <button class="btn-primary" onclick="closeModal('rules-overlay'); showSection('booking-step-1');">â” æˆ‘å·²æº–å‚™å¥½ï¼Œé»é¸é ç´„</button>
            </div>
        </div>
        <button class="close-modal-btn" onclick="closeModal('rules-overlay')">é—œé–‰å®ˆå‰‡</button>
    </div>
</div>

<div id="edit-profile-overlay" class="result-overlay">
    <div class="text-modal-card" style="max-width:450px; padding:30px;">
        <h3 style="margin-top:0;">âœï¸ ä¿®æ”¹æœƒå“¡è³‡æ–™</h3>
        <label>æ‰‹æ©Ÿ (å¸³è™Ÿä¸å¯ä¿®æ”¹)</label><input type="text" id="ep-phone" disabled style="background:#eee; color:#666;">
        <label style="margin-top:15px;">å§“å</label><input type="text" id="ep-name">
        <label style="margin-top:15px;">Email</label><input type="email" id="ep-email">
        <label style="margin-top:15px;">æ–°å¯†ç¢¼ (ä¸æ”¹è«‹ç•™ç©º)</label><input type="password" id="ep-pass" placeholder="è¼¸å…¥æ–°å¯†ç¢¼">
        <div style="margin-top:30px; display:flex; gap:15px;">
            <button class="btn-secondary" onclick="closeModal('edit-profile-overlay')" style="flex:1; justify-content:center;">å–æ¶ˆ</button>
            <button class="btn-primary" onclick="saveProfile()" style="flex:1; padding:10px 0; font-size:1rem;">å„²å­˜</button>
        </div>
    </div>
</div>

<script>
    const SB_URL = "https://geyrpowhaqfhnxghpokr.supabase.co";
    const SB_KEY = "sb_publishable_aXucdq8UtvMbCKbriqpJCw_gtpYBw-r";
    const myDB = supabase.createClient(SB_URL, SB_KEY);

    let cats = [], items = [], activeCat = null, allCards = [], kbTree = {}, kbState = { level: 0 }, otas = [];
    let currentCoupon = null; 
    let currentUser = null; 
    let isMemberBlocked = false; 
    const defaultStyle = { gate: { x: 50, y: 65, size: 34, font: "'Cinzel', serif", color: "#1a1a1a", stroke: "#ffffff" }, info: { x: 50, y: 72, size: 18, font: "'Noto Serif TC', serif", color: "#1a1a1a", stroke: "transparent", w: 300 }, zodiac: { x: 85, y: 65, size: 12, font: "sans-serif", color: "#6a1b9a", stroke: "transparent" }, quote: { x: 50, y: 88, size: 15, font: "'Shippori Mincho', serif", color: "#ffffff", stroke: "#000000", w: 280, lh: 1.6, ls: 0 } };

    function showSection(id) { 
        document.querySelectorAll('.section').forEach(s=>s.classList.remove('active')); 
        document.getElementById(id).classList.add('active'); 
        document.querySelectorAll('.nav-links button').forEach(b=>b.classList.remove('active'));
        const baseId = id.split('-')[0]; 
        const navBtn = document.getElementById('nav-' + baseId);
        if(navBtn) navBtn.classList.add('active');
        window.scrollTo(0,0); 
    }

    window.onload = async () => {
        await initBookingData(); 
        initDrawData(); 
        initKbData(); 
        loadSiteAssets();
        checkSession(); 
    };

    function checkSession() {
        const saved = localStorage.getItem('peiyu_user');
        if (saved) {
            try {
                const { phone, pass } = JSON.parse(saved);
                document.getElementById('l-phone').value = phone;
                document.getElementById('l-pass').value = pass;
                doLogin(); 
            } catch (e) {
                console.log("è‡ªå‹•ç™»å…¥å¤±æ•ˆ");
                localStorage.removeItem('peiyu_user');
            }
        }
    }

    async function checkPhoneMembership() {
        const phone = document.getElementById('c-phone').value.trim();
        const statusEl = document.getElementById('phone-status');
        const submitBtn = document.getElementById('sub-btn');

        if (!phone || currentUser) return;
        if (!/^09\d{8}$/.test(phone)) {
            statusEl.innerHTML = "âŒ æ ¼å¼éŒ¯èª¤ (éœ€10ç¢¼)"; statusEl.style.color = "red"; submitBtn.disabled = true; return;
        }

        statusEl.innerHTML = "ğŸ” æª¢æŸ¥ä¸­...";
        const { data } = await myDB.from('profiles').select('id').eq('phone', phone).single();

        if (data) {
            isMemberBlocked = true;
            statusEl.innerHTML = `âš ï¸ æ­¤è™Ÿç¢¼å·²è¨»å†Šï¼è«‹å…ˆ <a href="#" onclick="showSection('member'); return false;" style="color:red;font-weight:bold;text-decoration:underline;">ç™»å…¥æœƒå“¡</a>`;
            statusEl.style.color = "red"; submitBtn.disabled = true; submitBtn.innerText = "è«‹å…ˆç™»å…¥æœƒå“¡";
        } else {
            isMemberBlocked = false;
            statusEl.innerHTML = "âœ… æ–°æœ‹å‹æ­¡è¿ä½ ";
            statusEl.style.color = "green";
            toggleSubmitBtn(document.getElementById('agree-check').checked);
        }
    }

    async function verifyCoupon() {
        const code = document.getElementById('coupon-code').value.trim().toUpperCase();
        const msgEl = document.getElementById('coupon-msg');
        const phone = document.getElementById('c-phone').value.trim();

        if (!phone && !currentUser) { alert("âš ï¸ è«‹å…ˆè¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼æˆ–ç™»å…¥æœƒå“¡ï¼Œæ‰èƒ½é©—è­‰å„ªæƒ åˆ¸è³‡æ ¼ï¼"); return; }
        if (!code) { msgEl.innerText = ""; currentCoupon = null; calcTotal(); return; }

        msgEl.className = "coupon-msg"; msgEl.innerText = "æŸ¥è©¢ä¸­...";

        const { data: coupon, error } = await myDB.from('coupons').select('*').eq('code', code).single();

        if (error || !coupon) {
            msgEl.className = "coupon-msg error"; msgEl.innerText = "âŒ ç„¡æ•ˆçš„å„ªæƒ ä»£ç¢¼";
            currentCoupon = null;
        } else {
            if (coupon.expires_at && new Date(coupon.expires_at) < new Date()) {
                msgEl.className = "coupon-msg error"; msgEl.innerText = "âš ï¸ æ­¤ä»£ç¢¼å·²éæœŸ";
                currentCoupon = null;
            } else {
                let isMember = false;
                let searchUserId = null;

                if (currentUser) {
                    isMember = true;
                    searchUserId = currentUser.id;
                } else {
                    const { data: profile } = await myDB.from('profiles').select('id').eq('phone', phone).single();
                    if (profile) { isMember = true; searchUserId = profile.id; }
                }

                if (isMember && !coupon.allow_member) {
                    msgEl.className = "coupon-msg error"; msgEl.innerText = "âŒ æ­¤å„ªæƒ åˆ¸åƒ…é™ã€æ–°æœ‹å‹/è¨ªå®¢ã€‘ä½¿ç”¨";
                    currentCoupon = null; calcTotal(); return;
                } else if (!isMember && !coupon.allow_guest) {
                    msgEl.className = "coupon-msg error"; msgEl.innerText = "âŒ æ­¤å„ªæƒ åˆ¸åƒ…é™ã€æœƒå“¡ã€‘ä½¿ç”¨ (è«‹è¨»å†Š/ç™»å…¥)";
                    currentCoupon = null; calcTotal(); return;
                }

                if (searchUserId) {
                    const { data: history } = await myDB.from('bookings').select('id').eq('user_id', searchUserId).ilike('coupon_info', `%Code:${code}%`).limit(1);
                    if (history && history.length > 0) {
                        msgEl.className = "coupon-msg error"; msgEl.innerText = "âŒ æ‚¨å·²ä½¿ç”¨éæ­¤å„ªæƒ åˆ¸ (é™ç”¨ä¸€æ¬¡)";
                        currentCoupon = null; calcTotal(); return;
                    }
                }

                currentCoupon = coupon;
                let desc = coupon.discount_type === 'percentage' ? `æ‰“ ${coupon.discount_value < 10 ? coupon.discount_value*10 : coupon.discount_value} æŠ˜` : `æŠ˜æŠµ $${coupon.discount_value}`;
                msgEl.className = "coupon-msg success"; msgEl.innerText = `âœ… å¥—ç”¨æˆåŠŸï¼š${coupon.name} (${desc})`;
            }
        }
        calcTotal(); 
    }

    async function initBookingData() {
        const { data: c } = await myDB.from('service_categories').select('*').order('created_at'); cats = c || [];
        const { data: i } = await myDB.from('services').select('*').order('sort_order'); items = i || [];
        const { data: o } = await myDB.from('ota_settings').select('*'); otas = o || [];
        
        const otaSelect = document.getElementById('ota-source-select');
        if(otaSelect) otaSelect.innerHTML = otas.map(p => `<option value="${p.code}">${p.name}</option>`).join('');

        document.getElementById('category-list').innerHTML = cats.map(c => `
            <div class="cat-card" onclick="selectCat('${c.id}')">
                <h3>${c.name}</h3>
                <span style="font-size:1.5rem; color:var(--accent);">â”</span>
            </div>`).join('');
    }

    function selectCat(id) {
        activeCat = cats.find(x => x.id === id);
        document.getElementById('active-cat-name').innerText = activeCat.name;
        document.getElementById('terms-box').innerText = activeCat.terms || "è«‹éµå®ˆè¦ç¯„ã€‚";
        document.getElementById('agree-check').checked = false; toggleSubmitBtn(false);
        document.getElementById('coupon-code').value = ""; document.getElementById('coupon-msg').innerText = ""; currentCoupon = null;

        const sub = items.filter(x => x.category_id === id);
        document.getElementById('items-area').innerHTML = sub.map(i => {
            let subHtml = i.sub_options ? `<div class="sub-check-grid">${i.sub_options.split(/[,ï¼Œ]/).map(o=>`<label class="sub-opt-label"><input type="checkbox" class="sub-opt-item" data-parent-id="${i.id}" value="${o.trim()}"> ${o.trim()}</label>`).join('')}</div>` : '';
            return `<div class="service-card" id="card-${i.id}"><div class="service-header"><label class="service-info"><input type="checkbox" name="svc" value="${i.id}" data-price="${i.price}" data-title="${i.title}" data-is-main="${i.is_main}" onchange="handleServiceCheck(this)"> <span>${i.title}</span></label><span class="price-badge">$${i.price}</span></div>${subHtml}</div>`;
        }).join('');
        
        document.getElementById('conditional-question').innerHTML = activeCat.question_type === 'sleep' ? `<label>ğŸŒ™ ç¡çœ æ™‚é–“</label><input type="text" id="q-val" placeholder="ä¾‹å¦‚ï¼š23:30 ~ 07:00">` : `<label>ğŸ“… å¸Œæœ›è«®è©¢æ™‚é–“</label><input type="text" id="q-val" placeholder="ä¾‹å¦‚ï¼šå¹³æ—¥æ™šä¸Š">`;
        calcTotal(); showSection('booking-step-2');
    }

    function handleServiceCheck(el) {
        if (el.dataset.isMain === 'true') {
            document.querySelectorAll('input[name="svc"][data-is-main="true"]').forEach(i => {
                if (i !== el) { i.disabled = el.checked; if(document.getElementById(`card-${i.value}`)) document.getElementById(`card-${i.value}`).classList.toggle('disabled-card', el.checked); }
            });
        }
        calcTotal();
    }

    function calcTotal() {
        let t = 0;
        document.querySelectorAll('input[name="svc"]:checked').forEach(el => t += parseInt(el.dataset.price || 0));
        const originalPrice = t;
        let finalPrice = t;
        if (currentCoupon) {
            if (currentCoupon.discount_type === 'percentage') finalPrice = Math.round(originalPrice * (currentCoupon.discount_value / 100));
            else finalPrice = originalPrice - currentCoupon.discount_value;
            if (finalPrice < 0) finalPrice = 0;
            document.getElementById('original-price').innerText = originalPrice;
            document.getElementById('original-price-row').style.display = 'block';
            document.getElementById('total-price').style.color = '#27ae60';
        } else {
            document.getElementById('original-price-row').style.display = 'none';
            document.getElementById('total-price').style.color = '#d35400';
        }
        document.getElementById('total-price').innerText = finalPrice;
        return finalPrice;
    }

    function compressImage(file) {
        return new Promise((resolve, reject) => {
            const maxWidth = 1600; const quality = 0.7; const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image(); img.src = event.target.result;
                img.onload = () => {
                    let width = img.width; let height = img.height;
                    if (width > maxWidth) { height = Math.round(height * (maxWidth / width)); width = maxWidth; }
                    const canvas = document.createElement('canvas'); canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
                    canvas.toBlob((blob) => { if (!blob) return reject(new Error("å£“ç¸®å¤±æ•—")); resolve(blob); }, 'image/jpeg', quality);
                }; img.onerror = (err) => reject(err);
            }; reader.onerror = (err) => reject(err);
        });
    }

    async function doSubmit() {
        if (isMemberBlocked) return alert("âš ï¸ ç³»çµ±åµæ¸¬æ‚¨å·²æ˜¯æœƒå“¡ï¼Œè«‹å…ˆå‰å¾€ã€Œå€‹æ¡ˆå°ˆå€ã€ç™»å…¥ï¼");
        const name = document.getElementById('c-name').value.trim();
        const phone = document.getElementById('c-phone').value.trim();
        const email = document.getElementById('c-email').value.trim();
        if (!name || !phone || !email) return alert("è«‹å¡«å¯«å®Œæ•´åŸºæœ¬è³‡æ–™");
        if (!/^09\d{8}$/.test(phone)) return alert("æ‰‹æ©Ÿæ ¼å¼éŒ¯èª¤ (éœ€10ç¢¼)");
        
        const finalPrice = calcTotal();
        if (finalPrice === 0 && document.querySelectorAll('input[name="svc"]:checked').length === 0) return alert("è«‹è‡³å°‘é¸æ“‡ä¸€é …æœå‹™");

        const payStatus = document.getElementById('pay-status').value;
        const otaSource = document.getElementById('ota-source-select').value;
        const otaOrderId = document.getElementById('ota-order-id').value.trim();
        if (payStatus === 'ota' && !otaOrderId) return alert("âŒ è«‹å¡«å¯«è¨‚å–®ç·¨è™Ÿ");

        const qVal = document.getElementById('q-val').value.trim();
        if (!qVal) return alert("âŒ è«‹å›ç­”æ™‚é–“ç›¸é—œå•é¡Œ");

        const flow = document.getElementById('data-flow').value;
        let finalDataInfo = "";
        const btn = document.getElementById('sub-btn'); btn.disabled = true; btn.innerText = "è³‡æ–™è™•ç†ä¸­...";

        try {
            if (flow === 'upload') {
                const fileInput = document.getElementById('c-file');
                if (!fileInput.files || fileInput.files.length === 0) throw new Error("âŒ è«‹ä¸Šå‚³äººé¡åœ–æˆªåœ–ï¼");
                let fileToUpload = fileInput.files[0];
                if (fileToUpload.size > 1024 * 1024) fileToUpload = await compressImage(fileToUpload);
                const fName = `HD_${phone}_${Date.now()}.jpg`;
                const { error: uploadErr } = await myDB.storage.from('case-charts').upload(fName, fileToUpload, { contentType: 'image/jpeg' });
                if (uploadErr) throw uploadErr;
                const { data } = myDB.storage.from('case-charts').getPublicUrl(fName);
                finalDataInfo = `æˆªåœ–: ${data.publicUrl}`;
            } else {
                const bDate = document.getElementById('b-date').value;
                const bTime = document.getElementById('b-time').value;
                const bPlace = document.getElementById('b-place').value.trim();
                if (!bDate || !bTime || !bPlace) throw new Error("âŒ è«‹å®Œæ•´å¡«å¯«å‡ºç”Ÿè³‡æ–™");
                finalDataInfo = `å‡ºç”Ÿ: ${bDate} ${bTime} ${bPlace}`;
            }

            let details = [];
            document.querySelectorAll('input[name="svc"]:checked').forEach(el => {
                let txt = `${el.dataset.title} ($${el.dataset.price})`;
                let subs = Array.from(document.querySelectorAll(`.sub-opt-item[data-parent-id="${el.value}"]:checked`)).map(s=>s.value);
                if(subs.length) txt += ` [${subs.join('ã€')}]`;
                details.push(txt);
            });

            let couponInfoText = null;
            if (currentCoupon) {
                let desc = currentCoupon.discount_type === 'percentage' ? `${currentCoupon.discount_value}æŠ˜` : `æŠ˜$${currentCoupon.discount_value}`;
                couponInfoText = `${currentCoupon.name} (${desc}) [Code:${currentCoupon.code}]`;
                await myDB.from('coupons').update({ usage_count: currentCoupon.usage_count + 1 }).eq('id', currentCoupon.id);
            }

            const { error } = await myDB.from('bookings').insert([{
                booking_id: "OD" + Date.now(), temp_phone: phone, status: 'pending', price: finalPrice,
                service_item: activeCat.name, service_detail: details.join(' | '),
                ota_source: payStatus === 'ota' ? otaSource : null,
                ota_order_id: payStatus === 'ota' ? otaOrderId : null,
                payment_method: payStatus, sleep_time: qVal,
                wish_detail: `å§“å:${name} | Email:${email} | æ•¸æ“š:${finalDataInfo}`,
                coupon_info: couponInfoText, user_id: currentUser ? currentUser.id : null
            }]);

            if(!error) { 
                await myDB.functions.invoke('line-notify', { body: { name, phone, service: activeCat.name, note: `é‡‘é¡:$${finalPrice} ${couponInfoText ? '(å«å„ªæƒ )' : ''}` } });
                
                alert("ğŸ‰ é ç´„æˆåŠŸï¼"); 

                if(currentUser) {
                    const { data: newBookings } = await myDB.from('bookings').select('*').eq('user_id', currentUser.id);
                    const { data: newReports } = await myDB.from('reports').select('*').eq('user_id', currentUser.id);
                    currentUser.bookings = newBookings || [];
                    currentUser.reports = newReports || [];
                    renderDashboard(currentUser); 
                    showSection('member');
                } else {
                    location.reload(); 
                }

            } else { 
                throw error; 
            }

        } catch (err) { 
            alert(err.message || "ç™¼ç”ŸéŒ¯èª¤"); 
            btn.disabled = false; 
            btn.innerText = "é€å‡ºé ç´„"; 
        }
    }

    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function toggleOTA() { const isOTA = document.getElementById('pay-status').value === 'ota'; document.getElementById('ota-area').style.display = isOTA ? 'block' : 'none'; }
    function toggleFlow() { const isD=document.getElementById('data-flow').value==='data'; document.getElementById('flow-data').style.display=isD?'block':'none'; document.getElementById('flow-upload').style.display=isD?'none':'block'; }
    function toggleSubmitBtn(c) { if(isMemberBlocked) return; document.getElementById('sub-btn').disabled = !c; document.getElementById('sub-btn').innerText = c ? "é€å‡ºé ç´„" : "è«‹åŒæ„è¦ç¯„"; }

    // --- KB, Draw, Login ---
    async function initKbData() { const { data } = await myDB.from('kb_articles').select('id,title,big_category,mid_category').eq('is_published',true); if(data) { kbTree={}; data.forEach(i=>{ if(!kbTree[i.big_category])kbTree[i.big_category]={}; if(!kbTree[i.big_category][i.mid_category])kbTree[i.big_category][i.mid_category]=[]; kbTree[i.big_category][i.mid_category].push(i); }); renderKbHome(); } }
    function renderKbHome() { document.getElementById('kb-container').innerHTML = `<div class="kb-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;">${Object.keys(kbTree).map(b=>`<div class="kb-card" onclick="enterKb('${b}')"><h3>ğŸ“‚ ${b}</h3><span>${Object.values(kbTree[b]).flat().length} ç¯‡</span></div>`).join('')}</div>`; document.querySelector('.kb-title').innerText="åŸ¹ç™’å¯¶å…¸"; document.getElementById('kb-back-btn').style.display='none'; }
    function enterKb(big) { kbState = { level: 1, big }; document.getElementById('kb-container').innerHTML = Object.entries(kbTree[big]).map(([mid, arts]) => `<details class="kb-mid-cat"><summary class="kb-mid-header">${mid} â–¼</summary>${arts.map(a=>`<div class="kb-article-link" onclick="readArt('${a.id}')">${a.title}</div>`).join('')}</details>`).join(''); document.querySelector('.kb-title').innerText=big; document.getElementById('kb-back-btn').style.display='block'; }
    async function readArt(id) { const { data } = await myDB.from('kb_articles').select('*').eq('id', id).single(); document.getElementById('kb-container').innerHTML = `<div class="kb-article-view"><h1>${data.title}</h1><div style="border-bottom:1px solid #eee;padding-bottom:10px;color:#999;">${data.big_category} > ${data.mid_category}</div><div style="margin-top:20px;">${data.body}</div></div>`; kbState.level = 2; document.getElementById('kb-back-btn').innerText="â† è¿”å›åˆ—è¡¨"; }
    function kbGoBack() { if(kbState.level===2) enterKb(kbState.big); else renderKbHome(); }
    async function initDrawData() { const { data } = await myDB.from('card_pool').select('*'); allCards = data || []; renderDrawTable(); }
    function renderDrawTable() { const table = document.getElementById('draw-area'); if (!table) return; table.innerHTML = ''; const deck = allCards.length > 0 ? [...allCards] : Array.from({length: 64}, (_, i) => ({ gate_id: i + 1 })); const shuffled = deck.sort(() => Math.random() - 0.5); shuffled.forEach((card, index) => { const el = document.createElement('div'); el.className = 'card-back'; el.style.animationDelay = (index * 0.015) + 's'; el.onclick = () => drawCard(card); table.appendChild(el); }); }
    async function drawCard(card) { document.getElementById('p-gate').innerText = `GATE ${card.gate_id}`; document.getElementById('p-info').innerText = `${card.gate_name || ''} / ${card.gate_keyword || ''}`; document.getElementById('p-zodiac').innerText = card.zodiac || ''; document.getElementById('p-quote').innerText = card.quote || ''; if (card.image_url) { document.getElementById('p-bg').src = card.image_url + `?t=${new Date().getTime()}`; } const style = card.style_config || defaultStyle; applyStyle('gate', style.gate || defaultStyle.gate); applyStyle('info', style.info || defaultStyle.info); applyStyle('zodiac', style.zodiac || defaultStyle.zodiac); applyStyle('quote', style.quote || defaultStyle.quote); document.getElementById('overlay').classList.add('active'); }
    function applyStyle(id, s) { const el = document.getElementById(`p-${id}`); const def = defaultStyle[id]; const val = (prop) => (s && s[prop] !== undefined) ? s[prop] : def[prop]; el.style.left = val('x') + '%'; el.style.top = val('y') + '%'; el.style.fontSize = val('size') + 'px'; el.style.fontFamily = val('font'); el.style.color = val('color'); const str = val('stroke'); el.style.textShadow = (str && str !== 'transparent') ? `1px 1px 0 ${str}, -1px -1px 0 ${str}, 1px -1px 0 ${str}, -1px 1px 0 ${str}` : 'none'; if(id === 'quote' || id === 'info') el.style.width = val('w') + 'px'; if(id === 'quote') { el.style.lineHeight = val('lh'); el.style.letterSpacing = val('ls') + 'px'; } if(id === 'zodiac') el.style.display = document.getElementById('p-zodiac').innerText ? 'block' : 'none'; }
    function closeResult() { document.getElementById('overlay').classList.remove('active'); setTimeout(() => { renderDrawTable(); document.getElementById('p-bg').src = ""; }, 500); }
    async function loadSiteAssets() { const { data } = await myDB.from('site_content').select('*').eq('category', 'site_asset'); if (data) { data.forEach(item => { if (item.title === 'logo') document.getElementById('site-logo').src = item.image_url; if (item.title === 'logohuman') document.getElementById('site-hero').src = item.image_url; if (item.title === 'my_hd_chart') document.getElementById('hd-chart-img').src = item.image_url; }); } }
    
    async function doLogin() { 
        const phone = document.getElementById('l-phone').value.trim(); 
        const pass = document.getElementById('l-pass').value.trim(); 
        if(!phone || !pass) return alert("è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼"); 
        
        try { 
            const { data: user, error: userErr } = await myDB.from('profiles').select('*').eq('phone', phone).eq('password', pass).single(); 
            if (userErr || !user) throw new Error("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤"); 
            
            const { data: bookings } = await myDB.from('bookings').select('*').eq('user_id', user.id); 
            const { data: reports } = await myDB.from('reports').select('*').eq('user_id', user.id); 
            
            user.bookings = bookings || []; 
            user.reports = reports || []; 
            
            currentUser = user; 
            isMemberBlocked = false; 

            // ğŸ‘‡ ç™»å…¥æˆåŠŸæ™‚ï¼Œå­˜å…¥ LocalStorage
            localStorage.setItem('peiyu_user', JSON.stringify({ phone: phone, pass: pass }));
            
            document.getElementById('login-box').style.display = 'none'; 
            document.getElementById('dash').style.display = 'block'; 
            
            renderDashboard(currentUser); 
        } catch (err) { 
            console.error(err); 
            alert("ç™»å…¥ç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message); 
        } 
    }

    function renderDashboard(user) { 
        document.getElementById('dash-welcome').innerText = `æ‚¨å¥½ï¼Œ${user.full_name}`; 
        const allBookings = user.bookings.sort((a,b) => new Date(b.created_at) - new Date(a.created_at)); 
        let historyHtml = "<div style='color:#666;padding:10px;'>ç›®å‰å°šç„¡é ç´„ç´€éŒ„</div>"; 
        
        if(allBookings.length > 0) { 
            historyHtml = allBookings.map(b => { 
                const dateStr = new Date(b.created_at).toLocaleDateString(); 
                const title = b.service_item || 'æœå‹™é ç´„'; 
                const stMap = { 'pending': '<span style="color:red">æœªä»˜æ¬¾</span>', 'paid': '<span style="color:green">å·²ä»˜æ¬¾</span>', 'completed': '<span style="color:#333">å·²çµæ¡ˆ</span>' }; 
                const statusBadge = stMap[b.status] || b.status; 
                const rawDetail = b.service_detail || ""; 
                const details = rawDetail.split('|').map(s => s.trim().split('(')[0].trim()).join(' + '); 
                
                let originalPrice = 0; 
                const matches = rawDetail.match(/\$(\d+)/g); 
                if(matches) matches.forEach(m => originalPrice += parseInt(m.replace('$',''))); 
                if(originalPrice < b.price || originalPrice === 0) originalPrice = b.price; 
                
                let priceInfoHtml = b.coupon_info ? 
                    `<div style="font-size:12px;color:#999;margin-top:5px;">åŸåƒ¹ <span style="text-decoration:line-through;">$${originalPrice}</span></div><div style="font-size:12px;color:#27ae60;">ğŸŸï¸ ${b.coupon_info}</div><div style="font-weight:bold;color:#d35400;">å¯¦ä»˜ $${b.price}</div>` : 
                    `<div style="font-weight:bold;color:#333;margin-top:5px;">$${b.price}</div>`; 
                
                // --- ğŸŒŸ é—œéµé‚è¼¯ä¿®æ”¹é–‹å§‹ ğŸŒŸ ---
                const reportMatch = (b.wish_detail||"").match(/\[å ±å‘Šå·²ç”Ÿæˆ ID:(.*?)\]/); 
                const currentReportId = reportMatch ? reportMatch[1] : null; 
                
                let scheduleHtml = "";
                if (currentReportId) {
                    // å¦‚æœæœ‰å ±å‘Šï¼Œé¡¯ç¤ºå·²å®Œæˆ
                    scheduleHtml = `<div style="color:var(--success); font-weight:bold; font-size:13px; margin-top:4px; background:#e8f5e9; padding:3px 6px; border-radius:4px; display:inline-block;">âœ¨ æœå‹™å·²å®Œæˆ</div>`;
                } else if (b.scheduled_at) {
                    // æ²’å ±å‘Šä½†æœ‰æ’ç¨‹ï¼Œé¡¯ç¤ºæ™‚é–“
                    const t = new Date(b.scheduled_at);
                    const timeStr = `${t.getFullYear()}/${t.getMonth()+1}/${t.getDate()} ${t.getHours().toString().padStart(2,'0')}:${t.getMinutes().toString().padStart(2,'0')}`;
                    scheduleHtml = `<div style="color:#6a1b9a; font-weight:bold; font-size:13px; margin-top:4px; background:#f3e5f5; padding:3px 6px; border-radius:4px; display:inline-block;">ğŸ•’ é è¨ˆæœå‹™ï¼š${timeStr}</div>`;
                }
                // --- ğŸŒŸ é—œéµé‚è¼¯ä¿®æ”¹çµæŸ ğŸŒŸ ---

                let btnHtml = `<div style="font-size:12px; margin-top:5px;">${statusBadge}</div>`; 
                if (currentReportId) { 
                    const targetReport = user.reports.find(r => r.id === currentReportId); 
                    let targetUrl = `viewer.html?id=${currentReportId}`; 
                    if (targetReport && targetReport.raw_data && (targetReport.raw_data.centers || Array.isArray(targetReport.raw_data))) { 
                        targetUrl = `srt_report.html?id=${currentReportId}&mode=view`; 
                    } 
                    btnHtml = `<button class="btn-primary" style="font-size:13px;padding:6px 15px;height:fit-content;" onclick="window.open('${targetUrl}')">æŸ¥çœ‹å ±å‘Š</button>`; 
                } 
                
                return `<div style="border-bottom:1px solid #eee;padding:15px 10px;display:flex;justify-content:space-between;align-items:flex-start;">
                    <div style="flex:1;padding-right:10px;">
                        <span style="font-weight:bold;font-size:15px;display:block;color:var(--forest);">${title}</span>
                        <small style="color:#666;display:block;margin-top:2px;">${details}</small>
                        ${scheduleHtml} 
                        <small style="color:#999; display:block; margin-top:5px;">ä¸‹å–®æ—¥ï¼š${dateStr}</small>
                        ${priceInfoHtml}
                    </div>
                    <div style="text-align:right">${btnHtml}</div>
                </div>`; 
            }).join(''); 
        } 
        
        document.getElementById('dash-history').innerHTML = historyHtml; 
        document.getElementById('c-name').value = user.full_name; 
        document.getElementById('c-phone').value = user.phone; 
        document.getElementById('c-email').value = user.email || ""; 
        document.getElementById('c-phone').disabled = true; 
        document.getElementById('c-name').style.backgroundColor = "#e8f5e9"; 
        const statusEl = document.getElementById('phone-status'); 
        if(statusEl) statusEl.innerHTML = ""; 
        const phoneInput = document.getElementById('c-phone'); 
        if(phoneInput) { phoneInput.style.borderColor = "#ddd"; phoneInput.style.backgroundColor = "#eee"; } 
    }

    function doLogout() { 
        currentUser = null; 
        localStorage.removeItem('peiyu_user'); // ğŸ‘‡ ç™»å‡ºåˆªé™¤ç´€éŒ„
        document.getElementById('login-box').style.display = 'block'; 
        document.getElementById('dash').style.display = 'none'; 
        document.getElementById('c-name').value = ""; 
        document.getElementById('c-phone').value = ""; 
        document.getElementById('c-email').value = ""; 
        document.getElementById('c-phone').disabled = false; 
        document.getElementById('c-name').style.backgroundColor = ""; 
        alert("å·²ç™»å‡º"); 
    }

    function openEditProfile() { 
        if(!currentUser) return; 
        document.getElementById('ep-phone').value = currentUser.phone; 
        document.getElementById('ep-name').value = currentUser.full_name; 
        document.getElementById('ep-email').value = currentUser.email || ""; 
        document.getElementById('ep-pass').value = ""; 
        openModal('edit-profile-overlay'); 
    }

    async function saveProfile() { 
        if(!currentUser) return; 
        const newName = document.getElementById('ep-name').value; 
        const newEmail = document.getElementById('ep-email').value; 
        const newPass = document.getElementById('ep-pass').value; 
        
        const updateData = { full_name: newName, email: newEmail }; 
        if(newPass) updateData.password = newPass; 
        
        const { error } = await myDB.from('profiles').update(updateData).eq('id', currentUser.id); 
        
        if(error) { 
            alert("æ›´æ–°å¤±æ•—: " + error.message); 
        } else { 
            alert("âœ… è³‡æ–™å·²æ›´æ–°ï¼"); 
            currentUser.full_name = newName; 
            currentUser.email = newEmail; 
            document.getElementById('dash-welcome').innerText = `æ‚¨å¥½ï¼Œ${newName}`; 
            document.getElementById('c-name').value = newName; 
            document.getElementById('c-email').value = newEmail; 
            closeModal('edit-profile-overlay'); 
        } 
    }

    // --- éŸ³æ•ˆé­”æ³• ---
    const music = new Audio("https://geyrpowhaqfhnxghpokr.supabase.co/storage/v1/object/public/site-assets/magic.mp3"); 
    music.loop = true; 
    
    const startMagic = () => { 
        music.play().then(() => { 
            music.volume = 0; 
            let vol = 0; 
            const fade = setInterval(() => { 
                if (vol < 0.15) { vol += 0.005; music.volume = vol; } else { clearInterval(fade); } 
            }, 100); 
            ['click', 'scroll', 'touchstart', 'wheel', 'mousedown'].forEach(evt => { window.removeEventListener(evt, startMagic); }); 
        }).catch(err => { console.log("é­”æ³•å•Ÿå‹•å—é˜»...", err); }); 
    }; 
    ['click', 'scroll', 'touchstart', 'wheel', 'mousedown'].forEach(evt => { window.addEventListener(evt, startMagic, { once: true }); });
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸ¹ç™’è©¦é©—å®¤ å¾Œå°ç®¡ç†ç³»çµ±</title>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quill-image-resize-module@3.0.0/image-resize.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@600;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
    /* ======================================================
       1. å…¨ç«™è®Šæ•¸èˆ‡åŸºç¤ä½ˆå±€ (Variables & Base Layout)
       ====================================================== */
    :root { 
        --forest: #1a2f23; --cream: #fdfaf1; --accent: #c6a87c; 
        --dark: #2c3e50; --danger: #e74c3c; --info: #3498db; 
        --success: #27ae60; --warning: #f39c12; --purple: #9b59b6; 
        --shopee: #ff5722; 
    }
    * { box-sizing: border-box; }
    body { 
        font-family: -apple-system, "Microsoft JhengHei", sans-serif; 
        background: #f4f7f6; margin: 0; display: flex; height: 100vh; overflow: hidden; 
    }
    
    /* å´é‚Šå°èˆª (Sidebar) */
    .sidebar { 
        width: 240px; background: var(--forest); height: 100%; color: white; 
        flex-shrink: 0; display: flex; flex-direction: column; 
        overflow-y: auto; transition: width 0.3s ease; overflow-x: hidden; white-space: nowrap; 
    }
    body.hide-nav .sidebar { width: 0; }
    
    .sidebar h2 { 
        text-align: center; color: var(--accent); padding: 25px 0; 
        border-bottom: 1px solid #2a3f33; margin: 0; font-size: 1.2rem; font-family: 'Noto Serif TC', serif; 
    }
    .sidebar button { 
        width: 100%; padding: 18px; background: none; border: none; 
        color: #ccc; text-align: left; cursor: pointer; border-bottom: 1px solid #2a3f33; 
        font-size: 14px; transition: 0.2s; 
    }
    .sidebar button:hover { background: #2a3f33; color: white; }
    .sidebar button.active { 
        background: #2a3f33; color: var(--accent); font-weight: bold; border-left: 5px solid var(--accent); 
    }
    
    /* ä¸»å…§å®¹å€ (Main Content) */
    .main { flex: 1; padding: 30px; overflow-y: auto; background: #f4f7f6; position: relative; }
    .tab-content { display: none; animation: fadeIn 0.3s ease; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* ======================================================
       2. é€šç”¨ UI å…ƒä»¶ (Cards, Buttons, Tables, Tags)
       ====================================================== */
    /* å¡ç‰‡ */
    .card { 
        background: white; padding: 25px; border-radius: 12px; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; 
        border-top: 4px solid var(--accent); overflow-x: auto; 
    }

    /* æŒ‰éˆ• */
    .btn { 
        padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; 
        font-weight: bold; font-size: 13px; transition:0.2s; display: inline-block; 
        margin-right: 5px; text-decoration: none; white-space:nowrap; 
    }
    .btn:hover { opacity: 0.8; transform: translateY(-1px); }
    .btn-forest { background: var(--forest); color: white; }
    .btn-info { background: var(--info); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-warning { background: var(--warning); color: white; }
    .btn-purple { background: var(--purple); color: white; }
    .btn-outline { background: white; border: 1px solid #ccc; color: #666; }
    
    /* è¡¨æ ¼ */
    table { width: 100%; border-collapse: collapse; margin-top: 15px; table-layout: auto !important; }
    th { background: #f8f9fa; color: #666; font-weight: bold; padding: 12px; text-align: left; border-bottom: 2px solid #eee; white-space: nowrap !important; }
    td { padding: 10px 8px !important; text-align: left; border-bottom: 1px solid #eee; font-size: 14px; vertical-align: middle; color: #444; word-break: keep-all !important; white-space: nowrap !important; }
    tr:hover { background: #fdfaf1; }

    /* ç‹€æ…‹æ¨™ç±¤ */
    .tag { padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight:bold; color: white; display: inline-block; margin-right: 3px; }
    .tag-main { background: #d32f2f; }
    .tag-addon { background: #1976d2; }
    .tag-ota { background: #f39c12; }
    .tag-coupon { background: #e91e63; padding: 4px 8px; font-size: 12px; border-radius: 20px; }
    .tag-paid { background: #d4edda; color: #155724; padding: 3px 6px; border-radius: 4px; font-size:12px; }
    .tag-wait { background: #fff3cd; color: #856404; padding: 3px 6px; border-radius: 4px; font-size:12px; }

    /* è¡¨å–®èˆ‡è¼¸å…¥æ¡† */
    input, select, textarea { padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%; box-sizing: border-box; font-size: 14px; margin-bottom: 5px; }
    input:disabled { background: #eee; color: #999; cursor: not-allowed; }
    .finance-nav { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
    .finance-nav button { flex: 1; padding: 10px; border: none; background: #eee; cursor: pointer; border-radius: 8px 8px 0 0; font-weight: bold; color: #666; transition: 0.2s; }
    .finance-nav button.active { background: var(--forest); color: white; }

    /* æœå‹™ç´°é …ç®¡ç†åˆ—è¡¨è¡Œ */
    .admin-row { display: flex; gap: 10px; align-items: center; padding: 12px; border-bottom: 1px solid #eee; background: #fff; transition: 0.2s; }
    .admin-row:hover { background: #f0f7ff; }

    /* SQL æç¤ºæ¡† */
    .sql-hint-box { background: #fff3cd; border: 1px solid #ffeeba; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 12px; color: #856404; position: relative; }
    .sql-code-area { background: #eee; padding: 10px; margin-top: 5px; border-radius: 4px; font-family: monospace; word-break: break-all; }
    .btn-copy-sql { position: absolute; right: 10px; top: 10px; font-size: 11px; padding: 2px 6px; }

    /* é–å±ä»‹é¢ */
    #admin-lock { position: fixed; top:0; left:0; width:100%; height:100vh; background: var(--forest); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
    #admin-lock input { padding: 10px; border-radius: 5px; border: none; width: 200px; margin-bottom: 10px; text-align: center; }

    /* ======================================================
       3. æœˆæ›†èˆ‡æ’ç¨‹ç³»çµ± (Calendar & Schedule)
       ====================================================== */
    /* å¿«é€Ÿæ’ç­æ ¼å­ */
    .batch-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 10px; align-content: start; }
    .batch-slot { position: relative; height: 35px; border: 1px solid #ccc; border-radius: 4px; overflow: hidden; }
    .batch-slot input { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 2; left: 0; top: 0; }
    .batch-slot label { display: flex; justify-content: center; align-items: center; width: 100%; height: 100%; background: #fff; font-size: 13px; color: #333; font-weight: bold; transition: 0.2s; }
    .batch-slot input:checked + label { background: var(--forest); color: white; border-color: var(--forest); }

    /* æœˆæ›†æœ¬é«” */
    #calendar-body { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; background: #fff; margin-top: 15px; padding-bottom: 10px; }
    .cal-week-header { text-align: center; font-weight: bold; color: var(--forest); background-color: #e8f5e9; padding: 8px 0; border-radius: 4px; font-size: 14px; }
    .cal-cell { 
        min-height: 65px; padding: 4px; border: 1px solid #eee; border-radius: 6px; cursor: pointer; transition: 0.2s; 
        display: flex; flex-direction: column; align-items: center; background: #fff; 
    }
    .cal-cell:hover { background: #fdfaf1; border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 3px 8px rgba(0,0,0,0.05); }
    .cal-cell.active { border: 2px solid var(--forest); background: #f4f9f4; }
    .cal-past { background: #f8f8f8; color: #ddd; pointer-events: none; cursor: default; border-color: #eee; }
    .cal-past .cal-stat { opacity: 0.3; filter: grayscale(100%); }
    .cal-date { font-size: 14px; font-weight: bold; color: var(--dark); margin-bottom: 4px; width: 100%; text-align: center; border-bottom: 1px solid #f5f5f5; padding-bottom: 2px; }
    
    /* æœˆæ›†å…§æ¨™ç±¤ */
    .cal-stat { font-size: 11px; padding: 2px 6px; border-radius: 10px; color: white; margin-bottom: 2px; width: 90%; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: normal; }
    .st-free { background-color: #3498db; }
    .st-book { background-color: #e74c3c; }
    .st-off { background-color: #95a5a6; font-weight: bold; color:#fff;}
    .dot-off { position: absolute; top: 5px; right: 5px; font-size: 10px; background: #e74c3c; color: white; padding: 2px 5px; border-radius: 4px; }

    /* å–®æ—¥è©³æƒ… */
    .day-detail-list { display: flex; flex-direction: column; gap: 5px; overflow-y: auto; justify-content: flex-start; }
    .detail-row { flex: 0 0 45px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; background: #fff; border: 1px solid #eee; border-radius: 6px; }
    .detail-row:hover { background: #f0f7ff; border-color: var(--info); }
    .detail-row.booked { background: #fff5f5; border-color: #e74c3c; color: #c0392b; text-decoration: line-through; opacity: 0.7; }
    .detail-chk { width: 18px; height: 18px; cursor: pointer; }
    .day-off-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px; color: #999; }
    .day-off-icon { font-size: 50px; margin-bottom: 10px; color: #e74c3c; }
    
    /* 7æ—¥æ¦‚è¦½ */
    .u-slot { display: inline-block; margin: 3px; padding: 4px 8px; background: #f0f7ff; border: 1px solid #d6e9f9; border-radius: 4px; font-size: 12px; color: #2980b9; }
    .u-slot.booked { background: #fff5f5; border-color: #e74c3c; color: #c0392b; text-decoration: line-through; opacity: 0.7; }

    /* ======================================================
       4. çŸ¥è­˜åº«èˆ‡åœ–åº« (Knowledge Base & Gallery)
       ====================================================== */
    .kb-layout { display: grid; grid-template-columns: 280px 1fr; gap: 20px; height: calc(100vh - 100px); transition: all 0.3s ease; }
    .kb-layout.collapsed { grid-template-columns: 0 1fr; gap: 0; }
    .kb-sidebar { background: #2c3e50; color: #ecf0f1; border-radius: 8px; overflow-y: auto; display: flex; flex-direction: column; overflow-x: hidden; white-space: nowrap; }
    .kb-header { padding: 15px; background: #1a252f; border-bottom: 1px solid #34495e; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; }
    .kb-tree-content { padding: 10px; flex: 1; }
    
    /* KB æ¨¹ç‹€çµæ§‹ */
    details.big-cat { margin-bottom: 5px; }
    details.big-cat > summary { padding: 10px; cursor: pointer; font-weight: bold; list-style: none; border-radius: 4px; color: #ecf0f1; }
    details.big-cat > summary:hover { background: rgba(255,255,255,0.1); }
    details.mid-cat { margin-left: 12px; border-left: 1px solid #555; }
    details.mid-cat > summary { padding: 8px; cursor: pointer; color: #ccc; font-size: 0.95rem; }
    details.mid-cat > summary:hover { color: #fff; }
    .article-item { padding: 8px 10px 8px 20px; cursor: pointer; color: #bdc3c7; display: flex; align-items: center; font-size: 0.95rem; border-radius: 4px; transition: 0.2s; border-bottom: 1px solid #34495e; }
    .article-item:hover { color: #fff; background: rgba(255,255,255,0.05); }
    .article-item.active { color: #fff; background: #c6a87c; font-weight: bold; }
    .article-item.draft { color: #e74c3c; } 
    .article-item.draft::before { content: 'ğŸ”´ '; font-size: 10px; }
    .article-title-span { flex: 1; }

    /* æ’åºæŒ‰éˆ• */
    .sort-actions { display: inline-flex; gap: 2px; margin-right: 8px; vertical-align: middle; }
    .btn-sort-arrow { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: #aaa; cursor: pointer; padding: 0 4px; font-size: 10px; border-radius: 3px; line-height: 1.2; }
    .btn-sort-arrow:hover { background: rgba(255,255,255,0.2); color: #fff; }
    .article-item .sort-actions { margin-right: 10px; opacity: 0.3; transition: 0.2s; }
    .article-item:hover .sort-actions { opacity: 1; }

    /* åœ–åº«èˆ‡å½ˆçª— (Modals) */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; }
    .modal-body { background: white; width: 90%; max-width: 800px; padding: 30px; border-radius: 15px; position: relative; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
    .close-btn { position: absolute; right: 20px; top: 15px; cursor: pointer; font-size: 24px; color: #999; }
    
    .gallery-box { background: white; width: 90%; height: 90%; border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; }
    .gallery-header { padding: 15px 20px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .gallery-grid { flex: 1; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; padding: 20px; background: #fff; }
    .gallery-item { border: 2px solid #eee; border-radius: 6px; overflow: hidden; cursor: pointer; transition: 0.2s; position: relative; aspect-ratio: 1/1; }
    .gallery-item:hover { border-color: #3498db; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .gallery-item img { width: 100%; height: 100%; object-fit: cover; }
    .gallery-item-name { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.6); color: white; font-size: 11px; padding: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center; }

 
/* ======================================================
       5. ç·¨è¼¯å™¨æ¨£å¼ (å¾Œå°åŒæ­¥ç‰ˆï¼šå°é½Š index å‰å°é»ƒé‡‘æ¯”ä¾‹)
       ====================================================== */
    #editor-container { flex: 1; min-height: 200px; display: flex; flex-direction: column; background: white; margin-bottom: 0; border: 1px solid #ccc; overflow: hidden; position: relative; }
    .ql-container { flex: 1; overflow-y: auto; font-size: 16px; font-family: -apple-system, "Microsoft JhengHei", sans-serif; }
    
    /* ğŸ”¥ é—œéµï¼šåŒæ­¥å‰å° index.html çš„ç·¨è¼¯å™¨æœ¬é«”æ¨£å¼ */
    .ql-editor { 
        padding: 30px 40px; /* ç·¨è¼¯å€ç•™ç™½æ–¹ä¾¿æ“ä½œï¼Œé è¦½æ™‚æœƒæ­¸é›¶ */
        color: #2c3e50 !important; /* åŒæ­¥å‰å°æ–‡å­—é¡è‰² */
        font-size: 16px !important; 
        line-height: 1.8 !important; 
        font-family: -apple-system, "Microsoft JhengHei", "Helvetica Neue", sans-serif !important; 
        overflow-wrap: break-word; 
    }

    /* æ¨™é¡Œèˆ‡å­—é«”é¡åˆ¥ */
    .ql-font-serif { font-family: 'Noto Serif TC', serif !important; }
    .ql-font-monospace { font-family: inherit !important; letter-spacing: 0.05em; color: #444; }
    .ql-editor img { max-width: 100%; height: auto; display: block; margin: 20px 0; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    
    /* åŒæ­¥ Tab ç¸®æ’ */
    .ql-editor .ql-indent-1 { padding-left: 3em !important; }
    .ql-editor .ql-indent-2 { padding-left: 6em !important; }
    .ql-editor .ql-indent-3 { padding-left: 9em !important; }

    /* ğŸ”¥ åŒæ­¥åˆ—è¡¨é–“è· (åˆ—è¡¨èˆ‡ä¸Šä¸€æ®µçš„è·é›¢) */
    .ql-editor ul, .ql-editor ol { 
        padding-left: 5px !important; 
        margin-bottom: 5px !important; 
        margin-top: 0 !important; /* index å‰å°ç›®å‰æ˜¯ 0 */
    }

    .ql-editor li { 
        padding-left: 1.2em !important; 
        margin-bottom: 0px !important; 
        margin-top: 8px !important; /* é»é»è¡Œä¹‹é–“çš„é–“è· */
        line-height: 1.3 !important; 
        list-style-position: outside !important; 
    }

    .ql-editor li > p { margin: 0 !important; padding: 0 !important; display: inline-block !important; line-height: 1.3 !important; }
    
    /* é»é»èˆ‡æ–‡å­—è·é›¢ä¿®æ­£ */
    .ql-editor li::before { 
        margin-right: 0.3em !important; 
        width: 1.2em !important; 
        text-align: center !important; 
        display: inline-block !important; 
    }

    /* ğŸ”¥ åŒæ­¥æ¨™é¡Œå¤§å°èˆ‡é‚Šè· */
    .ql-editor .ql-size-small { font-size: 0.85rem; color: #666; line-height: 1.6; }
    .ql-editor .ql-size-large { 
        font-size: 1.5rem !important; 
        font-weight: 900 !important; 
        margin-top: 0px !important; 
        margin-bottom: 15px !important; 
        line-height: 1.4 !important; 
        display: block; 
        color: var(--forest) !important; 
    }
    .ql-editor .ql-size-huge { font-size: 2.2rem !important; font-weight: 900 !important; margin-top: 40px !important; margin-bottom: 25px !important; line-height: 1.2 !important; display: block; color: var(--forest) !important; text-align: center; }
    
    .ql-editor blockquote { border-left: 5px solid var(--shopee, #d35400); background-color: #fffaf0; padding: 15px 20px; margin: 20px 0; color: #8a5a00; font-style: italic; font-weight: bold; }

    /* ğŸ”¥ åŒæ­¥ç‰¹æ®Šè† å›Šæ¨™é¡Œ (é‚Šè· 25px 0 5px 0) */
    .ql-editor h2.title-boxed-h2 { border-left: 8px solid var(--accent); background: var(--forest); color: #fff; padding: 10px 20px; margin: 30px 0 15px 0; border-radius: 4px; font-family: 'Noto Serif TC', serif; font-size: 1.4rem; line-height: 1.4; display: table; box-shadow: 4px 4px 0px rgba(198, 168, 124, 0.4); }
    .ql-editor h3.title-boxed-h3 { border: 2px solid var(--accent); background: #fffcf5; color: var(--forest); display: inline-flex !important; align-items: center !important; justify-content: center; padding: 8px 35px !important; margin: 25px 0 5px 0 !important; border-radius: 50px; font-family: 'Noto Serif TC', serif; width: auto; max-width: 100%; min-height: 50px; }
    .ql-editor h3.title-boxed-h3 .ql-size-large { margin: 0 !important; padding: 0 !important; line-height: 1.2 !important; display: inline !important; border: none !important; color: inherit !important; }
    /* æ ¼å¼åˆ·èˆ‡ HTML ç·¨è¼¯ */
    .painter-active { cursor: copy !important; user-select: none; }
    .ql-format-painter.active { color: var(--forest) !important; font-weight: bold; }
    .html-editor { width: 100%; height: 100%; display: none; background: #1e1e1e; color: #d4d4d4; font-family: 'Consolas', 'Monaco', monospace; font-size: 14px; padding: 20px; border: none; line-height: 1.5; resize: none; outline: none; position: absolute; top: 0; left: 0; z-index: 10; }
    /* =========================================
       ğŸ”¥ æ•¸å€¼é¡¯ç¤ºæ¨™æº–åŒ– (å…¨ç«™çµ±ä¸€)
       ========================================= */
    /* 1. é‡‘é¡ (ç¶ è‰² + ç²—é«” + ç­‰å¯¬å­—) */
    .num-money { 
        color: #27ae60; 
        font-weight: 900; 
        font-family: 'Consolas', 'Monaco', monospace; 
        letter-spacing: -0.5px;
    }
    
    /* 2. è¶´æ•¸/ä½£é‡‘ (æ©˜è‰² + ç²—é«”) */
    .num-rate { 
        color: #d35400; 
        font-weight: 900; 
        font-family: 'Consolas', 'Monaco', monospace;
    }

    /* 3. æŠ˜æ‰£/æ‰“æŠ˜ (æ¡ƒç´…è‰² + ç²—é«”) */
    .num-discount { 
        color: #e91e63; 
        font-weight: 900; 
        font-family: 'Consolas', 'Monaco', monospace;
    }
    /* å¼·åˆ¶æ›è¡Œå·¥å…·ï¼šå°ä»˜é•·ç¶²å€ã€é•·æ–‡å­—ã€æ²’ç©ºæ ¼çš„äº‚ç¢¼ */
    .force-wrap {
        white-space: pre-wrap !important;    /* ä¿ç•™æ›è¡Œä¸¦è‡ªå‹•æ›è¡Œ */
        overflow-wrap: break-word !important; /* ç¾ä»£æ›è¡Œè¦å‰‡ */
        word-break: break-all !important;    /* æš´åŠ›æ›è¡Œï¼Œä¸ç•™æ´»å£ */
        max-width: 100% !important;          /* é™åˆ¶å¯¬åº¦ä¸å‡†æ’é–‹ */
        display: block !important;           /* ç¢ºä¿ä½”æ»¿å®¹å™¨ */
    }
    /* ======================================================
       ğŸ“± RWD è¡Œå‹•ç‰ˆèˆ‡å¹³æ¿å¼·åŠ›å„ªåŒ–è£œä¸
       (é‡å° Schedule æ’ç¨‹ã€KB çŸ¥è­˜åº«ã€è¡¨æ ¼åšç¸½æ•´ç†)
       ====================================================== */
    
    /* é€šç”¨ï¼šè¡¨æ ¼å„ªåŒ– (è®“è¡¨æ ¼å¯ä»¥æ©«å‘æ»‘å‹•ï¼Œä¸æœƒæ’çˆ†ç•«é¢) */
    .card { overflow-x: auto; } 
    table { min-width: 600px; } /* å¼·åˆ¶è¡¨æ ¼ä¿æŒå¯¬åº¦ï¼Œç”¨æ»‘çš„çœ‹ */

    /* ------------------------------------------------------
       iPad ç›´å‘èˆ‡æ‰‹æ©Ÿ (å¯¬åº¦ 1024px ä»¥ä¸‹)
       ------------------------------------------------------ */
    @media (max-width: 1024px) {
        /* 1. å´é‚Šé¸å–® (Sidebar) æ”¹ç‚ºæ¼¢å ¡é¸å–®æ¨¡å¼ */
        body.hide-nav .sidebar { width: 0; }
        .sidebar { position: fixed; left: 0; top: 0; height: 100%; z-index: 2000; box-shadow: 5px 0 15px rgba(0,0,0,0.2); }
        /* é è¨­éš±è—å´é‚Šæ¬„ï¼Œé»æŒ‰éˆ•æ‰å«å‡ºä¾† */
        body:not(.hide-nav) .sidebar { width: 240px; } 
        body:not(.hide-nav) .main::before {
            content: ''; position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.5); z-index: 1999;
        }

        /* 2. æ’ç¨‹ç®¡ç† (Schedule) - é€™æ˜¯æœ€é›£ç”¨çš„åœ°æ–¹ï¼Œæ”¹ç‚ºä¸Šä¸‹å †ç–Š */
        #tab-schedule > div {
            flex-direction: column !important; /* å¼·åˆ¶è®Šæˆç›´æ’ */
            height: auto !important;
            padding-bottom: 50px;
        }
        /* ä¸‰å¤§å€å¡Š (å¿«é€Ÿæ’ç­ã€æœˆæ›†ã€è©³æƒ…) å…¨éƒ¨å¯¬åº¦ 100% */
        #tab-schedule .card { width: 100% !important; margin-bottom: 20px; min-height: auto; }
        
        /* æœˆæ›†æ ¼å­åŠ å¤§ï¼Œæ–¹ä¾¿æ‰‹æŒ‡é»æ“Š */
        .cal-cell { min-height: 80px; }
        
        /* è©³æƒ…å€å¡Šé«˜åº¦é™åˆ¶ */
        #day-detail-container { max-height: 300px; }

        /* 3. çŸ¥è­˜åº« (KB) - æ”¹ç‚ºä¸Šä¸‹å †ç–Š */
        .kb-layout { 
            display: flex !important; 
            flex-direction: column; 
            height: auto !important; 
        }
        .kb-sidebar { 
            height: 300px; /* æ¨¹ç‹€é¸å–®çµ¦å›ºå®šé«˜åº¦ */
            min-height: 300px; 
            margin-bottom: 20px;
            width: 100%;
        }
        /* ç·¨è¼¯å™¨å€åŸŸ */
        #editor-container { min-height: 500px; }
        
        /* 4. è²¡å‹™è¨­å®š (Finance) - å·¦å³æ¬„ä½æ”¹ç›´æ’ */
        #sub-ota input, #sub-ota select, 
        #sub-coupon input, #sub-coupon select { 
            font-size: 16px; /* é˜²æ­¢ iOS è‡ªå‹•æ”¾å¤§ */
        }
        #sub-ota > div > div, 
        #sub-coupon > div > div {
            display: block !important; /* è®“åŸæœ¬ä½µæ’çš„æ¬„ä½è®Šæ›è¡Œ */
            margin-bottom: 15px;
        }
        #sub-ota > div > div > div,
        #sub-coupon > div > div > div {
            width: 100% !important;
            margin-bottom: 10px;
        }
    }

    /* ------------------------------------------------------
       æ‰‹æ©Ÿç‰ˆå°ˆç”¨ (å¯¬åº¦ 768px ä»¥ä¸‹)
       ------------------------------------------------------ */
    @media (max-width: 768px) {
        .main { padding: 15px; } /* ç¸®å°é‚Šè· */
        
        /* æ¨™é¡Œå­—é«”ç¸®å° */
        h2, h3 { font-size: 1.2rem; }
        
        /* éš±è—éå¿…è¦è³‡è¨Š (ä¾‹å¦‚ ID) ä»¥ç¯€çœç©ºé–“ */
        .admin-row { flex-direction: column; align-items: flex-start; }
        .admin-row > div { width: 100%; margin-bottom: 5px; }
        .admin-row button { width: 100%; margin: 2px 0; }

        /* çŸ¥è­˜åº«ç·¨è¼¯å™¨å·¥å…·åˆ— - è®“å®ƒå¯ä»¥æ©«å‘æ»‘å‹•ï¼Œä¸è¦æ“ æˆä¸€åœ˜ */
        .ql-toolbar {
            overflow-x: auto;
            white-space: nowrap;
            padding: 5px !important;
        }
        .ql-formats { display: inline-block; margin-right: 5px !important; }

        /* å½ˆçª— (Modal) å„ªåŒ– */
        .modal-body { width: 95%; padding: 15px; max-height: 85vh; }
        
        /* åˆ—è¡¨æŒ‰éˆ•åŠ å¤§ (æ‰‹æŒ‡å¥½æŒ‰) */
        .btn { padding: 10px 15px; font-size: 14px; }
        
        /* æ’ç¨‹ - å¿«é€Ÿæ’ç­æ ¼å­ */
        .batch-grid { grid-template-columns: repeat(4, 1fr); }
    }
   /* ======================================================
       ğŸ“± æ‰‹æ©Ÿç‰ˆé¸å–®æŒ‰éˆ•ï¼šç§»å‹•åˆ°å·¦ä¸‹è§’ (ä¿®æ­£ç‰ˆ)
       ====================================================== */
    @media (max-width: 1024px) {
        
        /* ğŸ”¥ ä¿®æ­£é¸æ“‡å™¨åç¨±ï¼šå¿…é ˆè·Ÿ HTML çš„ onclick ä¸€æ¨¡ä¸€æ¨£ */
        button[onclick="toggleMainSidebar()"] {
            position: fixed !important;
            
            /* ä½ç½®ï¼šå·¦ä¸‹è§’ */
            bottom: 30px !important;
            left: 20px !important;
            top: auto !important;
            
            /* æ¨£å¼ï¼šåœ“å½¢å¤§æŒ‰éˆ• */
            width: 50px !important;
            height: 50px !important;
            border-radius: 50% !important;
            background-color: var(--forest) !important;
            color: #fff !important;
            border: 2px solid var(--accent) !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4) !important;
            z-index: 3000 !important;
            
            /* å…§å®¹ç½®ä¸­ */
            display: flex !important;
            align-items: center;
            justify-content: center;
        }

        /* åœ–ç¤ºæ”¾å¤§ */
        button[onclick="toggleMainSidebar()"] i { font-size: 24px !important; margin: 0 !important; }
        
        /* éš±è—æ–‡å­—ï¼Œåªç•™åœ–ç¤º (å¦‚æœ HTML å…§æœ‰ icon çš„è©±ï¼Œæ²’æœ‰ä¹Ÿæ²’é—œä¿‚) */
        button[onclick="toggleMainSidebar()"] { font-size: 0 !important; } /* éš±è— "é¸å–®é–‹é—œ" æ–‡å­— */
        button[onclick="toggleMainSidebar()"]::after {
            content: 'â˜°'; /* å¼·åˆ¶åŠ ä¸Šæ¼¢å ¡åœ–ç¤º */
            font-size: 24px;
            color: #fff;
        }
    }
</style>
</head>
<body>

<div id="admin-lock">
    <h2 style="color:var(--accent);">ğŸ”’ åŸ¹ç™’è©¦é©—å®¤å¾Œå°ç®¡ç†</h2>
    <input type="password" id="admin-pwd" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
    <button class="btn btn-warning" onclick="checkAdmin()">é€²å…¥ç³»çµ±</button>
</div>

<div id="gallery-modal" class="modal" style="z-index: 3000;">
    <div class="gallery-box">
        <div class="gallery-header">
            <div style="display:flex; align-items:center; gap:10px;">
                <h3 style="margin:0;">ğŸ–¼ï¸ å…¨åŸŸåœ–åº«</h3>
                <select id="bucket-select" onchange="switchBucket()" style="padding:5px;">
                    <option value="kb-images">æ–‡ç« é…åœ– (kb-images)</option>
                    <option value="site-assets">ç¶²ç«™ç´ æ (site-assets)</option>
                    <option value="banners">æ©«å¹… (banners)</option>
                </select>
            </div>
            <div style="display:flex; gap:10px;">
                <input type="file" id="upload-input" accept="image/*" style="display:none" onchange="uploadImage()">
                <button class="btn btn-forest" onclick="document.getElementById('upload-input').click()">â¬†ï¸ ä¸Šå‚³</button>
                <button class="btn btn-danger" onclick="document.getElementById('gallery-modal').style.display='none'">é—œé–‰</button>
            </div>
        </div>
        <div id="gallery-content" class="gallery-grid"></div>
    </div>
</div>

<div class="sidebar">
    <h2>åŸ¹ç™’è©¦é©—å®¤å¾Œå°</h2>
    <button onclick="switchTab('bks')" id="nav-bks" class="active">ğŸ“… é ç´„çœ‹æ¿</button>
    <button onclick="switchTab('schedule')" id="nav-schedule">ğŸ•’ æ’ç¨‹ç®¡ç†</button>
    <button onclick="switchTab('pro')" id="nav-pro">ğŸ‘¤ å€‹æ¡ˆ CRM</button>
    <button onclick="switchTab('finance')" id="nav-finance">ğŸ’° è²¡å‹™èˆ‡å„ªæƒ åˆ¸</button>
    <button onclick="switchTab('kb')" id="nav-kb">ğŸ“ çŸ¥è­˜åº« (CMS)</button>
    <button onclick="switchTab('menu')" id="nav-menu">âš™ï¸ æœå‹™é…ç½®</button>
    <button onclick="switchTab('announce')" id="nav-announce">ğŸ“¢ å…¬å‘Šç®¡ç†</button>
</div>

<div class="main">
    <button class="btn btn-outline" onclick="toggleMainSidebar()" style="margin-bottom: 15px; padding: 5px 10px;">â˜° é¸å–®é–‹é—œ</button>
    
    <div id="tab-bks" class="tab-content active">
        <div class="dashboard-layout" style="display: grid; grid-template-columns: 2.5fr 1fr; gap: 20px;">
            <div>
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3>ğŸ“‹ è¿‘æœŸé ç´„æ¸…å–®</h3>
                        <button class="btn btn-outline" onclick="fetchAll()">ğŸ”„ åˆ·æ–°</button>
                    </div>
                    <input type="text" id="search-key" placeholder="ğŸ” æœå°‹ å§“å / æ‰‹æ©Ÿ / å–®è™Ÿ / OTA..." style="margin-bottom:15px;" onkeyup="renderBks()">
                    <table>
                        <thead><tr><th width="20%">å–®è™Ÿ/æ—¥æœŸ</th><th width="25%">å€‹æ¡ˆè³‡è¨Š</th><th width="25%">æœå‹™å…§å®¹</th><th width="10%">é‡‘é¡</th><th width="10%">ç‹€æ…‹</th><th width="10%">æ“ä½œ</th></tr></thead>
                        <tbody id="bk-list"></tbody>
                    </table>
                </div>
            </div>
            <div>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <div class="card" style="flex:1; padding:15px; border-top-color:var(--success);">
                        <small>ğŸ’° æœ¬æœˆå¯¦æ”¶</small><h2 id="inc-val" style="margin:5px 0; color:var(--success);">$0</h2>
                    </div>
                    <div class="card" style="flex:1; padding:15px; border-top-color:var(--info);">
                        <small>ğŸ‘¤ ç´¯ç©å€‹æ¡ˆ</small><h2 id="total-val" style="margin:5px 0;">0</h2>
                    </div>
                </div>
                <div class="card" style="border-top-color: var(--purple);">
                    <h3 style="margin-top:0;">ğŸ“… 7æ—¥æ’ç¨‹æ¦‚è¦½</h3>
                    <div id="dashboard-7day-schedule" style="font-size:13px; line-height:1.8;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-schedule" class="tab-content">
        <div style="display: flex; gap: 10px; height: 85vh;">
            
            <div class="card" style="width:240px; flex-shrink:0; display:flex; flex-direction:column; overflow-y:auto;">
                <h4 style="color:var(--forest); margin-top:0;">âš¡ å¿«é€Ÿæ’ç­</h4>
                <div style="display:flex; flex-direction: column; gap:8px; margin-bottom:15px;">
                    <input type="date" id="batch-start" style="width:100%;">
                    <div style="text-align:center; font-size:12px; color:#999;">â¬‡ï¸ è‡³ â¬‡ï¸</div>
                    <input type="date" id="batch-end" style="width:100%;">
                </div>
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <button class="btn btn-outline" style="font-size:10px; flex:1;" onclick="toggleAllSlots(true)">å…¨é¸</button>
                    <button class="btn btn-outline" style="font-size:10px; flex:1;" onclick="toggleAllSlots(false)">æ¸…ç©º</button>
                </div>
                <div id="time-grid" class="batch-grid" style="flex:1; overflow-y:auto;"></div>
                <button class="btn btn-forest" style="width:100%; margin-top:15px;" onclick="batchAddSchedule()">ğŸš€ ç”Ÿæˆ</button>
            </div>

            <div class="card" style="flex:1; display:flex; flex-direction:column; min-width:0;">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <button class="btn btn-outline" onclick="changeMonth(-1)">â—€</button>
                    <h3 id="cal-title" style="margin:0; font-size:1.2rem;">Loading...</h3>
                    <button class="btn btn-outline" onclick="changeMonth(1)">â–¶</button>
                </div>
                <div id="calendar-body" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; flex:1; overflow-y:auto; align-content: start;"></div>
            </div>

            <div class="card" style="width:400px; flex-shrink:0; background:#fdfdfd; display:flex; flex-direction:column;">
                <h4 id="detail-date-title" style="margin-top:0; border-bottom:2px solid var(--accent); padding-bottom:10px;">è«‹é¸æ“‡æ—¥æœŸ</h4>
                <div id="detail-actions" style="display:none; gap:5px; margin-bottom:10px; flex-shrink:0;">
                    <button class="btn btn-outline" style="font-size:12px; flex:1;" onclick="toggleDetailChecks(true)">å…¨é¸</button>
                    <button class="btn btn-outline" style="font-size:12px; flex:1;" onclick="toggleDetailChecks(false)">å–æ¶ˆ</button>
                    <button class="btn btn-danger" style="font-size:12px; flex:1;" onclick="deleteSelectedSlots()">ğŸ—‘ï¸ åˆªé™¤</button>
                    <button class="btn btn-warning" style="font-size:12px; flex:1;" onclick="setDayOff()">â˜• ä¼‘å‡</button>
                </div>
                <div id="day-detail-container" class="day-detail-list" style="flex:1; overflow-y:auto;"></div>
            </div>
        </div>
    </div>

    <div id="tab-pro" class="tab-content">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>ğŸ‘¤ æœƒå“¡ç®¡ç†ç³»çµ± (CRM)</h3>
                <button class="btn btn-outline" onclick="fetchAll()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
            </div>
            <input type="text" id="search-member" placeholder="ğŸ” æœå°‹å§“åæˆ–æ‰‹æ©Ÿ..." onkeyup="renderPro()" style="margin-bottom:15px;">
            <div style="overflow-x: auto;">
                <table>
                    <thead><tr><th width="15%">å§“å</th><th width="15%">æ‰‹æ©Ÿ</th><th width="20%">Email</th><th width="15%">ç´¯ç©æ¶ˆè²»</th><th width="15%">æœ€è¿‘é ç´„</th><th width="20%">æ“ä½œ</th></tr></thead>
                    <tbody id="pro-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-finance" class="tab-content">
        <div class="card">
            <div class="finance-nav">
                <button onclick="switchFinanceSub('ota')" id="btn-sub-ota" class="active">ğŸ’° OTA å¹³å°è¨­å®š</button>
                <button onclick="switchFinanceSub('coupon')" id="btn-sub-coupon">ğŸ« å„ªæƒ åˆ¸ç®¡ç†</button>
            </div>
            <div id="sub-ota">
                <div style="background:#f9f9f9; padding:20px; border-radius:8px; margin-bottom:20px;">
                    <h4 style="margin-top:0; color:#555;">â• æ–°å¢ / ä¿®æ”¹å¹³å°</h4>
                    <input type="hidden" id="ota-id">
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <div style="flex:1"><label>å¹³å°åç¨±</label><input type="text" id="ota-name" placeholder="ä¾‹: è¦çš®è³¼ç‰©"></div>
                        <div style="flex:1"><label>è‹±æ–‡ä»£è™Ÿ</label><input type="text" id="ota-code" placeholder="ä¾‹: shopee"></div>
                        <div style="width:100px;"><label>ä½£é‡‘ %</label><input type="number" id="ota-rate" placeholder="5.5"></div>
                    </div>
                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <div style="flex:1"><label>å‰å°ç¶²å€</label><input type="text" id="ota-front" placeholder="https://..."></div>
                        <div style="flex:1"><label>å¾Œå°ç¶²å€</label><input type="text" id="ota-admin" placeholder="https://..."></div>
                    </div>
                    <div style="text-align:right;">
                        <button class="btn btn-outline" id="btn-ota-cancel" onclick="cancelOTA()" style="display:none; margin-right:5px;">å–æ¶ˆ</button>
                        <button class="btn btn-warning" id="btn-ota-save" onclick="saveOTA()" style="width:150px;">ğŸ’¾ å„²å­˜è¨­å®š</button>
                    </div>
                </div>
                <table><thead><tr><th width="15%">å¹³å°åç¨±</th><th width="10%">ä»£è™Ÿ</th><th width="10%">ä½£é‡‘</th><th width="45%">ç¶²å€é€£çµ</th><th width="20%">æ“ä½œ</th></tr></thead><tbody id="ota-list"></tbody></table>
            </div>

            <div id="sub-coupon" style="display:none;">
                <input type="hidden" id="cp-edit-id">
                <div style="background:#fffcf5; padding:25px; border:1px solid #fae1c3; border-radius:10px; margin-bottom:20px;">
                    <h4 style="margin-top:0; color:#e65100; border-bottom:1px dashed #e65100; padding-bottom:10px; margin-bottom:20px;">ğŸ« å„ªæƒ åˆ¸ç·¨è¼¯å™¨</h4>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:25px;">
                        <div><label>å„ªæƒ åˆ¸åç¨±</label><input type="text" id="cp-name" placeholder="ä¾‹å¦‚ï¼šæ–°æ˜¥èª¿é » 9 æŠ˜"></div>
                        <div><label>å„ªæƒ ä»£ç¢¼ (Code)</label><input type="text" id="cp-code" placeholder="ä¾‹å¦‚ï¼š2026NEW" style="text-transform:uppercase;"></div>
                        
                        <div><label>æŠ˜æ‰£é¡å‹</label><select id="cp-type" onchange="updateCpHint()"><option value="percentage">æ‰“æŠ˜ (Percentage)</option><option value="fixed">æŠ˜æŠµé‡‘é¡ (Fixed Amount)</option></select></div>
                        <div><label id="cp-val-hint">æŠ˜æ‰£æ•¸å€¼ (90 = 9æŠ˜)</label><input type="number" id="cp-val" placeholder="è¼¸å…¥æ•¸å€¼"></div>
                        
                        <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #eee;">
                            <label style="margin-bottom: 8px;">ä½¿ç”¨æœŸé™</label>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <input type="date" id="cp-exp" style="flex:1;">
                                <div style="display:flex; align-items:center; gap:5px; white-space:nowrap;">
                                    <input type="checkbox" id="cp-no-limit" onchange="toggleCpExp()" style="width:18px; height:18px; cursor:pointer;"> 
                                    <label for="cp-no-limit" style="margin:0; cursor:pointer; font-weight:normal;">ç„¡æœŸé™</label>
                                </div>
                            </div>
                        </div>

                        <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #eee;">
                            <label style="margin-bottom: 8px;">é©ç”¨å°è±¡</label>
                            <div style="display:flex; gap:20px; align-items:center; height: 42px;"> 
                                <label style="display:flex; align-items:center; gap:5px; margin:0; cursor:pointer; font-weight:normal;">
                                    <input type="checkbox" id="cp-mem" checked style="width:18px; height:18px;"> éœ€æœƒå“¡
                                </label>
                                <label style="display:flex; align-items:center; gap:5px; margin:0; cursor:pointer; font-weight:normal;">
                                    <input type="checkbox" id="cp-guest" style="width:18px; height:18px;"> è¨ªå®¢å¯ç”¨
                                </label>
                            </div>
                        </div>

                    </div>
                    
                    <div style="text-align:right; margin-top:25px; padding-top:15px; border-top:1px dashed #fae1c3;">
                        <button class="btn btn-outline" id="btn-cp-cancel" onclick="resetCouponForm()" style="display:none; margin-right: 10px;">å–æ¶ˆ</button>
                        <button class="btn btn-forest" id="btn-cp-save" onclick="saveCoupon()" style="padding:10px 40px; font-size:1.1rem;">å»ºç«‹å„ªæƒ åˆ¸</button>
                    </div>
                </div>
                
                <table>
                    <thead><tr><th>åç¨±</th><th>ä»£ç¢¼</th><th>å…§å®¹</th><th>æœŸé™</th><th>å°è±¡</th><th>æ¬¡æ•¸</th><th>æ“ä½œ</th></tr></thead>
                    <tbody id="cp-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-kb" class="tab-content">
        <div class="kb-layout">
            <div class="kb-sidebar">
                <div class="kb-header">
                    <span style="font-weight:bold;">çŸ¥è­˜åº«åˆ—è¡¨</span>
                    <button class="btn btn-success" style="padding:4px 8px; font-size:12px;" onclick="resetKbForm()">ï¼‹ æ–°å¢</button>
                </div>
                <div id="kb-tree" class="kb-tree-content"></div>
            </div>
            <div class="card" style="display:flex; flex-direction:column; overflow-y:hidden; height:100%;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h2 id="mode-title" style="margin:0; color:var(--dark);">æ–°å¢æ–‡ç« </h2>
                    <button class="btn btn-purple" onclick="openGallery()">ğŸ–¼ï¸ é–‹å•Ÿåœ–åº«</button>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr 2fr; gap:15px; margin-bottom:15px;">
                    <div><label style="font-weight:bold;">å¤§åˆ†é¡</label><input list="kb-big-list" id="kb-big" placeholder="ä¾‹: äººé¡åœ–"><datalist id="kb-big-list"></datalist></div>
                    <div><label style="font-weight:bold;">ä¸­åˆ†é¡</label><input list="kb-mid-list" id="kb-mid" placeholder="ä¾‹: é€šé“"><datalist id="kb-mid-list"></datalist></div>
                    <div><label style="font-weight:bold;">æ–‡ç« æ¨™é¡Œ</label><input type="text" id="kb-title" placeholder="è¼¸å…¥æ¨™é¡Œ..."></div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; background:#f1f8e9; padding:10px; border-radius:8px;">
                    <div style="display:flex; gap:5px;">
                        <button class="btn btn-outline" onclick="toggleHtmlMode()" id="btn-html-view" title="åˆ‡æ› HTML æ¨¡å¼"><i class="fa-solid fa-code"></i> HTML</button>
                        <button class="btn btn-outline" onclick="applyBoxedTitle('h2')" title="å¤§æ¨™é¡Œæ¨£å¼"><i class="fa-solid fa-heading"></i> 2</button>
                        <button class="btn btn-outline" onclick="applyBoxedTitle('h3')" title="å°æ¨™é¡Œæ¨£å¼"><i class="fa-solid fa-heading"></i> 3</button>
                    </div>

                    <div style="display:flex; gap:10px; align-items:center;">
                        <label style="display:flex; align-items:center; gap:5px; font-weight:bold; margin:0; cursor:pointer;">
                            <input type="checkbox" id="kb-pub" checked style="width:auto; cursor:pointer;"> å‰å°é¡¯ç¤º
                        </label>
                        <input type="hidden" id="kb-id">
                        <button class="btn btn-danger" onclick="delArticle()" style="display:none;" id="btn-kb-del">åˆªé™¤</button>
                        <button class="btn btn-info" onclick="previewArticle()">ğŸ‘ï¸ é è¦½</button>
                        <button class="btn btn-forest" onclick="saveArticle()">ğŸ’¾ å„²å­˜æ–‡ç« </button>
                    </div>
                </div>

                <div id="editor-container" style="position: relative;">
                    <div id="editor"></div>
                    <textarea id="html-textarea" class="html-editor"></textarea>
                </div>
            </div>
        </div>
    </div>
    
    <div id="tab-announce" class="tab-content">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3>ğŸ“¢ é¦–é å…¬å‘Šç®¡ç†</h3>
                <button class="btn btn-success" onclick="openAnnounceModal()">ï¼‹ æ–°å¢å…¬å‘Š</button>
            </div>
            
            <table class="table">
                <thead>
                    <tr>
                        <th width="8%">æ’åº</th>
                        <th width="27%">æŒ‰éˆ•æ¨™é¡Œ</th>
                        <th width="15%">é¡å‹</th> <th width="15%">ç‹€æ…‹</th>
                        <th width="15%">å»ºç«‹æ™‚é–“</th>
                        <th width="20%">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="announce-list"></tbody>
            </table>
        </div>
    </div>

    <div id="tab-menu" class="tab-content">
        <div style="display:grid; grid-template-columns: 1fr 1.5fr; gap:20px;">
            <div class="card" id="card-cat">
                <h3>ğŸ“‚ å¤§é¡ç®¡ç†</h3>
                <input type="hidden" id="cat-id-edit">
                
                <input type="text" id="cat-name" placeholder="å¤§é¡åç¨± (ä¾‹: äººé¡åœ–è§£è®€)" style="width:100%; margin-bottom:10px; padding:8px;">
                
                <select id="cat-type" style="width:100%; margin-bottom:10px; padding:8px;">
                    <option value="sleep">è©¢å•ç¡çœ  (èª¿é »é¡)</option>
                    <option value="consult">è©¢å•æ—¥æœŸ (è«®è©¢é¡)</option>
                </select>

                <div style="background:#e3f2fd; padding:12px; border-radius:6px; margin-bottom:10px; border:1px solid #bbdefb;">
                    <label style="font-size:12px; color:#1565c0; font-weight:bold; display:block; margin-bottom:8px;">å®¢äººå¯æä¾›è³‡æ–™æ–¹å¼ (å¯è¤‡é¸)ï¼š</label>
                    <div style="display:flex; gap:15px;">
                        <label style="cursor:pointer; display:flex; align-items:center; gap:5px; color:#333;">
                            <input type="checkbox" id="req-birth" value="birth" style="width:18px; height:18px;"> 
                            ğŸ“… å‡ºç”Ÿå¹´æœˆæ—¥
                        </label>
                        <label style="cursor:pointer; display:flex; align-items:center; gap:5px; color:#333;">
                            <input type="checkbox" id="req-image" value="image" style="width:18px; height:18px;"> 
                            ğŸ“¸ ä¸Šå‚³æˆªåœ–
                        </label>
                    </div>
                </div>

                <textarea id="cat-terms" placeholder="æœå‹™è¦ç¯„æ¢æ¬¾" style="width:100%; height:80px; margin-bottom:10px; padding:8px;"></textarea>
                
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-forest" id="btn-cat-save" onclick="saveCategory()">ï¼‹ æ–°å¢</button>
                    <button class="btn btn-outline" id="btn-cat-cancel" onclick="cancelEdit('cat')" style="display:none;">å–æ¶ˆ</button>
                </div>
                <table id="cat-list" style="margin-top:15px;"></table>
            </div>
            
            <div class="card" id="card-svc">
                <h3>âš™ï¸ ç´°é …ç®¡ç†</h3>
                <div class="sql-hint-box">
                    <strong>ğŸ’¡ SQL è£œä¸ï¼š</strong>
                    <button class="btn btn-outline btn-copy-sql" onclick="copySqlCode()">ğŸ“‹ è¤‡è£½ä»£ç¢¼</button>
                    <div class="sql-code-area" id="sql-code-block">ALTER TABLE services ADD COLUMN IF NOT EXISTS report_template TEXT;</div>
                </div>

                <input type="hidden" id="svc-id-edit">
                <select id="svc-cat-filter" style="width:100%; margin-bottom:10px; padding:8px; border:2px solid var(--info); background:#f0f8ff;" onchange="filterServiceList()"><option value="">è¼‰å…¥ä¸­...</option></select>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="i-name" placeholder="é …ç›®å" style="flex:2;">
                    <input type="number" id="i-price" placeholder="åƒ¹æ ¼" style="flex:1;">
                </div>
                <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin:10px 0;">
                    <label style="display:flex; align-items:center; gap:5px; margin-bottom:10px; color:var(--danger); font-weight:bold; cursor:pointer;">
                        <input type="checkbox" id="i-is-main" style="width:18px; height:18px;" onchange="toggleSubOptionInput()"> è¨­ç‚ºä¸»é …ç›® (å–®é¸äº’æ–¥ï¼Œç„¡å­é¸é …)
                    </label>
                    <div id="main-opt-wrapper" style="display:none;">
                        <input type="text" id="i-report-tpl" placeholder="å°æ‡‰å ±å‘Šæª”æ¡ˆ (ä¾‹: srt_report.html)">
                        <small style="color:var(--purple);">ğŸ’¡ è‹¥ç‚ºä¸»é …ç›®ï¼Œè«‹å¡«å¯«æ­¤æ¬„ä»¥é€£çµå ±è¡¨ã€‚</small>
                    </div>
                    <div id="sub-opt-wrapper">
                        <input type="text" id="i-sub-opts" placeholder="å­é¸é … (é€—è™Ÿéš”é–‹)">
                        <small style="color:#666;">ğŸ’¡ åŠ è³¼é …ç›®æ‰éœ€è¦</small>
                    </div>
                </div>
                <div style="display:flex; gap:10px; justify-content: flex-end;">
                    <button class="btn btn-outline" id="btn-svc-cancel" onclick="cancelEdit('svc')" style="display:none;">å–æ¶ˆ</button>
                    <button class="btn btn-forest" id="btn-svc-save" onclick="saveItem()">ï¼‹ æ–°å¢é …ç›®</button>
                </div>
                <div style="max-height:400px; overflow-y:auto; margin-top:15px; border-top:1px solid #eee;" id="svc-list-container">
                    <p style="padding:10px; color:#999;">è«‹å…ˆé¸æ“‡ä¸Šæ–¹çš„å¤§é¡...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modal" class="modal">
    <div class="modal-body">
        <span onclick="closeModal()" class="close-btn">Ã—</span>
        <h2 id="m-title" style="border-bottom:1px solid #eee; padding-bottom:10px; color:var(--forest);">è©³æƒ…</h2>
        <div id="m-content"></div>
    </div>
</div>

<div id="announce-modal" class="modal">
    <div class="modal-body" style="max-width: 800px;">
        <span onclick="closeAnnounceModal()" class="close-btn">Ã—</span>
        <h2 id="anc-modal-title" style="border-bottom:1px solid #eee; padding-bottom:10px;">æ–°å¢å…¬å‘Š</h2>
        
        <input type="hidden" id="anc-id">
        <div style="display:grid; grid-template-columns: 2fr 1fr; gap:15px; margin-bottom:15px;">
            <div><label>æŒ‰éˆ•æ¨™é¡Œ</label><input type="text" id="anc-title" placeholder="ä¾‹å¦‚ï¼šğŸ‰ é–‹å¹•æ…¶"></div>
            <div><label>æ’åº (å°è‡³å¤§)</label><input type="number" id="anc-order" value="1"></div>
        </div>
        
        <div style="margin-bottom:15px;">
            <label>ç‹€æ…‹</label>
            <select id="anc-active">
                <option value="true">ğŸŸ¢ ä¸Šæ¶é¡¯ç¤º</option>
                <option value="false">ğŸ”´ ä¸‹æ¶éš±è—</option>
            </select>
        </div>
        <div style="margin-bottom:15px;">
            <label>å…¬å‘Šé¡å‹</label>
            <select id="anc-type">
                <option value="must_read">ğŸ“˜ å¿…è®€å°ˆå€ (å¸¸é§)</option>
                <option value="temp">ğŸ”¥ è‡¨æ™‚å¿«è¨Š (æ´»å‹•/å…¬ä¼‘)</option>
            </select>
        </div>
       <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
            <label style="margin:0;">å½ˆçª—å…§å®¹ (æ”¯æ´ HTML)</label>
            <button class="btn btn-outline" onclick="copyTemplate()" style="font-size:12px; padding:4px 10px; background:#fff; border:1px solid #666; color:#666;">
                ğŸ“‹ è¤‡è£½æ¨™æº–ç¯„æœ¬ (çµ¦AIç”¨)
            </button>
        </div>
        
        <textarea id="anc-content" style="height: 200px; font-family: monospace;" placeholder="è«‹è¼¸å…¥å…§å®¹ HTML..."></textarea>
        <div style="text-align:right; margin-top:20px;">
            <button class="btn btn-forest" onclick="saveAnnouncement()">ğŸ’¾ å„²å­˜å…¬å‘Š</button>
        </div>
    </div>
</div>

<script>
    const SB_URL = "https://geyrpowhaqfhnxghpokr.supabase.co";
    const SB_KEY = "sb_publishable_aXucdq8UtvMbCKbriqpJCw_gtpYBw-r";
    const myDB = supabase.createClient(SB_URL, SB_KEY);
    const cleanPhone = (p) => p ? p.replace(/\D/g, '') : '';
    
    let cache = { bks:[], pros:[], cats:[], svcs:[], slots:[], otas:[], coupons:[], articles:[] };
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth() + 1;
    let selectedDateStr = "";
    let currentBucket = 'kb-images';
    let kbCatOrder = { big: [], mid: {} };

    const STATUS_MAP = {
        'paid': '<span class="tag tag-paid">å·²ä»˜æ¬¾</span>',
        'pending': '<span class="tag tag-wait">æœªä»˜æ¬¾</span>',
        'awaiting_payment': '<span class="tag tag-wait">å¾…ç¢ºèª</span>',
        'awaiting_service': '<span class="tag tag-ota">æœå‹™ä¸­</span>',
        'completed': '<span class="tag" style="background:#333">å·²çµæ¡ˆ</span>'
    };

    const BaseImage = Quill.import('formats/image');
    class CustomImage extends BaseImage {
        static formats(domNode) { return ['alt', 'height', 'width', 'style'].reduce((f, a) => { if (domNode.hasAttribute(a)) f[a] = domNode.getAttribute(a); return f; }, {}); }
        format(name, value) { if (['alt', 'height', 'width', 'style'].indexOf(name) > -1) { if (value) this.domNode.setAttribute(name, value); else this.domNode.removeAttribute(name); } else super.format(name, value); }
    }
    Quill.register({ 'formats/image': CustomImage }, true);
    
    var Font = Quill.import('formats/font');
    Font.whitelist = ['serif', 'sans-serif', 'monospace'];
    Quill.register(Font, true);

    if (window.QuillBetterTable) {
        Quill.register({ 'modules/better-table': window.QuillBetterTable }, true);
    }

    var painterFormat = null;
    var isPainterOn = false;

    var quill = new Quill('#editor', {
        theme: 'snow',
        modules: { 
            imageResize: { displaySize: true }, 
            table: false, 
            'better-table': window.QuillBetterTable ? {
                operationMenu: { items: { unmergeCells: { text: 'å–æ¶ˆåˆä½µ' } }, color: { text: 'èƒŒæ™¯é¡è‰²' } }
            } : null,
            keyboard: { 
                bindings: Object.assign({}, 
                    (window.QuillBetterTable ? window.QuillBetterTable.keyboardBindings : {}), 
                    {
                        'linebreak': { key: 13, shiftKey: true, handler: function() { const range = this.quill.getSelection(); if (range) { this.quill.insertText(range.index, '\n'); this.quill.setSelection(range.index + 1); } return false; } },
                        'exitPainter': { key: 27, handler: function() { turnOffPainter(); return true; } }
                    }
                )
            },
            toolbar: {
                container: [
                    [{ 'font': [] }, { 'size': ['small', false, 'large', 'huge'] }], 
                    [{ 'header': [1, 2, 3, false] }], 
                    ['bold', 'italic', 'underline', 'strike'], 
                    [{ 'color': [] }, { 'background': [] }], 
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }], 
                    [{ 'indent': '-1'}, { 'indent': '+1' }], 
                    [{ 'align': [] }], 
                    ['blockquote'], 
                    ['format-painter'], 
                    ['link', 'image'], 
                    window.QuillBetterTable ? ['table-btn'] : [], 
                    ['clean']
                ],
                handlers: {
                    'table-btn': function() { if(window.QuillBetterTable) this.quill.getModule('better-table').insertTable(3, 3); },
                    'format-painter': function() { if (isPainterOn) { turnOffPainter(); } else { var range = this.quill.getSelection(); if (range) { painterFormat = this.quill.getFormat(range); isPainterOn = true; document.querySelector('.ql-editor').classList.add('painter-active'); document.querySelector('.ql-format-painter').classList.add('active'); } } }
                }
            }
        },
        placeholder: 'åœ¨æ­¤è¼¸å…¥å…§å®¹...'
    });

    function turnOffPainter() { isPainterOn = false; painterFormat = null; document.querySelector('.ql-editor').classList.remove('painter-active'); document.querySelector('.ql-format-painter').classList.remove('active'); }
    quill.on('selection-change', function(range, oldRange, source) { if (source === 'user' && range && range.length > 0 && isPainterOn && painterFormat) { for (let format in painterFormat) { quill.formatText(range.index, range.length, format, painterFormat[format]); } } });
    setTimeout(() => { if(window.QuillBetterTable) { const btn = document.querySelector('.ql-table-btn'); if(btn) btn.innerHTML = '<i class="fa-solid fa-table"></i>'; } const painterBtn = document.querySelector('.ql-format-painter'); if(painterBtn) { painterBtn.innerHTML = '<i class="fa-solid fa-paint-roller"></i>'; painterBtn.title = "æ ¼å¼åˆ· (é»ä¸€ä¸‹é–å®šï¼Œå†é»ä¸€ä¸‹è§£é™¤)"; } }, 100);

    async function fetchAll() {
        try {
            console.log("ğŸš€ æ­£åœ¨è®€å–è³‡æ–™...");
            let ar = await myDB.from('kb_articles').select('*').order('sort_order');
            if (ar.error) ar = await myDB.from('kb_articles').select('*').order('created_at', {ascending:false});

            const [b, p, c, s, sl, o, cp, cfg] = await Promise.all([
                myDB.from('bookings').select('*').order('created_at', {ascending:false}).limit(100),
                myDB.from('profiles').select('*').order('created_at', {ascending:false}),
                myDB.from('service_categories').select('*').order('created_at'),
                myDB.from('services').select('*').order('sort_order'),
                myDB.from('schedule_slots').select('*').order('slot_date').order('slot_time'),
                myDB.from('ota_settings').select('*'),
                myDB.from('coupons').select('*').order('created_at', {ascending:false}),
                myDB.from('site_content').select('content').eq('title', 'kb_category_order').single()
            ]);

            cache = { 
                bks: (b.data || []).map(bk => ({ ...bk, profiles: (p.data || []).find(pr => pr.id === bk.user_id) || null })), 
                pros: p.data||[], cats: c.data||[], svcs: s.data||[], slots: sl.data||[], otas: o.data||[], 
                coupons: cp.data||[], articles: ar.data||[] 
            };

            if (cfg.data && cfg.data.content) { kbCatOrder = cfg.data.content; } else { kbCatOrder = { big: [], mid: {} }; }
            if(typeof syncKbOrderKeys === 'function') syncKbOrderKeys();

            renderBks(); renderPro(); renderConfigTables(); renderCalendar(); renderFinance(); 
            if(typeof renderKbTree === 'function') renderKbTree(); 
            if(typeof render7DaySchedule === 'function') render7DaySchedule();
            if(typeof fetchAnnouncements === 'function') fetchAnnouncements();
            if (document.getElementById('svc-cat-filter')?.value) filterServiceList();
            console.log("âœ… è³‡æ–™è®€å–æˆåŠŸï¼");
        } catch (e) { console.error(e); alert("è¼‰å…¥å¤±æ•—: " + e.message); }
    }

    async function checkAdmin() {
        const k = document.getElementById('admin-pwd').value;
        const b = document.querySelector('#admin-lock button');
        
        const _0x1a2b = "YmFjb24zMTA=";

        try {
            if (btoa(k) !== _0x1a2b) throw new Error("Invalid Configuration");

            localStorage.setItem('sys_cfg_v1', _0x1a2b); 

            b.innerText = "è¼‰å…¥ä¸­..."; 
            b.disabled = true;
            
            await fetchAll(); 
            document.getElementById('admin-lock').style.display = 'none'; 
            document.querySelector('.main').style.display = 'block'; 
            renderTimeGrid(); 

        } catch(e) {
            console.error(e);
            alert("âŒ ç³»çµ±å­˜å–æ‹’çµ• (Access Denied)");
        }
    }
    function renderBks() {
        const search = document.getElementById('search-key').value.trim().toUpperCase();
        document.getElementById('bk-list').innerHTML = cache.bks.filter(x => !search || JSON.stringify(x).toUpperCase().includes(search)).map(x => {
            const hasPro = !!x.profiles;
            let guestName = '', guestEmail = '';
            if (x.wish_detail) {
                const nm = x.wish_detail.match(/å§“å:(.*?) \|/);
                const em = x.wish_detail.match(/Email:(.*?) \|/);
                if (nm) guestName = nm[1].trim();
                if (em) guestEmail = em[1].trim();
            }
            let otaTag = '';
            if (x.ota_order_id) {
                const otaName = cache.otas.find(o => o.code === x.ota_source)?.name || 'OTA';
                otaTag = `<br><span class="tag tag-ota">${otaName} #${x.ota_order_id.slice(-5)}</span>`;
            } else if (x.payment_method === 'shopee') otaTag = `<br><span class="tag tag-ota">è¦çš®(èˆŠ)</span>`;

            const safeName = guestName.replace(/'/g, "&apos;"); const safeEmail = guestEmail.replace(/'/g, "&apos;");
            let userHtml = hasPro ? `<b>${x.profiles.full_name}</b><br><small>${x.profiles.phone}</small>` : `<b>${x.temp_phone}</b><br><button class="btn btn-info" style="font-size:10px;padding:2px;" onclick="openCreateMemberModal('${x.temp_phone}', '${x.id}', '${safeName}', '${safeEmail}')">ï¼‹å»ºç«‹</button>`;
            let serviceHtml = `<div style="font-weight:bold; color:#2c3e50; font-size:15px;">${x.service_item || 'æœªçŸ¥é¡åˆ¥'}</div>`;
            let moneyHtml = `<div style="font-weight:bold; font-size:16px;">$${x.price}</div>`;
            if (x.coupon_info) moneyHtml += `<div style="font-size:11px; color:#e91e63; margin-top:2px;">ğŸŸï¸ ${x.coupon_info.split('(')[0]}</div>`;

            return `<tr><td><small>${x.created_at.slice(0,10)}</small><br><small>${x.booking_id.slice(-6)}</small>${otaTag}</td><td>${userHtml}</td><td>${serviceHtml}</td><td>${moneyHtml}</td><td>${STATUS_MAP[x.status] || x.status}</td><td><button class="btn btn-forest" onclick="openBooking('${x.id}')">è©³æƒ…</button><button class="btn btn-danger" onclick="deleteBooking('${x.id}')" style="padding:2px 8px;">åˆª</button></td></tr>`;
        }).join('');

        const m = new Date().toISOString().slice(0, 7);
        const inc = cache.bks.filter(x => (x.status === 'paid' || x.status === 'completed') && x.created_at.startsWith(m)).reduce((s, x) => s + (x.price || 0), 0);
        if(document.getElementById('inc-val')) document.getElementById('inc-val').innerText = "$" + inc.toLocaleString();
        if(document.getElementById('total-val')) document.getElementById('total-val').innerText = cache.pros.length;
    }

    function openCreateMemberModal(phone, bookingId, name, email) {
        // 1. è®Šæ•¸åˆå§‹åŒ–
        const defaultPwd = phone && phone.length >= 4 ? 'guest' + phone.slice(-4) : 'guest1234';
        const initName = (name && name !== 'undefined') ? name : '';
        const initEmail = (email && email !== 'undefined') ? email : '';
        
        // 2. è¨­å®šå½ˆçª—æ¨™é¡Œ
        document.getElementById('m-title').innerText = "ğŸ‘¤ å»ºç«‹æ–°æœƒå“¡";

        // 3. è¨­å®šå½ˆçª—å…§å®¹ (æ’ç‰ˆæ•´ç†å¾Œçš„ HTML)
        document.getElementById('m-content').innerHTML = `
            <div style="padding: 10px;">
                
                <div style="margin-bottom: 15px;">
                    <label style="font-weight: bold; color: var(--forest); display: block;">å§“å *</label>
                    <input type="text" id="new-name" value="${initName}" placeholder="è«‹è¼¸å…¥å®¢æˆ¶å§“å" style="margin-top: 5px;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="font-weight: bold; color: var(--forest); display: block;">æ‰‹æ©Ÿ * (å¸³è™Ÿ)</label>
                    <input type="text" id="new-phone" value="${phone || ''}" style="margin-top: 5px;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="font-weight: bold; color: #666; display: block;">Email (é¸å¡«)</label>
                    <input type="text" id="new-email" value="${initEmail}" placeholder="example@mail.com" style="margin-top: 5px;">
                </div>

                <div style="margin-bottom: 25px;">
                    <label style="font-weight: bold; color: #666; display: block;">é è¨­å¯†ç¢¼</label>
                    <input type="text" id="new-pwd" value="${defaultPwd}" style="margin-top: 5px; background: #eee;" readonly>
                    <small style="color: #999; display: block; margin-top: 4px;">é è¨­ç‚º guest + æ‰‹æ©Ÿæœ« 4 ç¢¼</small>
                </div>

                <div style="text-align: right; border-top: 1px solid #eee; padding-top: 20px;">
                    <button class="btn btn-forest" onclick="saveNewMember('${bookingId}')" style="width: 100%; padding: 12px; font-size: 1.1rem;">
                        ç¢ºèªå»ºç«‹ä¸¦æ­¸æˆ¶
                    </button>
                </div>

            </div>
        `;
        
        // 4. é¡¯ç¤ºå½ˆçª—
        document.getElementById('modal').style.display = 'flex';
    }

    async function saveNewMember(bookingId) {
        const n = document.getElementById('new-name').value.trim();
        const p = document.getElementById('new-phone').value.trim();
        const e = document.getElementById('new-email').value.trim();
        const pwd = document.getElementById('new-pwd').value.trim();
        if (!n || !p) return alert("âŒ å§“åèˆ‡æ‰‹æ©Ÿç‚ºå¿…å¡«æ¬„ä½");

        let targetUserId = null; let isNew = false;
        const { data, error } = await myDB.from('profiles').insert([{ full_name: n, phone: p, email: e, password: pwd, role: 'member' }]).select().single();
        if (error) { if (error.code === '23505') { const { data: existUser } = await myDB.from('profiles').select('id').eq('phone', p).single(); if (existUser) targetUserId = existUser.id; else return alert("âŒ æ‰¾ä¸åˆ°è©²æœƒå“¡è³‡æ–™"); } else return alert("âŒ ç³»çµ±éŒ¯èª¤: " + error.message); } else { targetUserId = data.id; isNew = true; }

        if (targetUserId) {
            const { data: updatedBks, error: linkErr } = await myDB.from('bookings').update({ user_id: targetUserId }).eq('temp_phone', p).is('user_id', null).select();
            let msg = isNew ? `âœ… æœƒå“¡ ${n} å»ºç«‹æˆåŠŸï¼` : `âœ… åµæ¸¬åˆ°æœƒå“¡å·²å­˜åœ¨ï¼ŒåŸ·è¡Œè‡ªå‹•æ­¸æˆ¶ï¼`;
            if (!linkErr && updatedBks && updatedBks.length > 0) msg += `\nğŸ”— å·²å°‡ ${updatedBks.length} ç­†è¨‚å–®æ­¸æˆ¶æˆåŠŸï¼`;
            alert(msg); closeModal(); fetchAll();
        }
    }

    function openBooking(id) {
        const b = cache.bks.find(x => x.id === id); 
        if(!b) return alert("æ‰¾ä¸åˆ°è¨‚å–®");
        
        // --- è³‡æ–™è™•ç†å€ ---
        const rawDetail = b.wish_detail || '';
        const urlMatch = rawDetail.match(/(https?:\/\/[^\s|]+)/);
        const screenshotBtn = urlMatch ? `<a href="${urlMatch[0]}" target="_blank" class="btn btn-outline" style="color:#3498db; border-color:#3498db;">ğŸ–¼ï¸ æŸ¥çœ‹æˆªåœ–è­‰æ“š</a>` : `<span style="color:#999; font-size:12px;">(ç„¡æˆªåœ–)</span>`;
        let displayData = rawDetail.replace(/(https?:\/\/[^\s|]+)/g, '').replace(/æˆªåœ–[:ï¼š]\s*/g, '').replace(/\|? ?å§“å:.*? \|/g, '').replace(/\|? ?Email:.*? \|/g, '').replace(/\|? ?æ•¸æ“š: ?/g, '').replace(/\| \[QRå·²å‚³.*?\]/g, '').trim();
        
        let extractName = "æœªçŸ¥", extractEmail = "æœªçŸ¥";
        const nm = rawDetail.match(/å§“å:(.*?) \|/); const em = rawDetail.match(/Email:(.*?) \|/);
        if(nm) extractName = nm[1].trim(); if(em) extractEmail = em[1].trim();

        let serviceHtml = `<div style="font-size:1.1rem; font-weight:bold; color:#2c3e50;">ğŸ“‚ ${b.service_item || 'æœªçŸ¥å¤§é¡'}</div>`;
        if (b.main_service) serviceHtml += `<div style="color:#d35400; font-weight:bold; font-size:1.2rem; margin-top:5px; padding-left:5px;">ğŸ”¥ ${b.main_service}</div>`;
        if (b.service_detail) serviceHtml += `<div style="color:#666; font-size:0.95rem; margin-top:8px; padding-left:15px; border-left:3px solid #eee;">${b.service_detail.split('|').map(s => `<div style="margin-top:3px;">â• ${s.trim()}</div>`).join('')}</div>`;
        
        const mainService = (cache.svcs || []).find(s => s.is_main && (b.main_service === s.title || (b.service_detail||'').includes(s.title)));
        let btnLabel = "ğŸ“„ ç”Ÿæˆæœå‹™å ±å‘Š", btnClass = "btn-forest";
        let reportTemplate = (mainService && mainService.report_template) ? mainService.report_template : "srt_report.html";
        const reportMatch = rawDetail.match(/\[å ±å‘Šå·²ç”Ÿæˆ ID:(.*?)\]/);
        const existingReportId = reportMatch ? reportMatch[1] : null;
        let reportUrl = existingReportId ? `${reportTemplate}?id=${existingReportId}` : `${reportTemplate}?bid=${b.id}&name=${encodeURIComponent(extractName)}&phone=${b.temp_phone}&email=${encodeURIComponent(extractEmail)}`;        if(existingReportId) { btnLabel = "ğŸ“„ æŸ¥çœ‹/ä¿®æ”¹å ±å‘Š"; btnClass = "btn-purple"; }
        let scheduleBox = '';
        if(b.scheduled_at) { scheduleBox = `<div style="background:#f0f8ff; padding:12px; border-left:4px solid #3498db; border-radius:4px; margin-top:15px;"><div style="display:flex; justify-content:space-between; align-items:center;"><strong style="color:#2980b9;">ğŸ“… å·²é–å®šæœå‹™æ’ç¨‹</strong><button class="btn btn-outline" style="font-size:12px; background:white;" onclick="document.getElementById('reschedule-area').style.display='block'; this.style.display='none';">âœï¸ ä¿®æ”¹</button></div><div style="font-size:1.2rem; color:#2c3e50; margin-top:5px; font-weight:bold;">${new Date(b.scheduled_at).toLocaleString()}</div><div id="reschedule-area" style="display:none; margin-top:10px;"><div style="display:flex; gap:10px;"><input type="date" id="book-date" onchange="loadSlotsForBooking(this.value)"><select id="book-slot"><option>å…ˆé¸æ—¥æœŸ</option></select></div><button class="btn btn-purple" style="width:100%; margin-top:5px;" onclick="confirmSchedule('${b.id}')">ç¢ºèªè®Šæ›´</button></div></div>`; }
        else if(b.status === 'paid' || b.status === 'awaiting_service') { scheduleBox = `<div style="background:#fff3e0; padding:12px; border-left:4px solid #f39c12; border-radius:4px; margin-top:15px;"><strong style="color:#e67e22;">â³ ç­‰å¾…æ’ç¨‹</strong><div style="display:flex; gap:10px; margin-top:5px;"><input type="date" id="book-date" onchange="loadSlotsForBooking(this.value)"><select id="book-slot"><option>å…ˆé¸æ—¥æœŸ</option></select></div><button class="btn btn-purple" style="width:100%; margin-top:5px;" onclick="confirmSchedule('${b.id}')">ç¢ºèªé–å®šæ™‚æ®µ</button></div>`; }

        const reportArea = (b.status === 'awaiting_service' || b.status === 'completed') ? `<div style="margin-top:20px; padding-top:10px; border-top:1px dashed #eee;"><a href="${reportUrl}" target="_blank" class="btn ${btnClass}" style="display:block; width:100%; text-align:center;">${btnLabel}</a></div>` : '';
        const couponBadge = b.coupon_info ? `<div style="display:inline-block; background:#fce4ec; color:#c2185b; font-size:12px; padding:2px 8px; border-radius:10px; margin-top:5px;">ğŸŸï¸ ${b.coupon_info}</div>` : '';

        // --- å½ˆçª—é¡¯ç¤ºå€ (ä¿®æ­£ç‰ˆï¼šæ¶ˆé™¤ç©ºç™½) ---
        document.getElementById('m-title').innerHTML = `è¨‚å–®è©³æƒ… <span style="font-size:12px; color:#999;">${b.booking_id}</span>`;
        document.getElementById('m-content').innerHTML = `
            <div style="display:flex; gap:15px; align-items:center; margin-bottom:15px;">
                <div style="width:50px; height:50px; background:var(--forest); color:white; border-radius:50%; display:flex; justify-content:center; align-items:center; font-size:20px; font-weight:bold;">
                    ${extractName[0]}
                </div>
                <div>
                    <div style="font-weight:bold; font-size:1.1rem;">${extractName}</div>
                    <div style="color:#666;">${b.temp_phone}</div>
                    <div style="color:#888; font-size:0.8rem;">${extractEmail}</div>
                </div>
            </div>

            <div style="background:#fafafa; padding:15px; border-radius:8px; border:1px solid #eee;">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div style="flex:1;">${serviceHtml}</div>
                    <b style="color:#d35400; font-size:1.2rem; white-space:nowrap;">$${b.price}</b>
                </div>
                ${couponBadge}
            </div>

            <div style="margin-top:15px; padding:10px; background:white; border:1px solid #eee; border-radius:4px;">
                <label style="color:#999; font-size:12px;">æ•¸æ“šèˆ‡å‚™è¨»</label>
                <div class="force-wrap" style="margin-top:5px; line-height:1.5; font-size:14px;">${displayData || 'ç„¡'}</div>
                <div style="margin-top:5px; font-weight:bold; color:#e67e22;">
                    è¨±é¡˜æ™‚é–“ï¼š${b.sleep_time || 'ç„¡'}
                </div>
                <div style="margin-top:10px; padding-top:5px; border-top:1px dashed #eee;">
                    ${screenshotBtn}
                </div>
            </div>

            ${b.case_story ? `
                <div style="margin-top:15px; padding:12px; background:#fdfaf5; border:1px solid #fae1c3; border-radius:8px;">
                    <label style="color:#1a2f23; font-weight:bold; font-size:13px;">ğŸ“– å®¢äººèªªçš„æ•…äº‹ï¼š</label>
                    <div class="force-wrap" style="margin-top:5px; line-height:1.6; color:#444; font-size:14px;">${b.case_story}</div>
                </div>` : ''
            }

            ${scheduleBox}
            ${reportArea}
            <div style="margin-top:20px; text-align:right;">
                ${renderActionButtons(b)}
            </div>
        `;
        
        document.getElementById('modal').style.display = 'flex';
        document.querySelector('.modal-body').scrollTop = 0;
    }
        
    function toggleKbSidebar() { document.querySelector('.kb-layout').classList.toggle('collapsed'); }
    async function editKb(id) {
        try { const {data, error} = await myDB.from('kb_articles').select('*').eq('id',id).single(); if(error || !data) return alert("è®€å–å¤±æ•—"); document.getElementById('kb-id').value = data.id; document.getElementById('kb-title').value = data.title; document.getElementById('kb-big').value = data.big_category; document.getElementById('kb-mid').value = data.mid_category; document.getElementById('kb-pub').checked = data.is_published; if(quill) quill.root.innerHTML = data.body || ''; document.getElementById('btn-kb-del').style.display = 'inline-block'; document.getElementById('mode-title').innerText = "ç·¨è¼¯æ–‡ç« "; } catch (e) { alert("é–‹å•Ÿæ–‡ç« å¤±æ•—: " + e.message); }
    }
    function resetKbForm(){ document.getElementById('kb-id').value=''; document.getElementById('kb-title').value=''; document.getElementById('kb-big').value=''; document.getElementById('kb-mid').value=''; if(quill) quill.root.innerHTML=''; document.getElementById('btn-kb-del').style.display='none'; document.getElementById('mode-title').innerText="æ–°å¢æ–‡ç« "; }
    async function saveArticle() {
        if (typeof isHtmlMode !== 'undefined' && isHtmlMode) quill.root.innerHTML = document.getElementById('html-textarea').value;
        const p = { title: document.getElementById('kb-title').value, big_category: document.getElementById('kb-big').value, mid_category: document.getElementById('kb-mid').value, is_published: document.getElementById('kb-pub').checked, body: quill ? quill.root.innerHTML : '' };
        const id = document.getElementById('kb-id').value;
        if (!p.title || !p.big_category) return alert("æ¨™é¡Œ/åˆ†é¡å¿…å¡«");
        try { if (id) await myDB.from('kb_articles').update(p).eq('id', id); else { const { data } = await myDB.from('kb_articles').select('sort_order').order('sort_order', { ascending: false }).limit(1); p.sort_order = (data && data.length) ? data[0].sort_order + 1 : 1; await myDB.from('kb_articles').insert([p]); } alert("âœ… å·²å„²å­˜"); fetchAll(); if (!id) resetKbForm(); } catch (e) { alert("å„²å­˜å¤±æ•—: " + e.message); }
    }
    async function delArticle(){ if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { await myDB.from('kb_articles').delete().eq('id',document.getElementById('kb-id').value); alert("å·²åˆªé™¤"); resetKbForm(); fetchAll(); } }
    function previewArticle() { const title=document.getElementById('kb-title').value, html=quill ? quill.root.innerHTML : '', isPub=document.getElementById('kb-pub').checked; document.getElementById('m-title').innerText="å‰å°é è¦½"; document.getElementById('m-content').innerHTML=`<div style="font-family:sans-serif;padding:10px;">${!isPub?'<div style="color:red">(éš±è—)</div>':''}<h1>${title}</h1><div class="ql-editor" style="padding:0;">${html}</div></div>`; document.getElementById('modal').style.display='flex'; }
    async function openGallery(){document.getElementById('gallery-modal').style.display='flex';loadGalleryImages();}
    function closeGallery(){document.getElementById('gallery-modal').style.display='none';}
    function switchBucket(){currentBucket=document.getElementById('bucket-select').value;loadGalleryImages();}
    async function loadGalleryImages(){const g=document.getElementById('gallery-content');g.innerHTML="è®€å–ä¸­...";const{data}=await myDB.storage.from(currentBucket).list('',{limit:100,sortBy:{column:'created_at',order:'desc'}});if(!data){g.innerHTML="å¤±æ•—";return;}g.innerHTML=data.map(f=>{if(f.name==='.emptyFolderPlaceholder')return'';const u=myDB.storage.from(currentBucket).getPublicUrl(f.name).data.publicUrl;return `<div class="gallery-item" onclick="insertImageToEditor('${u}')"><img src="${u}"><div class="gallery-item-name">${f.name}</div></div>`;}).join('');}
    function insertImageToEditor(u){if(quill){const r=quill.getSelection(true);quill.insertEmbed(r?r.index:quill.getLength(),'image',u);}closeGallery();}
    async function uploadImage(){const f=document.getElementById('upload-input').files[0];if(!f)return;await myDB.storage.from(currentBucket).upload(`${Date.now()}_${f.name}`,f);loadGalleryImages();}

    function syncKbOrderKeys() {
        let c = false; if (!kbCatOrder.hide_note) { kbCatOrder.hide_note = []; c = true; }
        const ct = {}; cache.articles.forEach(a => { if (!ct[a.big_category]) ct[a.big_category] = new Set(); ct[a.big_category].add(a.mid_category); });
        Object.keys(ct).forEach(b => { if (!kbCatOrder.big.includes(b)) { kbCatOrder.big.push(b); c = true; } });
        Object.keys(ct).forEach(b => { if (!kbCatOrder.mid[b]) kbCatOrder.mid[b] = []; [...ct[b]].forEach(m => { if (!kbCatOrder.mid[b].includes(m)) { kbCatOrder.mid[b].push(m); c = true; } }); });
        if (c) saveKbOrderConfig();
    }    
    function renderKbTree() {
        const t = {}; cache.articles.forEach(a => { if (!t[a.big_category]) t[a.big_category] = {}; if (!t[a.big_category][a.mid_category]) t[a.big_category][a.mid_category] = []; t[a.big_category][a.mid_category].push(a); });
        document.getElementById('kb-tree').innerHTML = kbCatOrder.big.filter(b => t[b]).map(b => {
            const isHidden = (kbCatOrder.hide_note || []).includes(b); const noteIcon = isHidden ? 'ğŸ”‡' : 'ğŸ“¢';
            const noteBtn = `<span onclick="toggleKbNote('${b}', event)" style="cursor:pointer; margin-right:8px; font-size:14px; opacity:0.8;" title="åˆ‡æ›ä¾¿åˆ©è²¼">${noteIcon}</span>`;
            const ms = (kbCatOrder.mid[b] || []).filter(m => t[b][m]).map(m => {
                const as = t[b][m].map(a => `<div class="article-item ${a.is_published ? '' : 'draft'}"><div class="sort-actions"><button class="btn-sort-arrow" onclick="moveArt('${a.id}',-1,event)">â–²</button><button class="btn-sort-arrow" onclick="moveArt('${a.id}',1,event)">â–¼</button></div><span class="article-title-span" onclick="editKb('${a.id}')">ğŸ“„ ${a.title}</span></div>`).join('');
                return `<details class="mid-cat" open><summary><div class="sort-actions"><button class="btn-sort-arrow" onclick="moveMid('${b}','${m}',-1,event)">â–²</button><button class="btn-sort-arrow" onclick="moveMid('${b}','${m}',1,event)">â–¼</button></div>â”” ${m}</summary>${as}</details>`;
            }).join('');
            return `<details class="big-cat" open><summary><div class="sort-actions"><button class="btn-sort-arrow" onclick="moveBig('${b}',-1,event)">â–²</button><button class="btn-sort-arrow" onclick="moveBig('${b}',1,event)">â–¼</button></div>${noteBtn} ğŸ“‚ ${b}</summary>${ms}</details>`;
        }).join('');
        document.getElementById('kb-big-list').innerHTML = kbCatOrder.big.map(v => `<option value="${v}">`).join('');
        const allMids = new Set(); Object.values(kbCatOrder.mid).forEach(a => a.forEach(m => allMids.add(m)));
        document.getElementById('kb-mid-list').innerHTML = [...allMids].map(v => `<option value="${v}">`).join('');
    }

    async function moveBig(n,d,e){e.stopPropagation();const i=kbCatOrder.big.indexOf(n);if(i===-1||i+d<0||i+d>=kbCatOrder.big.length)return;[kbCatOrder.big[i],kbCatOrder.big[i+d]]=[kbCatOrder.big[i+d],kbCatOrder.big[i]];renderKbTree();await saveKbOrderConfig();}
    async function moveMid(b,n,d,e){e.stopPropagation();const i=kbCatOrder.mid[b].indexOf(n);if(i===-1||i+d<0||i+d>=kbCatOrder.mid[b].length)return;[kbCatOrder.mid[b][i],kbCatOrder.mid[b][i+d]]=[kbCatOrder.mid[b][i+d],kbCatOrder.mid[b][i]];renderKbTree();await saveKbOrderConfig();}
    async function moveArt(id, dir, e) {
        e.stopPropagation(); const art = cache.articles.find(a => a.id === id); if (!art) return;
        const siblings = cache.articles.filter(a => a.big_category === art.big_category && a.mid_category === art.mid_category);
        const idx = siblings.findIndex(a => a.id === id); if (idx === -1 || idx + dir < 0 || idx + dir >= siblings.length) return;
        const temp = siblings[idx]; siblings[idx] = siblings[idx + dir]; siblings[idx + dir] = temp;
        const updates = siblings.map((a, index) => { a.sort_order = index; return { id: a.id, sort_order: index, title: a.title, big_category: a.big_category, mid_category: a.mid_category }; });
        cache.articles.sort((a, b) => a.sort_order - b.sort_order); renderKbTree();
        try { await myDB.from('kb_articles').upsert(updates, { onConflict: 'id' }); console.log("âœ… æ’åºå·²æ›´æ–°"); } catch (err) { alert("æ’åºå„²å­˜å¤±æ•—: " + err.message); }
    }    
    async function saveKbOrderConfig(){const{data}=await myDB.from('site_content').select('id').eq('title','kb_category_order').single();if(data)await myDB.from('site_content').update({content:kbCatOrder}).eq('id',data.id);else await myDB.from('site_content').insert([{category:'system_config',title:'kb_category_order',content:kbCatOrder}]);}

    function loadSlotsForBooking(date) { const slots = cache.slots.filter(s => s.slot_date === date && !s.is_booked); const sel = document.getElementById('book-slot'); sel.innerHTML = slots.length ? slots.map(s => `<option value="${s.id}" data-t="${s.slot_date} ${s.slot_time}">${s.slot_time.slice(0,5)}</option>`).join('') : '<option>ç„¡ç©ºæª”</option>'; }
    async function confirmSchedule(bid) { const sel = document.getElementById('book-slot'); if(!sel.value || sel.value.includes("å…ˆé¸")) return alert("è«‹é¸æ“‡æ™‚æ®µ"); const t = sel.options[sel.selectedIndex].dataset.t; await myDB.from('bookings').update({scheduled_at: t, status: 'awaiting_service'}).eq('id', bid); await myDB.from('schedule_slots').update({is_booked: true}).eq('id', sel.value); alert("âœ… æ’ç¨‹æˆåŠŸ"); closeModal(); fetchAll(); }
    async function deleteBooking(id) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { await myDB.from('bookings').delete().eq('id',id); fetchAll(); } }
    async function sendPayLink(id) { if(confirm("ç¢ºå®šç™¼é€ï¼Ÿ")) { const t = new Date().toLocaleString(); const b = cache.bks.find(x => x.id === id); await myDB.from('bookings').update({ status: 'awaiting_payment', wish_detail: `${b.wish_detail} | [QRå·²å‚³: ${t}]` }).eq('id', id); await fetchAll(); openBooking(id); alert("âœ… ä»˜æ¬¾ç¢¼ç‹€æ…‹å·²æ›´æ–°"); } }
    function renderActionButtons(b) { if (b.status === 'paid') return `<button class="btn" style="background:#ccc;">å¾…æ’ç¨‹</button>`; if (b.status === 'awaiting_service') return `<button class="btn btn-forest" onclick="updateS('${b.id}','completed')">âœ… çµæ¡ˆ</button>`; if (b.status === 'completed') return `<button class="btn" style="background:#ccc;">å·²çµæ¡ˆ</button>`; if (b.status === 'pending') return `<button class="btn btn-info" onclick="sendPayLink('${b.id}')">ğŸ“§ å‚³ä»˜æ¬¾ç¢¼</button>`; if (b.status === 'awaiting_payment' || b.payment_method === 'shopee' || b.ota_order_id) return `<button class="btn btn-success" onclick="updateS('${b.id}','paid')">ğŸ’° ç¢ºèªå…¥å¸³</button>`; return ""; }
    
    function renderPro() { 
        const k = document.getElementById('search-member').value.toLowerCase(); 
        document.getElementById('pro-list').innerHTML = cache.pros.filter(p => !k || (p.full_name && p.full_name.includes(k)) || p.phone.includes(k)).map(p => { 
            const ub = cache.bks.filter(b => b.user_id === p.id || cleanPhone(b.temp_phone) === cleanPhone(p.phone)); 
            const t = ub.filter(b => b.status === 'paid' || b.status === 'completed').reduce((s, b) => s + (b.price || 0), 0); 
            return `<tr><td><b>${p.full_name}</b></td><td>${p.phone}</td><td><small>${p.email||'-'}</small></td><td style="color:#d35400;">$${t.toLocaleString()}</td><td>${ub.length?ub[0].created_at.slice(0,10):'-'}</td><td><button class="btn btn-forest" onclick="showHistory('${p.id}', '${p.full_name}')">ğŸ“œ</button><button class="btn btn-warning" onclick="editProfile('${p.id}')">âœï¸</button><button class="btn btn-danger" onclick="deleteMember('${p.id}', '${p.full_name}')">ğŸ—‘ï¸</button></td></tr>`; 
        }).join(''); 
    }
    
    function editProfile(uid) { const p = cache.pros.find(x => x.id === uid); document.getElementById('m-title').innerText = "ç·¨è¼¯æœƒå“¡"; document.getElementById('m-content').innerHTML = `<label>å§“å</label><input id="ep-n" value="${p.full_name}" style="margin-bottom:10px;"><label>æ‰‹æ©Ÿ</label><input id="ep-p" value="${p.phone}" style="margin-bottom:10px;"><label>Email</label><input id="ep-e" value="${p.email||''}" style="margin-bottom:15px;"><div style="display:flex; gap:10px;"><button class="btn btn-success" style="flex:1;" onclick="updPro('${p.id}')">ğŸ’¾ å„²å­˜è®Šæ›´</button><button class="btn btn-danger" style="flex:1;" onclick="resetMemberPassword('${p.id}', '${p.phone}')">ğŸ”‘ é‡ç½®å¯†ç¢¼</button></div>`; document.getElementById('modal').style.display = 'flex'; }
    async function updPro(id) { await myDB.from('profiles').update({ full_name: document.getElementById('ep-n').value, phone: document.getElementById('ep-p').value, email: document.getElementById('ep-e').value }).eq('id', id); closeModal(); fetchAll(); alert("âœ… æ›´æ–°æˆåŠŸ"); }
    async function resetMemberPassword(uid, phone) { if(!confirm(`ç¢ºå®šè¦é‡ç½®å¯†ç¢¼å—ï¼Ÿ\né è¨­ç‚ºï¼šguest${phone.slice(-4)}`)) return; const newPw = 'guest' + phone.slice(-4); const { error } = await myDB.from('profiles').update({ password: newPw }).eq('id', uid); if(error) alert("å¤±æ•—: " + error.message); else alert("âœ… å¯†ç¢¼å·²é‡ç½®"); }
    async function deleteMember(uid, name) { if(confirm(`âš ï¸ ç¢ºå®šåˆªé™¤æœƒå“¡ ${name}ï¼Ÿ`)) { await myDB.from('profiles').delete().eq('id', uid); fetchAll(); } }
    function showHistory(uid, name) { const p = cache.pros.find(x => x.id === uid); const userBks = cache.bks.filter(b => b.user_id === uid || cleanPhone(b.temp_phone) === cleanPhone(p.phone)); let html = userBks.length === 0 ? "<p style='color:#999; text-align:center;'>ç„¡è¨‚å–®ç´€éŒ„</p>" : userBks.map(b => ` <div onclick="openBooking('${b.id}')" class="history-card"> <div style="display:flex; justify-content:space-between;"> <b style="color:var(--forest);">${b.service_item}</b> ${STATUS_MAP[b.status] || b.status} </div> <div style="font-size:12px; color:#666; margin-top:5px;">${b.created_at.slice(0,10)} | $${b.price}</div> </div> `).join(''); document.getElementById('m-title').innerText = `${name} çš„æ­·å²è¨‚å–®`; document.getElementById('m-content').innerHTML = `<div style="max-height:400px; overflow-y:auto;">${html}</div>`; document.getElementById('modal').style.display = 'flex'; }
    // ğŸ”¥ å„ªåŒ–ç‰ˆï¼šè®“å„ªæƒ åˆ¸é‡‘é¡é¡¯ç¤ºçœ‹å¾—æ‡‚ (æ‰“æŠ˜é¡¯ç¤ºã€ŒæŠ˜ã€ï¼Œæ‰£æ¬¾é¡¯ç¤ºã€Œ-$ã€)
    // ğŸ”¥ çµ‚æ¥µçµ±ä¸€ç‰ˆï¼šå¥—ç”¨æ¨™æº– CSS Classï¼Œä¸å†æ‰‹å¯« style
    // ğŸ”¥ çµ‚æ¥µçµ±ä¸€ç‰ˆï¼šOTA ç·¨è¼¯å€èˆ‡åˆ—è¡¨æ¨£å¼ï¼Œå…¨éƒ¨èˆ‡å„ªæƒ åˆ¸å°é½Šï¼
    function renderFinance() { 
        // ------------------------------------------------
        // 1. OTA åˆ—è¡¨ (åŒ…å«ä¸Šæ–¹çš„ç·¨è¼¯è¡¨å–®)
        // ------------------------------------------------
        
        // â˜…â˜…â˜… é‡é»ä¿®æ”¹ï¼šé€™è£¡æŠŠç·¨è¼¯å€ HTML æ”¹æˆè·Ÿå„ªæƒ åˆ¸ä¸€æ¨£çš„æš–è‰²ç³» Grid æ’ç‰ˆ â˜…â˜…â˜…
        const otaFormHtml = `
            <div style="background:#fffcf5; padding:25px; border:1px solid #fae1c3; border-radius:10px; margin-bottom:20px;">
                <h4 style="margin-top:0; color:#e65100; border-bottom:1px dashed #e65100; padding-bottom:10px; margin-bottom:20px;">â• æ–°å¢ / ä¿®æ”¹å¹³å°</h4>
                <input type="hidden" id="ota-id">
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:25px;">
                    <div>
                        <label>å¹³å°åç¨±</label>
                        <input type="text" id="ota-name" placeholder="ä¾‹: è¦çš®è³¼ç‰©">
                    </div>
                    <div>
                        <label>è‹±æ–‡ä»£è™Ÿ (Code)</label>
                        <input type="text" id="ota-code" placeholder="ä¾‹: shopee">
                    </div>
                    
                    <div>
                        <label>ä½£é‡‘è²»ç‡ (%)</label>
                        <input type="number" id="ota-rate" placeholder="5.5">
                    </div>
                    <div>
                        <label>å‰å°ç¶²å€ (å®¢äººçœ‹çš„)</label>
                        <input type="text" id="ota-front" placeholder="https://...">
                    </div>

                    <div style="grid-column: 1 / -1;">
                        <label>å¾Œå°ç¶²å€ (æ‚¨ç™»å…¥ç”¨çš„)</label>
                        <input type="text" id="ota-admin" placeholder="https://...">
                    </div>
                </div>

                <div style="text-align:right; margin-top:25px; padding-top:15px; border-top:1px dashed #fae1c3;">
                    <button class="btn btn-outline" id="btn-ota-cancel" onclick="cancelOTA()" style="display:none; margin-right:5px;">å–æ¶ˆ</button>
                    <button class="btn btn-warning" id="btn-ota-save" onclick="saveOTA()" style="width:150px;">ğŸ’¾ å„²å­˜è¨­å®š</button>
                </div>
            </div>
        `;

        const otaTableRows = cache.otas.map(o => `
            <tr>
                <td style="font-weight:bold; color:#2c3e50;">${o.name}</td>
                
                <td><span class="tag tag-ota">${o.code}</span></td>
                
                <td><span class="num-rate">${o.commission_rate}%</span></td>
                
                <td style="font-size:12px; color:#999; max-width:150px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                    ${o.front_url || '-'}
                </td>
                
                <td>
                    <button class="btn btn-info" onclick="editOTA('${o.id}')">ä¿®</button>
                    <button class="btn btn-danger" onclick="delData('ota_settings', '${o.id}')">åˆª</button>
                </td>
            </tr>
        `).join('');

        document.getElementById('sub-ota').innerHTML = `
            ${otaFormHtml}
            <table>
                <thead><tr><th width="15%">å¹³å°åç¨±</th><th width="10%">ä»£è™Ÿ</th><th width="10%">ä½£é‡‘</th><th width="45%">ç¶²å€é€£çµ</th><th width="20%">æ“ä½œ</th></tr></thead>
                <tbody id="ota-list">${otaTableRows}</tbody>
            </table>
        `;

        // ------------------------------------------------
        // 2. å„ªæƒ åˆ¸åˆ—è¡¨ (é‚è¼¯ä¸è®Šï¼Œä¿æŒçµ±ä¸€çš„åˆ—è¡¨æ¨£å¼)
        // ------------------------------------------------
        document.getElementById('cp-list').innerHTML = cache.coupons.map(c => {
            let displayVal = "";
            
            if (c.discount_type === 'percentage') {
                let zhe = c.discount_value / 10;
                displayVal = `<span class="num-discount">${zhe} æŠ˜</span>`; 
            } else {
                displayVal = `<span class="num-money">-$${c.discount_value}</span>`;
            }

            let roleText = `<span style="color:#666; font-size:12px;">ä¸é™</span>`;
            if (c.allowed_roles && c.allowed_roles.includes('member')) {
                roleText = `<span style="color:#2980b9; font-weight:bold; font-size:12px;">åƒ…æœƒå“¡</span>`;
            }

            return `
            <tr>
                <td style="font-weight:bold; color:#2c3e50;">${c.name}</td>
                <td><span class="tag tag-coupon">${c.code}</span></td>
                <td>${displayVal}</td>
                <td style="font-size:13px;">${c.expires_at ? c.expires_at.slice(0,10) : '<span style="color:#ccc">ç„¡æœŸé™</span>'}</td>
                <td>${roleText}</td>
                <td style="font-size:13px; color:#555;">${c.usage_count} æ¬¡</td>
                <td>
                    <button class="btn btn-info" onclick="editCoupon('${c.id}')">ä¿®</button>
                    <button class="btn btn-danger" onclick="delData('coupons', '${c.id}')">åˆª</button>
                </td>
            </tr>`;
        }).join(''); 
    }


    function renderConfigTables() {
        const s = document.getElementById('svc-cat-filter'); const activeCats = cache.cats.filter(c => c.is_active !== false); s.innerHTML = '<option value="">è«‹é¸å¤§é¡</option>' + activeCats.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        document.getElementById('cat-list').innerHTML = cache.cats.map(c => {
            const isActive = c.is_active !== false; const rowStyle = isActive ? '' : 'background:#eee; color:#999;'; const statusLabel = isActive ? '' : '<span style="font-size:12px; color:red; font-weight:bold;">(å·²æš«åœ)</span>'; const toggleBtnText = isActive ? 'ğŸš« æš«åœ' : 'ğŸ‘ï¸ å•Ÿç”¨'; const toggleBtnClass = isActive ? 'btn-warning' : 'btn-success';
            return `<tr style="${rowStyle}"><td>${c.name} ${statusLabel}<div style="font-size:12px; color:#aaa;">${c.terms ? '(å«è¦ç¯„)' : ''}</div></td><td style="text-align:right;"><button class="btn btn-outline" onclick="editCat('${c.id}')" title="ç·¨è¼¯">âœï¸</button><button class="btn ${toggleBtnClass}" onclick="toggleCatStatus('${c.id}', ${!isActive})" style="font-size:12px;">${toggleBtnText}</button><button class="btn btn-danger" onclick="deleteCat('${c.id}')" title="åˆªé™¤">ğŸ—‘ï¸</button></td></tr>`;
        }).join('');
    }
    async function toggleCatStatus(id, newStatus) { const { error } = await myDB.from('service_categories').update({ is_active: newStatus }).eq('id', id); if (error) alert("æ›´æ–°å¤±æ•—: " + error.message); else fetchAll(); }
    async function deleteCat(id) { if (!confirm("âš ï¸ è­¦å‘Šï¼šç¢ºå®šè¦åˆªé™¤é€™å€‹å¤§é¡å—ï¼Ÿ")) return; const { error } = await myDB.from('service_categories').delete().eq('id', id); if (error) alert("åˆªé™¤å¤±æ•— (å¯èƒ½æœ‰é—œè¯è³‡æ–™): " + error.message); else { alert("âœ… å·²åˆªé™¤"); fetchAll(); } }
    
    function filterServiceList(){ const c=document.getElementById('svc-cat-filter').value; document.getElementById('svc-list-container').innerHTML=cache.svcs.filter(s=>s.category_id===c).map((s,i)=>`<div class="admin-row"><div style="display:flex; flex-direction:column; margin-right:10px;"><button class="btn btn-outline" style="padding:0 5px;" onclick="moveSvc('${s.id}',-1)">â–²</button><button class="btn btn-outline" style="padding:0 5px;" onclick="moveSvc('${s.id}',1)">â–¼</button></div><div style="flex:1"><b>${s.title}</b> $${s.price} ${s.sub_options ? `<div style="font-size:12px; color:#666;">â”” ${s.sub_options}</div>` : ''}</div><button class="btn btn-info" onclick="editSvc('${s.id}')">ä¿®</button><button class="btn btn-danger" onclick="delData('services','${s.id}')">åˆª</button></div>`).join(''); }
    async function moveSvc(id, dir) {
        const c = document.getElementById('svc-cat-filter').value; const list = cache.svcs.filter(s => s.category_id === c); const idx = list.findIndex(s => s.id === id); if (idx === -1 || idx + dir < 0 || idx + dir >= list.length) return;
        const target = list[idx + dir]; const temp = list[idx].sort_order; list[idx].sort_order = target.sort_order; target.sort_order = temp;
        await Promise.all([ myDB.from('services').update({sort_order: list[idx].sort_order}).eq('id', list[idx].id), myDB.from('services').update({sort_order: target.sort_order}).eq('id', target.id) ]); fetchAll();
    }

    function renderTimeGrid() { 
        let h = ''; 
        
        // è·‘è¿´åœˆï¼š0é» åˆ° 23é»
        for(let i=0; i<=23; i++) { 
            ['00','30'].forEach(m => { 
                
                // --- ğŸ”¥ é—œéµé‚è¼¯ï¼šåˆ¤æ–·è¦ä¸è¦é¡¯ç¤º ---
                // æˆ‘å€‘æŠŠæ™‚é–“æ›ç®—æˆæ•¸å­— (ä¾‹å¦‚ 01:30 = 1.5, 13:00 = 13)
                let timeVal = i + (m === '30' ? 0.5 : 0);

                // è¦å‰‡ï¼šåªé¡¯ç¤ºã€Œå°æ–¼ç­‰æ–¼ 3é»ã€ æˆ– ã€Œå¤§æ–¼ç­‰æ–¼ 13é»ã€
                // é€™æ¨£ 03:30 ~ 12:30 é€™ä¸­é–“çš„æ•¸å­—éƒ½ä¸æœƒé€šéï¼Œå°±æœƒè¢«éš±è—
                if (timeVal <= 3 || timeVal >= 13) {
                    
                    let t = `${i.toString().padStart(2,'0')}:${m}`; 
                    let v = `${i}:${m}`; 
                    h += `<div class="batch-slot"><input type="checkbox" name="ts" id="t-${v}" value="${v}"><label for="t-${v}">${t}</label></div>`; 
                }
            }) 
        } 
        document.getElementById('time-grid').innerHTML = h; 
    }

    function toggleAllSlots(c){document.querySelectorAll('input[name="ts"]').forEach(e=>e.checked=c);}
    async function batchAddSchedule() {
        // 1. æŠ“å–æ—¥æœŸå­—ä¸²
        const d1 = document.getElementById('batch-start').value; 
        const d2 = document.getElementById('batch-end').value || d1; 
        
        // 2. æŠ“å–æ™‚æ®µ
        const ts = Array.from(document.querySelectorAll('input[name="ts"]:checked')).map(e => e.value); 
        
        if (!d1 || !ts.length) return alert("è«‹é¸æ“‡æ—¥æœŸèˆ‡æ™‚æ®µ");

        let ins = []; 
        let skipped = 0; 

        // ğŸ”¥ğŸ”¥ğŸ”¥ é—œéµä¿®æ”¹ï¼šå¼·åˆ¶è¨­å®šç‚ºã€Œä¸­åˆ 12:00ã€ğŸ”¥ğŸ”¥ğŸ”¥
        // é€™æ¨£ä¸ç®¡æ™‚å€æ€éº¼é£„ï¼ŒåŠ æ¸›å¹¾å°æ™‚éƒ½é‚„æ˜¯åœ¨ã€Œç•¶å¤©ã€ï¼Œçµ•å°ä¸æœƒè·³æ—¥ï¼
        let currentDate = new Date(d1 + "T12:00:00"); 
        let endDate = new Date(d2 + "T12:00:00");

        while (currentDate <= endDate) {
            // 3. å–å¾—ä¹¾æ·¨çš„æ—¥æœŸå­—ä¸² (YYYY-MM-DD)
            const year = currentDate.getFullYear();
            const month = String(currentDate.getMonth() + 1).padStart(2, '0');
            const day = String(currentDate.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`; 

            ts.forEach(t => {
                // t æ˜¯ "00:30" æˆ– "14:00"
                // ğŸ”¥ æˆ‘å€‘å®Œå…¨ä¸åšæ—¥æœŸé‹ç®—ï¼Œç›´æ¥æŠŠå­—ä¸²æ‹¼èµ·ä¾†
                // é€™æ¨£ä½ é¸ 6 è™Ÿå°±æ˜¯ 6 è™Ÿï¼Œé¸ 00:30 å°±æ˜¯ 00:30ï¼Œç³»çµ±ç„¡æ¬Šä¿®æ”¹å®ƒ
                const finalTime = `${t}:00`;

                // æª¢æŸ¥é‡è¤‡
                const exists = cache.slots.some(s => s.slot_date === dateStr && s.slot_time.startsWith(t));
                
                if (!exists) {
                    ins.push({ 
                        slot_date: dateStr, 
                        slot_time: finalTime, 
                        is_booked: false 
                    }); 
                } else {
                    skipped++;
                }
            }); 
            
            // è¿´åœˆè·‘å®Œï¼Œæ—¥æœŸ + 1 å¤© (ç¹¼çºŒä¿æŒåœ¨ä¸­åˆ)
            currentDate.setDate(currentDate.getDate() + 1);
        }

        if (ins.length === 0) return alert(`æ‰€æœ‰é¸å®šæ™‚æ®µå‡å·²å­˜åœ¨ã€‚(è·³é ${skipped} ç­†)`);
        
        const { error } = await myDB.from('schedule_slots').insert(ins); 
        if (error) alert("ç”Ÿæˆå¤±æ•—: " + error.message); 
        else { 
            alert(`âœ… æˆåŠŸæ–°å¢ ${ins.length} ç­†æ™‚æ®µ` + (skipped > 0 ? `\n(å·²è‡ªå‹•è·³é ${skipped} ç­†é‡è¤‡è³‡æ–™)` : "")); 
            fetchAll(); 
            toggleAllSlots(false); 
        }
    }

    function renderCalendar() {
        const t = new Date(); document.getElementById('cal-title').innerText = `${currentYear}/${currentMonth}`;
        const fd = new Date(currentYear, currentMonth - 1, 1).getDay(); const dim = new Date(currentYear, currentMonth, 0).getDate(); const today = new Date().toISOString().split('T')[0];
        const weeks = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­']; let h = ''; weeks.forEach(w => { h += `<div class="cal-week-header">${w}</div>`; });
        for (let i = 0; i < fd; i++) h += '<div class="cal-cell" style="background:#f9f9f9; border:none; cursor:default;"></div>';
        for (let d = 1; d <= dim; d++) {
            const ds = `${currentYear}-${currentMonth.toString().padStart(2, '0')}-${d.toString().padStart(2, '0')}`;
            const s = cache.slots.filter(x => x.slot_date === ds); const isOff = s.some(x => x.type === 'off'); const f = s.filter(x => !x.is_booked && x.type !== 'off').length; const bk = s.filter(x => x.is_booked && x.type !== 'off').length; const isPast = ds < today; const activeClass = ds === selectedDateStr ? 'active' : ''; const pastClass = isPast ? 'cal-past' : '';
            h += `<div class="cal-cell ${activeClass} ${pastClass}" onclick="selectDate('${ds}')"><div class="cal-date">${d}</div>${isOff ? `<div class="cal-stat st-off">â˜• ä¼‘å‡ä¸­</div>` : ''}${!isOff && f ? `<div class="cal-stat st-free">ç©ºæª” ${f}</div>` : ''}${!isOff && bk ? `<div class="cal-stat st-book">é ç´„ ${bk}</div>` : ''}</div>`;
        }
        document.getElementById('calendar-body').innerHTML = h;
    }
    function changeMonth(o){currentMonth+=o;if(currentMonth>12){currentMonth=1;currentYear++}else if(currentMonth<1){currentMonth=12;currentYear--}renderCalendar();}
    
    function selectDate(d) {
        selectedDateStr = d; renderCalendar(); document.getElementById('detail-date-title').innerText = `${d}`; document.getElementById('detail-actions').style.display = 'flex';
        const s = cache.slots.filter(x => x.slot_date === d); const dayOffRecord = s.find(x => x.type === 'off');
        if (dayOffRecord) { document.getElementById('day-detail-container').innerHTML = `<div class="day-off-state"><div class="day-off-icon">â˜•</div><h3>æœ¬æ—¥å·²è¨­ç‚ºä¼‘å‡</h3><p style="font-size:12px; color:#ccc;">æœªä¾†é¦–é å°‡é¡¯ç¤ºç‚ºä¸é–‹æ”¾</p><button class="btn btn-outline" onclick="cancelDayOff('${dayOffRecord.id}')" style="margin-top:15px;">âŒ å–æ¶ˆä¼‘å‡</button></div>`; return; }
        if (s.length === 0) { document.getElementById('day-detail-container').innerHTML = '<p style="text-align:center;color:#999;margin-top:20px;">æœ¬æ—¥ç„¡æ’ç¨‹</p>'; return; }
        const sortedS = s.sort((a, b) => a.slot_time.localeCompare(b.slot_time));
        document.getElementById('day-detail-container').innerHTML = sortedS.map(x => `<div class="detail-row ${x.is_booked ? 'booked' : ''}" style="padding:10px; border:1px solid #eee; margin-bottom:5px; border-radius:4px; ${x.is_booked ? 'background:#ffebee; border-color:#ef9a9a;' : ''}"><input type="checkbox" class="detail-chk" value="${x.id}" ${x.is_booked ? 'disabled' : ''}><span style="font-weight:bold; font-size:1.1rem; ${x.is_booked ? 'text-decoration:line-through; color:#c62828;' : ''}">${x.slot_time.slice(0, 5)}</span></div>`).join('');
    }

    function toggleDetailChecks(checked) { document.querySelectorAll('.detail-chk:not(:disabled)').forEach(el => el.checked = checked); }
    async function deleteSelectedSlots() { const ids = Array.from(document.querySelectorAll('.detail-chk:checked')).map(e => e.value); if (ids.length === 0) return alert("è«‹å…ˆå‹¾é¸è¦åˆªé™¤çš„æ™‚æ®µ"); if (!confirm(`ç¢ºå®šè¦åˆªé™¤é€™ ${ids.length} å€‹æ™‚æ®µå—ï¼Ÿ`)) return; const { error } = await myDB.from('schedule_slots').delete().in('id', ids); if (error) alert("åˆªé™¤å¤±æ•—: " + error.message); else { fetchAll(); setTimeout(() => { if(selectedDateStr) selectDate(selectedDateStr); }, 500); } }
    async function setDayOff() { if (!selectedDateStr) return alert("è«‹å…ˆé¸æ“‡æ—¥æœŸ"); const hasRealBooking = cache.slots.some(s => s.slot_date === selectedDateStr && s.is_booked && s.type !== 'off'); if (hasRealBooking) return alert("âš ï¸ ç„¡æ³•ä¼‘å‡ï¼šç•¶å¤©å·²æœ‰å®¢æˆ¶é ç´„ï¼Œè«‹å…ˆæ‰‹å‹•å–æ¶ˆè¨‚å–®ã€‚"); if (!confirm(`ç¢ºå®šè¦å°‡ ${selectedDateStr} è¨­ç‚ºä¼‘å‡å—ï¼Ÿ`)) return; await myDB.from('schedule_slots').delete().eq('slot_date', selectedDateStr); const { error } = await myDB.from('schedule_slots').insert([{ slot_date: selectedDateStr, slot_time: '00:00:00', is_booked: true, type: 'off' }]); if (error) alert("è¨­å®šå¤±æ•—: " + error.message); else { fetchAll(); setTimeout(() => { if(selectedDateStr) selectDate(selectedDateStr); }, 500); } }
    async function cancelDayOff(id) { if (!confirm("ç¢ºå®šå–æ¶ˆä¼‘å‡ï¼Ÿ")) return; await myDB.from('schedule_slots').delete().eq('id', id); fetchAll(); setTimeout(() => { if(selectedDateStr) selectDate(selectedDateStr); }, 500); }
    function render7DaySchedule(){const t=new Date();let h='';for(let i=0;i<7;i++){const d=new Date(t);d.setDate(t.getDate()+i);const ds=d.toISOString().split('T')[0];const s=cache.slots.filter(x=>x.slot_date===ds).sort((a,b)=>a.slot_time.localeCompare(b.slot_time));if(s.length)h+=`<div class="upcoming-day"><div class="upcoming-day-header">${ds}</div><div class="upcoming-slots">${s.map(x=>`<span class="u-slot ${x.is_booked?'booked':''}">${x.slot_time.slice(0,5)}</span>`).join('')}</div></div>`}document.getElementById('dashboard-7day-schedule').innerHTML=h||"ç„¡";}
    function closeModal(){document.getElementById('modal').style.display='none';}
    function switchTab(id){document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));document.getElementById('tab-'+id).classList.add('active');document.querySelectorAll('.sidebar button').forEach(b=>b.classList.remove('active'));document.getElementById('nav-'+id).classList.add('active');}
    async function delData(table, id){if(confirm("åˆªé™¤ï¼Ÿ")){await myDB.from(table).delete().eq('id',id);fetchAll();}}
    window.updateS = async function(id, status) { const b = cache.bks.find(x => x.id === id); if (status === 'completed') { const hasReport = b.wish_detail && b.wish_detail.includes('[å ±å‘Šå·²ç”Ÿæˆ'); if (!hasReport) return alert("âš ï¸ ç„¡æ³•çµæ¡ˆï¼è«‹å…ˆç”Ÿæˆæœå‹™å ±å‘Šä¸¦å­˜æª”ã€‚"); } if (confirm("ç¢ºå®šè¦æ›´æ–°ç‹€æ…‹å—ï¼Ÿ")) { await myDB.from('bookings').update({ status: status }).eq('id', id); await fetchAll(); openBooking(id); } }
    function copyCode(el) { navigator.clipboard.writeText(el.innerText).then(() => alert("æŒ‡ä»¤å·²è¤‡è£½ï¼")); }
    function toggleMainSidebar() { document.body.classList.toggle('hide-nav'); }

    async function saveCategory() {
        const id = document.getElementById('cat-id-edit').value; const name = document.getElementById('cat-name').value.trim(); const type = document.getElementById('cat-type').value; const terms = document.getElementById('cat-terms').value; if (!name) return alert("âŒ å¤§é¡åç¨±ç‚ºå¿…å¡«ï¼");
        let reqs = []; if (document.getElementById('req-birth').checked) reqs.push('birth'); if (document.getElementById('req-image').checked) reqs.push('image'); const dataReqStr = reqs.length > 0 ? reqs.join(',') : 'birth';
        const payload = { name: name, question_type: type, data_requirement: dataReqStr, terms: terms };
        let error = null; if (id) { const res = await myDB.from('service_categories').update(payload).eq('id', id); error = res.error; } else { const res = await myDB.from('service_categories').insert([payload]); error = res.error; }
        if (error) alert("å„²å­˜å¤±æ•—: " + error.message); else { alert(id ? "âœ… ä¿®æ”¹æˆåŠŸï¼" : "âœ… æ–°å¢æˆåŠŸï¼"); cancelEdit('cat'); fetchAll(); }
    }
    function editCat(id) {
        const c = cache.cats.find(x => x.id === id); if (!c) return;
        document.getElementById('cat-id-edit').value = c.id; document.getElementById('cat-name').value = c.name; document.getElementById('cat-type').value = c.question_type || 'sleep'; document.getElementById('cat-terms').value = c.terms || '';
        const reqStr = c.data_requirement || 'birth'; document.getElementById('req-birth').checked = reqStr.includes('birth'); document.getElementById('req-image').checked = reqStr.includes('image');
        document.getElementById('btn-cat-save').innerText = "ğŸ’¾ å„²å­˜ä¿®æ”¹"; document.getElementById('btn-cat-save').className = "btn btn-warning"; document.getElementById('btn-cat-cancel').style.display = "inline-block"; document.getElementById('card-cat').scrollIntoView({ behavior: 'smooth' });
    }
    function cancelEdit(type) {
        if (type === 'cat') { document.getElementById('cat-id-edit').value = ''; document.getElementById('cat-name').value = ''; document.getElementById('cat-terms').value = ''; document.getElementById('cat-type').value = 'sleep'; document.getElementById('req-birth').checked = true; document.getElementById('req-image').checked = false; document.getElementById('btn-cat-save').innerText = "ï¼‹ æ–°å¢"; document.getElementById('btn-cat-save').className = "btn btn-forest"; document.getElementById('btn-cat-cancel').style.display = "none"; } 
        else if (type === 'svc') { document.getElementById('svc-id-edit').value = ''; document.getElementById('i-name').value = ''; document.getElementById('i-price').value = ''; document.getElementById('i-sub-opts').value = ''; document.getElementById('i-report-tpl').value = ''; document.getElementById('i-is-main').checked = false; toggleSubOptionInput(); document.getElementById('btn-svc-save').innerText = "ï¼‹ æ–°å¢é …ç›®"; document.getElementById('btn-svc-save').className = "btn btn-forest"; document.getElementById('btn-svc-cancel').style.display = 'none'; }
    }
    // ğŸ“‹ è¤‡è£½å…¬å‘Šæ¨™æº–ç¯„æœ¬ (AI è¬ç”¨æ ¼å¼ç‰ˆ)
    function copyTemplate() {
        const template = `
<h4>ğŸ“Œ ç¬¬ä¸€éƒ¨åˆ†ï¼šä¸»æ¨™é¡Œ (ä¾‹å¦‚ï¼šæˆ‘çš„æ•…äº‹ / æœå‹™ç•°å‹•)</h4>
<p>é€™è£¡æ˜¯å‰è¨€æ®µè½ï¼Œæ•˜è¿°ä¸»è¦çš„æƒ…å¢ƒæˆ–æ˜¯ç™¼ç”Ÿçš„èƒŒæ™¯æ•…äº‹...</p>

<div class="anno-box-tip">
    <strong>ğŸ’¡ æ ¸å¿ƒè§€é»ï¼š</strong><br>
    é€™è£¡æ”¾ä¸€å¥é‡‘å¥ï¼Œæˆ–æ˜¯ä½ æƒ³å¼·èª¿çš„é‡é»æ¦‚å¿µã€‚
</div>

<h4>ğŸ”¸ ç¬¬äºŒéƒ¨åˆ†ï¼šæ¢åˆ—å¼èªªæ˜</h4>
<p>é‡å°ç´°ç¯€é€²è¡Œèªªæ˜ï¼š</p>
<ul>
    <li><strong>é‡é»ä¸€ï¼š</strong> è©³ç´°å…§å®¹æ•˜è¿°...</li>
    <li><strong>é‡é»äºŒï¼š</strong> è©³ç´°å…§å®¹æ•˜è¿°...</li>
    <li><strong>é‡é»ä¸‰ï¼š</strong> è©³ç´°å…§å®¹æ•˜è¿°...</li>
</ul>

<div style="text-align: center; margin: 25px 0;">
    <img src="https://ä½ çš„åœ–ç‰‡ç¶²å€.jpg" alt="åœ–ç‰‡èªªæ˜" style="max-width: 100%; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
    <div style="font-size: 13px; color: #888; margin-top: 8px;">â–² åœ–ç‰‡è¨»è§£æ–‡å­—</div>
</div>

<h4>ğŸ”¹ ç¬¬ä¸‰éƒ¨åˆ†ï¼šæµç¨‹æˆ–è¦ç¯„</h4>
<ol>
    <li><strong>æ­¥é©Ÿä¸€ï¼š</strong> å…ˆåšä»€éº¼...</li>
    <li><strong>æ­¥é©ŸäºŒï¼š</strong> å†åšä»€éº¼...</li>
</ol>

<div style="background: #f4f7f6; padding: 15px; border-radius: 8px; margin: 20px 0;">
    <strong>ğŸ’³ è£œå……è³‡è¨Šï¼š</strong>
    <ul>
        <li>è³‡è¨Š Aï¼šå…§å®¹...</li>
        <li>è³‡è¨Š Bï¼šå…§å®¹...</li>
    </ul>
</div>

<div class="anno-box-warn">
    <strong style="font-size: 1.1rem;">âš ï¸ é‡è¦é ˆçŸ¥ / çµèª</strong>
    <p style="margin: 10px 0 0 0;">
        é€™è£¡æ”¾æœ€å¾Œçš„å®åš€ï¼Œä¾‹å¦‚ã€Œé€å‡ºå³ä»£è¡¨åŒæ„ã€æˆ–æ˜¯ã€Œè«‹å‹™å¿…æº–æ™‚ã€ã€‚
    </p>
    
    <div style="text-align:center; margin-top: 20px;">
        <button class="btn-primary" onclick="closeModal('dynamic-overlay'); showSection('booking-step-1');">
            â” æˆ‘å·²äº†è§£ï¼Œå‰å¾€é ç´„
        </button>
    </div>
</div>
`;
        navigator.clipboard.writeText(template).then(() => {
            alert("âœ… è¬ç”¨ç¯„æœ¬å·²è¤‡è£½ï¼\n\næ‚¨å¯ä»¥è²¼çµ¦ AI ä¸¦ä¸‹æŒ‡ä»¤ï¼š\nã€Œè«‹ä¾ç…§é€™å€‹ HTML æ ¼å¼ï¼Œå¹«æˆ‘æ’°å¯«ä¸€ç¯‡é—œæ–¼ [ä¸»é¡Œ] çš„å…¬å‘Šï¼Œå…§å®¹è¦åŒ…å«...ã€");
        }).catch(err => {
            console.error('è¤‡è£½å¤±æ•—', err);
            alert("âŒ è¤‡è£½å¤±æ•—");
        });
    }
    // ğŸ”¥ ä¿®æ­£ç‰ˆï¼šåˆ—è¡¨è£œä¸Šã€Œå…¬å‘Šé¡å‹ã€é¡¯ç¤º
    async function fetchAnnouncements() { 
        const { data, error } = await myDB.from('announcements').select('*').order('sort_order', { ascending: true }); 
        if (error) { console.error(error); return; } 
        
        const list = document.getElementById('announce-list'); 
        list.innerHTML = data.map(item => {
            
            // åˆ¤æ–·é¡å‹é¡¯ç¤ºæ¨™ç±¤
            let typeHtml = '';
            if (item.type === 'must_read') {
                typeHtml = `<span style="color:#2980b9; font-weight:bold; font-size:13px;">ğŸ“˜ å¿…è®€</span>`;
            } else if (item.type === 'temp') {
                typeHtml = `<span style="color:#d35400; font-weight:bold; font-size:13px;">ğŸ”¥ å¿«è¨Š</span>`;
            } else {
                typeHtml = `<span style="color:#999; font-size:13px;">ä¸€èˆ¬</span>`;
            }

            return `
            <tr>
                <td><span class="badge badge-secondary" style="background:#eee; padding:2px 6px; border-radius:4px;">${item.sort_order}</span></td>
                
                <td style="font-weight:bold; color:var(--forest);">${item.title}</td>
                
                <td>${typeHtml}</td>
                
                <td>${item.is_active ? '<span class="tag tag-paid">ğŸŸ¢ ä¸Šæ¶ä¸­</span>' : '<span class="tag tag-wait">ğŸ”´ å·²éš±è—</span>'}</td>
                
                <td style="font-size:12px; color:#999;">${new Date(item.created_at).toLocaleDateString()}</td>
                
                <td>
                    <button class="btn btn-info" onclick="editAnnouncement('${item.id}')">âœï¸ ç·¨è¼¯</button>
                    <button class="btn btn-danger" onclick="deleteAnnouncement('${item.id}')">ğŸ—‘ï¸ åˆªé™¤</button>
                </td>
            </tr>`;
        }).join(''); 
    }
    function openAnnounceModal() { document.getElementById('anc-id').value = ''; document.getElementById('anc-title').value = ''; document.getElementById('anc-order').value = '10'; document.getElementById('anc-content').value = ''; document.getElementById('anc-active').value = 'true'; document.getElementById('anc-modal-title').innerText = "æ–°å¢å…¬å‘Š"; document.getElementById('announce-modal').style.display = 'flex'; }
    function closeAnnounceModal() { document.getElementById('announce-modal').style.display = 'none'; }
    async function editAnnouncement(id) { const { data } = await myDB.from('announcements').select('*').eq('id', id).single(); if (data) { document.getElementById('anc-id').value = data.id; document.getElementById('anc-title').value = data.title; document.getElementById('anc-order').value = data.sort_order; document.getElementById('anc-content').value = data.content; document.getElementById('anc-active').value = data.is_active.toString(); document.getElementById('anc-type').value = data.type || 'must_read'; document.getElementById('anc-modal-title').innerText = "ç·¨è¼¯å…¬å‘Š"; document.getElementById('announce-modal').style.display = 'flex'; } }
    async function saveAnnouncement() { const id = document.getElementById('anc-id').value; const typeVal = document.getElementById('anc-type').value; const payload = { title: document.getElementById('anc-title').value, sort_order: parseInt(document.getElementById('anc-order').value), content: document.getElementById('anc-content').value, is_active: document.getElementById('anc-active').value === 'true', type: typeVal }; if (!payload.title) return alert("æ¨™é¡Œå¿…å¡«ï¼"); let error; if (id) { const res = await myDB.from('announcements').update(payload).eq('id', id); error = res.error; } else { const res = await myDB.from('announcements').insert([payload]); error = res.error; } if (error) alert("å„²å­˜å¤±æ•—: " + error.message); else { alert("âœ… å…¬å‘Šå·²å„²å­˜ï¼"); closeAnnounceModal(); fetchAnnouncements(); } }
    async function deleteAnnouncement(id) { if (confirm("âš ï¸ ç¢ºå®šè¦åˆªé™¤æ­¤å…¬å‘Šå—ï¼Ÿåˆªé™¤å¾Œç„¡æ³•å¾©åŸï¼")) { await myDB.from('announcements').delete().eq('id', id); fetchAnnouncements(); } }

    async function saveItem() {
        const id = document.getElementById('svc-id-edit').value; const catId = document.getElementById('svc-cat-filter').value; const title = document.getElementById('i-name').value.trim(); const price = document.getElementById('i-price').value; const isMain = document.getElementById('i-is-main').checked; const reportTpl = document.getElementById('i-report-tpl').value.trim(); const subOpts = document.getElementById('i-sub-opts').value.trim();
        if (!catId) return alert("âŒ è«‹å…ˆåœ¨ä¸‹æ‹‰é¸å–®ä¸­é¸æ“‡ã€Œæ‰€å±¬å¤§é¡ã€ï¼"); if (!title || !price) return alert("âŒ é …ç›®åç¨±èˆ‡åƒ¹æ ¼ç‚ºå¿…å¡«ï¼");
        const payload = { category_id: catId, title: title, price: parseInt(price), is_main: isMain, report_template: reportTpl, sub_options: subOpts };
        let error = null; if (id) { const res = await myDB.from('services').update(payload).eq('id', id); error = res.error; } else { const { count } = await myDB.from('services').select('*', { count: 'exact', head: true }); payload.sort_order = count ? count + 1 : 1; const res = await myDB.from('services').insert([payload]); error = res.error; }
        if (error) alert("å„²å­˜å¤±æ•—: " + error.message); else { alert(id ? "âœ… ä¿®æ”¹æˆåŠŸï¼" : "âœ… æ–°å¢æˆåŠŸï¼"); cancelEdit('svc'); await fetchAll(); filterServiceList(); }
    }
    function editSvc(id) {
        const s = cache.svcs.find(x => x.id === id); if (!s) return;
        document.getElementById('svc-cat-filter').value = s.category_id; filterServiceList();
        document.getElementById('svc-id-edit').value = s.id; document.getElementById('i-name').value = s.title; document.getElementById('i-price').value = s.price; document.getElementById('i-is-main').checked = s.is_main; document.getElementById('i-report-tpl').value = s.report_template || ''; document.getElementById('i-sub-opts').value = s.sub_options || '';
        toggleSubOptionInput(); document.getElementById('btn-svc-save').innerText = "ğŸ’¾ å„²å­˜ä¿®æ”¹"; document.getElementById('btn-svc-save').className = "btn btn-warning"; document.getElementById('btn-svc-cancel').style.display = 'inline-block'; document.getElementById('card-svc').scrollIntoView({ behavior: 'smooth' });
    }
    function toggleSubOptionInput() { const isMain = document.getElementById('i-is-main').checked; document.getElementById('main-opt-wrapper').style.display = isMain ? 'block' : 'none'; document.getElementById('sub-opt-wrapper').style.display = isMain ? 'none' : 'block'; }
    function copySqlCode() { const code = document.getElementById('sql-code-block').innerText; navigator.clipboard.writeText(code).then(() => alert("SQL æŒ‡ä»¤å·²è¤‡è£½ï¼")); }
    function switchFinanceSub(tab) { document.getElementById('sub-ota').style.display = tab === 'ota' ? 'block' : 'none'; document.getElementById('sub-coupon').style.display = tab === 'coupon' ? 'block' : 'none'; document.getElementById('btn-sub-ota').className = tab === 'ota' ? 'active' : ''; document.getElementById('btn-sub-coupon').className = tab === 'coupon' ? 'active' : ''; }
    
    async function toggleKbNote(cat, e) { e.stopPropagation(); if (!kbCatOrder.hide_note) kbCatOrder.hide_note = []; const idx = kbCatOrder.hide_note.indexOf(cat); if (idx > -1) kbCatOrder.hide_note.splice(idx, 1); else kbCatOrder.hide_note.push(cat); renderKbTree(); await saveKbOrderConfig(); }
    let isHtmlMode = false;
    function toggleHtmlMode() {
        const editorEl = document.getElementById('editor'); const textareaEl = document.getElementById('html-textarea'); const btn = document.getElementById('btn-html-view');
        if (!isHtmlMode) { textareaEl.value = quill.root.innerHTML; editorEl.style.display = 'none'; textareaEl.style.display = 'block'; btn.classList.replace('btn-outline', 'btn-warning'); isHtmlMode = true; } 
        else { quill.root.innerHTML = textareaEl.value; editorEl.style.display = 'block'; textareaEl.style.display = 'none'; btn.classList.replace('btn-warning', 'btn-outline'); isHtmlMode = false; }
    }
    function applyBoxedTitle(level) {
        const range = quill.getSelection(); if (!range) return alert("è«‹å…ˆé»é¸ä¸€è¡Œæ–‡å­—"); const headerLevel = level === 'h2' ? 2 : 3; const className = level === 'h2' ? 'title-boxed-h2' : 'title-boxed-h3';
        quill.format('header', headerLevel); setTimeout(() => { const [line, offset] = quill.getLine(range.index); if (line && line.domNode) { line.domNode.classList.remove('title-boxed-h2', 'title-boxed-h3'); line.domNode.classList.add(className); } }, 10);
    }
    const _oldSave = saveArticle; saveArticle = async function() { if (isHtmlMode) { quill.root.innerHTML = document.getElementById('html-textarea').value; } await _oldSave(); };
    function initRealtimeListener() {
        console.log("ğŸ“¡ å•Ÿå‹•è¨‚å–®ç›£è½ç³»çµ±...");
        myDB.channel('custom-all-channel').on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'bookings' }, (payload) => {
            if (payload.new.status === 'completed' && payload.old.status !== 'completed') {
                const notify = document.createElement('div'); notify.style.cssText = "position:fixed; bottom:20px; right:20px; background:#1a2f23; color:white; padding:15px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.2); z-index:9999; animation: fadeIn 0.5s;"; notify.innerHTML = `âœ… è¨‚å–®å·²è‡ªå‹•çµæ¡ˆï¼Œåˆ—è¡¨å·²åˆ·æ–°`; document.body.appendChild(notify); setTimeout(() => notify.remove(), 3000); fetchAll(); 
            }
        }).subscribe();
    }
    initRealtimeListener();
    // ==========================================
    // ğŸ“± æ‰‹æ©Ÿç‰ˆäº’å‹•å„ªåŒ–è…³æœ¬ (è«‹è²¼åœ¨ script æœ€ä¸‹é¢)
    // ==========================================

    // 1. æ‰‹æ©Ÿç‰ˆè¼‰å…¥æ™‚ï¼Œé è¨­ã€Œéš±è—é¸å–®ã€
    if (window.innerWidth <= 1024) {
        document.body.classList.add('hide-nav');
    }

    // 2. é»æ“Šã€Œå³å´å…§å®¹å€ (Main)ã€æ™‚ï¼Œè‡ªå‹•é—œé–‰é¸å–®
    document.querySelector('.main').addEventListener('click', function(e) {
        // å¦‚æœæ˜¯æ‰‹æ©Ÿç‰ˆ ä¸” é¸å–®ç›®å‰æ˜¯æ‰“é–‹çš„ (æ²’æœ‰ hide-nav class)
        if (window.innerWidth <= 1024 && !document.body.classList.contains('hide-nav')) {
            
            // é¿å…é»åˆ°ã€Œé¸å–®é–‹é—œæŒ‰éˆ•ã€æ™‚é‡è¤‡è§¸ç™¼
            if (e.target.closest('button[onclick="toggleMainSidebar()"]')) return;
            
            // åŸ·è¡Œé—œé–‰
            toggleMainSidebar();
        }
    });
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>åŸ¹ç™’ä¸­æ§å®¤ V21 | è©³æƒ…ä¿®å¾©ç‰ˆ</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        /* ================= æ¨£å¼è¡¨ (CSS) ================= */
        :root { --forest: #1a2f23; --cream: #fdfaf1; --accent: #c6a87c; --dark: #2c3e50; --danger: #e74c3c; --info: #3498db; --success: #27ae60; --warning: #f39c12; --purple: #9b59b6; }
        * { box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: #f4f7f6; margin: 0; display: flex; }
        
        /* å´é‚Šæ¬„ */
        .sidebar { width: 240px; background: var(--forest); height: 100vh; color: white; position: fixed; box-shadow: 2px 0 10px rgba(0,0,0,0.1); overflow-y: auto; z-index: 100; }
        .sidebar h2 { text-align: center; color: var(--accent); padding: 25px 0; border-bottom: 1px solid #2a3f33; margin: 0; }
        .sidebar button { width: 100%; padding: 18px; background: none; border: none; color: #ccc; text-align: left; cursor: pointer; border-bottom: 1px solid #2a3f33; font-size: 14px; transition: 0.2s; }
        .sidebar button:hover { background: #2a3f33; color: white; }
        .sidebar button.active { background: #2a3f33; color: var(--accent); font-weight: bold; border-left: 5px solid var(--accent); }
        
        /* ä¸»å…§å®¹å€ */
        .main { margin-left: 240px; padding: 30px; flex: 1; min-height: 100vh; display:none; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* å¡ç‰‡èˆ‡å…ƒä»¶ */
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; border-top: 4px solid var(--accent); }
        
        /* è¡¨æ ¼èˆ‡æŒ‰éˆ• */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { background: #f8f9fa; color: #666; font-weight: bold; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; font-size: 14px; }
        tr:hover { background: #fdfaf1; }
        
        .btn { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; font-size: 13px; transition:0.2s; display: inline-block; margin-right: 5px; }
        .btn:hover { opacity: 0.8; transform: translateY(-1px); }
        .btn-forest { background: var(--forest); color: white; }
        .btn-info { background: var(--info); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-purple { background: var(--purple); color: white; }
        .btn-outline { background: white; border: 1px solid #ccc; color: #666; }
        .btn-sort { background: #7f8c8d; padding: 4px 8px; font-size: 12px; color:white; line-height: 1; }

        /* æ¨™ç±¤æ¨£å¼ */
        .tag-main { background: #d32f2f; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight:bold; }
        .tag-addon { background: #1976d2; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; }
        .tag-file { background: #9b59b6; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px; }

        /* SQL æç¤ºå€å¡Š */
        .sql-hint-box { background: #fff3cd; border: 1px solid #ffeeba; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 12px; color: #856404; }
        .code-block { background: #eee; padding: 5px; border-radius: 3px; font-family: monospace; display: block; margin-top: 5px; word-break: break-all; border: 1px solid #ccc; cursor: pointer; }
        
        /* Modal å½ˆçª— */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; }
        .modal-body { background: white; width: 90%; max-width: 700px; padding: 30px; border-radius: 15px; position: relative; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .id-card { background: #f0f7ff; padding: 15px; border-radius: 10px; border-left: 5px solid var(--info); margin-bottom: 15px; }

        /* ç™»å…¥é– */
        #admin-lock { position: fixed; top:0; left:0; width:100%; height:100vh; background: var(--forest); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
        #admin-lock input { padding: 10px; border-radius: 5px; border: none; width: 200px; margin-bottom: 10px; text-align: center; }

        /* å„€è¡¨æ¿ä½ˆå±€ */
        .dashboard-layout { display: grid; grid-template-columns: 2.5fr 1fr; gap: 20px; }
        .upcoming-day { margin-bottom: 15px; border-bottom: 1px dashed #eee; padding-bottom: 10px; }
        .upcoming-day-header { font-weight: bold; color: var(--forest); margin-bottom: 5px; font-size: 14px; }
        .upcoming-slots { display: flex; flex-wrap: wrap; gap: 5px; }
        .u-slot { font-size: 11px; padding: 3px 8px; border-radius: 4px; background: #f0f7ff; border: 1px solid #d6e9f9; color: #2980b9; }
        .u-slot.booked { background: #fff5f5; border-color: #e74c3c; color: #c0392b; text-decoration: line-through; opacity: 0.7; }

        /* æ’ç¨‹èˆ‡æœˆæ›† */
        .batch-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; }
        .batch-slot { position: relative; }
        .batch-slot input { position: absolute; opacity: 0; cursor: pointer; }
        .batch-slot label { display: block; padding: 8px; background: #fff; border: 1px solid #ccc; border-radius: 5px; text-align: center; font-size: 13px; cursor: pointer; transition: 0.2s; }
        .batch-slot input:checked + label { background: var(--forest); color: white; border-color: var(--forest); }
        .calendar-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; background: #fff; }
        .cal-header { text-align: center; font-weight: bold; padding: 5px; background: #eee; font-size: 12px; }
        .cal-cell { border: 1px solid #eee; min-height: 80px; padding: 5px; cursor: pointer; position: relative; background: white; transition: 0.2s; }
        .cal-cell:hover { background: #f9f9f9; border-color: var(--accent); }
        .cal-cell.active { border: 2px solid var(--forest); background: #f0f7ff; }
        .cal-cell.empty { background: #fafafa; cursor: default; }
        .cal-date { font-weight: bold; font-size: 14px; margin-bottom: 5px; }
        .cal-stat { font-size: 11px; display: block; margin-top: 2px; }
        .dot-free { color: var(--info); }
        .dot-booked { color: var(--danger); }
        .day-detail-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; }
        .compact-slot { padding: 5px; border: 1px solid #ddd; border-radius: 4px; text-align: center; font-size: 12px; background: white; position: relative; }
        .compact-slot.booked { background: #fff5f5; color: #c0392b; border-color: #e74c3c; }
        .compact-slot.free { background: #f0f7ff; color: #2980b9; border-color: #3498db; }
        .compact-del { position: absolute; top:-5px; right:-5px; background:red; color:white; width:15px; height:15px; border-radius:50%; font-size:10px; line-height:15px; cursor:pointer; display:none; }
        .compact-slot:hover .compact-del { display: block; }

        /* æœå‹™åˆ—è¡¨ç®¡ç†æ¨£å¼ */
        .admin-row { display: flex; gap: 10px; align-items: center; padding: 8px; border-bottom: 1px solid #eee; font-size: 13px; }
        .admin-row:hover { background: #e8f5e9; }
        input, select, textarea { padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-family:inherit; }
    </style>
</head>
<body>

<div id="admin-lock">
    <h2 style="color:var(--accent);">ğŸ”’ åŸ¹ç™’ä¸­æ§å®¤</h2>
    <input type="password" id="admin-pwd" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
    <button class="btn btn-warning" onclick="checkAdmin()">é€²å…¥ç³»çµ±</button>
</div>

<div class="sidebar">
    <h2>åŸ¹ç™’æ§åˆ¶ä¸­å¿ƒ</h2>
    <button onclick="switchTab('bks')" id="nav-bks" class="active">ğŸ“… é ç´„çœ‹æ¿</button>
    <button onclick="switchTab('schedule')" id="nav-schedule">ğŸ•’ æ’ç¨‹ç®¡ç†</button>
    <button onclick="switchTab('pro')" id="nav-pro">ğŸ‘¤ å€‹æ¡ˆ CRM</button>
    <button onclick="switchTab('menu')" id="nav-menu">âš™ï¸ æœå‹™é…ç½®</button>
</div>

<div class="main">
    
    <div id="tab-bks" class="tab-content active">
        <div class="dashboard-layout">
            <div>
                <div style="display:flex; gap:15px; margin-bottom:20px;">
                    <div class="stat-card" style="flex:1; border-top-color:var(--success);">
                        <small>ğŸ’° æœ¬æœˆå¯¦æ”¶ç‡Ÿæ”¶</small><h2 id="inc-val" style="color:var(--success); margin:5px 0;">$0</h2>
                    </div>
                    <div class="stat-card" style="flex:1; border-top-color:var(--info);">
                        <small>ğŸ‘¤ ç´¯ç©å€‹æ¡ˆæ•¸</small><h2 id="total-val" style="margin:5px 0;">0</h2>
                    </div>
                </div>

                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3>ğŸ“‹ è¿‘æœŸé ç´„æ¸…å–®</h3>
                        <button class="btn btn-outline" onclick="fetchAll()">ğŸ”„ åˆ·æ–°</button>
                    </div>
                    <input type="text" id="search-key" placeholder="ğŸ” æœå°‹ å§“å / æ‰‹æ©Ÿ / å–®è™Ÿ..." style="padding:10px; width:100%; border:1px solid #ddd; border-radius:6px; margin-bottom:15px;" onkeyup="renderUI()">
                    <table>
                        <thead><tr><th>æ—¥æœŸ/å–®è™Ÿ</th><th>å€‹æ¡ˆè³‡è¨Š</th><th>æœå‹™å…§å®¹</th><th>é‡‘é¡</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead>
                        <tbody id="bk-list"></tbody>
                    </table>
                </div>
            </div>

            <div>
                <div class="card" style="height: calc(100vh - 60px); overflow-y: auto; border-top-color: var(--purple);">
                    <h3 style="color:var(--purple); border-bottom:1px solid #eee; padding-bottom:10px; margin-top:0;">
                        ğŸ“… æœªä¾† 7 å¤©æ’ç¨‹
                    </h3>
                    <div id="dashboard-7day-schedule">
                        <p style="color:#999; font-size:12px;">è¼‰å…¥ä¸­...</p>
                    </div>
                    <button class="btn btn-outline" style="width:100%; margin-top:15px;" onclick="switchTab('schedule')">å‰å¾€å®Œæ•´æ’ç¨‹ç®¡ç† &gt;</button>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-schedule" class="tab-content">
        <div style="display: flex; gap: 20px; height: calc(100vh - 100px);">
            <div class="schedule-sidebar card" style="width:280px; flex-shrink:0; overflow-y:auto;">
                <h4 style="color:var(--forest); margin-top:0;">âš¡ å¿«é€Ÿæ’ç­</h4>
                <div style="background:#f9f9f9; padding:10px; border-radius:8px; margin-bottom:15px;">
                    <label>æ—¥æœŸå€é–“</label>
                    <div style="display:flex; gap:2px;">
                        <input type="date" id="batch-start" style="width:48%; font-size:11px;">
                        <span style="font-size:10px; padding-top:5px;">~</span>
                        <input type="date" id="batch-end" style="width:48%; font-size:11px;">
                    </div>
                </div>
                <label>å‹¾é¸æ™‚æ®µ (æ¯30åˆ†)</label>
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <button class="btn btn-outline" style="font-size:10px; width:50%;" onclick="toggleAllSlots(true)">å…¨é¸</button>
                    <button class="btn btn-outline" style="font-size:10px; width:50%;" onclick="toggleAllSlots(false)">æ¸…ç©º</button>
                </div>
                <div id="time-grid" class="batch-grid"></div>
                <button class="btn btn-forest" style="width:100%; margin-top:15px;" onclick="batchAddSchedule()">ğŸš€ ç”Ÿæˆæ’ç¨‹</button>
            </div>
            <div class="card" style="flex: 2; display:flex; flex-direction:column;">
                <div class="calendar-controls">
                    <button class="btn btn-outline" onclick="changeMonth(-1)">â—€ ä¸Šå€‹æœˆ</button>
                    <h3 id="cal-title" style="margin:0;">2025 å¹´ 12 æœˆ</h3>
                    <button class="btn btn-outline" onclick="changeMonth(1)">ä¸‹å€‹æœˆ â–¶</button>
                </div>
                <div style="display:grid; grid-template-columns: repeat(7, 1fr); text-align:center; background:#eee;">
                    <div class="cal-header" style="color:red">æ—¥</div>
                    <div class="cal-header">ä¸€</div>
                    <div class="cal-header">äºŒ</div>
                    <div class="cal-header">ä¸‰</div>
                    <div class="cal-header">å››</div>
                    <div class="cal-header">äº”</div>
                    <div class="cal-header" style="color:green">å…­</div>
                </div>
                <div id="calendar-body" class="calendar-grid" style="flex:1; overflow-y:auto;"></div>
            </div>
            <div class="card" style="width:250px; flex-shrink:0; background:#fdfdfd;">
                <h4 id="detail-date-title" style="margin-top:0; color:var(--dark); border-bottom:2px solid var(--accent); padding-bottom:10px;">è«‹é¸æ“‡æ—¥æœŸ</h4>
                <div id="day-detail-container" class="day-detail-list">
                    <p style="color:#999; font-size:13px;">é»æ“Šæœˆæ›†æ—¥æœŸ<br>æŸ¥çœ‹ç•¶æ—¥æ™‚æ®µè©³æƒ…</p>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-pro" class="tab-content">
        <div class="card">
            <h3>ğŸ‘¤ å€‹æ¡ˆè³‡æ–™åº«</h3>
            <table>
                <thead><tr><th width="15%">å§“å</th><th width="15%">æ‰‹æ©Ÿ</th><th width="15%">ç´¯ç©æ¶ˆè²»</th><th width="15%">æœ€è¿‘é ç´„</th><th width="20%">å¸³è™Ÿè³‡è¨Š</th><th width="20%">æ“ä½œ</th></tr></thead>
                <tbody id="pro-list"></tbody>
            </table>
        </div>
    </div>

    <div id="tab-menu" class="tab-content">
        <div style="display:grid; grid-template-columns: 1fr 1.2fr; gap:20px;">
            <div class="card" id="card-cat">
                <h3>ğŸ“‚ å¤§é¡ç®¡ç†</h3>
                <input type="hidden" id="cat-id-edit">
                <input type="text" id="cat-name" placeholder="å¤§é¡åç¨±" style="width:100%; margin-bottom:10px; padding:8px;">
                <select id="cat-type" style="width:100%; margin-bottom:10px; padding:8px;"><option value="sleep">è©¢å•ç¡çœ  (èª¿é »é¡)</option><option value="consult">è©¢å•æ—¥æœŸ (è«®è©¢é¡)</option></select>
                <textarea id="cat-terms" placeholder="æœå‹™è¦ç¯„æ¢æ¬¾" style="width:100%; height:80px; margin-bottom:10px; padding:8px;"></textarea>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-forest" id="btn-cat-save" onclick="saveCategory()">ï¼‹ æ–°å¢</button>
                    <button class="btn btn-outline" id="btn-cat-cancel" onclick="cancelEdit('cat')" style="display:none;">å–æ¶ˆ</button>
                </div>
                <table id="cat-list" style="margin-top:15px;"></table>
            </div>
            
            <div class="card" id="card-svc">
                <h3>âš™ï¸ ç´°é …ç®¡ç†</h3>
                
                <div class="sql-hint-box">
                    <strong>ğŸ’¡ ç³»çµ±æç¤ºï¼š</strong> è‹¥å­˜æª”å¤±æ•—ï¼Œè«‹ç¢ºèªè³‡æ–™åº«æœ‰ <code>report_template</code> æ¬„ä½ã€‚<br>
                    <code class="code-block" onclick="copyCode(this)" title="é»æ“Šè¤‡è£½">ALTER TABLE services ADD COLUMN report_template TEXT DEFAULT 'srt_report.html';</code>
                </div>

                <input type="hidden" id="svc-id-edit">
                
                <select id="svc-cat-filter" style="width:100%; margin-bottom:10px; padding:8px; border:2px solid var(--info); background:#f0f8ff;" onchange="filterServiceList()">
                    <option value="">è¼‰å…¥ä¸­...</option>
                </select>

                <input type="text" id="i-name" placeholder="é …ç›®å" style="width:100%; margin-bottom:10px; padding:8px;">
                <input type="number" id="i-price" placeholder="åƒ¹æ ¼" style="width:100%; margin-bottom:10px; padding:8px;">
                
                <label style="display:flex; align-items:center; gap:5px; margin-bottom:10px; color:var(--danger); font-weight:bold; cursor:pointer; background:#fff3e0; padding:5px; border-radius:5px;">
                    <input type="checkbox" id="i-is-main" style="width:18px; height:18px;" onchange="toggleSubOptionInput()"> 
                    è¨­ç‚ºä¸»é …ç›® (å–®é¸äº’æ–¥ï¼Œç„¡å­é¸é …)
                </label>

                <div id="main-opt-wrapper" style="display:none;">
                    <input type="text" id="i-report-tpl" placeholder="å°æ‡‰å ±å‘Šæª”æ¡ˆ (ä¾‹: srt_report.html)" style="width:100%; margin-bottom:10px; padding:8px; border:1px solid var(--purple); background:#fdfaff;">
                    <small style="color:var(--purple); display:block; margin-top:-8px; margin-bottom:10px;">ğŸ’¡ è‹¥ç‚ºä¸»é …ç›®ï¼Œè«‹å¡«å¯«æ­¤æ¬„ä»¥é€£çµå ±è¡¨ã€‚</small>
                </div>

                <div id="sub-opt-wrapper">
                    <input type="text" id="i-sub-opts" placeholder="å­é¸é … (é€—è™Ÿéš”é–‹)" style="width:100%; margin-bottom:10px; padding:8px;">
                    <small style="color:#666; display:block; margin-top:-8px; margin-bottom:10px;">ğŸ’¡ åŠ è³¼é …ç›®æ‰éœ€è¦</small>
                </div>

                <div style="display:flex; gap:10px;">
                    <button class="btn btn-forest" id="btn-svc-save" onclick="saveItem()">ï¼‹ æ–°å¢</button>
                    <button class="btn btn-outline" id="btn-svc-cancel" onclick="cancelEdit('svc')" style="display:none;">å–æ¶ˆ</button>
                </div>
                
                <div style="max-height:400px; overflow-y:auto; margin-top:15px; border:1px solid #eee; border-radius:8px;" id="svc-list-container">
                    <p style="padding:10px; color:#999;">è«‹å…ˆé¸æ“‡ä¸Šæ–¹çš„å¤§é¡...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modal" class="modal">
    <div class="modal-body">
        <span onclick="closeModal()" style="position:absolute;right:20px;top:15px;cursor:pointer;font-size:24px;">Ã—</span>
        <h2 id="m-title">è©³æƒ…</h2>
        <div id="m-content"></div>
    </div>
</div>

<script>
    const SB_URL = "https://geyrpowhaqfhnxghpokr.supabase.co";
    const SB_KEY = "sb_publishable_aXucdq8UtvMbCKbriqpJCw_gtpYBw-r"; 
    const myDB = supabase.createClient(SB_URL, SB_KEY);
    
    let cache = { bks:[], pros:[], cats:[], svcs:[], slots:[] };
    const cleanPhone = (p) => p ? p.replace(/\D/g, '') : '';

    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth() + 1;
    let selectedDateStr = "";

    function checkAdmin() {
        if(document.getElementById('admin-pwd').value === "admin888") { 
            document.getElementById('admin-lock').style.display = 'none';
            document.querySelector('.main').style.display = 'block';
            fetchAll(); 
        } else { alert("å¯†ç¢¼éŒ¯èª¤"); }
    }

    async function fetchAll() {
        try {
            const { data: b } = await myDB.from('bookings').select('*, profiles(*)').order('created_at',{ascending:false}).limit(100);
            const { data: p } = await myDB.from('profiles').select('*').order('created_at',{ascending:false});
            const { data: c } = await myDB.from('service_categories').select('*').order('created_at');
            
            // ğŸŒŸ å®¹éŒ¯æŸ¥è©¢
            let { data: s, error: svcErr } = await myDB.from('services').select('*');
            if (svcErr) { console.error("Service fetch err:", svcErr); s = []; }
            else { s.sort((a,b) => (a.sort_order||0) - (b.sort_order||0)); }

            const { data: sl } = await myDB.from('schedule_slots').select('*').order('slot_date').order('slot_time');

            cache = { bks:b||[], pros:p||[], cats:c||[], svcs:s||[], slots:sl||[] };
            
            renderUI();
            renderTimeGrid();
            renderCalendar(); 
            if(selectedDateStr) selectDate(selectedDateStr);

        } catch (e) {
            console.error(e);
            alert("è³‡æ–™è¼‰å…¥ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
        }
    }

    function renderUI() {
        const search = document.getElementById('search-key').value.trim().toUpperCase();
        const cleanSearch = cleanPhone(search);
        
        document.getElementById('bk-list').innerHTML = cache.bks.filter(x => {
            const str = JSON.stringify(x).toUpperCase();
            const phone = x.profiles?.phone || x.temp_phone || '';
            const cPhone = cleanPhone(phone);
            return !search || str.includes(search) || phone.includes(search) || cPhone.includes(cleanSearch);
        }).map(x => {
            const phone = x.profiles?.phone || x.temp_phone;
            const hasPro = !!x.profiles;
            const potentialMatch = !hasPro ? cache.pros.find(p => cleanPhone(p.phone) === cleanPhone(phone)) : null;

            let preName = 'æ–°å€‹æ¡ˆ';
            if (x.wish_detail) { const nm = x.wish_detail.match(/å§“å:(.*?) \|/); if(nm) preName = nm[1].trim(); }

            let userHtml = hasPro ? `<b>${x.profiles.full_name}</b><br><small>${x.profiles.phone}</small>` :
                           potentialMatch ? `<b style="color:var(--info)">[ç–‘ä¼¼] ${potentialMatch.full_name}</b><br><button class="btn btn-success" style="font-size:10px;padding:2px;" onclick="linkUser('${potentialMatch.id}', '${x.id}')">æ­¸æˆ¶</button>` :
                           `<b>${preName}</b><br><button class="btn btn-info" style="font-size:10px;padding:2px;" onclick="openCreateMemberModal('${phone}', '${x.id}', '${preName}', '')">ï¼‹å»ºç«‹</button>`;

            let stColor = '#e74c3c'; let stText = 'æœªä»˜æ¬¾';
            if(x.status === 'paid') { stColor = '#27ae60'; stText = 'å·²ä»˜æ¬¾'; }
            else if(x.status === 'awaiting_payment') { stColor = '#f39c12'; stText = 'å¾…ä»˜æ¬¾'; }
            else if(x.status === 'awaiting_service') { stColor = '#9b59b6'; stText = 'æœå‹™ä¸­'; }
            else if(x.status === 'completed') { stColor = '#2c3e50'; stText = 'å·²å®Œæˆ'; }

            return `<tr>
                <td><small style="color:#999">${x.created_at.slice(0,10)}</small><br><small>${x.booking_id.slice(-6)}</small></td>
                <td>${userHtml}</td>
                <td><small>${x.service_item}</small></td>
                <td>$${x.price}</td>
                <td><span style="color:${stColor}; font-weight:bold;">${stText}</span></td>
                <td><button class="btn btn-forest" onclick="openBooking('${x.id}')">è©³æƒ…</button></td>
            </tr>`;
        }).join('');

        const currentMonth = new Date().toISOString().slice(0, 7);
        const inc = cache.bks.filter(x => x.status === 'paid' && x.created_at.startsWith(currentMonth)).reduce((s, x) => s + (x.price || 0), 0);
        document.getElementById('inc-val').innerText = "$" + inc.toLocaleString();
        document.getElementById('total-val').innerText = cache.pros.length;

        document.getElementById('pro-list').innerHTML = cache.pros.map(p => {
            const userBks = cache.bks.filter(b => b.user_id === p.id || cleanPhone(b.temp_phone) === cleanPhone(p.phone));
            const totalSpent = userBks.filter(b => b.status === 'paid').reduce((sum, b) => sum + (b.price||0), 0);
            const lastBk = userBks.length > 0 ? userBks[0].created_at.slice(0,10) : '-';
            return `<tr><td>${p.full_name}</td><td>${p.phone}</td><td style="color:#d35400;">$${totalSpent.toLocaleString()}</td><td>${lastBk}</td><td><small>${p.email||'-'}</small></td><td><button class="btn btn-info" onclick="showHistory('${p.id}', '${p.full_name}')">æ­·å²</button><button class="btn btn-warning" onclick="editProfile('${p.id}')">æ”¹</button></td></tr>`;
        }).join('');

        renderConfigTables();
        render7DaySchedule();
    }

    // ğŸŒŸ æ ¸å¿ƒï¼šæ™ºæ…§åˆ¤æ–·é–‹å•Ÿå“ªå¼µå ±è¡¨ ğŸŒŸ
    function openBooking(id) {
        try {
            const b = cache.bks.find(x => x.id === id);
            if(!b) { alert("æ‰¾ä¸åˆ°è¨‚å–®è³‡æ–™"); return; }
            
            // é˜²å‘†
            const wishDetail = b.wish_detail || '';
            const serviceDetail = b.service_detail || '';
            const serviceItem = b.service_item || '';

            const cleanDetail = wishDetail.replace(/\| \[ä»˜æ¬¾ç¢¼.*?\]/g, '');
            let extractName="æœªçŸ¥", extractEmail="æœªçŸ¥", extractData=cleanDetail;
            const nm=cleanDetail.match(/å§“å:(.*?) \|/), em=cleanDetail.match(/Email:(.*?) \|/), dt=cleanDetail.match(/æ•¸æ“š:(.*)/);
            if(nm) extractName=nm[1]; if(em) extractEmail=em[1]; if(dt) extractData=dt[1];

            // 1. ğŸ” å°‹æ‰¾ä¸»é …ç›®æœå‹™
            const mainService = (cache.svcs || []).find(s => s.is_main && serviceDetail.includes(s.title));

            let reportTemplate = "srt_report.html"; 
            let btnLabel = "ğŸ“„ ç”Ÿæˆæœå‹™å ±å‘Š";
            
            if (mainService && mainService.report_template) {
                reportTemplate = mainService.report_template;
                btnLabel = `ğŸ“„ ç”Ÿæˆ ${mainService.title} å ±å‘Š`;
            }

            const reportMatch = wishDetail.match(/\[å ±å‘Šå·²ç”Ÿæˆ ID:(.*?)\]/);
            const existingReportId = reportMatch ? reportMatch[1] : null;
            let reportUrl = "";
            let btnClass = "btn-forest";

            if (existingReportId) {
                reportUrl = `${reportTemplate}?id=${existingReportId}`;
                btnLabel = "ğŸ“„ æŸ¥çœ‹ / ä¿®æ”¹å·²å­˜å ±å‘Š";
                btnClass = "btn-purple";
            } else {
                reportUrl = `${reportTemplate}?bid=${b.id}&name=${encodeURIComponent(extractName)}&phone=${b.temp_phone}`;
            }

            const serviceListHtml = serviceDetail.split(' | ').map(item => {
                const matchedSvc = (cache.svcs||[]).find(s => item.includes(s.title));
                return `<div style="display:flex; justify-content:space-between; margin-bottom:5px; border-bottom:1px dashed #eee;"><span>${item}</span><span style="color:#666;">${matchedSvc?'$'+matchedSvc.price:''}</span></div>`;
            }).join('');

            const scheduledTime = b.scheduled_at ? new Date(b.scheduled_at).toLocaleString() : '<span style="color:#999">å°šæœªæ’ç¨‹</span>';
            
            const today = new Date().toISOString().split('T')[0];
            const availableSlots = (cache.slots||[]).filter(s => !s.is_booked && s.slot_date >= today);
            let slotOptions = '<option value="">-- è«‹é¸æ“‡æ’ç¨‹ç©ºæª” --</option>';
            availableSlots.forEach(s => { slotOptions += `<option value="${s.id}" data-time="${s.slot_date} ${s.slot_time}">${s.slot_date} ${s.slot_time.slice(0,5)}</option>`; });

            document.getElementById('m-title').innerText = "é ç´„è©³æƒ…";
            document.getElementById('m-content').innerHTML = `
                <div class="id-card" style="background:#f0f7ff; padding:15px;">
                    <b>${extractName}</b> <small>(${!!b.profiles?'æœƒå“¡':'è¨ªå®¢'})</small><br>
                    <small>${b.temp_phone} | ${extractEmail}</small>
                </div>
                <div style="margin-top:15px; background:#fafafa; padding:10px; border-radius:8px;">
                    <b>${serviceItem}</b>
                    ${serviceListHtml}
                    <div style="margin-top:5px; color:#999; font-size:12px;">é€£çµï¼š${mainService ? 'âœ… '+mainService.title : 'âš ï¸ é è¨­'}</div>
                </div>
                <div style="margin-top:15px; background:#fffdf0; padding:10px; border:1px solid #eee; border-radius:8px;">
                    ${extractData}
                    <div style="margin-top:10px; padding-top:10px; border-top:1px dashed #ccc; color:#d35400;">ğŸ’¡ å®¢äººè¨±é¡˜ï¼š${b.sleep_time || 'ç„¡'}</div>
                </div>
                <div style="margin-top:15px; padding:15px; background:#f3e5f5; border-radius:8px;">
                    <div style="margin-bottom:10px; display:flex; justify-content:space-between;">
                        <span><b>ğŸ“… é è¨ˆæœå‹™ï¼š</b> <span style="font-size:1.1em; color:var(--purple);">${scheduledTime}</span></span>
                        ${b.scheduled_at ? `<button class="btn btn-outline" style="font-size:12px;padding:2px 5px;" onclick="document.getElementById('schedule-box').style.display='block'">âœ</button>` : ''}
                    </div>
                    <div id="schedule-box" style="display:${b.scheduled_at ? 'none' : 'block'};">
                        ${b.status === 'paid' || b.scheduled_at ? `<div style="display:flex; gap:10px;"><select id="slot-selector" style="flex:1;">${slotOptions}</select><button class="btn btn-purple" onclick="saveSchedule('${b.id}')">æ’å…¥</button></div>` : '<small style="color:#999">æœªä»˜æ¬¾ç„¡æ³•æ’ç¨‹</small>'}
                    </div>
                </div>
                ${b.status === 'awaiting_service' || b.status === 'completed' ? `<div style="margin-top:15px; padding:15px; background:#e8f5e9; border-radius:8px; text-align:center;"><a href="${reportUrl}" target="_blank" class="btn ${btnClass}" style="text-decoration:none; display:block; width:100%;">${btnLabel}</a><div style="margin-top:5px; font-size:11px; color:#666;">ç›®æ¨™æª”æ¡ˆ: ${reportTemplate}</div></div>` : ''}
                <div style="margin-top:20px; text-align:right;"><div style="font-size:24px; color:#d35400; font-weight:bold; margin-bottom:10px;">$${b.price}</div>${renderActionButtons(b)}</div>
            `;
            document.getElementById('modal').style.display = 'flex';
        } catch (err) {
            console.error(err);
            alert("è©³æƒ…é–‹å•Ÿå¤±æ•—: " + err.message);
        }
    }

    async function saveSchedule(bid) {
        const sel = document.getElementById('slot-selector');
        if(!sel.value) return alert("è«‹é¸æ™‚æ®µ");
        const timeText = sel.options[sel.selectedIndex].dataset.time;
        
        await myDB.from('bookings').update({ scheduled_at: timeText, status: 'awaiting_service' }).eq('id', bid);
        await myDB.from('schedule_slots').update({ is_booked: true }).eq('id', sel.value);
        
        alert("âœ… æ’ç¨‹æˆåŠŸï¼"); closeModal(); fetchAll();
    }

    // ğŸŒŸ è£œå›ä¾†çš„ renderActionButtons ğŸŒŸ
    function renderActionButtons(b) {
        if (b.status === 'paid') return `<button class="btn" style="background:#ccc;">å¾…æ’ç¨‹ (è«‹ä¸Šæ–¹é¸æ™‚æ®µ)</button>`;
        if (b.status === 'awaiting_service') return `<span style="color:var(--purple); font-weight:bold; margin-right:10px;">â³ æœå‹™ä¸­...</span><button class="btn btn-forest" onclick="updateS('${b.id}','completed')">âœ… çµæ¡ˆ</button>`;
        if (b.status === 'completed') return `<button class="btn" style="background:#ccc;">ğŸ‰ å·²çµæ¡ˆ</button>`;
        if (b.status === 'pending') return `<button class="btn btn-info" onclick="sendPayLink('${b.id}', '${b.price}')">ğŸ“§ å‚³ä»˜æ¬¾ç¢¼</button>`;
        if (b.status === 'awaiting_payment') return `<button class="btn btn-success" onclick="updateS('${b.id}','paid')">ğŸ’° ç¢ºèªå…¥å¸³</button>`;
        if (b.payment_method === 'shopee') return `<button class="btn btn-success" onclick="updateS('${b.id}','paid')">ç¢ºèªè¦çš®å…¥å¸³</button>`;
        return "";
    }

    // --- æœå‹™é…ç½®èˆ‡ CRUD ---
    function renderConfigTables() {
        document.getElementById('cat-list').innerHTML=cache.cats.map(c=>`<tr><td>${c.name}</td><td><button onclick="editCat('${c.id}')">âœï¸</button><button onclick="delData('service_categories','${c.id}')">ğŸ—‘ï¸</button></td></tr>`).join('');
        
        const sel = document.getElementById('svc-cat-filter');
        const oldVal = sel.value;
        sel.innerHTML = `<option value="">-- è«‹é¸æ“‡å¤§é¡ä»¥ç®¡ç†é …ç›® --</option>` + cache.cats.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        if(oldVal && cache.cats.find(c=>c.id===oldVal)) { sel.value = oldVal; } 
        else if (cache.cats.length > 0) { sel.value = cache.cats[0].id; }
        
        filterServiceList();
    }

    function filterServiceList() {
        const catId = document.getElementById('svc-cat-filter').value;
        const listContainer = document.getElementById('svc-list-container');
        if (!catId) { listContainer.innerHTML = "<p style='padding:10px;'>è«‹å…ˆé¸æ“‡å¤§é¡</p>"; return; }
        const filteredSvcs = cache.svcs.filter(s => s.category_id === catId);
        if (filteredSvcs.length === 0) { listContainer.innerHTML = "<p style='padding:10px; color:#999;'>æ­¤é¡åˆ¥å°šç„¡é …ç›®</p>"; return; }

        listContainer.innerHTML = filteredSvcs.map((s, index) => {
            const tag = s.is_main ? `<span class="tag-main">ä¸»</span>` : `<span class="tag-addon">åŠ </span>`;
            const fileTag = s.report_template ? `<span class="tag-file">ğŸ“„ ${s.report_template}</span>` : '';
            const isFirst = index === 0; const isLast = index === filteredSvcs.length - 1;
            return `
                <div class="admin-row">
                    <div style="display:flex; flex-direction:column; gap:2px; margin-right:5px;">
                        <button class="btn btn-sort" onclick="moveService('${s.id}', -1)" ${isFirst?'disabled style="opacity:0.3"':''}>â–²</button>
                        <button class="btn btn-sort" onclick="moveService('${s.id}', 1)" ${isLast?'disabled style="opacity:0.3"':''}>â–¼</button>
                    </div>
                    <div style="flex:1">
                        <b>${s.title}</b> <span style="color:#d35400">$${s.price}</span>
                        ${tag} ${fileTag}
                        ${s.sub_options ? `<br><small style="color:#666">â”” ${s.sub_options}</small>` : ''}
                    </div>
                    <button class="btn btn-info" onclick="editSvc('${s.id}')" style="padding:2px 8px; font-size:12px;">ä¿®</button>
                    <button class="btn btn-danger" onclick="delData('services','${s.id}')" style="padding:2px 8px; font-size:12px;">åˆª</button>
                </div>
            `;
        }).join('');
    }

    async function moveService(id, direction) {
        const catId = document.getElementById('svc-cat-filter').value;
        let currentList = cache.svcs.filter(s => s.category_id === catId);
        const idx = currentList.findIndex(s => s.id === id);
        if (idx === -1) return;
        const targetIdx = idx + direction;
        if (targetIdx < 0 || targetIdx >= currentList.length) return;
        const temp = currentList[idx]; currentList[idx] = currentList[targetIdx]; currentList[targetIdx] = temp;
        const updates = currentList.map((s, i) => ({ id: s.id, sort_order: (i + 1) * 1000 }));
        document.getElementById('svc-list-container').innerHTML = "<p style='padding:10px;'>æ›´æ–°æ’åºä¸­...</p>";
        for (let item of updates) { await myDB.from('services').update({ sort_order: item.sort_order }).eq('id', item.id); }
        fetchAll();
    }

    function editCat(id){const c=cache.cats.find(x=>x.id===id);document.getElementById('cat-id-edit').value=c.id;document.getElementById('cat-name').value=c.name;document.getElementById('cat-terms').value=c.terms;document.getElementById('btn-cat-save').innerText="ğŸ’¾ å„²å­˜";document.getElementById('btn-cat-cancel').style.display="inline-block";}
    
    function editSvc(id){
        const s=cache.svcs.find(x=>x.id===id);
        document.getElementById('svc-id-edit').value=s.id;
        document.getElementById('i-name').value=s.title;
        document.getElementById('i-price').value=s.price;
        document.getElementById('i-sub-opts').value=s.sub_options||'';
        document.getElementById('i-report-tpl').value=s.report_template||'';
        document.getElementById('i-is-main').checked=s.is_main;
        toggleSubOptionInput();
        document.getElementById('btn-svc-save').innerText="ğŸ’¾ å„²å­˜";
        document.getElementById('btn-svc-cancel').style.display="inline-block";
        document.querySelector('#card-svc').scrollIntoView({behavior:"smooth"});
    }

    function toggleSubOptionInput() {
        const isMain = document.getElementById('i-is-main').checked;
        const mainWrapper = document.getElementById('main-opt-wrapper');
        const subWrapper = document.getElementById('sub-opt-wrapper');
        if (isMain) { mainWrapper.style.display = 'block'; subWrapper.style.display = 'none'; document.getElementById('i-sub-opts').value = ''; } 
        else { mainWrapper.style.display = 'none'; subWrapper.style.display = 'block'; document.getElementById('i-report-tpl').value = ''; }
    }

    async function saveCategory(){const id=document.getElementById('cat-id-edit').value,n=document.getElementById('cat-name').value,t=document.getElementById('cat-type').value,tm=document.getElementById('cat-terms').value; const q=id?myDB.from('service_categories').update({name:n,question_type:t,terms:tm}).eq('id',id):myDB.from('service_categories').insert([{name:n,question_type:t,terms:tm}]); await q; cancelEdit('cat'); fetchAll();}
    
    async function saveItem(){
        const id=document.getElementById('svc-id-edit').value;
        const c=document.getElementById('svc-cat-filter').value;
        const n=document.getElementById('i-name').value;
        const p=document.getElementById('i-price').value;
        const isM=document.getElementById('i-is-main').checked;
        const subs=isM ? '' : document.getElementById('i-sub-opts').value;
        const rpt=document.getElementById('i-report-tpl').value;
        if(!c) return alert("è«‹å…ˆé¸æ“‡å¤§é¡"); if(!n) return alert("è«‹è¼¸å…¥é …ç›®åç¨±");
        let newSort = 0;
        if(!id) { const sibs = cache.svcs.filter(s=>s.category_id === c); const max = sibs.length>0 ? Math.max(...sibs.map(s=>s.sort_order||0)) : 0; newSort = max + 1000; }
        const payload = {category_id:c, title:n, price:p, is_main:isM, sub_options:subs, report_template:rpt};
        if(!id) payload.sort_order = newSort;
        const q=id?myDB.from('services').update(payload).eq('id',id):myDB.from('services').insert([payload]);
        const { error } = await q; if(error) alert(error.message); else { alert("OK"); cancelEdit('svc'); fetchAll(); }
    }

    async function delData(t,id){if(confirm('åˆªé™¤?'))await myDB.from(t).delete().eq('id',id);fetchAll();}
    function cancelEdit(t){ 
        if(t==='cat'){document.getElementById('cat-id-edit').value='';document.getElementById('cat-name').value='';document.getElementById('cat-terms').value='';document.getElementById('btn-cat-save').innerText="ï¼‹ æ–°å¢";document.getElementById('btn-cat-cancel').style.display="none";}
        else{document.getElementById('svc-id-edit').value='';document.getElementById('i-name').value='';document.getElementById('i-price').value='';document.getElementById('i-sub-opts').value='';document.getElementById('i-report-tpl').value='';document.getElementById('i-is-main').checked=false;toggleSubOptionInput();document.getElementById('btn-svc-save').innerText="ï¼‹ æ–°å¢";document.getElementById('btn-svc-cancel').style.display="none";}
    }
    function copyCode(el) { navigator.clipboard.writeText(el.innerText).then(() => alert("æŒ‡ä»¤å·²è¤‡è£½ï¼")); }

    // --- å…±ç”¨åŠŸèƒ½ ---
    function render7DaySchedule() { const container = document.getElementById('dashboard-7day-schedule'); const today = new Date(); let html = ""; for (let i = 0; i < 7; i++) { const d = new Date(today); d.setDate(today.getDate() + i); const dateStr = d.toISOString().split('T')[0]; const dayLabel = `${d.getMonth()+1}/${d.getDate()} (${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()]})`; const daySlots = cache.slots.filter(s => s.slot_date === dateStr).sort((a,b) => a.slot_time.localeCompare(b.slot_time)); if(daySlots.length === 0) continue; else { let slotsHtml = daySlots.map(s => `<span class="u-slot ${s.is_booked ? 'booked' : ''}">${s.slot_time.slice(0,5)}</span>`).join(''); html += `<div class="upcoming-day"><div class="upcoming-day-header">${dayLabel}</div><div class="upcoming-slots">${slotsHtml}</div></div>`; } } container.innerHTML = html || "<p style='color:#999;text-align:center;'>æœªä¾†ä¸€é€±ç„¡æ’ç¨‹</p>"; }
    function renderTimeGrid() { const grid = document.getElementById('time-grid'); if(!grid || grid.innerHTML !== "") return; let html = ''; for (let h = 13; h <= 25; h++) { [0, 30].forEach(m => { let displayH = h >= 24 ? h - 24 : h; let displayTime = `${displayH.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`; let val = `${h}:${m}`; html += `<div class="batch-slot"><input type="checkbox" id="t-${val}" value="${val}" name="batch-times"><label for="t-${val}">${displayTime}</label></div>`; }); } grid.innerHTML = html; }
    async function batchAddSchedule() { const startDateVal = document.getElementById('batch-start').value; let endDateVal = document.getElementById('batch-end').value; if (!endDateVal) endDateVal = startDateVal; if (!startDateVal) return alert("è«‹è‡³å°‘é¸æ“‡é–‹å§‹æ—¥æœŸ"); const checkboxes = document.querySelectorAll('input[name="batch-times"]:checked'); if (checkboxes.length === 0) return alert("è«‹è‡³å°‘å‹¾é¸ä¸€å€‹æ™‚æ®µ"); const { data: existings } = await myDB.from('schedule_slots').select('slot_date, slot_time').gte('slot_date', startDateVal).lte('slot_date', endDateVal); const existingSet = new Set(existings ? existings.map(e => `${e.slot_date}_${e.slot_time.slice(0,5)}`) : []); const start = new Date(startDateVal); const end = new Date(endDateVal); let inserts = []; let skipCount = 0; for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) { checkboxes.forEach(chk => { const [h, m] = chk.value.split(':').map(Number); let currentDay = new Date(d); let finalTimeStr = ""; if (h >= 24) { currentDay.setDate(currentDay.getDate() + 1); finalTimeStr = `${(h-24).toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`; } else { finalTimeStr = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`; } const dateStr = currentDay.toISOString().split('T')[0]; const checkKey = `${dateStr}_${finalTimeStr}`; if (existingSet.has(checkKey)) { skipCount++; } else { inserts.push({ slot_date: dateStr, slot_time: finalTimeStr, is_booked: false }); } }); } if (inserts.length === 0) return alert(`æ‰€æœ‰æ™‚æ®µéƒ½å·²å­˜åœ¨ (è·³é ${skipCount} ç­†)`); if(!confirm(`å³å°‡æ–°å¢ ${inserts.length} å€‹æ™‚æ®µ (å·²è·³é ${skipCount} å€‹é‡è¤‡)ï¼Œç¢ºå®šå—ï¼Ÿ`)) return; const { error } = await myDB.from('schedule_slots').insert(inserts); if (error) alert("âŒ å¤±æ•—ï¼š" + error.message); else { alert("âœ… æˆåŠŸï¼"); fetchAll(); } }
    function toggleAllSlots(checked) { document.querySelectorAll('input[name="batch-times"]').forEach(el => el.checked = checked); }
    function renderCalendar() { const calBody = document.getElementById('calendar-body'); const calTitle = document.getElementById('cal-title'); if(!calBody) return; calBody.innerHTML = ""; calTitle.innerText = `${currentYear} å¹´ ${currentMonth} æœˆ`; const firstDay = new Date(currentYear, currentMonth - 1, 1).getDay(); const daysInMonth = new Date(currentYear, currentMonth, 0).getDate(); for (let i = 0; i < firstDay; i++) calBody.innerHTML += `<div class="cal-cell empty"></div>`; for (let d = 1; d <= daysInMonth; d++) { const dateStr = `${currentYear}-${currentMonth.toString().padStart(2, '0')}-${d.toString().padStart(2, '0')}`; const daySlots = cache.slots.filter(s => s.slot_date === dateStr); const freeCount = daySlots.filter(s => !s.is_booked).length; const bookedCount = daySlots.filter(s => s.is_booked).length; let indicator = ""; if (daySlots.length > 0) { if (freeCount > 0) indicator += `<span class="cal-stat dot-free">ğŸ”µ ${freeCount} ç©º</span>`; if (bookedCount > 0) indicator += `<span class="cal-stat dot-booked">ğŸ”´ ${bookedCount} æ»¿</span>`; } const activeClass = (dateStr === selectedDateStr) ? 'active' : ''; calBody.innerHTML += `<div class="cal-cell ${activeClass}" onclick="selectDate('${dateStr}')"><div class="cal-date">${d}</div>${indicator}</div>`; } }
    function changeMonth(offset) { currentMonth += offset; if (currentMonth > 12) { currentMonth = 1; currentYear++; } else if (currentMonth < 1) { currentMonth = 12; currentYear--; } renderCalendar(); }
    function selectDate(dateStr) { selectedDateStr = dateStr; renderCalendar(); document.getElementById('detail-date-title').innerText = `${dateStr} è©³æƒ…`; const container = document.getElementById('day-detail-container'); const daySlots = cache.slots.filter(s => s.slot_date === dateStr).sort((a,b) => a.slot_time.localeCompare(b.slot_time)); if (daySlots.length === 0) { container.innerHTML = "<p style='color:#999; font-size:13px;'>ç„¡æ’ç¨‹</p>"; return; } container.innerHTML = daySlots.map(s => `<div class="compact-slot ${s.is_booked ? 'booked' : 'free'}">${s.slot_time.slice(0,5)}<span class="compact-del" onclick="event.stopPropagation(); delSlot('${s.id}')">Ã—</span></div>`).join(''); }
    async function delSlot(id) { if(!confirm("åˆªé™¤ï¼Ÿ")) return; const { error } = await myDB.from('schedule_slots').delete().eq('id', id); if(!error) { fetchAll(); } }
    async function sendPayLink(id, p) { if(confirm("å¯„é€?")) { await myDB.from('bookings').update({status:'awaiting_payment', wish_detail: cache.bks.find(x=>x.id===id).wish_detail+' | [ä»˜æ¬¾ç¢¼å·²å‚³]'}).eq('id',id); alert("OK"); closeModal(); fetchAll(); } }
    window.updateS = async function(id, s) { if(confirm("ç¢ºå®š?")) { await myDB.from('bookings').update({status:s}).eq('id',id); closeModal(); fetchAll(); } }
    async function linkUser(uid, bid) { if(confirm("æ­¸æˆ¶?")) { await myDB.from('bookings').update({user_id:uid}).eq('id',bid); fetchAll(); } }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    function switchTab(id) { document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active')); document.getElementById('tab-'+id).classList.add('active'); document.querySelectorAll('.sidebar button').forEach(b=>b.classList.remove('active')); document.getElementById('nav-'+id).classList.add('active'); }
</script>
</body>
</html>
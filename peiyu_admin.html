<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸ¹ç™’ä¸­æ§å®¤ V44 | KBç¾åŒ–ä¿®å¾©ç‰ˆ</title>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quill-image-resize-module@3.0.0/image-resize.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@600;900&display=swap" rel="stylesheet">

    <style>
        /* ================= å…¨åŸŸæ¨£å¼ ================= */
        :root { 
            --forest: #1a2f23; --cream: #fdfaf1; --accent: #c6a87c; 
            --dark: #2c3e50; --danger: #e74c3c; --info: #3498db; 
            --success: #27ae60; --warning: #f39c12; --purple: #9b59b6; 
        }
        * { box-sizing: border-box; }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: #f4f7f6; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* å·¦å´å°èˆªæ¬„ */
        .sidebar { width: 240px; background: var(--forest); height: 100%; color: white; flex-shrink: 0; display: flex; flex-direction: column; overflow-y: auto; }
        .sidebar h2 { text-align: center; color: var(--accent); padding: 25px 0; border-bottom: 1px solid #2a3f33; margin: 0; font-size: 1.2rem; font-family: 'Noto Serif TC', serif; }
        .sidebar button { width: 100%; padding: 18px; background: none; border: none; color: #ccc; text-align: left; cursor: pointer; border-bottom: 1px solid #2a3f33; font-size: 14px; transition: 0.2s; }
        .sidebar button:hover { background: #2a3f33; color: white; }
        .sidebar button.active { background: #2a3f33; color: var(--accent); font-weight: bold; border-left: 5px solid var(--accent); }
        
        /* ä¸»å…§å®¹å€ */
        .main { flex: 1; padding: 30px; overflow-y: auto; background: #f4f7f6; position: relative; }
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* é€šç”¨å…ƒä»¶ */
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; border-top: 4px solid var(--accent); }
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; font-size: 13px; transition:0.2s; display: inline-block; margin-right: 5px; text-decoration: none; white-space:nowrap; }
        .btn:hover { opacity: 0.8; transform: translateY(-1px); }
        .btn-forest { background: var(--forest); color: white; }
        .btn-info { background: var(--info); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-purple { background: var(--purple); color: white; }
        .btn-outline { background: white; border: 1px solid #ccc; color: #666; }
        .btn-sort { background: #7f8c8d; padding: 4px 8px; font-size: 12px; color:white; line-height: 1; }

        /* è¡¨æ ¼å„ªåŒ– */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; table-layout: fixed; }
        th { background: #f8f9fa; color: #666; font-weight: bold; padding: 12px; text-align: left; border-bottom: 2px solid #eee; white-space: nowrap; }
        td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; font-size: 14px; vertical-align: middle; color: #444; word-wrap: break-word; overflow-wrap: break-word; }
        tr:hover { background: #fdfaf1; }

        /* æ¨™ç±¤ */
        .tag { padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight:bold; color: white; display: inline-block; margin-right: 3px; }
        .tag-main { background: #d32f2f; }
        .tag-addon { background: #1976d2; }
        .tag-ota { background: #f39c12; }
        .tag-coupon { background: #e91e63; padding: 4px 8px; font-size: 12px; border-radius: 20px; }
        .tag-paid { background: #d4edda; color: #155724; padding: 3px 6px; border-radius: 4px; font-size:12px; }
        .tag-wait { background: #fff3cd; color: #856404; padding: 3px 6px; border-radius: 4px; font-size:12px; }

        /* è¼¸å…¥æ¡† */
        input, select, textarea { padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%; box-sizing: border-box; font-size: 14px; margin-bottom: 5px; }
        input:disabled { background: #eee; color: #999; cursor: not-allowed; }

        /* è²¡å‹™åˆ†é å°èˆª */
        .finance-nav { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        .finance-nav button { flex: 1; padding: 10px; border: none; background: #eee; cursor: pointer; border-radius: 8px 8px 0 0; font-weight: bold; color: #666; transition: 0.2s; }
        .finance-nav button.active { background: var(--forest); color: white; }

        /* ========== çŸ¥è­˜åº« V15 å¾©åˆ»æ¨£å¼ (é‡é»ä¿®æ”¹å€) ========== */
        .kb-layout { display: grid; grid-template-columns: 280px 1fr; gap: 20px; height: calc(100vh - 100px); }
        
        /* æ·±è‰²å´é‚Šæ¨¹ç‹€ç›®éŒ„ */
        .kb-sidebar { background: #2c3e50; color: #ecf0f1; border-radius: 8px; overflow-y: auto; display: flex; flex-direction: column; }
        .kb-header { padding: 15px; background: #1a252f; border-bottom: 1px solid #34495e; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; }
        .kb-tree-content { padding: 10px; flex: 1; }

        /* æ¨¹ç‹€çµæ§‹ */
        details.big-cat { margin-bottom: 5px; }
        details.big-cat > summary { padding: 10px; cursor: pointer; font-weight: bold; list-style: none; border-radius: 4px; color: #ecf0f1; }
        details.big-cat > summary:hover { background: rgba(255,255,255,0.1); }
        details.mid-cat { margin-left: 12px; border-left: 1px solid #555; }
        details.mid-cat > summary { padding: 8px; cursor: pointer; color: #ccc; font-size: 0.95rem; }
        details.mid-cat > summary:hover { color: #fff; }

        .article-item { padding: 8px 10px 8px 20px; cursor: pointer; color: #bdc3c7; display: block; font-size: 0.95rem; border-radius: 4px; transition: 0.2s; border-bottom: 1px solid #34495e; }
        .article-item:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .article-item.active { color: #fff; background: #c6a87c; font-weight: bold; }
        .article-item.draft { color: #e74c3c; } 
        .article-item.draft::before { content: 'ğŸ”´ '; font-size: 10px; }

        /* ç·¨è¼¯å™¨ */
        #editor-container { height: 500px; display: flex; flex-direction: column; background: white; margin-bottom: 10px; }
        #editor { flex: 1; font-size: 16px; }

        /* ========== åœ–åº« Modal ========== */
        .gallery-box { background: white; width: 90%; height: 90%; border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; }
        .gallery-header { padding: 15px 20px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .gallery-grid { flex: 1; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; padding: 20px; background: #fff; }
        .gallery-item { border: 2px solid #eee; border-radius: 6px; overflow: hidden; cursor: pointer; transition: 0.2s; position: relative; aspect-ratio: 1/1; }
        .gallery-item:hover { border-color: #3498db; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; }
        .gallery-item-name { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.6); color: white; font-size: 11px; padding: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center; }

        /* å…¶ä»– */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; }
        .modal-body { background: white; width: 90%; max-width: 800px; padding: 30px; border-radius: 15px; position: relative; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .close-btn { position: absolute; right: 20px; top: 15px; cursor: pointer; font-size: 24px; color: #999; }
        
        #admin-lock { position: fixed; top:0; left:0; width:100%; height:100vh; background: var(--forest); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
        #admin-lock input { padding: 10px; border-radius: 5px; border: none; width: 200px; margin-bottom: 10px; text-align: center; }

        /* æ’ç¨‹è¡¨æ ¼ */
        .batch-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; }
        .batch-slot { position: relative; }
        .batch-slot input { position: absolute; opacity: 0; cursor: pointer; }
        .batch-slot label { display: block; padding: 8px; background: #fff; border: 1px solid #ccc; border-radius: 5px; text-align: center; font-size: 13px; cursor: pointer; transition: 0.2s; }
        .batch-slot input:checked + label { background: var(--forest); color: white; border-color: var(--forest); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; background: #fff; }
        .cal-cell { border: 1px solid #eee; min-height: 80px; padding: 5px; cursor: pointer; position: relative; background: white; transition: 0.2s; }
        .cal-cell:hover { background: #f9f9f9; border-color: var(--accent); }
        .cal-cell.active { border: 2px solid var(--forest); background: #f0f7ff; }
        .day-detail-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; }
        .compact-slot { padding: 5px; border: 1px solid #ddd; border-radius: 4px; text-align: center; font-size: 12px; background: white; position: relative; }
        .compact-slot.booked { background: #fff5f5; color: #c0392b; border-color: #e74c3c; }
        .compact-slot.free { background: #f0f7ff; color: #2980b9; border-color: #3498db; }
        .compact-del { position: absolute; top:-5px; right:-5px; background:red; color:white; width:15px; height:15px; border-radius:50%; font-size:10px; line-height:15px; cursor:pointer; display:none; }
        .compact-slot:hover .compact-del { display: block; }
        
        /* é ç´„çœ‹æ¿ */
        .u-slot { font-size: 11px; padding: 3px 8px; border-radius: 4px; background: #f0f7ff; border: 1px solid #d6e9f9; color: #2980b9; }
        .u-slot.booked { background: #fff5f5; border-color: #e74c3c; color: #c0392b; text-decoration: line-through; opacity: 0.7; }
        .admin-row { display: flex; gap: 10px; align-items: center; padding: 12px; border-bottom: 1px solid #eee; background: #fff; transition: 0.2s; }
        .admin-row:hover { background: #f0f7ff; }
        .sql-hint-box { background: #fff3cd; border: 1px solid #ffeeba; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 12px; color: #856404; }
        .code-block { background: #eee; padding: 5px; border-radius: 3px; font-family: monospace; display: block; margin-top: 5px; word-break: break-all; border: 1px solid #ccc; cursor: pointer; }
/* ======= ğŸš‘ ç·Šæ€¥ä¿®å¾©è£œä¸ (é‡å°æˆªåœ–å•é¡Œ) ======= */

/* 1. ä¿®å¾©è¡¨æ ¼æ–‡å­—è®Šæˆç›´æ’çš„å•é¡Œ */
table {
    table-layout: auto !important; /* å–æ¶ˆå›ºå®šå¯¬åº¦ï¼Œè®“è¡¨æ ¼è‡ªå‹•æ’é–‹ */
    width: 100%;
}
th, td {
    white-space: nowrap !important; /* å¼·åˆ¶æ–‡å­—ä¸æ›è¡Œ */
    word-break: keep-all !important; /* ç¦æ­¢å–®å­—æ–·è¡Œ */
    padding: 10px 8px !important;    /* å¢åŠ ä¸€é»å‘¼å¸ç©ºé–“ */
    vertical-align: middle;
}
/* è®“è¡¨æ ¼é€™å¼µå¡ç‰‡å¯ä»¥å·¦å³æ»‘å‹•ï¼Œé¿å…æ’çˆ†ç‰ˆé¢ */
.card {
    overflow-x: auto; 
}

/* 2. ä¿®å¾©æ’ç¨‹æ™‚é–“é»åœ¨ä¸€èµ· (13:0013:30...) çš„å•é¡Œ */
.u-slot {
    display: inline-block !important; /* è®“å®ƒè®Šæˆæ–¹å¡Š */
    margin: 3px !important;           /* å¢åŠ é–“è· */
    padding: 4px 8px !important;      /* å…§è· */
    background: #f0f7ff;
    border: 1px solid #d6e9f9;
    border-radius: 4px;
    font-size: 12px;
    color: #2980b9;
}
.u-slot.booked {
    background: #fff5f5;
    border-color: #e74c3c;
    color: #c0392b;
    text-decoration: line-through;
}

/* 3. å¾®èª¿çœ‹æ¿æ¯”ä¾‹ï¼Œè®“å·¦é‚Šå¯¬ä¸€é» */
.dashboard-layout {
    grid-template-columns: 3fr 1fr !important; /* çµ¦å·¦é‚Šè¡¨æ ¼æ›´å¤šç©ºé–“ */
}
    </style>
</head>
<body>

<div id="admin-lock">
    <h2 style="color:var(--accent);">ğŸ”’ åŸ¹ç™’ä¸­æ§å®¤ V44</h2>
    <input type="password" id="admin-pwd" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
    <button class="btn btn-warning" onclick="checkAdmin()">é€²å…¥ç³»çµ±</button>
</div>

<div id="gallery-modal" class="modal" style="z-index: 3000;">
    <div class="gallery-box">
        <div class="gallery-header">
            <div style="display:flex; align-items:center; gap:10px;">
                <h3 style="margin:0;">ğŸ–¼ï¸ å…¨åŸŸåœ–åº«</h3>
                <select id="bucket-select" onchange="switchBucket()" style="padding:5px;">
                    <option value="kb-images">æ–‡ç« é…åœ– (kb-images)</option>
                    <option value="site-assets">ç¶²ç«™ç´ æ (site-assets)</option>
                    <option value="banners">æ©«å¹… (banners)</option>
                </select>
            </div>
            <div style="display:flex; gap:10px;">
                <input type="file" id="upload-input" accept="image/*" style="display:none" onchange="uploadImage()">
                <button class="btn btn-forest" onclick="document.getElementById('upload-input').click()">â¬†ï¸ ä¸Šå‚³</button>
                <button class="btn btn-danger" onclick="document.getElementById('gallery-modal').style.display='none'">é—œé–‰</button>
            </div>
        </div>
        <div id="gallery-content" class="gallery-grid"></div>
    </div>
</div>

<div class="sidebar">
    <h2>åŸ¹ç™’æ§åˆ¶ä¸­å¿ƒ</h2>
    <button onclick="switchTab('bks')" id="nav-bks" class="active">ğŸ“… é ç´„çœ‹æ¿</button>
    <button onclick="switchTab('schedule')" id="nav-schedule">ğŸ•’ æ’ç¨‹ç®¡ç†</button>
    <button onclick="switchTab('pro')" id="nav-pro">ğŸ‘¤ å€‹æ¡ˆ CRM</button>
    <button onclick="switchTab('finance')" id="nav-finance">ğŸ’° è²¡å‹™èˆ‡å„ªæƒ åˆ¸</button>
    <button onclick="switchTab('kb')" id="nav-kb">ğŸ“ çŸ¥è­˜åº« (CMS)</button>
    <button onclick="switchTab('menu')" id="nav-menu">âš™ï¸ æœå‹™é…ç½®</button>
</div>

<div class="main">
    
    <div id="tab-bks" class="tab-content active">
        <div class="dashboard-layout" style="display: grid; grid-template-columns: 2.5fr 1fr; gap: 20px;">
            <div>
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3>ğŸ“‹ è¿‘æœŸé ç´„æ¸…å–®</h3>
                        <button class="btn btn-outline" onclick="fetchAll()">ğŸ”„ åˆ·æ–°</button>
                    </div>
                    <input type="text" id="search-key" placeholder="ğŸ” æœå°‹ å§“å / æ‰‹æ©Ÿ / å–®è™Ÿ / OTA..." style="margin-bottom:15px;" onkeyup="renderUI()">
                    <table>
                        <thead><tr><th width="20%">å–®è™Ÿ/æ—¥æœŸ</th><th width="25%">å€‹æ¡ˆè³‡è¨Š</th><th width="25%">æœå‹™å…§å®¹</th><th width="10%">é‡‘é¡</th><th width="10%">ç‹€æ…‹</th><th width="10%">æ“ä½œ</th></tr></thead>
                        <tbody id="bk-list"></tbody>
                    </table>
                </div>
            </div>
            <div>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <div class="card" style="flex:1; padding:15px; border-top-color:var(--success);">
                        <small>ğŸ’° æœ¬æœˆå¯¦æ”¶</small><h2 id="inc-val" style="margin:5px 0; color:var(--success);">$0</h2>
                    </div>
                    <div class="card" style="flex:1; padding:15px; border-top-color:var(--info);">
                        <small>ğŸ‘¤ ç´¯ç©å€‹æ¡ˆ</small><h2 id="total-val" style="margin:5px 0;">0</h2>
                    </div>
                </div>
                <div class="card" style="border-top-color: var(--purple);">
                    <h3 style="margin-top:0;">ğŸ“… 7æ—¥æ’ç¨‹æ¦‚è¦½</h3>
                    <div id="dashboard-7day-schedule" style="font-size:13px; line-height:1.8;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-schedule" class="tab-content">
        <div style="display: flex; gap: 20px; height: 85vh;">
            <div class="card" style="width:280px; flex-shrink:0; overflow-y:auto;">
                <h4 style="color:var(--forest); margin-top:0;">âš¡ å¿«é€Ÿæ’ç­</h4>
                <label>æ—¥æœŸå€é–“</label>
                <div style="display:flex; gap:2px; margin-bottom:10px;">
                    <input type="date" id="batch-start"><span style="padding-top:5px;">~</span><input type="date" id="batch-end">
                </div>
                <label>å‹¾é¸æ™‚æ®µ (æ¯30åˆ†)</label>
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <button class="btn btn-outline" style="font-size:10px; flex:1;" onclick="toggleAllSlots(true)">å…¨é¸</button>
                    <button class="btn btn-outline" style="font-size:10px; flex:1;" onclick="toggleAllSlots(false)">æ¸…ç©º</button>
                </div>
                <div id="time-grid" class="batch-grid"></div>
                <button class="btn btn-forest" style="width:100%; margin-top:15px;" onclick="batchAddSchedule()">ğŸš€ ç”Ÿæˆæ’ç¨‹</button>
            </div>
            <div class="card" style="flex:1; display:flex; flex-direction:column;">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <button class="btn btn-outline" onclick="changeMonth(-1)">â—€</button>
                    <h3 id="cal-title" style="margin:0;">Loading...</h3>
                    <button class="btn btn-outline" onclick="changeMonth(1)">â–¶</button>
                </div>
                <div id="calendar-body" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; flex:1;"></div>
            </div>
            <div class="card" style="width:250px; flex-shrink:0; background:#fdfdfd;">
                <h4 id="detail-date-title" style="margin-top:0; color:var(--dark); border-bottom:2px solid var(--accent); padding-bottom:10px;">è«‹é¸æ“‡æ—¥æœŸ</h4>
                <div id="day-detail-container" class="day-detail-list"></div>
            </div>
        </div>
    </div>

    <div id="tab-pro" class="tab-content">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>ğŸ‘¤ æœƒå“¡ç®¡ç†ç³»çµ± (CRM)</h3>
                <button class="btn btn-outline" onclick="fetchAll()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
            </div>
            <input type="text" id="search-member" placeholder="ğŸ” æœå°‹å§“åæˆ–æ‰‹æ©Ÿ..." onkeyup="renderPro()" style="margin-bottom:15px;">
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th width="15%">å§“å</th><th width="15%">æ‰‹æ©Ÿ</th><th width="20%">Email</th>
                            <th width="15%">ç´¯ç©æ¶ˆè²»</th><th width="15%">æœ€è¿‘é ç´„</th><th width="20%">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="pro-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-finance" class="tab-content">
        <div class="card">
            <div class="finance-nav">
                <button onclick="switchFinanceSub('ota')" id="btn-sub-ota" class="active">ğŸ’° OTA å¹³å°è¨­å®š</button>
                <button onclick="switchFinanceSub('coupon')" id="btn-sub-coupon">ğŸ« å„ªæƒ åˆ¸ç®¡ç†</button>
            </div>

            <div id="sub-ota">
                <div style="background:#f9f9f9; padding:20px; border-radius:8px; margin-bottom:20px;">
                    <h4 style="margin-top:0; color:#555;">â• æ–°å¢ / ä¿®æ”¹å¹³å°</h4>
                    <input type="hidden" id="ota-id">
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <div style="flex:1"><label>å¹³å°åç¨±</label><input type="text" id="ota-name" placeholder="ä¾‹: è¦çš®è³¼ç‰©"></div>
                        <div style="flex:1"><label>è‹±æ–‡ä»£è™Ÿ</label><input type="text" id="ota-code" placeholder="ä¾‹: shopee"></div>
                        <div style="width:100px;"><label>ä½£é‡‘ %</label><input type="number" id="ota-rate" placeholder="5.5"></div>
                    </div>
                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <div style="flex:1"><label>å‰å°ç¶²å€</label><input type="text" id="ota-front" placeholder="https://..."></div>
                        <div style="flex:1"><label>å¾Œå°ç¶²å€</label><input type="text" id="ota-admin" placeholder="https://..."></div>
                    </div>
                    <div style="text-align:right;">
                        <button class="btn btn-outline" id="btn-ota-cancel" onclick="cancelOTA()" style="display:none; margin-right:5px;">å–æ¶ˆ</button>
                        <button class="btn btn-warning" id="btn-ota-save" onclick="saveOTA()" style="width:150px;">ğŸ’¾ å„²å­˜è¨­å®š</button>
                    </div>
                </div>
                <table><thead><tr><th width="15%">å¹³å°åç¨±</th><th width="10%">ä»£è™Ÿ</th><th width="10%">ä½£é‡‘</th><th width="45%">ç¶²å€é€£çµ</th><th width="20%">æ“ä½œ</th></tr></thead><tbody id="ota-list"></tbody></table>
            </div>

            <div id="sub-coupon" style="display:none;">
                <input type="hidden" id="cp-edit-id">
                <div style="background:#fffcf5; padding:20px; border:1px solid #fae1c3; border-radius:10px; margin-bottom:20px; box-shadow: 0 2px 5px rgba(0,0,0,0.02);">
                    <h4 style="margin-top:0; color:#e65100;">ğŸ« å„ªæƒ åˆ¸ç·¨è¼¯å™¨</h4>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                        <div><label>å„ªæƒ åˆ¸åç¨±</label><input type="text" id="cp-name" placeholder="ä¾‹å¦‚ï¼šæ–°æ˜¥èª¿é » 9 æŠ˜"></div>
                        <div><label>å„ªæƒ ä»£ç¢¼ (Code)</label><input type="text" id="cp-code" placeholder="ä¾‹å¦‚ï¼š2026NEW" style="text-transform:uppercase;"></div>
                        <div><label>æŠ˜æ‰£é¡å‹</label><select id="cp-type" onchange="updateCpHint()"><option value="percentage">æ‰“æŠ˜ (Percentage)</option><option value="fixed">æŠ˜æŠµé‡‘é¡ (Fixed Amount)</option></select></div>
                        <div><label id="cp-val-hint">æŠ˜æ‰£æ•¸å€¼ (90 = 9æŠ˜)</label><input type="number" id="cp-val" placeholder="è¼¸å…¥æ•¸å€¼"></div>
                        <div>
                            <label>ä½¿ç”¨æœŸé™</label>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <input type="date" id="cp-exp">
                                <label style="white-space:nowrap; font-size:14px; display:flex; align-items:center; cursor:pointer;"><input type="checkbox" id="cp-no-limit" onchange="toggleCpExp()" style="width:18px; height:18px; margin-right:5px;"> ç„¡æœŸé™</label>
                            </div>
                        </div>
                        <div>
                            <label>é©ç”¨å°è±¡</label>
                            <div style="margin-top:10px; display:flex; gap:20px;">
                                <label style="display:flex; align-items:center;"><input type="checkbox" id="cp-mem" checked style="width:auto; margin-right:5px;"> éœ€æœƒå“¡</label>
                                <label style="display:flex; align-items:center;"><input type="checkbox" id="cp-guest" style="width:auto; margin-right:5px;"> è¨ªå®¢å¯ç”¨</label>
                            </div>
                        </div>
                    </div>
                    <div style="text-align:right; margin-top:20px;">
                        <button class="btn btn-outline" id="btn-cp-cancel" onclick="resetCouponForm()" style="display:none;">å–æ¶ˆ</button>
                        <button class="btn btn-forest" id="btn-cp-save" onclick="saveCoupon()" style="padding:10px 30px;">å»ºç«‹å„ªæƒ åˆ¸</button>
                    </div>
                </div>
                <table><thead><tr><th>åç¨±</th><th>ä»£ç¢¼</th><th>å…§å®¹</th><th>æœŸé™</th><th>å°è±¡</th><th>æ¬¡æ•¸</th><th>æ“ä½œ</th></tr></thead><tbody id="cp-list"></tbody></table>
                <div style="margin-top:30px; background:#f9f9f9; padding:15px; border-radius:8px;">
                    <h4 style="margin-top:0;">ğŸ§ª å„ªæƒ åˆ¸è©¦ç®—</h4>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="test-cp-code" placeholder="è¼¸å…¥ä»£ç¢¼" style="flex:1;">
                        <input type="number" id="test-cp-price" placeholder="è¨‚å–®åŸåƒ¹" style="flex:1;">
                        <button class="btn btn-info" onclick="testCoupon()">è©¦ç®—</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-kb" class="tab-content">
        <div class="kb-layout">
            <div class="kb-sidebar">
                <div class="kb-header">
                    <span style="font-weight:bold;">çŸ¥è­˜åº«åˆ—è¡¨</span>
                    <button class="btn btn-success" style="padding:4px 8px; font-size:12px;" onclick="resetKbForm()">ï¼‹ æ–°å¢</button>
                </div>
                <div id="kb-tree" class="kb-tree-content"></div>
            </div>

            <div class="card" style="display:flex; flex-direction:column; overflow-y:auto; height:100%;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h2 id="mode-title" style="margin:0; color:var(--dark);">æ–°å¢æ–‡ç« </h2>
                    <button class="btn btn-purple" onclick="openGallery()">ğŸ–¼ï¸ é–‹å•Ÿåœ–åº«</button>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr 2fr; gap:15px; margin-bottom:15px;">
                    <div>
                        <label style="font-weight:bold;">å¤§åˆ†é¡</label>
                        <input list="kb-big-list" id="kb-big" placeholder="ä¾‹: äººé¡åœ–">
                        <datalist id="kb-big-list"></datalist>
                    </div>
                    <div>
                        <label style="font-weight:bold;">ä¸­åˆ†é¡</label>
                        <input list="kb-mid-list" id="kb-mid" placeholder="ä¾‹: é€šé“">
                        <datalist id="kb-mid-list"></datalist>
                    </div>
                    <div>
                        <label style="font-weight:bold;">æ–‡ç« æ¨™é¡Œ</label>
                        <input type="text" id="kb-title" placeholder="è¼¸å…¥æ¨™é¡Œ...">
                    </div>
                </div>

                <div id="editor-container"><div id="editor"></div></div>

                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:15px;">
                    <div>
                        <label style="display:flex; align-items:center; gap:5px; font-weight:bold;">
                            <input type="checkbox" id="kb-pub" checked style="width:auto;"> å‰å°é¡¯ç¤º
                        </label>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <input type="hidden" id="kb-id">
                        <button class="btn btn-danger" onclick="delArticle()" style="display:none;" id="btn-kb-del">åˆªé™¤æ–‡ç« </button>
                        <button class="btn btn-info" onclick="previewArticle()">ğŸ‘ï¸ é è¦½</button>
                        <button class="btn btn-forest" onclick="saveArticle()">ğŸ’¾ å„²å­˜è®Šæ›´</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-menu" class="tab-content">
        <div style="display:grid; grid-template-columns: 1fr 1.5fr; gap:20px;">
            <div class="card" id="card-cat">
                <h3>ğŸ“‚ å¤§é¡ç®¡ç†</h3>
                <input type="hidden" id="cat-id-edit">
                <input type="text" id="cat-name" placeholder="å¤§é¡åç¨±" style="width:100%; margin-bottom:10px; padding:8px;">
                <select id="cat-type" style="width:100%; margin-bottom:10px; padding:8px;"><option value="sleep">è©¢å•ç¡çœ  (èª¿é »é¡)</option><option value="consult">è©¢å•æ—¥æœŸ (è«®è©¢é¡)</option></select>
                <textarea id="cat-terms" placeholder="æœå‹™è¦ç¯„æ¢æ¬¾" style="width:100%; height:80px; margin-bottom:10px; padding:8px;"></textarea>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-forest" id="btn-cat-save" onclick="saveCategory()">ï¼‹ æ–°å¢</button>
                    <button class="btn btn-outline" id="btn-cat-cancel" onclick="cancelEdit('cat')" style="display:none;">å–æ¶ˆ</button>
                </div>
                <table id="cat-list" style="margin-top:15px;"></table>
            </div>
            
            <div class="card" id="card-svc">
                <h3>âš™ï¸ ç´°é …ç®¡ç†</h3>
                <div class="sql-hint-box">
                    <strong>ğŸ’¡ ç³»çµ±æç¤ºï¼š</strong> è‹¥å­˜æª”å¤±æ•—ï¼Œè«‹ç¢ºèªè³‡æ–™åº«æœ‰ <code>report_template</code> æ¬„ä½ã€‚
                </div>

                <input type="hidden" id="svc-id-edit">
                
                <select id="svc-cat-filter" style="width:100%; margin-bottom:10px; padding:8px; border:2px solid var(--info); background:#f0f8ff;" onchange="filterServiceList()">
                    <option value="">è¼‰å…¥ä¸­...</option>
                </select>

                <div style="display:flex; gap:10px;">
                    <input type="text" id="i-name" placeholder="é …ç›®å" style="flex:2;">
                    <input type="number" id="i-price" placeholder="åƒ¹æ ¼" style="flex:1;">
                </div>
                
                <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin:10px 0;">
                    <label style="display:flex; align-items:center; gap:5px; margin-bottom:10px; color:var(--danger); font-weight:bold; cursor:pointer;">
                        <input type="checkbox" id="i-is-main" style="width:18px; height:18px;" onchange="toggleSubOptionInput()">Â 
                        è¨­ç‚ºä¸»é …ç›® (å–®é¸äº’æ–¥ï¼Œç„¡å­é¸é …)
                    </label>

                    <div id="main-opt-wrapper" style="display:none;">
                        <input type="text" id="i-report-tpl" placeholder="å°æ‡‰å ±å‘Šæª”æ¡ˆ (ä¾‹: srt_report.html)">
                        <small style="color:var(--purple);">ğŸ’¡ è‹¥ç‚ºä¸»é …ç›®ï¼Œè«‹å¡«å¯«æ­¤æ¬„ä»¥é€£çµå ±è¡¨ã€‚</small>
                    </div>

                    <div id="sub-opt-wrapper">
                        <input type="text" id="i-sub-opts" placeholder="å­é¸é … (é€—è™Ÿéš”é–‹)">
                        <small style="color:#666;">ğŸ’¡ åŠ è³¼é …ç›®æ‰éœ€è¦</small>
                    </div>
                </div>

                <div style="display:flex; gap:10px; justify-content: flex-end;">
                    <button class="btn btn-outline" id="btn-svc-cancel" onclick="cancelEdit('svc')" style="display:none;">å–æ¶ˆ</button>
                    <button class="btn btn-forest" id="btn-svc-save" onclick="saveItem()">ï¼‹ æ–°å¢é …ç›®</button>
                </div>
                
                <div style="max-height:400px; overflow-y:auto; margin-top:15px; border-top:1px solid #eee;" id="svc-list-container">
                    <p style="padding:10px; color:#999;">è«‹å…ˆé¸æ“‡ä¸Šæ–¹çš„å¤§é¡...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modal" class="modal">
    <div class="modal-body">
        <span onclick="closeModal()" class="close-btn">Ã—</span>
        <h2 id="m-title" style="border-bottom:1px solid #eee; padding-bottom:10px; color:var(--forest);">è©³æƒ…</h2>
        <div id="m-content"></div>
    </div>
</div>

<script>
    // ğŸŒŸ å…¨åŸŸå·¥å…·
    const SB_URL = "https://geyrpowhaqfhnxghpokr.supabase.co";
    const SB_KEY = "sb_publishable_aXucdq8UtvMbCKbriqpJCw_gtpYBw-r"; 
    const myDB = supabase.createClient(SB_URL, SB_KEY);
    const cleanPhone = (p) => p ? p.replace(/\D/g, '') : '';
    const STATUS_MAP = {
        'paid': '<span class="tag tag-paid">å·²ä»˜æ¬¾</span>',
        'pending': '<span class="tag tag-wait">æœªä»˜æ¬¾</span>',
        'awaiting_payment': '<span class="tag tag-wait">å¾…ç¢ºèª</span>',
        'awaiting_service': '<span class="tag tag-ota">æœå‹™ä¸­</span>',
        'completed': '<span class="tag" style="background:#333">å·²çµæ¡ˆ</span>'
    };

    // Quill Image Blot
    const BaseImage = Quill.import('formats/image');
    const ATTRIBUTES = ['alt', 'height', 'width', 'style', 'class'];
    class CustomImage extends BaseImage {
        static formats(domNode) { return ATTRIBUTES.reduce((f, a) => { if (domNode.hasAttribute(a)) f[a] = domNode.getAttribute(a); return f; }, {}); }
        format(name, value) { if (ATTRIBUTES.indexOf(name) > -1) { if (value) this.domNode.setAttribute(name, value); else this.domNode.removeAttribute(name); } else super.format(name, value); }
    }
    Quill.register({ 'formats/image': CustomImage }, true);
    var quill = new Quill('#editor', {
        theme: 'snow',
        modules: { imageResize: { displaySize: true }, toolbar: [['bold', 'italic', 'underline', 'strike'], [{'header': [1, 2, 3, false]}], [{'color': []}, {'background': []}], ['link', 'image'], [{'list': 'ordered'}, {'list': 'bullet'}], ['clean']] }
    });

    let cache = { bks:[], pros:[], cats:[], svcs:[], slots:[], otas:[], coupons:[], articles:[] };
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth() + 1;
    let selectedDateStr = "";
    let currentBucket = 'kb-images';

    function checkAdmin() {
        if(document.getElementById('admin-pwd').value === "admin888") { 
            document.getElementById('admin-lock').style.display = 'none';
            document.querySelector('.main').style.display = 'block';
            fetchAll(); renderTimeGrid();
        } else { alert("å¯†ç¢¼éŒ¯èª¤"); }
    }

    async function fetchAll() {
        try {
            const [b, p, c, s, sl, o, cp, ar] = await Promise.all([
                myDB.from('bookings').select('*').order('created_at', {ascending:false}).limit(100),
                myDB.from('profiles').select('*').order('created_at', {ascending:false}),
                myDB.from('service_categories').select('*').order('created_at'),
                myDB.from('services').select('*').order('sort_order'),
                myDB.from('schedule_slots').select('*').order('slot_date').order('slot_time'),
                myDB.from('ota_settings').select('*'),
                myDB.from('coupons').select('*').order('created_at', {ascending:false}),
                myDB.from('kb_articles').select('id, title, big_category, mid_category, is_published')
            ]);

            const bookingsWithProfile = (b.data || []).map(bk => {
                const profile = (p.data || []).find(pr => pr.id === bk.user_id);
                return { ...bk, profiles: profile || null };
            });

            cache = { 
                bks: bookingsWithProfile, pros: p.data||[], cats: c.data||[], 
                svcs: s.data||[], slots: sl.data||[], otas: o.data||[], 
                coupons: cp.data||[], articles: ar.data||[] 
            };
            
            renderBks(); renderPro(); renderConfigTables(); renderCalendar(); renderFinance(); renderKbTree(); render7DaySchedule();
            
        } catch (e) { console.error(e); alert("è¼‰å…¥å¤±æ•—: " + e.message); }
    }

    // --- 1. é ç´„çœ‹æ¿ ---
    function renderBks() {
        const search = document.getElementById('search-key').value.trim().toUpperCase();
        document.getElementById('bk-list').innerHTML = cache.bks.filter(x => 
            !search || JSON.stringify(x).toUpperCase().includes(search)
        ).map(x => {
            const hasPro = !!x.profiles;
            
            let otaTag = '';
            if (x.ota_order_id) {
                const otaName = cache.otas.find(o => o.code === x.ota_source)?.name || 'OTA';
                otaTag = `<br><span class="tag tag-ota">${otaName} #${x.ota_order_id.slice(-5)}</span>`;
            } else if (x.payment_method === 'shopee') otaTag = `<br><span class="tag tag-ota">è¦çš®(èˆŠ)</span>`;

            let userHtml = hasPro ? `<b>${x.profiles.full_name}</b><br><small>${x.profiles.phone}</small>` :
                           `<b>${x.temp_phone}</b><br><button class="btn btn-info" style="font-size:10px;padding:2px;" onclick="openCreateMemberModal('${x.temp_phone}', '${x.id}')">ï¼‹å»ºç«‹</button>`;

            return `<tr>
                <td><small>${x.created_at.slice(0,10)}</small><br><small>${x.booking_id.slice(-6)}</small>${otaTag}</td>
                <td>${userHtml}</td>
                <td><small>${x.service_item}</small></td>
                <td>$${x.price}</td>
                <td>${STATUS_MAP[x.status] || x.status}</td>
                <td><button class="btn btn-forest" onclick="openBooking('${x.id}')">è©³æƒ…</button><button class="btn btn-danger" onclick="deleteBooking('${x.id}')" style="padding:2px 8px;">åˆª</button></td>
            </tr>`;
        }).join('');

        const m = new Date().toISOString().slice(0, 7);
        const inc = cache.bks.filter(x => x.status === 'paid' && x.created_at.startsWith(m)).reduce((s, x) => s + (x.price || 0), 0);
        if(document.getElementById('inc-val')) document.getElementById('inc-val').innerText = "$" + inc.toLocaleString();
        if(document.getElementById('total-val')) document.getElementById('total-val').innerText = cache.pros.length;
    }

    function openBooking(id) {
        const b = cache.bks.find(x => x.id === id);
        if(!b) { alert("æ‰¾ä¸åˆ°è¨‚å–®"); return; }
        
        const cleanDetail = (b.wish_detail||'').replace(/\| \[ä»˜æ¬¾ç¢¼.*?\]/g, '');
        let extractName="æœªçŸ¥", extractEmail="æœªçŸ¥", extractData=cleanDetail;
        const nm=cleanDetail.match(/å§“å:(.*?) \|/), em=cleanDetail.match(/Email:(.*?) \|/), dt=cleanDetail.match(/æ•¸æ“š:(.*)/);
        if(nm) extractName=nm[1]; if(em) extractEmail=em[1]; if(dt) extractData=dt[1];

        const mainService = (cache.svcs || []).find(s => s.is_main && (b.service_detail||'').includes(s.title));
        let reportTemplate = "srt_report.html", btnLabel = "ğŸ“„ ç”Ÿæˆæœå‹™å ±å‘Š", btnClass = "btn-forest";
        if (mainService && mainService.report_template) {
            reportTemplate = mainService.report_template;
            btnLabel = `ğŸ“„ ç”Ÿæˆ ${mainService.title} å ±å‘Š`;
        }

        const reportMatch = (b.wish_detail||'').match(/\[å ±å‘Šå·²ç”Ÿæˆ ID:(.*?)\]/);
        const existingReportId = reportMatch ? reportMatch[1] : null;
        let reportUrl = existingReportId ? `${reportTemplate}?id=${existingReportId}` : `${reportTemplate}?bid=${b.id}&name=${encodeURIComponent(extractName)}&phone=${b.temp_phone}`;
        if(existingReportId) { btnLabel = "ğŸ“„ æŸ¥çœ‹/ä¿®æ”¹å ±å‘Š"; btnClass = "btn-purple"; }

        let couponHtml = b.coupon_info ? `<div style="background:#fce4ec; color:#c2185b; padding:10px; border-radius:5px; margin-top:10px;">ğŸŸï¸ <b>ä½¿ç”¨å„ªæƒ åˆ¸ï¼š</b> ${b.coupon_info}</div>` : '';

        let scheduleBox = '';
        if(b.scheduled_at) {
            scheduleBox = `<div style="color:var(--purple); font-weight:bold; margin-top:10px; font-size:1.1rem;">ğŸ“… å·²æ’ç¨‹ï¼š${new Date(b.scheduled_at).toLocaleString()}</div>`;
        } else if(b.status === 'paid' || b.status === 'awaiting_service') {
            scheduleBox = `<div style="background:#e3f2fd; padding:10px; border-radius:5px; margin-top:10px;">
                <label>1. å…ˆé¸æ—¥æœŸ</label><input type="date" id="book-date" onchange="loadSlotsForBooking(this.value)">
                <label style="margin-top:5px;">2. å†é¸æ™‚é–“</label><select id="book-slot"><option>è«‹å…ˆé¸æ—¥æœŸ</option></select>
                <button class="btn btn-purple" style="width:100%; margin-top:10px;" onclick="confirmSchedule('${b.id}')">ç¢ºèªæ’ç¨‹</button></div>`;
        } else {
            scheduleBox = `<div style="color:#999; margin-top:10px;">(ä»˜æ¬¾å¾Œå¯æ’ç¨‹)</div>`;
        }

        document.getElementById('m-title').innerText = "é ç´„è©³æƒ…";
        document.getElementById('m-content').innerHTML = `
            <div class="id-card"><b>${extractName}</b> <small>(${!!b.profiles?'æœƒå“¡':'è¨ªå®¢'})</small><br><small>${b.temp_phone} | ${extractEmail}</small></div>
            <div style="margin-top:15px; background:#fafafa; padding:10px; border-radius:8px;"><b>${b.service_item}</b><br><small>${b.service_detail}</small></div>
            ${couponHtml}
            <div style="margin-top:15px; background:#fffdf0; padding:10px; border:1px solid #eee; border-radius:8px;">${extractData}<br><span style="color:#d35400;">ğŸ’¡ è¨±é¡˜ï¼š${b.sleep_time || 'ç„¡'}</span></div>
            <div style="margin-top:15px; padding:15px; background:#f3e5f5; border-radius:8px;">${scheduleBox}</div>
            ${b.status === 'awaiting_service' || b.status === 'completed' ? `<div style="margin-top:15px; padding:15px; background:#e8f5e9; border-radius:8px; text-align:center;"><a href="${reportUrl}" target="_blank" class="btn ${btnClass}" style="display:block; width:100%; text-align:center;">${btnLabel}</a></div>` : ''}
            <div style="margin-top:20px; text-align:right;">${renderActionButtons(b)}</div>
        `;
        document.getElementById('modal').style.display = 'flex';
    }

    function loadSlotsForBooking(date) {
        const slots = cache.slots.filter(s => s.slot_date === date && !s.is_booked);
        const sel = document.getElementById('book-slot');
        sel.innerHTML = slots.length ? slots.map(s => `<option value="${s.id}" data-t="${s.slot_date} ${s.slot_time}">${s.slot_time.slice(0,5)}</option>`).join('') : '<option>ç„¡ç©ºæª”</option>';
    }
    async function confirmSchedule(bid) {
        const sel = document.getElementById('book-slot');
        if(!sel.value || sel.value.includes("è«‹å…ˆé¸")) return alert("è«‹é¸æ“‡æ™‚æ®µ");
        const t = sel.options[sel.selectedIndex].dataset.t;
        await myDB.from('bookings').update({scheduled_at: t, status: 'awaiting_service'}).eq('id', bid);
        await myDB.from('schedule_slots').update({is_booked: true}).eq('id', sel.value);
        alert("âœ… æ’ç¨‹æˆåŠŸ"); closeModal(); fetchAll();
    }
    async function deleteBooking(id) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { await myDB.from('bookings').delete().eq('id',id); fetchAll(); } }
    async function sendPayLink(id) { if(confirm("ç¢ºå®šç™¼é€ï¼Ÿ")) { const t = new Date().toLocaleString(); await myDB.from('bookings').update({ status: 'awaiting_payment', wish_detail: `${cache.bks.find(x=>x.id===id).wish_detail} | [QRå·²å‚³: ${t}]` }).eq('id', id); alert("OK"); closeModal(); fetchAll(); } }
    function renderActionButtons(b) {
        if (b.status === 'paid') return `<button class="btn" style="background:#ccc;">å¾…æ’ç¨‹</button>`;
        if (b.status === 'awaiting_service') return `<button class="btn btn-forest" onclick="updateS('${b.id}','completed')">âœ… çµæ¡ˆ</button>`;
        if (b.status === 'completed') return `<button class="btn" style="background:#ccc;">å·²çµæ¡ˆ</button>`;
        if (b.status === 'pending') return `<button class="btn btn-info" onclick="sendPayLink('${b.id}')">ğŸ“§ å‚³ä»˜æ¬¾ç¢¼</button>`;
        if (b.status === 'awaiting_payment' || b.payment_method === 'shopee' || b.ota_order_id) return `<button class="btn btn-success" onclick="updateS('${b.id}','paid')">ğŸ’° ç¢ºèªå…¥å¸³</button>`;
        return "";
    }

    // --- 2. æœƒå“¡ CRM ---
    function renderPro() {
        const key = document.getElementById('search-member').value.toLowerCase();
        const list = cache.pros.filter(p => !key || (p.full_name && p.full_name.includes(key)) || p.phone.includes(key));
        
        document.getElementById('pro-list').innerHTML = list.map(p => {
            const userBks = cache.bks.filter(b => b.user_id === p.id || cleanPhone(b.temp_phone) === cleanPhone(p.phone));
            const total = userBks.filter(b => b.status === 'paid' || b.status === 'completed').reduce((sum, b) => sum + (b.price || 0), 0);
            const last = userBks.length > 0 ? userBks[0].created_at.slice(0, 10) : '<span style="color:#ccc">ç„¡</span>';

            return `<tr>
                <td><b>${p.full_name || 'æœªå‘½å'}</b></td>
                <td>${p.phone}</td>
                <td><small>${p.email || '-'}</small></td>
                <td style="color:#d35400; font-weight:bold;">$${total.toLocaleString()}</td>
                <td>${last}</td>
                <td><button class="btn btn-forest" onclick="showHistory('${p.id}', '${p.full_name}')">ğŸ“œ æ­·å²</button><button class="btn btn-warning" onclick="editProfile('${p.id}')">âœï¸</button><button class="btn btn-danger" onclick="deleteMember('${p.id}', '${p.full_name}')">ğŸ—‘ï¸</button></td>
            </tr>`;
        }).join('');
    }

    function showHistory(uid, name) {
        const p = cache.pros.find(x => x.id === uid);
        const userBks = cache.bks.filter(b => b.user_id === uid || cleanPhone(b.temp_phone) === cleanPhone(p.phone));
        let html = userBks.length === 0 ? "<p style='color:#999; text-align:center;'>ç„¡è¨‚å–®ç´€éŒ„</p>" : userBks.map(b => `
            <div onclick="openBooking('${b.id}')" class="history-card">
                <div style="display:flex; justify-content:space-between;">
                    <b style="color:var(--forest);">${b.service_item}</b>
                    ${STATUS_MAP[b.status] || b.status}
                </div>
                <div style="font-size:12px; color:#666; margin-top:5px;">${b.created_at.slice(0,10)} | $${b.price}</div>
            </div>
        `).join('');
        document.getElementById('m-title').innerText = `${name} çš„æ­·å²è¨‚å–®`;
        document.getElementById('m-content').innerHTML = `<div style="max-height:400px; overflow-y:auto;">${html}</div>`;
        document.getElementById('modal').style.display = 'flex';
    }

    function editProfile(uid) {
        const p = cache.pros.find(x => x.id === uid);
        document.getElementById('m-title').innerText = "ç·¨è¼¯æœƒå“¡";
        document.getElementById('m-content').innerHTML = `
            <label>å§“å</label><input id="ep-n" value="${p.full_name}" style="margin-bottom:10px;">
            <label>æ‰‹æ©Ÿ</label><input id="ep-p" value="${p.phone}" style="margin-bottom:10px;">
            <label>Email</label><input id="ep-e" value="${p.email||''}" style="margin-bottom:15px;">
            <div style="display:flex; gap:10px;">
                <button class="btn btn-success" style="flex:1;" onclick="updPro('${p.id}')">ğŸ’¾ å„²å­˜è®Šæ›´</button>
                <button class="btn btn-danger" style="flex:1;" onclick="resetMemberPassword('${p.id}', '${p.phone}')">ğŸ”‘ é‡ç½®å¯†ç¢¼ (Guest+æœ«4ç¢¼)</button>
            </div>
        `;
        document.getElementById('modal').style.display = 'flex';
    }

    async function updPro(id) {
        await myDB.from('profiles').update({ full_name: document.getElementById('ep-n').value, phone: document.getElementById('ep-p').value, email: document.getElementById('ep-e').value }).eq('id', id);
        closeModal(); fetchAll(); alert("âœ… æ›´æ–°æˆåŠŸ");
    }

    async function resetMemberPassword(uid, phone) {
        if(!confirm(`ç¢ºå®šè¦é‡ç½®å¯†ç¢¼å—ï¼Ÿ\né è¨­å¯†ç¢¼å°‡è®Šç‚ºï¼šguest${phone.slice(-4)}`)) return;
        const newPw = 'guest' + phone.slice(-4);
        const { error } = await myDB.from('profiles').update({ password: newPw }).eq('id', uid);
        if(error) alert("å¤±æ•—: " + error.message); else alert("âœ… å¯†ç¢¼å·²é‡ç½®ç‚º: " + newPw);
    }

    async function deleteMember(uid, name) {
        if(confirm(`âš ï¸ ç¢ºå®šåˆªé™¤æœƒå“¡ ${name}ï¼Ÿ\n(æ­·å²è¨‚å–®å°‡ä¿ç•™)`)) { await myDB.from('profiles').delete().eq('id', uid); fetchAll(); }
    }

    // --- 3. è²¡å‹™å°ˆå€ ---
    function switchFinanceSub(tab) {
        document.getElementById('sub-ota').style.display = tab==='ota' ? 'block' : 'none';
        document.getElementById('sub-coupon').style.display = tab==='coupon' ? 'block' : 'none';
        document.getElementById('btn-sub-ota').className = tab==='ota' ? 'active' : '';
        document.getElementById('btn-sub-coupon').className = tab==='coupon' ? 'active' : '';
    }

    function renderFinance() {
        document.getElementById('ota-list').innerHTML = cache.otas.map(o => `<tr><td>${o.name}</td><td>${o.code}</td><td>${o.commission_rate}%</td><td>${o.front_url?`<a href="${o.front_url}" target="_blank" class="btn btn-outline" style="font-size:10px;">å‰</a>`:''}${o.admin_url?`<a href="${o.admin_url}" target="_blank" class="btn btn-outline" style="font-size:10px;">å¾Œ</a>`:''}</td><td><button class="btn btn-info" onclick="editOTA('${o.id}')" style="padding:2px 6px;">ä¿®</button><button class="btn btn-danger" onclick="delData('ota_settings', '${o.id}')" style="padding:2px 6px;">åˆª</button></td></tr>`).join('');
        document.getElementById('cp-list').innerHTML = cache.coupons.map(c => `<tr><td>${c.name}</td><td>${c.code}</td><td>${c.discount_type==='percentage'?(c.discount_value%10===0?c.discount_value/10:c.discount_value)+'æŠ˜':'-$'+c.discount_value}</td><td>${c.expires_at?c.expires_at.slice(0,10):'ç„¡'}</td><td>${c.allow_member?'æœƒ':''}${c.allow_guest?'è¨ª':''}</td><td>${c.usage_count}</td><td><button class="btn btn-info" onclick="editCoupon('${c.id}')" style="padding:2px 6px;">ä¿®</button><button class="btn btn-danger" onclick="delData('coupons','${c.id}')" style="padding:2px 6px;">åˆª</button></td></tr>`).join('');
    }

    // OTA ä¿®æ”¹åŠŸèƒ½
    function editOTA(id) {
        const o = cache.otas.find(x => x.id === id);
        document.getElementById('ota-id').value = o.id;
        document.getElementById('ota-name').value = o.name;
        document.getElementById('ota-code').value = o.code;
        document.getElementById('ota-rate').value = o.commission_rate;
        document.getElementById('ota-front').value = o.front_url || '';
        document.getElementById('ota-admin').value = o.admin_url || '';
        document.getElementById('btn-ota-save').innerText = "æ›´æ–°å¹³å°";
        document.getElementById('btn-ota-cancel').style.display = 'inline-block';
    }
    function cancelOTA() {
        document.getElementById('ota-id').value = ''; document.getElementById('ota-name').value = '';
        document.getElementById('ota-code').value = ''; document.getElementById('ota-front').value = '';
        document.getElementById('ota-admin').value = ''; document.getElementById('btn-ota-save').innerText = "ğŸ’¾ å„²å­˜è¨­å®š";
        document.getElementById('btn-ota-cancel').style.display = 'none';
    }
    async function saveOTA() {
        const id = document.getElementById('ota-id').value;
        const p = { name: document.getElementById('ota-name').value, code: document.getElementById('ota-code').value, commission_rate: document.getElementById('ota-rate').value, front_url: document.getElementById('ota-front').value, admin_url: document.getElementById('ota-admin').value };
        if(!p.name) return alert("åç¨±å¿…å¡«");
        if(id) await myDB.from('ota_settings').update(p).eq('id', id); else await myDB.from('ota_settings').insert([p]);
        cancelOTA(); fetchAll();
    }

    // å„ªæƒ åˆ¸
    function toggleCpExp() {
        const noLimit = document.getElementById('cp-no-limit').checked;
        const expInput = document.getElementById('cp-exp');
        expInput.disabled = noLimit;
        if(noLimit) expInput.value = '';
    }
    function updateCpHint() {
        const type = document.getElementById('cp-type').value;
        document.getElementById('cp-val-hint').innerText = type === 'percentage' ? "æŠ˜æ‰£æ•¸å€¼ (90=9æŠ˜)" : "æŠ˜æŠµé‡‘é¡ (100=æŠ˜100)";
    }
    async function saveCoupon() {
        const id = document.getElementById('cp-edit-id').value;
        const p = {
            name: document.getElementById('cp-name').value, code: document.getElementById('cp-code').value,
            discount_type: document.getElementById('cp-type').value, discount_value: document.getElementById('cp-val').value,
            expires_at: document.getElementById('cp-no-limit').checked ? null : document.getElementById('cp-exp').value,
            allow_member: document.getElementById('cp-mem').checked, allow_guest: document.getElementById('cp-guest').checked
        };
        if(!p.name || !p.code) return alert("è³‡æ–™ä¸å…¨");
        if(id) await myDB.from('coupons').update(p).eq('id', id); else await myDB.from('coupons').insert([p]);
        resetCouponForm(); fetchAll();
    }
    function editCoupon(id) {
        const c = cache.coupons.find(x => x.id === id);
        document.getElementById('cp-edit-id').value = c.id; document.getElementById('cp-name').value = c.name;
        document.getElementById('cp-code').value = c.code; document.getElementById('cp-val').value = c.discount_value;
        document.getElementById('cp-mem').checked = c.allow_member; document.getElementById('cp-guest').checked = c.allow_guest;
        if(!c.expires_at) { document.getElementById('cp-no-limit').checked = true; document.getElementById('cp-exp').disabled = true; }
        else { document.getElementById('cp-no-limit').checked = false; document.getElementById('cp-exp').value = c.expires_at.slice(0,10); document.getElementById('cp-exp').disabled = false; }
        document.getElementById('btn-cp-save').innerText = "æ›´æ–°"; document.getElementById('btn-cp-cancel').style.display = "inline-block";
    }
    function resetCouponForm() {
        document.getElementById('cp-edit-id').value = ''; document.getElementById('cp-name').value = '';
        document.getElementById('cp-code').value = ''; document.getElementById('cp-val').value = '';
        document.getElementById('cp-exp').value = ''; document.getElementById('cp-no-limit').checked = false; document.getElementById('cp-exp').disabled = false;
        document.getElementById('btn-cp-save').innerText = "å»ºç«‹"; document.getElementById('btn-cp-cancel').style.display = "none";
    }
    async function testCoupon() {
        const c = document.getElementById('test-cp-code').value; const p = document.getElementById('test-cp-price').value;
        const { data } = await myDB.from('coupons').select('*').eq('code', c).single();
        if(!data) return alert("ç„¡æ•ˆä»£ç¢¼");
        let f = p; if(data.discount_type === 'percentage') f = Math.round(p * (data.discount_value/100)); else f = p - data.discount_value;
        alert(`åŸåƒ¹ $${p} -> æŠ˜å¾Œ $${f}`);
    }

    // --- 5. çŸ¥è­˜åº« (V15 é‚è¼¯ä¿®å¾©) ---
    async function openGallery() { document.getElementById('gallery-modal').style.display = 'flex'; loadGalleryImages(); }
    function closeGallery() { document.getElementById('gallery-modal').style.display = 'none'; }
    function switchBucket() { currentBucket = document.getElementById('bucket-select').value; loadGalleryImages(); }
    async function loadGalleryImages() {
        const grid = document.getElementById('gallery-content');
        grid.innerHTML = "<p style='padding:20px; color:#666;'>è®€å–ä¸­...</p>";
        const { data, error } = await myDB.storage.from(currentBucket).list('', { limit: 100, sortBy: { column: 'created_at', order: 'desc' } });
        if(error || !data) { grid.innerHTML = "<p>è®€å–å¤±æ•—</p>"; return; }
        grid.innerHTML = data.map(f => {
            if(f.name==='.emptyFolderPlaceholder') return '';
            const url = myDB.storage.from(currentBucket).getPublicUrl(f.name).data.publicUrl;
            return `<div class="gallery-item" onclick="insertImageToEditor('${url}')"><img src="${url}" loading="lazy"><div class="gallery-item-name">${f.name}</div></div>`;
        }).join('');
    }
    function insertImageToEditor(url) {
        const range = quill.getSelection(true);
        if (range) quill.insertEmbed(range.index, 'image', url); else quill.insertEmbed(quill.getLength(), 'image', url);
        closeGallery();
    }
    async function uploadImage() {
        const file = document.getElementById('upload-input').files[0];
        if(!file) return;
        const fileName = `${Date.now()}_${file.name}`;
        await myDB.storage.from(currentBucket).upload(fileName, file);
        loadGalleryImages();
    }

    function renderKbTree() { 
        const tree={};
        const bigSet = new Set(), midSet = new Set();
        cache.articles.forEach(a=>{
            bigSet.add(a.big_category); midSet.add(a.mid_category);
            if(!tree[a.big_category])tree[a.big_category]=[];
            if(!tree[a.big_category][a.mid_category])tree[a.big_category][a.mid_category]=[];
            tree[a.big_category][a.mid_category].push(a);
        });
        
        document.getElementById('kb-big-list').innerHTML = [...bigSet].map(v=>`<option value="${v}">`).join('');
        document.getElementById('kb-mid-list').innerHTML = [...midSet].map(v=>`<option value="${v}">`).join('');

        document.getElementById('kb-tree').innerHTML=Object.entries(tree).map(([b,mids])=>`
            <details class="big-cat" open><summary>ğŸ“‚ ${b}</summary>
            ${Object.entries(mids).map(([m,arts])=>`
                <details class="mid-cat" open><summary>â”” ${m}</summary>
                ${arts.map(a=>`<div class="article-item ${a.is_published?'':'draft'}" onclick="editKb('${a.id}')">ğŸ“„ ${a.title}</div>`).join('')}
                </details>
            `).join('')}
            </details>
        `).join(''); 
    }
    async function editKb(id){const{data}=await myDB.from('kb_articles').select('*').eq('id',id).single();document.getElementById('kb-id').value=data.id;document.getElementById('kb-title').value=data.title;document.getElementById('kb-big').value=data.big_category;document.getElementById('kb-mid').value=data.mid_category;document.getElementById('kb-pub').checked=data.is_published;quill.root.innerHTML=data.body||'';document.getElementById('btn-kb-del').style.display='inline-block';document.getElementById('mode-title').innerText="ç·¨è¼¯æ–‡ç« ";}
    function resetKbForm(){document.getElementById('kb-id').value='';document.getElementById('kb-title').value='';quill.root.innerHTML='';document.getElementById('btn-kb-del').style.display='none';document.getElementById('mode-title').innerText="æ–°å¢æ–‡ç« ";}
    async function saveArticle(){const p={title:document.getElementById('kb-title').value,big_category:document.getElementById('kb-big').value,mid_category:document.getElementById('kb-mid').value,is_published:document.getElementById('kb-pub').checked,body:quill.root.innerHTML};const id=document.getElementById('kb-id').value;if(id)await myDB.from('kb_articles').update(p).eq('id',id);else await myDB.from('kb_articles').insert([p]);alert("å·²å„²å­˜");fetchAll();}
    async function delArticle(){if(confirm("åˆªé™¤?"))await myDB.from('kb_articles').delete().eq('id',document.getElementById('kb-id').value);resetKbForm();fetchAll();}
    function previewArticle() {
        const title = document.getElementById('kb-title').value;
        const html = quill.root.innerHTML;
        const isPub = document.getElementById('kb-pub').checked;
        document.getElementById('m-title').innerText = "å‰å°é è¦½";
        document.getElementById('m-content').innerHTML = `<div style="font-family:sans-serif;line-height:1.6;padding:10px;">${!isPub?'<div style="color:red">(éš±è—ä¸­)</div>':''}<h1>${title}</h1>${html}</div>`;
        document.getElementById('modal').style.display = 'flex';
    }

    // --- 6. æœå‹™é…ç½® & æ’ç¨‹ ---
    function renderConfigTables(){const s=document.getElementById('svc-cat-filter');s.innerHTML='<option value="">è«‹é¸å¤§é¡</option>'+cache.cats.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');document.getElementById('cat-list').innerHTML=cache.cats.map(c=>`<tr><td>${c.name}</td><td><button class="btn btn-outline" style="padding:2px 6px" onclick="editCat('${c.id}')">âœï¸</button></td></tr>`).join('');}
    function filterServiceList(){const c=document.getElementById('svc-cat-filter').value;document.getElementById('svc-list-container').innerHTML=cache.svcs.filter(s=>s.category_id===c).map((s,i)=>`<div class="admin-row"><div style="display:flex;flex-direction:column;margin-right:10px"><button class="btn btn-outline" style="padding:0 5px" onclick="moveSvc('${s.id}',-1)" ${i===0?'disabled':''}>â–²</button><button class="btn btn-outline" style="padding:0 5px" onclick="moveSvc('${s.id}',1)">â–¼</button></div><div style="flex:1"><b>${s.title}</b> $${s.price} ${s.is_main?'<span class="tag tag-main">ä¸»</span>':''} ${s.report_template?`<br><small style="color:purple">${s.report_template}</small>`:''} ${s.sub_options?`<div style="color:#666;font-size:12px;">â”” ${s.sub_options}</div>`:''}</div><button class="btn btn-info" onclick="editSvc('${s.id}')">ä¿®</button><button class="btn btn-danger" onclick="delData('services','${s.id}')">åˆª</button></div>`).join('');}
    async function moveSvc(id,dir){const c=document.getElementById('svc-cat-filter').value;const l=cache.svcs.filter(s=>s.category_id===c);const i=l.findIndex(s=>s.id===id);if(i===-1||i+dir<0||i+dir>=l.length)return;const t=l[i+dir];const tmp=l[i].sort_order;l[i].sort_order=t.sort_order;t.sort_order=tmp;await Promise.all([myDB.from('services').update({sort_order:l[i].sort_order}).eq('id',l[i].id),myDB.from('services').update({sort_order:t.sort_order}).eq('id',t.id)]);fetchAll();}
    function editCat(id){const c=cache.cats.find(x=>x.id===id);document.getElementById('cat-id-edit').value=c.id;document.getElementById('cat-name').value=c.name;document.getElementById('cat-terms').value=c.terms;document.getElementById('btn-cat-save').innerText="å„²å­˜";document.getElementById('btn-cat-cancel').style.display="inline-block";}
    function cancelEdit(t){if(t==='svc'){document.getElementById('svc-id-edit').value='';document.getElementById('i-name').value='';document.getElementById('btn-svc-save').innerText="ï¼‹ æ–°å¢";document.getElementById('btn-svc-cancel').style.display="none";}else{document.getElementById('cat-id-edit').value='';document.getElementById('cat-name').value='';document.getElementById('btn-cat-save').innerText="ï¼‹ æ–°å¢";document.getElementById('btn-cat-cancel').style.display="none";}}
    async function saveCategory(){const id=document.getElementById('cat-id-edit').value,n=document.getElementById('cat-name').value,t=document.getElementById('cat-type').value,tm=document.getElementById('cat-terms').value;const q=id?myDB.from('service_categories').update({name:n,question_type:t,terms:tm}).eq('id',id):myDB.from('service_categories').insert([{name:n,question_type:t,terms:tm}]);await q;cancelEdit('cat');fetchAll();}
    function toggleSubOptionInput(){const m=document.getElementById('i-is-main').checked;document.getElementById('main-opt-wrapper').style.display=m?'block':'none';document.getElementById('sub-opt-wrapper').style.display=m?'none':'block';}
    function editSvc(id){const s=cache.svcs.find(x=>x.id===id);document.getElementById('svc-id-edit').value=s.id;document.getElementById('i-name').value=s.title;document.getElementById('i-price').value=s.price;document.getElementById('i-is-main').checked=s.is_main;document.getElementById('i-report-tpl').value=s.report_template||'';document.getElementById('i-sub-opts').value=s.sub_options||'';toggleSubOptionInput();document.getElementById('btn-svc-save').innerText="å„²å­˜";document.getElementById('btn-svc-cancel').style.display='inline-block';}
    async function saveItem(){const id=document.getElementById('svc-id-edit').value,p={category_id:document.getElementById('svc-cat-filter').value,title:document.getElementById('i-name').value,price:document.getElementById('i-price').value,is_main:document.getElementById('i-is-main').checked,report_template:document.getElementById('i-report-tpl').value,sub_options:document.getElementById('i-sub-opts').value};if(!p.category_id)return alert("é¸å¤§é¡");if(!id){const s=cache.svcs.filter(x=>x.category_id===p.category_id);p.sort_order=s.length?Math.max(...s.map(x=>x.sort_order))+1000:1000;}if(id)await myDB.from('services').update(p).eq('id',id);else await myDB.from('services').insert([p]);cancelEdit('svc');fetchAll();}
    
    function renderTimeGrid(){let h='';for(let i=13;i<=25;i++){['00','30'].forEach(m=>{let hh=i>=24?i-24:i;let t=`${hh.toString().padStart(2,'0')}:${m}`;let v=`${i}:${m}`;h+=`<div class="batch-slot"><input type="checkbox" name="ts" value="${v}"> ${t}</div>`})}document.getElementById('time-grid').innerHTML=h;}
    function toggleAllSlots(c){document.querySelectorAll('input[name="ts"]').forEach(e=>e.checked=c);}
    async function batchAddSchedule(){const d1=document.getElementById('batch-start').value,d2=document.getElementById('batch-end').value||d1,ts=Array.from(document.querySelectorAll('input[name="ts"]:checked')).map(e=>e.value);if(!d1||!ts.length)return alert("é¸æ—¥æœŸæ™‚é–“");let ins=[],c=new Date(d1),e=new Date(d2);while(c<=e){const d=c.toISOString().split('T')[0];ts.forEach(t=>{let[hh,mm]=t.split(':').map(Number);let ad=new Date(c);if(hh>=24){ad.setDate(ad.getDate()+1);hh-=24;}ins.push({slot_date:ad.toISOString().split('T')[0],slot_time:`${hh.toString().padStart(2,'0')}:${mm}`})});c.setDate(c.getDate()+1);}await myDB.from('schedule_slots').insert(ins);alert("å·²ç”Ÿæˆ");fetchAll();}
    function renderCalendar(){const t=new Date();document.getElementById('cal-title').innerText=`${currentYear}/${currentMonth}`;const fd=new Date(currentYear,currentMonth-1,1).getDay(),dim=new Date(currentYear,currentMonth,0).getDate();let h='';for(let i=0;i<fd;i++)h+='<div class="cal-cell empty"></div>';for(let d=1;d<=dim;d++){const ds=`${currentYear}-${currentMonth.toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;const s=cache.slots.filter(x=>x.slot_date===ds);const f=s.filter(x=>!x.is_booked).length,bk=s.filter(x=>x.is_booked).length;h+=`<div class="cal-cell ${ds===selectedDateStr?'active':''}" onclick="selectDate('${ds}')"><div class="cal-date">${d}</div>${f?`<div class="dot-free">ğŸ”µ${f}</div>`:''}${bk?`<div class="dot-booked">ğŸ”´${bk}</div>`:''}</div>`}document.getElementById('calendar-body').innerHTML=h;}
    function changeMonth(o){currentMonth+=o;if(currentMonth>12){currentMonth=1;currentYear++}else if(currentMonth<1){currentMonth=12;currentYear--}renderCalendar();}
    function selectDate(d){selectedDateStr=d;renderCalendar();document.getElementById('detail-date-title').innerText=d;const s=cache.slots.filter(x=>x.slot_date===d).sort((a,b)=>a.slot_time.localeCompare(b.slot_time));document.getElementById('day-detail-container').innerHTML=s.map(x=>`<div class="compact-slot ${x.is_booked?'booked':'free'}">${x.slot_time.slice(0,5)} <span class="compact-del" onclick="delSlot('${x.id}')">Ã—</span></div>`).join('');}
    async function delSlot(id){if(confirm("åˆª?"))await myDB.from('schedule_slots').delete().eq('id',id);fetchAll();}
    function render7DaySchedule(){const t=new Date();let h='';for(let i=0;i<7;i++){const d=new Date(t);d.setDate(t.getDate()+i);const ds=d.toISOString().split('T')[0];const s=cache.slots.filter(x=>x.slot_date===ds).sort((a,b)=>a.slot_time.localeCompare(b.slot_time));if(s.length)h+=`<div class="upcoming-day"><div class="upcoming-day-header">${ds}</div><div class="upcoming-slots">${s.map(x=>`<span class="u-slot ${x.is_booked?'booked':''}">${x.slot_time.slice(0,5)}</span>`).join('')}</div></div>`}document.getElementById('dashboard-7day-schedule').innerHTML=h||"ç„¡";}
    
    // Utils
    function closeModal(){document.getElementById('modal').style.display='none';}
    function switchTab(id){document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));document.getElementById('tab-'+id).classList.add('active');document.querySelectorAll('.sidebar button').forEach(b=>b.classList.remove('active'));document.getElementById('nav-'+id).classList.add('active');}
    async function delData(table, id){if(confirm("åˆªé™¤ï¼Ÿ")){await myDB.from(table).delete().eq('id',id);fetchAll();}}
    window.updateS = async function(id,s){if(confirm("ç¢ºå®š?"))await myDB.from('bookings').update({status:s}).eq('id',id);closeModal();fetchAll();}
    async function linkUser(u,b){if(confirm("æ­¸æˆ¶?"))await myDB.from('bookings').update({user_id:u}).eq('id',b);fetchAll();}
    function copyCode(el) { navigator.clipboard.writeText(el.innerText).then(() => alert("æŒ‡ä»¤å·²è¤‡è£½ï¼")); }
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸ¹ç™’ä¸­æ§å®¤ V60 | ç©©å®šå›æ­¸ç‰ˆ</title>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quill-image-resize-module@3.0.0/image-resize.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@600;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* ================= å…¨åŸŸæ¨£å¼ ================= */
        :root { 
            --forest: #1a2f23; --cream: #fdfaf1; --accent: #c6a87c; 
            --dark: #2c3e50; --danger: #e74c3c; --info: #3498db; 
            --success: #27ae60; --warning: #f39c12; --purple: #9b59b6; 
        }
        * { box-sizing: border-box; }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: #f4f7f6; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* å·¦å´å°èˆª */
        .sidebar { width: 240px; background: var(--forest); height: 100%; color: white; flex-shrink: 0; display: flex; flex-direction: column; overflow-y: auto; transition: width 0.3s ease; overflow-x: hidden; white-space: nowrap; }
        body.hide-nav .sidebar { width: 0; }
        .sidebar h2 { text-align: center; color: var(--accent); padding: 25px 0; border-bottom: 1px solid #2a3f33; margin: 0; font-size: 1.2rem; font-family: 'Noto Serif TC', serif; }
        .sidebar button { width: 100%; padding: 18px; background: none; border: none; color: #ccc; text-align: left; cursor: pointer; border-bottom: 1px solid #2a3f33; font-size: 14px; transition: 0.2s; }
        .sidebar button:hover { background: #2a3f33; color: white; }
        .sidebar button.active { background: #2a3f33; color: var(--accent); font-weight: bold; border-left: 5px solid var(--accent); }
        
        /* ä¸»å…§å®¹ */
        .main { flex: 1; padding: 30px; overflow-y: auto; background: #f4f7f6; position: relative; }
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* å¡ç‰‡èˆ‡æŒ‰éˆ• */
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; border-top: 4px solid var(--accent); overflow-x: auto; }
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; font-size: 13px; transition:0.2s; display: inline-block; margin-right: 5px; text-decoration: none; white-space:nowrap; }
        .btn:hover { opacity: 0.8; transform: translateY(-1px); }
        .btn-forest { background: var(--forest); color: white; }
        .btn-info { background: var(--info); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-purple { background: var(--purple); color: white; }
        .btn-outline { background: white; border: 1px solid #ccc; color: #666; }
        .btn-sort { background: #7f8c8d; padding: 4px 8px; font-size: 12px; color:white; line-height: 1; }

        /* è¡¨æ ¼å„ªåŒ– */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; table-layout: auto !important; }
        th { background: #f8f9fa; color: #666; font-weight: bold; padding: 12px; text-align: left; border-bottom: 2px solid #eee; white-space: nowrap !important; }
        td { padding: 10px 8px !important; text-align: left; border-bottom: 1px solid #eee; font-size: 14px; vertical-align: middle; color: #444; word-break: keep-all !important; white-space: nowrap !important; }
        tr:hover { background: #fdfaf1; }

        /* æ¨™ç±¤ */
        .tag { padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight:bold; color: white; display: inline-block; margin-right: 3px; }
        .tag-main { background: #d32f2f; }
        .tag-addon { background: #1976d2; }
        .tag-ota { background: #f39c12; }
        .tag-coupon { background: #e91e63; padding: 4px 8px; font-size: 12px; border-radius: 20px; }
        .tag-paid { background: #d4edda; color: #155724; padding: 3px 6px; border-radius: 4px; font-size:12px; }
        .tag-wait { background: #fff3cd; color: #856404; padding: 3px 6px; border-radius: 4px; font-size:12px; }

        input, select, textarea { padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%; box-sizing: border-box; font-size: 14px; margin-bottom: 5px; }
        input:disabled { background: #eee; color: #999; cursor: not-allowed; }
        .finance-nav { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        .finance-nav button { flex: 1; padding: 10px; border: none; background: #eee; cursor: pointer; border-radius: 8px 8px 0 0; font-weight: bold; color: #666; transition: 0.2s; }
        .finance-nav button.active { background: var(--forest); color: white; }

        /* KB æ¨£å¼ */
        .kb-layout { display: grid; grid-template-columns: 280px 1fr; gap: 20px; height: calc(100vh - 100px); transition: all 0.3s ease; }
        .kb-layout.collapsed { grid-template-columns: 0 1fr; gap: 0; }
        .kb-sidebar { background: #2c3e50; color: #ecf0f1; border-radius: 8px; overflow-y: auto; display: flex; flex-direction: column; overflow-x: hidden; white-space: nowrap; }
        .kb-header { padding: 15px; background: #1a252f; border-bottom: 1px solid #34495e; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; }
        .kb-tree-content { padding: 10px; flex: 1; }
        details.big-cat { margin-bottom: 5px; }
        details.big-cat > summary { padding: 10px; cursor: pointer; font-weight: bold; list-style: none; border-radius: 4px; color: #ecf0f1; }
        details.big-cat > summary:hover { background: rgba(255,255,255,0.1); }
        details.mid-cat { margin-left: 12px; border-left: 1px solid #555; }
        details.mid-cat > summary { padding: 8px; cursor: pointer; color: #ccc; font-size: 0.95rem; }
        details.mid-cat > summary:hover { color: #fff; }
        .article-item { padding: 8px 10px 8px 20px; cursor: pointer; color: #bdc3c7; display: block; font-size: 0.95rem; border-radius: 4px; transition: 0.2s; border-bottom: 1px solid #34495e; display: flex; align-items: center; }
        .article-item:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .article-item.active { color: #fff; background: #c6a87c; font-weight: bold; }
        .article-item.draft { color: #e74c3c; } 
        .article-item.draft::before { content: 'ğŸ”´ '; font-size: 10px; }
        .sort-actions { display: inline-flex; gap: 2px; margin-right: 8px; vertical-align: middle; }
        .btn-sort-arrow { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: #aaa; cursor: pointer; padding: 0 4px; font-size: 10px; border-radius: 3px; line-height: 1.2; }
        .btn-sort-arrow:hover { background: rgba(255,255,255,0.2); color: #fff; }
        .article-item .sort-actions { margin-right: 10px; opacity: 0.3; transition: 0.2s; }
        .article-item:hover .sort-actions { opacity: 1; }
        .article-title-span { flex: 1; }

        /* ç·¨è¼¯å™¨å®¹å™¨ */
        #editor-container { flex: 1; min-height: 200px; display: flex; flex-direction: column; background: white; margin-bottom: 0; border: 1px solid #ccc; overflow: hidden; }
        .ql-container { flex: 1; overflow-y: auto; font-size: 16px; font-family: "Microsoft JhengHei", sans-serif; }
        .ql-font-serif { font-family: 'Noto Serif TC', serif !important; }
        .ql-font-monospace { font-family: 'Courier New', monospace !important; }
        .ql-picker-item[data-value="serif"]::before { font-family: 'Noto Serif TC', serif !important; content: 'å®‹é«” (Serif)' !important; }
        .ql-picker-item[data-value="monospace"]::before { font-family: 'Courier New', monospace !important; content: 'ç­‰å¯¬ (Mono)' !important; }
        .ql-picker-label[data-value="serif"]::before { font-family: 'Noto Serif TC', serif !important; content: 'å®‹é«” (Serif)' !important; }

        /* åœ–åº«èˆ‡ Modals */
        .gallery-box { background: white; width: 90%; height: 90%; border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; }
        .gallery-header { padding: 15px 20px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .gallery-grid { flex: 1; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; padding: 20px; background: #fff; }
        .gallery-item { border: 2px solid #eee; border-radius: 6px; overflow: hidden; cursor: pointer; transition: 0.2s; position: relative; aspect-ratio: 1/1; }
        .gallery-item:hover { border-color: #3498db; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; }
        .gallery-item-name { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.6); color: white; font-size: 11px; padding: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; }
        .modal-body { background: white; width: 90%; max-width: 800px; padding: 30px; border-radius: 15px; position: relative; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .close-btn { position: absolute; right: 20px; top: 15px; cursor: pointer; font-size: 24px; color: #999; }
        
        /* é–å±èˆ‡å…¶ä»– */
        #admin-lock { position: fixed; top:0; left:0; width:100%; height:100vh; background: var(--forest); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
        #admin-lock input { padding: 10px; border-radius: 5px; border: none; width: 200px; margin-bottom: 10px; text-align: center; }
        .batch-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; }
        .batch-slot { position: relative; }
        .batch-slot input { position: absolute; opacity: 0; cursor: pointer; }
        .batch-slot label { display: block; padding: 8px; background: #fff; border: 1px solid #ccc; border-radius: 5px; text-align: center; font-size: 13px; cursor: pointer; transition: 0.2s; }
        .batch-slot input:checked + label { background: var(--forest); color: white; border-color: var(--forest); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; background: #fff; }
        .cal-cell { border: 1px solid #eee; min-height: 80px; padding: 5px; cursor: pointer; position: relative; background: white; transition: 0.2s; }
        .cal-cell:hover { background: #f9f9f9; border-color: var(--accent); }
        .cal-cell.active { border: 2px solid var(--forest); background: #f0f7ff; }
        .day-detail-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; }
        .compact-slot { padding: 5px; border: 1px solid #ddd; border-radius: 4px; text-align: center; font-size: 12px; background: white; position: relative; }
        .compact-slot.booked { background: #fff5f5; color: #c0392b; border-color: #e74c3c; }
        .compact-slot.free { background: #f0f7ff; color: #2980b9; border-color: #3498db; }
        .compact-del { position: absolute; top:-5px; right:-5px; background:red; color:white; width:15px; height:15px; border-radius:50%; font-size:10px; line-height:15px; cursor:pointer; display:none; }
        .compact-slot:hover .compact-del { display: block; }
        .u-slot { display: inline-block !important; margin: 3px !important; padding: 4px 8px !important; background: #f0f7ff; border: 1px solid #d6e9f9; border-radius: 4px; font-size: 12px; color: #2980b9; }
        .u-slot.booked { background: #fff5f5; border-color: #e74c3c; color: #c0392b; text-decoration: line-through; opacity: 0.7; }
        .admin-row { display: flex; gap: 10px; align-items: center; padding: 12px; border-bottom: 1px solid #eee; background: #fff; transition: 0.2s; }
        .admin-row:hover { background: #f0f7ff; }
        
        /* SQL è¤‡è£½å€æ¨£å¼ */
        .sql-hint-box { background: #fff3cd; border: 1px solid #ffeeba; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 12px; color: #856404; position: relative; }
        .sql-code-area { background: #eee; padding: 10px; margin-top: 5px; border-radius: 4px; font-family: monospace; word-break: break-all; }
        .btn-copy-sql { position: absolute; right: 10px; top: 10px; font-size: 11px; padding: 2px 6px; }

        .dashboard-layout { grid-template-columns: 3fr 1fr !important; }
        /* ğŸ”¥ ç·¨è¼¯å™¨ç¾åŒ–ï¼šæ©˜è‰²å¼•ç”¨ç·š & ç¸®æ’è¨­å®š ğŸ”¥ */
        .ql-editor blockquote {
        border-left: 5px solid #d35400 !important; /* æ©˜è‰²ç²—ç·š */
        background-color: #fffaf0 !important;      /* æ·¡ç±³è‰²åº• */
        padding: 10px 15px !important;             /* å…§è· */
        margin: 10px 0 !important;
        color: #8a5a00;
        font-weight: bold;
        }
    
        /* è®“ç¸®æ’ (Indent) çœŸçš„æœ‰æ•ˆæœ */
        .ql-indent-1 { padding-left: 2em !important; }
        .ql-indent-2 { padding-left: 4em !important; }
        .ql-indent-3 { padding-left: 6em !important; }
    
        /* è®“å°é½Š (Align) çœŸçš„æœ‰æ•ˆæœ */
        .ql-align-center { text-align: center !important; }
        .ql-align-right { text-align: right !important; }
        /* ğŸ”¥ æ ¼å¼åˆ·æ¸¸æ¨™æ¨£å¼ ğŸ”¥ */
        .painter-active {
            cursor: copy !important; /* æ»‘é¼ è®Šæˆè¤‡è£½åœ–ç¤º */
            user-select: none;
         }
        /* è®“æ ¼å¼åˆ·æŒ‰éˆ•è¢«æŒ‰ä¸‹æ™‚æœ‰é¡è‰² */
        .ql-format-painter.active {
            color: var(--forest) !important;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div id="admin-lock">
    <h2 style="color:var(--accent);">ğŸ”’ åŸ¹ç™’ä¸­æ§å®¤ V60</h2>
    <input type="password" id="admin-pwd" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
    <button class="btn btn-warning" onclick="checkAdmin()">é€²å…¥ç³»çµ±</button>
</div>

<div id="gallery-modal" class="modal" style="z-index: 3000;">
    <div class="gallery-box">
        <div class="gallery-header">
            <div style="display:flex; align-items:center; gap:10px;">
                <h3 style="margin:0;">ğŸ–¼ï¸ å…¨åŸŸåœ–åº«</h3>
                <select id="bucket-select" onchange="switchBucket()" style="padding:5px;">
                    <option value="kb-images">æ–‡ç« é…åœ– (kb-images)</option>
                    <option value="site-assets">ç¶²ç«™ç´ æ (site-assets)</option>
                    <option value="banners">æ©«å¹… (banners)</option>
                </select>
            </div>
            <div style="display:flex; gap:10px;">
                <input type="file" id="upload-input" accept="image/*" style="display:none" onchange="uploadImage()">
                <button class="btn btn-forest" onclick="document.getElementById('upload-input').click()">â¬†ï¸ ä¸Šå‚³</button>
                <button class="btn btn-danger" onclick="document.getElementById('gallery-modal').style.display='none'">é—œé–‰</button>
            </div>
        </div>
        <div id="gallery-content" class="gallery-grid"></div>
    </div>
</div>

<div class="sidebar">
    <h2>åŸ¹ç™’æ§åˆ¶ä¸­å¿ƒ</h2>
    <button onclick="switchTab('bks')" id="nav-bks" class="active">ğŸ“… é ç´„çœ‹æ¿</button>
    <button onclick="switchTab('schedule')" id="nav-schedule">ğŸ•’ æ’ç¨‹ç®¡ç†</button>
    <button onclick="switchTab('pro')" id="nav-pro">ğŸ‘¤ å€‹æ¡ˆ CRM</button>
    <button onclick="switchTab('finance')" id="nav-finance">ğŸ’° è²¡å‹™èˆ‡å„ªæƒ åˆ¸</button>
    <button onclick="switchTab('kb')" id="nav-kb">ğŸ“ çŸ¥è­˜åº« (CMS)</button>
    <button onclick="switchTab('menu')" id="nav-menu">âš™ï¸ æœå‹™é…ç½®</button>
</div>

<div class="main">
    <button class="btn btn-outline" onclick="toggleMainSidebar()" style="margin-bottom: 15px; padding: 5px 10px;">â˜° é¸å–®é–‹é—œ</button>
    
    <div id="tab-bks" class="tab-content active">
        <div class="dashboard-layout" style="display: grid; grid-template-columns: 2.5fr 1fr; gap: 20px;">
            <div>
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3>ğŸ“‹ è¿‘æœŸé ç´„æ¸…å–®</h3>
                        <button class="btn btn-outline" onclick="fetchAll()">ğŸ”„ åˆ·æ–°</button>
                    </div>
                    <input type="text" id="search-key" placeholder="ğŸ” æœå°‹ å§“å / æ‰‹æ©Ÿ / å–®è™Ÿ / OTA..." style="margin-bottom:15px;" onkeyup="renderBks()">
                    <table>
                        <thead><tr><th width="20%">å–®è™Ÿ/æ—¥æœŸ</th><th width="25%">å€‹æ¡ˆè³‡è¨Š</th><th width="25%">æœå‹™å…§å®¹</th><th width="10%">é‡‘é¡</th><th width="10%">ç‹€æ…‹</th><th width="10%">æ“ä½œ</th></tr></thead>
                        <tbody id="bk-list"></tbody>
                    </table>
                </div>
            </div>
            <div>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <div class="card" style="flex:1; padding:15px; border-top-color:var(--success);">
                        <small>ğŸ’° æœ¬æœˆå¯¦æ”¶</small><h2 id="inc-val" style="margin:5px 0; color:var(--success);">$0</h2>
                    </div>
                    <div class="card" style="flex:1; padding:15px; border-top-color:var(--info);">
                        <small>ğŸ‘¤ ç´¯ç©å€‹æ¡ˆ</small><h2 id="total-val" style="margin:5px 0;">0</h2>
                    </div>
                </div>
                <div class="card" style="border-top-color: var(--purple);">
                    <h3 style="margin-top:0;">ğŸ“… 7æ—¥æ’ç¨‹æ¦‚è¦½</h3>
                    <div id="dashboard-7day-schedule" style="font-size:13px; line-height:1.8;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-schedule" class="tab-content">
        <div style="display: flex; gap: 20px; height: 85vh;">
            <div class="card" style="width:280px; flex-shrink:0; overflow-y:auto;">
                <h4 style="color:var(--forest); margin-top:0;">âš¡ å¿«é€Ÿæ’ç­</h4>
                <label>æ—¥æœŸå€é–“</label>
                <div style="display:flex; gap:2px; margin-bottom:10px;">
                    <input type="date" id="batch-start"><span style="padding-top:5px;">~</span><input type="date" id="batch-end">
                </div>
                <label>å‹¾é¸æ™‚æ®µ (æ¯30åˆ†)</label>
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <button class="btn btn-outline" style="font-size:10px; flex:1;" onclick="toggleAllSlots(true)">å…¨é¸</button>
                    <button class="btn btn-outline" style="font-size:10px; flex:1;" onclick="toggleAllSlots(false)">æ¸…ç©º</button>
                </div>
                <div id="time-grid" class="batch-grid"></div>
                <button class="btn btn-forest" style="width:100%; margin-top:15px;" onclick="batchAddSchedule()">ğŸš€ ç”Ÿæˆæ’ç¨‹</button>
            </div>
            <div class="card" style="flex:1; display:flex; flex-direction:column;">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <button class="btn btn-outline" onclick="changeMonth(-1)">â—€</button>
                    <h3 id="cal-title" style="margin:0;">Loading...</h3>
                    <button class="btn btn-outline" onclick="changeMonth(1)">â–¶</button>
                </div>
                <div id="calendar-body" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; flex:1;"></div>
            </div>
            <div class="card" style="width:250px; flex-shrink:0; background:#fdfdfd;">
                <h4 id="detail-date-title" style="margin-top:0; color:var(--dark); border-bottom:2px solid var(--accent); padding-bottom:10px;">è«‹é¸æ“‡æ—¥æœŸ</h4>
                <div id="day-detail-container" class="day-detail-list"></div>
            </div>
        </div>
    </div>

    <div id="tab-pro" class="tab-content">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>ğŸ‘¤ æœƒå“¡ç®¡ç†ç³»çµ± (CRM)</h3>
                <button class="btn btn-outline" onclick="fetchAll()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
            </div>
            <input type="text" id="search-member" placeholder="ğŸ” æœå°‹å§“åæˆ–æ‰‹æ©Ÿ..." onkeyup="renderPro()" style="margin-bottom:15px;">
            <div style="overflow-x: auto;">
                <table>
                    <thead><tr><th width="15%">å§“å</th><th width="15%">æ‰‹æ©Ÿ</th><th width="20%">Email</th><th width="15%">ç´¯ç©æ¶ˆè²»</th><th width="15%">æœ€è¿‘é ç´„</th><th width="20%">æ“ä½œ</th></tr></thead>
                    <tbody id="pro-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-finance" class="tab-content">
        <div class="card">
            <div class="finance-nav">
                <button onclick="switchFinanceSub('ota')" id="btn-sub-ota" class="active">ğŸ’° OTA å¹³å°è¨­å®š</button>
                <button onclick="switchFinanceSub('coupon')" id="btn-sub-coupon">ğŸ« å„ªæƒ åˆ¸ç®¡ç†</button>
            </div>
            <div id="sub-ota">
                <div style="background:#f9f9f9; padding:20px; border-radius:8px; margin-bottom:20px;">
                    <h4 style="margin-top:0; color:#555;">â• æ–°å¢ / ä¿®æ”¹å¹³å°</h4>
                    <input type="hidden" id="ota-id">
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <div style="flex:1"><label>å¹³å°åç¨±</label><input type="text" id="ota-name" placeholder="ä¾‹: è¦çš®è³¼ç‰©"></div>
                        <div style="flex:1"><label>è‹±æ–‡ä»£è™Ÿ</label><input type="text" id="ota-code" placeholder="ä¾‹: shopee"></div>
                        <div style="width:100px;"><label>ä½£é‡‘ %</label><input type="number" id="ota-rate" placeholder="5.5"></div>
                    </div>
                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <div style="flex:1"><label>å‰å°ç¶²å€</label><input type="text" id="ota-front" placeholder="https://..."></div>
                        <div style="flex:1"><label>å¾Œå°ç¶²å€</label><input type="text" id="ota-admin" placeholder="https://..."></div>
                    </div>
                    <div style="text-align:right;">
                        <button class="btn btn-outline" id="btn-ota-cancel" onclick="cancelOTA()" style="display:none; margin-right:5px;">å–æ¶ˆ</button>
                        <button class="btn btn-warning" id="btn-ota-save" onclick="saveOTA()" style="width:150px;">ğŸ’¾ å„²å­˜è¨­å®š</button>
                    </div>
                </div>
                <table><thead><tr><th width="15%">å¹³å°åç¨±</th><th width="10%">ä»£è™Ÿ</th><th width="10%">ä½£é‡‘</th><th width="45%">ç¶²å€é€£çµ</th><th width="20%">æ“ä½œ</th></tr></thead><tbody id="ota-list"></tbody></table>
            </div>

            <div id="sub-coupon" style="display:none;">
                <input type="hidden" id="cp-edit-id">
                <div style="background:#fffcf5; padding:20px; border:1px solid #fae1c3; border-radius:10px; margin-bottom:20px;">
                    <h4 style="margin-top:0; color:#e65100;">ğŸ« å„ªæƒ åˆ¸ç·¨è¼¯å™¨</h4>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                        <div><label>å„ªæƒ åˆ¸åç¨±</label><input type="text" id="cp-name" placeholder="ä¾‹å¦‚ï¼šæ–°æ˜¥èª¿é » 9 æŠ˜"></div>
                        <div><label>å„ªæƒ ä»£ç¢¼ (Code)</label><input type="text" id="cp-code" placeholder="ä¾‹å¦‚ï¼š2026NEW" style="text-transform:uppercase;"></div>
                        <div><label>æŠ˜æ‰£é¡å‹</label><select id="cp-type" onchange="updateCpHint()"><option value="percentage">æ‰“æŠ˜ (Percentage)</option><option value="fixed">æŠ˜æŠµé‡‘é¡ (Fixed Amount)</option></select></div>
                        <div><label id="cp-val-hint">æŠ˜æ‰£æ•¸å€¼ (90 = 9æŠ˜)</label><input type="number" id="cp-val" placeholder="è¼¸å…¥æ•¸å€¼"></div>
                        <div>
                            <label>ä½¿ç”¨æœŸé™</label>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <input type="date" id="cp-exp">
                                <label style="white-space:nowrap; cursor:pointer;"><input type="checkbox" id="cp-no-limit" onchange="toggleCpExp()" style="margin-right:5px;"> ç„¡æœŸé™</label>
                            </div>
                        </div>
                        <div>
                            <label>é©ç”¨å°è±¡</label>
                            <div style="margin-top:10px; display:flex; gap:20px;">
                                <label><input type="checkbox" id="cp-mem" checked style="margin-right:5px;"> éœ€æœƒå“¡</label>
                                <label><input type="checkbox" id="cp-guest" style="margin-right:5px;"> è¨ªå®¢å¯ç”¨</label>
                            </div>
                        </div>
                    </div>
                    <div style="text-align:right; margin-top:20px;">
                        <button class="btn btn-outline" id="btn-cp-cancel" onclick="resetCouponForm()" style="display:none;">å–æ¶ˆ</button>
                        <button class="btn btn-forest" id="btn-cp-save" onclick="saveCoupon()" style="padding:10px 30px;">å»ºç«‹å„ªæƒ åˆ¸</button>
                    </div>
                </div>
                <table><thead><tr><th>åç¨±</th><th>ä»£ç¢¼</th><th>å…§å®¹</th><th>æœŸé™</th><th>å°è±¡</th><th>æ¬¡æ•¸</th><th>æ“ä½œ</th></tr></thead><tbody id="cp-list"></tbody></table>
            </div>
        </div>
    </div>

    <div id="tab-kb" class="tab-content">
        <div class="kb-layout">
            <div class="kb-sidebar">
                <div class="kb-header">
                    <span style="font-weight:bold;">çŸ¥è­˜åº«åˆ—è¡¨</span>
                    <button class="btn btn-success" style="padding:4px 8px; font-size:12px;" onclick="resetKbForm()">ï¼‹ æ–°å¢</button>
                </div>
                <div id="kb-tree" class="kb-tree-content"></div>
            </div>
            <div class="card" style="display:flex; flex-direction:column; overflow-y:hidden; height:100%;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h2 id="mode-title" style="margin:0; color:var(--dark);">æ–°å¢æ–‡ç« </h2>
                    <button class="btn btn-purple" onclick="openGallery()">ğŸ–¼ï¸ é–‹å•Ÿåœ–åº«</button>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr 2fr; gap:15px; margin-bottom:15px;">
                    <div><label style="font-weight:bold;">å¤§åˆ†é¡</label><input list="kb-big-list" id="kb-big" placeholder="ä¾‹: äººé¡åœ–"><datalist id="kb-big-list"></datalist></div>
                    <div><label style="font-weight:bold;">ä¸­åˆ†é¡</label><input list="kb-mid-list" id="kb-mid" placeholder="ä¾‹: é€šé“"><datalist id="kb-mid-list"></datalist></div>
                    <div><label style="font-weight:bold;">æ–‡ç« æ¨™é¡Œ</label><input type="text" id="kb-title" placeholder="è¼¸å…¥æ¨™é¡Œ..."></div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; background:#f1f8e9; padding:10px; border-radius:8px;">
                    <div><label style="display:flex; align-items:center; gap:5px; font-weight:bold; margin:0; cursor:pointer;"><input type="checkbox" id="kb-pub" checked style="width:auto; cursor:pointer;"> å‰å°é¡¯ç¤º</label></div>
                    <div style="display:flex; gap:10px;">
                        <input type="hidden" id="kb-id">
                        <button class="btn btn-danger" onclick="delArticle()" style="display:none;" id="btn-kb-del">åˆªé™¤</button>
                        <button class="btn btn-info" onclick="previewArticle()">ğŸ‘ï¸ é è¦½</button>
                        <button class="btn btn-forest" onclick="saveArticle()">ğŸ’¾ å„²å­˜æ–‡ç« </button>
                    </div>
                </div>
                <div id="editor-container">
                    <div id="editor"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-menu" class="tab-content">
        <div style="display:grid; grid-template-columns: 1fr 1.5fr; gap:20px;">
            <div class="card" id="card-cat">
                <h3>ğŸ“‚ å¤§é¡ç®¡ç†</h3>
                <input type="hidden" id="cat-id-edit">
                <input type="text" id="cat-name" placeholder="å¤§é¡åç¨±" style="width:100%; margin-bottom:10px; padding:8px;">
                <select id="cat-type" style="width:100%; margin-bottom:10px; padding:8px;"><option value="sleep">è©¢å•ç¡çœ  (èª¿é »é¡)</option><option value="consult">è©¢å•æ—¥æœŸ (è«®è©¢é¡)</option></select>
                <textarea id="cat-terms" placeholder="æœå‹™è¦ç¯„æ¢æ¬¾" style="width:100%; height:80px; margin-bottom:10px; padding:8px;"></textarea>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-forest" id="btn-cat-save" onclick="saveCategory()">ï¼‹ æ–°å¢</button>
                    <button class="btn btn-outline" id="btn-cat-cancel" onclick="cancelEdit('cat')" style="display:none;">å–æ¶ˆ</button>
                </div>
                <table id="cat-list" style="margin-top:15px;"></table>
            </div>
            <div class="card" id="card-svc">
                <h3>âš™ï¸ ç´°é …ç®¡ç†</h3>
                
                <div class="sql-hint-box">
                    <strong>ğŸ’¡ SQL è£œä¸ (è‹¥ç„¡æ³•æ–°å¢è«‹åœ¨ Supabase åŸ·è¡Œ)ï¼š</strong>
                    <button class="btn btn-outline btn-copy-sql" onclick="copySqlCode()">ğŸ“‹ è¤‡è£½ä»£ç¢¼</button>
                    <div class="sql-code-area" id="sql-code-block">
                        ALTER TABLE services ADD COLUMN IF NOT EXISTS report_template TEXT;
                    </div>
                </div>

                <input type="hidden" id="svc-id-edit">
                <select id="svc-cat-filter" style="width:100%; margin-bottom:10px; padding:8px; border:2px solid var(--info); background:#f0f8ff;" onchange="filterServiceList()"><option value="">è¼‰å…¥ä¸­...</option></select>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="i-name" placeholder="é …ç›®å" style="flex:2;">
                    <input type="number" id="i-price" placeholder="åƒ¹æ ¼" style="flex:1;">
                </div>
                <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin:10px 0;">
                    <label style="display:flex; align-items:center; gap:5px; margin-bottom:10px; color:var(--danger); font-weight:bold; cursor:pointer;">
                        <input type="checkbox" id="i-is-main" style="width:18px; height:18px;" onchange="toggleSubOptionInput()"> è¨­ç‚ºä¸»é …ç›® (å–®é¸äº’æ–¥ï¼Œç„¡å­é¸é …)
                    </label>
                    <div id="main-opt-wrapper" style="display:none;">
                        <input type="text" id="i-report-tpl" placeholder="å°æ‡‰å ±å‘Šæª”æ¡ˆ (ä¾‹: srt_report.html)">
                        <small style="color:var(--purple);">ğŸ’¡ è‹¥ç‚ºä¸»é …ç›®ï¼Œè«‹å¡«å¯«æ­¤æ¬„ä»¥é€£çµå ±è¡¨ã€‚</small>
                    </div>
                    <div id="sub-opt-wrapper">
                        <input type="text" id="i-sub-opts" placeholder="å­é¸é … (é€—è™Ÿéš”é–‹)">
                        <small style="color:#666;">ğŸ’¡ åŠ è³¼é …ç›®æ‰éœ€è¦</small>
                    </div>
                </div>
                <div style="display:flex; gap:10px; justify-content: flex-end;">
                    <button class="btn btn-outline" id="btn-svc-cancel" onclick="cancelEdit('svc')" style="display:none;">å–æ¶ˆ</button>
                    <button class="btn btn-forest" id="btn-svc-save" onclick="saveItem()">ï¼‹ æ–°å¢é …ç›®</button>
                </div>
                <div style="max-height:400px; overflow-y:auto; margin-top:15px; border-top:1px solid #eee;" id="svc-list-container">
                    <p style="padding:10px; color:#999;">è«‹å…ˆé¸æ“‡ä¸Šæ–¹çš„å¤§é¡...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modal" class="modal">
    <div class="modal-body">
        <span onclick="closeModal()" class="close-btn">Ã—</span>
        <h2 id="m-title" style="border-bottom:1px solid #eee; padding-bottom:10px; color:var(--forest);">è©³æƒ…</h2>
        <div id="m-content"></div>
    </div>
</div>

<script>
    // ==========================================
    // ğŸš€ åŸ¹ç™’ä¸­æ§å®¤ V60 | ç©©å®šå›æ­¸ç‰ˆ
    // ==========================================

    // 1. åˆå§‹åŒ– Supabase
    const SB_URL = "https://geyrpowhaqfhnxghpokr.supabase.co";
    const SB_KEY = "sb_publishable_aXucdq8UtvMbCKbriqpJCw_gtpYBw-r";
    const myDB = supabase.createClient(SB_URL, SB_KEY);
    const cleanPhone = (p) => p ? p.replace(/\D/g, '') : '';
    
    // 2. å®šç¾©å…¨åŸŸè®Šæ•¸ (æœ€å„ªå…ˆ)
    let cache = { bks:[], pros:[], cats:[], svcs:[], slots:[], otas:[], coupons:[], articles:[] };
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth() + 1;
    let selectedDateStr = "";
    let currentBucket = 'kb-images';
    let kbCatOrder = { big: [], mid: {} };

    const STATUS_MAP = {
        'paid': '<span class="tag tag-paid">å·²ä»˜æ¬¾</span>',
        'pending': '<span class="tag tag-wait">æœªä»˜æ¬¾</span>',
        'awaiting_payment': '<span class="tag tag-wait">å¾…ç¢ºèª</span>',
        'awaiting_service': '<span class="tag tag-ota">æœå‹™ä¸­</span>',
        'completed': '<span class="tag" style="background:#333">å·²çµæ¡ˆ</span>'
    };

    // 3. åˆå§‹åŒ– Quill ç·¨è¼¯å™¨ (ç§»é™¤ä¸ç©©å®šçš„è¡¨æ ¼å¤–æ›ï¼Œä¿ä½è³‡æ–™)
    // (A) è¨»å†Šåœ–ç‰‡å¤–æ›
    const BaseImage = Quill.import('formats/image');
    class CustomImage extends BaseImage {
        static formats(domNode) { return ['alt', 'height', 'width', 'style'].reduce((f, a) => { if (domNode.hasAttribute(a)) f[a] = domNode.getAttribute(a); return f; }, {}); }
        format(name, value) { if (['alt', 'height', 'width', 'style'].indexOf(name) > -1) { if (value) this.domNode.setAttribute(name, value); else this.domNode.removeAttribute(name); } else super.format(name, value); }
    }
    Quill.register({ 'formats/image': CustomImage }, true);
    
    // (B) è¨»å†Šå­—é«”
    var Font = Quill.import('formats/font');
    Font.whitelist = ['serif', 'sans-serif', 'monospace'];
    Quill.register(Font, true);

   // (C) è¨»å†Šè¡¨æ ¼å¤–æ› (é˜²å‘†)
    if (window.QuillBetterTable) {
        Quill.register({ 'modules/better-table': window.QuillBetterTable }, true);
    }

    // ğŸ”¥ å…¨åŸŸè®Šæ•¸ï¼šå„²å­˜æ ¼å¼åˆ·ç‹€æ…‹
    var painterFormat = null; // å­˜æ ¼å¼
    var isPainterOn = false;  // å­˜é–‹é—œç‹€æ…‹

    // (D) å•Ÿå‹•ç·¨è¼¯å™¨ (V71ï¼šå­—å‹+å¤§å°+æ ¼å¼åˆ·+æ’ç‰ˆå·¥å…· å…¨é–‹ç‰ˆ)
    var quill = new Quill('#editor', {
        theme: 'snow',
        modules: { 
            imageResize: { displaySize: true }, 
            table: false, 
            'better-table': window.QuillBetterTable ? {
                operationMenu: { items: { unmergeCells: { text: 'å–æ¶ˆåˆä½µ' } }, color: { text: 'èƒŒæ™¯é¡è‰²' } }
            } : null,
            keyboard: { 
                bindings: Object.assign({}, 
                    (window.QuillBetterTable ? window.QuillBetterTable.keyboardBindings : {}), 
                    {
                        'linebreak': {
                            key: 13,
                            shiftKey: true,
                            handler: function() {
                                const range = this.quill.getSelection();
                                if (range) {
                                    this.quill.insertText(range.index, '\n');
                                    this.quill.setSelection(range.index + 1);
                                }
                                return false; 
                            }
                        },
                        'exitPainter': {
                            key: 27, // ESC é€€å‡ºæ ¼å¼åˆ·
                            handler: function() {
                                turnOffPainter();
                                return true;
                            }
                        }
                    }
                )
            },
            toolbar: {
                container: [
                    // ğŸ‘‡ğŸ‘‡ğŸ‘‡ é€™è£¡ï¼æŠŠéºå¤±çš„å­—å‹èˆ‡å¤§å°åŠ å›ä¾†äº† ğŸ‘‡ğŸ‘‡ğŸ‘‡
                    [{ 'font': [] }, { 'size': ['small', false, 'large', 'huge'] }], 
                    
                    [{ 'header': [1, 2, 3, false] }], 
                    ['bold', 'italic', 'underline', 'strike'], 
                    [{ 'color': [] }, { 'background': [] }], 
                    
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }], 
                    [{ 'indent': '-1'}, { 'indent': '+1' }], 
                    [{ 'align': [] }], 
                    ['blockquote'], 

                    ['format-painter'], // æ ¼å¼åˆ·

                    ['link', 'image'], 
                    window.QuillBetterTable ? ['table-btn'] : [], 
                    ['clean']
                ],
                handlers: {
                    'table-btn': function() {
                        if(window.QuillBetterTable) this.quill.getModule('better-table').insertTable(3, 3);
                    },
                    'format-painter': function() {
                        if (isPainterOn) {
                            turnOffPainter();
                        } else {
                            var range = this.quill.getSelection();
                            if (range) {
                                painterFormat = this.quill.getFormat(range);
                                isPainterOn = true;
                                document.querySelector('.ql-editor').classList.add('painter-active');
                                document.querySelector('.ql-format-painter').classList.add('active');
                            }
                        }
                    }
                }
            }
        },
        placeholder: 'åœ¨æ­¤è¼¸å…¥å…§å®¹...'
    });

    // é—œé–‰æ ¼å¼åˆ·çš„å‡½å¼
    function turnOffPainter() {
        isPainterOn = false;
        painterFormat = null;
        document.querySelector('.ql-editor').classList.remove('painter-active');
        document.querySelector('.ql-format-painter').classList.remove('active');
    }

    // ğŸ”¥ ç›£è½ï¼šæ»‘é¼ é¸å­—æ™‚ï¼Œå¦‚æœåˆ·å­æ˜¯é–‹çš„ï¼Œå°±ç˜‹ç‹‚å¥—ç”¨æ ¼å¼
    quill.on('selection-change', function(range, oldRange, source) {
        if (source === 'user' && range && range.length > 0 && isPainterOn && painterFormat) {
            // å¥—ç”¨æ ¼å¼
            for (let format in painterFormat) {
                quill.formatText(range.index, range.length, format, painterFormat[format]);
            }
            // âš ï¸ é€™è£¡æ‹¿æ‰äº†ã€Œé—œé–‰ã€çš„ç¨‹å¼ç¢¼ï¼Œæ‰€ä»¥å®ƒæœƒä¸€ç›´é–‹è‘—ï¼Œç›´åˆ°æ‚¨æ‰‹å‹•é—œæ‰
        }
    });

    // è£œä¸Šåœ–ç¤º
    setTimeout(() => {
        if(window.QuillBetterTable) {
            const btn = document.querySelector('.ql-table-btn');
            if(btn) btn.innerHTML = '<i class="fa-solid fa-table"></i>';
        }
        const painterBtn = document.querySelector('.ql-format-painter');
        if(painterBtn) {
            painterBtn.innerHTML = '<i class="fa-solid fa-paint-roller"></i>';
            painterBtn.title = "æ ¼å¼åˆ· (é»ä¸€ä¸‹é–å®šï¼Œå†é»ä¸€ä¸‹è§£é™¤)";
        }
    }, 100);


    // ğŸŒŸ 4. æ ¸å¿ƒè®€å–å‡½å¼ (select * ä¿è­‰è®€å– body)
    async function fetchAll() {
        try {
            console.log("ğŸš€ æ­£åœ¨è®€å–è³‡æ–™...");

            // (A) è®€å–æ–‡ç«  (å„ªå…ˆ sort_order)
            let ar = await myDB.from('kb_articles').select('*').order('sort_order');
            
            if (ar.error) {
                console.warn("âš ï¸ æ’åºè®€å–å¤±æ•—ï¼Œåˆ‡æ›èˆŠæ¨¡å¼...", ar.error.message);
                ar = await myDB.from('kb_articles').select('*').order('created_at', {ascending:false});
            }

            // (B) è®€å–å…¶ä»–è³‡æ–™
            const [b, p, c, s, sl, o, cp, cfg] = await Promise.all([
                myDB.from('bookings').select('*').order('created_at', {ascending:false}).limit(100),
                myDB.from('profiles').select('*').order('created_at', {ascending:false}),
                myDB.from('service_categories').select('*').order('created_at'),
                myDB.from('services').select('*').order('sort_order'),
                myDB.from('schedule_slots').select('*').order('slot_date').order('slot_time'),
                myDB.from('ota_settings').select('*'),
                myDB.from('coupons').select('*').order('created_at', {ascending:false}),
                myDB.from('site_content').select('content').eq('title', 'kb_category_order').single()
            ]);

            const bookingsWithProfile = (b.data || []).map(bk => {
                const profile = (p.data || []).find(pr => pr.id === bk.user_id);
                return { ...bk, profiles: profile || null };
            });

            // (C) å¯«å…¥å¿«å–
            cache = { 
                bks: bookingsWithProfile, pros: p.data||[], cats: c.data||[], 
                svcs: s.data||[], slots: sl.data||[], otas: o.data||[], 
                coupons: cp.data||[], 
                articles: ar.data||[] 
            };

            // (D) åˆ†é¡æ’åº
            if (cfg.data && cfg.data.content) { kbCatOrder = cfg.data.content; }
            else { kbCatOrder = { big: [], mid: {} }; }
            if(typeof syncKbOrderKeys === 'function') syncKbOrderKeys();

            // (E) æ¸²æŸ“ç•«é¢
            renderBks(); 
            renderPro(); 
            renderConfigTables(); 
            renderCalendar(); 
            renderFinance(); 
            
            if(typeof renderKbTree === 'function') renderKbTree(); 
            if(typeof render7DaySchedule === 'function') render7DaySchedule();
            
            console.log("âœ… è³‡æ–™è®€å–æˆåŠŸï¼");

        } catch (e) { console.error(e); alert("è¼‰å…¥å¤±æ•—: " + e.message); }
    }

    // ğŸ”’ ç™»å…¥é©—è­‰
    async function checkAdmin() {
        const pwd = document.getElementById('admin-pwd').value;
        const btn = document.querySelector('#admin-lock button');
        
        if(pwd === "admin888") { 
            btn.innerText = "è®€å–ä¸­...";
            btn.disabled = true;
            try {
                await fetchAll(); 
                document.getElementById('admin-lock').style.display = 'none';
                document.querySelector('.main').style.display = 'block';
                renderTimeGrid();
            } catch (e) {
                alert("è¼‰å…¥å¤±æ•—ï¼š" + e.message);
                btn.innerText = "é€²å…¥ç³»çµ±";
                btn.disabled = false;
            }
        } else { 
            alert("å¯†ç¢¼éŒ¯èª¤"); 
        }
    }

    // ================= éºå¤±çš„é—œéµå‡½å¼ (renderBks) =================
    
    function renderBks() {
        const search = document.getElementById('search-key').value.trim().toUpperCase();
        document.getElementById('bk-list').innerHTML = cache.bks.filter(x => 
            !search || JSON.stringify(x).toUpperCase().includes(search)
        ).map(x => {
            const hasPro = !!x.profiles;
            
            let otaTag = '';
            if (x.ota_order_id) {
                const otaName = cache.otas.find(o => o.code === x.ota_source)?.name || 'OTA';
                otaTag = `<br><span class="tag tag-ota">${otaName} #${x.ota_order_id.slice(-5)}</span>`;
            } else if (x.payment_method === 'shopee') otaTag = `<br><span class="tag tag-ota">è¦çš®(èˆŠ)</span>`;

            let userHtml = hasPro ? `<b>${x.profiles.full_name}</b><br><small>${x.profiles.phone}</small>` :
                           `<b>${x.temp_phone}</b><br><button class="btn btn-info" style="font-size:10px;padding:2px;" onclick="openCreateMemberModal('${x.temp_phone}', '${x.id}')">ï¼‹å»ºç«‹</button>`;

            return `<tr>
                <td><small>${x.created_at.slice(0,10)}</small><br><small>${x.booking_id.slice(-6)}</small>${otaTag}</td>
                <td>${userHtml}</td>
                <td><small>${x.service_item}</small></td>
                <td>$${x.price}</td>
                <td>${STATUS_MAP[x.status] || x.status}</td>
                <td><button class="btn btn-forest" onclick="openBooking('${x.id}')">è©³æƒ…</button><button class="btn btn-danger" onclick="deleteBooking('${x.id}')" style="padding:2px 8px;">åˆª</button></td>
            </tr>`;
        }).join('');

        const m = new Date().toISOString().slice(0, 7);
        const inc = cache.bks.filter(x => x.status === 'paid' && x.created_at.startsWith(m)).reduce((s, x) => s + (x.price || 0), 0);
        if(document.getElementById('inc-val')) document.getElementById('inc-val').innerText = "$" + inc.toLocaleString();
        if(document.getElementById('total-val')) document.getElementById('total-val').innerText = cache.pros.length;
    }

    function openCreateMemberModal(phone, bookingId) {
        alert(`å»ºç«‹æœƒå“¡åŠŸèƒ½ (æ‰‹æ©Ÿ: ${phone}) \nè«‹ç¢ºèªæ˜¯å¦éœ€è¦æ­¤åŠŸèƒ½çš„å®Œæ•´ä»£ç¢¼ï¼Ÿ`);
    }

    // ğŸŒŸ 4. é ç´„é¸å–®å„ªåŒ– (V48 ç¾åŒ–ç‰ˆ)
    function openBooking(id) {
        const b = cache.bks.find(x => x.id === id);
        if(!b) return alert("æ‰¾ä¸åˆ°è¨‚å–®");
        
        try {
            const rawDetail = b.wish_detail || '';
            const cleanDetail = rawDetail.replace(/\| \[ä»˜æ¬¾ç¢¼.*?\]/g, '').replace(/\| \[QRå·²å‚³.*?\]/g, '');
            const urlMatch = cleanDetail.match(/(https?:\/\/[^\s|]+)/); 
            const screenshotUrl = urlMatch ? urlMatch[0] : null;
            const screenshotBtn = screenshotUrl 
                ? `<a href="${screenshotUrl}" target="_blank" class="btn btn-outline" style="color:#3498db; border-color:#3498db;">ğŸ–¼ï¸ æŸ¥çœ‹æˆªåœ–è­‰æ“š</a>` 
                : `<span style="color:#999; font-size:12px;">(ç„¡æˆªåœ–)</span>`;
            
            let displayData = cleanDetail.replace(/(https?:\/\/[^\s|]+)/g, '').replace(/æˆªåœ–[:ï¼š]\s*/g, '').replace(/\|? ?å§“å:.*? \|/g, '').replace(/\|? ?Email:.*? \|/g, '').replace(/\|? ?æ•¸æ“š: ?/g, '').trim();
            let extractName = "æœªçŸ¥", extractEmail = "æœªçŸ¥";
            const nm = rawDetail.match(/å§“å:(.*?) \|/);
            const em = rawDetail.match(/Email:(.*?) \|/);
            if(nm) extractName = nm[1].trim(); 
            if(em) extractEmail = em[1].trim();

            const mainService = (cache.svcs || []).find(s => s.is_main && (b.service_detail||'').includes(s.title));
            let btnLabel = "ğŸ“„ ç”Ÿæˆæœå‹™å ±å‘Š", btnClass = "btn-forest";
            let reportTemplate = (mainService && mainService.report_template) ? mainService.report_template : "srt_report.html";
            
            const reportMatch = rawDetail.match(/\[å ±å‘Šå·²ç”Ÿæˆ ID:(.*?)\]/);
            const existingReportId = reportMatch ? reportMatch[1] : null;
            
            let reportUrl = existingReportId ? `${reportTemplate}?id=${existingReportId}` : `${reportTemplate}?bid=${b.id}&name=${encodeURIComponent(extractName)}&phone=${b.temp_phone}`;
            if(existingReportId) { btnLabel = "ğŸ“„ æŸ¥çœ‹/ä¿®æ”¹å ±å‘Š"; btnClass = "btn-purple"; }

            const couponBadge = b.coupon_info ? `<div style="display:inline-block; background:#fce4ec; color:#c2185b; font-size:12px; padding:2px 8px; border-radius:10px; margin-top:5px;">ğŸŸï¸ ${b.coupon_info}</div>` : '';

            let scheduleBox = '';
            if(b.scheduled_at) {
                scheduleBox = `<div style="background:#f0f8ff; padding:12px; border-left:4px solid #3498db; border-radius:4px; margin-top:15px;"><div style="display:flex; justify-content:space-between; align-items:center;"><strong style="color:#2980b9;">ğŸ“… å·²é–å®šæœå‹™æ’ç¨‹</strong><button class="btn btn-outline" style="font-size:12px; background:white;" onclick="document.getElementById('reschedule-area').style.display='block'; this.style.display='none';">âœï¸ ä¿®æ”¹</button></div><div style="font-size:1.2rem; color:#2c3e50; margin-top:5px; font-weight:bold;">${new Date(b.scheduled_at).toLocaleString()}</div><div id="reschedule-area" style="display:none; margin-top:10px;"><div style="display:flex; gap:10px;"><input type="date" id="book-date" onchange="loadSlotsForBooking(this.value)"><select id="book-slot"><option>å…ˆé¸æ—¥æœŸ</option></select></div><button class="btn btn-purple" style="width:100%; margin-top:5px;" onclick="confirmSchedule('${b.id}')">ç¢ºèªè®Šæ›´</button></div></div>`;
            } else if(b.status === 'paid' || b.status === 'awaiting_service') {
                scheduleBox = `<div style="background:#fff3e0; padding:12px; border-left:4px solid #f39c12; border-radius:4px; margin-top:15px;"><strong style="color:#e67e22;">â³ ç­‰å¾…æ’ç¨‹</strong><div style="display:flex; gap:10px; margin-top:5px;"><input type="date" id="book-date" onchange="loadSlotsForBooking(this.value)"><select id="book-slot"><option>å…ˆé¸æ—¥æœŸ</option></select></div><button class="btn btn-purple" style="width:100%; margin-top:5px;" onclick="confirmSchedule('${b.id}')">ç¢ºèªé–å®šæ™‚æ®µ</button></div>`;
            }

            const reportArea = (b.status === 'awaiting_service' || b.status === 'completed') ? `<div style="margin-top:20px; padding-top:10px; border-top:1px dashed #eee;"><a href="${reportUrl}" target="_blank" class="btn ${btnClass}" style="display:block; width:100%; text-align:center;">${btnLabel}</a></div>` : '';

            document.getElementById('m-title').innerHTML = `è¨‚å–®è©³æƒ… <span style="font-size:12px; color:#999;">${b.booking_id}</span>`;
            document.getElementById('m-content').innerHTML = `
                <div style="display:flex; gap:15px; align-items:center; margin-bottom:15px;"><div style="width:50px; height:50px; background:var(--forest); color:white; border-radius:50%; display:flex; justify-content:center; align-items:center; font-size:20px; font-weight:bold;">${extractName[0]}</div><div><div style="font-weight:bold; font-size:1.1rem;">${extractName}</div><div style="color:#666;">${b.temp_phone}</div><div style="color:#888; font-size:0.8rem;">${extractEmail}</div></div></div>
                <div style="background:#fafafa; padding:15px; border-radius:8px; border:1px solid #eee;"><div style="display:flex; justify-content:space-between;"><b>${b.service_item}</b><b style="color:#d35400;">$${b.price}</b></div><div style="color:#666; font-size:0.9rem;">${b.service_detail}</div>${couponBadge}</div>
                <div style="margin-top:15px; padding:10px; background:white; border:1px solid #eee; border-radius:4px;"><label style="color:#999; font-size:12px;">å‚™è¨» / è¨±é¡˜</label><div style="margin-top:5px; line-height:1.5;">${displayData || 'ç„¡'}</div><div style="margin-top:5px; font-weight:bold; color:#e67e22;">è¨±é¡˜ï¼š${b.sleep_time || 'ç„¡'}</div><div style="margin-top:10px; padding-top:5px; border-top:1px dashed #eee;">${screenshotBtn}</div></div>
                ${scheduleBox}${reportArea}
                <div style="margin-top:20px; text-align:right;">${renderActionButtons(b)}</div>`;
            document.getElementById('modal').style.display = 'flex';
        } catch (e) { console.error(e); alert("è©³æƒ…é–‹å•Ÿå¤±æ•—: " + e.message); }
    }

    // ================= KB åŠŸèƒ½ (ä¿®å¾©ç·¨è¼¯åŠŸèƒ½) =================
    
    function toggleKbSidebar() { document.querySelector('.kb-layout').classList.toggle('collapsed'); }

    // ğŸ”¥ ç·¨è¼¯æ–‡ç«  (ä¿®å¾©ç‰ˆ)
    async function editKb(id) {
        try {
            const {data, error} = await myDB.from('kb_articles').select('*').eq('id',id).single();
            if(error || !data) { alert("è®€å–å¤±æ•—"); return; }
            document.getElementById('kb-id').value = data.id;
            document.getElementById('kb-title').value = data.title;
            document.getElementById('kb-big').value = data.big_category;
            document.getElementById('kb-mid').value = data.mid_category;
            document.getElementById('kb-pub').checked = data.is_published;
            if(quill) { quill.root.innerHTML = data.body || ''; }
            document.getElementById('btn-kb-del').style.display = 'inline-block';
            document.getElementById('mode-title').innerText = "ç·¨è¼¯æ–‡ç« ";
        } catch (e) { console.error(e); alert("é–‹å•Ÿæ–‡ç« å¤±æ•—: " + e.message); }
    }

    function resetKbForm(){ document.getElementById('kb-id').value=''; document.getElementById('kb-title').value=''; document.getElementById('kb-big').value=''; document.getElementById('kb-mid').value=''; if(quill) quill.root.innerHTML=''; document.getElementById('btn-kb-del').style.display='none'; document.getElementById('mode-title').innerText="æ–°å¢æ–‡ç« "; }
    async function saveArticle(){ const p={title:document.getElementById('kb-title').value,big_category:document.getElementById('kb-big').value,mid_category:document.getElementById('kb-mid').value,is_published:document.getElementById('kb-pub').checked,body:quill ? quill.root.innerHTML : ''}; const id=document.getElementById('kb-id').value; if(!p.title || !p.big_category){alert("æ¨™é¡Œ/åˆ†é¡å¿…å¡«");return;} try { if(id) await myDB.from('kb_articles').update(p).eq('id',id); else { const {data}=await myDB.from('kb_articles').select('sort_order').order('sort_order',{ascending:false}).limit(1); p.sort_order=(data&&data.length)?data[0].sort_order+1:1; await myDB.from('kb_articles').insert([p]); } alert("âœ… å·²å„²å­˜"); fetchAll(); if(!id)resetKbForm(); } catch(e){ alert("å„²å­˜å¤±æ•—: " + e.message); } }
    async function delArticle(){ if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { await myDB.from('kb_articles').delete().eq('id',document.getElementById('kb-id').value); alert("å·²åˆªé™¤"); resetKbForm(); fetchAll(); } }
    function previewArticle() { const title=document.getElementById('kb-title').value, html=quill ? quill.root.innerHTML : '', isPub=document.getElementById('kb-pub').checked; document.getElementById('m-title').innerText="å‰å°é è¦½"; document.getElementById('m-content').innerHTML=`<div style="font-family:sans-serif;padding:10px;">${!isPub?'<div style="color:red">(éš±è—)</div>':''}<h1>${title}</h1><div class="ql-editor" style="padding:0;">${html}</div></div>`; document.getElementById('modal').style.display='flex'; }

    // åœ–åº«
    async function openGallery(){document.getElementById('gallery-modal').style.display='flex';loadGalleryImages();}
    function closeGallery(){document.getElementById('gallery-modal').style.display='none';}
    function switchBucket(){currentBucket=document.getElementById('bucket-select').value;loadGalleryImages();}
    async function loadGalleryImages(){const g=document.getElementById('gallery-content');g.innerHTML="è®€å–ä¸­...";const{data}=await myDB.storage.from(currentBucket).list('',{limit:100,sortBy:{column:'created_at',order:'desc'}});if(!data){g.innerHTML="å¤±æ•—";return;}g.innerHTML=data.map(f=>{if(f.name==='.emptyFolderPlaceholder')return'';const u=myDB.storage.from(currentBucket).getPublicUrl(f.name).data.publicUrl;return `<div class="gallery-item" onclick="insertImageToEditor('${u}')"><img src="${u}"><div class="gallery-item-name">${f.name}</div></div>`;}).join('');}
    function insertImageToEditor(u){if(quill){const r=quill.getSelection(true);quill.insertEmbed(r?r.index:quill.getLength(),'image',u);}closeGallery();}
    async function uploadImage(){const f=document.getElementById('upload-input').files[0];if(!f)return;await myDB.storage.from(currentBucket).upload(`${Date.now()}_${f.name}`,f);loadGalleryImages();}

    // ğŸ”¥ æ’åº (è®Šæ•¸åä¿®æ­£ complete)
    function syncKbOrderKeys(){let c=false;const ct={};cache.articles.forEach(a=>{if(!ct[a.big_category])ct[a.big_category]=new Set();ct[a.big_category].add(a.mid_category);});Object.keys(ct).forEach(b=>{if(!kbCatOrder.big.includes(b)){kbCatOrder.big.push(b);c=true;}});Object.keys(ct).forEach(b=>{if(!kbCatOrder.mid[b])kbCatOrder.mid[b]=[];[...ct[b]].forEach(m=>{if(!kbCatOrder.mid[b].includes(m)){kbCatOrder.mid[b].push(m);c=true;}});});if(c)saveKbOrderConfig();}
    
    function renderKbTree(){
        const t={};
        cache.articles.forEach(a=>{if(!t[a.big_category])t[a.big_category]={};if(!t[a.big_category][a.mid_category])t[a.big_category][a.mid_category]=[];t[a.big_category][a.mid_category].push(a);});
        
        document.getElementById('kb-tree').innerHTML=kbCatOrder.big.filter(b=>t[b]).map(b=>{
            const ms=(kbCatOrder.mid[b]||[]).filter(m=>t[b][m]).map(m=>{
                const as=t[b][m].map(a=>`<div class="article-item ${a.is_published?'':'draft'}"><div class="sort-actions"><button class="btn-sort-arrow" onclick="moveArt('${a.id}',-1,event)">â–²</button><button class="btn-sort-arrow" onclick="moveArt('${a.id}',1,event)">â–¼</button></div><span class="article-title-span" onclick="editKb('${a.id}')">ğŸ“„ ${a.title}</span></div>`).join('');
                return`<details class="mid-cat" open><summary><div class="sort-actions"><button class="btn-sort-arrow" onclick="moveMid('${b}','${m}',-1,event)">â–²</button><button class="btn-sort-arrow" onclick="moveMid('${b}','${m}',1,event)">â–¼</button></div>â”” ${m}</summary>${as}</details>`;
            }).join('');
            return`<details class="big-cat" open><summary><div class="sort-actions"><button class="btn-sort-arrow" onclick="moveBig('${b}',-1,event)">â–²</button><button class="btn-sort-arrow" onclick="moveBig('${b}',1,event)">â–¼</button></div>ğŸ“‚ ${b}</summary>${ms}</details>`;
        }).join('');
        
        document.getElementById('kb-big-list').innerHTML=kbCatOrder.big.map(v=>`<option value="${v}">`).join('');
        
        // ğŸ”¥ è®Šæ•¸åä¿®æ­£ï¼šä½¿ç”¨ allMids è€Œä¸æ˜¯ am
        const allMids = new Set(); 
        Object.values(kbCatOrder.mid).forEach(a=>a.forEach(m=>allMids.add(m)));
        document.getElementById('kb-mid-list').innerHTML=[...allMids].map(v=>`<option value="${v}">`).join('');
    }

    async function moveBig(n,d,e){e.stopPropagation();const i=kbCatOrder.big.indexOf(n);if(i===-1||i+d<0||i+d>=kbCatOrder.big.length)return;[kbCatOrder.big[i],kbCatOrder.big[i+d]]=[kbCatOrder.big[i+d],kbCatOrder.big[i]];renderKbTree();await saveKbOrderConfig();}
    async function moveMid(b,n,d,e){e.stopPropagation();const i=kbCatOrder.mid[b].indexOf(n);if(i===-1||i+d<0||i+d>=kbCatOrder.mid[b].length)return;[kbCatOrder.mid[b][i],kbCatOrder.mid[b][i+d]]=[kbCatOrder.mid[b][i+d],kbCatOrder.mid[b][i]];renderKbTree();await saveKbOrderConfig();}
// ğŸ”¥ ä¿®å¾©ç‰ˆï¼šæ–‡ç« æ’åº (è£œä¸Šå¿…å¡«æ¬„ä½ï¼Œè§£æ±º SQL å ±éŒ¯)
    async function moveArt(id, dir, e) {
        e.stopPropagation();
        
        // 1. æ‰¾åˆ°ç›®æ¨™æ–‡ç« 
        const art = cache.articles.find(a => a.id === id);
        if (!art) return;

        // 2. æ‰¾å‡ºåŒåˆ†é¡çš„æ‰€æœ‰å…„å¼Ÿæ–‡ç« 
        const siblings = cache.articles.filter(a => 
            a.big_category === art.big_category && 
            a.mid_category === art.mid_category
        );

        // 3. æ‰¾åˆ°è‡ªå·±åœ¨å…„å¼Ÿä¸­çš„ä½ç½®
        const idx = siblings.findIndex(a => a.id === id);
        
        // é˜²å‘†
        if (idx === -1 || idx + dir < 0 || idx + dir >= siblings.length) return;

        // 4. äº¤æ›ä½ç½®
        const temp = siblings[idx];
        siblings[idx] = siblings[idx + dir];
        siblings[idx + dir] = temp;

        // 5. ğŸ”¥ é—œéµä¿®å¾©ï¼šé™¤äº† sort_orderï¼ŒæŠŠå¿…å¡«æ¬„ä½ä¹Ÿå¸¶ä¸Šï¼
        // é€™æ¨£ Supabase å°±ä¸æœƒå› ç‚ºã€Œç¼ºå°‘å¿…å¡«æ¬„ä½ã€è€Œå ±éŒ¯äº†
        const updates = siblings.map((a, index) => {
            a.sort_order = index; // æ›´æ–°å¿«å–
            return { 
                id: a.id, 
                sort_order: index,
                // ğŸ‘‡ é€™ä¸‰è¡Œæ˜¯ç‚ºäº†å®‰æ’«è³‡æ–™åº«çš„æª¢æŸ¥æ©Ÿåˆ¶ ğŸ‘‡
                title: a.title,
                big_category: a.big_category,
                mid_category: a.mid_category
            }; 
        });

        // 6. æ›´æ–°å¿«å–æ’åº
        cache.articles.sort((a, b) => a.sort_order - b.sort_order);

        // 7. æ¸²æŸ“
        renderKbTree();

        // 8. å¯«å…¥è³‡æ–™åº«
        try {
            const { error } = await myDB.from('kb_articles').upsert(updates, { onConflict: 'id' });
            if (error) throw error;
            console.log("âœ… æ’åºå·²æ›´æ–°");
        } catch (err) {
            console.error(err);
            alert("æ’åºå„²å­˜å¤±æ•—: " + err.message);
        }
    }    async function saveKbOrderConfig(){const{data}=await myDB.from('site_content').select('id').eq('title','kb_category_order').single();if(data)await myDB.from('site_content').update({content:kbCatOrder}).eq('id',data.id);else await myDB.from('site_content').insert([{category:'system_config',title:'kb_category_order',content:kbCatOrder}]);}

    // å…¶ä»–åŸæœ‰åŠŸèƒ½
    function loadSlotsForBooking(date) { const slots = cache.slots.filter(s => s.slot_date === date && !s.is_booked); const sel = document.getElementById('book-slot'); sel.innerHTML = slots.length ? slots.map(s => `<option value="${s.id}" data-t="${s.slot_date} ${s.slot_time}">${s.slot_time.slice(0,5)}</option>`).join('') : '<option>ç„¡ç©ºæª”</option>'; }
    async function confirmSchedule(bid) { const sel = document.getElementById('book-slot'); if(!sel.value || sel.value.includes("å…ˆé¸")) return alert("è«‹é¸æ“‡æ™‚æ®µ"); const t = sel.options[sel.selectedIndex].dataset.t; await myDB.from('bookings').update({scheduled_at: t, status: 'awaiting_service'}).eq('id', bid); await myDB.from('schedule_slots').update({is_booked: true}).eq('id', sel.value); alert("âœ… æ’ç¨‹æˆåŠŸ"); closeModal(); fetchAll(); }
    async function deleteBooking(id) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { await myDB.from('bookings').delete().eq('id',id); fetchAll(); } }
    async function sendPayLink(id) { if(confirm("ç¢ºå®šç™¼é€ï¼Ÿ")) { const t = new Date().toLocaleString(); await myDB.from('bookings').update({ status: 'awaiting_payment', wish_detail: `${cache.bks.find(x=>x.id===id).wish_detail} | [QRå·²å‚³: ${t}]` }).eq('id', id); alert("OK"); closeModal(); fetchAll(); } }
    function renderActionButtons(b) { if (b.status === 'paid') return `<button class="btn" style="background:#ccc;">å¾…æ’ç¨‹</button>`; if (b.status === 'awaiting_service') return `<button class="btn btn-forest" onclick="updateS('${b.id}','completed')">âœ… çµæ¡ˆ</button>`; if (b.status === 'completed') return `<button class="btn" style="background:#ccc;">å·²çµæ¡ˆ</button>`; if (b.status === 'pending') return `<button class="btn btn-info" onclick="sendPayLink('${b.id}')">ğŸ“§ å‚³ä»˜æ¬¾ç¢¼</button>`; if (b.status === 'awaiting_payment' || b.payment_method === 'shopee' || b.ota_order_id) return `<button class="btn btn-success" onclick="updateS('${b.id}','paid')">ğŸ’° ç¢ºèªå…¥å¸³</button>`; return ""; }
    
    // ğŸ”¥ CRM: è£œå›æ­·å²èˆ‡åˆªé™¤æŒ‰éˆ• ğŸ”¥
    function renderPro() { 
        const k = document.getElementById('search-member').value.toLowerCase(); 
        document.getElementById('pro-list').innerHTML = cache.pros.filter(p => !k || (p.full_name && p.full_name.includes(k)) || p.phone.includes(k)).map(p => { 
            const ub = cache.bks.filter(b => b.user_id === p.id || cleanPhone(b.temp_phone) === cleanPhone(p.phone)); 
            const t = ub.filter(b => b.status === 'paid' || b.status === 'completed').reduce((s, b) => s + (b.price || 0), 0); 
            return `<tr>
                <td><b>${p.full_name}</b></td>
                <td>${p.phone}</td>
                <td><small>${p.email||'-'}</small></td>
                <td style="color:#d35400;">$${t.toLocaleString()}</td>
                <td>${ub.length?ub[0].created_at.slice(0,10):'-'}</td>
                <td>
                    <button class="btn btn-forest" onclick="showHistory('${p.id}', '${p.full_name}')">ğŸ“œ</button>
                    <button class="btn btn-warning" onclick="editProfile('${p.id}')">âœï¸</button>
                    <button class="btn btn-danger" onclick="deleteMember('${p.id}', '${p.full_name}')">ğŸ—‘ï¸</button>
                </td>
            </tr>`; 
        }).join(''); 
    }
    
    function editProfile(uid) { const p = cache.pros.find(x => x.id === uid); document.getElementById('m-title').innerText = "ç·¨è¼¯æœƒå“¡"; document.getElementById('m-content').innerHTML = `<label>å§“å</label><input id="ep-n" value="${p.full_name}" style="margin-bottom:10px;"><label>æ‰‹æ©Ÿ</label><input id="ep-p" value="${p.phone}" style="margin-bottom:10px;"><label>Email</label><input id="ep-e" value="${p.email||''}" style="margin-bottom:15px;"><div style="display:flex; gap:10px;"><button class="btn btn-success" style="flex:1;" onclick="updPro('${p.id}')">ğŸ’¾ å„²å­˜è®Šæ›´</button><button class="btn btn-danger" style="flex:1;" onclick="resetMemberPassword('${p.id}', '${p.phone}')">ğŸ”‘ é‡ç½®å¯†ç¢¼</button></div>`; document.getElementById('modal').style.display = 'flex'; }
    async function updPro(id) { await myDB.from('profiles').update({ full_name: document.getElementById('ep-n').value, phone: document.getElementById('ep-p').value, email: document.getElementById('ep-e').value }).eq('id', id); closeModal(); fetchAll(); alert("âœ… æ›´æ–°æˆåŠŸ"); }
    async function resetMemberPassword(uid, phone) { if(!confirm(`ç¢ºå®šè¦é‡ç½®å¯†ç¢¼å—ï¼Ÿ\né è¨­ç‚ºï¼šguest${phone.slice(-4)}`)) return; const newPw = 'guest' + phone.slice(-4); const { error } = await myDB.from('profiles').update({ password: newPw }).eq('id', uid); if(error) alert("å¤±æ•—: " + error.message); else alert("âœ… å¯†ç¢¼å·²é‡ç½®"); }
    async function deleteMember(uid, name) { if(confirm(`âš ï¸ ç¢ºå®šåˆªé™¤æœƒå“¡ ${name}ï¼Ÿ`)) { await myDB.from('profiles').delete().eq('id', uid); fetchAll(); } }
    function showHistory(uid, name) { const p = cache.pros.find(x => x.id === uid); const userBks = cache.bks.filter(b => b.user_id === uid || cleanPhone(b.temp_phone) === cleanPhone(p.phone)); let html = userBks.length === 0 ? "<p style='color:#999; text-align:center;'>ç„¡è¨‚å–®ç´€éŒ„</p>" : userBks.map(b => ` <div onclick="openBooking('${b.id}')" class="history-card"> <div style="display:flex; justify-content:space-between;"> <b style="color:var(--forest);">${b.service_item}</b> ${STATUS_MAP[b.status] || b.status} </div> <div style="font-size:12px; color:#666; margin-top:5px;">${b.created_at.slice(0,10)} | $${b.price}</div> </div> `).join(''); document.getElementById('m-title').innerText = `${name} çš„æ­·å²è¨‚å–®`; document.getElementById('m-content').innerHTML = `<div style="max-height:400px; overflow-y:auto;">${html}</div>`; document.getElementById('modal').style.display = 'flex'; }

    // ğŸ”¥ Finance: è£œå› OTA åˆªé™¤æŒ‰éˆ• ğŸ”¥
    function renderFinance() { 
        document.getElementById('ota-list').innerHTML = cache.otas.map(o => `<tr><td>${o.name}</td><td>${o.code}</td><td>${o.commission_rate}%</td><td>-</td><td><button class="btn btn-info" onclick="editOTA('${o.id}')">ä¿®</button><button class="btn btn-danger" onclick="delData('ota_settings', '${o.id}')">åˆª</button></td></tr>`).join(''); 
        document.getElementById('cp-list').innerHTML = cache.coupons.map(c => `<tr><td>${c.name}</td><td>${c.code}</td><td>${c.discount_value}</td><td>${c.expires_at||'ç„¡'}</td><td>-</td><td>${c.usage_count}</td><td><button class="btn btn-info" onclick="editCoupon('${c.id}')">ä¿®</button><button class="btn btn-danger" onclick="delData('coupons', '${c.id}')">åˆª</button></td></tr>`).join(''); 
    }

    function renderConfigTables(){ const s=document.getElementById('svc-cat-filter');s.innerHTML='<option value="">è«‹é¸å¤§é¡</option>'+cache.cats.map(c=>`<option value="${c.id}">${c.name}</option>`).join(''); document.getElementById('cat-list').innerHTML=cache.cats.map(c=>`<tr><td>${c.name}</td><td><button class="btn btn-outline" onclick="editCat('${c.id}')">âœï¸</button></td></tr>`).join(''); }
    
    // ğŸ”¥ Services: è£œå›æ’åºåŠŸèƒ½èˆ‡ç´°é …é¡¯ç¤º ğŸ”¥
    function filterServiceList(){ 
        const c=document.getElementById('svc-cat-filter').value; 
        document.getElementById('svc-list-container').innerHTML=cache.svcs.filter(s=>s.category_id===c).map((s,i)=>`
            <div class="admin-row">
                <div style="display:flex; flex-direction:column; margin-right:10px;">
                    <button class="btn btn-outline" style="padding:0 5px;" onclick="moveSvc('${s.id}',-1)">â–²</button>
                    <button class="btn btn-outline" style="padding:0 5px;" onclick="moveSvc('${s.id}',1)">â–¼</button>
                </div>
                <div style="flex:1">
                    <b>${s.title}</b> $${s.price} 
                    ${s.sub_options ? `<div style="font-size:12px; color:#666;">â”” ${s.sub_options}</div>` : ''}
                </div>
                <button class="btn btn-info" onclick="editSvc('${s.id}')">ä¿®</button>
                <button class="btn btn-danger" onclick="delData('services','${s.id}')">åˆª</button>
            </div>`).join(''); 
    }
    
    async function moveSvc(id, dir) {
        const c = document.getElementById('svc-cat-filter').value;
        const list = cache.svcs.filter(s => s.category_id === c);
        const idx = list.findIndex(s => s.id === id);
        if (idx === -1 || idx + dir < 0 || idx + dir >= list.length) return;
        const target = list[idx + dir];
        const temp = list[idx].sort_order;
        list[idx].sort_order = target.sort_order;
        target.sort_order = temp;
        await Promise.all([
            myDB.from('services').update({sort_order: list[idx].sort_order}).eq('id', list[idx].id),
            myDB.from('services').update({sort_order: target.sort_order}).eq('id', target.id)
        ]);
        fetchAll();
    }

    function renderTimeGrid(){let h='';for(let i=13;i<=25;i++){['00','30'].forEach(m=>{let hh=i>=24?i-24:i;let t=`${hh.toString().padStart(2,'0')}:${m}`;let v=`${i}:${m}`;h+=`<div class="batch-slot"><input type="checkbox" name="ts" value="${v}"> ${t}</div>`})}document.getElementById('time-grid').innerHTML=h;}
    function toggleAllSlots(c){document.querySelectorAll('input[name="ts"]').forEach(e=>e.checked=c);}
    async function batchAddSchedule(){const d1=document.getElementById('batch-start').value,d2=document.getElementById('batch-end').value||d1,ts=Array.from(document.querySelectorAll('input[name="ts"]:checked')).map(e=>e.value);if(!d1||!ts.length)return alert("é¸æ—¥æœŸæ™‚é–“");let ins=[],c=new Date(d1),e=new Date(d2);while(c<=e){const d=c.toISOString().split('T')[0];ts.forEach(t=>{let[hh,mm]=t.split(':').map(Number);let ad=new Date(c);if(hh>=24){ad.setDate(ad.getDate()+1);hh-=24;}ins.push({slot_date:ad.toISOString().split('T')[0],slot_time:`${hh.toString().padStart(2,'0')}:${mm}`})});c.setDate(c.getDate()+1);}await myDB.from('schedule_slots').insert(ins);alert("å·²ç”Ÿæˆ");fetchAll();}
    function renderCalendar(){const t=new Date();document.getElementById('cal-title').innerText=`${currentYear}/${currentMonth}`;const fd=new Date(currentYear,currentMonth-1,1).getDay(),dim=new Date(currentYear,currentMonth,0).getDate();let h='';for(let i=0;i<fd;i++)h+='<div class="cal-cell empty"></div>';for(let d=1;d<=dim;d++){const ds=`${currentYear}-${currentMonth.toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;const s=cache.slots.filter(x=>x.slot_date===ds);const f=s.filter(x=>!x.is_booked).length,bk=s.filter(x=>x.is_booked).length;h+=`<div class="cal-cell ${ds===selectedDateStr?'active':''}" onclick="selectDate('${ds}')"><div class="cal-date">${d}</div>${f?`<div class="dot-free">ğŸ”µ${f}</div>`:''}${bk?`<div class="dot-booked">ğŸ”´${bk}</div>`:''}</div>`}document.getElementById('calendar-body').innerHTML=h;}
    function changeMonth(o){currentMonth+=o;if(currentMonth>12){currentMonth=1;currentYear++}else if(currentMonth<1){currentMonth=12;currentYear--}renderCalendar();}
    function selectDate(d){selectedDateStr=d;renderCalendar();document.getElementById('detail-date-title').innerText=d;const s=cache.slots.filter(x=>x.slot_date===d).sort((a,b)=>a.slot_time.localeCompare(b.slot_time));document.getElementById('day-detail-container').innerHTML=s.map(x=>`<div class="compact-slot ${x.is_booked?'booked':'free'}">${x.slot_time.slice(0,5)} <span class="compact-del" onclick="delSlot('${x.id}')">Ã—</span></div>`).join('');}
    async function delSlot(id){if(confirm("åˆª?"))await myDB.from('schedule_slots').delete().eq('id',id);fetchAll();}
    function render7DaySchedule(){const t=new Date();let h='';for(let i=0;i<7;i++){const d=new Date(t);d.setDate(t.getDate()+i);const ds=d.toISOString().split('T')[0];const s=cache.slots.filter(x=>x.slot_date===ds).sort((a,b)=>a.slot_time.localeCompare(b.slot_time));if(s.length)h+=`<div class="upcoming-day"><div class="upcoming-day-header">${ds}</div><div class="upcoming-slots">${s.map(x=>`<span class="u-slot ${x.is_booked?'booked':''}">${x.slot_time.slice(0,5)}</span>`).join('')}</div></div>`}document.getElementById('dashboard-7day-schedule').innerHTML=h||"ç„¡";}
    function closeModal(){document.getElementById('modal').style.display='none';}
    function switchTab(id){document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));document.getElementById('tab-'+id).classList.add('active');document.querySelectorAll('.sidebar button').forEach(b=>b.classList.remove('active'));document.getElementById('nav-'+id).classList.add('active');}
    async function delData(table, id){if(confirm("åˆªé™¤ï¼Ÿ")){await myDB.from(table).delete().eq('id',id);fetchAll();}}
    window.updateS = async function(id,s){if(confirm("ç¢ºå®š?"))await myDB.from('bookings').update({status:s}).eq('id',id);closeModal();fetchAll();}
    async function linkUser(u,b){if(confirm("æ­¸æˆ¶?"))await myDB.from('bookings').update({user_id:u}).eq('id',b);fetchAll();}
    function copyCode(el) { navigator.clipboard.writeText(el.innerText).then(() => alert("æŒ‡ä»¤å·²è¤‡è£½ï¼")); }
    function toggleMainSidebar() { document.body.classList.toggle('hide-nav'); }
    function editCat(id){const c=cache.cats.find(x=>x.id===id);document.getElementById('cat-id-edit').value=c.id;document.getElementById('cat-name').value=c.name;document.getElementById('cat-terms').value=c.terms;document.getElementById('btn-cat-save').innerText="å„²å­˜";document.getElementById('btn-cat-cancel').style.display="inline-block";}
    function cancelEdit(t){if(t==='svc'){document.getElementById('svc-id-edit').value='';document.getElementById('i-name').value='';document.getElementById('btn-svc-save').innerText="ï¼‹ æ–°å¢";document.getElementById('btn-svc-cancel').style.display="none";}else{document.getElementById('cat-id-edit').value='';document.getElementById('cat-name').value='';document.getElementById('btn-cat-save').innerText="ï¼‹ æ–°å¢";document.getElementById('btn-cat-cancel').style.display="none";}}
    function editSvc(id){const s=cache.svcs.find(x=>x.id===id);document.getElementById('svc-id-edit').value=s.id;document.getElementById('i-name').value=s.title;document.getElementById('i-price').value=s.price;document.getElementById('i-is-main').checked=s.is_main;document.getElementById('i-report-tpl').value=s.report_template||'';document.getElementById('i-sub-opts').value=s.sub_options||'';toggleSubOptionInput();document.getElementById('btn-svc-save').innerText="å„²å­˜";document.getElementById('btn-svc-cancel').style.display='inline-block';}
    function toggleSubOptionInput(){const m=document.getElementById('i-is-main').checked;document.getElementById('main-opt-wrapper').style.display=m?'block':'none';document.getElementById('sub-opt-wrapper').style.display=m?'none':'block';}
    function editOTA(id) { const o = cache.otas.find(x => x.id === id); document.getElementById('ota-id').value = o.id; document.getElementById('ota-name').value = o.name; document.getElementById('ota-code').value = o.code; document.getElementById('ota-rate').value = o.commission_rate; document.getElementById('ota-front').value = o.front_url || ''; document.getElementById('ota-admin').value = o.admin_url || ''; document.getElementById('btn-ota-save').innerText = "æ›´æ–°å¹³å°"; document.getElementById('btn-ota-cancel').style.display = 'inline-block'; }
    function cancelOTA() { document.getElementById('ota-id').value = ''; document.getElementById('ota-name').value = ''; document.getElementById('ota-code').value = ''; document.getElementById('ota-front').value = ''; document.getElementById('ota-admin').value = ''; document.getElementById('btn-ota-save').innerText = "ğŸ’¾ å„²å­˜è¨­å®š"; document.getElementById('btn-ota-cancel').style.display = 'none'; }
    async function saveOTA() { const id = document.getElementById('ota-id').value; const p = { name: document.getElementById('ota-name').value, code: document.getElementById('ota-code').value, commission_rate: document.getElementById('ota-rate').value, front_url: document.getElementById('ota-front').value, admin_url: document.getElementById('ota-admin').value }; if(!p.name) return alert("åç¨±å¿…å¡«"); if(id) await myDB.from('ota_settings').update(p).eq('id', id); else await myDB.from('ota_settings').insert([p]); cancelOTA(); fetchAll(); }
    function toggleCpExp() { const noLimit = document.getElementById('cp-no-limit').checked; const expInput = document.getElementById('cp-exp'); expInput.disabled = noLimit; if(noLimit) expInput.value = ''; }
    function updateCpHint() { const type = document.getElementById('cp-type').value; document.getElementById('cp-val-hint').innerText = type === 'percentage' ? "æŠ˜æ‰£æ•¸å€¼ (90=9æŠ˜)" : "æŠ˜æŠµé‡‘é¡ (100=æŠ˜100)"; }
    async function saveCoupon() { const id = document.getElementById('cp-edit-id').value; const p = { name: document.getElementById('cp-name').value, code: document.getElementById('cp-code').value, discount_type: document.getElementById('cp-type').value, discount_value: document.getElementById('cp-val').value, expires_at: document.getElementById('cp-no-limit').checked ? null : document.getElementById('cp-exp').value, allow_member: document.getElementById('cp-mem').checked, allow_guest: document.getElementById('cp-guest').checked }; if(!p.name || !p.code) return alert("è³‡æ–™ä¸å…¨"); if(id) await myDB.from('coupons').update(p).eq('id', id); else await myDB.from('coupons').insert([p]); resetCouponForm(); fetchAll(); }
    function editCoupon(id) { const c = cache.coupons.find(x => x.id === id); document.getElementById('cp-edit-id').value = c.id; document.getElementById('cp-name').value = c.name; document.getElementById('cp-code').value = c.code; document.getElementById('cp-val').value = c.discount_value; document.getElementById('cp-mem').checked = c.allow_member; document.getElementById('cp-guest').checked = c.allow_guest; if(!c.expires_at) { document.getElementById('cp-no-limit').checked = true; document.getElementById('cp-exp').disabled = true; } else { document.getElementById('cp-no-limit').checked = false; document.getElementById('cp-exp').value = c.expires_at.slice(0,10); document.getElementById('cp-exp').disabled = false; } document.getElementById('btn-cp-save').innerText = "æ›´æ–°"; document.getElementById('btn-cp-cancel').style.display = "inline-block"; }
    function resetCouponForm() { document.getElementById('cp-edit-id').value = ''; document.getElementById('cp-name').value = ''; document.getElementById('cp-code').value = ''; document.getElementById('cp-val').value = ''; document.getElementById('cp-exp').value = ''; document.getElementById('cp-no-limit').checked = false; document.getElementById('cp-exp').disabled = false; document.getElementById('btn-cp-save').innerText = "å»ºç«‹"; document.getElementById('btn-cp-cancel').style.display = "none"; }
    async function testCoupon() { const c = document.getElementById('test-cp-code').value; const p = document.getElementById('test-cp-price').value; const { data } = await myDB.from('coupons').select('*').eq('code', c).single(); if(!data) return alert("ç„¡æ•ˆä»£ç¢¼"); let f = p; if(data.discount_type === 'percentage') f = Math.round(p * (data.discount_value/100)); else f = p - data.discount_value; alert(`åŸåƒ¹ $${p} -> æŠ˜å¾Œ $${f}`); }
    
    // SQL è¤‡è£½åŠŸèƒ½
    function copySqlCode() {
        const code = document.getElementById('sql-code-block').innerText;
        navigator.clipboard.writeText(code).then(() => alert("SQL æŒ‡ä»¤å·²è¤‡è£½ï¼"));
    }
    
    // è§£æ±ºå„ªæƒ åˆ¸ Tab åˆ‡æ›å•é¡Œ (é—œéµä¿®æ­£)
    function switchFinanceSub(tab) {
        // åˆ‡æ›é¡¯ç¤º
        document.getElementById('sub-ota').style.display = tab === 'ota' ? 'block' : 'none';
        document.getElementById('sub-coupon').style.display = tab === 'coupon' ? 'block' : 'none';
        
        // åˆ‡æ›æŒ‰éˆ•æ¨£å¼
        document.getElementById('btn-sub-ota').className = tab === 'ota' ? 'active' : '';
        document.getElementById('btn-sub-coupon').className = tab === 'coupon' ? 'active' : '';
    }
</script>
</body>
</html>
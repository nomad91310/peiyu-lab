<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äººé¡åœ–èƒ½é‡è«®è©¢å ±è¡¨ | åŸ¹ç™’è©¦é©—å®¤</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: #e0e5ec; padding: 30px; margin: 0; color: #333; }
        .container { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 1280px; margin: 0 auto; }
        h2 { margin: 0 0 20px 0; text-align: center; color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 15px; font-size: 28px;}
        
        /* é ‚éƒ¨è³‡æ–™ */
        .header-inputs { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; background: #f0f4f8; padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #dcebf7; }
        .header-group label { display: block; font-size: 14px; color: #1565c0; font-weight: bold; margin-bottom: 6px; }
        .header-group input { width: 100%; padding: 10px; border: 1px solid #90caf9; border-radius: 6px; font-size: 15px; }
        
        /* åŠ è³¼é …ç›®å€ (æ–°) */
        #addon-section-wrapper { display: none; margin-bottom: 25px; }
        #addon-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 20px; }
        .addon-section-title { font-size: 18px; font-weight: bold; color: #0277bd; margin: 20px 0 10px 0; padding-left: 10px; border-left: 5px solid #0277bd; background: #e1f5fe; padding: 10px; border-radius: 0 5px 5px 0; }

        /* ç¸½çµå€ */
        .summary-section { background: #fff8e1; border: 2px solid #ffecb3; border-radius: 10px; padding: 15px; margin-bottom: 25px; }
        .summary-section label { display: block; font-size: 16px; color: #f57f17; font-weight: bold; margin-bottom: 8px; }
        .summary-section textarea { width: 100%; height: 70px; padding: 10px; border: 1px solid #ffe082; border-radius: 6px; font-size: 15px; resize: vertical; font-family: inherit;}

        /* èƒ½é‡ä¸­å¿ƒèˆ‡åŠ è³¼å¡ç‰‡å…±ç”¨æ¨£å¼ */
        #inputs-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 20px; }
        .center-card, .addon-card { background: #fff; border: 1px solid #e0e0e0; border-radius: 10px; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); position: relative; }
        
        /* èƒ½é‡ä¸­å¿ƒé¡è‰²æ¢ */
        .center-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px; background: #ccc; }
        .center-card[data-color="head"]::before { background: #e8e6a5; } .center-card[data-color="ajna"]::before { background: #a7d28b; } .center-card[data-color="throat"]::before { background: #c6a87c; } .center-card[data-color="g"]::before { background: #f4eb68; } .center-card[data-color="ego"]::before { background: #e85d5d; } .center-card[data-color="solar"]::before { background: #c69c6d; } .center-card[data-color="spleen"]::before { background: #c69c6d; } .center-card[data-color="sacral"]::before { background: #e85d5d; } .center-card[data-color="root"]::before { background: #c69c6d; }
        
        /* åŠ è³¼å¡ç‰‡æ¨£å¼ */
        .addon-card { border: 1px solid #b3e5fc; background: #f1f8e9; }
        .addon-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px; background: #0288d1; }
        
        .center-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 8px; padding-left: 8px; }
        .center-title { font-weight: bold; font-size: 17px; } .status-group { display: flex; gap: 4px; }
        .status-btn { padding: 5px 8px; font-size: 12px; border: 1px solid #ccc; background: #fff; border-radius: 4px; cursor: pointer; }
        .status-btn.active { background: #34495e; color: white; }
        .diagnosis-area { background: #fafafa; padding: 12px; border-radius: 8px; border: 1px dashed #ddd; margin-bottom: 10px; }
        .checkbox-item { display: flex; align-items: flex-start; gap: 6px; font-size: 13px; cursor: pointer; margin-bottom: 5px; line-height: 1.3; }
        .input-row { display: flex; gap: 10px; margin-bottom: 12px; } .input-group { flex: 1; } .input-group input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; text-align: center; }
        .custom-note-area textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; height: 45px; }
        
        /* æŒ‰éˆ•å€ */
        .action-bar { display: flex; gap: 15px; margin-top: 30px; justify-content: center; }
        .btn { padding: 15px 30px; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; transition:0.3s; flex: 1; max-width: 300px;}
        .btn-preview { background: #546e7a; color: white; }
        .btn-preview:hover { background: #455a64; transform:translateY(-2px); }
        .btn-save { background: #2e7d32; color: white; display: none; } 
        .btn-save:hover { background: #1b5e20; transform:translateY(-2px); }

        #status-msg { margin-top: 15px; text-align: center; font-weight: bold; color: #d32f2f; min-height: 24px;}
        #result-wrapper { display: none; margin-top: 40px; text-align: center; }
        #final-image { max-width: 100%; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .save-hint { background: #e8f5e9; color: #2e7d32; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 16px; font-weight: bold; display: inline-block; }
        .canvas-container { display: none; }
        @media (max-width: 768px) { .header-inputs { grid-template-columns: 1fr 1fr; } #inputs-container, #addon-container { grid-template-columns: 1fr; } .action-bar { flex-direction: column; align-items: center; } .btn { width: 100%; } }
    </style>
</head>
<body>

    <div class="container">
        <h2 id="page-title">ğŸ”® äººé¡åœ–èƒ½é‡è«®è©¢å ±è¡¨</h2>
        
        <div class="header-inputs">
            <div class="header-group"><label>èª¿æ•´æ—¥æœŸ</label><input type="date" id="info-date"></div>
            <div class="header-group phone-group"><label>å€‹æ¡ˆæ‰‹æ©Ÿ</label><input type="tel" id="info-phone" placeholder="ç³»çµ±è‡ªå‹•å¸¶å…¥"></div>
            <div class="header-group"><label>å€‹æ¡ˆå§“å</label><input type="text" id="info-name" placeholder="ç³»çµ±è‡ªå‹•å¸¶å…¥"></div>
            <div class="header-group"><label>ç™‚ç™’å¸«</label><input type="text" id="info-healer" value="åŸ¹ç™’è©¦é©—å®¤"></div>
        </div>

        <div id="inputs-container"></div>

        <div id="addon-section-wrapper">
            <div class="addon-section-title">â• åŠ è³¼é …ç›® / å®¢è£½åŒ–æª¢æ¸¬</div>
            <div id="addon-container"></div>
        </div>

        <div class="summary-section">
            <label>ğŸ“ ç™‚ç™’å¸«ç¸½çµ</label>
            <textarea id="overall-summary" placeholder="ä¾‹å¦‚ï¼šæœ¬æ¬¡æ•´é«”èƒ½é‡å ´èª¿æ•´é‡é»..."></textarea>
        </div>
        
        <div id="status-msg"></div>

        <div class="action-bar">
            <button class="btn btn-preview" onclick="generatePreview()">
                ğŸ“¸ ç”Ÿæˆåœ–ç‰‡é è¦½
            </button>
            <button class="btn btn-save" id="btn-real-save" onclick="saveToDatabase()">
                ğŸ’¾ ç¢ºèªå­˜æª”ä¸¦çµæ¡ˆ
            </button>
        </div>

        <div id="result-wrapper">
            <div id="preview-hint" style="color:#555; margin-bottom:10px;">ğŸ‘‡ é€™æ˜¯åœ–ç‰‡é è¦½ï¼Œç¢ºèªç„¡èª¤å¾Œè«‹æŒ‰ä¸Šæ–¹çš„ã€Œç¢ºèªå­˜æª”ã€</div>
            <img id="final-image" />
        </div>
    </div>

    <div class="canvas-container"><canvas id="mainCanvas"></canvas></div>

    <script>
        const SB_URL = "https://geyrpowhaqfhnxghpokr.supabase.co"; 
        const SB_KEY = "sb_publishable_aXucdq8UtvMbCKbriqpJCw_gtpYBw-r";
        let myDB = null; 
        
        let currentBookingId = null;
        let currentReportId = null;
        let detectedAddons = []; // å­˜å–è§£æå‡ºä¾†çš„åŠ è³¼é …ç›®æ–‡å­—

        // -----------------------------------------------------------
        // 1. è³‡æ–™å¸¸æ•¸ (å®Œæ•´ç‰ˆï¼Œä¸€å­—ä¸æ¼)
        // -----------------------------------------------------------
        const HD_COLORS = { head: '#e8e6a5', ajna: '#a7d28b', throat: '#c6a87c', g: '#f4eb68', ego: '#e85d5d', solar: '#c69c6d', spleen: '#c69c6d', sacral: '#e85d5d', root: '#c69c6d' };
        const ENERGY_COLORS = { red: '#ff5252', yellow: '#ffd740', green: '#69f0ae' };
        
        const CENTER_THEMES = {
            head: 'éˆæ„Ÿãƒ»å£“åŠ›ãƒ»ç–‘å•', ajna: 'æ¦‚å¿µãƒ»ä¿¡å¿µãƒ»åˆ†æ', throat: 'é¡¯åŒ–ãƒ»æºé€šãƒ»è¡Œå‹•',
            g: 'æ„›ãƒ»æ–¹å‘ãƒ»èªåŒ', ego: 'åƒ¹å€¼æ„Ÿãƒ»æ‰¿è«¾ãƒ»å‹•åŠ›', solar: 'æƒ…ç·’ãƒ»æ„Ÿå—ãƒ»ç¥ç¶“ç³»çµ±',
            spleen: 'ç”Ÿå­˜ãƒ»ç›´è¦ºãƒ»å¥åº·', sacral: 'ç”Ÿç”¢åŠ›ãƒ»æ€§ãƒ»ç”Ÿå‘½åŠ›', root: 'å£“åŠ›ãƒ»è¡å‹ãƒ»è…ä¸Šè…º'
        };

        const CENTER_CONTENT = {
            head: { label: "é ­è…¦", organ: "æ¾æœé«”", static: { defined: "å¤©ç”Ÿæœ‰å›ºå®šçš„æ€è€ƒæ¨¡å¼ï¼Œèƒ½æŒçºŒè™•ç†è³‡è¨Šã€‚", undefined: "éˆæ„Ÿä¾†è‡ªå››é¢å…«æ–¹ï¼Œæ€è€ƒæœ‰å½ˆæ€§ã€‚", open: "å°éˆæ„Ÿå®Œå…¨é–‹æ”¾ï¼Œä½†ä¹Ÿå®¹æ˜“è¿·å¤±ã€‚" }, dynamic: [{ label: "å›°åœ¨è…¦ä¸­/æ†‚é¬± (å…§ç¸®)", defDiag: "æ€è€ƒå…§æ²é™·å…¥å°é–‰è¿´åœˆï¼Œæƒ³å¤ªå¤šå°è‡´æ†‚é¬±ã€‚", defAdj: "é‡‹æ”¾ç´¯ç©å…§åœ¨å£“åŠ›ï¼Œæ¸…ç†æ€è€ƒè¿´è·¯ã€‚", undefDiag: "å¸æ”¶ç’°å¢ƒæ··äº‚æ€ç·’ï¼Œåˆ†ä¸æ¸…å“ªäº›æ˜¯è‡ªå·±çš„ã€‚", undefAdj: "æ¸…ç†å¤–ä¾†é›œè¨Šï¼Œå»ºç«‹é ­éƒ¨èƒ½é‡å±éšœã€‚", isHealthy: false }, { label: "é›å©†/ç„¦æ…®è¡Œå‹• (å¤–é¡¯)", defDiag: "æ€¥æ–¼æ‰¾ç­”æ¡ˆï¼Œçµ¦äººå£“è¿«æ„Ÿã€‚", defAdj: "å®‰æ’«æ€¥èºè…¦æ³¢ï¼Œå¼•å°èƒ½é‡ä¸‹è¡Œã€‚", undefDiag: "æŠŠä»–äººå•é¡Œç•¶è²¬ä»»ï¼Œç„¦æ…®åœ°æƒ³è§£æ±ºã€‚", undefAdj: "åˆ‡æ–·éå·±è²¬ä»»èƒ½é‡ç´¢ï¼Œå›æ­¸å¹³éœã€‚", isHealthy: false }, { label: "å¤±çœ /åœä¸ä¸‹ä¾† (å¤±èª¿)", defDiag: "èº«é«”ç´¯å¤§è…¦ä»æ…£æ€§é‹è½‰ï¼Œç„¡æ³•é—œæ©Ÿã€‚", defAdj: "æ³¨å…¥æ·±å±¤æ”¾é¬†é »ç‡ï¼Œå¼·åˆ¶é—œæ©Ÿã€‚", undefDiag: "ç¡å‰å—é«˜å£“ç’°å¢ƒå½±éŸ¿ï¼Œè…¦æ³¢éåº¦æ´»èºã€‚", undefAdj: "å»ºç«‹é ‚è¼ªé˜²è­·ç½©ï¼Œæ·¨åŒ–ç¡çœ å ´åŸŸã€‚", isHealthy: false }, { label: "å¥åº· (ç¶ ç‡ˆ)", defDiag: "èƒ½é‡é‹ä½œè‰¯å¥½ï¼Œæ€è€ƒæ¸…æ™°ã€‚", undefDiag: "é ­è…¦æ¸…æ˜ï¼Œä¸åŸ·è‘—æ–¼ç­”æ¡ˆã€‚", adjust: "", isHealthy: true }] },
            ajna: { label: "é‚è¼¯", organ: "è…¦ä¸‹å‚é«”", static: { defined: "äº«å—ç ”ç©¶ï¼Œæœ‰å›ºå®šçš„çœ‹æ³•ã€‚", undefined: "æ€è€ƒæœ‰å½ˆæ€§ï¼Œèƒ½çœ‹è¦‹å¤šç¨®å¯èƒ½æ€§ã€‚", open: "å¿ƒæ™ºåƒç™½ç´™ï¼Œå°è³‡è¨Šç„¡åè¦‹ã€‚" }, dynamic: [{ label: "ç„¦æ…®/è‡ªè²¬ (å…§ç¸®)", defDiag: "èª¤èªæƒ³é€šå³åšåˆ°ï¼Œå°çµæœå¤±æœ›ã€‚", defAdj: "æ•´åˆæ€è€ƒèˆ‡è¡Œå‹•èƒ½é‡ã€‚", undefDiag: "å› ç„¡å›ºå®šæƒ³æ³•è€Œä¸å®‰ï¼Œæ“”å¿ƒè‡ªå·±ä¸è°æ˜ã€‚", undefAdj: "è½‰åŒ–å°æœªçŸ¥ææ‡¼ï¼Œè‚¯å®šå½ˆæ€§åƒ¹å€¼ã€‚", isHealthy: false }, { label: "å›ºåŸ·/å‡è£ç¢ºå®š (å¤–é¡¯)", defDiag: "æ€ç¶­åƒµåŒ–ï¼Œè½ä¸é€²ä»–äººæ„è¦‹ã€‚", defAdj: "è»ŸåŒ–åƒµå›ºä¿¡å¿µï¼Œæ³¨å…¥æµå‹•èƒ½é‡ã€‚", undefDiag: "æ©é£¾ä¸ç¢ºå®šæ„Ÿï¼Œå‡è£è‡ªå·±ä»€éº¼éƒ½æ‡‚ã€‚", undefAdj: "å¸ä¸‹å½è£ç›”ç”²ï¼Œæ¥å—ä¸ç¢ºå®šæ€§ã€‚", isHealthy: false }, { label: "å°ˆæ³¨åŠ›æ¸™æ•£ (å¤±èª¿)", defDiag: "è…¦ä¸‹å‚é«”å£“åŠ›éå¤§ï¼Œç”¨è…¦éåº¦ã€‚", defAdj: "ä¿®å¾©çœ‰å¿ƒè¼ªèƒ½é‡ï¼Œè£œå……è…¦åŠ›ã€‚", undefDiag: "å¿ƒæ™ºè¢«è³‡è¨Šæ·¹æ²’ï¼Œç„¡æ³•èšç„¦ã€‚", undefAdj: "æ¸…ç†å¿ƒæ™ºç·©å­˜å€ï¼Œæ¢å¾©å°ˆæ³¨ã€‚", isHealthy: false }, { label: "å¥åº· (ç¶ ç‡ˆ)", defDiag: "èƒ½é‡é‹ä½œè‰¯å¥½ï¼Œè¦‹è§£ç¨åˆ°ã€‚", undefDiag: "æ€ç¶­éˆæ´»ï¼Œèƒ½å¸ç´ä¸åŒè§€é»ã€‚", adjust: "", isHealthy: true }] },
            throat: { label: "å–‰åš¨", organ: "ç”²ç‹€è…º", static: { defined: "æœ‰å›ºå®šè¡¨é”æ¨¡å¼ï¼Œèªªè©±æœ‰å½±éŸ¿åŠ›ã€‚", undefined: "è²éŸ³å¤šè®Šï¼Œå®¹æ˜“åæ‡‰ç’°å¢ƒã€‚", open: "ç„¡å›ºå®šè²éŸ³ï¼Œç”šè‡³å¯èƒ½æ²‰é»˜ã€‚" }, dynamic: [{ label: "æœ‰å£é›£è¨€/å£“æŠ‘ (å…§ç¸®)", defDiag: "å› å—æŒ«æˆ–åˆ¶ç´„è€Œä¸æ•¢è¡¨é”ã€‚", defAdj: "ç–é€šé¡¯åŒ–ç®¡é“ï¼Œç§»é™¤å–‰è¼ªé˜»å¡ã€‚", undefDiag: "ä¸çŸ¥å¦‚ä½•è¡¨é”ï¼Œè¦ºå¾—æ²’äººæƒ³è½ã€‚", undefAdj: "æ¸…ç†è¡¨é”é€šé“ç„¦æ…®ï¼Œé€£çµå…§åœ¨çœŸå¯¦ã€‚", isHealthy: false }, { label: "å–‹å–‹ä¸ä¼‘ (å¤–é¡¯)", defDiag: "æ€¥æ–¼è¡¨é”ï¼Œèªªè©±ä¸ç¶“å¤§è…¦ã€‚", defAdj: "å¹³è¡¡å–‰è¼ªèºå‹•èƒ½é‡ï¼Œæ…¢ä¸‹ä¾†ã€‚", undefDiag: "æ€•ç©ºæ°£å®‰éœï¼Œç‚ºäº†èªªè€Œèªªã€‚", undefAdj: "å®‰ä½æ–¼å…§åœ¨ï¼Œç·´ç¿’æ²ˆé»˜çš„åŠ›é‡ã€‚", isHealthy: false }, { label: "å…‰èªªä¸ç·´/ç©ºè«‡ (å¤±èª¿)", defDiag: "èƒ½é‡åœåœ¨å˜´å·´ï¼Œç„¡æ³•é¡¯åŒ–è¡Œå‹•ã€‚", defAdj: "é€£çµå–‰è¼ªèˆ‡å‹•åŠ›ä¸­å¿ƒï¼Œè½åœ°åŸ·è¡Œã€‚", undefDiag: "è¿åˆæ°£æ°›èªªéŒ¯è©±ï¼Œäº‹å¾Œå¾Œæ‚”ã€‚", undefAdj: "æ ¡æº–èªè¨€èƒ½é‡ï¼Œä¿æŒè¦ºçŸ¥ã€‚", isHealthy: false }, { label: "å¥åº· (ç¶ ç‡ˆ)", defDiag: "èƒ½é‡é‹ä½œè‰¯å¥½ï¼Œè¨€è¡Œä¸€è‡´ã€‚", undefDiag: "éš¨é †å› ç·£ç™¼è²ï¼Œè²éŸ³æœ‰ç£æ€§ã€‚", adjust: "", isHealthy: true }] },
            g: { label: "Gä¸­å¿ƒ", organ: "è‚è‡Ÿ", static: { defined: "æ„›èˆ‡æ–¹å‘æ˜¯å›ºå®šçš„ï¼Œäº†è§£è‡ªå·±ã€‚", undefined: "å ´æ‰€çš„è®Šè‰²é¾ï¼Œå°ç’°å¢ƒæ•æ„Ÿã€‚", open: "ç„¡èº«åˆ†æ¨™ç±¤ï¼Œé«”é©—ä¸åŒè§’è‰²ã€‚" }, dynamic: [{ label: "ç¼ºä¹è‡ªæ„›/è¨å¥½ (å…§ç¸®)", defDiag: "ç‚ºç¶­æŒé—œä¿‚è€Œå§”å±ˆè‡ªå·±ã€‚", defAdj: "ä¿®è£œèƒ½é‡å ´ç ´æ´ï¼Œå–šé†’è‡ªæ„›ã€‚", undefDiag: "è¨æ„›è€Œéåº¦é…åˆï¼Œå¤±å»è‡ªæˆ‘ã€‚", undefAdj: "æ³¨å…¥ç„¡æ¢ä»¶çš„æ„›ï¼Œå›æ­¸ä¸­å¿ƒã€‚", isHealthy: false }, { label: "å¼·å‹¢/æ§åˆ¶ç‹‚ (å¤–é¡¯)", defDiag: "éæ–¼å …æŒåŸå‰‡ï¼Œå¼·è¿«ä»–äººæ¥å—ã€‚", defAdj: "æŸ”åŒ–å¿ƒè¼ªèƒ½é‡ï¼Œå¢åŠ åŒ…å®¹æ€§ã€‚", undefDiag: "ä¾é™„ä»–äººä»¥ç²å¾—èº«åˆ†èªåŒã€‚", undefAdj: "åˆ‡æ–·ä¾é™„èƒ½é‡ç´¢ï¼Œç¨ç«‹è‡ªä¸»ã€‚", isHealthy: false }, { label: "è¿·å¤±æ–¹å‘/ç©ºè™› (å¤±èª¿)", defDiag: "å¤ªä¹…æ²’å›å…§åœ¨ï¼Œæ‰¾ä¸åˆ°ç†±æƒ…ã€‚", defAdj: "æ ¡æº–å…§åœ¨å°èˆªï¼Œé‡ç‡ƒç†±æƒ…ã€‚", undefDiag: "è¿·å¤±åœ¨ç’°å¢ƒè£¡ï¼Œä¸çŸ¥é“å»å“ªã€‚", undefAdj: "æ¸…ç†å¤–åœ¨å¹²æ“¾ï¼Œç­‰å¾…æŒ‡å¼•ã€‚", isHealthy: false }, { label: "å¥åº· (ç¶ ç‡ˆ)", defDiag: "èƒ½é‡é‹ä½œè‰¯å¥½ï¼Œæ–¹å‘æ˜ç¢ºã€‚", undefDiag: "äº«å—ç•¶ä¸‹ç’°å¢ƒï¼Œéš¨é‡è€Œå®‰ã€‚", adjust: "", isHealthy: true }] },
            ego: { label: "æ„å¿—", organ: "å¿ƒè‡Ÿ/èƒƒ", static: { defined: "æ„å¿—åŠ›å›ºå®šï¼Œæ‰¿è«¾å¿…é”ã€‚", undefined: "åƒ¹å€¼ç„¡éœ€è­‰æ˜ï¼Œä¸å¿…æ‰¿è«¾ã€‚", open: "ç„¡ç«¶çˆ­æ„è­˜ï¼Œä¸çŸ¥ç‚ºä½•è€Œæˆ°ã€‚" }, dynamic: [{ label: "è‡ªå‘/åƒ¹å€¼æ„Ÿä½ (å…§ç¸®)", defDiag: "å› å¤±æ•—æ‡·ç–‘èƒ½åŠ›ï¼Œè‡ªæˆ‘æ”»æ“Šã€‚", defAdj: "é‡‹æ”¾æŒ«æ•—æ„Ÿï¼Œä¿®å¾©è‡ªæˆ‘åƒ¹å€¼ã€‚", undefDiag: "é™·æ¯”è¼ƒé™·é˜±ï¼Œè¦ºå¾—ä¸å¦‚äººã€‚", undefAdj: "é‡‹æ”¾è‡ªæˆ‘æ‡·ç–‘æ¯’ç´ ï¼Œè‚¯å®šè‡ªæˆ‘ã€‚", isHealthy: false }, { label: "å‚²æ…¢/æ–½å£“ (å¤–é¡¯)", defDiag: "è‡ªæˆ‘è†¨è„¹ï¼Œå°ä»–äººé ¤æŒ‡æ°£ä½¿ã€‚", defAdj: "è½‰åŒ–éå¼·è‡ªæˆ‘æ„è­˜ï¼Œå­¸æœƒè¬™å‘ã€‚", undefDiag: "è™›å¼µè²å‹¢ï¼Œå‡è£å¼·å¤§ã€‚", undefAdj: "å¸ä¸‹å½è£ç›”ç”²ï¼Œæ¥å—çœŸå¯¦ã€‚", isHealthy: false }, { label: "éåº¦æ‰¿è«¾/éå‹ (å¤±èª¿)", defDiag: "é«˜ä¼°é›»é‡ï¼Œæ‰¿è«¾éå¤šã€‚", defAdj: "åˆ‡æ–·è¶…è¼‰æ‰¿è«¾ï¼Œä¿ç•™èƒ½é‡ã€‚", undefDiag: "ç‚ºè­‰æ˜è‡ªå·±è€Œæ‹šå‘½ï¼Œå¿ƒè‡Ÿè² è·å¤§ã€‚", undefAdj: "å¼·åŒ–èƒ½é‡é‚Šç•Œï¼Œæ‹’çµ•è­‰æ˜ã€‚", isHealthy: false }, { label: "å¥åº· (ç¶ ç‡ˆ)", defDiag: "èƒ½é‡é‹ä½œè‰¯å¥½ï¼Œä¿¡å®ˆæ‰¿è«¾ã€‚", undefDiag: "ä¸éœ€è­‰æ˜ä»€éº¼ï¼Œè¼•é¬†è‡ªåœ¨ã€‚", adjust: "", isHealthy: true }] },
            solar: { label: "æƒ…ç·’", organ: "è…/ç¥ç¶“", static: { defined: "è‡ªå¸¶æƒ…ç·’æ³¢ï¼Œæƒ…ç·’æœ‰é«˜ä½é€±æœŸã€‚", undefined: "å…±æ„Ÿè€…ï¼Œæ”¾å¤§ç’°å¢ƒæƒ…ç·’ã€‚", open: "æƒ…ç·’å†·éœï¼Œæ—è§€è€…è¦–è§’ã€‚" }, dynamic: [{ label: "å£“æŠ‘/å¥½äººç—‡å€™ç¾¤ (å…§ç¸®)", defDiag: "å—åˆ¶ç´„èªæƒ…ç·’ä¸å¥½ï¼Œå¼·é¡æ­¡ç¬‘ã€‚", defAdj: "ç–é€šæƒ…ç·’ç®¡é“ï¼Œå…è¨±æƒ…ç·’æµå‹•ã€‚", undefDiag: "æ€•è¡çªè€Œéš±å¿ï¼Œå…§å‚·åš´é‡ã€‚", undefAdj: "æ¸…ç†å †ç©æƒ…ç·’åƒåœ¾ï¼Œé‡‹æ”¾å§”å±ˆã€‚", isHealthy: false }, { label: "æƒ…ç·’å‹’ç´¢/å€’åƒåœ¾ (å¤–é¡¯)", defDiag: "æ‹’ç‚ºæƒ…ç·’è² è²¬ï¼Œé·æ€’ä»–äººã€‚", defAdj: "æ·¨åŒ–èƒ½é‡å ´ï¼Œè½‰åŒ–è² é¢æƒ…ç·’ã€‚", undefDiag: "åå°„ç’°å¢ƒæ†¤æ€’ï¼Œæƒ…ç·’å¤±æ§ã€‚", undefAdj: "å”åŠ©æŠ½é›¢ç•¶ä¸‹æƒ…ç·’ï¼Œå›æ­¸å¹³éœã€‚", isHealthy: false }, { label: "è¡å‹•/ç„¦æ…® (å¤±èª¿)", defDiag: "æµªå°–ä¸Šåšæ±ºå®šï¼Œäº‹å¾Œå¾Œæ‚”ã€‚", defAdj: "å®‰æ’«ç¥ç¶“ç³»çµ±ï¼Œç·´ç¿’ç­‰å¾…ã€‚", undefDiag: "ç¥ç¶“ç³»çµ±éè¼‰ï¼Œè«åç„¦æ…®ã€‚", undefAdj: "æ³¨å…¥å¯§éœé »ç‡ï¼Œä¿®å¾©ç¥ç¶“ã€‚", isHealthy: false }, { label: "å¥åº· (ç¶ ç‡ˆ)", defDiag: "èƒ½é‡é‹ä½œè‰¯å¥½ï¼Œæƒ…ç·’ç©©å®šã€‚", undefDiag: "ä¸æ²¾æŸ“ä»–äººæƒ…ç·’ï¼Œæ¸…æ˜è¦ºå¯Ÿã€‚", adjust: "", isHealthy: true }] },
            spleen: { label: "ç›´è¦º", organ: "è„¾/æ·‹å·´", static: { defined: "ç›´è¦ºå¯é ï¼Œèº«é«”åæ‡‰å¿«ã€‚", undefined: "ç›´è¦ºä¸ç©©ï¼Œå®¹æ˜“è¢«ç’°å¢ƒå½±éŸ¿ã€‚", open: "ææ‡¼ç„¡æ¿¾ç¶²ï¼Œå°å±éšªæ•æ„Ÿã€‚" }, dynamic: [{ label: "éåº¦ä¿å®ˆ/ä¸æ•¢è®Š (å…§ç¸®)", defDiag: "å¤ªæ¸…æ¥šé¢¨éšªï¼Œå°è‡´è£¹è¶³ä¸å‰ã€‚", defAdj: "é‡‹æ”¾åƒµåŒ–é˜²ç¦¦ï¼Œå¢å¼·å‹‡æ°£ã€‚", undefDiag: "è¢«ææ‡¼ç™±ç˜“ï¼Œä¸æ•¢è¡Œå‹•ã€‚", undefAdj: "æ¸…ç†æ·±å±¤ææ‡¼å°è¨˜ï¼Œå»ºç«‹å®‰å…¨æ„Ÿã€‚", isHealthy: false }, { label: "éµé½’/å¿½è¦–è­¦è¨Š (å¤–é¡¯)", defDiag: "å¤§è…¦è“‹éèº«é«”è¨Šè™Ÿï¼Œç¡¬æ’ã€‚", defAdj: "é‡æ–°æ ¡æº–èº«é«”é›·é”ï¼Œæ¢å¾©é€£çµã€‚", undefDiag: "ç‚ºæ©é£¾ææ‡¼è€Œé­¯è½è¡Œäº‹ã€‚", undefAdj: "é€£çµç”Ÿå­˜æœ¬èƒ½ï¼Œè½åœ°è¸å¯¦ã€‚", isHealthy: false }, { label: "ä¾è³´/ç·ŠæŠ“ä¸æ”¾ (å¤±èª¿)", defDiag: "åªä¿¡èˆŠç¿’æ…£ï¼ŒæŠ—æ‹’æ”¹è®Šã€‚", defAdj: "åˆ‡æ–·èˆŠæœ‰æ…£æ€§é€£çµï¼Œè¿æ¥æ–°æµã€‚", undefDiag: "æ€•å­¤å–®ï¼Œç·ŠæŠ“ä¸å¥åº·é—œä¿‚ã€‚", undefAdj: "åˆ‡æ–·ä¾é™„èƒ½é‡ç´¢ï¼Œç¨ç«‹è‡ªä¸»ã€‚", isHealthy: false }, { label: "å¥åº· (ç¶ ç‡ˆ)", defDiag: "èƒ½é‡é‹ä½œè‰¯å¥½ï¼Œç›´è¦ºæ•éŠ³ã€‚", undefDiag: "é¢å°ææ‡¼ä¸ä¾é™„ï¼Œä¾†å»è‡ªå¦‚ã€‚", adjust: "", isHealthy: true }] },
            sacral: { label: "è–¦éª¨", organ: "ç”Ÿæ®–ç³»çµ±", static: { defined: "å¼·å¤§ç™¼é›»æ©Ÿï¼ŒæŒçºŒå·¥ä½œçš„å‹•åŠ›ã€‚", undefined: "èƒ½é‡å¼•å°è€…ï¼ŒçŸ¥äººå–„ä»»ã€‚", open: "æ€§èƒ½é‡æ¨¡ç³Šï¼Œå°å·¥ä½œç„¡å›ºå®šåå¥½ã€‚" }, dynamic: [{ label: "å‹‰å¼·/èƒ½é‡é˜»å¡ (å…§ç¸®)", defDiag: "è…¦é€¼èº«é«”ï¼Œåšä¸å–œæ­¡çš„äº‹ã€‚", defAdj: "ä¿®å¾©èƒ½é‡æ¼æ´ï¼Œæ‰¾å›å–œæ‚…ã€‚", undefDiag: "å¸æ”¶ä»–äººèˆˆå¥®ï¼Œä¸çŸ¥ä½•æ™‚åœã€‚", undefAdj: "å”åŠ©èˆ‡ç©ºç™½å’Œè§£ï¼Œå…è¨±ä¼‘æ¯ã€‚", isHealthy: false }, { label: "äº‚ç™¼èµ·/æŒ«æ•— (å¤–é¡¯)", defDiag: "å¿˜è¨˜ç­‰å¾…ï¼Œä¸»å‹•ç™¼èµ·å—æŒ«ã€‚", defAdj: "å”åŠ©èƒ½é‡æ­¸ä½ï¼Œç·´ç¿’å›æ‡‰ã€‚", undefDiag: "æ‹¼å‘½å·¥ä½œï¼Œæƒ³è·Ÿä¸Šä»–äººç¯€å¥ã€‚", undefAdj: "é‡‹æ”¾æˆ‘ä¸å¤ å¥½é©…å‹•åŠ›ï¼Œæ”¾æ…¢ã€‚", isHealthy: false }, { label: "æ€§/å‰µé€ åŠ›å—é˜» (å¤±èª¿)", defDiag: "å‰µé€ ä¹‹ç«ç†„æ»…ï¼Œæ€§å†·æ„Ÿã€‚", defAdj: "æ¿€æ´»è‡è¼ªèƒ½é‡ï¼Œé‡ç‡ƒç”Ÿå‘½åŠ›ã€‚", undefDiag: "èƒ½é‡é€æ”¯ï¼Œå¾¹åº•ç‡’æ¯€ã€‚", undefAdj: "æ³¨å…¥ä¿®å¾©èƒ½é‡ï¼Œæ·±å±¤æ»‹é¤Šã€‚", isHealthy: false }, { label: "å¥åº· (ç¶ ç‡ˆ)", defDiag: "èƒ½é‡é‹ä½œè‰¯å¥½ï¼Œå·¥ä½œæ»¿è¶³ã€‚", undefDiag: "å·¥ä½œæœ‰åº¦ï¼Œæ‡‚å¾—ä¸‹ç­ã€‚", adjust: "", isHealthy: true }] },
            root: { label: "æ ¹éƒ¨", organ: "è…ä¸Šè…º", static: { defined: "æŠ—å£“æ€§å¼·ï¼Œå£“åŠ›æ˜¯å‹•åŠ›ã€‚", undefined: "å£“åŠ›æ”¾å¤§å™¨ï¼Œæ€¥æ–¼æ“ºè„«å£“åŠ›ã€‚", open: "å°å£“åŠ›ç„¡æ„Ÿï¼Œä½†ä¹Ÿå¯èƒ½ç„¡å‹•åŠ›ã€‚" }, dynamic: [{ label: "å£“æŠ‘ç„¦æ…®/ä¾¿ç§˜ (å…§ç¸®)", defDiag: "å£“åŠ›åè‚šå…§ï¼Œé€ æˆèº«é«”åƒµç¡¬ã€‚", defAdj: "é‡‹æ”¾ç´¯ç©åº•å±¤å£“åŠ›ï¼Œæ”¾é¬†ç­‹è†œã€‚", undefDiag: "è¢«ä»–äººå£“åŠ›ç¶æ¶ï¼Œè«åç„¦èºã€‚", undefAdj: "æ¸…ç†å¤–ä¾†å£“åŠ›èƒ½é‡ï¼Œå›æ­¸ä¸­å¿ƒã€‚", isHealthy: false }, { label: "é€¼è¿«ä»–äºº/æš´èº (å¤–é¡¯)", defDiag: "å—ä¸äº†æ…¢æ­¥èª¿ï¼Œå‚¬ä¿ƒä»–äººã€‚", defAdj: "å¹³è¡¡æ ¹éƒ¨èƒ½é‡ï¼Œå­¸ç¿’è€å¿ƒã€‚", undefDiag: "æ€¥æ–¼è§£è„«ï¼ŒæŠŠè¡Œç¨‹å¡æ»¿ã€‚", undefAdj: "å”åŠ©å®‰ä½ç•¶ä¸‹ï¼Œä¸€æ¬¡åšä¸€äº‹ã€‚", isHealthy: false }, { label: "ç”Ÿå­˜ç„¦æ…®/ç„¡æ³•æ‰æ ¹ (å¤±èª¿)", defDiag: "å°ç¾å¯¦ä¸å®‰ï¼Œæ“”æ†‚æœªä¾†ã€‚", defAdj: "å¼·åŒ–æµ·åº•è¼ªï¼Œé€£çµå¤§åœ°ã€‚", undefDiag: "å£“åŠ›å¤§åˆ°æƒ³é€ƒé¿ï¼Œé­‚ä¸å®ˆèˆã€‚", undefAdj: "å”åŠ©èƒ½é‡æ‰æ ¹ï¼Œç©©å®šæ ¸å¿ƒã€‚", isHealthy: false }, { label: "å¥åº· (ç¶ ç‡ˆ)", defDiag: "èƒ½é‡é‹ä½œè‰¯å¥½ï¼Œå¾å®¹æ‡‰å°ã€‚", undefDiag: "ä¸è¢«ä»–äººå£“åŠ›é©…å‹•ï¼Œè‡ªåœ¨é€é™ã€‚", adjust: "", isHealthy: true }] }
        };

        const CENTERS = [
            { id: 'head',   shape: 'tri-up',    cx: 400, cy: 150, w: 160, h: 140, textDy: 10 },
            { id: 'ajna',   shape: 'tri-down',  cx: 400, cy: 290, w: 160, h: 140, textDy: -10 },
            { id: 'throat', shape: 'square',    cx: 400, cy: 450, w: 140, h: 140, textDy: 0 },
            { id: 'g',      shape: 'diamond',   cx: 400, cy: 650, w: 170, h: 170, textDy: 0 },
            { id: 'ego',    shape: 'tri-small', cx: 620, cy: 680, w: 130, h: 120, textDy: 0 }, 
            { id: 'sacral', shape: 'square',    cx: 400, cy: 840, w: 140, h: 140, textDy: 0 },
            { id: 'spleen', shape: 'tri-left',  cx: 160, cy: 830, w: 160, h: 140, textDy: 0 },
            { id: 'solar',  shape: 'tri-right', cx: 640, cy: 830, w: 160, h: 140, textDy: 0 },
            { id: 'root',   shape: 'square',    cx: 400, cy: 1030, w: 140, h: 140, textDy: 0 }
        ];

        const CHANNELS = [
            ['head', 'ajna'], ['ajna', 'throat'], ['throat', 'g'], ['throat', 'spleen'], 
            ['throat', 'sacral'], ['throat', 'solar'], ['g', 'sacral'], ['g', 'spleen'], 
            ['g', 'ego'], ['ego', 'throat'], ['ego', 'solar'], ['sacral', 'root'], 
            ['sacral', 'spleen'], ['sacral', 'solar'], ['spleen', 'root'], ['solar', 'root']
        ];

        // -----------------------------------------------------------
        // 2. åˆå§‹åŒ–é‚è¼¯
        // -----------------------------------------------------------
        window.onload = async function() {
            document.getElementById('info-date').valueAsDate = new Date();
            renderInputs(); // æ¸²æŸ“ 9 å¤§ä¸­å¿ƒ

            try {
                myDB = window.supabase.createClient(SB_URL, SB_KEY);
                console.log("âœ… DB Connected");
            } catch(e) { console.error("DB Error:", e); }

            const params = new URLSearchParams(window.location.search);
            const pId = params.get('id'); 
            const pName = params.get('name');
            const pPhone = params.get('phone');
            const pBid = params.get('bid');

            if (pId) {
                // ç·¨è¼¯æ¨¡å¼
                currentReportId = pId;
                document.getElementById('page-title').innerText = "ğŸ“ ç·¨è¼¯æ­·å²å ±è¡¨";
                document.getElementById('btn-real-save').innerText = "ğŸ’¾ æ›´æ–°å„²å­˜";
                await loadReportData(pId);
            } else {
                // æ–°å¢æ¨¡å¼
                if (pName) document.getElementById('info-name').value = pName;
                if (pPhone) document.getElementById('info-phone').value = pPhone;
                if (pBid) {
                    currentBookingId = pBid;
                    fetchBookingService(pBid); // ğŸŒŸ æŠ“å–ä¸¦åˆ†æåŠ è³¼
                }
            }
        };

        // -----------------------------------------------------------
        // 3. æ ¸å¿ƒåŠŸèƒ½å‡½å¼
        // -----------------------------------------------------------

        // æŠ“å–ä¸¦è§£æåŠ è³¼é …ç›®
        async function fetchBookingService(bid) {
            if(!myDB) return;
            try {
                const { data, error } = await myDB.from('bookings').select('service_item, service_detail').eq('id', bid).single();
                if (error) throw error;
                
                if (data && data.service_detail) {
                    const mainItem = data.service_item.trim();
                    const details = data.service_detail.split('|').map(s => s.trim());
                    
                    // ğŸŒŸ æ™ºæ…§éæ¿¾ï¼šåªç•™ä¸‹ã€Œä¸ç­‰æ–¼ä¸»é …ç›®ã€çš„ç´°é …
                    detectedAddons = details.filter(d => {
                        const cleanName = d.replace(/\(\$\d+\)/g, '').trim();
                        // ç°¡å–®çš„åˆ¤æ–·ï¼šå¦‚æœç´°é …åç¨±ä¸å®Œå…¨åŒ…å«ä¸»é …ç›®åç¨±ï¼Œå°±è¦–ç‚ºåŠ è³¼
                        return !cleanName.includes(mainItem) && cleanName !== "";
                    }).map(d => d.replace(/\(\$\d+\)/g, '').trim());

                    if (detectedAddons.length > 0) {
                        renderAddonInputs(detectedAddons);
                    }
                }
            } catch(e) {
                console.error("Fetch Service Error", e);
            }
        }

        // æ¸²æŸ“åŠ è³¼é …ç›®è¼¸å…¥æ¡†
        function renderAddonInputs(addonNames) {
            const wrapper = document.getElementById('addon-section-wrapper');
            const container = document.getElementById('addon-container');
            wrapper.style.display = 'block';
            container.innerHTML = '';

            addonNames.forEach((name, idx) => {
                const div = document.createElement('div');
                div.className = 'addon-card';
                div.innerHTML = `
                    <div class="center-header" style="border-bottom-color:#b3e5fc;">
                        <div class="center-title" style="color:#0277bd;">ğŸ¯ ${name}</div>
                        <input type="hidden" id="addon-name-${idx}" value="${name}">
                    </div>
                    <div class="input-row" style="margin-top:15px;">
                        <div class="input-group"><label>æª¢æ¸¬æ•¸å€¼ (%)</label><input type="number" id="addon-val-${idx}" placeholder="%"></div>
                        <div class="input-group"><label>èª¿æ•´å¾Œ (%)</label><input type="number" id="addon-adj-${idx}" placeholder="%"></div>
                    </div>
                    <div class="custom-note-area">
                        <textarea id="addon-note-${idx}" placeholder="é‡å° ${name} çš„è§€å¯Ÿæˆ–å»ºè­°..."></textarea>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // æ¸²æŸ“ 9 å¤§ä¸­å¿ƒè¼¸å…¥æ¡†
        function renderInputs() {
            const container = document.getElementById('inputs-container');
            CENTERS.forEach(c => {
                const data = CENTER_CONTENT[c.id];
                const card = document.createElement('div');
                card.className = 'center-card';
                card.setAttribute('data-color', c.id);
                
                let checkHTML = data.dynamic.map((d, i) => {
                    return `<label class="checkbox-item">
                        <input type="checkbox" name="diag-${c.id}" value="${i}" onclick="handleCheck('${c.id}', ${i})">
                        <span>${d.label}</span>
                    </label>`;
                }).join('');

                card.innerHTML = `
                    <div class="center-header">
                        <div class="center-title">${data.label} <span style="font-size:12px;color:#777;">(${data.organ})</span></div>
                        <div class="status-group" id="group-${c.id}">
                            <button class="status-btn active" onclick="setStatus('${c.id}', 'defined')">å·²å®šç¾©</button>
                            <button class="status-btn" onclick="setStatus('${c.id}', 'undefined')">æœªå®šç¾©</button>
                            <button class="status-btn" onclick="setStatus('${c.id}', 'open')">å…¨ç©ºç™½</button>
                            <input type="hidden" id="status-${c.id}" value="defined">
                        </div>
                    </div>
                    <div class="diagnosis-area">
                        <div style="font-weight:bold;color:#e65100;margin-bottom:5px;">ğŸ“‹ éˆæ“ºè¨ºæ–·</div>
                        <div class="checkbox-group">${checkHTML}</div>
                    </div>
                    <div class="input-row">
                        <div class="input-group"><label>æª¢æ¸¬(%)</label><input type="number" id="val-${c.id}"></div>
                        <div class="input-group"><label>èª¿æ•´(%)</label><input type="number" id="adj-${c.id}"></div>
                    </div>
                    <div class="custom-note-area">
                        <textarea id="note-${c.id}" placeholder="æ‰‹å¯«è£œå……..."></textarea>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function setStatus(centerId, status) {
            const group = document.getElementById(`group-${centerId}`);
            const buttons = group.getElementsByTagName('button');
            buttons[0].className = status === 'defined' ? 'status-btn active' : 'status-btn';
            buttons[1].className = status === 'undefined' ? 'status-btn active' : 'status-btn';
            buttons[2].className = status === 'open' ? 'status-btn active' : 'status-btn';
            document.getElementById(`status-${centerId}`).value = status;
        }

        function handleCheck(centerId, index) {
            const checkboxes = document.getElementsByName(`diag-${centerId}`);
            const data = CENTER_CONTENT[centerId].dynamic[index];
            if (data.isHealthy) {
                if (checkboxes[index].checked) {
                    checkboxes.forEach((cb, i) => { if(i !== index) cb.checked = false; });
                    document.getElementById(`val-${centerId}`).value = 100; 
                }
            } else {
                checkboxes.forEach((cb, i) => {
                    const d = CENTER_CONTENT[centerId].dynamic[i];
                    if (d.isHealthy) cb.checked = false;
                });
            }
        }

        // æ”¶é›† UI è³‡æ–™
        function collectDataFromUI() {
            // 1. 9å¤§ä¸­å¿ƒ
            const centersData = CENTERS.map(c => {
                const centerKey = c.id;
                const db = CENTER_CONTENT[centerKey];
                const status = document.getElementById(`status-${centerKey}`).value;
                let statusLabel = (status === 'defined') ? "å·²å®šç¾©" : (status === 'undefined') ? "æœªå®šç¾©" : "å…¨ç©ºç™½";
                let valInput = document.getElementById(`val-${centerKey}`).value;
                let val = valInput === "" ? "--" : valInput;
                let adjInput = document.getElementById(`adj-${centerKey}`).value;
                let finalAdj = (adjInput !== "") ? adjInput : ((valInput !== "" && parseInt(valInput) !== 100) ? "100" : "ç„¡é ˆèª¿æ•´");
                const checkboxes = document.getElementsByName(`diag-${centerKey}`);
                let dynamicPairs = [];
                checkboxes.forEach((cb, i) => {
                    if (cb.checked) {
                        const item = db.dynamic[i];
                        let dTxt = (status === 'defined') ? item.defDiag : item.undefDiag;
                        let aTxt = (status === 'defined') ? item.defAdj : item.undefAdj;
                        if (item.isHealthy) { dynamicPairs.push({ type: 'healthy_diag', diag: `ğŸŸ¢ ${dTxt}` }); } 
                        else { dynamicPairs.push({ type: 'diag', text: `âš ï¸ ${dTxt}` }); dynamicPairs.push({ type: 'adjust', text: `ğŸ› ï¸ ${aTxt}` }); }
                    }
                });
                const customNote = document.getElementById(`note-${centerKey}`).value.trim();
                let content = [];
                content.push({ type: 'static', text: db.static[status] });
                content = content.concat(dynamicPairs.map(p => ({ type: p.type, text: p.diag || p.text })));
                if (customNote) { content.push({ type: 'note', text: `ğŸ’¡ è£œå……ï¼š${customNote}` }); }
                return { ...c, label: db.label, status, statusLabel, val, finalAdj, content, raw_diags: dynamicPairs }; 
            });

            // 2. åŠ è³¼é …ç›®
            const addonsData = [];
            if (detectedAddons.length > 0) {
                detectedAddons.forEach((name, idx) => {
                    const val = document.getElementById(`addon-val-${idx}`).value || "--";
                    const adj = document.getElementById(`addon-adj-${idx}`).value || "--";
                    const note = document.getElementById(`addon-note-${idx}`).value.trim();
                    addonsData.push({ name, val, adj, note });
                });
            }

            return { centers: centersData, addons: addonsData };
        }

        function generatePreview() {
            const msg = document.getElementById('status-msg');
            msg.innerText = "ğŸ¨ æ­£åœ¨ç”Ÿæˆé è¦½åœ–...";
            const fullData = collectDataFromUI();
            drawClassicReport(fullData);
            msg.innerText = "";
            document.getElementById('btn-real-save').style.display = 'inline-block';
            document.getElementById('result-wrapper').scrollIntoView({behavior: "smooth"});
        }

        async function saveToDatabase() {
            const msg = document.getElementById('status-msg');
            const ph = document.getElementById('info-phone').value.trim();
            const nm = document.getElementById('info-name').value.trim();
            if(!myDB) { alert("é€£ç·šéŒ¯èª¤"); return; }
            if(!ph) { alert("è«‹å¡«å¯«å€‹æ¡ˆæ‰‹æ©Ÿ"); return; }

            msg.innerText = "â³ æ­£åœ¨å­˜æª”ä¸­...";
            document.getElementById('btn-real-save').disabled = true;

            const fullData = collectDataFromUI();

            try {
                let uid = null;
                const { data: prof } = await myDB.from('profiles').select('id').eq('phone', ph).single();
                if(prof) uid = prof.id; 
                else {
                    const { data: np } = await myDB.from('profiles').insert([{phone: ph, full_name: nm}]).select().single();
                    uid = np.id;
                }

                const sum = document.getElementById('overall-summary').value;
                const dt = document.getElementById('info-date').value;
                const healer = document.getElementById('info-healer').value;

                let reportId = currentReportId;

                if (currentReportId) {
                    await myDB.from('reports').update({
                        summary: sum, raw_data: fullData, service_date: dt, healer_name: healer
                    }).eq('id', currentReportId);
                } else {
                    const { data: newR, error: ie } = await myDB.from('reports').insert([{
                        user_id: uid, service_date: dt, healer_name: healer,
                        summary: sum, raw_data: fullData
                    }]).select().single();
                    if(ie) throw ie;
                    reportId = newR.id;
                    currentReportId = newR.id;
                }

                if (currentBookingId) {
                    const linkText = `[å ±å‘Šå·²ç”Ÿæˆ ID:${reportId}]`;
                    const { data: oldB } = await myDB.from('bookings').select('wish_detail').eq('id', currentBookingId).single();
                    let newDetail = oldB.wish_detail;
                    if (!newDetail.includes("å ±å‘Šå·²ç”Ÿæˆ")) { newDetail += ` | ${linkText}`; }
                    await myDB.from('bookings').update({ status: 'completed', wish_detail: newDetail }).eq('id', currentBookingId);
                }

                msg.innerText = "âœ… å­˜æª”æˆåŠŸï¼è¨‚å–®å·²çµæ¡ˆã€‚";
                alert("å­˜æª”æˆåŠŸï¼");
                
            } catch(err) {
                console.error(err);
                msg.innerText = "âš ï¸ å­˜æª”å¤±æ•—: " + err.message;
                document.getElementById('btn-real-save').disabled = false;
            }
        }

        // --- 4. è®€å–èˆ‡å›å¡« ---
        async function loadReportData(reportId) {
            const msg = document.getElementById('status-msg');
            msg.innerText = "â³ æ­£åœ¨è®€å–æ­·å²è³‡æ–™...";
            const { data, error } = await myDB.from('reports').select('*').eq('id', reportId).single();
            if (error) { alert("è®€å–å¤±æ•—ï¼š" + error.message); return; }

            document.getElementById('info-date').value = data.service_date;
            document.getElementById('info-healer').value = data.healer_name;
            document.getElementById('overall-summary').value = data.summary || "";
            
            if (data.user_id) {
                const { data: prof } = await myDB.from('profiles').select('*').eq('id', data.user_id).single();
                if (prof) {
                    document.getElementById('info-name').value = prof.full_name;
                    document.getElementById('info-phone').value = prof.phone;
                }
            }

            let centersData = [];
            let addonsData = [];

            if (data.raw_data) {
                if (Array.isArray(data.raw_data)) {
                    centersData = data.raw_data;
                } else {
                    centersData = data.raw_data.centers || [];
                    addonsData = data.raw_data.addons || [];
                }
            }

            if (centersData) {
                centersData.forEach(item => {
                    const cid = item.id;
                    setStatus(cid, item.status);
                    if(item.val && item.val!=="--") document.getElementById(`val-${cid}`).value = item.val;
                    if(item.finalAdj && item.finalAdj!=="ç„¡é ˆèª¿æ•´" && item.finalAdj!=="100") document.getElementById(`adj-${cid}`).value = item.finalAdj;

                    if (item.raw_diags) {
                        const dbDynamic = CENTER_CONTENT[cid].dynamic;
                        item.raw_diags.forEach(d => {
                            let rawTxt = d.text || d.diag; 
                            if (!rawTxt) return;
                            const cleanTxt = rawTxt.substring(2).trim();
                            dbDynamic.forEach((def, idx) => {
                                if (def.defDiag === cleanTxt || def.undefDiag === cleanTxt || def.defAdj === cleanTxt || def.undefAdj === cleanTxt) {
                                    const cbs = document.getElementsByName(`diag-${cid}`);
                                    if(cbs[idx]) cbs[idx].checked = true;
                                }
                            });
                        });
                    }
                    if (item.content) {
                        const noteBlock = item.content.find(x => x.type === 'note');
                        if (noteBlock) document.getElementById(`note-${cid}`).value = noteBlock.text.replace("ğŸ’¡ è£œå……ï¼š", "");
                    }
                });
            }

            if (addonsData.length > 0) {
                detectedAddons = addonsData.map(a => a.name);
                renderAddonInputs(detectedAddons);
                addonsData.forEach((a, idx) => {
                    document.getElementById(`addon-val-${idx}`).value = a.val !== "--" ? a.val : "";
                    document.getElementById(`addon-adj-${idx}`).value = a.adj !== "--" ? a.adj : "";
                    document.getElementById(`addon-note-${idx}`).value = a.note || "";
                });
            }

            msg.innerText = "";
            generatePreview();
        }

        // --- 5. ç¹ªåœ– (Canvas) ---
        function drawClassicReport(fullData) {
            const reportData = fullData.centers; 
            const addonsData = fullData.addons;  

            const canvas = document.getElementById('mainCanvas');
            const ctx = canvas.getContext('2d');
            const canvasWidth = 2600;
            const headerHeight = 180;
            const ADJUST_CARD_HEIGHT = 380;
            const HEALTHY_CARD_HEIGHT = 130;
            const ADDON_CARD_H = 180; // åŠ è³¼å¡ç‰‡é«˜åº¦
            
            const healthyCenters = reportData.filter(item => item.finalAdj === "ç„¡é ˆèª¿æ•´");
            const adjustCenters = reportData.filter(item => item.finalAdj !== "ç„¡é ˆèª¿æ•´");
            
            const rightPanelX = 850; const rightPanelW = 1700; const gap = 40; 
            const colWidth = (rightPanelW - (gap * 2)) / 3;
            const colX = [rightPanelX, rightPanelX + colWidth + gap, rightPanelX + (colWidth + gap) * 2];
            const lineHeight = 22; 

            let currentY = headerHeight + 20; 
            let healthySectionY = currentY;
            let healthyColsY = [0, 0, 0];
            
            if (healthyCenters.length > 0) {
                currentY += 50; healthySectionY = currentY; 
                healthyCenters.forEach((item, index) => {
                    const colIdx = index % 3;
                    item.drawX = colX[colIdx]; item.drawY = currentY + healthyColsY[colIdx]; item.cardH = HEALTHY_CARD_HEIGHT;
                    healthyColsY[colIdx] += HEALTHY_CARD_HEIGHT + 20;
                });
                currentY += Math.max(...healthyColsY) + 20;
            }
            
            let adjustSectionY = currentY + 30; 
            let adjustColsY = [0, 0, 0];

            if (adjustCenters.length > 0) {
                currentY += 50; adjustSectionY = currentY;
                adjustCenters.forEach((item, index) => {
                    const colIdx = index % 3;
                    item.drawX = colX[colIdx]; item.drawY = currentY + adjustColsY[colIdx]; item.cardH = ADJUST_CARD_HEIGHT;
                    adjustColsY[colIdx] += ADJUST_CARD_HEIGHT + 20;
                });
                currentY += Math.max(...adjustColsY) + 20;
            }

            // è¨ˆç®—åŠ è³¼é …ç›®å€å¡Šé«˜åº¦
            let addonSectionH = 0;
            if (addonsData && addonsData.length > 0) {
                const rows = Math.ceil(addonsData.length / 3);
                addonSectionH = 100 + (rows * (ADDON_CARD_H + 20)) + 40; 
            }

            const overallSummary = document.getElementById('overall-summary').value.trim();
            let summaryH = 0; let sumLines = [];
            if (overallSummary) {
                ctx.font = "24px Microsoft JhengHei";
                sumLines = getLines(ctx, overallSummary, canvasWidth - 160);
                summaryH = 100 + (sumLines.length * 40) + 60; 
            }
            
            const totalH = Math.max(1350 + headerHeight, currentY + 50) + addonSectionH + summaryH;
            canvas.width = canvasWidth; canvas.height = totalH;
            
            ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, canvas.width, canvas.height);
            drawHeader(ctx, canvasWidth);

            ctx.save(); ctx.translate(0, headerHeight);
            
            // å·¦å´åˆ†éš”ç·š
            ctx.strokeStyle = "#e0e0e0"; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(800, 0); ctx.lineTo(800, totalH - headerHeight - addonSectionH - summaryH - 20); ctx.stroke();

            ctx.lineWidth = 3; ctx.strokeStyle = "#e0e0e0";
            CHANNELS.forEach(pair => {
                const c1 = CENTERS.find(c => c.id === pair[0]);
                const c2 = CENTERS.find(c => c.id === pair[1]);
                if(c1 && c2) { ctx.beginPath(); ctx.moveTo(c1.cx, c1.cy); ctx.lineTo(c2.cx, c2.cy); ctx.stroke(); }
            });

            // ç•« 9 å¤§ä¸­å¿ƒ (Bodygraph)
            reportData.forEach(item => {
                const x = item.cx; const y = item.cy; const w = item.w; const h = item.h;
                let bodyColor = (item.status === 'defined') ? HD_COLORS[item.id] : "#ffffff";
                let displayVal = item.val;
                let badgeColor = ENERGY_COLORS.green;
                if (displayVal !== "--") { if (parseInt(displayVal) <= 40) badgeColor = ENERGY_COLORS.red; else if (parseInt(displayVal) <= 70) badgeColor = ENERGY_COLORS.yellow; }

                ctx.beginPath();
                if (item.shape === 'square') ctx.rect(x-w/2, y-h/2, w, h);
                else if (item.shape === 'diamond') { ctx.moveTo(x, y-h/2); ctx.lineTo(x+w/2, y); ctx.lineTo(x, y+h/2); ctx.lineTo(x-w/2, y); ctx.closePath(); }
                else if (item.shape === 'tri-up') { ctx.moveTo(x, y-h/2); ctx.lineTo(x+w/2, y+h/2); ctx.lineTo(x-w/2, y+h/2); ctx.closePath(); }
                else if (item.shape === 'tri-down') { ctx.moveTo(x-w/2, y-h/2); ctx.lineTo(x+w/2, y-h/2); ctx.lineTo(x, y+h/2); ctx.closePath(); }
                else if (item.shape === 'tri-left') { ctx.moveTo(x-w/2, y-h/2); ctx.lineTo(x-w/2, y+h/2); ctx.lineTo(x+w/2, y); ctx.closePath(); }
                else if (item.shape === 'tri-right') { ctx.moveTo(x+w/2, y-h/2); ctx.lineTo(x+w/2, y+h/2); ctx.lineTo(x-w/2, y); ctx.closePath(); }
                else if (item.shape === 'tri-small') { ctx.moveTo(x-w/2, y); ctx.lineTo(x+w/2, y-h/2); ctx.lineTo(x+w/2, y+h/2); ctx.closePath(); }

                ctx.fillStyle = bodyColor; ctx.fill();
                ctx.lineWidth = 4; ctx.strokeStyle = "#444";
                ctx.setLineDash(item.status === 'open' ? [8, 6] : []); ctx.stroke(); ctx.setLineDash([]); 

                const textY = y + (item.textDy || 0);
                ctx.fillStyle = "#2c3e50"; ctx.font = "bold 20px Microsoft JhengHei"; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.lineWidth = 4; ctx.strokeStyle = "white";
                ctx.strokeText(item.label, x - 12, textY); ctx.fillText(item.label, x - 12, textY);   

                const badgeX = (x - 12) + (ctx.measureText(item.label).width / 2) + 28; const badgeY = textY - 2; 
                ctx.beginPath(); ctx.arc(badgeX, badgeY, 20, 0, Math.PI * 2); ctx.fillStyle = badgeColor; ctx.fill(); ctx.lineWidth = 2; ctx.strokeStyle = "#fff"; ctx.stroke();
                ctx.fillStyle = (displayVal !== "--" && parseInt(displayVal) <= 70 && badgeColor !== ENERGY_COLORS.green) ? "#333" : "#000";
                if (badgeColor === ENERGY_COLORS.red) ctx.fillStyle = "#fff";
                ctx.font = "bold 16px Arial"; ctx.fillText(displayVal === "--" ? "?" : displayVal, badgeX, badgeY);
            });
            ctx.restore();

            // ç•«å³å´å¡ç‰‡ (å¥åº·)
            if (healthyCenters.length > 0) {
                ctx.fillStyle = "#4a766e"; ctx.font = "bold 32px Microsoft JhengHei"; ctx.textAlign = "left";
                ctx.fillText("âœ… å¥åº·ç„¡é ˆèª¿æ•´çš„èƒ½é‡ä¸­å¿ƒ (è«‹ä¿æŒï¼)", rightPanelX, healthySectionY - 10);
                healthyCenters.forEach(item => {
                    const dx = item.drawX; const dy = item.drawY;
                    ctx.fillStyle = "#e8f5e9"; ctx.strokeStyle = "#c8e6c9"; ctx.lineJoin = "round"; ctx.lineWidth = 1;
                    ctx.strokeRect(dx, dy, colWidth, item.cardH); ctx.fillRect(dx, dy, colWidth, item.cardH);
                    ctx.fillStyle = HD_COLORS[item.id]; ctx.fillRect(dx, dy, colWidth, 4);
                    let cy = dy + 30; const px = dx + 20; 
                    const centerTheme = CENTER_THEMES[item.id] ? ` (${CENTER_THEMES[item.id]})` : '';
                    ctx.textAlign = "left"; ctx.fillStyle = "#2e7d32"; ctx.font = "bold 18px Microsoft JhengHei";
                    ctx.fillText(`${item.label}ä¸­å¿ƒ - [${item.statusLabel}] ${centerTheme}`, px, cy);
                    cy += 25; 
                    const staticBlock = item.content.find(b => b.type === 'static');
                    if (staticBlock) {
                        ctx.font = "15px Microsoft JhengHei"; ctx.fillStyle = "#4a6e4d";
                        const lines = getLines(ctx, staticBlock.text, colWidth - 40);
                        for(let line of lines.slice(0, 2)) { ctx.fillText(line, px, cy); cy += 18; }
                    }
                    cy += 8; ctx.font = "bold 16px Microsoft JhengHei"; ctx.fillStyle = "#1b5e20"; ctx.fillText("â­ ç‹€æ…‹è‰¯å¥½ï¼Œè«‹ä¿æŒæ¸…æ˜èˆ‡è¦ºå¯Ÿï¼", px, cy);
                });
            }

            // ç•«å³å´å¡ç‰‡ (èª¿æ•´)
            if (adjustCenters.length > 0) {
                let adjustTitleY = adjustSectionY - 40; if (healthyCenters.length === 0) adjustTitleY = healthySectionY - 10;
                ctx.fillStyle = "#c62828"; ctx.font = "bold 32px Microsoft JhengHei"; ctx.textAlign = "left";
                ctx.fillText("ğŸ› ï¸ æ­¤æ¬¡å¯¦æ–½éˆæ“ºèª¿é »çš„èƒ½é‡ä¸­å¿ƒ (é‡é»ï¼)", rightPanelX, adjustTitleY);
                adjustCenters.forEach(item => {
                    const dx = item.drawX; const dy = item.drawY;
                    ctx.fillStyle = "#fcfcfc"; ctx.strokeStyle = "#e0e0e0"; ctx.lineJoin = "round"; ctx.lineWidth = 1;
                    ctx.strokeRect(dx, dy, colWidth, item.cardH); ctx.fillRect(dx, dy, colWidth, item.cardH);
                    ctx.fillStyle = HD_COLORS[item.id]; ctx.fillRect(dx, dy, colWidth, 6);
                    let cy = dy + 32; const px = dx + 20; const cardBottom = dy + item.cardH - 15;
                    const canDraw = (y) => y < cardBottom;
                    const centerTheme = CENTER_THEMES[item.id] ? ` (${CENTER_THEMES[item.id]})` : '';
                    ctx.textAlign = "left"; ctx.fillStyle = "#2c3e50"; ctx.font = "bold 21px Microsoft JhengHei";
                    ctx.fillText(`${item.label}ä¸­å¿ƒ - [${item.statusLabel}] ${centerTheme}`, px, cy);
                    cy += 28; 
                    const staticBlock = item.content.find(b => b.type === 'static');
                    if (staticBlock && canDraw(cy)) {
                        ctx.font = "17px Microsoft JhengHei"; ctx.fillStyle = "#666";
                        const lines = getLines(ctx, staticBlock.text, colWidth - 40);
                        for(let line of lines) { if (!canDraw(cy)) break; ctx.fillText(line, px, cy); cy += 22; }
                    }
                    cy += 12;
                    if (canDraw(cy)) {
                        ctx.font = "bold 18px Microsoft JhengHei";
                        let currentX = px; ctx.fillStyle = "#2c3e50"; ctx.fillText("èƒ½é‡æª¢æ¸¬/èª¿æ•´é …ç›® ", currentX, cy); currentX += ctx.measureText("èƒ½é‡æª¢æ¸¬/èª¿æ•´é …ç›® ").width;
                        ctx.fillStyle = "#555"; ctx.fillText("æª¢æ¸¬æ•¸å€¼: ", currentX, cy); currentX += ctx.measureText("æª¢æ¸¬æ•¸å€¼: ").width;
                        ctx.fillStyle = "#d35400"; ctx.fillText(item.val, currentX, cy); currentX += ctx.measureText(item.val).width;
                        ctx.fillStyle = "#ccc"; ctx.fillText("  /  ", currentX, cy); currentX += ctx.measureText("  /  ").width;
                        ctx.fillStyle = "#555"; ctx.fillText("èª¿æ•´å¾Œæ•¸å€¼: ", currentX, cy); currentX += ctx.measureText("èª¿æ•´å¾Œæ•¸å€¼: ").width;
                        ctx.fillStyle = (item.finalAdj === "ç„¡é ˆèª¿æ•´") ? "#999" : "#27ae60"; ctx.fillText(item.finalAdj, currentX, cy);
                    }
                    cy += 28; 
                    const dynamicBlocks = item.content.filter(b => b.type !== 'static');
                    dynamicBlocks.forEach(block => {
                        if (!canDraw(cy)) return;
                        if (block.type === 'diag') { ctx.font = "17px Microsoft JhengHei"; ctx.fillStyle = "#c62828"; }
                        else if (block.type === 'adjust') { ctx.font = "17px Microsoft JhengHei"; ctx.fillStyle = "#0277bd"; }
                        else if (block.type === 'note') { ctx.font = "17px Microsoft JhengHei"; ctx.fillStyle = "#333"; }
                        const lines = getLines(ctx, block.text, colWidth - 40);
                        for(let line of lines) { if (canDraw(cy)) { ctx.fillText(line, px, cy); cy += lineHeight; } else break; }
                        cy += 4;
                    });
                });
            }

            // 5. ç¹ªè£½åŠ è³¼é …ç›® (Blue Cards)
            if (addonsData && addonsData.length > 0) {
                const sy = totalH - summaryH - addonSectionH;
                ctx.fillStyle = "#0277bd"; ctx.font = "bold 28px Microsoft JhengHei"; ctx.textAlign = "left";
                ctx.fillText("â• å®¢è£½åŒ–åŠ è³¼é …ç›®èª¿æ•´ï¼š", 80, sy + 40);

                let startY = sy + 60;
                let colsY = [0, 0, 0];
                addonsData.forEach((a, idx) => {
                    const colIdx = idx % 3;
                    const dx = colX[colIdx];
                    const dy = startY + colsY[colIdx];
                    
                    ctx.fillStyle = "#e1f5fe"; ctx.strokeStyle = "#81d4fa"; ctx.lineWidth = 1;
                    ctx.strokeRect(dx, dy, colWidth, ADDON_CARD_H); ctx.fillRect(dx, dy, colWidth, ADDON_CARD_H);
                    ctx.fillStyle = "#0288d1"; ctx.fillRect(dx, dy, colWidth, 5); 

                    let py = dy + 35; const px = dx + 20;
                    ctx.fillStyle = "#01579b"; ctx.font = "bold 22px Microsoft JhengHei";
                    ctx.fillText(a.name, px, py);
                    
                    py += 35;
                    ctx.font = "18px Microsoft JhengHei";
                    let cx = px; 
                    ctx.fillStyle = "#555"; ctx.fillText("æª¢æ¸¬ï¼š", cx, py); cx += 60;
                    ctx.fillStyle = "#d35400"; ctx.fillText(a.val || "--", cx, py); cx += 50;
                    ctx.fillStyle = "#555"; ctx.fillText("âœ èª¿æ•´å¾Œï¼š", cx, py); cx += 90;
                    ctx.fillStyle = "#2e7d32"; ctx.fillText(a.adj || "--", cx, py);

                    py += 35;
                    if (a.note) {
                        ctx.fillStyle = "#333"; ctx.font = "16px Microsoft JhengHei";
                        const lines = getLines(ctx, "ğŸ’¡ " + a.note, colWidth - 40);
                        for(let line of lines.slice(0, 3)) { ctx.fillText(line, px, py); py += 20; }
                    }
                    colsY[colIdx] += ADDON_CARD_H + 20;
                });
            }

            // 6. ç¹ªè£½ç¸½çµå€å¡Š (é»ƒ)
            if (overallSummary) {
                const sy = totalH - summaryH;
                ctx.fillStyle = "#fff8e1"; ctx.strokeStyle = "#ffecb3"; ctx.lineWidth = 2;
                ctx.strokeRect(50, sy, canvasWidth - 100, summaryH - 20); ctx.fillRect(50, sy, canvasWidth - 100, summaryH - 20);
                ctx.fillStyle = "#e65100"; ctx.font = "bold 28px Microsoft JhengHei"; ctx.textAlign = "left";
                ctx.fillText("ğŸ“ ç™‚ç™’å¸«ç¸½çµï¼š", 80, sy + 50);
                ctx.fillStyle = "#333"; ctx.font = "24px Microsoft JhengHei";
                let stY = sy + 100;
                sumLines.forEach(line => { ctx.fillText(line, 80, stY); stY += 40; });
            }

            const imgData = canvas.toDataURL("image/jpeg", 0.9);
            document.getElementById('final-image').src = imgData;
            document.getElementById('result-wrapper').style.display = 'block';
            document.getElementById('result-wrapper').scrollIntoView({behavior: "smooth"});
        }

        function drawHeader(ctx, width) {
            ctx.fillStyle = "#2c3e50"; ctx.font = "bold 56px Microsoft JhengHei"; ctx.textAlign = "center";
            ctx.fillText("äººé¡åœ–èƒ½é‡æª¢æ¸¬å ±è¡¨", width/2, 70);
            const boxW = width - 100; const boxX = 50; const boxY = 100; const boxH = 80;
            ctx.fillStyle = "#f1f8e9"; ctx.strokeStyle = "#c5e1a5"; ctx.lineWidth = 2;
            ctx.fillRect(boxX, boxY, boxW, boxH); ctx.strokeRect(boxX, boxY, boxW, boxH);
            const date = document.getElementById('info-date').value;
            const name = document.getElementById('info-name').value || "---";
            const healer = document.getElementById('info-healer').value || "---";
            const phone = document.getElementById('info-phone').value || "---";
            ctx.fillStyle = "#333"; ctx.font = "bold 24px Microsoft JhengHei"; ctx.textAlign = "left";
            const colW = boxW / 3;
            ctx.fillText(`èª¿æ•´æ—¥æœŸï¼š${date}`, boxX + 40, boxY + 50);
            ctx.fillText(`å§“åï¼š${name}`, boxX + colW + 40, boxY + 50);
            ctx.fillText(`æ‰‹æ©Ÿï¼š${phone}`, boxX + colW*2 + 40, boxY + 50);
        }

        function getLines(ctx, text, maxWidth) {
            const words = text.split(''); const lines = []; let currentLine = words[0];
            for (let i = 1; i < words.length; i++) {
                const width = ctx.measureText(currentLine + words[i]).width;
                if (width < maxWidth) { currentLine += words[i]; } 
                else { lines.push(currentLine); currentLine = words[i]; }
            }
            lines.push(currentLine); return lines;
        }
    </script>
</body>
</html>
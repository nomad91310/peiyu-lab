<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœå‹™å ±è¡¨ | åŸ¹ç™’è©¦é©—å®¤</title>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@600;900&display=swap" rel="stylesheet">

<style>
    /* ======================================================
       1. å…¨ç«™åŸºç¤è¨­å®š (Base Layout)
       ====================================================== */
    * { box-sizing: border-box; font-family: "Microsoft JhengHei", -apple-system, "Heiti TC", sans-serif; }
    body { background: #e0e5ec; padding: 30px; margin: 0; color: #333; line-height: 1.5; min-height: 100vh; }
    
    /* ä¸»å®¹å™¨ */
    .container { 
        background: white; padding: 30px; border-radius: 16px; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
        max-width: 1280px; margin: 0 auto; width: 100%; position: relative;
    }

    h2 { margin: 0 0 20px 0; text-align: center; color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 15px; font-size: 28px; font-weight: 900; }
    h3 { color:#e65100; margin-bottom:10px; font-size:16px; font-weight: bold; }

    /* ======================================================
       2. é ‚éƒ¨è³‡æ–™è¼¸å…¥å€ (Header Inputs)
       ====================================================== */
    .header-inputs { 
        display: grid; 
        /* ğŸ”¥ ä¿®æ”¹ï¼šåŸæœ¬æ˜¯ repeat(4, 1fr)ï¼Œæ”¹æˆé€™æ¨£æ¯”è¼ƒå½ˆæ€§ */
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
        gap: 15px;
        background: #f0f4f8; padding: 20px; border-radius: 12px; 
        margin-bottom: 25px; border: 1px solid #dcebf7; 
    }
    .header-group label { display: block; font-size: 14px; color: #1565c0; font-weight: bold; margin-bottom: 6px; }
    .header-group input { width: 100%; padding: 10px; border: 1px solid #90caf9; border-radius: 6px; font-size: 15px; background: #fff; }

    /* ======================================================
       3. æ ¸å¿ƒèƒ½é‡å€ (Core Metrics)
       ====================================================== */
    .core-metrics-container { 
        display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; 
        background: linear-gradient(135deg, #fff3e0 0%, #fffbf5 100%); 
        padding: 20px; border-radius: 15px; border: 1px solid #ffe0b2; 
        box-shadow: inset 0 2px 4px rgba(230, 81, 0, 0.05);
    }
    .metric-card { 
        background: white; padding: 12px 15px; border-radius: 12px; border: 1px solid #ffe0b2; 
        display: flex; align-items: center; justify-content: space-between; transition: all 0.2s;
    }
    .metric-card:hover { border-color: #ffb300; transform: translateY(-1px); }
    .metric-title { font-weight: bold; color: #e65100; font-size: 14px; white-space: nowrap; }
    .metric-inputs { display: flex; gap: 8px; align-items: center; }
    .metric-inputs select { width: 90px; height: 34px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; padding: 0 5px; background: #fff; color: #333; }
    .metric-inputs input { width: 55px; height: 32px; border: 1px solid #ddd; border-radius: 6px; text-align: center; font-size: 14px; }
    .adj-fixed { color: #2e7d32; font-weight: bold; font-size: 14px; padding-left: 8px; white-space: nowrap; }

    /* ======================================================
       4. åŠ è³¼é …ç›®å€ (Addons)
       ====================================================== */
    #addon-section-wrapper { margin-bottom: 25px; display: none; } /* é è¨­éš±è—ï¼Œæœ‰è³‡æ–™æ‰é¡¯ç¤º */
    #addon-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
    .addon-card { 
        border: 1px solid #b3e5fc; background: #f1f8e9; padding: 12px; border-radius: 8px; 
        position: relative; overflow: hidden; border-left: 6px solid #0288d1;
    }
    .addon-title { font-weight:bold; color:#0277bd; margin-bottom:10px; font-size: 14px; padding-bottom: 5px; border-bottom: 1px solid #eee; }

    /* ======================================================
       5. ä¹å¤§ä¸­å¿ƒå¡ç‰‡ (Centers Grid)
       ====================================================== */
    #inputs-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 20px; }

    .center-card { 
        background: #fff; border: 1px solid #e0e0e0; border-radius: 12px; 
        padding: 0 !important; box-shadow: 0 4px 10px rgba(0,0,0,0.03); 
        position: relative; overflow: hidden; transition: transform 0.2s;
    }
    .center-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.08); }

    /* å·¦å´è‰²æ¢æŒ‡ç¤º */
    .center-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px; z-index: 2; }
    .center-card[data-color="head"]::before { background: #e8e6a5; }
    .center-card[data-color="ajna"]::before { background: #a7d28b; }
    .center-card[data-color="throat"]::before { background: #c6a87c; }
    .center-card[data-color="g"]::before { background: #f4eb68; }
    .center-card[data-color="ego"]::before { background: #e85d5d; }
    .center-card[data-color="solar"]::before { background: #c69c6d; }
    .center-card[data-color="spleen"]::before { background: #c69c6d; }
    .center-card[data-color="sacral"]::before { background: #e85d5d; }
    .center-card[data-color="root"]::before { background: #c69c6d; }

    /* Header å¡«è‰²èˆ‡ä½ˆå±€ */
    .center-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px 12px 20px; }
    .center-card[data-color="head"] .center-header { background: #fdfdec; }
    .center-card[data-color="ajna"] .center-header { background: #f4f9f0; }
    .center-card[data-color="throat"] .center-header { background: #f9f5f0; }
    /* (å…¶é¤˜ä¸­å¿ƒé è¨­ç™½åº•æˆ–æ·¡è‰²) */

    .center-title { font-size: 15px; font-weight: bold; color: #333; }
    .status-group { transform: scale(0.9); display: flex; gap: 4px; transform-origin: right center; }
    .status-btn { padding: 4px 8px; font-size: 12px; border: 1px solid #ccc; background: #fff; border-radius: 4px; cursor: pointer; transition: 0.2s; }
    .status-btn.active { background: #34495e; color: white; border-color: #34495e; }

    /* å¡ç‰‡å…§éƒ¨å…ƒä»¶ */
    .diagnosis-area, .input-row, .custom-note-area { margin: 0 15px 12px 15px !important; }
    .diagnosis-area { background: #fafafa; padding: 12px; border-radius: 8px; border: 1px dashed #ddd; }
    .checkbox-item { display: flex; align-items: flex-start; gap: 8px; font-size: 13px; margin-bottom: 6px; cursor: pointer; color: #555; }
    .checkbox-item:hover { color: #000; }
    .checkbox-item input { margin-top: 3px; accent-color: #e65100; }

    .input-row { display: flex; gap: 10px; }
    .input-group { flex: 1; }
    .input-group label { display: block; font-size: 11px; color: #777; margin-bottom: 4px; }
    .input-group input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; text-align: center; font-weight: bold; color: #333; }

    .custom-note-area textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; height: 55px; resize: vertical; background: #fffdf9; }

    /* ======================================================
       6. ç¸½çµèˆ‡æ“ä½œå€ (Summary & Actions)
       ====================================================== */
    .summary-section { 
        background: #fffdf7; border: 1px solid #f1e4bc; border-radius: 16px; 
        padding: 25px; margin-top: 30px; box-shadow: 0 4px 15px rgba(245, 127, 23, 0.08); 
        position: relative; overflow: hidden;
    }
    .summary-section::before { content: ""; position: absolute; left: 0; top: 0; bottom: 0; width: 8px; background: linear-gradient(to bottom, #f57f17, #ffb300); }
    .summary-section label { font-size: 18px; color: #f57f17; font-weight: bold; display: flex; align-items: center; gap: 8px; margin-bottom: 15px; }
    .summary-section textarea { 
        width: 100%; height: 180px; padding: 15px; border: 1px solid #eee; border-radius: 10px; 
        font-size: 16px; line-height: 1.8; color: #444; resize: vertical; 
        font-family: "Microsoft JhengHei", sans-serif !important; 
    }

    .action-bar { display: flex; gap: 15px; margin-top: 30px; }
    .btn { width: 100%; padding: 18px; color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
    .btn-preview { background: #546e7a; }
    .btn-save { background: #2e7d32; }
    .btn:hover { opacity: 0.9; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.2); }
    .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }

    #status-msg { margin-top: 15px; text-align: center; color: #666; font-weight: bold; }

    /* ======================================================
       7. çµæœé è¦½èˆ‡ä¸‹è¼‰ (Results)
       ====================================================== */
    #result-wrapper { display: none; margin-top: 40px; text-align: center; }
    #final-image { max-width: 100%; border-radius: 12px; box-shadow: 0 15px 35px rgba(0,0,0,0.2); border: 1px solid #eee; }
    .save-hint { background: #e8f5e9; color: #2e7d32; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-weight: bold; display: inline-block; }
    .canvas-container { display: none; } /* éš±è—å¯¦éš›ç¹ªåœ–ç”¨çš„ Canvas */

    /* ======================================================
       8. å®¢äººç€è¦½æ¨¡å¼ (View Mode)
       ====================================================== */
    .back-btn { position: fixed; top: 20px; left: 20px; background: white; border: 1px solid #ccc; padding: 8px 15px; border-radius: 20px; cursor: pointer; display: none; z-index: 999; box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-weight: bold; color: #555; }
    
    body.view-mode .back-btn { display: block; }

    /* éš±è—ç·¨è¼¯å€å¡Š */
    body.view-mode h2, body.view-mode h3, 
    body.view-mode .header-inputs, body.view-mode .core-metrics-container, 
    body.view-mode #addon-section-wrapper, body.view-mode #inputs-container, 
    body.view-mode .summary-section, body.view-mode .action-bar,
    body.view-mode .save-hint { display: none !important; }

    /* èª¿æ•´å®¹å™¨èˆ‡çµæœé¡¯ç¤º */
    body.view-mode .container { background: transparent !important; box-shadow: none !important; padding: 0; max-width: 100%; }
    body.view-mode #result-wrapper { display: block !important; margin-top: 0; }
    body.view-mode #final-image { display: block; margin: 0 auto; width: 100%; max-width: 2600px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }

    /* å®¢äººä¸‹è¼‰æŒ‰éˆ• */
    #guest-dl-btn { 
        display: none; margin: 20px auto; background: #c6a87c; color: white; 
        font-size: 18px; font-weight: bold; padding: 15px 40px; border: none; 
        border-radius: 50px; cursor: pointer; box-shadow: 0 5px 15px rgba(198, 168, 124, 0.4); 
        transition: transform 0.2s; 
    }
    #guest-dl-btn:hover { transform: translateY(-2px); background: #b0936a; }
    body.view-mode #guest-dl-btn { display: inline-block !important; }

    /* ======================================================
       9. éŸ¿æ‡‰å¼èª¿æ•´ (Mobile)
       ====================================================== */
    @media (max-width: 768px) { 
        .header-inputs { grid-template-columns: 1fr 1fr; } 
        .core-metrics-container { grid-template-columns: 1fr; }
        #inputs-container { grid-template-columns: 1fr; } 
        .input-row { flex-direction: row; } 
        h2 { font-size: 22px; }
    }
</style>
</head>
<body>
    <button class="back-btn" onclick="window.close()">â† é—œé–‰è¦–çª—</button>

    <div class="container">
        <h2 id="page-title">ğŸ”® æœå‹™å ±è¡¨</h2>
        
       <div class="header-inputs">
            <div class="header-group"><label>èª¿æ•´æ—¥æœŸ</label><input type="date" id="info-date"></div>
            <div class="header-group phone-group"><label>å€‹æ¡ˆæ‰‹æ©Ÿ</label><input type="tel" id="info-phone" placeholder="ç³»çµ±è‡ªå‹•å¸¶å…¥"></div>
            <div class="header-group"><label>å€‹æ¡ˆå§“å</label><input type="text" id="info-name" placeholder="ç³»çµ±è‡ªå‹•å¸¶å…¥"></div>
            
            <div class="header-group"><label>Email (é¸å¡«)</label><input type="email" id="info-email" placeholder="æœƒå“¡ç™»å…¥ç”¨"></div>
            
            <div class="header-group"><label>ç™‚ç™’å¸«</label><input type="text" id="info-healer" value="åŸ¹ç™’è©¦é©—å®¤"></div>
        </div>

        <h3>âš¡ æ ¸å¿ƒèƒ½é‡ & åŠ è³¼ (å¿…å¡«å€)</h3>
        <div class="core-metrics-container">
            <div class="metric-card">
                <div class="metric-title">ğŸ”¥ ç”Ÿå‘½åŠ›</div>
                <div class="metric-inputs">
                    <select id="core-val-0">
                        <option value="ä½">æª¢æ¸¬ï¼šä½</option>
                        <option value="ä¸­" selected>æª¢æ¸¬ï¼šä¸­</option>
                        <option value="é«˜">æª¢æ¸¬ï¼šé«˜</option>
                    </select>
                    <span class="adj-fixed">â” èª¿æ•´ï¼šé«˜</span>
                    <input type="hidden" id="core-adj-0" value="é«˜">
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-title">ğŸš€ åŸ·è¡ŒåŠ›</div>
                <div class="metric-inputs">
                    <select id="core-val-1">
                        <option value="ä½">æª¢æ¸¬ï¼šä½</option>
                        <option value="ä¸­" selected>æª¢æ¸¬ï¼šä¸­</option>
                        <option value="é«˜">æª¢æ¸¬ï¼šé«˜</option>
                    </select>
                    <span class="adj-fixed">â” èª¿æ•´ï¼šé«˜</span>
                    <input type="hidden" id="core-adj-1" value="é«˜">
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-title">ğŸ¨ å‰µé€ åŠ›</div>
                <div class="metric-inputs">
                    <select id="core-val-2">
                        <option value="ä½">æª¢æ¸¬ï¼šä½</option>
                        <option value="ä¸­" selected>æª¢æ¸¬ï¼šä¸­</option>
                        <option value="é«˜">æª¢æ¸¬ï¼šé«˜</option>
                    </select>
                    <span class="adj-fixed">â” èª¿æ•´ï¼šé«˜</span>
                    <input type="hidden" id="core-adj-2" value="é«˜">
                </div>
            </div>
        </div>

        <div id="addon-section-wrapper"><div id="addon-container"></div></div>
        
        <div id="inputs-container" style="margin-top:20px;"></div>

        <div class="summary-section">
            <label>ğŸ“ ç™‚ç™’å¸«ç¸½çµ</label>
            <textarea id="overall-summary" placeholder="è«‹è¼¸å…¥ç¸½çµ...æ”¯æ´ Enter æ›è¡Œ"></textarea>
        </div>
        
        <div id="status-msg"></div>

        <div class="action-bar">
            <button class="btn btn-preview" onclick="generatePreview()">ğŸ“¸ ç”Ÿæˆåœ–ç‰‡é è¦½</button>
            <button class="btn btn-save" id="btn-real-save" onclick="saveToDatabase()">ğŸ’¾ ç¢ºèªå­˜æª”ä¸¦çµæ¡ˆ</button>
        </div>

        <div id="result-wrapper">
            <div class="save-hint">âœ… åœ–ç‰‡å·²ç”Ÿæˆï¼Œè«‹å³éµå¦å­˜åœ–ç‰‡</div><br>
            <button id="guest-dl-btn" onclick="downloadReportImage()">ğŸ“¥ ä¸‹è¼‰æˆ‘çš„èƒ½é‡å ±å‘Š</button>
            <br>
            <img id="final-image" alt="Generated Report" />
        </div>
    </div>

    <div class="canvas-container"><canvas id="mainCanvas"></canvas></div>

    <script>
        const SB_URL = "https://geyrpowhaqfhnxghpokr.supabase.co"; 
        const SB_KEY = "sb_publishable_aXucdq8UtvMbCKbriqpJCw_gtpYBw-r";
        let myDB = null; 
        let currentBookingId = null;
        let currentReportId = null;
        let detectedAddons = []; 
        let isViewMode = false;
        let currentMainService = "";

        const MANDATORY_CHECKS = ["ç”Ÿå‘½åŠ›", "åŸ·è¡ŒåŠ›", "å‰µé€ åŠ›"];
        const HD_COLORS = { head: '#e8e6a5', ajna: '#a7d28b', throat: '#c6a87c', g: '#f4eb68', ego: '#ff9b9b', solar: '#c69c6d', spleen: '#c69c6d', sacral: '#ff9b9b', root: '#c69c6d' };
        const ENERGY_COLORS = { red: '#ff5252', yellow: '#ffd740', green: '#69f0ae' };
        const CENTER_THEMES = { head: 'éˆæ„Ÿãƒ»å£“åŠ›ãƒ»ç–‘å•', ajna: 'æ¦‚å¿µãƒ»ä¿¡å¿µãƒ»åˆ†æ', throat: 'é¡¯åŒ–ãƒ»æºé€šãƒ»è¡Œå‹•', g: 'æ„›ãƒ»æ–¹å‘ãƒ»èªåŒ', ego: 'åƒ¹å€¼æ„Ÿãƒ»æ‰¿è«¾ãƒ»å‹•åŠ›', solar: 'æƒ…ç·’ãƒ»æ„Ÿå—ãƒ»ç¥ç¶“ç³»çµ±', spleen: 'ç”Ÿå­˜ãƒ»ç›´è¦ºãƒ»å¥åº·', sacral: 'ç”Ÿç”¢åŠ›ãƒ»æ€§ãƒ»ç”Ÿå‘½åŠ›', root: 'å£“åŠ›ãƒ»è¡å‹ãƒ»è…ä¸Šè…º' };

        const CENTER_CONTENT = {
            head: { label: "é ­è…¦", organ: "æ¾æœé«”", static: { defined: "å¤©ç”Ÿæœ‰å›ºå®šçš„æ€è€ƒæ¨¡å¼ã€‚å¥åº·æ™‚èƒ½äº«å—æ€è€ƒå£“åŠ›ï¼Œå•Ÿç™¼ä»–äººï¼›ä¸å¥åº·æ™‚å›°åœ¨è‡ªå·±çš„å•é¡Œè£¡æ†‚é¬±ï¼Œæˆ–å°ä»–äººæ¼ ä¸é—œå¿ƒã€‚", undefined: "éˆæ„Ÿä¾†è‡ªå››é¢å…«æ–¹ã€‚å¥åº·æ™‚èƒ½å€åˆ†ä»€éº¼å•é¡Œé‡è¦ï¼›ä¸å¥åº·æ™‚æœƒæŠŠåˆ¥äººçš„å•é¡Œæ”¬åœ¨èº«ä¸Šï¼Œæ€¥æ–¼è§£æ±ºè…¦ä¸­å›°æƒ‘ã€‚", open: "å°éˆæ„Ÿå®Œå…¨é–‹æ”¾ã€‚å¥åº·æ™‚äº«å—æœªçŸ¥ï¼›ä¸å¥åº·æ™‚æœƒè¿·å¤±åœ¨è³‡è¨Šæµ·ä¸­ï¼Œä¸çŸ¥é“ä»€éº¼å°è‡ªå·±é‡è¦ã€‚" }, dynamic: [ { label: "å›°åœ¨è…¦ä¸­/æ†‚é¬± (å…§ç¸®)", defDiag: "æ€è€ƒå…§æ²é™·å…¥å°é–‰è¿´åœˆï¼Œè…¦å£“éé«˜å°è‡´ä½æ½®ã€‚", defAdj: "é‡‹æ”¾ç´¯ç©å…§åœ¨å£“åŠ›ï¼ŒåŠ©æ€ç·’é‡æ–°æµå‹•é€£çµå¤–ç•Œã€‚", undefDiag: "å¸æ”¶ç’°å¢ƒæ··äº‚æ€ç·’ç„¡æ³•éæ¿¾ï¼Œå¤§è…¦ç•¶æ©Ÿæ·±å±¤ç–²æ†Šã€‚", undefAdj: "æ¸…ç†å¤–ä¾†é›œè¨Šï¼ŒåŠ©å¤§è…¦é—œæ©Ÿé‡‹æ”¾ä¸å±¬æ–¼ä½ çš„ç…©æƒ±ã€‚", isHealthy: false }, { label: "é›å©†/ç„¦æ…®è¡Œå‹• (å¤–é¡¯)", defDiag: "æ€¥æ–¼æ‰¾ç­”æ¡ˆè€Œè¡å‹•è¡Œäº‹ï¼Œæ¶ˆé™¤ç–‘æƒ‘å£“åŠ›æœªçœ‹æ¸…å…¨è²Œã€‚", defAdj: "å®‰æ’«æ€¥èºè…¦æ³¢ï¼Œå”åŠ©å­¸æœƒç­‰å¾…éˆæ„Ÿè‡ªç„¶æµ®ç¾ã€‚", undefDiag: "æŠŠä»–äººå•é¡Œç•¶è²¬ä»»ï¼Œæ€¥æ–¼å¹«å¿™è§£æ±ºä»¥ç´“è§£å£“åŠ›ã€‚", undefAdj: "åˆ‡æ–·éå·±è²¬ä»»èƒ½é‡ï¼Œå”åŠ©åŠƒæ¸…ç•Œç·šæ”¾ä¸‹ä»–äººå•é¡Œã€‚", isHealthy: false }, { label: "å¤±çœ /åœä¸ä¸‹ä¾† (å¤±èª¿)", defDiag: "èº«é«”ç´¯å¤§è…¦ä»æ…£æ€§é‹è½‰ï¼ŒåŸ·è‘—æƒ³é€šæŸäº‹è‡´å¤±çœ ã€‚", defAdj: "æ³¨å…¥æ·±å±¤æ”¾é¬†é »ç‡ï¼Œå¼·åˆ¶æ¾æœé«”é€²å…¥ä¼‘çœ æ¨¡å¼ã€‚", undefDiag: "ç¡å‰å—é«˜å£“ç’°å¢ƒå½±éŸ¿ï¼Œä¸çŸ¥éå·±å£“åŠ›è€ŒæŒçºŒç©ºè½‰ã€‚", undefAdj: "å»ºç«‹é ‚è¼ªé˜²è­·ç½©ï¼Œéæ¿¾å¤œé–“é›†é«”æ½›æ„è­˜å¹²æ“¾ã€‚", isHealthy: false }, { label: "å¥åº· (ç¶ ç‡ˆ)", defDiag: "èƒ½é‡é‹ä½œè‰¯å¥½ã€‚æ¾æœé«”é‹ä½œæ¸…æ™°ã€‚", undefDiag: "é ­è…¦æ¸…æ˜ï¼Œä¸ç‚ºä»–äººå•é¡Œç…©æƒ±ã€‚", adjust: "", isHealthy: true } ] },
            ajna: { label: "é‚è¼¯", organ: "è…¦ä¸‹å‚é«”", static: { defined: "äº«å—ç ”ç©¶ï¼Œæœ‰ç©©å›ºè§€é»ã€‚å¥åº·æ™‚æ€ç·’æ¸…æ™°ï¼›ä¸å¥åº·æ™‚å›ºåŸ·å·±è¦‹ï¼Œè½ä¸é€²åˆ¥äººçš„è©±ï¼Œæˆ–ç„¦æ…®æ–¼ã€Œæ²’åšåˆ°ã€ã€‚", undefined: "æ€è€ƒæœ‰å½ˆæ€§ã€‚å¥åº·æ™‚èƒ½æ¥ç´å„ç¨®è§€é»ï¼›ä¸å¥åº·æ™‚æ“”å¿ƒè‡ªå·±ä¸è°æ˜ï¼Œæˆ–ç‚ºäº†å‡è£ç¢ºå®šè€Œè®Šå¾—æ¯”å·²å®šç¾©æ›´å›ºåŸ·ã€‚", open: "å¿ƒæ™ºåƒç™½ç´™ã€‚å¥åº·æ™‚å®¢è§€ä¸­ç«‹ï¼›ä¸å¥åº·æ™‚å› ç‚ºç¼ºä¹å®šè¦‹è€Œæ¥µåº¦ä¸å®‰ï¼Œç„¡æ³•åšæ±ºå®šã€‚" }, dynamic: [ { label: "ç„¦æ…®/è‡ªè²¬ (å…§ç¸®)", defDiag: "å¿ƒæ™ºç„¦æ…®æƒ³é€šå³åšåˆ°ï¼Œå› ç¾å¯¦è½å·®é™·å…¥è‡ªè²¬æ‰¹åˆ¤ã€‚", defAdj: "æ•´åˆæ€è€ƒèˆ‡è¡Œå‹•è½å·®ï¼Œé‡‹æ”¾ä¸å¤ åŠªåŠ›çš„è‡ªè²¬æ„Ÿã€‚", undefDiag: "å› ç„¡å›ºå®šæƒ³æ³•è€Œä¸å®‰ï¼Œæ€•é¡¯ç„¡çŸ¥è€Œè‡ªæˆ‘æ‡·ç–‘ã€‚", undefAdj: "è½‰åŒ–å°æœªçŸ¥ææ‡¼ï¼Œå”åŠ©æ¥ç´ä¸ç¢ºå®šä¹Ÿæ˜¯ä¸€ç¨®æ™ºæ…§ã€‚", isHealthy: false }, { label: "å›ºåŸ·/å‡è£ç¢ºå®š (å¤–é¡¯)", defDiag: "æ€ç¶­åƒµåŒ–å¤ªä¿¡é‚è¼¯ï¼Œè½ä¸é€²å»ºè­°é–åœ¨è±¡ç‰™å¡”ã€‚", defAdj: "è»ŸåŒ–åƒµå›ºä¿¡å¿µçµæ§‹ï¼Œå¢å¿ƒæ™ºå½ˆæ€§è½è¦‹ä¸åŒè²éŸ³ã€‚", undefDiag: "æ©é£¾ä¸ç¢ºå®šæ„Ÿè€Œå‡è£å …å®šï¼Œæ­»å®ˆå€Ÿä¾†çš„è§€é»ä¸æ”¾ã€‚", undefAdj: "é‡‹æ”¾é˜²è¡›æ©Ÿåˆ¶ï¼Œå¸ä¸‹å¿…é ˆå…¨çŸ¥å…¨èƒ½çš„å½è£é¢å…·ã€‚", isHealthy: false }, { label: "å°ˆæ³¨åŠ›æ¸™æ•£ (å¤±èª¿)", defDiag: "è…¦ä¸‹å‚é«”å£“åŠ›éå¤§ï¼Œé‚è¼¯ç·šæ–·è£‚è‡´æ€ç·’æ··äº‚ã€‚", defAdj: "ä¿®å¾©çœ‰å¿ƒè¼ªèƒ½é‡ï¼Œå”åŠ©é‡æ–°èšç„¦æ‰¾å›çµ„ç¹”åŠ›ã€‚", undefDiag: "å¿ƒæ™ºè¢«è³‡è¨Šæ·¹æ²’ï¼Œè©¦åœ–è™•ç†éé‡è¨Šæ¯è€Œç•¶æ©Ÿã€‚", undefAdj: "æ¸…ç†å¿ƒæ™ºç·©å­˜å€ï¼Œåˆªé™¤ç„¡ç”¨è³‡è¨Šåƒåœ¾ã€‚", isHealthy: false }, { label: "å¥åº· (ç¶ ç‡ˆ)", defDiag: "èƒ½é‡é‹ä½œè‰¯å¥½ã€‚é‚è¼¯æ¸…æ™°ã€‚", undefDiag: "æ€ç¶­éˆæ´»ï¼Œèƒ½å®¢è§€çœ‹å¾…ä¸åŒè³‡è¨Šã€‚", adjust: "", isHealthy: true } ] },
            throat: { label: "å–‰åš¨", organ: "ç”²ç‹€è…º", static: { defined: "æœ‰å›ºå®šè¡¨é”æ¨¡å¼ã€‚å¥åº·æ™‚èªªè©±æœ‰åŠ›é‡ï¼›ä¸å¥åº·æ™‚å–‹å–‹ä¸ä¼‘ã€æ’å˜´ï¼Œæˆ–å…‰èªªä¸ç·´ã€‚", undefined: "è²éŸ³å¤šè®Šã€‚å¥åº·æ™‚æ²‰é»˜è‡ªåœ¨ï¼Œä¸€å­—åƒé‡‘ï¼›ä¸å¥åº·æ™‚ç‚ºäº†åšé—œæ³¨è€Œäº‚èªªè©±ï¼Œæˆ–éåº¦èªªè©±å¡«è£œç©ºç™½ã€‚", open: "ç„¡å›ºå®šè²éŸ³ã€‚å¥åº·æ™‚èƒ½æ¨¡ä»¿å„ç¨®å£éŸ³ï¼›ä¸å¥åº·æ™‚ä¸çŸ¥é“æ€éº¼è¡¨é”è‡ªå·±ï¼Œèªªå‡ºä¾†çš„è©±å¸¸è¢«èª¤è§£ã€‚" }, dynamic: [ { label: "æœ‰å£é›£è¨€/å£“æŠ‘ (å…§ç¸®)", defDiag: "å› å—æŒ«æˆ–åˆ¶ç´„é¸æ“‡åå¿ï¼ŒçœŸå¯¦æƒ³æ³•é–æ­»åœ¨å–‰è¼ªã€‚", defAdj: "ç–é€šé¡¯åŒ–ç®¡é“ï¼Œå”åŠ©æ‰¾å›ç‚ºè‡ªå·±ç™¼è²çš„å‹‡æ°£ã€‚", undefDiag: "ä¸çŸ¥å¦‚ä½•è¡¨é”ï¼Œæ€•èªªéŒ¯è©±å°è‡´èƒ½é‡æ·¤ç©ã€‚", undefAdj: "æ¸…ç†è¡¨é”é€šé“ç„¦æ…®ï¼Œå”åŠ©ä¿¡ä»»è‡ªå·±çš„è²éŸ³ã€‚", isHealthy: false }, { label: "å–‹å–‹ä¸ä¼‘ (å¤–é¡¯)", defDiag: "æ€¥æ–¼è¡¨é”å¿½ç•¥æ™‚æ©Ÿï¼Œæ’å˜´å°è‡´èªè¨€å¤±å»é‡é‡ã€‚", defAdj: "å¹³è¡¡å–‰è¼ªèºå‹•èƒ½é‡ï¼Œå”åŠ©å­¸æœƒç­‰å¾…èˆ‡è†è½ã€‚", undefDiag: "æ€•ç©ºæ°£å®‰éœè€Œå¼·è¿«èªªè©±ï¼Œåˆ·å­˜åœ¨æ„Ÿè€—ææ°£å ´ã€‚", undefAdj: "å®‰ä½æ–¼å…§åœ¨ï¼Œå”åŠ©äº«å—æ²‰é»˜ä¹Ÿæ˜¯ä¸€ç¨®åŠ›é‡ã€‚", isHealthy: false }, { label: "å…‰èªªä¸ç·´/ç©ºè«‡ (å¤±èª¿)", defDiag: "èƒ½é‡åœåœ¨å˜´å·´ï¼Œè¨ˆç•«å¤šå»ç„¡è½åœ°åŸ·è¡ŒåŠ›ã€‚", defAdj: "é€£çµå–‰è¼ªèˆ‡å‹•åŠ›ä¸­å¿ƒï¼Œå°‡èªè¨€è½‰åŒ–ç‚ºå…·é«”åŸ·è¡Œã€‚", undefDiag: "è¿åˆæ°£æ°›èªªéŒ¯è©±ï¼Œæ‰¿è«¾åšä¸åˆ°çš„äº‹å°è‡´å¤±è¡¡ã€‚", undefAdj: "æ ¡æº–èªè¨€èƒ½é‡ï¼Œå”åŠ©è¨€è¡Œä¸€è‡´ã€‚", isHealthy: false }, { label: "å¥åº· (ç¶ ç‡ˆ)", defDiag: "èƒ½é‡é‹ä½œè‰¯å¥½ã€‚è¡¨é”çœŸå¯¦æœ‰åŠ›ã€‚", undefDiag: "éš¨é †å› ç·£ç™¼è²ï¼Œæ²‰é»˜ä¹Ÿè‡ªåœ¨ã€‚", adjust: "", isHealthy: true } ] },
            g: { label: "G", organ: "è‚è‡Ÿ", static: { defined: "æ„›èˆ‡æ–¹å‘æ˜¯å›ºå®šçš„ã€‚å¥åº·æ™‚è‡ªä¿¡å …å®šï¼›ä¸å¥åº·æ™‚å¼·å‹¢æ§åˆ¶ï¼Œè¦æ±‚åˆ¥äººç…§ä½ çš„æ–¹å¼èµ°ã€‚", undefined: "å ´æ‰€çš„è®Šè‰²é¾ã€‚å¥åº·æ™‚éš¨é‡è€Œå®‰ï¼›ä¸å¥åº·æ™‚ç‚ºäº†è¨æ„›è€Œå§”å±ˆè‡ªå·±ï¼Œæˆ–ç˜‹ç‹‚å°‹æ‰¾ã€Œæˆ‘æ˜¯èª°ã€ã€‚", open: "ç„¡èº«åˆ†æ¨™ç±¤ã€‚å¥åº·æ™‚æ˜¯å®¢è§€è§€å¯Ÿè€…ï¼›ä¸å¥åº·æ™‚å› ç‚ºç¼ºä¹é‚Šç•Œæ„Ÿè€Œå¾¹åº•è¿·å¤±ã€‚" }, dynamic: [ { label: "ç¼ºä¹è‡ªæ„›/è¨å¥½ (å…§ç¸®)", defDiag: "ç‚ºç¶­æŒé—œä¿‚èƒŒå›åŸå‰‡ï¼Œå£“æŠ‘çœŸå¯¦è‡ªæˆ‘æ„Ÿåˆ°å§”å±ˆã€‚", defAdj: "ä¿®è£œèƒ½é‡å ´ç ´æ´ï¼Œæ³¨å…¥æ„›è‡ªå·±é »ç‡é‡å¡‘é‚Šç•Œã€‚", undefDiag: "è¨æ„›è€Œéåº¦é…åˆï¼Œèª¤ä»¥ç‚ºæ„›éœ€äº¤æ›è€Œè¿åˆã€‚", undefAdj: "æ³¨å…¥ç„¡æ¢ä»¶çš„æ„›ï¼Œå”åŠ©æ˜ç™½ä½ æœ¬èº«å°±å€¼å¾—è¢«æ„›ã€‚", isHealthy: false }, { label: "å¼·å‹¢/æ§åˆ¶ç‹‚ (å¤–é¡¯)", defDiag: "éæ–¼å …æŒåŸå‰‡ï¼Œå¼·è¿«ä»–äººç…§ä½ æ–¹å¼èµ°è‡´å£“åŠ›ã€‚", defAdj: "æŸ”åŒ–å¿ƒè¼ªèƒ½é‡ï¼Œå”åŠ©å°Šé‡æ¯å€‹ç”Ÿå‘½ç¨ç‰¹è»Œè·¡ã€‚", undefDiag: "ä¾é™„ä»–äººæŠ“å–æ–¹å‘ï¼Œæ­»æŠ“ä¼´ä¾¶ä¸æ”¾è®“äººçª’æ¯ã€‚", undefAdj: "åˆ‡æ–·ä¾é™„èƒ½é‡ç´¢ï¼Œæ‰¾å›è‡ªå·±å°±æ˜¯å°èˆªçš„åŠ›é‡ã€‚", isHealthy: false }, { label: "è¿·å¤±æ–¹å‘/ç©ºè™› (å¤±èª¿)", defDiag: "å¤ªä¹…æ²’å›å…§åœ¨ï¼ŒGPSè¨Šè™Ÿå¾®å¼±çœ‹ä¸åˆ°ä¸‹ä¸€æ­¥ã€‚", defAdj: "æ ¡æº–å…§åœ¨å°èˆªï¼Œé‡æ–°å°ç„¦éˆé­‚æ¸´æœ›çš„èˆªé“ã€‚", undefDiag: "è¿·å¤±åœ¨ç’°å¢ƒè£¡ï¼Œèª¤èªä»–äººæ–¹å‘ç‚ºå·±ç¨è™•æ™‚ç©ºè™›ã€‚", undefAdj: "æ¸…ç†å¤–åœ¨å¹²æ“¾ï¼Œå”åŠ©èŒ«èŒ«å¤§æµ·ä¸­æ‰¾åˆ°åº§æ¨™ã€‚", isHealthy: false }, { label: "å¥åº· (ç¶ ç‡ˆ)", defDiag: "èƒ½é‡é‹ä½œè‰¯å¥½ã€‚æ¸…æ¥šè‡ªå·±æ–¹å‘ã€‚", undefDiag: "äº«å—ç•¶ä¸‹ç’°å¢ƒï¼Œä¸åŸ·è‘—å®šä½ã€‚", adjust: "", isHealthy: true } ] },
            ego: { label: "æ„å¿—", organ: "å¿ƒè‡Ÿ/èƒƒ", static: { defined: "æ„å¿—åŠ›å›ºå®šã€‚å¥åº·æ™‚ä¿¡å®ˆæ‰¿è«¾ï¼Œæœ‰è‡ªä¿¡ï¼›ä¸å¥åº·æ™‚å‚²æ…¢ï¼Œæ–½å£“æ–¼äººï¼Œæˆ–éåº¦æ‰¿è«¾å°è‡´éå‹ã€‚", undefined: "åƒ¹å€¼ç„¡éœ€è­‰æ˜ã€‚å¥åº·æ™‚ä¸è¼•æ˜“æ‰¿è«¾ï¼›ä¸å¥åº·æ™‚è‡ªå‘ï¼Œç‚ºäº†è­‰æ˜è‡ªå·±è€Œé€å¼·ã€‚", open: "ç„¡ç«¶çˆ­æ„è­˜ã€‚å¥åº·æ™‚çŸ¥è¶³å¸¸æ¨‚ï¼›ä¸å¥åº·æ™‚å®Œå…¨ä¸çŸ¥é“è‡ªå·±åƒ¹å€¼åœ¨å“ªï¼Œä¸æ•¢çˆ­å–ã€‚" }, dynamic: [ { label: "è‡ªå‘/åƒ¹å€¼æ„Ÿä½ (å…§ç¸®)", defDiag: "å› å¤±æ•—æ‡·ç–‘èƒ½åŠ›ï¼Œè‡´å¿ƒè‡Ÿèˆ‡èƒƒéƒ¨èƒ½é‡èç¸®ã€‚", defAdj: "é‡‹æ”¾æŒ«æ•—æ„Ÿï¼Œå–šé†’å…§åœ¨æˆ°å£«ç²¾ç¥æ‰¾å›è‡ªä¿¡ã€‚", undefDiag: "é™·æ¯”è¼ƒé™·é˜±è¦ºä¸å¦‚äººï¼Œé å¤–åœ¨æˆå°±å¡«è£œç©ºæ´ã€‚", undefAdj: "é‡‹æ”¾è‡ªæˆ‘æ‡·ç–‘æ¯’ç´ ï¼Œè‚¯å®šåŸæœ¬çš„è‡ªå·±å°±å¤ å¥½äº†ã€‚", isHealthy: false }, { label: "å‚²æ…¢/æ–½å£“ (å¤–é¡¯)", defDiag: "è‡ªæˆ‘è†¨è„¹æ‰¹åˆ¤ä»–äººåšä¸åˆ°ï¼Œé€ æˆäººéš›å£“åŠ›ã€‚", defAdj: "è½‰åŒ–éå¼·è‡ªæˆ‘æ„è­˜ï¼Œé‹ç”¨æ„å¿—åŠ›æ”¯æŒè€Œéå£“è¿«ã€‚", undefDiag: "è™›å¼µè²å‹¢æ©é£¾è‡ªä¿¡ä¸è¶³ï¼Œè£å‡ºéåº¦è‡ªå¤§æ­¦è£ã€‚", undefAdj: "å¸ä¸‹å½è£ç›”ç”²ï¼Œå”åŠ©ç”¨çœŸå¯¦æ¨£è²Œèˆ‡äººé€£çµã€‚", isHealthy: false }, { label: "éåº¦æ‰¿è«¾/éå‹ (å¤±èª¿)", defDiag: "é«˜ä¼°é›»é‡æ¥ä¸‹è¶…è¼‰ä»»å‹™ï¼Œé€æ”¯å¿ƒè‡Ÿèƒ½é‡ã€‚", defAdj: "åˆ‡æ–·è¶…è¼‰æ‰¿è«¾ï¼Œè®“æ„å¿—åŠ›ä¸­å¿ƒç²å¾—å¿…è¦ä¼‘æ¯ã€‚", undefDiag: "ç‚ºè­‰æ˜è‡ªå·±è€Œäº‚ç­”æ‡‰ï¼Œä¸æƒ³åšå»ä¸æ•¢æ‹’çµ•ã€‚", undefAdj: "å¼·åŒ–èƒ½é‡é‚Šç•Œï¼Œå”åŠ©å‹‡æ•¢æ‹’çµ•ä¸é©åˆæ‰¿è«¾ã€‚", isHealthy: false }, { label: "å¥åº· (ç¶ ç‡ˆ)", defDiag: "èƒ½é‡é‹ä½œè‰¯å¥½ã€‚è‡ªæˆ‘åƒ¹å€¼å¥åº·ã€‚", undefDiag: "ä¸éœ€è­‰æ˜ä»€éº¼ï¼Œè‡ªåœ¨å±•ç¾ã€‚", adjust: "", isHealthy: true } ] },
            solar: { label: "æƒ…ç·’", organ: "è…/ç¥ç¶“", static: { defined: "è‡ªå¸¶æƒ…ç·’æ³¢ã€‚å¥åº·æ™‚ç­‰å¾…æ¸…æ™°ï¼Œæ¥ç´ä½æ½®ï¼›ä¸å¥åº·æ™‚æƒ…ç·’å‹’ç´¢ï¼Œè¡å‹•æ±ºå®šï¼Œæˆ–å£“æŠ‘æ„Ÿå—ã€‚", undefined: "å…±æ„Ÿè€…ã€‚å¥åº·æ™‚ä¸é¿è«±è¡çªï¼›ä¸å¥åº·æ™‚ç•¶çˆ›å¥½äººï¼Œå£“æŠ‘çœŸå¯¦æ„Ÿå—ï¼Œè«åå´©æ½°ã€‚", open: "æƒ…ç·’å†·éœã€‚å¥åº·æ™‚æ•æ„Ÿåº¦é«˜ï¼›ä¸å¥åº·æ™‚å°æƒ…ç·’éº»æœ¨ï¼Œæˆ–ç„¡æ³•è™•ç†é«˜å¼µåŠ›æƒ…ç·’è€Œç•¶æ©Ÿã€‚" }, dynamic: [ { label: "å£“æŠ‘/å¥½äººç—‡å€™ç¾¤ (å…§ç¸®)", defDiag: "å—åˆ¶ç´„èªæƒ…ç·’ä¸å¥½ï¼Œå¼·åèƒ½é‡é€ æˆå…§å‚·ã€‚", defAdj: "ç–é€šæƒ…ç·’ç®¡é“ï¼Œå…è¨±æƒ…ç·’å®‰å…¨æµå‹•èˆ‡é‡‹æ”¾ã€‚", undefDiag: "æ€•è¡çªè€Œåå¿ç•¶å¥½äººï¼Œè®Šä»–äººæƒ…ç·’åƒåœ¾æ¡¶ã€‚", undefAdj: "æ¸…ç†å †ç©æƒ…ç·’åƒåœ¾ï¼Œå»ºç«‹ä¿è­·å±¤ä¸å†ç…§å–®å…¨æ”¶ã€‚", isHealthy: false }, { label: "æƒ…ç·’å‹’ç´¢/å€’åƒåœ¾ (å¤–é¡¯)", defDiag: "æ‹’ç‚ºæƒ…ç·’è² è²¬ï¼Œä»»é¢¨æš´è‚†è™é·æ€’ä»–äººã€‚", defAdj: "æ·¨åŒ–èƒ½é‡å ´ï¼Œå»ºç«‹å¥åº·å®£æ´©ç®¡é“ä¸å‚·åŠä»–äººã€‚", undefDiag: "åå°„ç’°å¢ƒæ†¤æ€’ï¼Œä¸æœƒè™•ç†è€Œç”¨æ¿€çƒˆæ–¹å¼å½ˆå›å»ã€‚", undefAdj: "å”åŠ©æŠ½é›¢ç•¶ä¸‹æƒ…ç·’ï¼Œçœ‹æ¸…é€™ä¸æ˜¯æˆ‘çš„æƒ…ç·’ã€‚", isHealthy: false }, { label: "è¡å‹•/ç„¦æ…® (å¤±èª¿)", defDiag: "æµªå°–ä¸Šåšæ±ºå®šï¼Œå› ä¸€æ™‚æƒ…ç·’é«˜ä½åšå‡ºå¾Œæ‚”äº‹ã€‚", defAdj: "å®‰æ’«ç¥ç¶“ç³»çµ±ï¼Œå”åŠ©å­¸æœƒç­‰å¾…æƒ…ç·’æµªæ½®é€€å»ã€‚", undefDiag: "ç¥ç¶“ç³»çµ±éè¼‰ï¼Œéå¤šæƒ…ç·’åˆºæ¿€è‡´é«˜åº¦ç„¦æ…®ã€‚", undefAdj: "æ³¨å…¥å¯§éœé »ç‡ï¼Œè®“ç·Šç¹ƒçš„ç¥ç¶“æ·±å±¤æ”¾é¬†ã€‚", isHealthy: false }, { label: "å¥åº· (ç¶ ç‡ˆ)", defDiag: "èƒ½é‡é‹ä½œè‰¯å¥½ã€‚æ“æœ‰æƒ…ç·’æ™ºæ…§ã€‚", undefDiag: "ä¸æ²¾æŸ“ä»–äººæƒ…ç·’ï¼Œä¿æŒæ¸…æ˜ã€‚", adjust: "", isHealthy: true } ] },
            spleen: { label: "ç›´è¦º", organ: "è„¾/æ·‹å·´", static: { defined: "ç›´è¦ºå¯é ã€‚å¥åº·æ™‚ç›¸ä¿¡èº«é«”è¨Šè™Ÿï¼›ä¸å¥åº·æ™‚éµé½’å¿½è¦–ç›´è¦ºï¼Œæˆ–å› å¤ªæ¸…æ¥šé¢¨éšªè€Œéåº¦ä¿å®ˆã€‚", undefined: "ç›´è¦ºä¸ç©©ã€‚å¥åº·æ™‚å°æœªçŸ¥è‡ªåœ¨ï¼›ä¸å¥åº·æ™‚ç·ŠæŠ“ä¸æ”¾ï¼ˆä¾è³´ï¼‰ï¼Œæ”¾å¤§ææ‡¼ã€‚", open: "ææ‡¼ç„¡æ¿¾ç¶²ã€‚å¥åº·æ™‚ç„¡ç•é«”é©—ï¼›ä¸å¥åº·æ™‚ä¸çŸ¥æ­»æ´»ï¼Œæˆ–è¢«ææ‡¼å¾¹åº•ç™±ç˜“ã€‚" }, dynamic: [ { label: "éåº¦ä¿å®ˆ/ä¸æ•¢è®Š (å…§ç¸®)", defDiag: "å¤ªæ¸…æ¥šé¢¨éšªè€Œå°é–‰ï¼Œæ‹’çµ•æ”¹è®ŠéŒ¯å¤±æ©Ÿæœƒã€‚", defAdj: "é‡‹æ”¾åƒµåŒ–é˜²ç¦¦ï¼Œçµ¦äºˆè¸å‡ºèˆ’é©åœˆçš„ä¿¡ä»»èˆ‡å‹‡æ°£ã€‚", undefDiag: "è¢«ææ‡¼ç™±ç˜“ï¼Œé¢å°æœªçŸ¥å·¨å¤§ä¸å®‰è€Œç¸®è§’è½ã€‚", undefAdj: "æ¸…ç†æ·±å±¤ææ‡¼å°è¨˜ï¼Œå”åŠ©å›åˆ°ç•¶ä¸‹å®‰å…¨æ„Ÿã€‚", isHealthy: false }, { label: "éµé½’/å¿½è¦–è­¦è¨Š (å¤–é¡¯)", defDiag: "å¤§è…¦è“‹éèº«é«”è¨Šè™Ÿï¼Œå¤ªä¾è³´é‚è¼¯è‡´éšªå¢ƒã€‚", defAdj: "é‡æ–°æ ¡æº–èº«é«”é›·é”ï¼Œå†æ¬¡è½è¦‹ç›´è¦ºè²éŸ³ã€‚", undefDiag: "ç‚ºæ©é£¾ææ‡¼è€Œé€å¼·ï¼Œè¡¨ç¾é­¯è½ç„¡è¦–æ¥µé™ã€‚", undefAdj: "é€£çµç”Ÿå­˜æœ¬èƒ½ï¼Œå”åŠ©è¾¨è­˜çœŸæ­£çš„å±éšªã€‚", isHealthy: false }, { label: "ä¾è³´/ç·ŠæŠ“ä¸æ”¾ (å¤±èª¿)", defDiag: "åªä¿¡èˆŠç¿’æ…£ï¼Œå³ä¾¿æœ‰å®³å¥åº·ä»ä¸é¡˜æ”¾æ‰‹ã€‚", defAdj: "åˆ‡æ–·èˆŠæœ‰æ…£æ€§é€£çµï¼Œå”åŠ©æ“æŠ±æ–°å¥åº·æ¨¡å¼ã€‚", undefDiag: "æ€•å­¤å–®è€Œç·ŠæŠ“æœ‰æ¯’é—œä¿‚ï¼Œç‚ºå°æ–¹æ‰¾è—‰å£ã€‚", undefAdj: "åˆ‡æ–·ä¾é™„èƒ½é‡ç´¢ï¼Œæé†’éš¨æ™‚æœ‰è½‰èº«é›¢é–‹æ¬Šåˆ©ã€‚", isHealthy: false }, { label: "å¥åº· (ç¶ ç‡ˆ)", defDiag: "èƒ½é‡é‹ä½œè‰¯å¥½ã€‚ç›´è¦ºæ•éŠ³ã€‚", undefDiag: "é¢å°ææ‡¼ä¸ä¾é™„ï¼Œç¨ç«‹è‡ªä¸»ã€‚", adjust: "", isHealthy: true } ] },
            sacral: { label: "è–¦éª¨", organ: "ç”Ÿæ®–ç³»çµ±", static: { defined: "å¼·å¤§ç™¼é›»æ©Ÿã€‚å¥åº·æ™‚åšå–œæ­¡çš„äº‹ï¼›ä¸å¥åº·æ™‚äº‚ç™¼èµ·è¡Œå‹•ï¼ˆæŒ«æ•—ï¼‰ï¼Œæˆ–å‹‰å¼·åšä¸æ„›çš„äº‹ã€‚", undefined: "èƒ½é‡å¼•å°è€…ã€‚å¥åº·æ™‚é©åº¦ä¼‘æ¯ï¼›ä¸å¥åº·æ™‚ä¸çŸ¥ä½•æ™‚åœï¼Œè®Šå·¥ä½œç‹‚ã€‚", open: "æ€§èƒ½é‡æ¨¡ç³Šã€‚å¥åº·æ™‚äº«å—ç”Ÿæ´»ï¼›ä¸å¥åº·æ™‚ç”Ÿæ´»å¤±å»é‚Šç•Œï¼Œå¾¹åº•éå‹ã€‚" }, dynamic: [ { label: "å‹‰å¼·/èƒ½é‡é˜»å¡ (å…§ç¸®)", defDiag: "è…¦é€¼èº«é«”åšæ²’å›æ‡‰çš„äº‹ï¼Œè‡´ç”Ÿå‘½åŠ›åš´é‡æ¼æ²¹ã€‚", defAdj: "ä¿®å¾©èƒ½é‡æ¼æ´ï¼Œå–šé†’å°çœŸå¿ƒå–œæ„›äº‹ç‰©çš„å›æ‡‰ã€‚", undefDiag: "å¸æ”¶ä»–äººèˆˆå¥®èª¤èªæœ‰é«”åŠ›ï¼Œè¢«æ¦¨ä¹¾ä¸æ•¢åœã€‚", undefAdj: "å”åŠ©èˆ‡ç©ºç™½å’Œè§£ï¼Œæ‰¾å›é©åˆä½ çš„ä¼‘æ¯ç¯€å¥ã€‚", isHealthy: false }, { label: "äº‚ç™¼èµ·/æŒ«æ•— (å¤–é¡¯)", defDiag: "å¿˜è¨˜ç­‰å¾…ä¸»å‹•ç™¼èµ·ï¼Œè™•è™•ç¢°å£æ„Ÿåˆ°æ†¤æ€’æŒ«æ•—ã€‚", defAdj: "å”åŠ©èƒ½é‡æ­¸ä½ï¼Œå¾ä¸»å‹•å‡ºæ“Šèª¿å›ç£æ€§å¸å¼•ã€‚", undefDiag: "æ‹¼å‘½å·¥ä½œè­‰æ˜æœ‰ç”¨ï¼Œå¿™ç¢Œå¡«è£œå…§å¿ƒç©ºè™›ã€‚", undefAdj: "é‡‹æ”¾æˆ‘ä¸å¤ å¥½é©…å‹•åŠ›ï¼Œå”åŠ©æ…¢ä¸‹ä¾†äº«å—ç”Ÿæ´»ã€‚", isHealthy: false }, { label: "æ€§/å‰µé€ åŠ›å—é˜» (å¤±èª¿)", defDiag: "å‰µé€ ä¹‹ç«ç†„æ»…ï¼Œç”Ÿæ´»æ©Ÿæ¢°åŒ–å½±éŸ¿è¦ªå¯†æµå‹•ã€‚", defAdj: "æ¿€æ´»è‡è¼ªèƒ½é‡ï¼Œæ‰¾å›ç”Ÿæ´»æ¨‚è¶£èˆ‡æ€§å‹•åŠ›ã€‚", undefDiag: "èƒ½é‡é€æ”¯ï¼Œé•·æœŸé«˜å£“è‡´èº«é«”å¼·åˆ¶é—œæ©Ÿã€‚", undefAdj: "æ³¨å…¥ä¿®å¾©èƒ½é‡ï¼Œå”åŠ©ç”Ÿæ®–ç³»çµ±æ·±å±¤å……é›»ã€‚", isHealthy: false }, { label: "å¥åº· (ç¶ ç‡ˆ)", defDiag: "èƒ½é‡é‹ä½œè‰¯å¥½ã€‚æºæºä¸çµ•å‰µé€ åŠ›ã€‚", undefDiag: "å·¥ä½œæœ‰åº¦ï¼Œæ‡‚å¾—é©æ™‚ä¼‘æ¯ã€‚", adjust: "", isHealthy: true } ] },
            root: { label: "æ ¹éƒ¨", organ: "è…ä¸Šè…º", static: { defined: "æŠ—å£“æ€§å¼·ã€‚å¥åº·æ™‚å¾å®¹é¢å°ï¼›ä¸å¥åº·æ™‚æ²’è€å¿ƒï¼Œé€¼è¿«åˆ¥äººå¿«ä¸€é»ã€‚", undefined: "å£“åŠ›æ”¾å¤§å™¨ã€‚å¥åº·æ™‚å€ŸåŠ›ä½¿åŠ›ï¼›ä¸å¥åº·æ™‚æ€¥è‘—åšå®Œï¼Œå¿™ä¸­å‡ºéŒ¯ã€‚", open: "å°å£“åŠ›ç„¡æ„Ÿã€‚å¥åº·æ™‚é€é™è‡ªåœ¨ï¼›ä¸å¥åº·æ™‚ç´¯ç©å£“åŠ›è€Œä¸è‡ªçŸ¥ï¼Œçªç„¶å´©æ½°ã€‚" }, dynamic: [ { label: "å£“æŠ‘å£“åŠ›/ä¾¿ç§˜ (å…§ç¸®)", defDiag: "å£“åŠ›åè‚šå…§ï¼Œè…ä¸Šè…ºå‚™æˆ°è‡´èº«é«”åƒµç¡¬ã€‚", defAdj: "é‡‹æ”¾ç´¯ç©åº•å±¤å£“åŠ›ï¼Œå”åŠ©èº«é«”è‚Œè‚‰æ·±å±¤æ”¾é¬†ã€‚", undefDiag: "è¢«ä»–äººå£“åŠ›ç¶æ¶ï¼Œå‘¨é­è‘—æ€¥è®Šè‡ªå·±ç„¦æ…®ã€‚", undefAdj: "æ¸…ç†å¤–ä¾†å£“åŠ›èƒ½é‡ï¼Œå”åŠ©æ‰¾å›å…§åœ¨å¾å®¹ã€‚", isHealthy: false }, { label: "é€¼è¿«ä»–äºº/æš´èº (å¤–é¡¯)", defDiag: "å—ä¸äº†æ…¢æ­¥èª¿é€¼è¿«ä»–äººï¼Œè£½é€ é«˜å£“æ°£æ°›ã€‚", defAdj: "å¹³è¡¡æ ¹éƒ¨èƒ½é‡ï¼Œå°‡å£“åŠ›è½‰åŒ–ç‚ºç©©å®šæ”¯æŒåŠ›ã€‚", undefDiag: "æ€¥æ–¼è§£è„«æœªå®Œæˆå£“åŠ›ï¼Œæ‹¼å‘½è¶•å·¥æ¬²é€Ÿä¸é”ã€‚", undefAdj: "å”åŠ©å®‰ä½ç•¶ä¸‹ï¼Œæ˜ç™½äº‹æƒ…åšä¸å®Œä½†å¯æ…¢æ…¢åšã€‚", isHealthy: false }, { label: "ç”Ÿå­˜ç„¦æ…®/ç„¡æ³•æ‰æ ¹ (å¤±èª¿)", defDiag: "å°ç¾å¯¦ä¸å®‰æ“”å¿ƒåŒ±ä¹ï¼Œç„¡æ³•å®‰ç©©æ´»ç•¶ä¸‹ã€‚", defAdj: "å¼·åŒ–æµ·åº•è¼ªèˆ‡å¤§åœ°é€£çµï¼Œæ³¨å…¥è±ç››ä¿¡ä»»é »ç‡ã€‚", undefDiag: "å£“åŠ›å¤§åˆ°æƒ³é€ƒé¿ï¼Œé£„å¿½ä¸å®šç„¡æ³•è½åœ°åŸ·è¡Œã€‚", undefAdj: "å”åŠ©èƒ½é‡æ‰æ ¹ï¼Œæå‡åŸ·è¡ŒåŠ›èˆ‡ç©©å®šåº¦ã€‚", isHealthy: false }, { label: "å¥åº· (ç¶ ç‡ˆ)", defDiag: "èƒ½é‡é‹ä½œè‰¯å¥½ã€‚æ­¥å±¥è¸å¯¦ã€‚", undefDiag: "ä¸è¢«ä»–äººå£“åŠ›é©…å‹•ï¼Œå¾å®¹è‡ªåœ¨ã€‚", adjust: "", isHealthy: true } ] }
        };

        const CENTERS = [
            { id: 'head', shape: 'tri-up', cx: 400, cy: 120, w: 180, h: 150, textDy: 10 }, 
            { id: 'ajna', shape: 'tri-down', cx: 400, cy: 290, w: 180, h: 150, textDy: -10 },
            { id: 'throat', shape: 'square', cx: 400, cy: 450, w: 140, h: 140, textDy: 0 },
            { id: 'g', shape: 'diamond', cx: 400, cy: 650, w: 170, h: 170, textDy: 0 },
            { id: 'ego', shape: 'tri-small', cx: 620, cy: 680, w: 130, h: 120, textDy: 0 }, 
            { id: 'sacral', shape: 'square', cx: 400, cy: 840, w: 140, h: 140, textDy: 0 },
            { id: 'spleen', shape: 'tri-left', cx: 165, cy: 830, w: 180, h: 160, textDy: 0 }, 
            { id: 'solar', shape: 'tri-right', cx: 635, cy: 830, w: 180, h: 160, textDy: 0 }, 
            { id: 'root', shape: 'square', cx: 400, cy: 1030, w: 140, h: 140, textDy: 0 }
        ];

        const CHANNELS = [['head','ajna'],['ajna','throat'],['throat','g'],['throat','spleen'],['throat','sacral'],['throat','solar'],['g','sacral'],['g','spleen'],['g','ego'],['ego','throat'],['ego','solar'],['sacral','root'],['sacral','spleen'],['sacral','solar'],['spleen','root'],['solar','root']];

        window.onload = async function() {
            document.getElementById('info-date').valueAsDate = new Date();
            renderInputs(); 

            try {
                myDB = window.supabase.createClient(SB_URL, SB_KEY);
                console.log("âœ… DB Connected");
            } catch(e) { console.error("DB Error:", e); }

            const params = new URLSearchParams(window.location.search);
            const pId = params.get('id'); 
            const pMode = params.get('mode'); 

            if (pMode === 'view') {
                isViewMode = true;
                document.body.classList.add('view-mode');
                if(pId) await loadReportData(pId);
            } else if (pId) {
                currentReportId = pId;
                document.getElementById('btn-real-save').innerText = "ğŸ’¾ æ›´æ–°å„²å­˜";
                await loadReportData(pId); 
            } else {
                const pName = params.get('name');
                const pPhone = params.get('phone');
                const pBid = params.get('bid');
                if (pName) document.getElementById('info-name').value = pName;
                if (pPhone) document.getElementById('info-phone').value = pPhone;
                if (pBid) {
                    currentBookingId = pBid;
                    fetchBookingService(pBid); 
                }
            }
        };

        async function fetchBookingService(bid) {
            if(!myDB) return;
            try {
                const { data: booking, error } = await myDB.from('bookings').select('service_item, service_detail').eq('id', bid).single();
                if (error) throw error;

                if (booking) {
                    currentMainService = booking.service_item;
                    document.getElementById('page-title').innerText = `ğŸ”® ${currentMainService}`;

                    if (booking.service_detail) {
                        let detailStr = booking.service_detail
                            .replace(/\(\s*\$\s*\d+\s*\)/g, '') 
                            .replace(/\$\s*\d+/g, '')          
                            .replace(/\d+\s*å…ƒ/g, '')         
                            .trim();

                        const parts = detailStr.split('|').map(p => p.trim());
                        detectedAddons = []; 

                        parts.forEach(p => {
                            const match = p.match(/(.+?)[\[\(](.+?)[\]\)]/);
                            if (match) {
                                const category = match[1].trim(); 
                                const subItems = match[2].split(/[ã€ï¼Œ,]+/).map(s => s.trim()).filter(s => s !== "");
                                detectedAddons.push({ name: category, subs: subItems });
                            } else if (p && p !== currentMainService) {
                                detectedAddons.push({ name: p, subs: [] });
                            }
                        });
                        
                        const container = document.getElementById('addon-container');
                        const wrapper = document.getElementById('addon-section-wrapper');
                        if (container && detectedAddons.length > 0) {
                            wrapper.style.display = 'block';
                            container.innerHTML = ''; 
                            detectedAddons.forEach((item, idx) => {
                                const card = document.createElement('div');
                                card.className = 'addon-card';
                                let html = `<div class="addon-title">${item.name}</div>`;
                                html += `<div style="margin-bottom:10px;"><label style="font-size:12px; color:#c62828;">é …ç›®æª¢æ¸¬ï¼š</label><select id="addon-main-val-${idx}"><option value="ä½">ä½</option><option value="ä¸­" selected>ä¸­</option><option value="é«˜">é«˜</option></select></div>`;
                                item.subs.forEach((sub, sIdx) => {
                                    html += `<div style="margin-bottom:8px; padding-left:10px; display:flex; justify-content:space-between; align-items:center;"><span style="font-size:13px;">â€¢ ${sub}</span><select id="addon-sub-adj-${idx}-${sIdx}"><option value="ä½">èª¿æ•´ï¼šä½</option><option value="ä¸­">èª¿æ•´ï¼šä¸­</option><option value="é«˜" selected>èª¿æ•´ï¼šé«˜</option></select></div>`;
                                });
                                card.innerHTML = html;
                                container.appendChild(card);
                            });
                        }
                    }
                }
            } catch(e) { console.error("Fetch Booking Error:", e); }
        }

        function renderInputs() {
            const container = document.getElementById('inputs-container');
            CENTERS.forEach(c => {
                const data = CENTER_CONTENT[c.id];
                const card = document.createElement('div');
                card.className = 'center-card';
                card.setAttribute('data-color', c.id);
                let checkHTML = data.dynamic.map((d, i) => `<label class="checkbox-item"><input type="checkbox" name="diag-${c.id}" value="${i}" onclick="handleCheck('${c.id}', ${i})"><span>${d.label}</span></label>`).join('');
                card.innerHTML = `
                    <div class="center-header">
                        <div class="center-title">${data.label} <span style="font-size:12px;color:#777;">(${data.organ})</span></div>
                        <div class="status-group" id="group-${c.id}">
                            <button class="status-btn active" onclick="setStatus('${c.id}', 'defined')">å·²å®šç¾©</button>
                            <button class="status-btn" onclick="setStatus('${c.id}', 'undefined')">æœªå®šç¾©</button>
                            <button class="status-btn" onclick="setStatus('${c.id}', 'open')">å…¨ç©ºç™½</button>
                            <input type="hidden" id="status-${c.id}" value="defined">
                        </div>
                    </div>
                    <div class="diagnosis-area"><div style="font-weight:bold;color:#e65100;margin-bottom:5px;">ğŸ“‹ éˆæ“ºè¨ºæ–·</div><div class="checkbox-group">${checkHTML}</div></div>
                    <div class="input-row"><div class="input-group"><label>æª¢æ¸¬(%)</label><input type="number" id="val-${c.id}"></div><div class="input-group"><label>èª¿æ•´(%)</label><input type="number" id="adj-${c.id}"></div></div>
                    <div class="custom-note-area"><textarea id="note-${c.id}" placeholder="æ‰‹å¯«è£œå……..."></textarea></div>
                `;
                container.appendChild(card);
            });
        }

        function setStatus(id, s) {
            const btns = document.getElementById(`group-${id}`).getElementsByTagName('button');
            btns[0].className = s==='defined'?'status-btn active':'status-btn';
            btns[1].className = s==='undefined'?'status-btn active':'status-btn';
            btns[2].className = s==='open'?'status-btn active':'status-btn';
            document.getElementById(`status-${id}`).value = s;
        }

        function handleCheck(id, idx) {
            const cbs = document.getElementsByName(`diag-${id}`);
            if (CENTER_CONTENT[id].dynamic[idx].isHealthy && cbs[idx].checked) {
                cbs.forEach((cb, i) => { if(i!==idx) cb.checked = false; });
                document.getElementById(`val-${id}`).value = 100;
            } else if (cbs[idx].checked) {
                cbs.forEach((cb, i) => { if(CENTER_CONTENT[id].dynamic[i].isHealthy) cb.checked = false; });
            }
        }

        function collectDataFromUI() {
            const centersData = CENTERS.map(c => {
                const centerKey = c.id;
                const db = CENTER_CONTENT[centerKey];
                const status = document.getElementById(`status-${centerKey}`) ? document.getElementById(`status-${centerKey}`).value : 'defined'; 
                let statusLabel = (status === 'defined') ? "å·²å®šç¾©" : (status === 'undefined') ? "æœªå®šç¾©" : "å…¨ç©ºç™½";
                let valInput = document.getElementById(`val-${centerKey}`).value;
                let val = valInput === "" ? "--" : valInput;
                let adjInput = document.getElementById(`adj-${centerKey}`).value;
                const checkboxes = document.getElementsByName(`diag-${centerKey}`);
                let hasUnhealthyIssue = false;
                let dynamicPairs = [];
                
                checkboxes.forEach((cb, i) => {
                    if (cb.checked) {
                        const item = db.dynamic[i];
                        if (!item.isHealthy) hasUnhealthyIssue = true;
                        let dTxt = (status === 'defined' ? item.defDiag : item.undefDiag);
                        let aTxt = (status === 'defined' ? item.defAdj : item.undefAdj);
                        if (item.isHealthy) { dynamicPairs.push({ type: 'healthy_diag', diag: `ğŸŸ¢ ${dTxt}` }); } 
                        else { dynamicPairs.push({ type: 'diag', text: `âš ï¸ ${dTxt}` }); dynamicPairs.push({ type: 'adjust', text: `ğŸ› ï¸ ${aTxt}` }); }
                    }
                });
                let finalAdj = adjInput !== "" ? adjInput : (valInput !== "" && parseInt(valInput) !== 100 ? "100" : (hasUnhealthyIssue ? "100" : "ç„¡é ˆèª¿æ•´"));
                
                return { 
                    ...c, label: db.label, status: status, statusLabel: statusLabel, sLabel: statusLabel, val: val, adj: finalAdj, finalAdj: finalAdj, 
                    content: [{ type: 'static', text: db.static[status] }].concat(dynamicPairs.map(p => ({ type: p.type, text: p.text || p.diag }))).concat(document.getElementById(`note-${centerKey}`).value.trim() ? [{type:'note', text: 'ğŸ’¡ è£œå……ï¼š' + document.getElementById(`note-${centerKey}`).value.trim()}] : []),
                    raw_diags: dynamicPairs 
                }; 
            });

            const coreData = MANDATORY_CHECKS.map((name, i) => ({
                name: name, val: document.getElementById(`core-val-${i}`).value, adj: "é«˜", isCore: true, subs: []
            }));

            const addonsData = [];
            if (detectedAddons && detectedAddons.length > 0) {
                detectedAddons.forEach((item, idx) => {
                    const mainVal = document.getElementById(`addon-main-val-${idx}`).value;
                    const subsData = item.subs.map((subName, sIdx) => ({
                        name: subName,
                        adj: document.getElementById(`addon-sub-adj-${idx}-${sIdx}`).value
                    }));
                    addonsData.push({ name: item.name, val: mainVal, subs: subsData, isCore: false });
                });
            }

            return { centers: centersData, specialItems: [...coreData, ...addonsData], reportTitle: currentMainService };
        }

        function generatePreview() {
            try {
                const msg = document.getElementById('status-msg');
                msg.innerText = "ğŸ¨ æ­£åœ¨ç”Ÿæˆé è¦½åœ–...";
                const fullData = collectDataFromUI();

                const meta = {
                    title: currentMainService, 
                    date: document.getElementById('info-date').value,
                    name: document.getElementById('info-name').value,
                    phone: document.getElementById('info-phone').value,
                    healer: document.getElementById('info-healer').value,
                    summary: document.getElementById('overall-summary').value
                };

                drawClassicReport(fullData, meta); 

                msg.innerText = "";
                document.getElementById('btn-real-save').style.display = 'inline-block';
                document.getElementById('result-wrapper').style.display = 'block';
                
                if (isViewMode) { document.getElementById('result-wrapper').scrollIntoView(); } 
                else { document.getElementById('result-wrapper').scrollIntoView({behavior: "smooth"}); }
            } catch (e) {
                console.error(e);
                alert("ç”Ÿæˆå¤±æ•—: " + e.message);
            }
        }

        async function saveToDatabase() {
            const msg = document.getElementById('status-msg');
            const ph = document.getElementById('info-phone').value.trim();
            const nm = document.getElementById('info-name').value.trim();
            const em = document.getElementById('info-email').value.trim(); // ğŸ‘ˆ æŠ“å– Email

            if(!myDB) { alert("é€£ç·šéŒ¯èª¤"); return; }
            if(!ph) { alert("è«‹å¡«å¯«å€‹æ¡ˆæ‰‹æ©Ÿ"); return; }

            msg.innerText = "â³ æ­£åœ¨å­˜æª”ä¸¦åŸ·è¡Œçµæ¡ˆç¨‹åº...";
            document.getElementById('btn-real-save').disabled = true;
            const fullData = collectDataFromUI();

            try {
                let uid = null;
                // 1. æŸ¥è©¢æ˜¯å¦å·²æ˜¯æœƒå“¡
                const { data: prof } = await myDB.from('profiles').select('id').eq('phone', ph).single();
                
                if(prof) {
                    uid = prof.id; 
                } else {
                    // ğŸ”¥ é—œéµä¿®æ­£ï¼šç”Ÿæˆé è¨­å¯†ç¢¼ (guest + æ‰‹æ©Ÿæœ«4ç¢¼)
                    const defaultPwd = ph.length >= 4 ? 'guest' + ph.slice(-4) : 'guest1234';
                    
                    // ğŸ”¥ é—œéµä¿®æ­£ï¼šè¨»å†Šæ™‚åŒæ™‚å¯«å…¥ emailã€password èˆ‡ role
                    const { data: np, error: createErr } = await myDB.from('profiles').insert([{
                        phone: ph, 
                        full_name: nm,
                        email: em,           
                        password: defaultPwd, 
                        role: 'member'
                    }]).select().single();
                    
                    if(createErr) throw createErr;
                    uid = np.id;
                }

                // 2. æº–å‚™å ±å‘Šèˆ‡è¨‚å–®é€£å‹•é‚è¼¯
                const sum = document.getElementById('overall-summary').value;
                const dt = document.getElementById('info-date').value;
                const healer = document.getElementById('info-healer').value;

                const payload = { 
                    user_id: uid, 
                    service_date: dt, 
                    healer_name: healer, 
                    summary: sum, 
                    raw_data: fullData,
                    service_item: currentMainService 
                };

                let reportId = currentReportId;
                if (currentReportId) {
                    await myDB.from('reports').update(payload).eq('id', currentReportId);
                } else {
                    const { data: newR, error: ie } = await myDB.from('reports').insert([payload]).select().single();
                    if(ie) throw ie;
                    reportId = newR.id;
                    currentReportId = newR.id;
                }

                if (currentBookingId) {
                    const linkText = `[å ±å‘Šå·²ç”Ÿæˆ ID:${reportId}]`;
                    const { data: oldB } = await myDB.from('bookings').select('wish_detail').eq('id', currentBookingId).single();
                    let newDetail = oldB ? (oldB.wish_detail || "") : "";
                    if (!newDetail.includes("å ±å‘Šå·²ç”Ÿæˆ")) { newDetail += (newDetail ? " | " : "") + linkText; }
                    await myDB.from('bookings').update({ status: 'completed', wish_detail: newDetail }).eq('id', currentBookingId);
                }

                alert("âœ… å­˜æª”æˆåŠŸï¼è¦–çª—å°‡è‡ªå‹•é—œé–‰ã€‚");
                window.close();

            } catch(err) {
                console.error(err);
                msg.innerText = "âš ï¸ å­˜æª”å¤±æ•—: " + err.message;
                document.getElementById('btn-real-save').disabled = false;
            }
        }
        
        async function loadReportData(reportId) {
            const msg = document.getElementById('status-msg');
            msg.innerText = "â³ æ­£åœ¨è®€å–è³‡æ–™...";
            
            const { data, error } = await myDB.from('reports').select('*').eq('id', reportId).single();
            if (error) { alert("è®€å–å¤±æ•—ï¼š" + error.message); return; }

            document.getElementById('info-date').value = data.service_date;
            document.getElementById('info-healer').value = data.healer_name;
            document.getElementById('overall-summary').value = data.summary || "";
            
            if (data.service_item) { currentMainService = data.service_item; } 
            else if (data.raw_data && data.raw_data.reportTitle) { currentMainService = data.raw_data.reportTitle; }
            document.getElementById('page-title').innerText = currentMainService ? `ğŸ”® ${currentMainService}` : "ğŸ”®";

            if (data.user_id) {
                const { data: prof } = await myDB.from('profiles').select('*').eq('id', data.user_id).single();
                if (prof) {
                    document.getElementById('info-name').value = prof.full_name;
                    document.getElementById('info-phone').value = prof.phone;
                }
            }

            if (data.raw_data) {
                const rd = data.raw_data;
                (rd.centers || []).forEach(item => {
                    const cid = item.id;
                    setStatus(cid, item.status);
                    if(item.val && item.val!=="--") document.getElementById(`val-${cid}`).value = item.val;
                    if(item.finalAdj && item.finalAdj!=="ç„¡é ˆèª¿æ•´" && item.finalAdj!=="100") document.getElementById(`adj-${cid}`).value = item.finalAdj;
                    if (item.raw_diags) {
                        const dbDynamic = CENTER_CONTENT[cid].dynamic;
                        const cbs = document.getElementsByName(`diag-${cid}`);
                        item.raw_diags.forEach(d => {
                            let r = d.text || d.diag; if(!r) return;
                            const clean = r.substring(2).trim();
                            dbDynamic.forEach((def, idx) => {
                                if(def.defDiag===clean || def.undefDiag===clean || def.defAdj===clean || def.undefAdj===clean) {
                                    if(cbs[idx]) cbs[idx].checked = true;
                                }
                            });
                        });
                    }
                    if (item.content) {
                        const nb = item.content.find(x => x.type === 'note');
                        if (nb) document.getElementById(`note-${cid}`).value = nb.text.replace("ğŸ’¡ è£œå……ï¼š", "");
                    }
                });

                const special = rd.specialItems || [];
                special.filter(x => x.isCore).forEach((c, i) => {
                    const el = document.getElementById(`core-val-${i}`);
                    if (el) el.value = c.val;
                });

                const addons = special.filter(x => !x.isCore);
                const container = document.getElementById('addon-container');
                const wrapper = document.getElementById('addon-section-wrapper');
                if (container && addons.length > 0) {
                    wrapper.style.display = 'block';
                    container.innerHTML = '';
                    detectedAddons = addons.map(a => ({ name: a.name, subs: a.subs ? a.subs.map(s => s.name) : [] }));
                    addons.forEach((item, idx) => {
                        const card = document.createElement('div');
                        card.className = 'addon-card';
                        let h = `<div class="addon-title">${item.name}</div>`;
                        h += `<div style="margin-bottom:10px;"><label style="font-size:12px; color:#c62828;">é …ç›®æª¢æ¸¬ï¼š</label><select id="addon-main-val-${idx}"><option value="${item.val}">${item.val}</option></select></div>`;
                        if (item.subs) item.subs.forEach((s, si) => h += `<div style="margin-bottom:8px; padding-left:10px; display:flex; justify-content:space-between; align-items:center;"><span style="font-size:13px;">â€¢ ${s.name}</span><select id="addon-sub-adj-${idx}-${si}"><option value="${s.adj}">${s.adj}</option></select></div>`);
                        card.innerHTML = h;
                        container.appendChild(card);
                    });
                }
            }
            msg.innerText = "";
            setTimeout(() => { generatePreview(); }, 200);
        }

        async function drawClassicReport(fullData, meta) { 
            try {
                const canvas = document.getElementById('mainCanvas');
                const ctx = canvas.getContext('2d');
                const canvasWidth = 2600; const headerHeight = 250;

                const logoImg = await new Promise((res) => {
                    const img = new Image(); img.src = 'logo.png';
                    img.onload = () => res(img); img.onerror = () => res(null);
                });

                const reportData = fullData.centers; 
                const specialItems = fullData.specialItems || [];
                const coreItems = specialItems.filter(x => x.isCore);
                const addonItems = specialItems.filter(x => !x.isCore);
                const healthyCenters = reportData.filter(x => x.finalAdj === "ç„¡é ˆèª¿æ•´");
                const adjustCenters = reportData.filter(x => x.finalAdj !== "ç„¡é ˆèª¿æ•´");

                const dividerX = 750; const rightPanelX = 780; const rightPanelW = 1770;
                const mainColWidth = (rightPanelW - 50) / 3;
                const mainColX = [rightPanelX, rightPanelX + mainColWidth + 25, rightPanelX + (mainColWidth + 25) * 2];
                const HEALTHY_CARD_H = 160; const ADJUST_CARD_H = 460;

                const drawEnergyBarRow = (bx, by, level, label, isDet, barW = 100) => {
                    ctx.fillStyle = "#888"; ctx.font = "15px Microsoft JhengHei"; ctx.textAlign = "left";
                    ctx.fillText(label, bx, by + 14);
                    const labelW = ctx.measureText(label).width + 8;
                    const barH = 16; const segW = (barW - 6) / 3;
                    ctx.fillStyle = "#f0f0f0"; roundRect(ctx, bx + labelW, by, barW, barH, 4); ctx.fill();
                    let count = (level === "ä½" ? 1 : level === "ä¸­" ? 2 : 3);
                    let color = isDet ? "#ff5252" : (count === 1 ? "#ff5252" : count === 2 ? "#ffd740" : "#69f0ae");
                    for (let k = 0; k < count; k++) { ctx.fillStyle = color; roundRect(ctx, bx + labelW + 3 + (k * (segW + 2)), by + 3, segW, barH - 6, 2); ctx.fill(); }
                };

                let rowY = headerHeight + 130;
                let addonAreaH = addonItems.length * 160;
                let healthyTopY = headerHeight + 100 + addonAreaH + 20;
                let healthyTotalH = Math.ceil(healthyCenters.length / 3) * (HEALTHY_CARD_H + 30) + 40;
                let adjustTopY = healthyTopY + healthyTotalH;
                let adjustTotalH = Math.ceil(adjustCenters.length / 3) * (ADJUST_CARD_H + 100) + 40;
                const sumLines = processParagraphs(ctx, meta.summary || "", canvasWidth - 280);
                const summaryBoxH = (sumLines.length * 52) + 160;

                canvas.width = canvasWidth; canvas.height = adjustTopY + adjustTotalH + summaryBoxH + 200;
                ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, canvas.width, canvas.height);
                drawHeader(ctx, canvasWidth, headerHeight, meta, logoImg);

                ctx.save(); ctx.translate(0, headerHeight);
                ctx.strokeStyle = "#eee"; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(dividerX, 0); ctx.lineTo(dividerX, adjustTopY + adjustTotalH - headerHeight - 50); ctx.stroke();
                CHANNELS.forEach(p => { const c1 = CENTERS.find(c => c.id === p[0]), c2 = CENTERS.find(c => c.id === p[1]); if(c1 && c2) { ctx.lineWidth=3; ctx.strokeStyle="#e0e0e0"; ctx.beginPath(); ctx.moveTo(c1.cx, c1.cy); ctx.lineTo(c2.cx, c2.cy); ctx.stroke(); } });
                reportData.forEach(item => { 
                    const {cx:x, cy:y, w, h} = item; ctx.beginPath();
                    if (item.shape === 'square') ctx.rect(x-w/2, y-h/2, w, h);
                    else if (item.shape === 'diamond') { ctx.moveTo(x, y-h/2); ctx.lineTo(x+w/2, y); ctx.lineTo(x, y+h/2); ctx.lineTo(x-w/2, y); ctx.closePath(); }
                    else if (item.shape === 'tri-up') { ctx.moveTo(x, y-h/2); ctx.lineTo(x+w/2, y+h/2); ctx.lineTo(x-w/2, y+h/2); ctx.closePath(); }
                    else if (item.shape === 'tri-down') { ctx.moveTo(x-w/2, y-h/2); ctx.lineTo(x+w/2, y-h/2); ctx.lineTo(x, y+h/2); ctx.closePath(); }
                    else if (item.shape === 'tri-left') { ctx.moveTo(x-w/2, y-h/2); ctx.lineTo(x-w/2, y+h/2); ctx.lineTo(x+w/2, y); ctx.closePath(); }
                    else if (item.shape === 'tri-right') { ctx.moveTo(x+w/2, y-h/2); ctx.lineTo(x+w/2, y+h/2); ctx.lineTo(x-w/2, y); ctx.closePath(); }
                    else if (item.shape === 'tri-small') { ctx.moveTo(x-w/2, y); ctx.lineTo(x+w/2, y-h/2); ctx.lineTo(x+w/2, y+h/2); ctx.closePath(); }
                    ctx.fillStyle = (item.status === 'defined' ? HD_COLORS[item.id] : "#ffffff"); ctx.fill();
                    ctx.lineWidth = 4; ctx.strokeStyle = "#444"; ctx.stroke();
                    let tx = x, ty = y, tAlign = "center";
                    if (item.id === 'head') { ty = y + (h/2) - 32; tx = x - 15; } else if (item.id === 'ajna') { ty = y - (h/2) + 32; tx = x - 15; } 
                    else if (item.id === 'spleen') { tAlign = "left"; tx = x - (w/2) + 18; } else if (item.id === 'solar') { tAlign = "right"; tx = x + (w/2) - 18; } else { tx = x - 15; }
                    ctx.fillStyle = "#2c3e50"; ctx.font = "bold 20px Microsoft JhengHei"; ctx.textAlign = tAlign; ctx.textBaseline = "middle"; ctx.fillText(item.label, tx, ty); 
                    let val = (item.finalAdj === "ç„¡é ˆèª¿æ•´" && item.val === "--") ? "100" : item.val;
                    let bC = (parseInt(val)<=40)? ENERGY_COLORS.red : (parseInt(val)<=70)? ENERGY_COLORS.yellow : ENERGY_COLORS.green;
                    let bx = (tAlign === "left") ? tx + ctx.measureText(item.label).width + 30 : (tAlign === "right") ? tx - ctx.measureText(item.label).width - 30 : tx + 45;
                    ctx.beginPath(); ctx.arc(bx, ty, 22, 0, Math.PI*2); ctx.fillStyle = bC; ctx.fill();
                    ctx.fillStyle = (bC === ENERGY_COLORS.red) ? "#ffffff" : "#000000"; ctx.font = "bold 16px Arial"; ctx.textAlign = "center"; ctx.fillText(val, bx, ty);
                });
                ctx.restore();

                const titleY = headerHeight + 65;
                ctx.fillStyle = "#1a2f23"; ctx.font = "bold 34px 'Noto Serif TC', serif"; ctx.textAlign="left";
                ctx.fillText("âš¡ åŸºæœ¬èƒ½é‡æª¢æ¸¬èˆ‡åŠ è³¼é …ç›®èª¿æ•´", rightPanelX, titleY);

                coreItems.forEach((cItem, i) => {
                    const bx = rightPanelX + 550 + (i * 420);
                    ctx.save(); ctx.strokeStyle = "#c6a87c"; ctx.lineWidth = 1;
                    roundRect(ctx, bx, titleY - 45, 400, 90, 15); ctx.stroke(); ctx.restore();
                    ctx.fillStyle = "#1a1a1a"; ctx.font = "bold 20px Microsoft JhengHei";
                    ctx.fillText(cItem.name, bx + 20, titleY);
                    drawEnergyBarRow(bx + 110, titleY - 30, cItem.val, "æª¢æ¸¬", true, 90);
                    drawEnergyBarRow(bx + 110, titleY + 5, "é«˜", "èª¿æ•´", false, 90);
                });

                addonItems.forEach((aItem, idx) => {
                    ctx.save(); ctx.fillStyle = "#ffffff"; ctx.strokeStyle = "#eee"; roundRect(ctx, rightPanelX, rowY, rightPanelW - 50, 120, 15); ctx.fill(); ctx.stroke();
                    ctx.fillStyle = "#0288d1"; roundRect(ctx, rightPanelX, rowY, 10, 120, {tl:15, bl:15}); ctx.fill();
                    ctx.fillStyle = "#0277bd"; ctx.font = "bold 24px Microsoft JhengHei"; ctx.fillText(aItem.name, rightPanelX + 35, rowY + 50);
                    drawEnergyBarRow(rightPanelX + 35, rowY + 75, aItem.val, "æª¢æ¸¬å€¼", true, 130);
                    if (aItem.subs) { aItem.subs.forEach((sub, sIdx) => { if (sIdx < 4) { const sx = rightPanelX + 380 + (sIdx * 340); ctx.fillStyle = "#333"; ctx.font = "bold 20px Microsoft JhengHei"; ctx.fillText(sub.name, sx, rowY + 50); drawEnergyBarRow(sx, rowY + 75, sub.adj, "èª¿æ•´å¾Œ", false, 130); } }); }
                    rowY += 120;
                });

                const drawCenterCard = (centerObj, dx, dy, h, isH) => {
                    ctx.save(); ctx.fillStyle = "#ffffff"; ctx.shadowColor = "rgba(0,0,0,0.05)"; ctx.shadowBlur = 10; roundRect(ctx, dx, dy, mainColWidth, h, 15); ctx.fill(); ctx.restore();
                    ctx.fillStyle = HD_COLORS[centerObj.id]; roundRect(ctx, dx, dy, 10, h, {tl:15, bl:15}); ctx.fill();
                    
                    const themeDesc = CENTER_THEMES[centerObj.id] ? ` - ${CENTER_THEMES[centerObj.id]}` : "";
                    const title = `${centerObj.label}ä¸­å¿ƒ (${centerObj.sLabel})${themeDesc}`;
                    
                    ctx.font = "bold 20px Microsoft JhengHei"; const pillW = ctx.measureText(title).width + 35;
                    ctx.strokeStyle = HD_COLORS[centerObj.id]; ctx.lineWidth = 3; roundRect(ctx, dx + 30, dy + 25, pillW, 45, 22.5); ctx.stroke();
                    
                    ctx.save(); ctx.fillStyle = "#333"; ctx.textAlign="center"; ctx.textBaseline="middle"; 
                    ctx.fillText(title, dx + 30 + pillW/2, dy + 25 + 22.5); ctx.restore();

                    if (isH) {
                        ctx.save(); ctx.fillStyle = "#e8f5e9"; roundRect(ctx, dx + mainColWidth - 85, dy + 32, 65, 32, 6); ctx.fill();
                        ctx.fillStyle = "#2e7d32"; ctx.font = "bold 16px Microsoft JhengHei"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
                        ctx.fillText("å¥åº·", dx + mainColWidth - 52.5, dy + 48); ctx.restore();
                    }

                    ctx.textAlign="left"; ctx.textBaseline="top"; ctx.fillStyle="#555"; ctx.font="17px Microsoft JhengHei";
                    const centerStatus = centerObj.status || 'defined';
                    const staticText = CENTER_CONTENT[centerObj.id].static[centerStatus] || "";
                    
                    if(isH) { 
                        processParagraphs(ctx, staticText, mainColWidth - 60).forEach((line, lineIdx) => ctx.fillText(line, dx + 35, dy + 95 + lineIdx * 26)); 
                    } else {
                        let cy = dy + 85; ctx.fillStyle = "#7f8c8d"; ctx.font = "17px Microsoft JhengHei";
                        const introText = processParagraphs(ctx, staticText, mainColWidth - 60);
                        introText.slice(0, 2).forEach(line => { ctx.fillText(line, dx + 35, cy); cy += 25; });
                        
                        cy += 10; ctx.fillStyle = "#2c3e50"; ctx.font = "bold 19px Microsoft JhengHei"; ctx.fillText("èƒ½é‡æª¢æ¸¬/èª¿æ•´é …ç›®", dx + 35, cy);

                        ctx.save();
                        ctx.fillStyle = "#f8f9fa"; 
                        roundRect(ctx, dx + mainColWidth - 225, cy - 8, 210, 35, 6); ctx.fill();
                        ctx.strokeStyle = "#eee"; ctx.lineWidth = 1; ctx.stroke();
                        
                        ctx.font = "bold 16px Microsoft JhengHei"; ctx.textAlign = "left"; ctx.textBaseline = "middle";
                        let detTxt = `æª¢æ¸¬ ${centerObj.val}% â” `;
                        ctx.fillStyle = "#e53935"; 
                        ctx.fillText(detTxt, dx + mainColWidth - 215, cy + 10);
                        let detW = ctx.measureText(detTxt).width;
                        
                        ctx.fillStyle = "#0277bd"; 
                        ctx.fillText(`èª¿æ•´å¾Œ ${centerObj.adj}%`, dx + mainColWidth - 215 + detW, cy + 10);
                        ctx.restore();

                        cy+=35; 
                        let dPairs = []; if (centerObj.content) { for(let j=0; j < centerObj.content.length; j++){ if(centerObj.content[j].type === 'diag'){ dPairs.push({d: centerObj.content[j].text, a: centerObj.content[j+1] ? centerObj.content[j+1].text : ""}); j++; } } }
                        dPairs.forEach(p => {
                            const dL = processParagraphs(ctx, p.d, mainColWidth-80); const aL = processParagraphs(ctx, p.a, mainColWidth-80);
                            const bh = (dL.length + aL.length) * 28 + 20; ctx.fillStyle="#fffcf5"; ctx.strokeStyle="#fae1c3"; roundRect(ctx, dx+35, cy, mainColWidth-70, bh, 10); ctx.fill(); ctx.stroke();
                            ctx.font="bold 16px Microsoft JhengHei"; ctx.fillStyle="#8e242a"; dL.forEach((l,i) => ctx.fillText(l, dx+50, cy+15+i*28));
                            ctx.font="15px Microsoft JhengHei"; ctx.fillStyle="#1a4a6e"; aL.forEach((l,i) => ctx.fillText(l, dx+50, cy+15+dL.length*28+i*28));
                            cy+=bh+10;
                        });
                    }
                };

                if(healthyCenters.length > 0) { ctx.fillStyle="#2e7d32"; ctx.font="bold 36px 'Noto Serif TC', serif"; ctx.textAlign="left"; ctx.fillText("âœ… ç©©å®šé‹ä½œèƒ½é‡ä¸­å¿ƒ", rightPanelX, healthyTopY + 30); let hY = [healthyTopY+60, healthyTopY+60, healthyTopY+60]; healthyCenters.forEach((it, i) => { const col = i%3; drawCenterCard(it, mainColX[col], hY[col], HEALTHY_CARD_H, true); hY[col] += HEALTHY_CARD_H + 35; }); }
                if(adjustCenters.length > 0) { ctx.fillStyle="#c62828"; ctx.font="bold 36px 'Noto Serif TC', serif"; ctx.textAlign="left"; ctx.fillText("ğŸ› ï¸ é‡é»èª¿æ•´èƒ½é‡ä¸­å¿ƒ", rightPanelX, adjustTopY + 30); let aY = [adjustTopY+80, adjustTopY+80, adjustTopY+80]; adjustCenters.forEach((it, i) => { const col = i%3; drawCenterCard(it, mainColX[col], aY[col], ADJUST_CARD_H, false); aY[col] += ADJUST_CARD_H + 35; }); }

                const finalSy = Math.max(adjustTopY + adjustTotalH - 30, healthyTopY + healthyTotalH); 
                ctx.fillStyle="#f9f7f2"; ctx.strokeStyle="#c6a87c"; roundRect(ctx, 100, finalSy, canvasWidth-200, summaryBoxH, 30); ctx.fill(); ctx.stroke();
                ctx.fillStyle="#1a2f23"; ctx.font="bold 42px 'Noto Serif TC', serif"; ctx.textAlign="left"; ctx.fillText("âœï¸ ç™‚ç™’å¸«ç¸½çµï¼š", 140, finalSy+40); 
                ctx.fillStyle="#333"; ctx.font="26px Microsoft JhengHei"; sumLines.forEach((line, i) => ctx.fillText(line, 140, finalSy + 110 + i * 52));

                document.getElementById('final-image').src = canvas.toDataURL("image/jpeg", 0.9);
            } catch (e) { console.error("âŒ ç¹ªåœ–å¤±æ•—ï¼š", e); alert("ç¹ªåœ–å‡ºéŒ¯ï¼è«‹æŒ‰ F12 æª¢æŸ¥ã€‚"); }
        }

        function roundRect(ctx, x, y, width, height, radius) {
            if (typeof radius === 'number') { radius = {tl: radius, tr: radius, br: radius, bl: radius}; }
            ctx.beginPath(); ctx.moveTo(x + radius.tl, y); ctx.lineTo(x + width - radius.tr, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius.tr); ctx.lineTo(x + width, y + height - radius.br);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius.br, y + height); ctx.lineTo(x + radius.bl, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius.bl); ctx.lineTo(x, y + radius.tl);
            ctx.quadraticCurveTo(x, y, x + radius.tl, y); ctx.closePath();
        }

        function processParagraphs(ctx, text, maxWidth) {
            if (!text) return [""];
            const paragraphs = text.split('\n');
            let allLines = [];
            paragraphs.forEach(para => {
                if (para.trim() === "") { allLines.push(""); return; }
                const words = para.split(''); 
                let currentLine = words[0];
                for (let i = 1; i < words.length; i++) {
                    const width = ctx.measureText(currentLine + words[i]).width;
                    if (width < maxWidth) { currentLine += words[i]; } 
                    else { allLines.push(currentLine); currentLine = words[i]; }
                }
                allLines.push(currentLine);
            });
            return allLines;
        }

        function drawHeader(ctx, width, height, meta, logoImg) {
            const mainBarH = height - 100;
            ctx.fillStyle = "#1a2f23"; ctx.fillRect(0, 0, width, mainBarH);
            if (logoImg) {
                const logoH = 90; const logoW = (logoImg.width / logoImg.height) * logoH;
                ctx.drawImage(logoImg, 50, (mainBarH / 2) - (logoH / 2), logoW, logoH);
            }
            ctx.fillStyle = "#ffffff"; ctx.font = "bold 72px 'Noto Serif TC', serif"; ctx.textAlign = "center";
            ctx.fillText(meta.title, width / 2, (mainBarH / 2) + 20); 
            ctx.fillStyle = "#c6a87c"; ctx.fillRect(0, mainBarH - 4, width, 4);
            ctx.fillStyle = "#f9f7f2"; ctx.fillRect(0, mainBarH, width, 100);
            ctx.fillStyle = "#1a2f23"; ctx.font = "bold 26px 'Noto Serif TC', serif"; ctx.textAlign = "left"; ctx.textBaseline = "middle";
            const colW = (width - 300) / 4;
            ctx.fillText(`ğŸ“… èª¿æ•´æ—¥æœŸï¼š${meta.date}`, 150, mainBarH + 50);
            ctx.fillText(`ğŸ‘¤ å§“åï¼š${meta.name}`, 150 + colW, mainBarH + 50);
            ctx.fillText(`ğŸ“ æ‰‹æ©Ÿï¼š${meta.phone}`, 150 + colW * 2, mainBarH + 50);
            ctx.fillText(`ğŸ©º ç™‚ç™’å¸«ï¼š${meta.healer}`, 150 + colW * 3, mainBarH + 50);
        }

        function downloadReportImage() {
            const name = document.getElementById('info-name').value || 'EnergyReport';
            const date = document.getElementById('info-date').value || '';
            const fileName = `æœå‹™å ±å‘Š_${name}_${date}.jpg`;
            const link = document.createElement('a');
            link.download = fileName;
            link.href = document.getElementById('mainCanvas').toDataURL("image/jpeg", 1.0);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>